cscope 15 $HOME/ocssd/linux/drivers/lightnvm               0000294065
	@core.c

7 
	~<lšux/li¡.h
>

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/£m.h
>

10 
	~<lšux/b™m­.h
>

11 
	~<lšux/moduË.h
>

12 
	~<lšux/moduË·¿m.h
>

13 
	~<lšux/miscdeviû.h
>

14 
	~<lšux/lighŠvm.h
>

15 
	~<lšux/sched/sysùl.h
>

17 
LIST_HEAD
(
nvm_tgt_ty³s
);

18 
DECLARE_RWSEM
(
nvm_tg‰_lock
);

19 
LIST_HEAD
(
nvm_deviûs
);

20 
DECLARE_RWSEM
(
nvm_lock
);

23 
	snvm_ch_m­
 {

24 
	mch_off
;

25 
	mnum_lun
;

26 *
	mlun_offs
;

29 
	snvm_dev_m­
 {

30 
nvm_ch_m­
 *
	mchÆs
;

31 
	mnum_ch
;

34 
nvm_ä“
(
k»f
 *
»f
);

36 
nvm_rg‘
 *
	$nvm_fšd_rg‘
(
nvm_dev
 *
dev
, cÚ¡ *
Çme
)

38 
nvm_rg‘
 *
tgt
;

40 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
dev
->
rg‘s
, 
li¡
)

41 ià(!
	`¡rcmp
(
Çme
, 
tgt
->
disk
->
disk_Çme
))

42  
tgt
;

44  
NULL
;

45 
	}
}

47 
boÞ
 
	$nvm_rg‘_exi¡s
(cÚ¡ *
Çme
)

49 
nvm_dev
 *
dev
;

50 
nvm_rg‘
 *
tgt
;

51 
boÞ
 
»t
 = 
çl£
;

53 
	`down_wr™e
(&
nvm_lock
);

54 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
nvm_deviûs
, 
deviûs
) {

55 
	`mu‹x_lock
(&
dev
->
mlock
);

56 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
dev
->
rg‘s
, 
li¡
) {

57 ià(!
	`¡rcmp
(
Çme
, 
tgt
->
disk
->
disk_Çme
)) {

58 
»t
 = 
Œue
;

59 
	`mu‹x_uÆock
(&
dev
->
mlock
);

60 
out
;

63 
	`mu‹x_uÆock
(&
dev
->
mlock
);

66 
out
:

67 
	`up_wr™e
(&
nvm_lock
);

68  
»t
;

69 
	}
}

71 
	$nvm_»£rve_luns
(
nvm_dev
 *
dev
, 
lun_begš
, 
lun_’d
)

73 
i
;

75 
i
 = 
lun_begš
; i <ð
lun_’d
; i++) {

76 ià(
	`‹¡_ªd_£t_b™
(
i
, 
dev
->
lun_m­
)) {

77 
	`´_”r
("nvm:†uÀ%d‡Ì—dy‡Îoÿ‹d\n", 
i
);

78 
”r
;

83 
”r
:

84 --
i
 >ð
lun_begš
)

85 
	`þ—r_b™
(
i
, 
dev
->
lun_m­
);

87  -
EBUSY
;

88 
	}
}

90 
	$nvm_»Ëa£_luns_”r
(
nvm_dev
 *
dev
, 
lun_begš
,

91 
lun_’d
)

93 
i
;

95 
i
 = 
lun_begš
; i <ð
lun_’d
; i++)

96 
	`WARN_ON
(!
	`‹¡_ªd_þ—r_b™
(
i
, 
dev
->
lun_m­
));

97 
	}
}

99 
	$nvm_»move_tgt_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
þ—r
)

101 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

102 
nvm_dev_m­
 *
dev_m­
 = 
tgt_dev
->
m­
;

103 
i
, 
j
;

105 
i
 = 0; i < 
dev_m­
->
num_ch
; i++) {

106 
nvm_ch_m­
 *
ch_m­
 = &
dev_m­
->
chÆs
[
i
];

107 *
lun_offs
 = 
ch_m­
->lun_offs;

108 
ch
 = 
i
 + 
ch_m­
->
ch_off
;

110 ià(
þ—r
) {

111 
j
 = 0; j < 
ch_m­
->
num_lun
; j++) {

112 
lun
 = 
j
 + 
lun_offs
[j];

113 
lunid
 = (
ch
 * 
dev
->
geo
.
num_lun
è+ 
lun
;

115 
	`WARN_ON
(!
	`‹¡_ªd_þ—r_b™
(
lunid
,

116 
dev
->
lun_m­
));

120 
	`kä“
(
ch_m­
->
lun_offs
);

123 
	`kä“
(
dev_m­
->
chÆs
);

124 
	`kä“
(
dev_m­
);

126 
	`kä“
(
tgt_dev
->
luns
);

127 
	`kä“
(
tgt_dev
);

128 
	}
}

130 
nvm_tgt_dev
 *
	$nvm_ü—‹_tgt_dev
(
nvm_dev
 *
dev
,

131 
u16
 
lun_begš
, u16 
lun_’d
,

132 
u16
 
Ý
)

134 
nvm_tgt_dev
 *
tgt_dev
 = 
NULL
;

135 
nvm_dev_m­
 *
dev_rm­
 = 
dev
->
rm­
;

136 
nvm_dev_m­
 *
dev_m­
;

137 
µa_addr
 *
luns
;

138 
num_lun
 = 
lun_’d
 - 
lun_begš
 + 1;

139 
luns_Ëá
 = 
num_lun
;

140 
num_ch
 = 
num_lun
 / 
dev
->
geo
.num_lun;

141 
num_ch_mod
 = 
num_lun
 % 
dev
->
geo
.num_lun;

142 
bch
 = 
lun_begš
 / 
dev
->
geo
.
num_lun
;

143 
blun
 = 
lun_begš
 % 
dev
->
geo
.
num_lun
;

144 
lunid
 = 0;

145 
lun_b®ªûd
 = 1;

146 
£c_³r_lun
, 
´ev_num_lun
;

147 
i
, 
j
;

149 
num_ch
 = (
num_ch_mod
 == 0) ?‚um_ch :‚um_ch + 1;

151 
dev_m­
 = 
	`km®loc
((
nvm_dev_m­
), 
GFP_KERNEL
);

152 ià(!
dev_m­
)

153 
”r_dev
;

155 
dev_m­
->
chÆs
 = 
	`kÿÎoc
(
num_ch
, (
nvm_ch_m­
), 
GFP_KERNEL
);

156 ià(!
dev_m­
->
chÆs
)

157 
”r_chÆs
;

159 
luns
 = 
	`kÿÎoc
(
num_lun
, (
µa_addr
), 
GFP_KERNEL
);

160 ià(!
luns
)

161 
”r_luns
;

163 
´ev_num_lun
 = (
luns_Ëá
 > 
dev
->
geo
.
num_lun
) ?

164 
dev
->
geo
.
num_lun
 : 
luns_Ëá
;

165 
i
 = 0; i < 
num_ch
; i++) {

166 
nvm_ch_m­
 *
ch_rm­
 = &
dev_rm­
->
chÆs
[
i
 + 
bch
];

167 *
lun_roffs
 = 
ch_rm­
->
lun_offs
;

168 
nvm_ch_m­
 *
ch_m­
 = &
dev_m­
->
chÆs
[
i
];

169 *
lun_offs
;

170 
luns_š_chÆ
 = (
luns_Ëá
 > 
dev
->
geo
.
num_lun
) ?

171 
dev
->
geo
.
num_lun
 : 
luns_Ëá
;

173 ià(
lun_b®ªûd
 && 
´ev_num_lun
 !ð
luns_š_chÆ
)

174 
lun_b®ªûd
 = 0;

176 
ch_m­
->
ch_off
 = 
ch_rm­
->ch_ofàð
bch
;

177 
ch_m­
->
num_lun
 = 
luns_š_chÆ
;

179 
lun_offs
 = 
	`kÿÎoc
(
luns_š_chÆ
, (), 
GFP_KERNEL
);

180 ià(!
lun_offs
)

181 
”r_ch
;

183 
j
 = 0; j < 
luns_š_chÆ
; j++) {

184 
luns
[
lunid
].
µa
 = 0;

185 
luns
[
lunid
].
a
.
ch
 = 
i
;

186 
luns
[
lunid
++].
a
.
lun
 = 
j
;

188 
lun_offs
[
j
] = 
blun
;

189 
lun_roffs
[
j
 + 
blun
] = blun;

192 
ch_m­
->
lun_offs
 =†un_offs;

195 
blun
 = 0;

196 
luns_Ëá
 -ð
luns_š_chÆ
;

199 
dev_m­
->
num_ch
 =‚um_ch;

201 
tgt_dev
 = 
	`km®loc
((
nvm_tgt_dev
), 
GFP_KERNEL
);

202 ià(!
tgt_dev
)

203 
”r_ch
;

206 
	`memýy
(&
tgt_dev
->
geo
, &
dev
->geo, (
nvm_geo
));

209 
tgt_dev
->
geo
.
num_ch
 =‚um_ch;

210 
tgt_dev
->
geo
.
num_lun
 = (
lun_b®ªûd
è? 
´ev_num_lun
 : -1;

211 
tgt_dev
->
geo
.
®l_luns
 = 
num_lun
;

212 
tgt_dev
->
geo
.
®l_chunks
 = 
num_lun
 * 
dev
->geo.
num_chk
;

214 
tgt_dev
->
geo
.
Ý
 = op;

216 
£c_³r_lun
 = 
dev
->
geo
.
þba
 * dev->geo.
num_chk
;

217 
tgt_dev
->
geo
.
tÙ®_£cs
 = 
num_lun
 * 
£c_³r_lun
;

219 
tgt_dev
->
q
 = 
dev
->q;

220 
tgt_dev
->
m­
 = 
dev_m­
;

221 
tgt_dev
->
luns
 =†uns;

222 
tgt_dev
->
·»Á
 = 
dev
;

224  
tgt_dev
;

225 
”r_ch
:

226 --
i
 >= 0)

227 
	`kä“
(
dev_m­
->
chÆs
[
i
].
lun_offs
);

228 
	`kä“
(
luns
);

229 
”r_luns
:

230 
	`kä“
(
dev_m­
->
chÆs
);

231 
”r_chÆs
:

232 
	`kä“
(
dev_m­
);

233 
”r_dev
:

234  
tgt_dev
;

235 
	}
}

237 cÚ¡ 
block_deviû_Ý”©iÚs
 
	gnvm_fÝs
 = {

238 .
owÃr
 = 
THIS_MODULE
,

241 
nvm_tgt_ty³
 *
	$__nvm_fšd_rg‘_ty³
(cÚ¡ *
Çme
)

243 
nvm_tgt_ty³
 *
‰
;

245 
	`li¡_fÜ_—ch_’Œy
(
‰
, &
nvm_tgt_ty³s
, 
li¡
)

246 ià(!
	`¡rcmp
(
Çme
, 
‰
->name))

247  
‰
;

249  
NULL
;

250 
	}
}

252 
nvm_tgt_ty³
 *
	$nvm_fšd_rg‘_ty³
(cÚ¡ *
Çme
)

254 
nvm_tgt_ty³
 *
‰
;

256 
	`down_wr™e
(&
nvm_tg‰_lock
);

257 
‰
 = 
	`__nvm_fšd_rg‘_ty³
(
Çme
);

258 
	`up_wr™e
(&
nvm_tg‰_lock
);

260  
‰
;

261 
	}
}

263 
	$nvm_cÚfig_check_luns
(
nvm_geo
 *
geo
, 
lun_begš
,

264 
lun_’d
)

266 ià(
lun_begš
 > 
lun_’d
 ||†un_’d >ð
geo
->
®l_luns
) {

267 
	`´_”r
("nvm:†un out of bound (%u:%u > %u)\n",

268 
lun_begš
, 
lun_’d
, 
geo
->
®l_luns
 - 1);

269  -
EINVAL
;

273 
	}
}

275 
	$__nvm_cÚfig_sim¶e
(
nvm_dev
 *
dev
,

276 
nvm_ioùl_ü—‹_sim¶e
 *
s
)

278 
nvm_geo
 *
geo
 = &
dev
->geo;

280 ià(
s
->
lun_begš
 =ð-1 && s->
lun_’d
 == -1) {

281 
s
->
lun_begš
 = 0;

282 
s
->
lun_’d
 = 
geo
->
®l_luns
 - 1;

285  
	`nvm_cÚfig_check_luns
(
geo
, 
s
->
lun_begš
, s->
lun_’d
);

286 
	}
}

288 
	$__nvm_cÚfig_ex‹nded
(
nvm_dev
 *
dev
,

289 
nvm_ioùl_ü—‹_ex‹nded
 *
e
)

291 ià(
e
->
lun_begš
 =ð0xFFFF &&ƒ->
lun_’d
 == 0xFFFF) {

292 
e
->
lun_begš
 = 0;

293 
e
->
lun_’d
 = 
dev
->
geo
.
®l_luns
 - 1;

297 ià(
e
->
Ý
 == 0xFFFF) {

298 
e
->
Ý
 = 
NVM_TARGET_DEFAULT_OP
;

299 } ià(
e
->
Ý
 < 
NVM_TARGET_MIN_OP
 ||ƒ->Ý > 
NVM_TARGET_MAX_OP
) {

300 
	`´_”r
("nvm: invalid over…rovisioning value\n");

301  -
EINVAL
;

304  
	`nvm_cÚfig_check_luns
(&
dev
->
geo
, 
e
->
lun_begš
,ƒ->
lun_’d
);

305 
	}
}

307 
	$nvm_ü—‹_tgt
(
nvm_dev
 *
dev
, 
nvm_ioùl_ü—‹
 *
ü—‹
)

309 
nvm_ioùl_ü—‹_ex‹nded
 
e
;

310 
»que¡_queue
 *
tqueue
;

311 
g’disk
 *
tdisk
;

312 
nvm_tgt_ty³
 *
‰
;

313 
nvm_rg‘
 *
t
;

314 
nvm_tgt_dev
 *
tgt_dev
;

315 *
rg‘d©a
;

316 
mdts
;

317 
»t
;

319 
ü—‹
->
cÚf
.
ty³
) {

320 
NVM_CONFIG_TYPE_SIMPLE
:

321 
»t
 = 
	`__nvm_cÚfig_sim¶e
(
dev
, &
ü—‹
->
cÚf
.
s
);

322 ià(
»t
)

323  
»t
;

325 
e
.
lun_begš
 = 
ü—‹
->
cÚf
.
s
.lun_begin;

326 
e
.
lun_’d
 = 
ü—‹
->
cÚf
.
s
.lun_end;

327 
e
.
Ý
 = 
NVM_TARGET_DEFAULT_OP
;

329 
NVM_CONFIG_TYPE_EXTENDED
:

330 
»t
 = 
	`__nvm_cÚfig_ex‹nded
(
dev
, &
ü—‹
->
cÚf
.
e
);

331 ià(
»t
)

332  
»t
;

334 
e
 = 
ü—‹
->
cÚf
.e;

337 
	`´_”r
("nvm: configype‚ot valid\n");

338  -
EINVAL
;

341 
‰
 = 
	`nvm_fšd_rg‘_ty³
(
ü—‹
->
tg‰y³
);

342 ià(!
‰
) {

343 
	`´_”r
("nvm:¬g‘y³ % nÙ found\n", 
ü—‹
->
tg‰y³
);

344  -
EINVAL
;

347 ià((
‰
->
æags
 & 
NVM_TGT_F_HOST_L2P
è!ð(
dev
->
geo
.
dom
 & 
NVM_RSP_L2P
)) {

348 
	`´_”r
("nvm: device is incompatible witharget L2Pype.\n");

349  -
EINVAL
;

352 ià(
	`nvm_rg‘_exi¡s
(
ü—‹
->
tgŠame
)) {

353 
	`´_”r
("nvm:arget‚ame‡lreadyƒxists (%s)\n",

354 
ü—‹
->
tgŠame
);

355  -
EINVAL
;

358 
»t
 = 
	`nvm_»£rve_luns
(
dev
, 
e
.
lun_begš
,ƒ.
lun_’d
);

359 ià(
»t
)

360  
»t
;

362 
t
 = 
	`km®loc
((
nvm_rg‘
), 
GFP_KERNEL
);

363 ià(!
t
) {

364 
»t
 = -
ENOMEM
;

365 
”r_»£rve
;

368 
tgt_dev
 = 
	`nvm_ü—‹_tgt_dev
(
dev
, 
e
.
lun_begš
,ƒ.
lun_’d
,ƒ.
Ý
);

369 ià(!
tgt_dev
) {

370 
	`´_”r
("nvm: could‚ot createarget device\n");

371 
»t
 = -
ENOMEM
;

372 
”r_t
;

375 
tdisk
 = 
	`®loc_disk
(0);

376 ià(!
tdisk
) {

377 
»t
 = -
ENOMEM
;

378 
”r_dev
;

381 
tqueue
 = 
	`blk_®loc_queue_node
(
GFP_KERNEL
, 
dev
->
q
->
node
);

382 ià(!
tqueue
) {

383 
»t
 = -
ENOMEM
;

384 
”r_disk
;

386 
	`blk_queue_make_»que¡
(
tqueue
, 
‰
->
make_rq
);

388 
	`¡¾ýy
(
tdisk
->
disk_Çme
, 
ü—‹
->
tgŠame
, (tdisk->disk_name));

389 
tdisk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

390 
tdisk
->
majÜ
 = 0;

391 
tdisk
->
fœ¡_mšÜ
 = 0;

392 
tdisk
->
fÝs
 = &
nvm_fÝs
;

393 
tdisk
->
queue
 = 
tqueue
;

395 
rg‘d©a
 = 
‰
->
	`š™
(
tgt_dev
, 
tdisk
, 
ü—‹
->
æags
);

396 ià(
	`IS_ERR
(
rg‘d©a
)) {

397 
»t
 = 
	`PTR_ERR
(
rg‘d©a
);

398 
”r_š™
;

401 
tdisk
->
´iv©e_d©a
 = 
rg‘d©a
;

402 
tqueue
->
queued©a
 = 
rg‘d©a
;

404 
mdts
 = (
dev
->
geo
.
c£cs
 >> 9è* 
NVM_MAX_VLBA
;

405 ià(
dev
->
geo
.
mdts
) {

406 
mdts
 = 
	`mš_t
(
u32
, 
dev
->
geo
.mdts,

407 (
dev
->
geo
.
c£cs
 >> 9è* 
NVM_MAX_VLBA
);

409 
	`blk_queue_max_hw_£ùÜs
(
tqueue
, 
mdts
);

411 
	`£t_ÿ·c™y
(
tdisk
, 
‰
->
	`ÿ·c™y
(
rg‘d©a
));

412 
	`add_disk
(
tdisk
);

414 ià(
‰
->
sysfs_š™
 &&t->
	`sysfs_š™
(
tdisk
)) {

415 
»t
 = -
ENOMEM
;

416 
”r_sysfs
;

419 
t
->
ty³
 = 
‰
;

420 
t
->
disk
 = 
tdisk
;

421 
t
->
dev
 = 
tgt_dev
;

423 
	`mu‹x_lock
(&
dev
->
mlock
);

424 
	`li¡_add_ž
(&
t
->
li¡
, &
dev
->
rg‘s
);

425 
	`mu‹x_uÆock
(&
dev
->
mlock
);

427 
	`__moduË_g‘
(
‰
->
owÃr
);

430 
”r_sysfs
:

431 ià(
‰
->
ex™
)

432 
‰
->
	`ex™
(
rg‘d©a
, 
Œue
);

433 
”r_š™
:

434 
	`blk_þ—nup_queue
(
tqueue
);

435 
tdisk
->
queue
 = 
NULL
;

436 
”r_disk
:

437 
	`put_disk
(
tdisk
);

438 
”r_dev
:

439 
	`nvm_»move_tgt_dev
(
tgt_dev
, 0);

440 
”r_t
:

441 
	`kä“
(
t
);

442 
”r_»£rve
:

443 
	`nvm_»Ëa£_luns_”r
(
dev
, 
e
.
lun_begš
,ƒ.
lun_’d
);

444  
»t
;

445 
	}
}

447 
	$__nvm_»move_rg‘
(
nvm_rg‘
 *
t
, 
boÞ
 
g¿ûful
)

449 
nvm_tgt_ty³
 *
‰
 = 
t
->
ty³
;

450 
g’disk
 *
tdisk
 = 
t
->
disk
;

451 
»que¡_queue
 *
q
 = 
tdisk
->
queue
;

453 
	`d–_g’disk
(
tdisk
);

454 
	`blk_þ—nup_queue
(
q
);

456 ià(
‰
->
sysfs_ex™
)

457 
‰
->
	`sysfs_ex™
(
tdisk
);

459 ià(
‰
->
ex™
)

460 
‰
->
	`ex™
(
tdisk
->
´iv©e_d©a
, 
g¿ûful
);

462 
	`nvm_»move_tgt_dev
(
t
->
dev
, 1);

463 
	`put_disk
(
tdisk
);

464 
	`moduË_put
(
t
->
ty³
->
owÃr
);

466 
	`li¡_d–
(&
t
->
li¡
);

467 
	`kä“
(
t
);

468 
	}
}

479 
	$nvm_»move_tgt
(
nvm_ioùl_»move
 *
»move
)

481 
nvm_rg‘
 *
t
;

482 
nvm_dev
 *
dev
;

484 
	`down_»ad
(&
nvm_lock
);

485 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
nvm_deviûs
, 
deviûs
) {

486 
	`mu‹x_lock
(&
dev
->
mlock
);

487 
t
 = 
	`nvm_fšd_rg‘
(
dev
, 
»move
->
tgŠame
);

488 ià(
t
) {

489 
	`mu‹x_uÆock
(&
dev
->
mlock
);

492 
	`mu‹x_uÆock
(&
dev
->
mlock
);

494 
	`up_»ad
(&
nvm_lock
);

496 ià(!
t
)

499 
	`__nvm_»move_rg‘
(
t
, 
Œue
);

500 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

503 
	}
}

505 
	$nvm_»gi¡”_m­
(
nvm_dev
 *
dev
)

507 
nvm_dev_m­
 *
rm­
;

508 
i
, 
j
;

510 
rm­
 = 
	`km®loc
((
nvm_dev_m­
), 
GFP_KERNEL
);

511 ià(!
rm­
)

512 
”r_rm­
;

514 
rm­
->
chÆs
 = 
	`kÿÎoc
(
dev
->
geo
.
num_ch
, (
nvm_ch_m­
),

515 
GFP_KERNEL
);

516 ià(!
rm­
->
chÆs
)

517 
”r_chÆs
;

519 
i
 = 0; i < 
dev
->
geo
.
num_ch
; i++) {

520 
nvm_ch_m­
 *
ch_rm­
;

521 *
lun_roffs
;

522 
luns_š_chÆ
 = 
dev
->
geo
.
num_lun
;

524 
ch_rm­
 = &
rm­
->
chÆs
[
i
];

526 
ch_rm­
->
ch_off
 = -1;

527 
ch_rm­
->
num_lun
 = 
luns_š_chÆ
;

529 
lun_roffs
 = 
	`kÿÎoc
(
luns_š_chÆ
, (), 
GFP_KERNEL
);

530 ià(!
lun_roffs
)

531 
”r_ch
;

533 
j
 = 0; j < 
luns_š_chÆ
; j++)

534 
lun_roffs
[
j
] = -1;

536 
ch_rm­
->
lun_offs
 = 
lun_roffs
;

539 
dev
->
rm­
 =„map;

542 
”r_ch
:

543 --
i
 >= 0)

544 
	`kä“
(
rm­
->
chÆs
[
i
].
lun_offs
);

545 
”r_chÆs
:

546 
	`kä“
(
rm­
);

547 
”r_rm­
:

548  -
ENOMEM
;

549 
	}
}

551 
	$nvm_uÄegi¡”_m­
(
nvm_dev
 *
dev
)

553 
nvm_dev_m­
 *
rm­
 = 
dev
->rmap;

554 
i
;

556 
i
 = 0; i < 
dev
->
geo
.
num_ch
; i++)

557 
	`kä“
(
rm­
->
chÆs
[
i
].
lun_offs
);

559 
	`kä“
(
rm­
->
chÆs
);

560 
	`kä“
(
rm­
);

561 
	}
}

563 
	$nvm_m­_to_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
p
)

565 
nvm_dev_m­
 *
dev_m­
 = 
tgt_dev
->
m­
;

566 
nvm_ch_m­
 *
ch_m­
 = &
dev_m­
->
chÆs
[
p
->
a
.
ch
];

567 
lun_off
 = 
ch_m­
->
lun_offs
[
p
->
a
.
lun
];

569 
p
->
a
.
ch
 +ð
ch_m­
->
ch_off
;

570 
p
->
a
.
lun
 +ð
lun_off
;

571 
	}
}

573 
	$nvm_m­_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
p
)

575 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

576 
nvm_dev_m­
 *
dev_rm­
 = 
dev
->
rm­
;

577 
nvm_ch_m­
 *
ch_rm­
 = &
dev_rm­
->
chÆs
[
p
->
a
.
ch
];

578 
lun_roff
 = 
ch_rm­
->
lun_offs
[
p
->
a
.
lun
];

580 
p
->
a
.
ch
 -ð
ch_rm­
->
ch_off
;

581 
p
->
a
.
lun
 -ð
lun_roff
;

582 
	}
}

584 
	$nvm_µa_tgt_to_dev
(
nvm_tgt_dev
 *
tgt_dev
,

585 
µa_addr
 *
µa_li¡
, 
Ä_µas
)

587 
i
;

589 
i
 = 0; i < 
Ä_µas
; i++) {

590 
	`nvm_m­_to_dev
(
tgt_dev
, &
µa_li¡
[
i
]);

591 
µa_li¡
[
i
] = 
	`g’”ic_to_dev_addr
(
tgt_dev
->
·»Á
,…pa_list[i]);

593 
	}
}

595 
	$nvm_µa_dev_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
,

596 
µa_addr
 *
µa_li¡
, 
Ä_µas
)

598 
i
;

600 
i
 = 0; i < 
Ä_µas
; i++) {

601 
µa_li¡
[
i
] = 
	`dev_to_g’”ic_addr
(
tgt_dev
->
·»Á
,…pa_list[i]);

602 
	`nvm_m­_to_tgt
(
tgt_dev
, &
µa_li¡
[
i
]);

604 
	}
}

606 
	$nvm_rq_tgt_to_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

608 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

610 
	`nvm_µa_tgt_to_dev
(
tgt_dev
, 
µa_li¡
, 
rqd
->
Ä_µas
);

611 
	}
}

613 
	$nvm_rq_dev_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

615 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

617 
	`nvm_µa_dev_to_tgt
(
tgt_dev
, 
µa_li¡
, 
rqd
->
Ä_µas
);

618 
	}
}

620 
	$nvm_»gi¡”_tgt_ty³
(
nvm_tgt_ty³
 *
‰
)

622 
»t
 = 0;

624 
	`down_wr™e
(&
nvm_tg‰_lock
);

625 ià(
	`__nvm_fšd_rg‘_ty³
(
‰
->
Çme
))

626 
»t
 = -
EEXIST
;

628 
	`li¡_add
(&
‰
->
li¡
, &
nvm_tgt_ty³s
);

629 
	`up_wr™e
(&
nvm_tg‰_lock
);

631  
»t
;

632 
	}
}

633 
EXPORT_SYMBOL
(
nvm_»gi¡”_tgt_ty³
);

635 
	$nvm_uÄegi¡”_tgt_ty³
(
nvm_tgt_ty³
 *
‰
)

637 ià(!
‰
)

640 
	`down_wr™e
(&
nvm_tg‰_lock
);

641 
	`li¡_d–
(&
‰
->
li¡
);

642 
	`up_wr™e
(&
nvm_tg‰_lock
);

643 
	}
}

644 
EXPORT_SYMBOL
(
nvm_uÄegi¡”_tgt_ty³
);

646 *
	$nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, 
gå_t
 
mem_æags
,

647 
dma_addr_t
 *
dma_hªdËr
)

649  
dev
->
Ýs
->
	`dev_dma_®loc
(dev, dev->
dma_poÞ
, 
mem_æags
,

650 
dma_hªdËr
);

651 
	}
}

652 
EXPORT_SYMBOL
(
nvm_dev_dma_®loc
);

654 
	$nvm_dev_dma_ä“
(
nvm_dev
 *
dev
, *
addr
, 
dma_addr_t
 
dma_hªdËr
)

656 
dev
->
Ýs
->
	`dev_dma_ä“
(dev->
dma_poÞ
, 
addr
, 
dma_hªdËr
);

657 
	}
}

658 
EXPORT_SYMBOL
(
nvm_dev_dma_ä“
);

660 
nvm_dev
 *
	$nvm_fšd_nvm_dev
(cÚ¡ *
Çme
)

662 
nvm_dev
 *
dev
;

664 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
nvm_deviûs
, 
deviûs
)

665 ià(!
	`¡rcmp
(
Çme
, 
dev
->name))

666  
dev
;

668  
NULL
;

669 
	}
}

671 
	$nvm_£t_rqd_µ®i¡
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
,

672 cÚ¡ 
µa_addr
 *
µas
, 
Ä_µas
)

674 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

675 
nvm_geo
 *
geo
 = &
tgt_dev
->geo;

676 
i
, 
¶ªe_út
, 
¶_idx
;

677 
µa_addr
 
µa
;

679 ià(
geo
->
¶n_mode
 =ð
NVM_PLANE_SINGLE
 && 
Ä_µas
 == 1) {

680 
rqd
->
Ä_µas
 =‚r_ppas;

681 
rqd
->
µa_addr
 = 
µas
[0];

686 
rqd
->
Ä_µas
 =‚r_ppas;

687 
rqd
->
µa_li¡
 = 
	`nvm_dev_dma_®loc
(
dev
, 
GFP_KERNEL
, &rqd->
dma_µa_li¡
);

688 ià(!
rqd
->
µa_li¡
) {

689 
	`´_”r
("nvm: failedo‡llocate dma memory\n");

690  -
ENOMEM
;

693 
¶ªe_út
 = 
geo
->
¶n_mode
;

694 
rqd
->
Ä_µas
 *ð
¶ªe_út
;

696 
i
 = 0; i < 
Ä_µas
; i++) {

697 
¶_idx
 = 0;…l_idx < 
¶ªe_út
;…l_idx++) {

698 
µa
 = 
µas
[
i
];

699 
µa
.
g
.
¶
 = 
¶_idx
;

700 
rqd
->
µa_li¡
[(
¶_idx
 * 
Ä_µas
è+ 
i
] = 
µa
;

705 
	}
}

707 
	$nvm_ä“_rqd_µ®i¡
(
nvm_tgt_dev
 *
tgt_dev
,

708 
nvm_rq
 *
rqd
)

710 ià(!
rqd
->
µa_li¡
)

713 
	`nvm_dev_dma_ä“
(
tgt_dev
->
·»Á
, 
rqd
->
µa_li¡
,„qd->
dma_µa_li¡
);

714 
	}
}

716 
	$nvm_£t_æags
(
nvm_geo
 *
geo
, 
nvm_rq
 *
rqd
)

718 
æags
 = 0;

720 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_20
)

723 ià(
rqd
->
is_£q
)

724 
æags
 |ð
geo
->
¶n_mode
 >> 1;

726 ià(
rqd
->
Ýcode
 =ð
NVM_OP_PREAD
)

727 
æags
 |ð(
NVM_IO_SCRAMBLE_ENABLE
 | 
NVM_IO_SUSPEND
);

728 ià(
rqd
->
Ýcode
 =ð
NVM_OP_PWRITE
)

729 
æags
 |ð
NVM_IO_SCRAMBLE_ENABLE
;

731  
æags
;

732 
	}
}

734 
	$nvm_subm™_io
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

736 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

737 
»t
;

739 ià(!
dev
->
Ýs
->
subm™_io
)

740  -
ENODEV
;

742 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, 
rqd
);

744 
rqd
->
dev
 = 
tgt_dev
;

745 
rqd
->
æags
 = 
	`nvm_£t_æags
(&
tgt_dev
->
geo
,„qd);

748 
»t
 = 
dev
->
Ýs
->
	`subm™_io
(dev, 
rqd
);

749 ià(
»t
)

750 
	`nvm_rq_dev_to_tgt
(
tgt_dev
, 
rqd
);

751  
»t
;

752 
	}
}

753 
EXPORT_SYMBOL
(
nvm_subm™_io
);

755 
	$nvm_subm™_io_sync
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

757 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

758 
»t
;

760 ià(!
dev
->
Ýs
->
subm™_io_sync
)

761  -
ENODEV
;

763 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, 
rqd
);

765 
rqd
->
dev
 = 
tgt_dev
;

766 
rqd
->
æags
 = 
	`nvm_£t_æags
(&
tgt_dev
->
geo
,„qd);

769 
»t
 = 
dev
->
Ýs
->
	`subm™_io_sync
(dev, 
rqd
);

770 
	`nvm_rq_dev_to_tgt
(
tgt_dev
, 
rqd
);

772  
»t
;

773 
	}
}

774 
EXPORT_SYMBOL
(
nvm_subm™_io_sync
);

776 
	$nvm_’d_io
(
nvm_rq
 *
rqd
)

778 
nvm_tgt_dev
 *
tgt_dev
 = 
rqd
->
dev
;

781 ià(
tgt_dev
)

782 
	`nvm_rq_dev_to_tgt
(
tgt_dev
, 
rqd
);

784 ià(
rqd
->
’d_io
)

785 
rqd
->
	`’d_io
(rqd);

786 
	}
}

787 
EXPORT_SYMBOL
(
nvm_’d_io
);

789 
	$nvm_subm™_io_sync_¿w
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

791 ià(!
dev
->
Ýs
->
subm™_io_sync
)

792  -
ENODEV
;

794 
rqd
->
æags
 = 
	`nvm_£t_æags
(&
dev
->
geo
,„qd);

796  
dev
->
Ýs
->
	`subm™_io_sync
(dev, 
rqd
);

797 
	}
}

799 
	$nvm_bb_chunk_£n£
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
)

801 
nvm_rq
 
rqd
 = { 
NULL
 };

802 
bio
 bio;

803 
bio_vec
 bio_vec;

804 
·ge
 *page;

805 
»t
;

807 
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

808 ià(!
·ge
)

809  -
ENOMEM
;

811 
	`bio_š™
(&
bio
, &
bio_vec
, 1);

812 
	`bio_add_·ge
(&
bio
, 
·ge
, 
PAGE_SIZE
, 0);

813 
	`bio_£t_Ý_©Œs
(&
bio
, 
REQ_OP_READ
, 0);

815 
rqd
.
bio
 = &bio;

816 
rqd
.
Ýcode
 = 
NVM_OP_PREAD
;

817 
rqd
.
is_£q
 = 1;

818 
rqd
.
Ä_µas
 = 1;

819 
rqd
.
µa_addr
 = 
	`g’”ic_to_dev_addr
(
dev
, 
µa
);

821 
»t
 = 
	`nvm_subm™_io_sync_¿w
(
dev
, &
rqd
);

822 ià(
»t
)

823  
»t
;

825 
	`__ä“_·ge
(
·ge
);

827  
rqd
.
”rÜ
;

828 
	}
}

835 
	$nvm_bb_chunk_sÿn
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
,

836 
nvm_chk_m‘a
 *
m‘a
)

838 
nvm_geo
 *
geo
 = &
dev
->geo;

839 
»t
, 
pg
, 
¶
;

842 
»t
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

843 ià(
»t
 < 0)

844  
»t
;

845 ià(
»t
 == 0)

846 
m‘a
->
¡©e
 = 
NVM_CHK_ST_OPEN
;

847 ià(
»t
 > 0) {

852 
»t
) {

853 
NVM_RSP_ERR_EMPTYPAGE
:

854 
m‘a
->
¡©e
 = 
NVM_CHK_ST_FREE
;

856 
NVM_RSP_ERR_FAILCRC
:

857 
NVM_RSP_ERR_FAILECC
:

858 
NVM_RSP_WARN_HIGHECC
:

859 
m‘a
->
¡©e
 = 
NVM_CHK_ST_OPEN
;

860 
sÿn
;

862  -
»t
;

867 
µa
.
g
.
pg
 = 
geo
->
num_pg
 - 1;

868 
µa
.
g
.
¶
 = 
geo
->
num_¶n
 - 1;

870 
»t
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

871 ià(
»t
 < 0)

872  
»t
;

873 ià(
»t
 == 0) {

874 
m‘a
->
¡©e
 = 
NVM_CHK_ST_CLOSED
;

875 
m‘a
->
wp
 = 
geo
->
þba
;

877 } ià(
»t
 > 0) {

878 
»t
) {

879 
NVM_RSP_ERR_EMPTYPAGE
:

880 
NVM_RSP_ERR_FAILCRC
:

881 
NVM_RSP_ERR_FAILECC
:

882 
NVM_RSP_WARN_HIGHECC
:

883 
m‘a
->
¡©e
 = 
NVM_CHK_ST_OPEN
;

886  -
»t
;

890 
sÿn
:

896 
pg
 = 0;…g < 
geo
->
num_pg
;…g++) {

897 
¶
 = 0;…È< 
geo
->
num_¶n
;…l++) {

898 
µa
.
g
.
pg
 =…g;

899 
µa
.
g
.
¶
 =…l;

901 
»t
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

902 ià(
»t
 < 0)

903  
»t
;

904 ià(
»t
 == 0) {

905 
m‘a
->
wp
 +ð
geo
->
ws_mš
;

906 } ià(
»t
 > 0) {

907 
»t
) {

908 
NVM_RSP_ERR_EMPTYPAGE
:

910 
NVM_RSP_ERR_FAILCRC
:

911 
NVM_RSP_ERR_FAILECC
:

912 
NVM_RSP_WARN_HIGHECC
:

913 
m‘a
->
wp
 +ð
geo
->
ws_mš
;

916  -
»t
;

923 
	}
}

932 
	$nvm_bb_to_chunk
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
,

933 
u8
 *
blks
, 
Ä_blks
, 
nvm_chk_m‘a
 *
m‘a
)

935 
nvm_geo
 *
geo
 = &
dev
->geo;

936 
»t
, 
blk
, 
¶
, 
off£t
, 
blkty³
;

938 
blk
 = 0; blk < 
geo
->
num_chk
; blk++) {

939 
off£t
 = 
blk
 * 
geo
->
¶n_mode
;

940 
blkty³
 = 
blks
[
off£t
];

942 
¶
 = 0;…È< 
geo
->
¶n_mode
;…l++) {

943 ià(
blks
[
off£t
 + 
¶
] &

944 (
NVM_BLK_T_BAD
|
NVM_BLK_T_GRWN_BAD
)) {

945 
blkty³
 = 
blks
[
off£t
 + 
¶
];

950 
µa
.
g
.
blk
 = blk;

952 
m‘a
->
wp
 = 0;

953 
m‘a
->
ty³
 = 
NVM_CHK_TP_W_SEQ
;

954 
m‘a
->
wi
 = 0;

955 
m‘a
->
¦ba
 = 
	`g’”ic_to_dev_addr
(
dev
, 
µa
).ppa;

956 
m‘a
->
úlb
 = 
dev
->
geo
.
þba
;

958 ià(
blkty³
 =ð
NVM_BLK_T_FREE
) {

959 
»t
 = 
	`nvm_bb_chunk_sÿn
(
dev
, 
µa
, 
m‘a
);

960 ià(
»t
)

961  
»t
;

963 
m‘a
->
¡©e
 = 
NVM_CHK_ST_OFFLINE
;

966 
m‘a
++;

970 
	}
}

972 
	$nvm_g‘_bb_m‘a
(
nvm_dev
 *
dev
, 
£ùÜ_t
 
¦ba
,

973 
nchks
, 
nvm_chk_m‘a
 *
m‘a
)

975 
nvm_geo
 *
geo
 = &
dev
->geo;

976 
µa_addr
 
µa
;

977 
u8
 *
blks
;

978 
ch
, 
lun
, 
Ä_blks
;

979 
»t
 = 0;

981 
µa
.µ¨ð
¦ba
;

982 
µa
 = 
	`dev_to_g’”ic_addr
(
dev
,…pa);

984 ià(
µa
.
g
.
blk
 != 0)

985  -
EINVAL
;

987 ià((
nchks
 % 
geo
->
num_chk
) != 0)

988  -
EINVAL
;

990 
Ä_blks
 = 
geo
->
num_chk
 * geo->
¶n_mode
;

992 
blks
 = 
	`km®loc
(
Ä_blks
, 
GFP_KERNEL
);

993 ià(!
blks
)

994  -
ENOMEM
;

996 
ch
 = 
µa
.
g
.ch; ch < 
geo
->
num_ch
; ch++) {

997 
lun
 = 
µa
.
g
.lun;†uÀ< 
geo
->
num_lun
;†un++) {

998 
µa_addr
 
µa_g’
, 
µa_dev
;

1000 ià(!
nchks
)

1001 
dÚe
;

1003 
µa_g’
.
µa
 = 0;

1004 
µa_g’
.
g
.
ch
 = ch;

1005 
µa_g’
.
g
.
lun
 =†un;

1006 
µa_dev
 = 
	`g’”ic_to_dev_addr
(
dev
, 
µa_g’
);

1008 
»t
 = 
dev
->
Ýs
->
	`g‘_bb_tbl
(dev, 
µa_dev
, 
blks
);

1009 ià(
»t
)

1010 
dÚe
;

1012 
»t
 = 
	`nvm_bb_to_chunk
(
dev
, 
µa_g’
, 
blks
, 
Ä_blks
,

1013 
m‘a
);

1014 ià(
»t
)

1015 
dÚe
;

1017 
m‘a
 +ð
geo
->
num_chk
;

1018 
nchks
 -ð
geo
->
num_chk
;

1021 
dÚe
:

1022 
	`kä“
(
blks
);

1023  
»t
;

1024 
	}
}

1026 
	$nvm_g‘_chunk_m‘a
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 
µa
,

1027 
nchks
, 
nvm_chk_m‘a
 *
m‘a
)

1029 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

1031 
	`nvm_µa_tgt_to_dev
(
tgt_dev
, &
µa
, 1);

1033 ià(
dev
->
geo
.
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
)

1034  
	`nvm_g‘_bb_m‘a
(
dev
, (
£ùÜ_t
)
µa
.µa, 
nchks
, 
m‘a
);

1036  
dev
->
Ýs
->
	`g‘_chk_m‘a
(dev, (
£ùÜ_t
)
µa
.µa, 
nchks
, 
m‘a
);

1037 
	}
}

1038 
EXPORT_SYMBOL_GPL
(
nvm_g‘_chunk_m‘a
);

1040 
	$nvm_£t_chunk_m‘a
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
µas
,

1041 
Ä_µas
, 
ty³
)

1043 
nvm_dev
 *
dev
 = 
tgt_dev
->
·»Á
;

1044 
nvm_rq
 
rqd
;

1045 
»t
;

1047 ià(
dev
->
geo
.
v”siÚ
 =ð
NVM_OCSSD_SPEC_20
)

1050 ià(
Ä_µas
 > 
NVM_MAX_VLBA
) {

1051 
	`´_”r
("nvm: unableo update‡ll blocks‡tomically\n");

1052  -
EINVAL
;

1055 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

1057 
	`nvm_£t_rqd_µ®i¡
(
tgt_dev
, &
rqd
, 
µas
, 
Ä_µas
);

1058 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, &
rqd
);

1060 
»t
 = 
dev
->
Ýs
->
	`£t_bb_tbl
(dev, &
rqd
.
µa_addr
,„qd.
Ä_µas
, 
ty³
);

1061 
	`nvm_ä“_rqd_µ®i¡
(
tgt_dev
, &
rqd
);

1062 ià(
»t
)

1063  -
EINVAL
;

1066 
	}
}

1067 
EXPORT_SYMBOL_GPL
(
nvm_£t_chunk_m‘a
);

1069 
	$nvm_cÜe_š™
(
nvm_dev
 *
dev
)

1071 
nvm_geo
 *
geo
 = &
dev
->geo;

1072 
»t
;

1074 
dev
->
lun_m­
 = 
	`kÿÎoc
(
	`BITS_TO_LONGS
(
geo
->
®l_luns
),

1075 (), 
GFP_KERNEL
);

1076 ià(!
dev
->
lun_m­
)

1077  -
ENOMEM
;

1079 
	`INIT_LIST_HEAD
(&
dev
->
¬—_li¡
);

1080 
	`INIT_LIST_HEAD
(&
dev
->
rg‘s
);

1081 
	`mu‹x_š™
(&
dev
->
mlock
);

1082 
	`¥š_lock_š™
(&
dev
->
lock
);

1084 
»t
 = 
	`nvm_»gi¡”_m­
(
dev
);

1085 ià(
»t
)

1086 
”r_fmty³
;

1089 
”r_fmty³
:

1090 
	`kä“
(
dev
->
lun_m­
);

1091  
»t
;

1092 
	}
}

1094 
	$nvm_ä“
(
k»f
 *
»f
)

1096 
nvm_dev
 *
dev
 = 
	`cÚš”_of
(
»f
, nvm_dev,„ef);

1098 ià(
dev
->
dma_poÞ
)

1099 
dev
->
Ýs
->
	`de¡roy_dma_poÞ
(dev->
dma_poÞ
);

1101 ià(
dev
->
rm­
)

1102 
	`nvm_uÄegi¡”_m­
(
dev
);

1104 
	`kä“
(
dev
->
lun_m­
);

1105 
	`kä“
(
dev
);

1106 
	}
}

1108 
	$nvm_š™
(
nvm_dev
 *
dev
)

1110 
nvm_geo
 *
geo
 = &
dev
->geo;

1111 
»t
 = -
EINVAL
;

1113 ià(
dev
->
Ýs
->
	`id’t™y
(dev)) {

1114 
	`´_”r
("nvm: device could‚ot be identified\n");

1115 
”r
;

1118 
	`´_debug
("nvm: ver:%u.%u‚vm_vendor:%x\n",

1119 
geo
->
majÜ_v”_id
, geo->
mšÜ_v”_id
,

1120 
geo
->
vmÁ
);

1122 
»t
 = 
	`nvm_cÜe_š™
(
dev
);

1123 ià(
»t
) {

1124 
	`´_”r
("nvm: could‚ot initialize core structures.\n");

1125 
”r
;

1128 
	`´_šfo
("nvm:„egistered %s [%u/%u/%u/%u/%u]\n",

1129 
dev
->
Çme
, dev->
geo
.
ws_mš
, dev->geo.
ws_Ýt
,

1130 
dev
->
geo
.
num_chk
, dev->geo.
®l_luns
,

1131 
dev
->
geo
.
num_ch
);

1133 
”r
:

1134 
	`´_”r
("nvm: failedo initialize‚vm\n");

1135  
»t
;

1136 
	}
}

1138 
nvm_dev
 *
	$nvm_®loc_dev
(
node
)

1140 
nvm_dev
 *
dev
;

1142 
dev
 = 
	`kz®loc_node
((
nvm_dev
), 
GFP_KERNEL
, 
node
);

1143 ià(
dev
)

1144 
	`k»f_š™
(&
dev
->
»f
);

1146  
dev
;

1147 
	}
}

1148 
EXPORT_SYMBOL
(
nvm_®loc_dev
);

1150 
	$nvm_»gi¡”
(
nvm_dev
 *
dev
)

1152 
»t
, 
exp_poÞ_size
;

1154 ià(!
dev
->
q
 || !dev->
Ýs
) {

1155 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1156  -
EINVAL
;

1159 
»t
 = 
	`nvm_š™
(
dev
);

1160 ià(
»t
) {

1161 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1162  
»t
;

1165 
exp_poÞ_size
 = 
	`max_t
(, 
PAGE_SIZE
,

1166 (
NVM_MAX_VLBA
 * ((
u64
è+ 
dev
->
geo
.
sos
)));

1167 
exp_poÞ_size
 = 
	`round_up
Óxp_poÞ_size, 
PAGE_SIZE
);

1169 
dev
->
dma_poÞ
 = dev->
Ýs
->
	`ü—‹_dma_poÞ
(dev, "ppalist",

1170 
exp_poÞ_size
);

1171 ià(!
dev
->
dma_poÞ
) {

1172 
	`´_”r
("nvm: could‚ot create dma…ool\n");

1173 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1174  -
ENOMEM
;

1178 
	`down_wr™e
(&
nvm_lock
);

1179 
	`li¡_add
(&
dev
->
deviûs
, &
nvm_deviûs
);

1180 
	`up_wr™e
(&
nvm_lock
);

1183 
	}
}

1184 
EXPORT_SYMBOL
(
nvm_»gi¡”
);

1186 
	$nvm_uÄegi¡”
(
nvm_dev
 *
dev
)

1188 
nvm_rg‘
 *
t
, *
tmp
;

1190 
	`mu‹x_lock
(&
dev
->
mlock
);

1191 
	`li¡_fÜ_—ch_’Œy_§ã
(
t
, 
tmp
, &
dev
->
rg‘s
, 
li¡
) {

1192 ià(
t
->
dev
->
·»Á
 != dev)

1194 
	`__nvm_»move_rg‘
(
t
, 
çl£
);

1195 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1197 
	`mu‹x_uÆock
(&
dev
->
mlock
);

1199 
	`down_wr™e
(&
nvm_lock
);

1200 
	`li¡_d–
(&
dev
->
deviûs
);

1201 
	`up_wr™e
(&
nvm_lock
);

1203 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1204 
	}
}

1205 
EXPORT_SYMBOL
(
nvm_uÄegi¡”
);

1207 
	$__nvm_cÚfigu»_ü—‹
(
nvm_ioùl_ü—‹
 *
ü—‹
)

1209 
nvm_dev
 *
dev
;

1210 
»t
;

1212 
	`down_wr™e
(&
nvm_lock
);

1213 
dev
 = 
	`nvm_fšd_nvm_dev
(
ü—‹
->dev);

1214 
	`up_wr™e
(&
nvm_lock
);

1216 ià(!
dev
) {

1217 
	`´_”r
("nvm: device‚ot found\n");

1218  -
EINVAL
;

1221 
	`k»f_g‘
(&
dev
->
»f
);

1222 
»t
 = 
	`nvm_ü—‹_tgt
(
dev
, 
ü—‹
);

1223 ià(
»t
)

1224 
	`k»f_put
(&
dev
->
»f
, 
nvm_ä“
);

1226  
»t
;

1227 
	}
}

1229 
	$nvm_ioùl_šfo
(
fže
 *fže, 
__u£r
 *
¬g
)

1231 
nvm_ioùl_šfo
 *
šfo
;

1232 
nvm_tgt_ty³
 *
‰
;

1233 
tgt_™”
 = 0;

1235 
šfo
 = 
	`memdup_u£r
(
¬g
, (
nvm_ioùl_šfo
));

1236 ià(
	`IS_ERR
(
šfo
))

1237  -
EFAULT
;

1239 
šfo
->
v”siÚ
[0] = 
NVM_VERSION_MAJOR
;

1240 
šfo
->
v”siÚ
[1] = 
NVM_VERSION_MINOR
;

1241 
šfo
->
v”siÚ
[2] = 
NVM_VERSION_PATCH
;

1243 
	`down_wr™e
(&
nvm_tg‰_lock
);

1244 
	`li¡_fÜ_—ch_’Œy
(
‰
, &
nvm_tgt_ty³s
, 
li¡
) {

1245 
nvm_ioùl_šfo_tgt
 *
tgt
 = &
šfo
->
tgts
[
tgt_™”
];

1247 
tgt
->
v”siÚ
[0] = 
‰
->version[0];

1248 
tgt
->
v”siÚ
[1] = 
‰
->version[1];

1249 
tgt
->
v”siÚ
[2] = 
‰
->version[2];

1250 
	`¡ºýy
(
tgt
->
tgŠame
, 
‰
->
Çme
, 
NVM_TTYPE_NAME_MAX
);

1252 
tgt_™”
++;

1255 
šfo
->
tgtsize
 = 
tgt_™”
;

1256 
	`up_wr™e
(&
nvm_tg‰_lock
);

1258 ià(
	`cÝy_to_u£r
(
¬g
, 
šfo
, (
nvm_ioùl_šfo
))) {

1259 
	`kä“
(
šfo
);

1260  -
EFAULT
;

1263 
	`kä“
(
šfo
);

1265 
	}
}

1267 
	$nvm_ioùl_g‘_deviûs
(
fže
 *fže, 
__u£r
 *
¬g
)

1269 
nvm_ioùl_g‘_deviûs
 *
deviûs
;

1270 
nvm_dev
 *
dev
;

1271 
i
 = 0;

1273 
deviûs
 = 
	`kz®loc
((
nvm_ioùl_g‘_deviûs
), 
GFP_KERNEL
);

1274 ià(!
deviûs
)

1275  -
ENOMEM
;

1277 
	`down_wr™e
(&
nvm_lock
);

1278 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
nvm_deviûs
, 
deviûs
) {

1279 
nvm_ioùl_deviû_šfo
 *
šfo
 = &
deviûs
->šfo[
i
];

1281 
	`¡¾ýy
(
šfo
->
devÇme
, 
dev
->
Çme
, (info->devname));

1284 
šfo
->
bmv”siÚ
[0] = 1;

1285 
šfo
->
bmv”siÚ
[1] = 0;

1286 
šfo
->
bmv”siÚ
[2] = 0;

1287 
	`¡¾ýy
(
šfo
->
bmÇme
, "gennvm", (info->bmname));

1288 
i
++;

1290 ià(
i
 > 31) {

1291 
	`´_”r
("nvm: max 31 devices can be„eported.\n");

1295 
	`up_wr™e
(&
nvm_lock
);

1297 
deviûs
->
Ä_deviûs
 = 
i
;

1299 ià(
	`cÝy_to_u£r
(
¬g
, 
deviûs
,

1300 (
nvm_ioùl_g‘_deviûs
))) {

1301 
	`kä“
(
deviûs
);

1302  -
EFAULT
;

1305 
	`kä“
(
deviûs
);

1307 
	}
}

1309 
	$nvm_ioùl_dev_ü—‹
(
fže
 *fže, 
__u£r
 *
¬g
)

1311 
nvm_ioùl_ü—‹
 
ü—‹
;

1313 ià(
	`cÝy_äom_u£r
(&
ü—‹
, 
¬g
, (
nvm_ioùl_ü—‹
)))

1314  -
EFAULT
;

1316 ià(
ü—‹
.
cÚf
.
ty³
 =ð
NVM_CONFIG_TYPE_EXTENDED
 &&

1317 
ü—‹
.
cÚf
.
e
.
rsv
 != 0) {

1318 
	`´_”r
("nvm:„eserved config field in use\n");

1319  -
EINVAL
;

1322 
ü—‹
.
dev
[
DISK_NAME_LEN
 - 1] = '\0';

1323 
ü—‹
.
tg‰y³
[
NVM_TTYPE_NAME_MAX
 - 1] = '\0';

1324 
ü—‹
.
tgŠame
[
DISK_NAME_LEN
 - 1] = '\0';

1326 ià(
ü—‹
.
æags
 != 0) {

1327 
__u32
 
æags
 = 
ü—‹
.flags;

1330 ià(
æags
 & 
NVM_TARGET_FACTORY
)

1331 
æags
 &ð~
NVM_TARGET_FACTORY
;

1333 ià(
æags
) {

1334 
	`´_”r
("nvm: flag‚ot supported\n");

1335  -
EINVAL
;

1339  
	`__nvm_cÚfigu»_ü—‹
(&
ü—‹
);

1340 
	}
}

1342 
	$nvm_ioùl_dev_»move
(
fže
 *fže, 
__u£r
 *
¬g
)

1344 
nvm_ioùl_»move
 
»move
;

1346 ià(
	`cÝy_äom_u£r
(&
»move
, 
¬g
, (
nvm_ioùl_»move
)))

1347  -
EFAULT
;

1349 
»move
.
tgŠame
[
DISK_NAME_LEN
 - 1] = '\0';

1351 ià(
»move
.
æags
 != 0) {

1352 
	`´_”r
("nvm:‚o flags supported\n");

1353  -
EINVAL
;

1356  
	`nvm_»move_tgt
(&
»move
);

1357 
	}
}

1360 
	$nvm_ioùl_dev_š™
(
fže
 *fže, 
__u£r
 *
¬g
)

1362 
nvm_ioùl_dev_š™
 
š™
;

1364 ià(
	`cÝy_äom_u£r
(&
š™
, 
¬g
, (
nvm_ioùl_dev_š™
)))

1365  -
EFAULT
;

1367 ià(
š™
.
æags
 != 0) {

1368 
	`´_”r
("nvm:‚o flags supported\n");

1369  -
EINVAL
;

1373 
	}
}

1376 
	$nvm_ioùl_dev_çùÜy
(
fže
 *fže, 
__u£r
 *
¬g
)

1378 
nvm_ioùl_dev_çùÜy
 
çù
;

1380 ià(
	`cÝy_äom_u£r
(&
çù
, 
¬g
, (
nvm_ioùl_dev_çùÜy
)))

1381  -
EFAULT
;

1383 
çù
.
dev
[
DISK_NAME_LEN
 - 1] = '\0';

1385 ià(
çù
.
æags
 & ~(
NVM_FACTORY_NR_BITS
 - 1))

1386  -
EINVAL
;

1389 
	}
}

1391 
	$nvm_ùl_ioùl
(
fže
 *fže, 
ušt
 
cmd
, 
¬g
)

1393 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

1395 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1396  -
EPERM
;

1398 
cmd
) {

1399 
NVM_INFO
:

1400  
	`nvm_ioùl_šfo
(
fže
, 
¬gp
);

1401 
NVM_GET_DEVICES
:

1402  
	`nvm_ioùl_g‘_deviûs
(
fže
, 
¬gp
);

1403 
NVM_DEV_CREATE
:

1404  
	`nvm_ioùl_dev_ü—‹
(
fže
, 
¬gp
);

1405 
NVM_DEV_REMOVE
:

1406  
	`nvm_ioùl_dev_»move
(
fže
, 
¬gp
);

1407 
NVM_DEV_INIT
:

1408  
	`nvm_ioùl_dev_š™
(
fže
, 
¬gp
);

1409 
NVM_DEV_FACTORY
:

1410  
	`nvm_ioùl_dev_çùÜy
(
fže
, 
¬gp
);

1413 
	}
}

1415 cÚ¡ 
fže_Ý”©iÚs
 
	g_ùl_fÝs
 = {

1416 .
Ý’
 = 
nÚ£ekabË_Ý’
,

1417 .
	guÆocked_ioùl
 = 
nvm_ùl_ioùl
,

1418 .
	gowÃr
 = 
THIS_MODULE
,

1419 .
	gÎ£ek
 = 
noÝ_Î£ek
,

1422 
miscdeviû
 
	g_nvm_misc
 = {

1423 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

1424 .
	gÇme
 = "lightnvm",

1425 .
	gnod’ame
 = "lightnvm/control",

1426 .
	gfÝs
 = &
_ùl_fÝs
,

1428 
bužtš_misc_deviû
(
_nvm_misc
);

	@pblk-cache.c

19 
	~"pblk.h
"

21 
	$pblk_wr™e_to_ÿche
(
pblk
 *pblk, 
bio
 *bio,

22 
æags
)

24 
»que¡_queue
 *
q
 = 
pblk
->
dev
->q;

25 
pblk_w_ùx
 
w_ùx
;

26 
£ùÜ_t
 
lba
 = 
	`pblk_g‘_lba
(
bio
);

27 
¡¬t_time
 = 
jiff›s
;

28 
bpos
, 
pos
;

29 
Ä_’Œ›s
 = 
	`pblk_g‘_£cs
(
bio
);

30 
i
, 
»t
;

32 
	`g’”ic_¡¬t_io_acù
(
q
, 
REQ_OP_WRITE
, 
	`bio_£ùÜs
(
bio
),

33 &
pblk
->
disk
->
·¹0
);

39 
»Œy
:

40 
»t
 = 
	`pblk_rb_may_wr™e_u£r
(&
pblk
->
rwb
, 
bio
, 
Ä_’Œ›s
, &
bpos
);

41 
»t
) {

42 
NVM_IO_REQUEUE
:

43 
	`io_scheduË
();

44 
»Œy
;

45 
NVM_IO_ERR
:

46 
	`pblk_p–še_¡Ý
(
pblk
);

47 
	`bio_io_”rÜ
(
bio
);

48 
out
;

51 
	`pblk_µa_£t_em±y
(&
w_ùx
.
µa
);

52 
w_ùx
.
æags
 = flags;

53 ià(
bio
->
bi_Ýf
 & 
REQ_PREFLUSH
) {

54 
w_ùx
.
æags
 |ð
PBLK_FLUSH_ENTRY
;

55 
	`pblk_wr™e_kick
(
pblk
);

58 ià(
	`uÆik–y
(!
	`bio_has_d©a
(
bio
)))

59 
out
;

61 
i
 = 0; i < 
Ä_’Œ›s
; i++) {

62 *
d©a
 = 
	`bio_d©a
(
bio
);

64 
w_ùx
.
lba
 =†b¨+ 
i
;

66 
pos
 = 
	`pblk_rb_w¿p_pos
(&
pblk
->
rwb
, 
bpos
 + 
i
);

67 
	`pblk_rb_wr™e_’Œy_u£r
(&
pblk
->
rwb
, 
d©a
, 
w_ùx
, 
pos
);

69 
	`bio_advªû
(
bio
, 
PBLK_EXPOSED_PAGE_SIZE
);

72 
	`©omic64_add
(
Ä_’Œ›s
, &
pblk
->
u£r_wa
);

74 #ifdeà
CONFIG_NVM_PBLK_DEBUG


75 
	`©omic_lÚg_add
(
Ä_’Œ›s
, &
pblk
->
šæight_wr™es
);

76 
	`©omic_lÚg_add
(
Ä_’Œ›s
, &
pblk
->
»q_wr™es
);

79 
	`pblk_¾_š£¹ed
(&
pblk
->
¾
, 
Ä_’Œ›s
);

81 
out
:

82 
	`g’”ic_’d_io_acù
(
q
, 
REQ_OP_WRITE
, &
pblk
->
disk
->
·¹0
, 
¡¬t_time
);

83 
	`pblk_wr™e_should_kick
(
pblk
);

85 ià(
»t
 =ð
NVM_IO_DONE
)

86 
	`bio_’dio
(
bio
);

87 
	}
}

93 
	$pblk_wr™e_gc_to_ÿche
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
)

95 
pblk_w_ùx
 
w_ùx
;

96 
bpos
, 
pos
;

97 *
d©a
 = 
gc_rq
->data;

98 
i
, 
v®id_’Œ›s
;

104 
»Œy
:

105 ià(!
	`pblk_rb_may_wr™e_gc
(&
pblk
->
rwb
, 
gc_rq
->
£cs_to_gc
, &
bpos
)) {

106 
	`io_scheduË
();

107 
»Œy
;

110 
w_ùx
.
æags
 = 
PBLK_IOTYPE_GC
;

111 
	`pblk_µa_£t_em±y
(&
w_ùx
.
µa
);

113 
i
 = 0, 
v®id_’Œ›s
 = 0; i < 
gc_rq
->
Ä_£cs
; i++) {

114 ià(
gc_rq
->
lba_li¡
[
i
] =ð
ADDR_EMPTY
)

117 
w_ùx
.
lba
 = 
gc_rq
->
lba_li¡
[
i
];

119 
pos
 = 
	`pblk_rb_w¿p_pos
(&
pblk
->
rwb
, 
bpos
 + 
v®id_’Œ›s
);

120 
	`pblk_rb_wr™e_’Œy_gc
(&
pblk
->
rwb
, 
d©a
, 
w_ùx
, 
gc_rq
->
lše
,

121 
gc_rq
->
·ddr_li¡
[
i
], 
pos
);

123 
d©a
 +ð
PBLK_EXPOSED_PAGE_SIZE
;

124 
v®id_’Œ›s
++;

127 
	`WARN_ONCE
(
gc_rq
->
£cs_to_gc
 !ð
v®id_’Œ›s
,

130 
	`©omic64_add
(
v®id_’Œ›s
, &
pblk
->
gc_wa
);

132 #ifdeà
CONFIG_NVM_PBLK_DEBUG


133 
	`©omic_lÚg_add
(
v®id_’Œ›s
, &
pblk
->
šæight_wr™es
);

134 
	`©omic_lÚg_add
(
v®id_’Œ›s
, &
pblk
->
»cov_gc_wr™es
);

137 
	`pblk_wr™e_should_kick
(
pblk
);

138  
NVM_IO_OK
;

139 
	}
}

	@pblk-core.c

20 
	#CREATE_TRACE_POINTS


	)

22 
	~"pblk.h
"

23 
	~"pblk-Œaû.h
"

25 
	$pblk_lše_m¬k_bb
(
wÜk_¡ruù
 *
wÜk
)

27 
pblk_lše_ws
 *
lše_ws
 = 
	`cÚš”_of
(
wÜk
, pblk_line_ws,

28 
ws
);

29 
pblk
 *pblk = 
lše_ws
->pblk;

30 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

31 
µa_addr
 *
µa
 = 
lše_ws
->
´iv
;

32 
»t
;

34 
»t
 = 
	`nvm_£t_chunk_m‘a
(
dev
, 
µa
, 1, 
NVM_BLK_T_GRWN_BAD
);

35 ià(
»t
) {

36 
pblk_lše
 *
lše
;

37 
pos
;

39 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, *
µa
);

40 
pos
 = 
	`pblk_µa_to_pos
(&
dev
->
geo
, *
µa
);

42 
	`pblk_”r
(
pblk
, "failedo mark bb,†ine:%d,…os:%d\n",

43 
lše
->
id
, 
pos
);

46 
	`kä“
(
µa
);

47 
	`mempoÞ_ä“
(
lše_ws
, &
pblk
->
g’_ws_poÞ
);

48 
	}
}

50 
	$pblk_m¬k_bb
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

51 
µa_addr
…pa_addr)

53 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

54 
nvm_geo
 *
geo
 = &
dev
->geo;

55 
µa_addr
 *
µa
;

56 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_addr
);

58 
	`pblk_debug
(
pblk
, "”a£ fažed:†še:%d,…os:%d\n", 
lše
->
id
, 
pos
);

59 
	`©omic_lÚg_šc
(&
pblk
->
”a£_çžed
);

61 
	`©omic_dec
(&
lše
->
blk_š_lše
);

62 ià(
	`‹¡_ªd_£t_b™
(
pos
, 
lše
->
blk_b™m­
))

63 
	`pblk_”r
(
pblk
, "attemptedoƒrase bb:†ine:%d,…os:%d\n",

64 
lše
->
id
, 
pos
);

67 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_20
)

70 
µa
 = 
	`km®loc
((
µa_addr
), 
GFP_ATOMIC
);

71 ià(!
µa
)

74 *
µa
 = 
µa_addr
;

75 
	`pblk_g’_run_ws
(
pblk
, 
NULL
, 
µa
, 
pblk_lše_m¬k_bb
,

76 
GFP_ATOMIC
, 
pblk
->
bb_wq
);

77 
	}
}

79 
	$__pblk_’d_io_”a£
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

81 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

82 
nvm_geo
 *
geo
 = &
dev
->geo;

83 
nvm_chk_m‘a
 *
chunk
;

84 
pblk_lše
 *
lše
;

85 
pos
;

87 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
rqd
->
µa_addr
);

88 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
rqd
->
µa_addr
);

89 
chunk
 = &
lše
->
chks
[
pos
];

91 
	`©omic_dec
(&
lše
->
Ëá_£blks
);

93 ià(
rqd
->
”rÜ
) {

94 
	`Œaû_pblk_chunk_»£t
(
	`pblk_disk_Çme
(
pblk
),

95 &
rqd
->
µa_addr
, 
PBLK_CHUNK_RESET_FAILED
);

97 
chunk
->
¡©e
 = 
NVM_CHK_ST_OFFLINE
;

98 
	`pblk_m¬k_bb
(
pblk
, 
lše
, 
rqd
->
µa_addr
);

100 
	`Œaû_pblk_chunk_»£t
(
	`pblk_disk_Çme
(
pblk
),

101 &
rqd
->
µa_addr
, 
PBLK_CHUNK_RESET_DONE
);

103 
chunk
->
¡©e
 = 
NVM_CHK_ST_FREE
;

106 
	`Œaû_pblk_chunk_¡©e
(
	`pblk_disk_Çme
(
pblk
), &
rqd
->
µa_addr
,

107 
chunk
->
¡©e
);

109 
	`©omic_dec
(&
pblk
->
šæight_io
);

110 
	}
}

113 
	$pblk_’d_io_”a£
(
nvm_rq
 *
rqd
)

115 
pblk
 *pblk = 
rqd
->
´iv©e
;

117 
	`__pblk_’d_io_”a£
(
pblk
, 
rqd
);

118 
	`mempoÞ_ä“
(
rqd
, &
pblk
->
e_rq_poÞ
);

119 
	}
}

126 
nvm_chk_m‘a
 *
	$pblk_g‘_chunk_m‘a
(
pblk
 *pblk)

128 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

129 
nvm_geo
 *
geo
 = &
dev
->geo;

130 
nvm_chk_m‘a
 *
m‘a
;

131 
µa_addr
 
µa
;

132 
Ën
;

133 
»t
;

135 
µa
.ppa = 0;

137 
Ën
 = 
geo
->
®l_chunks
 * (*
m‘a
);

138 
m‘a
 = 
	`vz®loc
(
Ën
);

139 ià(!
m‘a
)

140  
	`ERR_PTR
(-
ENOMEM
);

142 
»t
 = 
	`nvm_g‘_chunk_m‘a
(
dev
, 
µa
, 
geo
->
®l_chunks
, 
m‘a
);

143 ià(
»t
) {

144 
	`vä“
(
m‘a
);

145  
	`ERR_PTR
(-
EIO
);

148  
m‘a
;

149 
	}
}

151 
nvm_chk_m‘a
 *
	$pblk_chunk_g‘_off
(
pblk
 *pblk,

152 
nvm_chk_m‘a
 *
m‘a
,

153 
µa_addr
 
µa
)

155 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

156 
nvm_geo
 *
geo
 = &
dev
->geo;

157 
ch_off
 = 
µa
.
m
.
g½
 * 
geo
->
num_chk
 * geo->
num_lun
;

158 
lun_off
 = 
µa
.
m
.
pu
 * 
geo
->
num_chk
;

159 
chk_off
 = 
µa
.
m
.
chk
;

161  
m‘a
 + 
ch_off
 + 
lun_off
 + 
chk_off
;

162 
	}
}

164 
	$__pblk_m­_šv®id©e
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

165 
u64
 
·ddr
)

167 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

168 
li¡_h—d
 *
move_li¡
 = 
NULL
;

174 
	`¥š_lock
(&
lše
->
lock
);

175 
	`WARN_ON
(
lše
->
¡©e
 =ð
PBLK_LINESTATE_FREE
);

177 ià(
	`‹¡_ªd_£t_b™
(
·ddr
, 
lše
->
šv®id_b™m­
)) {

178 
	`WARN_ONCE
(1, "pblk: double invalidate\n");

179 
	`¥š_uÆock
(&
lše
->
lock
);

182 
	`Ë32_add_ýu
(
lše
->
vsc
, -1);

184 ià(
lše
->
¡©e
 =ð
PBLK_LINESTATE_CLOSED
)

185 
move_li¡
 = 
	`pblk_lše_gc_li¡
(
pblk
, 
lše
);

186 
	`¥š_uÆock
(&
lše
->
lock
);

188 ià(
move_li¡
) {

189 
	`¥š_lock
(&
l_mg
->
gc_lock
);

190 
	`¥š_lock
(&
lše
->
lock
);

192 ià(
lše
->
¡©e
 =ð
PBLK_LINESTATE_GC
) {

193 
	`¥š_uÆock
(&
lše
->
lock
);

194 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

197 
	`¥š_uÆock
(&
lše
->
lock
);

199 
	`li¡_move_ž
(&
lše
->
li¡
, 
move_li¡
);

200 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

202 
	}
}

204 
	$pblk_m­_šv®id©e
(
pblk
 *pblk, 
µa_addr
 
µa
)

206 
pblk_lše
 *
lše
;

207 
u64
 
·ddr
;

209 #ifdeà
CONFIG_NVM_PBLK_DEBUG


211 
	`BUG_ON
(
	`pblk_addr_š_ÿche
(
µa
));

212 
	`BUG_ON
(
	`pblk_µa_em±y
(
µa
));

215 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
µa
);

216 
·ddr
 = 
	`pblk_dev_µa_to_lše_addr
(
pblk
, 
µa
);

218 
	`__pblk_m­_šv®id©e
(
pblk
, 
lše
, 
·ddr
);

219 
	}
}

221 
	$pblk_šv®id©e_¿nge
(
pblk
 *pblk, 
£ùÜ_t
 
¦ba
,

222 
Ä_£cs
)

224 
£ùÜ_t
 
lba
;

226 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

227 
lba
 = 
¦ba
;†b¨< slb¨+ 
Ä_£cs
;†ba++) {

228 
µa_addr
 
µa
;

230 
µa
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

232 ià(!
	`pblk_addr_š_ÿche
(
µa
è&& !
	`pblk_µa_em±y
(ppa))

233 
	`pblk_m­_šv®id©e
(
pblk
, 
µa
);

235 
	`pblk_µa_£t_em±y
(&
µa
);

236 
	`pblk_Œªs_m­_£t
(
pblk
, 
lba
, 
µa
);

238 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

239 
	}
}

241 
	$pblk_®loc_rqd_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

243 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

245 
rqd
->
m‘a_li¡
 = 
	`nvm_dev_dma_®loc
(
dev
->
·»Á
, 
GFP_KERNEL
,

246 &
rqd
->
dma_m‘a_li¡
);

247 ià(!
rqd
->
m‘a_li¡
)

248  -
ENOMEM
;

250 ià(
rqd
->
Ä_µas
 == 1)

253 
rqd
->
µa_li¡
 =„qd->
m‘a_li¡
 + 
	`pblk_dma_m‘a_size
(
pblk
);

254 
rqd
->
dma_µa_li¡
 =„qd->
dma_m‘a_li¡
 + 
	`pblk_dma_m‘a_size
(
pblk
);

257 
	}
}

259 
	$pblk_ä“_rqd_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

261 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

263 ià(
rqd
->
m‘a_li¡
)

264 
	`nvm_dev_dma_ä“
(
dev
->
·»Á
, 
rqd
->
m‘a_li¡
,

265 
rqd
->
dma_m‘a_li¡
);

266 
	}
}

269 
nvm_rq
 *
	$pblk_®loc_rqd
(
pblk
 *pblk, 
ty³
)

271 
mempoÞ_t
 *
poÞ
;

272 
nvm_rq
 *
rqd
;

273 
rq_size
;

275 
ty³
) {

276 
PBLK_WRITE
:

277 
PBLK_WRITE_INT
:

278 
poÞ
 = &
pblk
->
w_rq_poÞ
;

279 
rq_size
 = 
pblk_w_rq_size
;

281 
PBLK_READ
:

282 
poÞ
 = &
pblk
->
r_rq_poÞ
;

283 
rq_size
 = 
pblk_g_rq_size
;

286 
poÞ
 = &
pblk
->
e_rq_poÞ
;

287 
rq_size
 = 
pblk_g_rq_size
;

290 
rqd
 = 
	`mempoÞ_®loc
(
poÞ
, 
GFP_KERNEL
);

291 
	`mem£t
(
rqd
, 0, 
rq_size
);

293  
rqd
;

294 
	}
}

297 
	$pblk_ä“_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
ty³
)

299 
mempoÞ_t
 *
poÞ
;

301 
ty³
) {

302 
PBLK_WRITE
:

303 
	`kä“
(((
pblk_c_ùx
 *)
	`nvm_rq_to_pdu
(
rqd
))->
lun_b™m­
);

305 
PBLK_WRITE_INT
:

306 
poÞ
 = &
pblk
->
w_rq_poÞ
;

308 
PBLK_READ
:

309 
poÞ
 = &
pblk
->
r_rq_poÞ
;

311 
PBLK_ERASE
:

312 
poÞ
 = &
pblk
->
e_rq_poÞ
;

315 
	`pblk_”r
(
pblk
, "tryingo free unknown„qdype\n");

319 
	`pblk_ä“_rqd_m‘a
(
pblk
, 
rqd
);

320 
	`mempoÞ_ä“
(
rqd
, 
poÞ
);

321 
	}
}

323 
	$pblk_bio_ä“_·ges
(
pblk
 *pblk, 
bio
 *bio, 
off
,

324 
Ä_·ges
)

326 
bio_vec
 
bv
;

327 
i
;

329 
	`WARN_ON
(
off
 + 
Ä_·ges
 !ð
bio
->
bi_vút
);

331 
i
 = 
off
; i < 
Ä_·ges
 + off; i++) {

332 
bv
 = 
bio
->
bi_io_vec
[
i
];

333 
	`mempoÞ_ä“
(
bv
.
bv_·ge
, &
pblk
->
·ge_bio_poÞ
);

335 
	}
}

337 
	$pblk_bio_add_·ges
(
pblk
 *pblk, 
bio
 *bio, 
gå_t
 
æags
,

338 
Ä_·ges
)

340 
»que¡_queue
 *
q
 = 
pblk
->
dev
->q;

341 
·ge
 *page;

342 
i
, 
»t
;

344 
i
 = 0; i < 
Ä_·ges
; i++) {

345 
·ge
 = 
	`mempoÞ_®loc
(&
pblk
->
·ge_bio_poÞ
, 
æags
);

347 
»t
 = 
	`bio_add_pc_·ge
(
q
, 
bio
, 
·ge
, 
PBLK_EXPOSED_PAGE_SIZE
, 0);

348 ià(
»t
 !ð
PBLK_EXPOSED_PAGE_SIZE
) {

349 
	`pblk_”r
(
pblk
, "could‚ot‡dd…ageo bio\n");

350 
	`mempoÞ_ä“
(
·ge
, &
pblk
->
·ge_bio_poÞ
);

351 
”r
;

356 
”r
:

357 
	`pblk_bio_ä“_·ges
(
pblk
, 
bio
, (bio->
bi_vút
 - 
i
), i);

359 
	}
}

361 
	$pblk_wr™e_kick
(
pblk
 *pblk)

363 
	`wake_up_´oûss
(
pblk
->
wr™”_ts
);

364 
	`mod_tim”
(&
pblk
->
wtim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(1000));

365 
	}
}

367 
	$pblk_wr™e_tim”_â
(
tim”_li¡
 *
t
)

369 
pblk
 *pblk = 
	`äom_tim”
Õblk, 
t
, 
wtim”
);

372 
	`pblk_wr™e_kick
(
pblk
);

373 
	}
}

375 
	$pblk_wr™e_should_kick
(
pblk
 *pblk)

377 
£cs_avaž
 = 
	`pblk_rb_»ad_couÁ
(&
pblk
->
rwb
);

379 ià(
£cs_avaž
 >ð
pblk
->
mš_wr™e_pgs_d©a
)

380 
	`pblk_wr™e_kick
(
pblk
);

381 
	}
}

383 
	$pblk_wa™_fÜ_m‘a
(
pblk
 *pblk)

386 ià(!
	`©omic_»ad
(&
pblk
->
šæight_io
))

389 
	`scheduË
();

391 
	}
}

393 
	$pblk_æush_wr™”
(
pblk
 *pblk)

395 
	`pblk_rb_æush
(&
pblk
->
rwb
);

397 ià(!
	`pblk_rb_sync_couÁ
(&
pblk
->
rwb
))

400 
	`pblk_wr™e_kick
(
pblk
);

401 
	`scheduË
();

403 
	}
}

405 
li¡_h—d
 *
	$pblk_lše_gc_li¡
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

407 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

408 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

409 
li¡_h—d
 *
move_li¡
 = 
NULL
;

410 
·cked_m‘a
 = (
	`Ë32_to_ýu
(*
lše
->
vsc
è/ 
pblk
->
mš_wr™e_pgs_d©a
)

411 * (
pblk
->
mš_wr™e_pgs
 -…blk->
mš_wr™e_pgs_d©a
);

412 
vsc
 = 
	`Ë32_to_ýu
(*
lše
->vscè+ 
·cked_m‘a
;

414 
	`lockd•_as£¹_h–d
(&
lše
->
lock
);

416 ià(
lše
->
w_”r_gc
->
has_wr™e_”r
) {

417 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_WERR
) {

418 
lše
->
gc_group
 = 
PBLK_LINEGC_WERR
;

419 
move_li¡
 = &
l_mg
->
gc_w”r_li¡
;

420 
	`pblk_¾_w”r_lše_š
(&
pblk
->
¾
);

422 } ià(!
vsc
) {

423 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_FULL
) {

424 
lše
->
gc_group
 = 
PBLK_LINEGC_FULL
;

425 
move_li¡
 = &
l_mg
->
gc_fuÎ_li¡
;

427 } ià(
vsc
 < 
lm
->
high_thrs
) {

428 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_HIGH
) {

429 
lše
->
gc_group
 = 
PBLK_LINEGC_HIGH
;

430 
move_li¡
 = &
l_mg
->
gc_high_li¡
;

432 } ià(
vsc
 < 
lm
->
mid_thrs
) {

433 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_MID
) {

434 
lše
->
gc_group
 = 
PBLK_LINEGC_MID
;

435 
move_li¡
 = &
l_mg
->
gc_mid_li¡
;

437 } ià(
vsc
 < 
lše
->
£c_š_lše
) {

438 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_LOW
) {

439 
lše
->
gc_group
 = 
PBLK_LINEGC_LOW
;

440 
move_li¡
 = &
l_mg
->
gc_low_li¡
;

442 } ià(
vsc
 =ð
lše
->
£c_š_lše
) {

443 ià(
lše
->
gc_group
 !ð
PBLK_LINEGC_EMPTY
) {

444 
lše
->
gc_group
 = 
PBLK_LINEGC_EMPTY
;

445 
move_li¡
 = &
l_mg
->
gc_em±y_li¡
;

448 
lše
->
¡©e
 = 
PBLK_LINESTATE_CORRUPT
;

449 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

450 
lše
->
¡©e
);

452 
lše
->
gc_group
 = 
PBLK_LINEGC_NONE
;

453 
move_li¡
 = &
l_mg
->
cÜru±_li¡
;

454 
	`pblk_”r
(
pblk
, "corrupted vsc for†ine %d, vsc:%d (%d/%d/%d)\n",

455 
lše
->
id
, 
vsc
,

456 
lše
->
£c_š_lše
,

457 
lm
->
high_thrs
,†m->
mid_thrs
);

460  
move_li¡
;

461 
	}
}

463 
	$pblk_disÿrd
(
pblk
 *pblk, 
bio
 *bio)

465 
£ùÜ_t
 
¦ba
 = 
	`pblk_g‘_lba
(
bio
);

466 
£ùÜ_t
 
Ä_£cs
 = 
	`pblk_g‘_£cs
(
bio
);

468 
	`pblk_šv®id©e_¿nge
(
pblk
, 
¦ba
, 
Ä_£cs
);

469 
	}
}

471 
	$pblk_log_wr™e_”r
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

473 
	`©omic_lÚg_šc
(&
pblk
->
wr™e_çžed
);

474 #ifdeà
CONFIG_NVM_PBLK_DEBUG


475 
	`pblk_´št_çžed_rqd
(
pblk
, 
rqd
,„qd->
”rÜ
);

477 
	}
}

479 
	$pblk_log_»ad_”r
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

482 ià(
rqd
->
”rÜ
 =ð
NVM_RSP_ERR_EMPTYPAGE
) {

483 
	`©omic_lÚg_šc
(&
pblk
->
»ad_em±y
);

487 
rqd
->
”rÜ
) {

488 
NVM_RSP_WARN_HIGHECC
:

489 
	`©omic_lÚg_šc
(&
pblk
->
»ad_high_ecc
);

491 
NVM_RSP_ERR_FAILECC
:

492 
NVM_RSP_ERR_FAILCRC
:

493 
	`©omic_lÚg_šc
(&
pblk
->
»ad_çžed
);

496 
	`pblk_”r
(
pblk
, "unknowÀ»adƒ¼Ü:%d\n", 
rqd
->
”rÜ
);

498 #ifdeà
CONFIG_NVM_PBLK_DEBUG


499 
	`pblk_´št_çžed_rqd
(
pblk
, 
rqd
,„qd->
”rÜ
);

501 
	}
}

503 
	$pblk_£t_£c_³r_wr™e
(
pblk
 *pblk, 
£c_³r_wr™e
)

505 
pblk
->
£c_³r_wr™e
 = sec_per_write;

506 
	}
}

508 
	$pblk_subm™_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

510 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

512 
	`©omic_šc
(&
pblk
->
šæight_io
);

514 #ifdeà
CONFIG_NVM_PBLK_DEBUG


515 ià(
	`pblk_check_io
(
pblk
, 
rqd
))

516  
NVM_IO_ERR
;

519  
	`nvm_subm™_io
(
dev
, 
rqd
);

520 
	}
}

522 
	$pblk_check_chunk_¡©e_upd©e
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

524 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

526 
i
;

528 
i
 = 0; i < 
rqd
->
Ä_µas
; i++) {

529 
µa_addr
 *
µa
 = &
µa_li¡
[
i
];

530 
nvm_chk_m‘a
 *
chunk
 = 
	`pblk_dev_µa_to_chunk
(
pblk
, *
µa
);

531 
u64
 
ÿddr
 = 
	`pblk_dev_µa_to_chunk_addr
(
pblk
, *
µa
);

533 ià(
ÿddr
 == 0)

534 
	`Œaû_pblk_chunk_¡©e
(
	`pblk_disk_Çme
(
pblk
),

535 
µa
, 
NVM_CHK_ST_OPEN
);

536 ià(
ÿddr
 =ð(
chunk
->
úlb
 - 1))

537 
	`Œaû_pblk_chunk_¡©e
(
	`pblk_disk_Çme
(
pblk
),

538 
µa
, 
NVM_CHK_ST_CLOSED
);

540 
	}
}

542 
	$pblk_subm™_io_sync
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

544 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

545 
»t
;

547 
	`©omic_šc
(&
pblk
->
šæight_io
);

549 #ifdeà
CONFIG_NVM_PBLK_DEBUG


550 ià(
	`pblk_check_io
(
pblk
, 
rqd
))

551  
NVM_IO_ERR
;

554 
»t
 = 
	`nvm_subm™_io_sync
(
dev
, 
rqd
);

556 ià(
	`Œaû_pblk_chunk_¡©e_’abËd
(è&& !
»t
 &&

557 
rqd
->
Ýcode
 =ð
NVM_OP_PWRITE
)

558 
	`pblk_check_chunk_¡©e_upd©e
(
pblk
, 
rqd
);

560  
»t
;

561 
	}
}

563 
	$pblk_subm™_io_sync_£m
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

565 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

566 
»t
;

568 
	`pblk_down_chunk
(
pblk
, 
µa_li¡
[0]);

569 
»t
 = 
	`pblk_subm™_io_sync
(
pblk
, 
rqd
);

570 
	`pblk_up_chunk
(
pblk
, 
µa_li¡
[0]);

572  
»t
;

573 
	}
}

575 
	$pblk_bio_m­_addr_’dio
(
bio
 *bio)

577 
	`bio_put
(
bio
);

578 
	}
}

580 
bio
 *
	$pblk_bio_m­_addr
(
pblk
 *pblk, *
d©a
,

581 
Ä_£cs
, 
Ën
,

582 
®loc_ty³
, 
gå_t
 
gå_mask
)

584 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

585 *
kaddr
 = 
d©a
;

586 
·ge
 *page;

587 
bio
 *bio;

588 
i
, 
»t
;

590 ià(
®loc_ty³
 =ð
PBLK_KMALLOC_META
)

591  
	`bio_m­_k”n
(
dev
->
q
, 
kaddr
, 
Ën
, 
gå_mask
);

593 
bio
 = 
	`bio_km®loc
(
gå_mask
, 
Ä_£cs
);

594 ià(!
bio
)

595  
	`ERR_PTR
(-
ENOMEM
);

597 
i
 = 0; i < 
Ä_£cs
; i++) {

598 
·ge
 = 
	`vm®loc_to_·ge
(
kaddr
);

599 ià(!
·ge
) {

600 
	`pblk_”r
(
pblk
, "could‚ot map vmalloc bio\n");

601 
	`bio_put
(
bio
);

602 
bio
 = 
	`ERR_PTR
(-
ENOMEM
);

603 
out
;

606 
»t
 = 
	`bio_add_pc_·ge
(
dev
->
q
, 
bio
, 
·ge
, 
PAGE_SIZE
, 0);

607 ià(
»t
 !ð
PAGE_SIZE
) {

608 
	`pblk_”r
(
pblk
, "could‚ot‡dd…ageo bio\n");

609 
	`bio_put
(
bio
);

610 
bio
 = 
	`ERR_PTR
(-
ENOMEM
);

611 
out
;

614 
kaddr
 +ð
PAGE_SIZE
;

617 
bio
->
bi_’d_io
 = 
pblk_bio_m­_addr_’dio
;

618 
out
:

619  
bio
;

620 
	}
}

622 
	$pblk_ÿlc_£cs
(
pblk
 *pblk, 
£cs_avaž
,

623 
£cs_to_æush
, 
boÞ
 
sk_m‘a
)

625 
max
 = 
pblk
->
£c_³r_wr™e
;

626 
mš
 = 
pblk
->
mš_wr™e_pgs
;

627 
£cs_to_sync
 = 0;

629 ià(
sk_m‘a
 && 
pblk
->
mš_wr™e_pgs_d©a
 !ðpblk->
mš_wr™e_pgs
)

630 
mš
 = 
max
 = 
pblk
->
mš_wr™e_pgs_d©a
;

632 ià(
£cs_avaž
 >ð
max
)

633 
£cs_to_sync
 = 
max
;

634 ià(
£cs_avaž
 >ð
mš
)

635 
£cs_to_sync
 = 
mš
 * (
£cs_avaž
 / min);

636 ià(
£cs_to_æush
)

637 
£cs_to_sync
 = 
mš
;

639  
£cs_to_sync
;

640 
	}
}

642 
	$pblk_d—Îoc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
)

644 
u64
 
addr
;

645 
i
;

647 
	`¥š_lock
(&
lše
->
lock
);

648 
addr
 = 
	`fšd_Ãxt_z”o_b™
(
lše
->
m­_b™m­
,

649 
pblk
->
lm
.
£c_³r_lše
, 
lše
->
cur_£c
);

650 
lše
->
cur_£c
 = 
addr
 - 
Ä_£cs
;

652 
i
 = 0; i < 
Ä_£cs
; i++, 
lše
->
cur_£c
--)

653 
	`WARN_ON
(!
	`‹¡_ªd_þ—r_b™
(
lše
->
cur_£c
,†še->
m­_b™m­
));

654 
	`¥š_uÆock
(&
lše
->
lock
);

655 
	}
}

657 
u64
 
	$__pblk_®loc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
)

659 
u64
 
addr
;

660 
i
;

662 
	`lockd•_as£¹_h–d
(&
lše
->
lock
);

665 ià(
lše
->
cur_£c
 + 
Ä_£cs
 > 
pblk
->
lm
.
£c_³r_lše
) {

666 
	`WARN
(1, "pblk:…age‡llocation out of bounds\n");

667 
Ä_£cs
 = 
pblk
->
lm
.
£c_³r_lše
 - 
lše
->
cur_£c
;

670 
lše
->
cur_£c
 = 
addr
 = 
	`fšd_Ãxt_z”o_b™
Öše->
m­_b™m­
,

671 
pblk
->
lm
.
£c_³r_lše
, 
lše
->
cur_£c
);

672 
i
 = 0; i < 
Ä_£cs
; i++, 
lše
->
cur_£c
++)

673 
	`WARN_ON
(
	`‹¡_ªd_£t_b™
(
lše
->
cur_£c
,†še->
m­_b™m­
));

675  
addr
;

676 
	}
}

678 
u64
 
	$pblk_®loc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
)

680 
u64
 
addr
;

685 
	`¥š_lock
(&
lše
->
lock
);

686 
addr
 = 
	`__pblk_®loc_·ge
(
pblk
, 
lše
, 
Ä_£cs
);

687 
lše
->
Ëá_m£cs
 -ð
Ä_£cs
;

688 
	`WARN
(
lše
->
Ëá_m£cs
 < 0, "pblk:…age‡llocation out of bounds\n");

689 
	`¥š_uÆock
(&
lše
->
lock
);

691  
addr
;

692 
	}
}

694 
u64
 
	$pblk_lookup_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

696 
u64
 
·ddr
;

698 
	`¥š_lock
(&
lše
->
lock
);

699 
·ddr
 = 
	`fšd_Ãxt_z”o_b™
(
lše
->
m­_b™m­
,

700 
pblk
->
lm
.
£c_³r_lše
, 
lše
->
cur_£c
);

701 
	`¥š_uÆock
(&
lše
->
lock
);

703  
·ddr
;

704 
	}
}

706 
u64
 
	$pblk_lše_sm‘a_¡¬t
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

708 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

709 
nvm_geo
 *
geo
 = &
dev
->geo;

710 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

711 
b™
;

714 
b™
 = 
	`fšd_fœ¡_z”o_b™
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

715 ià(
b™
 >ð
lm
->
blk_³r_lše
)

718  
b™
 * 
geo
->
ws_Ýt
;

719 
	}
}

721 
	$pblk_lše_sm‘a_»ad
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

723 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

724 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

725 
bio
 *bio;

726 
µa_addr
 *
µa_li¡
;

727 
nvm_rq
 
rqd
;

728 
u64
 
·ddr
 = 
	`pblk_lše_sm‘a_¡¬t
(
pblk
, 
lše
);

729 
i
, 
»t
;

731 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

733 
»t
 = 
	`pblk_®loc_rqd_m‘a
(
pblk
, &
rqd
);

734 ià(
»t
)

735  
»t
;

737 
bio
 = 
	`bio_m­_k”n
(
dev
->
q
, 
lše
->
sm‘a
, 
lm
->
sm‘a_Ën
, 
GFP_KERNEL
);

738 ià(
	`IS_ERR
(
bio
)) {

739 
»t
 = 
	`PTR_ERR
(
bio
);

740 
þ—r_rqd
;

743 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

744 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

746 
rqd
.
bio
 = bio;

747 
rqd
.
Ýcode
 = 
NVM_OP_PREAD
;

748 
rqd
.
Ä_µas
 = 
lm
->
sm‘a_£c
;

749 
rqd
.
is_£q
 = 1;

750 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(&
rqd
);

752 
i
 = 0; i < 
lm
->
sm‘a_£c
; i++, 
·ddr
++)

753 
µa_li¡
[
i
] = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše
->
id
);

755 
»t
 = 
	`pblk_subm™_io_sync
(
pblk
, &
rqd
);

756 ià(
»t
) {

757 
	`pblk_”r
(
pblk
, "sm‘¨I/O submissiÚ fažed: %d\n", 
»t
);

758 
	`bio_put
(
bio
);

759 
þ—r_rqd
;

762 
	`©omic_dec
(&
pblk
->
šæight_io
);

764 ià(
rqd
.
”rÜ
 &&„qd.”rÜ !ð
NVM_RSP_WARN_HIGHECC
) {

765 
	`pblk_log_»ad_”r
(
pblk
, &
rqd
);

766 
»t
 = -
EIO
;

769 
þ—r_rqd
:

770 
	`pblk_ä“_rqd_m‘a
(
pblk
, &
rqd
);

771  
»t
;

772 
	}
}

774 
	$pblk_lše_sm‘a_wr™e
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

775 
u64
 
·ddr
)

777 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

778 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

779 
bio
 *bio;

780 
µa_addr
 *
µa_li¡
;

781 
nvm_rq
 
rqd
;

782 
__Ë64
 *
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
lše
->
em‘a
->
buf
);

783 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

784 
i
, 
»t
;

786 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

788 
»t
 = 
	`pblk_®loc_rqd_m‘a
(
pblk
, &
rqd
);

789 ià(
»t
)

790  
»t
;

792 
bio
 = 
	`bio_m­_k”n
(
dev
->
q
, 
lše
->
sm‘a
, 
lm
->
sm‘a_Ën
, 
GFP_KERNEL
);

793 ià(
	`IS_ERR
(
bio
)) {

794 
»t
 = 
	`PTR_ERR
(
bio
);

795 
þ—r_rqd
;

798 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

799 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

801 
rqd
.
bio
 = bio;

802 
rqd
.
Ýcode
 = 
NVM_OP_PWRITE
;

803 
rqd
.
Ä_µas
 = 
lm
->
sm‘a_£c
;

804 
rqd
.
is_£q
 = 1;

805 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(&
rqd
);

807 
i
 = 0; i < 
lm
->
sm‘a_£c
; i++, 
·ddr
++) {

808 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
,

809 
rqd
.
m‘a_li¡
, 
i
);

811 
µa_li¡
[
i
] = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše
->
id
);

812 
m‘a
->
lba
 = 
lba_li¡
[
·ddr
] = 
addr_em±y
;

815 
»t
 = 
	`pblk_subm™_io_sync_£m
(
pblk
, &
rqd
);

816 ià(
»t
) {

817 
	`pblk_”r
(
pblk
, "sm‘¨I/O submissiÚ fažed: %d\n", 
»t
);

818 
	`bio_put
(
bio
);

819 
þ—r_rqd
;

822 
	`©omic_dec
(&
pblk
->
šæight_io
);

824 ià(
rqd
.
”rÜ
) {

825 
	`pblk_log_wr™e_”r
(
pblk
, &
rqd
);

826 
»t
 = -
EIO
;

829 
þ—r_rqd
:

830 
	`pblk_ä“_rqd_m‘a
(
pblk
, &
rqd
);

831  
»t
;

832 
	}
}

834 
	$pblk_lše_em‘a_»ad
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

835 *
em‘a_buf
)

837 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

838 
nvm_geo
 *
geo
 = &
dev
->geo;

839 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

840 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

841 *
µa_li¡_buf
, *
m‘a_li¡
;

842 
bio
 *bio;

843 
µa_addr
 *
µa_li¡
;

844 
nvm_rq
 
rqd
;

845 
u64
 
·ddr
 = 
lše
->
em‘a_s£c
;

846 
dma_addr_t
 
dma_µa_li¡
, 
dma_m‘a_li¡
;

847 
mš
 = 
pblk
->
mš_wr™e_pgs
;

848 
Ëá_µas
 = 
lm
->
em‘a_£c
[0];

849 
lše_id
 = 
lše
->
id
;

850 
rq_µas
, 
rq_Ën
;

851 
i
, 
j
;

852 
»t
;

854 
m‘a_li¡
 = 
	`nvm_dev_dma_®loc
(
dev
->
·»Á
, 
GFP_KERNEL
,

855 &
dma_m‘a_li¡
);

856 ià(!
m‘a_li¡
)

857  -
ENOMEM
;

859 
µa_li¡_buf
 = 
m‘a_li¡
 + 
	`pblk_dma_m‘a_size
(
pblk
);

860 
dma_µa_li¡
 = 
dma_m‘a_li¡
 + 
	`pblk_dma_m‘a_size
(
pblk
);

862 
Ãxt_rq
:

863 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

865 
rq_µas
 = 
	`pblk_ÿlc_£cs
(
pblk
, 
Ëá_µas
, 0, 
çl£
);

866 
rq_Ën
 = 
rq_µas
 * 
geo
->
c£cs
;

868 
bio
 = 
	`pblk_bio_m­_addr
(
pblk
, 
em‘a_buf
, 
rq_µas
, 
rq_Ën
,

869 
l_mg
->
em‘a_®loc_ty³
, 
GFP_KERNEL
);

870 ià(
	`IS_ERR
(
bio
)) {

871 
»t
 = 
	`PTR_ERR
(
bio
);

872 
ä“_rqd_dma
;

875 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

876 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

878 
rqd
.
bio
 = bio;

879 
rqd
.
m‘a_li¡
 = meta_list;

880 
rqd
.
µa_li¡
 = 
µa_li¡_buf
;

881 
rqd
.
dma_m‘a_li¡
 = dma_meta_list;

882 
rqd
.
dma_µa_li¡
 = dma_ppa_list;

883 
rqd
.
Ýcode
 = 
NVM_OP_PREAD
;

884 
rqd
.
Ä_µas
 = 
rq_µas
;

885 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(&
rqd
);

887 
i
 = 0; i < 
rqd
.
Ä_µas
; ) {

888 
µa_addr
 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše_id
);

889 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

891 ià(
	`pblk_io_®igÃd
(
pblk
, 
rq_µas
))

892 
rqd
.
is_£q
 = 1;

894 
	`‹¡_b™
(
pos
, 
lše
->
blk_b™m­
)) {

895 
·ddr
 +ð
mš
;

896 ià(
	`pblk_bound¬y_·ddr_checks
(
pblk
, 
·ddr
)) {

897 
	`bio_put
(
bio
);

898 
»t
 = -
EINTR
;

899 
ä“_rqd_dma
;

902 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše_id
);

903 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

906 ià(
	`pblk_bound¬y_·ddr_checks
(
pblk
, 
·ddr
 + 
mš
)) {

907 
	`bio_put
(
bio
);

908 
»t
 = -
EINTR
;

909 
ä“_rqd_dma
;

912 
j
 = 0; j < 
mš
; j++, 
i
++, 
·ddr
++)

913 
µa_li¡
[
i
] = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše_id
);

916 
»t
 = 
	`pblk_subm™_io_sync
(
pblk
, &
rqd
);

917 ià(
»t
) {

918 
	`pblk_”r
(
pblk
, "em‘¨I/O submissiÚ fažed: %d\n", 
»t
);

919 
	`bio_put
(
bio
);

920 
ä“_rqd_dma
;

923 
	`©omic_dec
(&
pblk
->
šæight_io
);

925 ià(
rqd
.
”rÜ
 &&„qd.”rÜ !ð
NVM_RSP_WARN_HIGHECC
) {

926 
	`pblk_log_»ad_”r
(
pblk
, &
rqd
);

927 
»t
 = -
EIO
;

928 
ä“_rqd_dma
;

931 
em‘a_buf
 +ð
rq_Ën
;

932 
Ëá_µas
 -ð
rq_µas
;

933 ià(
Ëá_µas
)

934 
Ãxt_rq
;

936 
ä“_rqd_dma
:

937 
	`nvm_dev_dma_ä“
(
dev
->
·»Á
, 
rqd
.
m‘a_li¡
,„qd.
dma_m‘a_li¡
);

938  
»t
;

939 
	}
}

941 
	$pblk_£tup_e_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

942 
µa_addr
 
µa
)

944 
rqd
->
Ýcode
 = 
NVM_OP_ERASE
;

945 
rqd
->
µa_addr
 = 
µa
;

946 
rqd
->
Ä_µas
 = 1;

947 
rqd
->
is_£q
 = 1;

948 
rqd
->
bio
 = 
NULL
;

949 
	}
}

951 
	$pblk_blk_”a£_sync
(
pblk
 *pblk, 
µa_addr
 
µa
)

953 
nvm_rq
 
rqd
 = {
NULL
};

954 
»t
;

956 
	`Œaû_pblk_chunk_»£t
(
	`pblk_disk_Çme
(
pblk
), &
µa
,

957 
PBLK_CHUNK_RESET_START
);

959 
	`pblk_£tup_e_rq
(
pblk
, &
rqd
, 
µa
);

964 
»t
 = 
	`pblk_subm™_io_sync
(
pblk
, &
rqd
);

965 
rqd
.
´iv©e
 = 
pblk
;

966 
	`__pblk_’d_io_”a£
(
pblk
, &
rqd
);

968  
»t
;

969 
	}
}

971 
	$pblk_lše_”a£
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

973 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

974 
µa_addr
 
µa
;

975 
»t
, 
b™
 = -1;

979 
	`¥š_lock
(&
lše
->
lock
);

980 
b™
 = 
	`fšd_Ãxt_z”o_b™
(
lše
->
”a£_b™m­
, 
lm
->
blk_³r_lše
,

981 
b™
 + 1);

982 ià(
b™
 >ð
lm
->
blk_³r_lše
) {

983 
	`¥š_uÆock
(&
lše
->
lock
);

987 
µa
 = 
pblk
->
luns
[
b™
].
bµa
;

988 
µa
.
a
.
blk
 = 
lše
->
id
;

990 
	`©omic_dec
(&
lše
->
Ëá_eblks
);

991 
	`WARN_ON
(
	`‹¡_ªd_£t_b™
(
b™
, 
lše
->
”a£_b™m­
));

992 
	`¥š_uÆock
(&
lše
->
lock
);

994 
»t
 = 
	`pblk_blk_”a£_sync
(
pblk
, 
µa
);

995 ià(
»t
) {

996 
	`pblk_”r
(
pblk
, "çžedØ”a£†š%d\n", 
lše
->
id
);

997  
»t
;

1002 
	}
}

1004 
	$pblk_lše_£tup_m‘ad©a
(
pblk_lše
 *
lše
,

1005 
pblk_lše_mgmt
 *
l_mg
,

1006 
pblk_lše_m‘a
 *
lm
)

1008 
m‘a_lše
;

1010 
	`lockd•_as£¹_h–d
(&
l_mg
->
ä“_lock
);

1012 
»Œy_m‘a
:

1013 
m‘a_lše
 = 
	`fšd_fœ¡_z”o_b™
(&
l_mg
->
m‘a_b™m­
, 
PBLK_DATA_LINES
);

1014 ià(
m‘a_lše
 =ð
PBLK_DATA_LINES
) {

1015 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1016 
	`io_scheduË
();

1017 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1018 
»Œy_m‘a
;

1021 
	`£t_b™
(
m‘a_lše
, &
l_mg
->
m‘a_b™m­
);

1022 
lše
->
m‘a_lše
 = meta_line;

1024 
lše
->
sm‘a
 = 
l_mg
->
¦še_m‘a
[
m‘a_lše
];

1025 
lše
->
em‘a
 = 
l_mg
->
–še_m‘a
[
m‘a_lše
];

1027 
	`mem£t
(
lše
->
sm‘a
, 0, 
lm
->
sm‘a_Ën
);

1028 
	`mem£t
(
lše
->
em‘a
->
buf
, 0, 
lm
->
em‘a_Ën
[0]);

1030 
lše
->
em‘a
->
mem
 = 0;

1031 
	`©omic_£t
(&
lše
->
em‘a
->
sync
, 0);

1032 
	}
}

1037 
	$pblk_lše_š™_m‘ad©a
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

1038 
pblk_lše
 *
cur
)

1040 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1041 
nvm_geo
 *
geo
 = &
dev
->geo;

1042 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1043 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1044 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

1045 
lše_em‘a
 *
em‘a_buf
 = 
em‘a
->
buf
;

1046 
lše_sm‘a
 *
sm‘a_buf
 = (lše_sm‘¨*)
lše
->
sm‘a
;

1047 
Ä_blk_lše
;

1052 
Ä_blk_lše
 = 
lm
->
blk_³r_lše
 -

1053 
	`b™m­_weight
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

1054 ià(
Ä_blk_lše
 < 
lm
->
mš_blk_lše
) {

1055 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1056 
	`¥š_lock
(&
lše
->
lock
);

1057 
lše
->
¡©e
 = 
PBLK_LINESTATE_BAD
;

1058 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1059 
lše
->
¡©e
);

1060 
	`¥š_uÆock
(&
lše
->
lock
);

1062 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
bad_li¡
);

1063 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1065 
	`pblk_debug
(
pblk
, "lš%d i bad\n", 
lše
->
id
);

1071 
lše
->
lun_b™m­
 = ((*)(
sm‘a_buf
)è+ (
lše_sm‘a
);

1074 
	`b™m­_£t
(
lše
->
lun_b™m­
, 0, 
lm
->
lun_b™m­_Ën
);

1076 
sm‘a_buf
->
h—d”
.
id’tif›r
 = 
	`ýu_to_Ë32
(
PBLK_MAGIC
);

1077 
	`guid_cÝy
((
guid_t
 *)&
sm‘a_buf
->
h—d”
.
uuid
, &
pblk
->
š¡ªû_uuid
);

1078 
sm‘a_buf
->
h—d”
.
id
 = 
	`ýu_to_Ë32
(
lše
->id);

1079 
sm‘a_buf
->
h—d”
.
ty³
 = 
	`ýu_to_Ë16
(
lše
->type);

1080 
sm‘a_buf
->
h—d”
.
v”siÚ_majÜ
 = 
SMETA_VERSION_MAJOR
;

1081 
sm‘a_buf
->
h—d”
.
v”siÚ_mšÜ
 = 
SMETA_VERSION_MINOR
;

1084 
sm‘a_buf
->
£q_Ä
 = 
	`ýu_to_Ë64
(
lše
->seq_nr);

1085 
sm‘a_buf
->
wšdow_wr_lun
 = 
	`ýu_to_Ë32
(
geo
->
®l_luns
);

1088 ià(
cur
) {

1089 
	`memýy
(
lše
->
lun_b™m­
, 
cur
->lun_b™m­, 
lm
->
lun_b™m­_Ën
);

1090 
sm‘a_buf
->
´ev_id
 = 
	`ýu_to_Ë32
(
cur
->
id
);

1091 
cur
->
em‘a
->
buf
->
Ãxt_id
 = 
	`ýu_to_Ë32
(
lše
->
id
);

1093 
sm‘a_buf
->
´ev_id
 = 
	`ýu_to_Ë32
(
PBLK_LINE_EMPTY
);

1097 
sm‘a_buf
->
h—d”
.
üc
 = 
	`ýu_to_Ë32
(

1098 
	`pblk_ÿlc_m‘a_h—d”_üc
(
pblk
, &
sm‘a_buf
->
h—d”
));

1099 
sm‘a_buf
->
üc
 = 
	`ýu_to_Ë32
(
	`pblk_ÿlc_sm‘a_üc
(
pblk
, smeta_buf));

1102 
	`memýy
(&
em‘a_buf
->
h—d”
, &
sm‘a_buf
->header,

1103 (
lše_h—d”
));

1105 
em‘a_buf
->
h—d”
.
v”siÚ_majÜ
 = 
EMETA_VERSION_MAJOR
;

1106 
em‘a_buf
->
h—d”
.
v”siÚ_mšÜ
 = 
EMETA_VERSION_MINOR
;

1107 
em‘a_buf
->
h—d”
.
üc
 = 
	`ýu_to_Ë32
(

1108 
	`pblk_ÿlc_m‘a_h—d”_üc
(
pblk
, &
em‘a_buf
->
h—d”
));

1110 
em‘a_buf
->
£q_Ä
 = 
	`ýu_to_Ë64
(
lše
->seq_nr);

1111 
em‘a_buf
->
Ä_lbas
 = 
	`ýu_to_Ë64
(
lše
->
£c_š_lše
);

1112 
em‘a_buf
->
Ä_v®id_lbas
 = 
	`ýu_to_Ë64
(0);

1113 
em‘a_buf
->
Ãxt_id
 = 
	`ýu_to_Ë32
(
PBLK_LINE_EMPTY
);

1114 
em‘a_buf
->
üc
 = 
	`ýu_to_Ë32
(0);

1115 
em‘a_buf
->
´ev_id
 = 
sm‘a_buf
->prev_id;

1118 
	}
}

1120 
	$pblk_lše_®loc_b™m­s
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1122 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1123 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1125 
lše
->
m­_b™m­
 = 
	`mempoÞ_®loc
(
l_mg
->
b™m­_poÞ
, 
GFP_KERNEL
);

1126 ià(!
lše
->
m­_b™m­
)

1127  -
ENOMEM
;

1129 
	`mem£t
(
lše
->
m­_b™m­
, 0, 
lm
->
£c_b™m­_Ën
);

1132 
lše
->
šv®id_b™m­
 = 
	`mempoÞ_®loc
(
l_mg
->
b™m­_poÞ
, 
GFP_KERNEL
);

1133 ià(!
lše
->
šv®id_b™m­
) {

1134 
	`mempoÞ_ä“
(
lše
->
m­_b™m­
, 
l_mg
->
b™m­_poÞ
);

1135 
lše
->
m­_b™m­
 = 
NULL
;

1136  -
ENOMEM
;

1140 
	}
}

1145 
	$pblk_lše_š™_bb
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

1146 
š™
)

1148 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1149 
nvm_geo
 *
geo
 = &
dev
->geo;

1150 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1151 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1152 
u64
 
off
;

1153 
b™
 = -1;

1154 
em‘a_£cs
;

1156 
lše
->
£c_š_lše
 = 
lm
->
£c_³r_lše
;

1159 (
b™
 = 
	`fšd_Ãxt_b™
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
,

1160 
b™
 + 1)è< 
lm
->
blk_³r_lše
) {

1161 
off
 = 
b™
 * 
geo
->
ws_Ýt
;

1162 
	`b™m­_shiá_Ëá
(
l_mg
->
bb_aux
,†_mg->
bb_‹m¶©e
, 
off
,

1163 
lm
->
£c_³r_lše
);

1164 
	`b™m­_Ü
(
lše
->
m­_b™m­
,†še->m­_b™m­, 
l_mg
->
bb_aux
,

1165 
lm
->
£c_³r_lše
);

1166 
lše
->
£c_š_lše
 -ð
geo
->
þba
;

1170 
b™
 = 
	`fšd_fœ¡_z”o_b™
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

1171 
off
 = 
b™
 * 
geo
->
ws_Ýt
;

1172 
	`b™m­_£t
(
lše
->
m­_b™m­
, 
off
, 
lm
->
sm‘a_£c
);

1173 
lše
->
£c_š_lše
 -ð
lm
->
sm‘a_£c
;

1174 
lše
->
cur_£c
 = 
off
 + 
lm
->
sm‘a_£c
;

1176 ià(
š™
 && 
	`pblk_lše_sm‘a_wr™e
(
pblk
, 
lše
, 
off
)) {

1177 
	`pblk_debug
(
pblk
, "line smeta I/O failed. Retry\n");

1181 
	`b™m­_cÝy
(
lše
->
šv®id_b™m­
,†še->
m­_b™m­
, 
lm
->
£c_³r_lše
);

1186 
em‘a_£cs
 = 
lm
->
em‘a_£c
[0];

1187 
off
 = 
lm
->
£c_³r_lše
;

1188 
em‘a_£cs
) {

1189 
off
 -ð
geo
->
ws_Ýt
;

1190 ià(!
	`‹¡_b™
(
off
, 
lše
->
šv®id_b™m­
)) {

1191 
	`b™m­_£t
(
lše
->
šv®id_b™m­
, 
off
, 
geo
->
ws_Ýt
);

1192 
em‘a_£cs
 -ð
geo
->
ws_Ýt
;

1196 
lše
->
em‘a_s£c
 = 
off
;

1197 
lše
->
£c_š_lše
 -ð
lm
->
em‘a_£c
[0];

1198 
lše
->
Ä_v®id_lbas
 = 0;

1199 
lše
->
Ëá_m£cs
 =†še->
£c_š_lše
;

1200 *
lše
->
vsc
 = 
	`ýu_to_Ë32
Öše->
£c_š_lše
);

1202 ià(
lm
->
£c_³r_lše
 - 
lše
->
£c_š_lše
 !=

1203 
	`b™m­_weight
(
lše
->
šv®id_b™m­
, 
lm
->
£c_³r_lše
)) {

1204 
	`¥š_lock
(&
lše
->
lock
);

1205 
lše
->
¡©e
 = 
PBLK_LINESTATE_BAD
;

1206 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1207 
lše
->
¡©e
);

1208 
	`¥š_uÆock
(&
lše
->
lock
);

1210 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
bad_li¡
);

1211 
	`pblk_”r
(
pblk
, "uÃx³ùed†š%d i bad\n", 
lše
->
id
);

1217 
	}
}

1219 
	$pblk_´•¬e_Ãw_lše
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1221 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1222 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1223 
nvm_geo
 *
geo
 = &
dev
->geo;

1224 
blk_to_”a£
 = 
	`©omic_»ad
(&
lše
->
blk_š_lše
);

1225 
i
;

1227 
i
 = 0; i < 
lm
->
blk_³r_lše
; i++) {

1228 
pblk_lun
 *
¾un
 = &
pblk
->
luns
[
i
];

1229 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
¾un
->
bµa
);

1230 
¡©e
 = 
lše
->
chks
[
pos
].state;

1233 ià(
¡©e
 & 
NVM_CHK_ST_FREE
) {

1234 
	`£t_b™
(
	`pblk_µa_to_pos
(
geo
, 
¾un
->
bµa
),

1235 
lše
->
”a£_b™m­
);

1236 
blk_to_”a£
--;

1240  
blk_to_”a£
;

1241 
	}
}

1243 
	$pblk_lše_´•¬e
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1245 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1246 
blk_š_lše
 = 
	`©omic_»ad
(&
lše
->blk_in_line);

1247 
blk_to_”a£
;

1250 
	`b™m­_cÝy
(
lše
->
”a£_b™m­
,†še->
blk_b™m­
, 
lm
->
blk_³r_lše
);

1252 
	`¥š_lock
(&
lše
->
lock
);

1257 ià(
lše
->
¡©e
 =ð
PBLK_LINESTATE_NEW
) {

1258 
blk_to_”a£
 = 
	`pblk_´•¬e_Ãw_lše
(
pblk
, 
lše
);

1259 
lše
->
¡©e
 = 
PBLK_LINESTATE_FREE
;

1260 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1261 
lše
->
¡©e
);

1263 
blk_to_”a£
 = 
blk_š_lše
;

1266 ià(
blk_š_lše
 < 
lm
->
mš_blk_lše
) {

1267 
	`¥š_uÆock
(&
lše
->
lock
);

1268  -
EAGAIN
;

1271 ià(
lše
->
¡©e
 !ð
PBLK_LINESTATE_FREE
) {

1272 
	`WARN
(1, "pblk: corrupted†ine %d, state %d\n",

1273 
lše
->
id
,†še->
¡©e
);

1274 
	`¥š_uÆock
(&
lše
->
lock
);

1275  -
EINTR
;

1278 
lše
->
¡©e
 = 
PBLK_LINESTATE_OPEN
;

1279 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1280 
lše
->
¡©e
);

1282 
	`©omic_£t
(&
lše
->
Ëá_eblks
, 
blk_to_”a£
);

1283 
	`©omic_£t
(&
lše
->
Ëá_£blks
, 
blk_to_”a£
);

1285 
lše
->
m‘a_di¡ªû
 = 
lm
->meta_distance;

1286 
	`¥š_uÆock
(&
lše
->
lock
);

1288 
	`k»f_š™
(&
lše
->
»f
);

1289 
	`©omic_£t
(&
lše
->
£c_to_upd©e
, 0);

1292 
	}
}

1295 
	$pblk_lše_»cov_®loc
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1297 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1298 
»t
;

1300 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1301 
l_mg
->
d©a_lše
 = 
lše
;

1302 
	`li¡_d–
(&
lše
->
li¡
);

1304 
»t
 = 
	`pblk_lše_´•¬e
(
pblk
, 
lše
);

1305 ià(
»t
) {

1306 
	`li¡_add
(&
lše
->
li¡
, &
l_mg
->
ä“_li¡
);

1307 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1308  
»t
;

1310 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1312 
»t
 = 
	`pblk_lše_®loc_b™m­s
(
pblk
, 
lše
);

1313 ià(
»t
)

1314 
çž
;

1316 ià(!
	`pblk_lše_š™_bb
(
pblk
, 
lše
, 0)) {

1317 
»t
 = -
EINTR
;

1318 
çž
;

1321 
	`pblk_¾_ä“_lšes_dec
(&
pblk
->
¾
, 
lše
, 
Œue
);

1324 
çž
:

1325 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1326 
	`li¡_add
(&
lše
->
li¡
, &
l_mg
->
ä“_li¡
);

1327 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1329  
»t
;

1330 
	}
}

1332 
	$pblk_lše_»cov_þo£
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1334 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1336 
	`mempoÞ_ä“
(
lše
->
m­_b™m­
, 
l_mg
->
b™m­_poÞ
);

1337 
lše
->
m­_b™m­
 = 
NULL
;

1338 
lše
->
sm‘a
 = 
NULL
;

1339 
lše
->
em‘a
 = 
NULL
;

1340 
	}
}

1342 
	$pblk_lše_»š™
(
pblk_lše
 *
lše
)

1344 *
lše
->
vsc
 = 
	`ýu_to_Ë32
(
EMPTY_ENTRY
);

1346 
lše
->
m­_b™m­
 = 
NULL
;

1347 
lše
->
šv®id_b™m­
 = 
NULL
;

1348 
lše
->
sm‘a
 = 
NULL
;

1349 
lše
->
em‘a
 = 
NULL
;

1350 
	}
}

1352 
	$pblk_lše_ä“
(
pblk_lše
 *
lše
)

1354 
pblk
 *pblk = 
lše
->pblk;

1355 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1357 
	`mempoÞ_ä“
(
lše
->
m­_b™m­
, 
l_mg
->
b™m­_poÞ
);

1358 
	`mempoÞ_ä“
(
lše
->
šv®id_b™m­
, 
l_mg
->
b™m­_poÞ
);

1360 
	`pblk_lše_»š™
(
lše
);

1361 
	}
}

1363 
pblk_lše
 *
	$pblk_lše_g‘
(
pblk
 *pblk)

1365 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1366 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1367 
pblk_lše
 *
lše
;

1368 
»t
, 
b™
;

1370 
	`lockd•_as£¹_h–d
(&
l_mg
->
ä“_lock
);

1372 
»Œy
:

1373 ià(
	`li¡_em±y
(&
l_mg
->
ä“_li¡
)) {

1374 
	`pblk_”r
(
pblk
, "no free†ines\n");

1375  
NULL
;

1378 
lše
 = 
	`li¡_fœ¡_’Œy
(&
l_mg
->
ä“_li¡
, 
pblk_lše
, 
li¡
);

1379 
	`li¡_d–
(&
lše
->
li¡
);

1380 
l_mg
->
Ä_ä“_lšes
--;

1382 
b™
 = 
	`fšd_fœ¡_z”o_b™
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

1383 ià(
	`uÆik–y
(
b™
 >ð
lm
->
blk_³r_lše
)) {

1384 
	`¥š_lock
(&
lše
->
lock
);

1385 
lše
->
¡©e
 = 
PBLK_LINESTATE_BAD
;

1386 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1387 
lše
->
¡©e
);

1388 
	`¥š_uÆock
(&
lše
->
lock
);

1390 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
bad_li¡
);

1392 
	`pblk_debug
(
pblk
, "lš%d i bad\n", 
lše
->
id
);

1393 
»Œy
;

1396 
»t
 = 
	`pblk_lše_´•¬e
(
pblk
, 
lše
);

1397 ià(
»t
) {

1398 
»t
) {

1399 -
EAGAIN
:

1400 
	`li¡_add
(&
lše
->
li¡
, &
l_mg
->
bad_li¡
);

1401 
»Œy
;

1402 -
EINTR
:

1403 
	`li¡_add
(&
lše
->
li¡
, &
l_mg
->
cÜru±_li¡
);

1404 
»Œy
;

1406 
	`pblk_”r
(
pblk
, "çžedØ´•¬lš%d\n", 
lše
->
id
);

1407 
	`li¡_add
(&
lše
->
li¡
, &
l_mg
->
ä“_li¡
);

1408 
l_mg
->
Ä_ä“_lšes
++;

1409  
NULL
;

1413  
lše
;

1414 
	}
}

1416 
pblk_lše
 *
	$pblk_lše_»Œy
(
pblk
 *pblk,

1417 
pblk_lše
 *
lše
)

1419 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1420 
pblk_lše
 *
»Œy_lše
;

1422 
»Œy
:

1423 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1424 
»Œy_lše
 = 
	`pblk_lše_g‘
(
pblk
);

1425 ià(!
»Œy_lše
) {

1426 
l_mg
->
d©a_lše
 = 
NULL
;

1427 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1428  
NULL
;

1431 
»Œy_lše
->
m­_b™m­
 = 
lše
->map_bitmap;

1432 
»Œy_lše
->
šv®id_b™m­
 = 
lše
->invalid_bitmap;

1433 
»Œy_lše
->
sm‘a
 = 
lše
->smeta;

1434 
»Œy_lše
->
em‘a
 = 
lše
->emeta;

1435 
»Œy_lše
->
m‘a_lše
 = 
lše
->meta_line;

1437 
	`pblk_lše_»š™
(
lše
);

1439 
l_mg
->
d©a_lše
 = 
»Œy_lše
;

1440 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1442 
	`pblk_¾_ä“_lšes_dec
(&
pblk
->
¾
, 
lše
, 
çl£
);

1444 ià(
	`pblk_lše_”a£
(
pblk
, 
»Œy_lše
))

1445 
»Œy
;

1447  
»Œy_lše
;

1448 
	}
}

1450 
	$pblk_£t_¥aû_lim™
(
pblk
 *pblk)

1452 
pblk_¾
 *
¾
 = &
pblk
->rl;

1454 
	`©omic_£t
(&
¾
->
rb_¥aû
, 0);

1455 
	}
}

1457 
pblk_lše
 *
	$pblk_lše_g‘_fœ¡_d©a
(
pblk
 *pblk)

1459 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1460 
pblk_lše
 *
lše
;

1462 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1463 
lše
 = 
	`pblk_lše_g‘
(
pblk
);

1464 ià(!
lše
) {

1465 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1466  
NULL
;

1469 
lše
->
£q_Ä
 = 
l_mg
->
d_£q_Ä
++;

1470 
lše
->
ty³
 = 
PBLK_LINETYPE_DATA
;

1471 
l_mg
->
d©a_lše
 = 
lše
;

1473 
	`pblk_lše_£tup_m‘ad©a
(
lše
, 
l_mg
, &
pblk
->
lm
);

1476 
l_mg
->
d©a_Ãxt
 = 
	`pblk_lše_g‘
(
pblk
);

1477 ià(!
l_mg
->
d©a_Ãxt
) {

1482 
	`pblk_£t_¥aû_lim™
(
pblk
);

1484 
l_mg
->
d©a_Ãxt
 = 
NULL
;

1486 
l_mg
->
d©a_Ãxt
->
£q_Ä
 =†_mg->
d_£q_Ä
++;

1487 
l_mg
->
d©a_Ãxt
->
ty³
 = 
PBLK_LINETYPE_DATA
;

1489 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1491 ià(
	`pblk_lše_®loc_b™m­s
(
pblk
, 
lše
))

1492  
NULL
;

1494 ià(
	`pblk_lše_”a£
(
pblk
, 
lše
)) {

1495 
lše
 = 
	`pblk_lše_»Œy
(
pblk
,†ine);

1496 ià(!
lše
)

1497  
NULL
;

1500 
»Œy_£tup
:

1501 ià(!
	`pblk_lše_š™_m‘ad©a
(
pblk
, 
lše
, 
NULL
)) {

1502 
lše
 = 
	`pblk_lše_»Œy
(
pblk
,†ine);

1503 ià(!
lše
)

1504  
NULL
;

1506 
»Œy_£tup
;

1509 ià(!
	`pblk_lše_š™_bb
(
pblk
, 
lše
, 1)) {

1510 
lše
 = 
	`pblk_lše_»Œy
(
pblk
,†ine);

1511 ià(!
lše
)

1512  
NULL
;

1514 
»Œy_£tup
;

1517 
	`pblk_¾_ä“_lšes_dec
(&
pblk
->
¾
, 
lše
, 
Œue
);

1519  
lše
;

1520 
	}
}

1522 
	$pblk_µa_to_lše_put
(
pblk
 *pblk, 
µa_addr
 
µa
)

1524 
pblk_lše
 *
lše
;

1526 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
µa
);

1527 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put_wq
);

1528 
	}
}

1530 
	$pblk_rq_to_lše_put
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

1532 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

1533 
i
;

1535 
i
 = 0; i < 
rqd
->
Ä_µas
; i++)

1536 
	`pblk_µa_to_lše_put
(
pblk
, 
µa_li¡
[
i
]);

1537 
	}
}

1539 
	$pblk_¡Ý_wr™es
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1541 
	`lockd•_as£¹_h–d
(&
pblk
->
l_mg
.
ä“_lock
);

1543 
	`pblk_£t_¥aû_lim™
(
pblk
);

1544 
pblk
->
¡©e
 = 
PBLK_STATE_STOPPING
;

1545 
	`Œaû_pblk_¡©e
(
	`pblk_disk_Çme
(
pblk
),…blk->
¡©e
);

1546 
	}
}

1548 
	$pblk_lše_þo£_m‘a_sync
(
pblk
 *pblk)

1550 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1551 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1552 
pblk_lše
 *
lše
, *
Žše
;

1553 
	`LIST_HEAD
(
li¡
);

1555 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

1556 ià(
	`li¡_em±y
(&
l_mg
->
em‘a_li¡
)) {

1557 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

1561 
	`li¡_cut_pos™iÚ
(&
li¡
, &
l_mg
->
em‘a_li¡
,†_mg->em‘a_li¡.
´ev
);

1562 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

1564 
	`li¡_fÜ_—ch_’Œy_§ã
(
lše
, 
Žše
, &
li¡
,†ist) {

1565 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

1567 
em‘a
->
mem
 < 
lm
->
em‘a_Ën
[0]) {

1568 
»t
;

1570 
»t
 = 
	`pblk_subm™_m‘a_io
(
pblk
, 
lše
);

1571 ià(
»t
) {

1572 
	`pblk_”r
(
pblk
, "sync meta†ine %d failed (%d)\n",

1573 
lše
->
id
, 
»t
);

1579 
	`pblk_wa™_fÜ_m‘a
(
pblk
);

1580 
	`æush_wÜkqueue
(
pblk
->
þo£_wq
);

1581 
	}
}

1583 
	$__pblk_p–še_æush
(
pblk
 *pblk)

1585 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1586 
»t
;

1588 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1589 ià(
pblk
->
¡©e
 =ð
PBLK_STATE_RECOVERING
 ||

1590 
pblk
->
¡©e
 =ð
PBLK_STATE_STOPPED
) {

1591 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1594 
pblk
->
¡©e
 = 
PBLK_STATE_RECOVERING
;

1595 
	`Œaû_pblk_¡©e
(
	`pblk_disk_Çme
(
pblk
),…blk->
¡©e
);

1596 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1598 
	`pblk_æush_wr™”
(
pblk
);

1599 
	`pblk_wa™_fÜ_m‘a
(
pblk
);

1601 
»t
 = 
	`pblk_»cov_·d
(
pblk
);

1602 ià(
»t
) {

1603 
	`pblk_”r
(
pblk
, "could‚Ù clo£ d©¨Ú—rdown(%d)\n", 
»t
);

1607 
	`æush_wÜkqueue
(
pblk
->
bb_wq
);

1608 
	`pblk_lše_þo£_m‘a_sync
(
pblk
);

1609 
	}
}

1611 
	$__pblk_p–še_¡Ý
(
pblk
 *pblk)

1613 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1615 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1616 
pblk
->
¡©e
 = 
PBLK_STATE_STOPPED
;

1617 
	`Œaû_pblk_¡©e
(
	`pblk_disk_Çme
(
pblk
),…blk->
¡©e
);

1618 
l_mg
->
d©a_lše
 = 
NULL
;

1619 
l_mg
->
d©a_Ãxt
 = 
NULL
;

1620 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1621 
	}
}

1623 
	$pblk_p–še_¡Ý
(
pblk
 *pblk)

1625 
	`__pblk_p–še_æush
(
pblk
);

1626 
	`__pblk_p–še_¡Ý
(
pblk
);

1627 
	}
}

1629 
pblk_lše
 *
	$pblk_lše_»¶aû_d©a
(
pblk
 *pblk)

1631 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1632 
pblk_lše
 *
cur
, *
Ãw
 = 
NULL
;

1633 
Ëá_£blks
;

1635 
Ãw
 = 
l_mg
->
d©a_Ãxt
;

1636 ià(!
Ãw
)

1637 
out
;

1639 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1640 
cur
 = 
l_mg
->
d©a_lše
;

1641 
l_mg
->
d©a_lše
 = 
Ãw
;

1643 
	`pblk_lše_£tup_m‘ad©a
(
Ãw
, 
l_mg
, &
pblk
->
lm
);

1644 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1646 
»Œy_”a£
:

1647 
Ëá_£blks
 = 
	`©omic_»ad
(&
Ãw
->left_seblks);

1648 ià(
Ëá_£blks
) {

1650 ià(
	`©omic_»ad
(&
Ãw
->
Ëá_eblks
)) {

1651 ià(
	`pblk_lše_”a£
(
pblk
, 
Ãw
))

1652 
out
;

1654 
	`io_scheduË
();

1656 
»Œy_”a£
;

1659 ià(
	`pblk_lše_®loc_b™m­s
(
pblk
, 
Ãw
))

1660  
NULL
;

1662 
»Œy_£tup
:

1663 ià(!
	`pblk_lše_š™_m‘ad©a
(
pblk
, 
Ãw
, 
cur
)) {

1664 
Ãw
 = 
	`pblk_lše_»Œy
(
pblk
,‚ew);

1665 ià(!
Ãw
)

1666 
out
;

1668 
»Œy_£tup
;

1671 ià(!
	`pblk_lše_š™_bb
(
pblk
, 
Ãw
, 1)) {

1672 
Ãw
 = 
	`pblk_lše_»Œy
(
pblk
,‚ew);

1673 ià(!
Ãw
)

1674 
out
;

1676 
»Œy_£tup
;

1679 
	`pblk_¾_ä“_lšes_dec
(&
pblk
->
¾
, 
Ãw
, 
Œue
);

1682 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1683 
l_mg
->
d©a_Ãxt
 = 
	`pblk_lše_g‘
(
pblk
);

1684 ià(!
l_mg
->
d©a_Ãxt
) {

1689 
	`pblk_¡Ý_wr™es
(
pblk
, 
Ãw
);

1690 
l_mg
->
d©a_Ãxt
 = 
NULL
;

1692 
l_mg
->
d©a_Ãxt
->
£q_Ä
 =†_mg->
d_£q_Ä
++;

1693 
l_mg
->
d©a_Ãxt
->
ty³
 = 
PBLK_LINETYPE_DATA
;

1695 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1697 
out
:

1698  
Ãw
;

1699 
	}
}

1701 
	$__pblk_lše_put
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1703 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1704 
pblk_gc
 *
gc
 = &
pblk
->gc;

1706 
	`¥š_lock
(&
lše
->
lock
);

1707 
	`WARN_ON
(
lše
->
¡©e
 !ð
PBLK_LINESTATE_GC
);

1708 ià(
lše
->
w_”r_gc
->
has_gc_”r
) {

1709 
	`¥š_uÆock
(&
lše
->
lock
);

1710 
	`pblk_”r
(
pblk
, "lš%d hadƒ¼Ü duršg GC\n", 
lše
->
id
);

1711 
	`pblk_put_lše_back
(
pblk
, 
lše
);

1712 
lše
->
w_”r_gc
->
has_gc_”r
 = 0;

1716 
lše
->
¡©e
 = 
PBLK_LINESTATE_FREE
;

1717 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1718 
lše
->
¡©e
);

1719 
lše
->
gc_group
 = 
PBLK_LINEGC_NONE
;

1720 
	`pblk_lše_ä“
(
lše
);

1722 ià(
lše
->
w_”r_gc
->
has_wr™e_”r
) {

1723 
	`pblk_¾_w”r_lše_out
(&
pblk
->
¾
);

1724 
lše
->
w_”r_gc
->
has_wr™e_”r
 = 0;

1727 
	`¥š_uÆock
(&
lše
->
lock
);

1728 
	`©omic_dec
(&
gc
->
p–še_gc
);

1730 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1731 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
ä“_li¡
);

1732 
l_mg
->
Ä_ä“_lšes
++;

1733 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1735 
	`pblk_¾_ä“_lšes_šc
(&
pblk
->
¾
, 
lše
);

1736 
	}
}

1738 
	$pblk_lše_put_ws
(
wÜk_¡ruù
 *
wÜk
)

1740 
pblk_lše_ws
 *
lše_put_ws
 = 
	`cÚš”_of
(
wÜk
,

1741 
pblk_lše_ws
, 
ws
);

1742 
pblk
 *pblk = 
lše_put_ws
->pblk;

1743 
pblk_lše
 *
lše
 = 
lše_put_ws
->line;

1745 
	`__pblk_lše_put
(
pblk
, 
lše
);

1746 
	`mempoÞ_ä“
(
lše_put_ws
, &
pblk
->
g’_ws_poÞ
);

1747 
	}
}

1749 
	$pblk_lše_put
(
k»f
 *
»f
)

1751 
pblk_lše
 *
lše
 = 
	`cÚš”_of
(
»f
, pblk_line,„ef);

1752 
pblk
 *pblk = 
lše
->pblk;

1754 
	`__pblk_lše_put
(
pblk
, 
lše
);

1755 
	}
}

1757 
	$pblk_lše_put_wq
(
k»f
 *
»f
)

1759 
pblk_lše
 *
lše
 = 
	`cÚš”_of
(
»f
, pblk_line,„ef);

1760 
pblk
 *pblk = 
lše
->pblk;

1761 
pblk_lše_ws
 *
lše_put_ws
;

1763 
lše_put_ws
 = 
	`mempoÞ_®loc
(&
pblk
->
g’_ws_poÞ
, 
GFP_ATOMIC
);

1764 ià(!
lše_put_ws
)

1767 
lše_put_ws
->
pblk
 =…blk;

1768 
lše_put_ws
->
lše
 =†ine;

1769 
lše_put_ws
->
´iv
 = 
NULL
;

1771 
	`INIT_WORK
(&
lše_put_ws
->
ws
, 
pblk_lše_put_ws
);

1772 
	`queue_wÜk
(
pblk
->
r_’d_wq
, &
lše_put_ws
->
ws
);

1773 
	}
}

1775 
	$pblk_blk_”a£_async
(
pblk
 *pblk, 
µa_addr
 
µa
)

1777 
nvm_rq
 *
rqd
;

1778 
”r
;

1780 
rqd
 = 
	`pblk_®loc_rqd
(
pblk
, 
PBLK_ERASE
);

1782 
	`pblk_£tup_e_rq
(
pblk
, 
rqd
, 
µa
);

1784 
rqd
->
’d_io
 = 
pblk_’d_io_”a£
;

1785 
rqd
->
´iv©e
 = 
pblk
;

1787 
	`Œaû_pblk_chunk_»£t
(
	`pblk_disk_Çme
(
pblk
),

1788 &
µa
, 
PBLK_CHUNK_RESET_START
);

1793 
”r
 = 
	`pblk_subm™_io
(
pblk
, 
rqd
);

1794 ià(
”r
) {

1795 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1796 
nvm_geo
 *
geo
 = &
dev
->geo;

1798 
	`pblk_”r
(
pblk
, "could‚ot‡syncƒrase†ine:%d,blk:%d\n",

1799 
	`pblk_µa_to_lše_id
(
µa
),

1800 
	`pblk_µa_to_pos
(
geo
, 
µa
));

1803  
”r
;

1804 
	}
}

1806 
pblk_lše
 *
	$pblk_lše_g‘_d©a
(
pblk
 *pblk)

1808  
pblk
->
l_mg
.
d©a_lše
;

1809 
	}
}

1812 
pblk_lše
 *
	$pblk_lše_g‘_”a£
(
pblk
 *pblk)

1814  
pblk
->
l_mg
.
d©a_Ãxt
;

1815 
	}
}

1817 
	$pblk_lše_is_fuÎ
(
pblk_lše
 *
lše
)

1819  (
lše
->
Ëá_m£cs
 == 0);

1820 
	}
}

1822 
	$pblk_lše_should_sync_m‘a
(
pblk
 *pblk)

1824 ià(
	`pblk_¾_is_lim™
(&
pblk
->
¾
))

1825 
	`pblk_lše_þo£_m‘a_sync
(
pblk
);

1826 
	}
}

1828 
	$pblk_lše_þo£
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1830 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1831 
nvm_geo
 *
geo
 = &
dev
->geo;

1832 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1833 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1834 
li¡_h—d
 *
move_li¡
;

1835 
i
;

1837 #ifdeà
CONFIG_NVM_PBLK_DEBUG


1838 
	`WARN
(!
	`b™m­_fuÎ
(
lše
->
m­_b™m­
, 
lm
->
£c_³r_lše
),

1839 "pblk: cÜru± clo£d†š%d\n", 
lše
->
id
);

1842 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

1843 
	`WARN_ON
(!
	`‹¡_ªd_þ—r_b™
(
lše
->
m‘a_lše
, &
l_mg
->
m‘a_b™m­
));

1844 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

1846 
	`¥š_lock
(&
l_mg
->
gc_lock
);

1847 
	`¥š_lock
(&
lše
->
lock
);

1848 
	`WARN_ON
(
lše
->
¡©e
 !ð
PBLK_LINESTATE_OPEN
);

1849 
lše
->
¡©e
 = 
PBLK_LINESTATE_CLOSED
;

1850 
move_li¡
 = 
	`pblk_lše_gc_li¡
(
pblk
, 
lše
);

1851 
	`li¡_add_ž
(&
lše
->
li¡
, 
move_li¡
);

1853 
	`mempoÞ_ä“
(
lše
->
m­_b™m­
, 
l_mg
->
b™m­_poÞ
);

1854 
lše
->
m­_b™m­
 = 
NULL
;

1855 
lše
->
sm‘a
 = 
NULL
;

1856 
lše
->
em‘a
 = 
NULL
;

1858 
i
 = 0; i < 
lm
->
blk_³r_lše
; i++) {

1859 
pblk_lun
 *
¾un
 = &
pblk
->
luns
[
i
];

1860 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
¾un
->
bµa
);

1861 
¡©e
 = 
lše
->
chks
[
pos
].state;

1863 ià(!(
¡©e
 & 
NVM_CHK_ST_OFFLINE
))

1864 
¡©e
 = 
NVM_CHK_ST_CLOSED
;

1867 
	`¥š_uÆock
(&
lše
->
lock
);

1868 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

1870 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1871 
lše
->
¡©e
);

1872 
	}
}

1874 
	$pblk_lše_þo£_m‘a
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1876 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1877 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1878 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

1879 
lše_em‘a
 *
em‘a_buf
 = 
em‘a
->
buf
;

1880 
wa_couÁ”s
 *
wa
 = 
	`em‘a_to_wa
(
lm
, 
em‘a_buf
);

1883 
	`memýy
(
	`em‘a_to_vsc
(
pblk
, 
em‘a_buf
), 
l_mg
->
vsc_li¡
, 
lm
->
vsc_li¡_Ën
);

1884 
	`memýy
(
	`em‘a_to_bb
(
em‘a_buf
), 
lše
->
blk_b™m­
, 
lm
->
blk_b™m­_Ën
);

1886 
wa
->
u£r
 = 
	`ýu_to_Ë64
(
	`©omic64_»ad
(&
pblk
->
u£r_wa
));

1887 
wa
->
·d
 = 
	`ýu_to_Ë64
(
	`©omic64_»ad
(&
pblk
->
·d_wa
));

1888 
wa
->
gc
 = 
	`ýu_to_Ë64
(
	`©omic64_»ad
(&
pblk
->
gc_wa
));

1890 ià(
	`Ë32_to_ýu
(
em‘a_buf
->
h—d”
.
id’tif›r
è!ð
PBLK_MAGIC
) {

1891 
em‘a_buf
->
h—d”
.
id’tif›r
 = 
	`ýu_to_Ë32
(
PBLK_MAGIC
);

1892 
	`guid_cÝy
((
guid_t
 *)&
em‘a_buf
->
h—d”
.
uuid
,

1893 &
pblk
->
š¡ªû_uuid
);

1894 
em‘a_buf
->
h—d”
.
id
 = 
	`ýu_to_Ë32
(
lše
->id);

1895 
em‘a_buf
->
h—d”
.
ty³
 = 
	`ýu_to_Ë16
(
lše
->type);

1896 
em‘a_buf
->
h—d”
.
v”siÚ_majÜ
 = 
EMETA_VERSION_MAJOR
;

1897 
em‘a_buf
->
h—d”
.
v”siÚ_mšÜ
 = 
EMETA_VERSION_MINOR
;

1898 
em‘a_buf
->
h—d”
.
üc
 = 
	`ýu_to_Ë32
(

1899 
	`pblk_ÿlc_m‘a_h—d”_üc
(
pblk
, &
em‘a_buf
->
h—d”
));

1902 
em‘a_buf
->
Ä_v®id_lbas
 = 
	`ýu_to_Ë64
(
lše
->nr_valid_lbas);

1903 
em‘a_buf
->
üc
 = 
	`ýu_to_Ë32
(
	`pblk_ÿlc_em‘a_üc
(
pblk
,ƒmeta_buf));

1905 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

1906 
	`¥š_lock
(&
lše
->
lock
);

1911 ià(
lše
->
em‘a_s£c
 !ðlše->
cur_£c
)

1912 
lše
->
em‘a_s£c
 =†še->
cur_£c
;

1914 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
em‘a_li¡
);

1915 
	`¥š_uÆock
(&
lše
->
lock
);

1916 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

1918 
	`pblk_lše_should_sync_m‘a
(
pblk
);

1919 
	}
}

1921 
	$pblk_§ve_lba_li¡
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

1923 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1924 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1925 
lba_li¡_size
 = 
lm
->
em‘a_Ën
[2];

1926 
pblk_w_”r_gc
 *
w_”r_gc
 = 
lše
->w_err_gc;

1927 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

1929 
w_”r_gc
->
lba_li¡
 = 
	`pblk_m®loc
(
lba_li¡_size
,

1930 
l_mg
->
em‘a_®loc_ty³
, 
GFP_KERNEL
);

1931 
	`memýy
(
w_”r_gc
->
lba_li¡
, 
	`em‘a_to_lbas
(
pblk
, 
em‘a
->
buf
),

1932 
lba_li¡_size
);

1933 
	}
}

1935 
	$pblk_lše_þo£_ws
(
wÜk_¡ruù
 *
wÜk
)

1937 
pblk_lše_ws
 *
lše_ws
 = 
	`cÚš”_of
(
wÜk
, pblk_line_ws,

1938 
ws
);

1939 
pblk
 *pblk = 
lše_ws
->pblk;

1940 
pblk_lše
 *
lše
 = 
lše_ws
->line;

1941 
pblk_w_”r_gc
 *
w_”r_gc
 = 
lše
->w_err_gc;

1946 ià(
w_”r_gc
->
has_wr™e_”r
)

1947 
	`pblk_§ve_lba_li¡
(
pblk
, 
lše
);

1949 
	`pblk_lše_þo£
(
pblk
, 
lše
);

1950 
	`mempoÞ_ä“
(
lše_ws
, &
pblk
->
g’_ws_poÞ
);

1951 
	}
}

1953 
	$pblk_g’_run_ws
(
pblk
 *pblk, 
pblk_lše
 *
lše
, *
´iv
,

1954 (*
wÜk
)(
wÜk_¡ruù
 *), 
gå_t
 
gå_mask
,

1955 
wÜkqueue_¡ruù
 *
wq
)

1957 
pblk_lše_ws
 *
lše_ws
;

1959 
lše_ws
 = 
	`mempoÞ_®loc
(&
pblk
->
g’_ws_poÞ
, 
gå_mask
);

1961 
lše_ws
->
pblk
 =…blk;

1962 
lše_ws
->
lše
 =†ine;

1963 
lše_ws
->
´iv
 =…riv;

1965 
	`INIT_WORK
(&
lše_ws
->
ws
, 
wÜk
);

1966 
	`queue_wÜk
(
wq
, &
lše_ws
->
ws
);

1967 
	}
}

1969 
	$__pblk_down_chunk
(
pblk
 *pblk, 
pos
)

1971 
pblk_lun
 *
¾un
 = &
pblk
->
luns
[
pos
];

1972 
»t
;

1979 
»t
 = 
	`down_timeout
(&
¾un
->
wr_£m
, 
	`m£cs_to_jiff›s
(30000));

1980 ià(
»t
 =ð-
ETIME
 ||„‘ =ð-
EINTR
)

1981 
	`pblk_”r
(
pblk
, "taking†un semaphoreimed out:ƒrr %d\n",

1982 -
»t
);

1983 
	}
}

1985 
	$pblk_down_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
)

1987 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1988 
nvm_geo
 *
geo
 = &
dev
->geo;

1989 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

1991 
	`__pblk_down_chunk
(
pblk
, 
pos
);

1992 
	}
}

1994 
	$pblk_down_rq
(
pblk
 *pblk, 
µa_addr
 
µa
,

1995 *
lun_b™m­
)

1997 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1998 
nvm_geo
 *
geo
 = &
dev
->geo;

1999 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

2004 ià(
	`‹¡_ªd_£t_b™
(
pos
, 
lun_b™m­
))

2007 
	`__pblk_down_chunk
(
pblk
, 
pos
);

2008 
	}
}

2010 
	$pblk_up_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
)

2012 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

2013 
nvm_geo
 *
geo
 = &
dev
->geo;

2014 
pblk_lun
 *
¾un
;

2015 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

2017 
¾un
 = &
pblk
->
luns
[
pos
];

2018 
	`up
(&
¾un
->
wr_£m
);

2019 
	}
}

2021 
	$pblk_up_rq
(
pblk
 *pblk, *
lun_b™m­
)

2023 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

2024 
nvm_geo
 *
geo
 = &
dev
->geo;

2025 
pblk_lun
 *
¾un
;

2026 
num_lun
 = 
geo
->
®l_luns
;

2027 
b™
 = -1;

2029 (
b™
 = 
	`fšd_Ãxt_b™
(
lun_b™m­
, 
num_lun
, bit + 1)) <‚um_lun) {

2030 
¾un
 = &
pblk
->
luns
[
b™
];

2031 
	`up
(&
¾un
->
wr_£m
);

2033 
	}
}

2035 
	$pblk_upd©e_m­
(
pblk
 *pblk, 
£ùÜ_t
 
lba
, 
µa_addr
 
µa
)

2037 
µa_addr
 
µa_l2p
;

2040 ià(!(
lba
 < 
pblk
->
ÿ·c™y
)) {

2041 
	`WARN
(1, "pblk: corrupted L2P map„equest\n");

2045 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

2046 
µa_l2p
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

2048 ià(!
	`pblk_addr_š_ÿche
(
µa_l2p
è&& !
	`pblk_µa_em±y
(ppa_l2p))

2049 
	`pblk_m­_šv®id©e
(
pblk
, 
µa_l2p
);

2051 
	`pblk_Œªs_m­_£t
(
pblk
, 
lba
, 
µa
);

2052 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

2053 
	}
}

2055 
	$pblk_upd©e_m­_ÿche
(
pblk
 *pblk, 
£ùÜ_t
 
lba
, 
µa_addr
 
µa
)

2058 #ifdeà
CONFIG_NVM_PBLK_DEBUG


2060 
	`BUG_ON
(!
	`pblk_addr_š_ÿche
(
µa
));

2061 
	`BUG_ON
(
	`pblk_rb_pos_oob
(&
pblk
->
rwb
, 
	`pblk_addr_to_ÿch–še
(
µa
)));

2064 
	`pblk_upd©e_m­
(
pblk
, 
lba
, 
µa
);

2065 
	}
}

2067 
	$pblk_upd©e_m­_gc
(
pblk
 *pblk, 
£ùÜ_t
 
lba
, 
µa_addr
 
µa_Ãw
,

2068 
pblk_lše
 *
gc_lše
, 
u64
 
·ddr_gc
)

2070 
µa_addr
 
µa_l2p
, 
µa_gc
;

2071 
»t
 = 1;

2073 #ifdeà
CONFIG_NVM_PBLK_DEBUG


2075 
	`BUG_ON
(!
	`pblk_addr_š_ÿche
(
µa_Ãw
));

2076 
	`BUG_ON
(
	`pblk_rb_pos_oob
(&
pblk
->
rwb
, 
	`pblk_addr_to_ÿch–še
(
µa_Ãw
)));

2080 ià(!(
lba
 < 
pblk
->
ÿ·c™y
)) {

2081 
	`WARN
(1, "pblk: corrupted L2P map„equest\n");

2085 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

2086 
µa_l2p
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

2087 
µa_gc
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr_gc
, 
gc_lše
->
id
);

2089 ià(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_gc
)) {

2090 
	`¥š_lock
(&
gc_lše
->
lock
);

2091 
	`WARN
(!
	`‹¡_b™
(
·ddr_gc
, 
gc_lše
->
šv®id_b™m­
),

2093 
	`¥š_uÆock
(&
gc_lše
->
lock
);

2095 
»t
 = 0;

2096 
out
;

2099 
	`pblk_Œªs_m­_£t
(
pblk
, 
lba
, 
µa_Ãw
);

2100 
out
:

2101 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

2102  
»t
;

2103 
	}
}

2105 
	$pblk_upd©e_m­_dev
(
pblk
 *pblk, 
£ùÜ_t
 
lba
,

2106 
µa_addr
 
µa_m­³d
, µa_add¸
µa_ÿche
)

2108 
µa_addr
 
µa_l2p
;

2110 #ifdeà
CONFIG_NVM_PBLK_DEBUG


2112 
	`BUG_ON
(
	`pblk_addr_š_ÿche
(
µa_m­³d
));

2115 ià(
lba
 =ð
ADDR_EMPTY
) {

2116 
	`©omic64_šc
(&
pblk
->
·d_wa
);

2117 #ifdeà
CONFIG_NVM_PBLK_DEBUG


2118 
	`©omic_lÚg_šc
(&
pblk
->
·dded_wb
);

2120 ià(!
	`pblk_µa_em±y
(
µa_m­³d
))

2121 
	`pblk_m­_šv®id©e
(
pblk
, 
µa_m­³d
);

2126 ià(!(
lba
 < 
pblk
->
ÿ·c™y
)) {

2127 
	`WARN
(1, "pblk: corrupted L2P map„equest\n");

2131 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

2132 
µa_l2p
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

2137 ià(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_ÿche
)) {

2138 ià(!
	`pblk_µa_em±y
(
µa_m­³d
))

2139 
	`pblk_m­_šv®id©e
(
pblk
, 
µa_m­³d
);

2140 
out
;

2143 #ifdeà
CONFIG_NVM_PBLK_DEBUG


2144 
	`WARN_ON
(!
	`pblk_addr_š_ÿche
(
µa_l2p
è&& !
	`pblk_µa_em±y
(ppa_l2p));

2147 
	`pblk_Œªs_m­_£t
(
pblk
, 
lba
, 
µa_m­³d
);

2148 
out
:

2149 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

2150 
	}
}

2152 
	$pblk_lookup_l2p_£q
(
pblk
 *pblk, 
µa_addr
 *
µas
,

2153 
£ùÜ_t
 
blba
, 
Ä_£cs
, 
boÞ
 *
äom_ÿche
)

2155 
i
;

2157 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

2158 
i
 = 0; i < 
Ä_£cs
; i++) {

2159 
µa_addr
 
µa
;

2161 
µa
 = 
µas
[
i
] = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
blba
 + i);

2164 ià(!
	`pblk_µa_em±y
(
µa
è&& !
	`pblk_addr_š_ÿche
(ppa)) {

2165 
pblk_lše
 *
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
µa
);

2167 ià(
i
 > 0 && *
äom_ÿche
)

2169 *
äom_ÿche
 = 
çl£
;

2171 
	`k»f_g‘
(&
lše
->
»f
);

2173 ià(
i
 > 0 && !*
äom_ÿche
)

2175 *
äom_ÿche
 = 
Œue
;

2178 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

2179  
i
;

2180 
	}
}

2182 
	$pblk_lookup_l2p_¿nd
(
pblk
 *pblk, 
µa_addr
 *
µas
,

2183 
u64
 *
lba_li¡
, 
Ä_£cs
)

2185 
u64
 
lba
;

2186 
i
;

2188 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

2189 
i
 = 0; i < 
Ä_£cs
; i++) {

2190 
lba
 = 
lba_li¡
[
i
];

2191 ià(
lba
 !ð
ADDR_EMPTY
) {

2193 ià(!(
lba
 < 
pblk
->
ÿ·c™y
)) {

2194 
	`WARN
(1, "pblk: corrupted L2P map„equest\n");

2197 
µas
[
i
] = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

2200 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

2201 
	}
}

2203 *
	$pblk_g‘_m‘a_fÜ_wr™es
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

2205 *
bufãr
;

2207 ià(
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
)) {

2209 
bufãr
 = 
rqd
->
m‘a_li¡
;

2214 
bufãr
 = 
	`·ge_to_vœt
(

2215 
rqd
->
bio
->
bi_io_vec
[rqd->bio->
bi_vút
 - 1].
bv_·ge
);

2218  
bufãr
;

2219 
	}
}

2221 
	$pblk_g‘_·cked_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

2223 *
m‘a_li¡
 = 
rqd
->meta_list;

2224 *
·ge
;

2225 
i
 = 0;

2227 ià(
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
))

2230 
·ge
 = 
	`·ge_to_vœt
(
rqd
->
bio
->
bi_io_vec
[rqd->bio->
bi_vút
 - 1].
bv_·ge
);

2232 ; 
i
 < 
rqd
->
Ä_µas
; i++)

2233 
	`memýy
(
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
),

2234 
·ge
 + (
i
 * (
pblk_£c_m‘a
)),

2235 (
pblk_£c_m‘a
));

2236 
	}
}

	@pblk-gc.c

19 
	~"pblk.h
"

20 
	~"pblk-Œaû.h
"

21 
	~<lšux/d–ay.h
>

24 
	$pblk_gc_ä“_gc_rq
(
pblk_gc_rq
 *
gc_rq
)

26 ià(
gc_rq
->
d©a
)

27 
	`vä“
(
gc_rq
->
d©a
);

28 
	`kä“
(
gc_rq
);

29 
	}
}

31 
	$pblk_gc_wr™e
(
pblk
 *pblk)

33 
pblk_gc
 *
gc
 = &
pblk
->gc;

34 
pblk_gc_rq
 *
gc_rq
, *
tgc_rq
;

35 
	`LIST_HEAD
(
w_li¡
);

37 
	`¥š_lock
(&
gc
->
w_lock
);

38 ià(
	`li¡_em±y
(&
gc
->
w_li¡
)) {

39 
	`¥š_uÆock
(&
gc
->
w_lock
);

43 
	`li¡_cut_pos™iÚ
(&
w_li¡
, &
gc
->w_li¡, gc->w_li¡.
´ev
);

44 
gc
->
w_’Œ›s
 = 0;

45 
	`¥š_uÆock
(&
gc
->
w_lock
);

47 
	`li¡_fÜ_—ch_’Œy_§ã
(
gc_rq
, 
tgc_rq
, &
w_li¡
, 
li¡
) {

48 
	`pblk_wr™e_gc_to_ÿche
(
pblk
, 
gc_rq
);

49 
	`li¡_d–
(&
gc_rq
->
li¡
);

50 
	`k»f_put
(&
gc_rq
->
lše
->
»f
, 
pblk_lše_put
);

51 
	`pblk_gc_ä“_gc_rq
(
gc_rq
);

55 
	}
}

57 
	$pblk_gc_wr™”_kick
(
pblk_gc
 *
gc
)

59 
	`wake_up_´oûss
(
gc
->
gc_wr™”_ts
);

60 
	}
}

62 
	$pblk_put_lše_back
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

64 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

65 
li¡_h—d
 *
move_li¡
;

67 
	`¥š_lock
(&
l_mg
->
gc_lock
);

68 
	`¥š_lock
(&
lše
->
lock
);

69 
	`WARN_ON
(
lše
->
¡©e
 !ð
PBLK_LINESTATE_GC
);

70 
lše
->
¡©e
 = 
PBLK_LINESTATE_CLOSED
;

71 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

72 
lše
->
¡©e
);

79 
lše
->
gc_group
 = 
PBLK_LINEGC_NONE
;

80 
move_li¡
 = 
	`pblk_lše_gc_li¡
(
pblk
, 
lše
);

81 
	`¥š_uÆock
(&
lše
->
lock
);

82 
	`li¡_add_ž
(&
lše
->
li¡
, 
move_li¡
);

83 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

84 
	}
}

86 
	$pblk_gc_lše_ws
(
wÜk_¡ruù
 *
wÜk
)

88 
pblk_lše_ws
 *
gc_rq_ws
 = 
	`cÚš”_of
(
wÜk
,

89 
pblk_lše_ws
, 
ws
);

90 
pblk
 *pblk = 
gc_rq_ws
->pblk;

91 
pblk_gc
 *
gc
 = &
pblk
->gc;

92 
pblk_lše
 *
lše
 = 
gc_rq_ws
->line;

93 
pblk_gc_rq
 *
gc_rq
 = 
gc_rq_ws
->
´iv
;

94 
»t
;

96 
	`up
(&
gc
->
gc_£m
);

99 
»t
 = 
	`pblk_subm™_»ad_gc
(
pblk
, 
gc_rq
);

100 ià(
»t
) {

101 
lše
->
w_”r_gc
->
has_gc_”r
 = 1;

102 
out
;

105 ià(!
gc_rq
->
£cs_to_gc
)

106 
out
;

108 
»Œy
:

109 
	`¥š_lock
(&
gc
->
w_lock
);

110 ià(
gc
->
w_’Œ›s
 >ð
PBLK_GC_RQ_QD
) {

111 
	`¥š_uÆock
(&
gc
->
w_lock
);

112 
	`pblk_gc_wr™”_kick
(&
pblk
->
gc
);

113 
	`u¦“p_¿nge
(128, 256);

114 
»Œy
;

116 
gc
->
w_’Œ›s
++;

117 
	`li¡_add_ž
(&
gc_rq
->
li¡
, &
gc
->
w_li¡
);

118 
	`¥š_uÆock
(&
gc
->
w_lock
);

120 
	`pblk_gc_wr™”_kick
(&
pblk
->
gc
);

122 
	`kä“
(
gc_rq_ws
);

125 
out
:

126 
	`pblk_gc_ä“_gc_rq
(
gc_rq
);

127 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put
);

128 
	`kä“
(
gc_rq_ws
);

129 
	}
}

131 
__Ë64
 *
	$g‘_lba_li¡_äom_em‘a
(
pblk
 *pblk,

132 
pblk_lše
 *
lše
)

134 
lše_em‘a
 *
em‘a_buf
;

135 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

136 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

137 
lba_li¡_size
 = 
lm
->
em‘a_Ën
[2];

138 
__Ë64
 *
lba_li¡
;

139 
»t
;

141 
em‘a_buf
 = 
	`pblk_m®loc
(
lm
->
em‘a_Ën
[0],

142 
l_mg
->
em‘a_®loc_ty³
, 
GFP_KERNEL
);

143 ià(!
em‘a_buf
)

144  
NULL
;

146 
»t
 = 
	`pblk_lše_em‘a_»ad
(
pblk
, 
lše
, 
em‘a_buf
);

147 ià(
»t
) {

148 
	`pblk_”r
(
pblk
, "line %d„eadƒmeta failed (%d)\n",

149 
lše
->
id
, 
»t
);

150 
	`pblk_mä“
(
em‘a_buf
, 
l_mg
->
em‘a_®loc_ty³
);

151  
NULL
;

160 
»t
 = 
	`pblk_»cov_check_em‘a
(
pblk
, 
em‘a_buf
);

161 ià(
»t
) {

162 
	`pblk_”r
(
pblk
, "inconsistentƒmeta (line %d)\n",

163 
lše
->
id
);

164 
	`pblk_mä“
(
em‘a_buf
, 
l_mg
->
em‘a_®loc_ty³
);

165  
NULL
;

168 
lba_li¡
 = 
	`pblk_m®loc
(
lba_li¡_size
,

169 
l_mg
->
em‘a_®loc_ty³
, 
GFP_KERNEL
);

170 ià(
lba_li¡
)

171 
	`memýy
(
lba_li¡
, 
	`em‘a_to_lbas
(
pblk
, 
em‘a_buf
), 
lba_li¡_size
);

173 
	`pblk_mä“
(
em‘a_buf
, 
l_mg
->
em‘a_®loc_ty³
);

175  
lba_li¡
;

176 
	}
}

178 
	$pblk_gc_lše_´•¬e_ws
(
wÜk_¡ruù
 *
wÜk
)

180 
pblk_lše_ws
 *
lše_ws
 = 
	`cÚš”_of
(
wÜk
, pblk_line_ws,

181 
ws
);

182 
pblk
 *pblk = 
lše_ws
->pblk;

183 
pblk_lše
 *
lše
 = 
lše_ws
->line;

184 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

185 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

186 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

187 
nvm_geo
 *
geo
 = &
dev
->geo;

188 
pblk_gc
 *
gc
 = &
pblk
->gc;

189 
pblk_lše_ws
 *
gc_rq_ws
;

190 
pblk_gc_rq
 *
gc_rq
;

191 
__Ë64
 *
lba_li¡
;

192 *
šv®id_b™m­
;

193 
£c_Ëá
, 
Ä_£cs
, 
b™
;

195 
šv®id_b™m­
 = 
	`km®loc
(
lm
->
£c_b™m­_Ën
, 
GFP_KERNEL
);

196 ià(!
šv®id_b™m­
)

197 
çž_ä“_ws
;

199 ià(
lše
->
w_”r_gc
->
has_wr™e_”r
) {

200 
lba_li¡
 = 
lše
->
w_”r_gc
->lba_list;

201 
lše
->
w_”r_gc
->
lba_li¡
 = 
NULL
;

203 
lba_li¡
 = 
	`g‘_lba_li¡_äom_em‘a
(
pblk
, 
lše
);

204 ià(!
lba_li¡
) {

205 
	`pblk_”r
(
pblk
, "could‚ot interpretƒmeta (line %d)\n",

206 
lše
->
id
);

207 
çž_ä“_šv®id_b™m­
;

211 
	`¥š_lock
(&
lše
->
lock
);

212 
	`b™m­_cÝy
(
šv®id_b™m­
, 
lše
->šv®id_b™m­, 
lm
->
£c_³r_lše
);

213 
£c_Ëá
 = 
	`pblk_lše_vsc
(
lše
);

214 
	`¥š_uÆock
(&
lše
->
lock
);

216 ià(
£c_Ëá
 < 0) {

217 
	`pblk_”r
(
pblk
, "cÜru±ed GC†š(%d)\n", 
lše
->
id
);

218 
çž_ä“_lba_li¡
;

221 
b™
 = -1;

222 
Ãxt_rq
:

223 
gc_rq
 = 
	`km®loc
((
pblk_gc_rq
), 
GFP_KERNEL
);

224 ià(!
gc_rq
)

225 
çž_ä“_lba_li¡
;

227 
Ä_£cs
 = 0;

229 
b™
 = 
	`fšd_Ãxt_z”o_b™
(
šv®id_b™m­
, 
lm
->
£c_³r_lše
,

230 
b™
 + 1);

231 ià(
b™
 > 
lše
->
em‘a_s£c
)

234 
gc_rq
->
·ddr_li¡
[
Ä_£cs
] = 
b™
;

235 
gc_rq
->
lba_li¡
[
Ä_£cs
++] = 
	`Ë64_to_ýu
Öba_li¡[
b™
]);

236 } 
Ä_£cs
 < 
pblk
->
max_wr™e_pgs
);

238 ià(
	`uÆik–y
(!
Ä_£cs
)) {

239 
	`kä“
(
gc_rq
);

240 
out
;

243 
gc_rq
->
Ä_£cs
 =‚r_secs;

244 
gc_rq
->
lše
 =†ine;

246 
gc_rq
->
d©a
 = 
	`vm®loc
(
	`¬¿y_size
(gc_rq->
Ä_£cs
, 
geo
->
c£cs
));

247 ià(!
gc_rq
->
d©a
)

248 
çž_ä“_gc_rq
;

250 
gc_rq_ws
 = 
	`km®loc
((
pblk_lše_ws
), 
GFP_KERNEL
);

251 ià(!
gc_rq_ws
)

252 
çž_ä“_gc_d©a
;

254 
gc_rq_ws
->
pblk
 =…blk;

255 
gc_rq_ws
->
lše
 =†ine;

256 
gc_rq_ws
->
´iv
 = 
gc_rq
;

262 
	`down_timeout
(&
gc
->
gc_£m
, 
	`m£cs_to_jiff›s
(30000)))

263 
	`io_scheduË
();

265 
	`k»f_g‘
(&
lše
->
»f
);

267 
	`INIT_WORK
(&
gc_rq_ws
->
ws
, 
pblk_gc_lše_ws
);

268 
	`queue_wÜk
(
gc
->
gc_lše_»ad”_wq
, &
gc_rq_ws
->
ws
);

270 
£c_Ëá
 -ð
Ä_£cs
;

271 ià(
£c_Ëá
 > 0)

272 
Ãxt_rq
;

274 
out
:

275 
	`pblk_mä“
(
lba_li¡
, 
l_mg
->
em‘a_®loc_ty³
);

276 
	`kä“
(
lše_ws
);

277 
	`kä“
(
šv®id_b™m­
);

279 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put
);

280 
	`©omic_dec
(&
gc
->
»ad_šæight_gc
);

284 
çž_ä“_gc_d©a
:

285 
	`vä“
(
gc_rq
->
d©a
);

286 
çž_ä“_gc_rq
:

287 
	`kä“
(
gc_rq
);

288 
çž_ä“_lba_li¡
:

289 
	`pblk_mä“
(
lba_li¡
, 
l_mg
->
em‘a_®loc_ty³
);

290 
çž_ä“_šv®id_b™m­
:

291 
	`kä“
(
šv®id_b™m­
);

292 
çž_ä“_ws
:

293 
	`kä“
(
lše_ws
);

299 
	`pblk_put_lše_back
(
pblk
, 
lše
);

300 
	`©omic_dec
(&
gc
->
»ad_šæight_gc
);

302 
	`pblk_”r
(
pblk
, "çžedØGC†š%d\n", 
lše
->
id
);

303 
	}
}

305 
	$pblk_gc_lše
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

307 
pblk_gc
 *
gc
 = &
pblk
->gc;

308 
pblk_lše_ws
 *
lše_ws
;

310 
	`pblk_debug
(
pblk
, "lš'%d' bešg„eþaimed fÜ GC\n", 
lše
->
id
);

312 
lše_ws
 = 
	`km®loc
((
pblk_lše_ws
), 
GFP_KERNEL
);

313 ià(!
lše_ws
)

314  -
ENOMEM
;

316 
lše_ws
->
pblk
 =…blk;

317 
lše_ws
->
lše
 =†ine;

319 
	`©omic_šc
(&
gc
->
p–še_gc
);

320 
	`INIT_WORK
(&
lše_ws
->
ws
, 
pblk_gc_lše_´•¬e_ws
);

321 
	`queue_wÜk
(
gc
->
gc_»ad”_wq
, &
lše_ws
->
ws
);

324 
	}
}

326 
	$pblk_gc_»ad”_kick
(
pblk_gc
 *
gc
)

328 
	`wake_up_´oûss
(
gc
->
gc_»ad”_ts
);

329 
	}
}

331 
	$pblk_gc_kick
(
pblk
 *pblk)

333 
pblk_gc
 *
gc
 = &
pblk
->gc;

335 
	`pblk_gc_wr™”_kick
(
gc
);

336 
	`pblk_gc_»ad”_kick
(
gc
);

339 ià(
gc
->
gc_’abËd
) {

340 
	`wake_up_´oûss
(
gc
->
gc_ts
);

341 
	`mod_tim”
(&
gc
->
gc_tim”
,

342 
jiff›s
 + 
	`m£cs_to_jiff›s
(
GC_TIME_MSECS
));

344 
	}
}

346 
	$pblk_gc_»ad
(
pblk
 *pblk)

348 
pblk_gc
 *
gc
 = &
pblk
->gc;

349 
pblk_lše
 *
lše
;

351 
	`¥š_lock
(&
gc
->
r_lock
);

352 ià(
	`li¡_em±y
(&
gc
->
r_li¡
)) {

353 
	`¥š_uÆock
(&
gc
->
r_lock
);

357 
lše
 = 
	`li¡_fœ¡_’Œy
(&
gc
->
r_li¡
, 
pblk_lše
, 
li¡
);

358 
	`li¡_d–
(&
lše
->
li¡
);

359 
	`¥š_uÆock
(&
gc
->
r_lock
);

361 
	`pblk_gc_kick
(
pblk
);

363 ià(
	`pblk_gc_lše
(
pblk
, 
lše
)) {

364 
	`pblk_”r
(
pblk
, "çžedØGC†š%d\n", 
lše
->
id
);

366 
	`¥š_lock
(&
gc
->
r_lock
);

367 
	`li¡_add_ž
(&
lše
->
li¡
, &
gc
->
r_li¡
);

368 
	`¥š_uÆock
(&
gc
->
r_lock
);

372 
	}
}

374 
pblk_lše
 *
	$pblk_gc_g‘_viùim_lše
(
pblk
 *pblk,

375 
li¡_h—d
 *
group_li¡
)

377 
pblk_lše
 *
lše
, *
viùim
;

378 
lše_vsc
 = ~0x0L, 
viùim_vsc
 = ~0x0L;

380 
viùim
 = 
	`li¡_fœ¡_’Œy
(
group_li¡
, 
pblk_lše
, 
li¡
);

382 
	`li¡_fÜ_—ch_’Œy
(
lše
, 
group_li¡
, 
li¡
) {

383 ià(!
	`©omic_»ad
(&
lše
->
£c_to_upd©e
))

384 
lše_vsc
 = 
	`Ë32_to_ýu
(*
lše
->
vsc
);

385 ià(
lše_vsc
 < 
viùim_vsc
) {

386 
viùim
 = 
lše
;

387 
viùim_vsc
 = 
	`Ë32_to_ýu
(*
viùim
->
vsc
);

391 ià(
viùim_vsc
 == ~0x0)

392  
NULL
;

394  
viùim
;

395 
	}
}

397 
boÞ
 
	$pblk_gc_should_run
(
pblk_gc
 *
gc
, 
pblk_¾
 *
¾
)

399 
Ä_blocks_ä“
, 
Ä_blocks_Ãed
;

400 
w”r_lšes
 = 
	`©omic_»ad
(&
¾
->werr_lines);

402 
Ä_blocks_Ãed
 = 
	`pblk_¾_high_thrs
(
¾
);

403 
Ä_blocks_ä“
 = 
	`pblk_¾_Ä_ä“_blks
(
¾
);

406  ((
w”r_lšes
 > 0) ||

407 ((
gc
->
gc_aùive
è&& (
Ä_blocks_Ãed
 > 
Ä_blocks_ä“
)));

408 
	}
}

410 
	$pblk_gc_ä“_fuÎ_lšes
(
pblk
 *pblk)

412 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

413 
pblk_gc
 *
gc
 = &
pblk
->gc;

414 
pblk_lše
 *
lše
;

417 
	`¥š_lock
(&
l_mg
->
gc_lock
);

418 ià(
	`li¡_em±y
(&
l_mg
->
gc_fuÎ_li¡
)) {

419 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

423 
lše
 = 
	`li¡_fœ¡_’Œy
(&
l_mg
->
gc_fuÎ_li¡
,

424 
pblk_lše
, 
li¡
);

426 
	`¥š_lock
(&
lše
->
lock
);

427 
	`WARN_ON
(
lše
->
¡©e
 !ð
PBLK_LINESTATE_CLOSED
);

428 
lše
->
¡©e
 = 
PBLK_LINESTATE_GC
;

429 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

430 
lše
->
¡©e
);

431 
	`¥š_uÆock
(&
lše
->
lock
);

433 
	`li¡_d–
(&
lše
->
li¡
);

434 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

436 
	`©omic_šc
(&
gc
->
p–še_gc
);

437 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put
);

439 
	}
}

447 
	$pblk_gc_run
(
pblk
 *pblk)

449 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

450 
pblk_gc
 *
gc
 = &
pblk
->gc;

451 
pblk_lše
 *
lše
;

452 
li¡_h—d
 *
group_li¡
;

453 
boÞ
 
run_gc
;

454 
»ad_šæight_gc
, 
gc_group
 = 0, 
´ev_group
 = 0;

456 
	`pblk_gc_ä“_fuÎ_lšes
(
pblk
);

458 
run_gc
 = 
	`pblk_gc_should_run
(&
pblk
->
gc
, &pblk->
¾
);

459 ià(!
run_gc
 || (
	`©omic_»ad
(&
gc
->
»ad_šæight_gc
è>ð
PBLK_GC_L_QD
))

462 
Ãxt_gc_group
:

463 
group_li¡
 = 
l_mg
->
gc_li¡s
[
gc_group
++];

466 
	`¥š_lock
(&
l_mg
->
gc_lock
);

468 
lše
 = 
	`pblk_gc_g‘_viùim_lše
(
pblk
, 
group_li¡
);

469 ià(!
lše
) {

470 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

474 
	`¥š_lock
(&
lše
->
lock
);

475 
	`WARN_ON
(
lše
->
¡©e
 !ð
PBLK_LINESTATE_CLOSED
);

476 
lše
->
¡©e
 = 
PBLK_LINESTATE_GC
;

477 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

478 
lše
->
¡©e
);

479 
	`¥š_uÆock
(&
lše
->
lock
);

481 
	`li¡_d–
(&
lše
->
li¡
);

482 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

484 
	`¥š_lock
(&
gc
->
r_lock
);

485 
	`li¡_add_ž
(&
lše
->
li¡
, &
gc
->
r_li¡
);

486 
	`¥š_uÆock
(&
gc
->
r_lock
);

488 
»ad_šæight_gc
 = 
	`©omic_šc_»tuº
(&
gc
->read_inflight_gc);

489 
	`pblk_gc_»ad”_kick
(
gc
);

491 
´ev_group
 = 1;

494 
run_gc
 = 
	`pblk_gc_should_run
(&
pblk
->
gc
, &pblk->
¾
);

495 ià(!
run_gc
 || 
»ad_šæight_gc
 >ð
PBLK_GC_L_QD
)

499 ià(!
´ev_group
 && 
pblk
->
¾
.
rb_¡©e
 > 
gc_group
 &&

500 
gc_group
 < 
PBLK_GC_NR_LISTS
)

501 
Ãxt_gc_group
;

502 
	}
}

504 
	$pblk_gc_tim”
(
tim”_li¡
 *
t
)

506 
pblk
 *pblk = 
	`äom_tim”
Õblk, 
t
, 
gc
.
gc_tim”
);

508 
	`pblk_gc_kick
(
pblk
);

509 
	}
}

511 
	$pblk_gc_ts
(*
d©a
)

513 
pblk
 *pblk = 
d©a
;

515 !
	`kth»ad_should_¡Ý
()) {

516 
	`pblk_gc_run
(
pblk
);

517 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

518 
	`io_scheduË
();

522 
	}
}

524 
	$pblk_gc_wr™”_ts
(*
d©a
)

526 
pblk
 *pblk = 
d©a
;

528 !
	`kth»ad_should_¡Ý
()) {

529 ià(!
	`pblk_gc_wr™e
(
pblk
))

531 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

532 
	`io_scheduË
();

536 
	}
}

538 
	$pblk_gc_»ad”_ts
(*
d©a
)

540 
pblk
 *pblk = 
d©a
;

541 
pblk_gc
 *
gc
 = &
pblk
->gc;

543 !
	`kth»ad_should_¡Ý
()) {

544 ià(!
	`pblk_gc_»ad
(
pblk
))

546 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

547 
	`io_scheduË
();

550 #ifdeà
CONFIG_NVM_PBLK_DEBUG


551 
	`pblk_šfo
(
pblk
, "flushing gc…ipeline, %d†ines†eft\n",

552 
	`©omic_»ad
(&
gc
->
p–še_gc
));

556 ià(!
	`©omic_»ad
(&
gc
->
p–še_gc
))

559 
	`scheduË
();

563 
	}
}

565 
	$pblk_gc_¡¬t
(
pblk
 *pblk)

567 
pblk
->
gc
.
gc_aùive
 = 1;

568 
	`pblk_debug
(
pblk
, "gc start\n");

569 
	}
}

571 
	$pblk_gc_should_¡¬t
(
pblk
 *pblk)

573 
pblk_gc
 *
gc
 = &
pblk
->gc;

575 ià(
gc
->
gc_’abËd
 && !gc->
gc_aùive
) {

576 
	`pblk_gc_¡¬t
(
pblk
);

577 
	`pblk_gc_kick
(
pblk
);

579 
	}
}

581 
	$pblk_gc_should_¡Ý
(
pblk
 *pblk)

583 
pblk_gc
 *
gc
 = &
pblk
->gc;

585 ià(
gc
->
gc_aùive
 && !gc->
gc_fÜûd
)

586 
gc
->
gc_aùive
 = 0;

587 
	}
}

589 
	$pblk_gc_should_kick
(
pblk
 *pblk)

591 
	`pblk_¾_upd©e_¿‹s
(&
pblk
->
¾
);

592 
	}
}

594 
	$pblk_gc_sysfs_¡©e_show
(
pblk
 *pblk, *
gc_’abËd
,

595 *
gc_aùive
)

597 
pblk_gc
 *
gc
 = &
pblk
->gc;

599 
	`¥š_lock
(&
gc
->
lock
);

600 *
gc_’abËd
 = 
gc
->gc_enabled;

601 *
gc_aùive
 = 
gc
->gc_active;

602 
	`¥š_uÆock
(&
gc
->
lock
);

603 
	}
}

605 
	$pblk_gc_sysfs_fÜû
(
pblk
 *pblk, 
fÜû
)

607 
pblk_gc
 *
gc
 = &
pblk
->gc;

609 ià(
fÜû
 < 0 || force > 1)

610  -
EINVAL
;

612 
	`¥š_lock
(&
gc
->
lock
);

613 
gc
->
gc_fÜûd
 = 
fÜû
;

615 ià(
fÜû
)

616 
gc
->
gc_’abËd
 = 1;

618 
gc
->
gc_’abËd
 = 0;

619 
	`¥š_uÆock
(&
gc
->
lock
);

621 
	`pblk_gc_should_¡¬t
(
pblk
);

624 
	}
}

626 
	$pblk_gc_š™
(
pblk
 *pblk)

628 
pblk_gc
 *
gc
 = &
pblk
->gc;

629 
»t
;

631 
gc
->
gc_ts
 = 
	`kth»ad_ü—‹
(
pblk_gc_ts
, 
pblk
, "pblk-gc-ts");

632 ià(
	`IS_ERR
(
gc
->
gc_ts
)) {

633 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC main kthread\n");

634  
	`PTR_ERR
(
gc
->
gc_ts
);

637 
gc
->
gc_wr™”_ts
 = 
	`kth»ad_ü—‹
(
pblk_gc_wr™”_ts
, 
pblk
,

639 ià(
	`IS_ERR
(
gc
->
gc_wr™”_ts
)) {

640 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC writer kthread\n");

641 
»t
 = 
	`PTR_ERR
(
gc
->
gc_wr™”_ts
);

642 
çž_ä“_maš_kth»ad
;

645 
gc
->
gc_»ad”_ts
 = 
	`kth»ad_ü—‹
(
pblk_gc_»ad”_ts
, 
pblk
,

647 ià(
	`IS_ERR
(
gc
->
gc_»ad”_ts
)) {

648 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC„eader kthread\n");

649 
»t
 = 
	`PTR_ERR
(
gc
->
gc_»ad”_ts
);

650 
çž_ä“_wr™”_kth»ad
;

653 
	`tim”_£tup
(&
gc
->
gc_tim”
, 
pblk_gc_tim”
, 0);

654 
	`mod_tim”
(&
gc
->
gc_tim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(
GC_TIME_MSECS
));

656 
gc
->
gc_aùive
 = 0;

657 
gc
->
gc_fÜûd
 = 0;

658 
gc
->
gc_’abËd
 = 1;

659 
gc
->
w_’Œ›s
 = 0;

660 
	`©omic_£t
(&
gc
->
»ad_šæight_gc
, 0);

661 
	`©omic_£t
(&
gc
->
p–še_gc
, 0);

666 
gc
->
gc_lše_»ad”_wq
 = 
	`®loc_wÜkqueue
("pblk-gc-line-reader-wq",

667 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 
PBLK_GC_MAX_READERS
);

668 ià(!
gc
->
gc_lše_»ad”_wq
) {

669 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC†ine„eader workqueue\n");

670 
»t
 = -
ENOMEM
;

671 
çž_ä“_»ad”_kth»ad
;

675 
gc
->
gc_»ad”_wq
 = 
	`®loc_wÜkqueue
("pblk-gc-line_wq",

676 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

677 ià(!
gc
->
gc_»ad”_wq
) {

678 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC„eader workqueue\n");

679 
»t
 = -
ENOMEM
;

680 
çž_ä“_»ad”_lše_wq
;

683 
	`¥š_lock_š™
(&
gc
->
lock
);

684 
	`¥š_lock_š™
(&
gc
->
w_lock
);

685 
	`¥š_lock_š™
(&
gc
->
r_lock
);

687 
	`£ma_š™
(&
gc
->
gc_£m
, 
PBLK_GC_RQ_QD
);

689 
	`INIT_LIST_HEAD
(&
gc
->
w_li¡
);

690 
	`INIT_LIST_HEAD
(&
gc
->
r_li¡
);

694 
çž_ä“_»ad”_lše_wq
:

695 
	`de¡roy_wÜkqueue
(
gc
->
gc_lše_»ad”_wq
);

696 
çž_ä“_»ad”_kth»ad
:

697 
	`kth»ad_¡Ý
(
gc
->
gc_»ad”_ts
);

698 
çž_ä“_wr™”_kth»ad
:

699 
	`kth»ad_¡Ý
(
gc
->
gc_wr™”_ts
);

700 
çž_ä“_maš_kth»ad
:

701 
	`kth»ad_¡Ý
(
gc
->
gc_ts
);

703  
»t
;

704 
	}
}

706 
	$pblk_gc_ex™
(
pblk
 *pblk, 
boÞ
 
g¿ûful
)

708 
pblk_gc
 *
gc
 = &
pblk
->gc;

710 
gc
->
gc_’abËd
 = 0;

711 
	`d–_tim”_sync
(&
gc
->
gc_tim”
);

712 
gc
->
gc_aùive
 = 0;

714 ià(
gc
->
gc_ts
)

715 
	`kth»ad_¡Ý
(
gc
->
gc_ts
);

717 ià(
gc
->
gc_»ad”_ts
)

718 
	`kth»ad_¡Ý
(
gc
->
gc_»ad”_ts
);

720 ià(
g¿ûful
) {

721 
	`æush_wÜkqueue
(
gc
->
gc_»ad”_wq
);

722 
	`æush_wÜkqueue
(
gc
->
gc_lše_»ad”_wq
);

725 
	`de¡roy_wÜkqueue
(
gc
->
gc_»ad”_wq
);

726 
	`de¡roy_wÜkqueue
(
gc
->
gc_lše_»ad”_wq
);

728 ià(
gc
->
gc_wr™”_ts
)

729 
	`kth»ad_¡Ý
(
gc
->
gc_wr™”_ts
);

730 
	}
}

	@pblk-init.c

22 
	~"pblk.h
"

23 
	~"pblk-Œaû.h
"

25 
	gwr™e_bufãr_size
;

27 
moduË_·¿m
(
wr™e_bufãr_size
, 
ušt
, 0644);

28 
MODULE_PARM_DESC
(
wr™e_bufãr_size
, "number ofƒntries in‡ write buffer");

30 
	spblk_glob®_ÿches
 {

31 
kmem_ÿche
 *
	mws
;

32 
kmem_ÿche
 *
	m»c
;

33 
kmem_ÿche
 *
	mg_rq
;

34 
kmem_ÿche
 *
	mw_rq
;

36 
k»f
 
	mk»f
;

38 
mu‹x
 
	mmu‹x
;

43 
pblk_glob®_ÿches
 
	gpblk_ÿches
 = {

44 .
mu‹x
 = 
__MUTEX_INITIALIZER
(
pblk_ÿches
.mutex),

45 .
	gk»f
 = 
KREF_INIT
(0),

48 
bio_£t
 
	gpblk_bio_£t
;

50 
blk_qc_t
 
	$pblk_make_rq
(
»que¡_queue
 *
q
, 
bio
 *bio)

52 
pblk
 *pblk = 
q
->
queued©a
;

54 ià(
	`bio_Ý
(
bio
è=ð
REQ_OP_DISCARD
) {

55 
	`pblk_disÿrd
(
pblk
, 
bio
);

56 ià(!(
bio
->
bi_Ýf
 & 
REQ_PREFLUSH
)) {

57 
	`bio_’dio
(
bio
);

58  
BLK_QC_T_NONE
;

65 ià(
	`bio_d©a_dœ
(
bio
è=ð
READ
) {

66 
	`blk_queue_¥l™
(
q
, &
bio
);

67 
	`pblk_subm™_»ad
(
pblk
, 
bio
);

73 ià(
	`pblk_g‘_£cs
(
bio
è> 
	`pblk_¾_max_io
(&
pblk
->
¾
))

74 
	`blk_queue_¥l™
(
q
, &
bio
);

76 
	`pblk_wr™e_to_ÿche
(
pblk
, 
bio
, 
PBLK_IOTYPE_USER
);

79  
BLK_QC_T_NONE
;

80 
	}
}

82 
size_t
 
	$pblk_Œªs_m­_size
(
pblk
 *pblk)

84 
’Œy_size
 = 8;

86 ià(
pblk
->
addrf_Ën
 < 32)

87 
’Œy_size
 = 4;

89  
’Œy_size
 * 
pblk
->
ÿ·c™y
;

90 
	}
}

92 #ifdeà
CONFIG_NVM_PBLK_DEBUG


93 
u32
 
	$pblk_l2p_üc
(
pblk
 *pblk)

95 
size_t
 
m­_size
;

96 
u32
 
üc
 = ~(u32)0;

98 
m­_size
 = 
	`pblk_Œªs_m­_size
(
pblk
);

99 
üc
 = 
	`üc32_Ë
(üc, 
pblk
->
Œªs_m­
, 
m­_size
);

100  
üc
;

101 
	}
}

104 
	$pblk_l2p_ä“
(
pblk
 *pblk)

106 
	`vä“
(
pblk
->
Œªs_m­
);

107 
	}
}

109 
	$pblk_l2p_»cov”
(
pblk
 *pblk, 
boÞ
 
çùÜy_š™
)

111 
pblk_lše
 *
lše
 = 
NULL
;

113 ià(
çùÜy_š™
) {

114 
	`guid_g’
(&
pblk
->
š¡ªû_uuid
);

116 
lše
 = 
	`pblk_»cov_l2p
(
pblk
);

117 ià(
	`IS_ERR
(
lše
)) {

118 
	`pblk_”r
(
pblk
, "could‚ot„ecover†2pable\n");

119  -
EFAULT
;

123 #ifdeà
CONFIG_NVM_PBLK_DEBUG


124 
	`pblk_šfo
(
pblk
, "š™: L2P CRC: %x\n", 
	`pblk_l2p_üc
(pblk));

128 
	`pblk_gc_ä“_fuÎ_lšes
(
pblk
);

130 ià(!
lše
) {

132 
lše
 = 
	`pblk_lše_g‘_fœ¡_d©a
(
pblk
);

133 ià(!
lše
)

134  -
EFAULT
;

138 
	}
}

140 
	$pblk_l2p_š™
(
pblk
 *pblk, 
boÞ
 
çùÜy_š™
)

142 
£ùÜ_t
 
i
;

143 
µa_addr
 
µa
;

144 
size_t
 
m­_size
;

145 
»t
 = 0;

147 
m­_size
 = 
	`pblk_Œªs_m­_size
(
pblk
);

148 
pblk
->
Œªs_m­
 = 
	`__vm®loc
(
m­_size
, 
GFP_KERNEL
 | 
__GFP_NOWARN


149 | 
__GFP_RETRY_MAYFAIL
 | 
__GFP_HIGHMEM
,

150 
PAGE_KERNEL
);

151 ià(!
pblk
->
Œªs_m­
) {

152 
	`pblk_”r
(
pblk
, "failedo‡llocate L2P (need %zu of memory)\n",

153 
m­_size
);

154  -
ENOMEM
;

157 
	`pblk_µa_£t_em±y
(&
µa
);

159 
i
 = 0; i < 
pblk
->
ÿ·c™y
; i++)

160 
	`pblk_Œªs_m­_£t
(
pblk
, 
i
, 
µa
);

162 
»t
 = 
	`pblk_l2p_»cov”
(
pblk
, 
çùÜy_š™
);

163 ià(
»t
)

164 
	`vä“
(
pblk
->
Œªs_m­
);

166  
»t
;

167 
	}
}

169 
	$pblk_rwb_ä“
(
pblk
 *pblk)

171 ià(
	`pblk_rb_‹¬_down_check
(&
pblk
->
rwb
))

172 
	`pblk_”r
(
pblk
, "write bufferƒrror onear down\n");

174 
	`pblk_rb_ä“
(&
pblk
->
rwb
);

175 
	}
}

177 
	$pblk_rwb_š™
(
pblk
 *pblk)

179 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

180 
nvm_geo
 *
geo
 = &
dev
->geo;

181 
bufãr_size
;

182 
pgs_š_bufãr
, 
th»shÞd
;

184 
th»shÞd
 = 
geo
->
mw_cun™s
 * geo->
®l_luns
;

185 
pgs_š_bufãr
 = (
	`max
(
geo
->
mw_cun™s
, geo->
ws_Ýt
) + geo->ws_opt)

186 * 
geo
->
®l_luns
;

188 ià(
wr™e_bufãr_size
 && (wr™e_bufãr_siz> 
pgs_š_bufãr
))

189 
bufãr_size
 = 
wr™e_bufãr_size
;

191 
bufãr_size
 = 
pgs_š_bufãr
;

193  
	`pblk_rb_š™
(&
pblk
->
rwb
, 
bufãr_size
, 
th»shÞd
, 
geo
->
c£cs
);

194 
	}
}

196 
	$pblk_£t_addrf_12
(
pblk
 *pblk, 
nvm_geo
 *
geo
,

197 
nvm_addrf_12
 *
d¡
)

199 
nvm_addrf_12
 *
¤c
 = (nvm_addrf_12 *)&
geo
->
addrf
;

200 
pow”_Ën
;

203 
pow”_Ën
 = 
	`g‘_couÁ_Üd”
(
geo
->
num_ch
);

204 ià(1 << 
pow”_Ën
 !ð
geo
->
num_ch
) {

205 
	`pblk_”r
(
pblk
, "supports only…ower-of-two channel config.\n");

206  -
EINVAL
;

208 
d¡
->
ch_Ën
 = 
pow”_Ën
;

210 
pow”_Ën
 = 
	`g‘_couÁ_Üd”
(
geo
->
num_lun
);

211 ià(1 << 
pow”_Ën
 !ð
geo
->
num_lun
) {

212 
	`pblk_”r
(
pblk
, "supports only…ower-of-two LUN config.\n");

213  -
EINVAL
;

215 
d¡
->
lun_Ën
 = 
pow”_Ën
;

217 
d¡
->
blk_Ën
 = 
¤c
->blk_len;

218 
d¡
->
pg_Ën
 = 
¤c
->pg_len;

219 
d¡
->
¶n_Ën
 = 
¤c
->pln_len;

220 
d¡
->
£c_Ën
 = 
¤c
->sec_len;

222 
d¡
->
£c_off£t
 = 0;

223 
d¡
->
¶n_off£t
 = d¡->
£c_Ën
;

224 
d¡
->
ch_off£t
 = d¡->
¶n_off£t
 + d¡->
¶n_Ën
;

225 
d¡
->
lun_off£t
 = d¡->
ch_off£t
 + d¡->
ch_Ën
;

226 
d¡
->
pg_off£t
 = d¡->
lun_off£t
 + d¡->
lun_Ën
;

227 
d¡
->
blk_off£t
 = d¡->
pg_off£t
 + d¡->
pg_Ën
;

229 
d¡
->
£c_mask
 = ((1ULL << d¡->
£c_Ën
è- 1è<< d¡->
£c_off£t
;

230 
d¡
->
¶n_mask
 = ((1ULL << d¡->
¶n_Ën
è- 1è<< d¡->
¶n_off£t
;

231 
d¡
->
ch_mask
 = ((1ULL << d¡->
ch_Ën
è- 1è<< d¡->
ch_off£t
;

232 
d¡
->
lun_mask
 = ((1ULL << d¡->
lun_Ën
è- 1è<< d¡->
lun_off£t
;

233 
d¡
->
pg_mask
 = ((1ULL << d¡->
pg_Ën
è- 1è<< d¡->
pg_off£t
;

234 
d¡
->
blk_mask
 = ((1ULL << d¡->
blk_Ën
è- 1è<< d¡->
blk_off£t
;

236  
d¡
->
blk_off£t
 + 
¤c
->
blk_Ën
;

237 
	}
}

239 
	$pblk_£t_addrf_20
(
nvm_geo
 *
geo
, 
nvm_addrf
 *
ad¡
,

240 
pblk_addrf
 *
ud¡
)

242 
nvm_addrf
 *
¤c
 = &
geo
->
addrf
;

244 
ad¡
->
ch_Ën
 = 
	`g‘_couÁ_Üd”
(
geo
->
num_ch
);

245 
ad¡
->
lun_Ën
 = 
	`g‘_couÁ_Üd”
(
geo
->
num_lun
);

246 
ad¡
->
chk_Ën
 = 
¤c
->chk_len;

247 
ad¡
->
£c_Ën
 = 
¤c
->sec_len;

249 
ad¡
->
£c_off£t
 = 0;

250 
ad¡
->
ch_off£t
 =‡d¡->
£c_Ën
;

251 
ad¡
->
lun_off£t
 =‡d¡->
ch_off£t
 +‡d¡->
ch_Ën
;

252 
ad¡
->
chk_off£t
 =‡d¡->
lun_off£t
 +‡d¡->
lun_Ën
;

254 
ad¡
->
£c_mask
 = ((1ULL <<‡d¡->
£c_Ën
è- 1è<<‡d¡->
£c_off£t
;

255 
ad¡
->
chk_mask
 = ((1ULL <<‡d¡->
chk_Ën
è- 1è<<‡d¡->
chk_off£t
;

256 
ad¡
->
lun_mask
 = ((1ULL <<‡d¡->
lun_Ën
è- 1è<<‡d¡->
lun_off£t
;

257 
ad¡
->
ch_mask
 = ((1ULL <<‡d¡->
ch_Ën
è- 1è<<‡d¡->
ch_off£t
;

259 
ud¡
->
£c_¡re
 = 
geo
->
ws_Ýt
;

260 
ud¡
->
ch_¡re
 = 
geo
->
num_ch
;

261 
ud¡
->
lun_¡re
 = 
geo
->
num_lun
;

263 
ud¡
->
£c_lun_¡re
 = ud¡->
£c_¡re
 * ud¡->
ch_¡re
;

264 
ud¡
->
£c_ws_¡re
 = ud¡->
£c_lun_¡re
 * ud¡->
lun_¡re
;

266  
ad¡
->
chk_off£t
 +‡d¡->
chk_Ën
;

267 
	}
}

269 
	$pblk_£t_addrf
(
pblk
 *pblk)

271 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

272 
nvm_geo
 *
geo
 = &
dev
->geo;

273 
mod
;

275 
geo
->
v”siÚ
) {

276 
NVM_OCSSD_SPEC_12
:

277 
	`div_u64_»m
(
geo
->
þba
, 
pblk
->
mš_wr™e_pgs
, &
mod
);

278 ià(
mod
) {

279 
	`pblk_”r
(
pblk
, "bad configuration of sectors/pages\n");

280  -
EINVAL
;

283 
pblk
->
addrf_Ën
 = 
	`pblk_£t_addrf_12
Õblk, 
geo
,

284 (*)&
pblk
->
addrf
);

286 
NVM_OCSSD_SPEC_20
:

287 
pblk
->
addrf_Ën
 = 
	`pblk_£t_addrf_20
(
geo
, (*)&pblk->
addrf
,

288 &
pblk
->
uaddrf
);

291 
	`pblk_”r
(
pblk
, "OCSSD„evision‚ot supported (%d)\n",

292 
geo
->
v”siÚ
);

293  -
EINVAL
;

297 
	}
}

299 
	$pblk_ü—‹_glob®_ÿches
()

302 
pblk_ÿches
.
ws
 = 
	`kmem_ÿche_ü—‹
("pblk_blk_ws",

303 (
pblk_lše_ws
), 0, 0, 
NULL
);

304 ià(!
pblk_ÿches
.
ws
)

305  -
ENOMEM
;

307 
pblk_ÿches
.
»c
 = 
	`kmem_ÿche_ü—‹
("pblk_rec",

308 (
pblk_»c_ùx
), 0, 0, 
NULL
);

309 ià(!
pblk_ÿches
.
»c
)

310 
çž_de¡roy_ws
;

312 
pblk_ÿches
.
g_rq
 = 
	`kmem_ÿche_ü—‹
("pblk_g_rq", 
pblk_g_rq_size
,

313 0, 0, 
NULL
);

314 ià(!
pblk_ÿches
.
g_rq
)

315 
çž_de¡roy_»c
;

317 
pblk_ÿches
.
w_rq
 = 
	`kmem_ÿche_ü—‹
("pblk_w_rq", 
pblk_w_rq_size
,

318 0, 0, 
NULL
);

319 ià(!
pblk_ÿches
.
w_rq
)

320 
çž_de¡roy_g_rq
;

324 
çž_de¡roy_g_rq
:

325 
	`kmem_ÿche_de¡roy
(
pblk_ÿches
.
g_rq
);

326 
çž_de¡roy_»c
:

327 
	`kmem_ÿche_de¡roy
(
pblk_ÿches
.
»c
);

328 
çž_de¡roy_ws
:

329 
	`kmem_ÿche_de¡roy
(
pblk_ÿches
.
ws
);

331  -
ENOMEM
;

332 
	}
}

334 
	$pblk_g‘_glob®_ÿches
()

336 
»t
 = 0;

338 
	`mu‹x_lock
(&
pblk_ÿches
.
mu‹x
);

340 ià(
	`k»f_g‘_uÆess_z”o
(&
pblk_ÿches
.
k»f
))

341 
out
;

343 
»t
 = 
	`pblk_ü—‹_glob®_ÿches
();

344 ià(!
»t
)

345 
	`k»f_š™
(&
pblk_ÿches
.
k»f
);

347 
out
:

348 
	`mu‹x_uÆock
(&
pblk_ÿches
.
mu‹x
);

349  
»t
;

350 
	}
}

352 
	$pblk_de¡roy_glob®_ÿches
(
k»f
 *
»f
)

354 
pblk_glob®_ÿches
 *
c
;

356 
c
 = 
	`cÚš”_of
(
»f
, 
pblk_glob®_ÿches
, 
k»f
);

358 
	`kmem_ÿche_de¡roy
(
c
->
ws
);

359 
	`kmem_ÿche_de¡roy
(
c
->
»c
);

360 
	`kmem_ÿche_de¡roy
(
c
->
g_rq
);

361 
	`kmem_ÿche_de¡roy
(
c
->
w_rq
);

362 
	}
}

364 
	$pblk_put_glob®_ÿches
()

366 
	`mu‹x_lock
(&
pblk_ÿches
.
mu‹x
);

367 
	`k»f_put
(&
pblk_ÿches
.
k»f
, 
pblk_de¡roy_glob®_ÿches
);

368 
	`mu‹x_uÆock
(&
pblk_ÿches
.
mu‹x
);

369 
	}
}

371 
	$pblk_cÜe_š™
(
pblk
 *pblk)

373 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

374 
nvm_geo
 *
geo
 = &
dev
->geo;

375 
»t
, 
max_wr™e_µas
;

377 
	`©omic64_£t
(&
pblk
->
u£r_wa
, 0);

378 
	`©omic64_£t
(&
pblk
->
·d_wa
, 0);

379 
	`©omic64_£t
(&
pblk
->
gc_wa
, 0);

380 
pblk
->
u£r_r¡_wa
 = 0;

381 
pblk
->
·d_r¡_wa
 = 0;

382 
pblk
->
gc_r¡_wa
 = 0;

384 
	`©omic64_£t
(&
pblk
->
Ä_æush
, 0);

385 
pblk
->
Ä_æush_r¡
 = 0;

387 
pblk
->
mš_wr™e_pgs
 = 
geo
->
ws_Ýt
;

388 
pblk
->
mš_wr™e_pgs_d©a
 =…blk->
mš_wr™e_pgs
;

389 
max_wr™e_µas
 = 
pblk
->
mš_wr™e_pgs
 * 
geo
->
®l_luns
;

390 
pblk
->
max_wr™e_pgs
 = 
	`mš_t
(, 
max_wr™e_µas
, 
NVM_MAX_VLBA
);

391 
pblk
->
max_wr™e_pgs
 = 
	`mš_t
(,…blk->max_write_pgs,

392 
	`queue_max_hw_£ùÜs
(
dev
->
q
è/ (
geo
->
c£cs
 >> 
SECTOR_SHIFT
));

393 
	`pblk_£t_£c_³r_wr™e
(
pblk
,…blk->
mš_wr™e_pgs
);

395 
pblk
->
oob_m‘a_size
 = 
geo
->
sos
;

396 ià(!
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
)) {

404 ià(
pblk
->
mš_wr™e_pgs


405 * (
pblk_£c_m‘a
è> 
PAGE_SIZE
) {

414 
	`pblk_”r
(
pblk
, "Not supported min write size\n");

415  -
EINVAL
;

423 
pblk
->
max_wr™e_pgs
 =…blk->
mš_wr™e_pgs
;

424 
pblk
->
mš_wr™e_pgs_d©a
 =…blk->
mš_wr™e_pgs
 - 1;

427 
pblk
->
·d_di¡
 = 
	`kÿÎoc
Õblk->
mš_wr™e_pgs
 - 1, (
©omic64_t
),

428 
GFP_KERNEL
);

429 ià(!
pblk
->
·d_di¡
)

430  -
ENOMEM
;

432 ià(
	`pblk_g‘_glob®_ÿches
())

433 
çž_ä“_·d_di¡
;

436 
»t
 = 
	`mempoÞ_š™_·ge_poÞ
(&
pblk
->
·ge_bio_poÞ
, 
NVM_MAX_VLBA
, 0);

437 ià(
»t
)

438 
ä“_glob®_ÿches
;

440 
»t
 = 
	`mempoÞ_š™_¦ab_poÞ
(&
pblk
->
g’_ws_poÞ
, 
PBLK_GEN_WS_POOL_SIZE
,

441 
pblk_ÿches
.
ws
);

442 ià(
»t
)

443 
ä“_·ge_bio_poÞ
;

445 
»t
 = 
	`mempoÞ_š™_¦ab_poÞ
(&
pblk
->
»c_poÞ
, 
geo
->
®l_luns
,

446 
pblk_ÿches
.
»c
);

447 ià(
»t
)

448 
ä“_g’_ws_poÞ
;

450 
»t
 = 
	`mempoÞ_š™_¦ab_poÞ
(&
pblk
->
r_rq_poÞ
, 
geo
->
®l_luns
,

451 
pblk_ÿches
.
g_rq
);

452 ià(
»t
)

453 
ä“_»c_poÞ
;

455 
»t
 = 
	`mempoÞ_š™_¦ab_poÞ
(&
pblk
->
e_rq_poÞ
, 
geo
->
®l_luns
,

456 
pblk_ÿches
.
g_rq
);

457 ià(
»t
)

458 
ä“_r_rq_poÞ
;

460 
»t
 = 
	`mempoÞ_š™_¦ab_poÞ
(&
pblk
->
w_rq_poÞ
, 
geo
->
®l_luns
,

461 
pblk_ÿches
.
w_rq
);

462 ià(
»t
)

463 
ä“_e_rq_poÞ
;

465 
pblk
->
þo£_wq
 = 
	`®loc_wÜkqueue
("pblk-close-wq",

466 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 
PBLK_NR_CLOSE_JOBS
);

467 ià(!
pblk
->
þo£_wq
)

468 
ä“_w_rq_poÞ
;

470 
pblk
->
bb_wq
 = 
	`®loc_wÜkqueue
("pblk-bb-wq",

471 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 0);

472 ià(!
pblk
->
bb_wq
)

473 
ä“_þo£_wq
;

475 
pblk
->
r_’d_wq
 = 
	`®loc_wÜkqueue
("pblk-read-end-wq",

476 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 0);

477 ià(!
pblk
->
r_’d_wq
)

478 
ä“_bb_wq
;

480 ià(
	`pblk_£t_addrf
(
pblk
))

481 
ä“_r_’d_wq
;

483 
	`INIT_LIST_HEAD
(&
pblk
->
com¶_li¡
);

484 
	`INIT_LIST_HEAD
(&
pblk
->
»subm™_li¡
);

488 
ä“_r_’d_wq
:

489 
	`de¡roy_wÜkqueue
(
pblk
->
r_’d_wq
);

490 
ä“_bb_wq
:

491 
	`de¡roy_wÜkqueue
(
pblk
->
bb_wq
);

492 
ä“_þo£_wq
:

493 
	`de¡roy_wÜkqueue
(
pblk
->
þo£_wq
);

494 
ä“_w_rq_poÞ
:

495 
	`mempoÞ_ex™
(&
pblk
->
w_rq_poÞ
);

496 
ä“_e_rq_poÞ
:

497 
	`mempoÞ_ex™
(&
pblk
->
e_rq_poÞ
);

498 
ä“_r_rq_poÞ
:

499 
	`mempoÞ_ex™
(&
pblk
->
r_rq_poÞ
);

500 
ä“_»c_poÞ
:

501 
	`mempoÞ_ex™
(&
pblk
->
»c_poÞ
);

502 
ä“_g’_ws_poÞ
:

503 
	`mempoÞ_ex™
(&
pblk
->
g’_ws_poÞ
);

504 
ä“_·ge_bio_poÞ
:

505 
	`mempoÞ_ex™
(&
pblk
->
·ge_bio_poÞ
);

506 
ä“_glob®_ÿches
:

507 
	`pblk_put_glob®_ÿches
();

508 
çž_ä“_·d_di¡
:

509 
	`kä“
(
pblk
->
·d_di¡
);

510  -
ENOMEM
;

511 
	}
}

513 
	$pblk_cÜe_ä“
(
pblk
 *pblk)

515 ià(
pblk
->
þo£_wq
)

516 
	`de¡roy_wÜkqueue
(
pblk
->
þo£_wq
);

518 ià(
pblk
->
r_’d_wq
)

519 
	`de¡roy_wÜkqueue
(
pblk
->
r_’d_wq
);

521 ià(
pblk
->
bb_wq
)

522 
	`de¡roy_wÜkqueue
(
pblk
->
bb_wq
);

524 
	`mempoÞ_ex™
(&
pblk
->
·ge_bio_poÞ
);

525 
	`mempoÞ_ex™
(&
pblk
->
g’_ws_poÞ
);

526 
	`mempoÞ_ex™
(&
pblk
->
»c_poÞ
);

527 
	`mempoÞ_ex™
(&
pblk
->
r_rq_poÞ
);

528 
	`mempoÞ_ex™
(&
pblk
->
e_rq_poÞ
);

529 
	`mempoÞ_ex™
(&
pblk
->
w_rq_poÞ
);

531 
	`pblk_put_glob®_ÿches
();

532 
	`kä“
(
pblk
->
·d_di¡
);

533 
	}
}

535 
	$pblk_lše_mg_ä“
(
pblk
 *pblk)

537 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

538 
i
;

540 
	`kä“
(
l_mg
->
bb_‹m¶©e
);

541 
	`kä“
(
l_mg
->
bb_aux
);

542 
	`kä“
(
l_mg
->
vsc_li¡
);

544 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

545 
	`kä“
(
l_mg
->
¦še_m‘a
[
i
]);

546 
	`pblk_mä“
(
l_mg
->
–še_m‘a
[
i
]->
buf
,†_mg->
em‘a_®loc_ty³
);

547 
	`kä“
(
l_mg
->
–še_m‘a
[
i
]);

550 
	`mempoÞ_de¡roy
(
l_mg
->
b™m­_poÞ
);

551 
	`kmem_ÿche_de¡roy
(
l_mg
->
b™m­_ÿche
);

552 
	}
}

554 
	$pblk_lše_m‘a_ä“
(
pblk_lše_mgmt
 *
l_mg
,

555 
pblk_lše
 *
lše
)

557 
pblk_w_”r_gc
 *
w_”r_gc
 = 
lše
->w_err_gc;

559 
	`kä“
(
lše
->
blk_b™m­
);

560 
	`kä“
(
lše
->
”a£_b™m­
);

561 
	`kä“
(
lše
->
chks
);

563 
	`pblk_mä“
(
w_”r_gc
->
lba_li¡
, 
l_mg
->
em‘a_®loc_ty³
);

564 
	`kä“
(
w_”r_gc
);

565 
	}
}

567 
	$pblk_lšes_ä“
(
pblk
 *pblk)

569 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

570 
pblk_lše
 *
lše
;

571 
i
;

573 
i
 = 0; i < 
l_mg
->
Ä_lšes
; i++) {

574 
lše
 = &
pblk
->
lšes
[
i
];

576 
	`pblk_lše_ä“
(
lše
);

577 
	`pblk_lše_m‘a_ä“
(
l_mg
, 
lše
);

580 
	`pblk_lše_mg_ä“
(
pblk
);

582 
	`kä“
(
pblk
->
luns
);

583 
	`kä“
(
pblk
->
lšes
);

584 
	}
}

586 
	$pblk_luns_š™
(
pblk
 *pblk)

588 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

589 
nvm_geo
 *
geo
 = &
dev
->geo;

590 
pblk_lun
 *
¾un
;

591 
i
;

594 ià(
geo
->
num_lun
 < 0) {

595 
	`pblk_”r
(
pblk
, "unbalanced LUN config.\n");

596  -
EINVAL
;

599 
pblk
->
luns
 = 
	`kÿÎoc
(
geo
->
®l_luns
, (
pblk_lun
),

600 
GFP_KERNEL
);

601 ià(!
pblk
->
luns
)

602  -
ENOMEM
;

604 
i
 = 0; i < 
geo
->
®l_luns
; i++) {

606 
ch
 = 
i
 % 
geo
->
num_ch
;

607 
lun_¿w
 = 
i
 / 
geo
->
num_ch
;

608 
lunid
 = 
lun_¿w
 + 
ch
 * 
geo
->
num_lun
;

610 
¾un
 = &
pblk
->
luns
[
i
];

611 
¾un
->
bµa
 = 
dev
->
luns
[
lunid
];

613 
	`£ma_š™
(&
¾un
->
wr_£m
, 1);

617 
	}
}

620 
	$ÿlc_em‘a_Ën
(
pblk
 *pblk)

622 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

623 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

624 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

625 
nvm_geo
 *
geo
 = &
dev
->geo;

628 
lm
->
em‘a_£c
[1] = 
	`DIV_ROUND_UP
(

629 (
lše_em‘a
è+ 
lm
->
blk_b™m­_Ën
 +

630 (
wa_couÁ”s
), 
geo
->
c£cs
);

631 
lm
->
em‘a_Ën
[1] =†m->
em‘a_£c
[1] * 
geo
->
c£cs
;

634 
lm
->
d£c_³r_lše
 =†m->
£c_³r_lše
 -†m->
em‘a_£c
[0];

635 
lm
->
em‘a_£c
[2] = 
	`DIV_ROUND_UP
Öm->
d£c_³r_lše
 * (
u64
),

636 
geo
->
c£cs
);

637 
lm
->
em‘a_Ën
[2] =†m->
em‘a_£c
[2] * 
geo
->
c£cs
;

639 
lm
->
em‘a_£c
[3] = 
	`DIV_ROUND_UP
(
l_mg
->
Ä_lšes
 * (
u32
),

640 
geo
->
c£cs
);

641 
lm
->
em‘a_Ën
[3] =†m->
em‘a_£c
[3] * 
geo
->
c£cs
;

643 
lm
->
vsc_li¡_Ën
 = 
l_mg
->
Ä_lšes
 * (
u32
);

645  (
lm
->
em‘a_Ën
[1] +†m->emeta_len[2] +†m->emeta_len[3]);

646 
	}
}

648 
	$pblk_£t_´ovisiÚ
(
pblk
 *pblk, 
Ä_ä“_chks
)

650 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

651 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

652 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

653 
nvm_geo
 *
geo
 = &
dev
->geo;

654 
£ùÜ_t
 
´ovisiÚed
;

655 
£c_m‘a
, 
blk_m‘a
, 
þba
;

656 
mšimum
;

658 ià(
geo
->
Ý
 =ð
NVM_TARGET_DEFAULT_OP
)

659 
pblk
->
Ý
 = 
PBLK_DEFAULT_OP
;

661 
pblk
->
Ý
 = 
geo
->op;

663 
mšimum
 = 
	`pblk_g‘_mš_chks
(
pblk
);

664 
´ovisiÚed
 = 
Ä_ä“_chks
;

665 
´ovisiÚed
 *ð(100 - 
pblk
->
Ý
);

666 
	`£ùÜ_div
(
´ovisiÚed
, 100);

668 ià((
Ä_ä“_chks
 - 
´ovisiÚed
è< 
mšimum
) {

669 ià(
geo
->
Ý
 !ð
NVM_TARGET_DEFAULT_OP
) {

670 
	`pblk_”r
(
pblk
, "OPoo smallo create‡ sane instance\n");

671  -
EINTR
;

678 
´ovisiÚed
 = 
Ä_ä“_chks
 - 
mšimum
;

679 
pblk
->
Ý
 = (100 * 
mšimum
è/ 
Ä_ä“_chks
;

680 
	`pblk_šfo
(
pblk
, "Default OP insufficient,‡djusting OPo %d\n",

681 
pblk
->
Ý
);

684 
pblk
->
Ý_blks
 = 
Ä_ä“_chks
 - 
´ovisiÚed
;

689 
pblk
->
¾
.
tÙ®_blocks
 = 
Ä_ä“_chks
;

692 
£c_m‘a
 = (
lm
->
sm‘a_£c
 +†m->
em‘a_£c
[0]è* 
l_mg
->
Ä_ä“_lšes
;

693 
blk_m‘a
 = 
	`DIV_ROUND_UP
(
£c_m‘a
, 
geo
->
þba
);

695 
þba
 = (
geo
->þb¨/ 
pblk
->
mš_wr™e_pgs
è*…blk->
mš_wr™e_pgs_d©a
;

696 
pblk
->
ÿ·c™y
 = (
´ovisiÚed
 - 
blk_m‘a
è* 
þba
;

698 
	`©omic_£t
(&
pblk
->
¾
.
ä“_blocks
, 
Ä_ä“_chks
);

699 
	`©omic_£t
(&
pblk
->
¾
.
ä“_u£r_blocks
, 
Ä_ä“_chks
);

702 
	}
}

704 
	$pblk_£tup_lše_m‘a_chk
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

705 
nvm_chk_m‘a
 *
m‘a
)

707 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

708 
nvm_geo
 *
geo
 = &
dev
->geo;

709 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

710 
i
, 
Ä_bad_chks
 = 0;

712 
i
 = 0; i < 
lm
->
blk_³r_lše
; i++) {

713 
pblk_lun
 *
¾un
 = &
pblk
->
luns
[
i
];

714 
nvm_chk_m‘a
 *
chunk
;

715 
nvm_chk_m‘a
 *
chunk_m‘a
;

716 
µa_addr
 
µa
;

717 
pos
;

719 
µa
 = 
¾un
->
bµa
;

720 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

721 
chunk
 = &
lše
->
chks
[
pos
];

723 
µa
.
m
.
chk
 = 
lše
->
id
;

724 
chunk_m‘a
 = 
	`pblk_chunk_g‘_off
(
pblk
, 
m‘a
, 
µa
);

726 
chunk
->
¡©e
 = 
chunk_m‘a
->state;

727 
chunk
->
ty³
 = 
chunk_m‘a
->type;

728 
chunk
->
wi
 = 
chunk_m‘a
->wi;

729 
chunk
->
¦ba
 = 
chunk_m‘a
->slba;

730 
chunk
->
úlb
 = 
chunk_m‘a
->cnlb;

731 
chunk
->
wp
 = 
chunk_m‘a
->wp;

733 
	`Œaû_pblk_chunk_¡©e
(
	`pblk_disk_Çme
(
pblk
), &
µa
,

734 
chunk
->
¡©e
);

736 ià(
chunk
->
ty³
 & 
NVM_CHK_TP_SZ_SPEC
) {

737 
	`WARN_ONCE
(1, "pblk: custom-sized chunks unsupported\n");

741 ià(!(
chunk
->
¡©e
 & 
NVM_CHK_ST_OFFLINE
))

744 
	`£t_b™
(
pos
, 
lše
->
blk_b™m­
);

745 
Ä_bad_chks
++;

748  
Ä_bad_chks
;

749 
	}
}

751 
	$pblk_£tup_lše_m‘a
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

752 *
chunk_m‘a
, 
lše_id
)

754 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

755 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

756 
Ä_bad_chks
, 
chk_š_lše
;

758 
lše
->
pblk
 =…blk;

759 
lše
->
id
 = 
lše_id
;

760 
lše
->
ty³
 = 
PBLK_LINETYPE_FREE
;

761 
lše
->
¡©e
 = 
PBLK_LINESTATE_NEW
;

762 
lše
->
gc_group
 = 
PBLK_LINEGC_NONE
;

763 
lše
->
vsc
 = &
l_mg
->
vsc_li¡
[
lše_id
];

764 
	`¥š_lock_š™
(&
lše
->
lock
);

766 
Ä_bad_chks
 = 
	`pblk_£tup_lše_m‘a_chk
(
pblk
, 
lše
, 
chunk_m‘a
);

768 
chk_š_lše
 = 
lm
->
blk_³r_lše
 - 
Ä_bad_chks
;

769 ià(
Ä_bad_chks
 < 0 ||‚r_bad_chk > 
lm
->
blk_³r_lše
 ||

770 
chk_š_lše
 < 
lm
->
mš_blk_lše
) {

771 
lše
->
¡©e
 = 
PBLK_LINESTATE_BAD
;

772 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
bad_li¡
);

776 
	`©omic_£t
(&
lše
->
blk_š_lše
, 
chk_š_lše
);

777 
	`li¡_add_ž
(&
lše
->
li¡
, &
l_mg
->
ä“_li¡
);

778 
l_mg
->
Ä_ä“_lšes
++;

780  
chk_š_lše
;

781 
	}
}

783 
	$pblk_®loc_lše_m‘a
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

785 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

787 
lše
->
blk_b™m­
 = 
	`kz®loc
(
lm
->
blk_b™m­_Ën
, 
GFP_KERNEL
);

788 ià(!
lše
->
blk_b™m­
)

789  -
ENOMEM
;

791 
lše
->
”a£_b™m­
 = 
	`kz®loc
(
lm
->
blk_b™m­_Ën
, 
GFP_KERNEL
);

792 ià(!
lše
->
”a£_b™m­
)

793 
ä“_blk_b™m­
;

796 
lše
->
chks
 = 
	`km®loc_¬¿y
(
lm
->
blk_³r_lše
,

797 (
nvm_chk_m‘a
), 
GFP_KERNEL
);

798 ià(!
lše
->
chks
)

799 
ä“_”a£_b™m­
;

801 
lše
->
w_”r_gc
 = 
	`kz®loc
((
pblk_w_”r_gc
), 
GFP_KERNEL
);

802 ià(!
lše
->
w_”r_gc
)

803 
ä“_chks
;

807 
ä“_chks
:

808 
	`kä“
(
lše
->
chks
);

809 
ä“_”a£_b™m­
:

810 
	`kä“
(
lše
->
”a£_b™m­
);

811 
ä“_blk_b™m­
:

812 
	`kä“
(
lše
->
blk_b™m­
);

813  -
ENOMEM
;

814 
	}
}

816 
	$pblk_lše_mg_š™
(
pblk
 *pblk)

818 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

819 
nvm_geo
 *
geo
 = &
dev
->geo;

820 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

821 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

822 
i
, 
bb_di¡ªû
;

824 
l_mg
->
Ä_lšes
 = 
geo
->
num_chk
;

825 
l_mg
->
log_lše
 =†_mg->
d©a_lše
 = 
NULL
;

826 
l_mg
->
l_£q_Ä
 =†_mg->
d_£q_Ä
 = 0;

827 
l_mg
->
Ä_ä“_lšes
 = 0;

828 
	`b™m­_z”o
(&
l_mg
->
m‘a_b™m­
, 
PBLK_DATA_LINES
);

830 
	`INIT_LIST_HEAD
(&
l_mg
->
ä“_li¡
);

831 
	`INIT_LIST_HEAD
(&
l_mg
->
cÜru±_li¡
);

832 
	`INIT_LIST_HEAD
(&
l_mg
->
bad_li¡
);

833 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_fuÎ_li¡
);

834 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_high_li¡
);

835 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_mid_li¡
);

836 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_low_li¡
);

837 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_em±y_li¡
);

838 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_w”r_li¡
);

840 
	`INIT_LIST_HEAD
(&
l_mg
->
em‘a_li¡
);

842 
l_mg
->
gc_li¡s
[0] = &l_mg->
gc_w”r_li¡
;

843 
l_mg
->
gc_li¡s
[1] = &l_mg->
gc_high_li¡
;

844 
l_mg
->
gc_li¡s
[2] = &l_mg->
gc_mid_li¡
;

845 
l_mg
->
gc_li¡s
[3] = &l_mg->
gc_low_li¡
;

847 
	`¥š_lock_š™
(&
l_mg
->
ä“_lock
);

848 
	`¥š_lock_š™
(&
l_mg
->
þo£_lock
);

849 
	`¥š_lock_š™
(&
l_mg
->
gc_lock
);

851 
l_mg
->
vsc_li¡
 = 
	`kÿÎoc
Ö_mg->
Ä_lšes
, (
__Ë32
), 
GFP_KERNEL
);

852 ià(!
l_mg
->
vsc_li¡
)

853 
çž
;

855 
l_mg
->
bb_‹m¶©e
 = 
	`kz®loc
(
lm
->
£c_b™m­_Ën
, 
GFP_KERNEL
);

856 ià(!
l_mg
->
bb_‹m¶©e
)

857 
çž_ä“_vsc_li¡
;

859 
l_mg
->
bb_aux
 = 
	`kz®loc
(
lm
->
£c_b™m­_Ën
, 
GFP_KERNEL
);

860 ià(!
l_mg
->
bb_aux
)

861 
çž_ä“_bb_‹m¶©e
;

866 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

867 
l_mg
->
¦še_m‘a
[
i
] = 
	`km®loc
(
lm
->
sm‘a_Ën
, 
GFP_KERNEL
);

868 ià(!
l_mg
->
¦še_m‘a
[
i
])

869 
çž_ä“_sm‘a
;

872 
l_mg
->
b™m­_ÿche
 = 
	`kmem_ÿche_ü—‹
("pblk_lm_bitmap",

873 
lm
->
£c_b™m­_Ën
, 0, 0, 
NULL
);

874 ià(!
l_mg
->
b™m­_ÿche
)

875 
çž_ä“_sm‘a
;

878 
l_mg
->
b™m­_poÞ
 = 
	`mempoÞ_ü—‹_¦ab_poÞ
(
PBLK_DATA_LINES
 * 2,

879 
l_mg
->
b™m­_ÿche
);

880 ià(!
l_mg
->
b™m­_poÞ
)

881 
çž_de¡roy_b™m­_ÿche
;

886 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

887 
pblk_em‘a
 *
em‘a
;

889 
em‘a
 = 
	`km®loc
((
pblk_em‘a
), 
GFP_KERNEL
);

890 ià(!
em‘a
)

891 
çž_ä“_em‘a
;

893 ià(
lm
->
em‘a_Ën
[0] > 
KMALLOC_MAX_CACHE_SIZE
) {

894 
l_mg
->
em‘a_®loc_ty³
 = 
PBLK_VMALLOC_META
;

896 
em‘a
->
buf
 = 
	`vm®loc
(
lm
->
em‘a_Ën
[0]);

897 ià(!
em‘a
->
buf
) {

898 
	`kä“
(
em‘a
);

899 
çž_ä“_em‘a
;

902 
em‘a
->
Ä_’Œ›s
 = 
lm
->
em‘a_£c
[0];

903 
l_mg
->
–še_m‘a
[
i
] = 
em‘a
;

905 
l_mg
->
em‘a_®loc_ty³
 = 
PBLK_KMALLOC_META
;

907 
em‘a
->
buf
 = 
	`km®loc
(
lm
->
em‘a_Ën
[0], 
GFP_KERNEL
);

908 ià(!
em‘a
->
buf
) {

909 
	`kä“
(
em‘a
);

910 
çž_ä“_em‘a
;

913 
em‘a
->
Ä_’Œ›s
 = 
lm
->
em‘a_£c
[0];

914 
l_mg
->
–še_m‘a
[
i
] = 
em‘a
;

918 
i
 = 0; i < 
l_mg
->
Ä_lšes
; i++)

919 
l_mg
->
vsc_li¡
[
i
] = 
	`ýu_to_Ë32
(
EMPTY_ENTRY
);

921 
bb_di¡ªû
 = (
geo
->
®l_luns
è* geo->
ws_Ýt
;

922 
i
 = 0; i < 
lm
->
£c_³r_lše
; i +ð
bb_di¡ªû
)

923 
	`b™m­_£t
(
l_mg
->
bb_‹m¶©e
, 
i
, 
geo
->
ws_Ýt
);

927 
çž_ä“_em‘a
:

928 --
i
 >= 0) {

929 ià(
l_mg
->
em‘a_®loc_ty³
 =ð
PBLK_VMALLOC_META
)

930 
	`vä“
(
l_mg
->
–še_m‘a
[
i
]->
buf
);

932 
	`kä“
(
l_mg
->
–še_m‘a
[
i
]->
buf
);

933 
	`kä“
(
l_mg
->
–še_m‘a
[
i
]);

936 
	`mempoÞ_de¡roy
(
l_mg
->
b™m­_poÞ
);

937 
çž_de¡roy_b™m­_ÿche
:

938 
	`kmem_ÿche_de¡roy
(
l_mg
->
b™m­_ÿche
);

939 
çž_ä“_sm‘a
:

940 
i
 = 0; i < 
PBLK_DATA_LINES
; i++)

941 
	`kä“
(
l_mg
->
¦še_m‘a
[
i
]);

942 
	`kä“
(
l_mg
->
bb_aux
);

943 
çž_ä“_bb_‹m¶©e
:

944 
	`kä“
(
l_mg
->
bb_‹m¶©e
);

945 
çž_ä“_vsc_li¡
:

946 
	`kä“
(
l_mg
->
vsc_li¡
);

947 
çž
:

948  -
ENOMEM
;

949 
	}
}

951 
	$pblk_lše_m‘a_š™
(
pblk
 *pblk)

953 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

954 
nvm_geo
 *
geo
 = &
dev
->geo;

955 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

956 
sm‘a_Ën
, 
em‘a_Ën
;

957 
i
;

959 
lm
->
£c_³r_lše
 = 
geo
->
þba
 * geo->
®l_luns
;

960 
lm
->
blk_³r_lše
 = 
geo
->
®l_luns
;

961 
lm
->
blk_b™m­_Ën
 = 
	`BITS_TO_LONGS
(
geo
->
®l_luns
) * ();

962 
lm
->
£c_b™m­_Ën
 = 
	`BITS_TO_LONGS
Öm->
£c_³r_lše
) * ();

963 
lm
->
lun_b™m­_Ën
 = 
	`BITS_TO_LONGS
(
geo
->
®l_luns
) * ();

964 
lm
->
mid_thrs
 =†m->
£c_³r_lše
 / 2;

965 
lm
->
high_thrs
 =†m->
£c_³r_lše
 / 4;

966 
lm
->
m‘a_di¡ªû
 = (
geo
->
®l_luns
 / 2è* 
pblk
->
mš_wr™e_pgs
;

971 
i
 = 1;

972 
add_sm‘a_·ge
:

973 
lm
->
sm‘a_£c
 = 
i
 * 
geo
->
ws_Ýt
;

974 
lm
->
sm‘a_Ën
 =†m->
sm‘a_£c
 * 
geo
->
c£cs
;

976 
sm‘a_Ën
 = (
lše_sm‘a
è+ 
lm
->
lun_b™m­_Ën
;

977 ià(
sm‘a_Ën
 > 
lm
->smeta_len) {

978 
i
++;

979 
add_sm‘a_·ge
;

985 
i
 = 1;

986 
add_em‘a_·ge
:

987 
lm
->
em‘a_£c
[0] = 
i
 * 
geo
->
ws_Ýt
;

988 
lm
->
em‘a_Ën
[0] =†m->
em‘a_£c
[0] * 
geo
->
c£cs
;

990 
em‘a_Ën
 = 
	`ÿlc_em‘a_Ën
(
pblk
);

991 ià(
em‘a_Ën
 > 
lm
->emeta_len[0]) {

992 
i
++;

993 
add_em‘a_·ge
;

996 
lm
->
em‘a_bb
 = 
geo
->
®l_luns
 > 
i
 ? geo->all_luns - i : 0;

998 
lm
->
mš_blk_lše
 = 1;

999 ià(
geo
->
®l_luns
 > 1)

1000 
lm
->
mš_blk_lše
 +ð
	`DIV_ROUND_UP
Öm->
sm‘a_£c
 +

1001 
lm
->
em‘a_£c
[0], 
geo
->
þba
);

1003 ià(
lm
->
mš_blk_lše
 >†m->
blk_³r_lše
) {

1004 
	`pblk_”r
(
pblk
, "config.‚ot supported. Min. LUN in†ine:%d\n",

1005 
lm
->
blk_³r_lše
);

1006  -
EINVAL
;

1010 
	}
}

1012 
	$pblk_lšes_š™
(
pblk
 *pblk)

1014 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1015 
pblk_lše
 *
lše
;

1016 *
chunk_m‘a
;

1017 
Ä_ä“_chks
 = 0;

1018 
i
, 
»t
;

1020 
»t
 = 
	`pblk_lše_m‘a_š™
(
pblk
);

1021 ià(
»t
)

1022  
»t
;

1024 
»t
 = 
	`pblk_lše_mg_š™
(
pblk
);

1025 ià(
»t
)

1026  
»t
;

1028 
»t
 = 
	`pblk_luns_š™
(
pblk
);

1029 ià(
»t
)

1030 
çž_ä“_m‘a
;

1032 
chunk_m‘a
 = 
	`pblk_g‘_chunk_m‘a
(
pblk
);

1033 ià(
	`IS_ERR
(
chunk_m‘a
)) {

1034 
»t
 = 
	`PTR_ERR
(
chunk_m‘a
);

1035 
çž_ä“_luns
;

1038 
pblk
->
lšes
 = 
	`kÿÎoc
(
l_mg
->
Ä_lšes
, (
pblk_lše
),

1039 
GFP_KERNEL
);

1040 ià(!
pblk
->
lšes
) {

1041 
»t
 = -
ENOMEM
;

1042 
çž_ä“_chunk_m‘a
;

1045 
i
 = 0; i < 
l_mg
->
Ä_lšes
; i++) {

1046 
lše
 = &
pblk
->
lšes
[
i
];

1048 
»t
 = 
	`pblk_®loc_lše_m‘a
(
pblk
, 
lše
);

1049 ià(
»t
)

1050 
çž_ä“_lšes
;

1052 
Ä_ä“_chks
 +ð
	`pblk_£tup_lše_m‘a
(
pblk
, 
lše
, 
chunk_m‘a
, 
i
);

1054 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

1055 
lše
->
¡©e
);

1058 ià(!
Ä_ä“_chks
) {

1059 
	`pblk_”r
(
pblk
, "too many bad blocks…revent for sane instance\n");

1060 
»t
 = -
EINTR
;

1061 
çž_ä“_lšes
;

1064 
»t
 = 
	`pblk_£t_´ovisiÚ
(
pblk
, 
Ä_ä“_chks
);

1065 ià(
»t
)

1066 
çž_ä“_lšes
;

1068 
	`vä“
(
chunk_m‘a
);

1071 
çž_ä“_lšes
:

1072 --
i
 >= 0)

1073 
	`pblk_lše_m‘a_ä“
(
l_mg
, &
pblk
->
lšes
[
i
]);

1074 
	`kä“
(
pblk
->
lšes
);

1075 
çž_ä“_chunk_m‘a
:

1076 
	`vä“
(
chunk_m‘a
);

1077 
çž_ä“_luns
:

1078 
	`kä“
(
pblk
->
luns
);

1079 
çž_ä“_m‘a
:

1080 
	`pblk_lše_mg_ä“
(
pblk
);

1082  
»t
;

1083 
	}
}

1085 
	$pblk_wr™”_š™
(
pblk
 *pblk)

1087 
pblk
->
wr™”_ts
 = 
	`kth»ad_ü—‹
(
pblk_wr™e_ts
,…blk, "pblk-writer-t");

1088 ià(
	`IS_ERR
(
pblk
->
wr™”_ts
)) {

1089 
”r
 = 
	`PTR_ERR
(
pblk
->
wr™”_ts
);

1091 ià(
”r
 !ð-
EINTR
)

1092 
	`pblk_”r
(
pblk
, "could‚ot‡llocate writer kthread (%d)\n",

1093 
”r
);

1094  
”r
;

1097 
	`tim”_£tup
(&
pblk
->
wtim”
, 
pblk_wr™e_tim”_â
, 0);

1098 
	`mod_tim”
(&
pblk
->
wtim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(100));

1101 
	}
}

1103 
	$pblk_wr™”_¡Ý
(
pblk
 *pblk)

1108 
	`WARN
(
	`pblk_rb_»ad_couÁ
(&
pblk
->
rwb
),

1111 
	`WARN
(
	`pblk_rb_sync_couÁ
(&
pblk
->
rwb
),

1114 
	`d–_tim”_sync
(&
pblk
->
wtim”
);

1115 ià(
pblk
->
wr™”_ts
)

1116 
	`kth»ad_¡Ý
(
pblk
->
wr™”_ts
);

1117 
	}
}

1119 
	$pblk_ä“
(
pblk
 *pblk)

1121 
	`pblk_lšes_ä“
(
pblk
);

1122 
	`pblk_l2p_ä“
(
pblk
);

1123 
	`pblk_rwb_ä“
(
pblk
);

1124 
	`pblk_cÜe_ä“
(
pblk
);

1126 
	`kä“
(
pblk
);

1127 
	}
}

1129 
	$pblk_‹¬_down
(
pblk
 *pblk, 
boÞ
 
g¿ûful
)

1131 ià(
g¿ûful
)

1132 
	`__pblk_p–še_æush
(
pblk
);

1133 
	`__pblk_p–še_¡Ý
(
pblk
);

1134 
	`pblk_wr™”_¡Ý
(
pblk
);

1135 
	`pblk_rb_sync_l2p
(&
pblk
->
rwb
);

1136 
	`pblk_¾_ä“
(&
pblk
->
¾
);

1138 
	`pblk_debug
(
pblk
, "cÚsi¡’ˆ‹¬ dowÀ(g¿ûful:%d)\n", 
g¿ûful
);

1139 
	}
}

1141 
	$pblk_ex™
(*
´iv©e
, 
boÞ
 
g¿ûful
)

1143 
pblk
 *pblk = 
´iv©e
;

1145 
	`pblk_gc_ex™
(
pblk
, 
g¿ûful
);

1146 
	`pblk_‹¬_down
(
pblk
, 
g¿ûful
);

1148 #ifdeà
CONFIG_NVM_PBLK_DEBUG


1149 
	`pblk_šfo
(
pblk
, "ex™: L2P CRC: %x\n", 
	`pblk_l2p_üc
(pblk));

1152 
	`pblk_ä“
(
pblk
);

1153 
	}
}

1155 
£ùÜ_t
 
	$pblk_ÿ·c™y
(*
´iv©e
)

1157 
pblk
 *pblk = 
´iv©e
;

1159  
pblk
->
ÿ·c™y
 * 
NR_PHY_IN_LOG
;

1160 
	}
}

1162 *
	$pblk_š™
(
nvm_tgt_dev
 *
dev
, 
g’disk
 *
tdisk
,

1163 
æags
)

1165 
nvm_geo
 *
geo
 = &
dev
->geo;

1166 
»que¡_queue
 *
bqueue
 = 
dev
->
q
;

1167 
»que¡_queue
 *
tqueue
 = 
tdisk
->
queue
;

1168 
pblk
 *pblk;

1169 
»t
;

1171 
pblk
 = 
	`kz®loc
((pblk), 
GFP_KERNEL
);

1172 ià(!
pblk
)

1173  
	`ERR_PTR
(-
ENOMEM
);

1175 
pblk
->
dev
 = dev;

1176 
pblk
->
disk
 = 
tdisk
;

1177 
pblk
->
¡©e
 = 
PBLK_STATE_RUNNING
;

1178 
	`Œaû_pblk_¡©e
(
	`pblk_disk_Çme
(
pblk
),…blk->
¡©e
);

1179 
pblk
->
gc
.
gc_’abËd
 = 0;

1181 ià(!(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
 ||

1182 
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_20
)) {

1183 
	`pblk_”r
(
pblk
, "OCSSD version‚ot supported (%u)\n",

1184 
geo
->
v”siÚ
);

1185 
	`kä“
(
pblk
);

1186  
	`ERR_PTR
(-
EINVAL
);

1189 ià(
geo
->
ext
) {

1190 
	`pblk_”r
(
pblk
, "extended metadata‚ot supported\n");

1191 
	`kä“
(
pblk
);

1192  
	`ERR_PTR
(-
EINVAL
);

1195 
	`¥š_lock_š™
(&
pblk
->
»subm™_lock
);

1196 
	`¥š_lock_š™
(&
pblk
->
Œªs_lock
);

1197 
	`¥š_lock_š™
(&
pblk
->
lock
);

1199 #ifdeà
CONFIG_NVM_PBLK_DEBUG


1200 
	`©omic_lÚg_£t
(&
pblk
->
šæight_wr™es
, 0);

1201 
	`©omic_lÚg_£t
(&
pblk
->
·dded_wr™es
, 0);

1202 
	`©omic_lÚg_£t
(&
pblk
->
·dded_wb
, 0);

1203 
	`©omic_lÚg_£t
(&
pblk
->
»q_wr™es
, 0);

1204 
	`©omic_lÚg_£t
(&
pblk
->
sub_wr™es
, 0);

1205 
	`©omic_lÚg_£t
(&
pblk
->
sync_wr™es
, 0);

1206 
	`©omic_lÚg_£t
(&
pblk
->
šæight_»ads
, 0);

1207 
	`©omic_lÚg_£t
(&
pblk
->
ÿche_»ads
, 0);

1208 
	`©omic_lÚg_£t
(&
pblk
->
sync_»ads
, 0);

1209 
	`©omic_lÚg_£t
(&
pblk
->
»cov_wr™es
, 0);

1210 
	`©omic_lÚg_£t
(&
pblk
->
»cov_wr™es
, 0);

1211 
	`©omic_lÚg_£t
(&
pblk
->
»cov_gc_wr™es
, 0);

1212 
	`©omic_lÚg_£t
(&
pblk
->
»cov_gc_»ads
, 0);

1215 
	`©omic_lÚg_£t
(&
pblk
->
»ad_çžed
, 0);

1216 
	`©omic_lÚg_£t
(&
pblk
->
»ad_em±y
, 0);

1217 
	`©omic_lÚg_£t
(&
pblk
->
»ad_high_ecc
, 0);

1218 
	`©omic_lÚg_£t
(&
pblk
->
»ad_çžed_gc
, 0);

1219 
	`©omic_lÚg_£t
(&
pblk
->
wr™e_çžed
, 0);

1220 
	`©omic_lÚg_£t
(&
pblk
->
”a£_çžed
, 0);

1222 
»t
 = 
	`pblk_cÜe_š™
(
pblk
);

1223 ià(
»t
) {

1224 
	`pblk_”r
(
pblk
, "could‚ot initialize core\n");

1225 
çž
;

1228 
»t
 = 
	`pblk_lšes_š™
(
pblk
);

1229 ià(
»t
) {

1230 
	`pblk_”r
(
pblk
, "could‚ot initialize†ines\n");

1231 
çž_ä“_cÜe
;

1234 
»t
 = 
	`pblk_rwb_š™
(
pblk
);

1235 ià(
»t
) {

1236 
	`pblk_”r
(
pblk
, "could‚ot initialize write buffer\n");

1237 
çž_ä“_lšes
;

1240 
»t
 = 
	`pblk_l2p_š™
(
pblk
, 
æags
 & 
NVM_TARGET_FACTORY
);

1241 ià(
»t
) {

1242 
	`pblk_”r
(
pblk
, "could‚ot initialize maps\n");

1243 
çž_ä“_rwb
;

1246 
»t
 = 
	`pblk_wr™”_š™
(
pblk
);

1247 ià(
»t
) {

1248 ià(
»t
 !ð-
EINTR
)

1249 
	`pblk_”r
(
pblk
, "could‚ot initialize writehread\n");

1250 
çž_ä“_l2p
;

1253 
»t
 = 
	`pblk_gc_š™
(
pblk
);

1254 ià(
»t
) {

1255 
	`pblk_”r
(
pblk
, "could‚ot initialize gc\n");

1256 
çž_¡Ý_wr™”
;

1260 
	`blk_queue_logiÿl_block_size
(
tqueue
, 
	`queue_physiÿl_block_size
(
bqueue
));

1261 
	`blk_queue_max_hw_£ùÜs
(
tqueue
, 
	`queue_max_hw_£ùÜs
(
bqueue
));

1263 
	`blk_queue_wr™e_ÿche
(
tqueue
, 
Œue
, 
çl£
);

1265 
tqueue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
geo
->
þba
 * geo->
c£cs
;

1266 
tqueue
->
lim™s
.
disÿrd_®ignm’t
 = 0;

1267 
	`blk_queue_max_disÿrd_£ùÜs
(
tqueue
, 
UINT_MAX
 >> 9);

1268 
	`blk_queue_æag_£t
(
QUEUE_FLAG_DISCARD
, 
tqueue
);

1270 
	`pblk_šfo
(
pblk
, "luns:%u,†ines:%d, secs:%llu, bufƒntries:%u\n",

1271 
geo
->
®l_luns
, 
pblk
->
l_mg
.
Ä_lšes
,

1272 ()
pblk
->
ÿ·c™y
,

1273 
pblk
->
rwb
.
Ä_’Œ›s
);

1275 
	`wake_up_´oûss
(
pblk
->
wr™”_ts
);

1278 
	`pblk_gc_should_kick
(
pblk
);

1280  
pblk
;

1282 
çž_¡Ý_wr™”
:

1283 
	`pblk_wr™”_¡Ý
(
pblk
);

1284 
çž_ä“_l2p
:

1285 
	`pblk_l2p_ä“
(
pblk
);

1286 
çž_ä“_rwb
:

1287 
	`pblk_rwb_ä“
(
pblk
);

1288 
çž_ä“_lšes
:

1289 
	`pblk_lšes_ä“
(
pblk
);

1290 
çž_ä“_cÜe
:

1291 
	`pblk_cÜe_ä“
(
pblk
);

1292 
çž
:

1293 
	`kä“
(
pblk
);

1294  
	`ERR_PTR
(
»t
);

1295 
	}
}

1298 
nvm_tgt_ty³
 
	g‰_pblk
 = {

1299 .
Çme
 = "pblk",

1300 .
	gv”siÚ
 = {1, 0, 0},

1302 .
	gmake_rq
 = 
pblk_make_rq
,

1303 .
	gÿ·c™y
 = 
pblk_ÿ·c™y
,

1305 .
	gš™
 = 
pblk_š™
,

1306 .
	gex™
 = 
pblk_ex™
,

1308 .
	gsysfs_š™
 = 
pblk_sysfs_š™
,

1309 .
	gsysfs_ex™
 = 
pblk_sysfs_ex™
,

1310 .
	gowÃr
 = 
THIS_MODULE
,

1313 
__š™
 
	$pblk_moduË_š™
()

1315 
»t
;

1317 
»t
 = 
	`bio£t_š™
(&
pblk_bio_£t
, 
BIO_POOL_SIZE
, 0, 0);

1318 ià(
»t
)

1319  
»t
;

1320 
»t
 = 
	`nvm_»gi¡”_tgt_ty³
(&
‰_pblk
);

1321 ià(
»t
)

1322 
	`bio£t_ex™
(&
pblk_bio_£t
);

1323  
»t
;

1324 
	}
}

1326 
	$pblk_moduË_ex™
()

1328 
	`bio£t_ex™
(&
pblk_bio_£t
);

1329 
	`nvm_uÄegi¡”_tgt_ty³
(&
‰_pblk
);

1330 
	}
}

1332 
moduË_š™
(
pblk_moduË_š™
);

1333 
moduË_ex™
(
pblk_moduË_ex™
);

1334 
MODULE_AUTHOR
("Javier Gonzalez <javier@cnexlabs.com>");

1335 
MODULE_AUTHOR
("Matias Bjorling <matias@cnexlabs.com>");

1336 
MODULE_LICENSE
("GPL v2");

1337 
MODULE_DESCRIPTION
("Physical Block-Device for Open-Channel SSDs");

	@pblk-map.c

20 
	~"pblk.h
"

22 
	$pblk_m­_·ge_d©a
(
pblk
 *pblk, 
£Áry
,

23 
µa_addr
 *
µa_li¡
,

24 *
lun_b™m­
,

25 *
m‘a_li¡
,

26 
v®id_£cs
)

28 
pblk_lše
 *
lše
 = 
	`pblk_lše_g‘_d©a
(
pblk
);

29 
pblk_em‘a
 *
em‘a
;

30 
pblk_w_ùx
 *
w_ùx
;

31 
__Ë64
 *
lba_li¡
;

32 
u64
 
·ddr
;

33 
Ä_£cs
 = 
pblk
->
mš_wr™e_pgs
;

34 
i
;

36 ià(!
lše
)

37  -
ENOSPC
;

39 ià(
	`pblk_lše_is_fuÎ
(
lše
)) {

40 
pblk_lše
 *
´ev_lše
 = 
lše
;

45 
lše
 = 
	`pblk_lše_»¶aû_d©a
(
pblk
);

46 
	`pblk_lše_þo£_m‘a
(
pblk
, 
´ev_lše
);

48 ià(!
lše
) {

49 
	`pblk_p–še_¡Ý
(
pblk
);

50  -
ENOSPC
;

55 
em‘a
 = 
lše
->emeta;

56 
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
em‘a
->
buf
);

58 
·ddr
 = 
	`pblk_®loc_·ge
(
pblk
, 
lše
, 
Ä_£cs
);

60 
i
 = 0; i < 
Ä_£cs
; i++, 
·ddr
++) {

61 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

62 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

65 
µa_li¡
[
i
] = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše
->
id
);

74 ià(
i
 < 
v®id_£cs
) {

75 
	`k»f_g‘
(&
lše
->
»f
);

76 
	`©omic_šc
(&
lše
->
£c_to_upd©e
);

77 
w_ùx
 = 
	`pblk_rb_w_ùx
(&
pblk
->
rwb
, 
£Áry
 + 
i
);

78 
w_ùx
->
µa
 = 
µa_li¡
[
i
];

79 
m‘a
->
lba
 = 
	`ýu_to_Ë64
(
w_ùx
->lba);

80 
lba_li¡
[
·ddr
] = 
	`ýu_to_Ë64
(
w_ùx
->
lba
);

81 ià(
lba_li¡
[
·ddr
] !ð
addr_em±y
)

82 
lše
->
Ä_v®id_lbas
++;

84 
	`©omic64_šc
(&
pblk
->
·d_wa
);

86 
lba_li¡
[
·ddr
] = 
addr_em±y
;

87 
m‘a
->
lba
 = 
addr_em±y
;

88 
	`__pblk_m­_šv®id©e
(
pblk
, 
lše
, 
·ddr
);

92 
	`pblk_down_rq
(
pblk
, 
µa_li¡
[0], 
lun_b™m­
);

94 
	}
}

96 
	$pblk_m­_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
£Áry
,

97 *
lun_b™m­
, 
v®id_£cs
,

98 
off
)

100 *
m‘a_li¡
 = 
	`pblk_g‘_m‘a_fÜ_wr™es
(
pblk
, 
rqd
);

101 *
m‘a_bufãr
;

102 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

103 
m­_£cs
;

104 
mš
 = 
pblk
->
mš_wr™e_pgs
;

105 
i
;

106 
»t
;

108 
i
 = 
off
; i < 
rqd
->
Ä_µas
; i +ð
mš
) {

109 
m­_£cs
 = (
i
 + 
mš
 > 
v®id_£cs
) ? (valid_secs % min) : min;

110 
m‘a_bufãr
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

112 
»t
 = 
	`pblk_m­_·ge_d©a
(
pblk
, 
£Áry
 + 
i
, &
µa_li¡
[i],

113 
lun_b™m­
, 
m‘a_bufãr
, 
m­_£cs
);

114 ià(
»t
)

115  
»t
;

119 
	}
}

122 
	$pblk_m­_”a£_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

123 
£Áry
, *
lun_b™m­
,

124 
v®id_£cs
, 
µa_addr
 *
”a£_µa
)

126 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

127 
nvm_geo
 *
geo
 = &
dev
->geo;

128 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

129 *
m‘a_li¡
 = 
	`pblk_g‘_m‘a_fÜ_wr™es
(
pblk
, 
rqd
);

130 *
m‘a_bufãr
;

131 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

132 
pblk_lše
 *
e_lše
, *
d_lše
;

133 
m­_£cs
;

134 
mš
 = 
pblk
->
mš_wr™e_pgs
;

135 
i
, 
”a£_lun
;

136 
»t
;

139 
i
 = 0; i < 
rqd
->
Ä_µas
; i +ð
mš
) {

140 
m­_£cs
 = (
i
 + 
mš
 > 
v®id_£cs
) ? (valid_secs % min) : min;

141 
m‘a_bufãr
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

143 
»t
 = 
	`pblk_m­_·ge_d©a
(
pblk
, 
£Áry
 + 
i
, &
µa_li¡
[i],

144 
lun_b™m­
, 
m‘a_bufãr
, 
m­_£cs
);

145 ià(
»t
)

146  
»t
;

148 
”a£_lun
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_li¡
[
i
]);

153 
e_lše
 = 
	`pblk_lše_g‘_”a£
(
pblk
);

154 ià(!
e_lše
)

155  
	`pblk_m­_rq
(
pblk
, 
rqd
, 
£Áry
, 
lun_b™m­
,

156 
v®id_£cs
, 
i
 + 
mš
);

158 
	`¥š_lock
(&
e_lše
->
lock
);

159 ià(!
	`‹¡_b™
(
”a£_lun
, 
e_lše
->
”a£_b™m­
)) {

160 
	`£t_b™
(
”a£_lun
, 
e_lše
->
”a£_b™m­
);

161 
	`©omic_dec
(&
e_lše
->
Ëá_eblks
);

163 *
”a£_µa
 = 
µa_li¡
[
i
];

164 
”a£_µa
->
a
.
blk
 = 
e_lše
->
id
;

165 
”a£_µa
->
a
.
»£rved
 = 0;

167 
	`¥š_uÆock
(&
e_lše
->
lock
);

170  
	`pblk_m­_rq
(
pblk
, 
rqd
, 
£Áry
, 
lun_b™m­
,

171 
v®id_£cs
, 
i
 + 
mš
);

173 
	`¥š_uÆock
(&
e_lše
->
lock
);

176 
d_lše
 = 
	`pblk_lše_g‘_d©a
(
pblk
);

181 
e_lše
 = 
	`pblk_lše_g‘_”a£
(
pblk
);

182 ià(!
e_lše
)

183  -
ENOSPC
;

186 ià(
	`uÆik–y
(
	`pblk_µa_em±y
(*
”a£_µa
)) &&

187 
	`b™m­_weight
(
d_lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
)) {

188 
b™
 = -1;

190 
»Œy
:

191 
b™
 = 
	`fšd_Ãxt_b™
(
d_lše
->
blk_b™m­
,

192 
lm
->
blk_³r_lše
, 
b™
 + 1);

193 ià(
b™
 >ð
lm
->
blk_³r_lše
)

196 
	`¥š_lock
(&
e_lše
->
lock
);

197 ià(
	`‹¡_b™
(
b™
, 
e_lše
->
”a£_b™m­
)) {

198 
	`¥š_uÆock
(&
e_lše
->
lock
);

199 
»Œy
;

201 
	`¥š_uÆock
(&
e_lše
->
lock
);

203 
	`£t_b™
(
b™
, 
e_lše
->
”a£_b™m­
);

204 
	`©omic_dec
(&
e_lše
->
Ëá_eblks
);

205 *
”a£_µa
 = 
pblk
->
luns
[
b™
].
bµa
;

206 
”a£_µa
->
a
.
blk
 = 
e_lše
->
id
;

210 
	}
}

	@pblk-rb.c

20 
	~<lšux/cœc_buf.h
>

22 
	~"pblk.h
"

24 
DECLARE_RWSEM
(
pblk_rb_lock
);

26 
	$pblk_rb_d©a_ä“
(
pblk_rb
 *
rb
)

28 
pblk_rb_·ges
 *
p
, *
t
;

30 
	`down_wr™e
(&
pblk_rb_lock
);

31 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
t
, &
rb
->
·ges
, 
li¡
) {

32 
	`ä“_·ges
(()
	`·ge_add»ss
(
p
->
·ges
),…->
Üd”
);

33 
	`li¡_d–
(&
p
->
li¡
);

34 
	`kä“
(
p
);

36 
	`up_wr™e
(&
pblk_rb_lock
);

37 
	}
}

39 
	$pblk_rb_ä“
(
pblk_rb
 *
rb
)

41 
	`pblk_rb_d©a_ä“
(
rb
);

42 
	`vä“
(
rb
->
’Œ›s
);

43 
	}
}

48 
	$pblk_rb_ÿlcuÏ‹_size
(
Ä_’Œ›s
,

49 
th»shÞd
)

51 
thr_sz
 = 1 << (
	`g‘_couÁ_Üd”
(
th»shÞd
 + 
NVM_MAX_VLBA
));

52 
max_sz
 = 
	`max
(
thr_sz
, 
Ä_’Œ›s
);

53 
max_io
;

59 
max_io
 = (1 << 
	`max
(()(
	`g‘_couÁ_Üd”
(
max_sz
)),

60 ()(
	`g‘_couÁ_Üd”
(
NVM_MAX_VLBA
 << 1))));

61 ià((
th»shÞd
 + 
NVM_MAX_VLBA
è>ð
max_io
)

62 
max_io
 <<= 1;

64  
max_io
;

65 
	}
}

72 
	$pblk_rb_š™
(
pblk_rb
 *
rb
, 
size
, 
th»shÞd
,

73 
£g_size
)

75 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

76 
pblk_rb_’Œy
 *
’Œ›s
;

77 
š™_’Œy
 = 0;

78 
max_Üd”
 = 
MAX_ORDER
 - 1;

79 
pow”_size
, 
pow”_£g_sz
;

80 
®loc_Üd”
, 
Üd”
, 
™”
;

81 
Ä_’Œ›s
;

83 
Ä_’Œ›s
 = 
	`pblk_rb_ÿlcuÏ‹_size
(
size
, 
th»shÞd
);

84 
’Œ›s
 = 
	`vz®loc
(
	`¬¿y_size
(
Ä_’Œ›s
, (
pblk_rb_’Œy
)));

85 ià(!
’Œ›s
)

86  -
ENOMEM
;

88 
pow”_size
 = 
	`g‘_couÁ_Üd”
(
Ä_’Œ›s
);

89 
pow”_£g_sz
 = 
	`g‘_couÁ_Üd”
(
£g_size
);

91 
	`down_wr™e
(&
pblk_rb_lock
);

92 
rb
->
’Œ›s
 =ƒntries;

93 
rb
->
£g_size
 = (1 << 
pow”_£g_sz
);

94 
rb
->
Ä_’Œ›s
 = (1 << 
pow”_size
);

95 
rb
->
mem
 =„b->
subm
 =„b->
sync
 =„b->
l2p_upd©e
 = 0;

96 
rb
->
back_th»s
 = 
th»shÞd
;

97 
rb
->
æush_pošt
 = 
EMPTY_ENTRY
;

99 
	`¥š_lock_š™
(&
rb
->
w_lock
);

100 
	`¥š_lock_š™
(&
rb
->
s_lock
);

102 
	`INIT_LIST_HEAD
(&
rb
->
·ges
);

104 
®loc_Üd”
 = 
pow”_size
;

105 ià(
®loc_Üd”
 >ð
max_Üd”
) {

106 
Üd”
 = 
max_Üd”
;

107 
™”
 = (1 << (
®loc_Üd”
 - 
max_Üd”
));

109 
Üd”
 = 
®loc_Üd”
;

110 
™”
 = 1;

114 
pblk_rb_’Œy
 *
’Œy
;

115 
pblk_rb_·ges
 *
·ge_£t
;

116 *
kaddr
;

117 
£t_size
;

118 
i
;

120 
·ge_£t
 = 
	`km®loc
((
pblk_rb_·ges
), 
GFP_KERNEL
);

121 ià(!
·ge_£t
) {

122 
	`up_wr™e
(&
pblk_rb_lock
);

123 
	`vä“
(
’Œ›s
);

124  -
ENOMEM
;

127 
·ge_£t
->
Üd”
 = order;

128 
·ge_£t
->
·ges
 = 
	`®loc_·ges
(
GFP_KERNEL
, 
Üd”
);

129 ià(!
·ge_£t
->
·ges
) {

130 
	`kä“
(
·ge_£t
);

131 
	`pblk_rb_d©a_ä“
(
rb
);

132 
	`up_wr™e
(&
pblk_rb_lock
);

133 
	`vä“
(
’Œ›s
);

134  -
ENOMEM
;

136 
kaddr
 = 
	`·ge_add»ss
(
·ge_£t
->
·ges
);

138 
’Œy
 = &
rb
->
’Œ›s
[
š™_’Œy
];

139 
’Œy
->
d©a
 = 
kaddr
;

140 
’Œy
->
ÿch–še
 = 
	`pblk_ÿch–še_to_addr
(
š™_’Œy
++);

141 
’Œy
->
w_ùx
.
æags
 = 
PBLK_WRITABLE_ENTRY
;

143 
£t_size
 = (1 << 
Üd”
);

144 
i
 = 1; i < 
£t_size
; i++) {

145 
’Œy
 = &
rb
->
’Œ›s
[
š™_’Œy
];

146 
’Œy
->
ÿch–še
 = 
	`pblk_ÿch–še_to_addr
(
š™_’Œy
++);

147 
’Œy
->
d©a
 = 
kaddr
 + (
i
 * 
rb
->
£g_size
);

148 
’Œy
->
w_ùx
.
æags
 = 
PBLK_WRITABLE_ENTRY
;

149 
	`bio_li¡_š™
(&
’Œy
->
w_ùx
.
bios
);

152 
	`li¡_add_ž
(&
·ge_£t
->
li¡
, &
rb
->
·ges
);

153 
™”
--;

154 } 
™”
 > 0);

155 
	`up_wr™e
(&
pblk_rb_lock
);

157 #ifdeà
CONFIG_NVM_PBLK_DEBUG


158 
	`©omic_£t
(&
rb
->
šæight_æush_pošt
, 0);

165 
	`pblk_¾_š™
(&
pblk
->
¾
, 
rb
->
Ä_’Œ›s
, 
th»shÞd
);

168 
	}
}

170 
	$þ—n_wùx
(
pblk_w_ùx
 *
w_ùx
)

172 
æags
;

174 
æags
 = 
	`READ_ONCE
(
w_ùx
->flags);

175 
	`WARN_ONCE
(!(
æags
 & 
PBLK_SUBMITTED_ENTRY
),

179 
	`smp_¡Üe_»Ëa£
(&
w_ùx
->
æags
, 
PBLK_WRITABLE_ENTRY
);

180 
	`pblk_µa_£t_em±y
(&
w_ùx
->
µa
);

181 
w_ùx
->
lba
 = 
ADDR_EMPTY
;

182 
	}
}

184 
	#pblk_rb_ršg_couÁ
(
h—d
, 
ž
, 
size
è
	`CIRC_CNT
(h—d,až, size)

	)

185 
	#pblk_rb_ršg_¥aû
(
rb
, 
h—d
, 
ž
, 
size
) \

186 (
	`CIRC_SPACE
(
h—d
, 
ž
, 
size
))

	)

192 
	$pblk_rb_¥aû
(
pblk_rb
 *
rb
)

194 
mem
 = 
	`READ_ONCE
(
rb
->mem);

195 
sync
 = 
	`READ_ONCE
(
rb
->sync);

197  
	`pblk_rb_ršg_¥aû
(
rb
, 
mem
, 
sync
,„b->
Ä_’Œ›s
);

198 
	}
}

200 
	$pblk_rb_±r_w¿p
(
pblk_rb
 *
rb
, 
p
,

201 
Ä_’Œ›s
)

203  (
p
 + 
Ä_’Œ›s
è& (
rb
->nr_entries - 1);

204 
	}
}

210 
	$pblk_rb_»ad_couÁ
(
pblk_rb
 *
rb
)

212 
mem
 = 
	`READ_ONCE
(
rb
->mem);

213 
subm
 = 
	`READ_ONCE
(
rb
->subm);

215  
	`pblk_rb_ršg_couÁ
(
mem
, 
subm
, 
rb
->
Ä_’Œ›s
);

216 
	}
}

218 
	$pblk_rb_sync_couÁ
(
pblk_rb
 *
rb
)

220 
mem
 = 
	`READ_ONCE
(
rb
->mem);

221 
sync
 = 
	`READ_ONCE
(
rb
->sync);

223  
	`pblk_rb_ršg_couÁ
(
mem
, 
sync
, 
rb
->
Ä_’Œ›s
);

224 
	}
}

226 
	$pblk_rb_»ad_comm™
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
)

228 
subm
;

230 
subm
 = 
	`READ_ONCE
(
rb
->subm);

232 
	`smp_¡Üe_»Ëa£
(&
rb
->
subm
, 
	`pblk_rb_±r_w¿p
Ôb, subm, 
Ä_’Œ›s
));

234  
subm
;

235 
	}
}

237 
	$__pblk_rb_upd©e_l2p
(
pblk_rb
 *
rb
, 
to_upd©e
)

239 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

240 
pblk_lše
 *
lše
;

241 
pblk_rb_’Œy
 *
’Œy
;

242 
pblk_w_ùx
 *
w_ùx
;

243 
u£r_io
 = 0, 
gc_io
 = 0;

244 
i
;

245 
æags
;

247 
i
 = 0; i < 
to_upd©e
; i++) {

248 
’Œy
 = &
rb
->
’Œ›s
[rb->
l2p_upd©e
];

249 
w_ùx
 = &
’Œy
->w_ctx;

251 
æags
 = 
	`READ_ONCE
(
’Œy
->
w_ùx
.flags);

252 ià(
æags
 & 
PBLK_IOTYPE_USER
)

253 
u£r_io
++;

254 ià(
æags
 & 
PBLK_IOTYPE_GC
)

255 
gc_io
++;

257 
	`WARN
(1, "pblk: unknown IOype\n");

259 
	`pblk_upd©e_m­_dev
(
pblk
, 
w_ùx
->
lba
, w_ùx->
µa
,

260 
’Œy
->
ÿch–še
);

262 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
w_ùx
->
µa
);

263 
	`©omic_dec
(&
lše
->
£c_to_upd©e
);

264 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put
);

265 
	`þ—n_wùx
(
w_ùx
);

266 
rb
->
l2p_upd©e
 = 
	`pblk_rb_±r_w¿p
(rb,„b->l2p_update, 1);

269 
	`pblk_¾_out
(&
pblk
->
¾
, 
u£r_io
, 
gc_io
);

272 
	}
}

279 
	$pblk_rb_upd©e_l2p
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

280 
mem
, 
sync
)

282 
¥aû
, 
couÁ
;

283 
»t
 = 0;

285 
	`lockd•_as£¹_h–d
(&
rb
->
w_lock
);

288 
¥aû
 = 
	`pblk_rb_ršg_¥aû
(
rb
, 
mem
,„b->
l2p_upd©e
,„b->
Ä_’Œ›s
);

289 ià(
¥aû
 > 
Ä_’Œ›s
)

290 
out
;

292 
couÁ
 = 
Ä_’Œ›s
 - 
¥aû
;

294 
»t
 = 
	`__pblk_rb_upd©e_l2p
(
rb
, 
couÁ
);

296 
out
:

297  
»t
;

298 
	}
}

305 
	$pblk_rb_sync_l2p
(
pblk_rb
 *
rb
)

307 
sync
;

308 
to_upd©e
;

310 
	`¥š_lock
(&
rb
->
w_lock
);

313 
sync
 = 
	`smp_lßd_acquœe
(&
rb
->sync);

315 
to_upd©e
 = 
	`pblk_rb_ršg_couÁ
(
sync
, 
rb
->
l2p_upd©e
,„b->
Ä_’Œ›s
);

316 
	`__pblk_rb_upd©e_l2p
(
rb
, 
to_upd©e
);

318 
	`¥š_uÆock
(&
rb
->
w_lock
);

319 
	}
}

327 
	$__pblk_rb_wr™e_’Œy
(
pblk_rb
 *
rb
, *
d©a
,

328 
pblk_w_ùx
 
w_ùx
,

329 
pblk_rb_’Œy
 *
’Œy
)

331 
	`memýy
(
’Œy
->
d©a
, d©a, 
rb
->
£g_size
);

333 
’Œy
->
w_ùx
.
lba
 = w_ctx.lba;

334 
’Œy
->
w_ùx
.
µa
 = w_ctx.ppa;

335 
	}
}

337 
	$pblk_rb_wr™e_’Œy_u£r
(
pblk_rb
 *
rb
, *
d©a
,

338 
pblk_w_ùx
 
w_ùx
, 
ršg_pos
)

340 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

341 
pblk_rb_’Œy
 *
’Œy
;

342 
æags
;

344 
’Œy
 = &
rb
->
’Œ›s
[
ršg_pos
];

345 
æags
 = 
	`READ_ONCE
(
’Œy
->
w_ùx
.flags);

346 #ifdeà
CONFIG_NVM_PBLK_DEBUG


348 
	`BUG_ON
(!(
æags
 & 
PBLK_WRITABLE_ENTRY
));

351 
	`__pblk_rb_wr™e_’Œy
(
rb
, 
d©a
, 
w_ùx
, 
’Œy
);

353 
	`pblk_upd©e_m­_ÿche
(
pblk
, 
w_ùx
.
lba
, 
’Œy
->
ÿch–še
);

354 
æags
 = 
w_ùx
.æag | 
PBLK_WRITTEN_DATA
;

357 
	`smp_¡Üe_»Ëa£
(&
’Œy
->
w_ùx
.
æags
, flags);

358 
	}
}

360 
	$pblk_rb_wr™e_’Œy_gc
(
pblk_rb
 *
rb
, *
d©a
,

361 
pblk_w_ùx
 
w_ùx
, 
pblk_lše
 *
lše
,

362 
u64
 
·ddr
, 
ršg_pos
)

364 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

365 
pblk_rb_’Œy
 *
’Œy
;

366 
æags
;

368 
’Œy
 = &
rb
->
’Œ›s
[
ršg_pos
];

369 
æags
 = 
	`READ_ONCE
(
’Œy
->
w_ùx
.flags);

370 #ifdeà
CONFIG_NVM_PBLK_DEBUG


372 
	`BUG_ON
(!(
æags
 & 
PBLK_WRITABLE_ENTRY
));

375 
	`__pblk_rb_wr™e_’Œy
(
rb
, 
d©a
, 
w_ùx
, 
’Œy
);

377 ià(!
	`pblk_upd©e_m­_gc
(
pblk
, 
w_ùx
.
lba
, 
’Œy
->
ÿch–še
, 
lše
, 
·ddr
))

378 
’Œy
->
w_ùx
.
lba
 = 
ADDR_EMPTY
;

380 
æags
 = 
w_ùx
.æag | 
PBLK_WRITTEN_DATA
;

383 
	`smp_¡Üe_»Ëa£
(&
’Œy
->
w_ùx
.
æags
, flags);

384 
	}
}

386 
	$pblk_rb_æush_pošt_£t
(
pblk_rb
 *
rb
, 
bio
 *bio,

387 
pos
)

389 
pblk_rb_’Œy
 *
’Œy
;

390 
sync
, 
æush_pošt
;

392 
	`pblk_rb_sync_š™
(
rb
, 
NULL
);

393 
sync
 = 
	`READ_ONCE
(
rb
->sync);

395 ià(
pos
 =ð
sync
) {

396 
	`pblk_rb_sync_’d
(
rb
, 
NULL
);

400 #ifdeà
CONFIG_NVM_PBLK_DEBUG


401 
	`©omic_šc
(&
rb
->
šæight_æush_pošt
);

404 
æush_pošt
 = (
pos
 =ð0è? (
rb
->
Ä_’Œ›s
 - 1) : (pos - 1);

405 
’Œy
 = &
rb
->
’Œ›s
[
æush_pošt
];

408 
	`smp_¡Üe_»Ëa£
(&
rb
->
æush_pošt
, flush_point);

410 ià(
bio
)

411 
	`bio_li¡_add
(&
’Œy
->
w_ùx
.
bios
, 
bio
);

413 
	`pblk_rb_sync_’d
(
rb
, 
NULL
);

415  
bio
 ? 1 : 0;

416 
	}
}

418 
	$__pblk_rb_may_wr™e
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

419 *
pos
)

421 
mem
;

422 
sync
;

423 
th»shÞd
;

425 
sync
 = 
	`READ_ONCE
(
rb
->sync);

426 
mem
 = 
	`READ_ONCE
(
rb
->mem);

428 
th»shÞd
 = 
Ä_’Œ›s
 + 
rb
->
back_th»s
;

430 ià(
	`pblk_rb_ršg_¥aû
(
rb
, 
mem
, 
sync
,„b->
Ä_’Œ›s
è< 
th»shÞd
)

433 ià(
	`pblk_rb_upd©e_l2p
(
rb
, 
Ä_’Œ›s
, 
mem
, 
sync
))

436 *
pos
 = 
mem
;

439 
	}
}

441 
	$pblk_rb_may_wr™e
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

442 *
pos
)

444 ià(!
	`__pblk_rb_may_wr™e
(
rb
, 
Ä_’Œ›s
, 
pos
))

448 
	`smp_¡Üe_»Ëa£
(&
rb
->
mem
, 
	`pblk_rb_±r_w¿p
Ôb, *
pos
, 
Ä_’Œ›s
));

450 
	}
}

452 
	$pblk_rb_æush
(
pblk_rb
 *
rb
)

454 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

455 
mem
 = 
	`READ_ONCE
(
rb
->mem);

457 ià(
	`pblk_rb_æush_pošt_£t
(
rb
, 
NULL
, 
mem
))

460 
	`pblk_wr™e_kick
(
pblk
);

461 
	}
}

463 
	$pblk_rb_may_wr™e_æush
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

464 *
pos
, 
bio
 *bio,

465 *
io_»t
)

467 
mem
;

469 ià(!
	`__pblk_rb_may_wr™e
(
rb
, 
Ä_’Œ›s
, 
pos
))

472 
mem
 = 
	`pblk_rb_±r_w¿p
(
rb
, *
pos
, 
Ä_’Œ›s
);

473 *
io_»t
 = 
NVM_IO_DONE
;

475 ià(
bio
->
bi_Ýf
 & 
REQ_PREFLUSH
) {

476 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

478 
	`©omic64_šc
(&
pblk
->
Ä_æush
);

479 ià(
	`pblk_rb_æush_pošt_£t
(&
pblk
->
rwb
, 
bio
, 
mem
))

480 *
io_»t
 = 
NVM_IO_OK
;

484 
	`smp_¡Üe_»Ëa£
(&
rb
->
mem
, mem);

487 
	}
}

494 
	$pblk_rb_may_wr™e_u£r
(
pblk_rb
 *
rb
, 
bio
 *bio,

495 
Ä_’Œ›s
, *
pos
)

497 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

498 
io_»t
;

500 
	`¥š_lock
(&
rb
->
w_lock
);

501 
io_»t
 = 
	`pblk_¾_u£r_may_š£¹
(&
pblk
->
¾
, 
Ä_’Œ›s
);

502 ià(
io_»t
) {

503 
	`¥š_uÆock
(&
rb
->
w_lock
);

504  
io_»t
;

507 ià(!
	`pblk_rb_may_wr™e_æush
(
rb
, 
Ä_’Œ›s
, 
pos
, 
bio
, &
io_»t
)) {

508 
	`¥š_uÆock
(&
rb
->
w_lock
);

509  
NVM_IO_REQUEUE
;

512 
	`pblk_¾_u£r_š
(&
pblk
->
¾
, 
Ä_’Œ›s
);

513 
	`¥š_uÆock
(&
rb
->
w_lock
);

515  
io_»t
;

516 
	}
}

521 
	$pblk_rb_may_wr™e_gc
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

522 *
pos
)

524 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

526 
	`¥š_lock
(&
rb
->
w_lock
);

527 ià(!
	`pblk_¾_gc_may_š£¹
(&
pblk
->
¾
, 
Ä_’Œ›s
)) {

528 
	`¥š_uÆock
(&
rb
->
w_lock
);

532 ià(!
	`pblk_rb_may_wr™e
(
rb
, 
Ä_’Œ›s
, 
pos
)) {

533 
	`¥š_uÆock
(&
rb
->
w_lock
);

537 
	`pblk_¾_gc_š
(&
pblk
->
¾
, 
Ä_’Œ›s
);

538 
	`¥š_uÆock
(&
rb
->
w_lock
);

541 
	}
}

550 
	$pblk_rb_»ad_to_bio
(
pblk_rb
 *
rb
, 
nvm_rq
 *
rqd
,

551 
pos
, 
Ä_’Œ›s
,

552 
couÁ
)

554 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

555 
»que¡_queue
 *
q
 = 
pblk
->
dev
->q;

556 
pblk_c_ùx
 *
c_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

557 
bio
 *biØð
rqd
->bio;

558 
pblk_rb_’Œy
 *
’Œy
;

559 
·ge
 *page;

560 
·d
 = 0, 
to_»ad
 = 
Ä_’Œ›s
;

561 
i
;

562 
æags
;

564 ià(
couÁ
 < 
Ä_’Œ›s
) {

565 
·d
 = 
Ä_’Œ›s
 - 
couÁ
;

566 
to_»ad
 = 
couÁ
;

570 
·d
 +ð(
pblk
->
mš_wr™e_pgs
 -…blk->
mš_wr™e_pgs_d©a
);

572 
c_ùx
->
£Áry
 = 
pos
;

573 
c_ùx
->
Ä_v®id
 = 
to_»ad
;

574 
c_ùx
->
Ä_·dded
 = 
·d
;

576 
i
 = 0; i < 
to_»ad
; i++) {

577 
’Œy
 = &
rb
->
’Œ›s
[
pos
];

582 
Œy
:

583 
æags
 = 
	`READ_ONCE
(
’Œy
->
w_ùx
.flags);

584 ià(!(
æags
 & 
PBLK_WRITTEN_DATA
)) {

585 
	`io_scheduË
();

586 
Œy
;

589 
·ge
 = 
	`vœt_to_·ge
(
’Œy
->
d©a
);

590 ià(!
·ge
) {

591 
	`pblk_”r
(
pblk
, "could‚ot‡llocate write bio…age\n");

592 
æags
 &ð~
PBLK_WRITTEN_DATA
;

593 
æags
 |ð
PBLK_SUBMITTED_ENTRY
;

595 
	`smp_¡Üe_»Ëa£
(&
’Œy
->
w_ùx
.
æags
, flags);

596  
NVM_IO_ERR
;

599 ià(
	`bio_add_pc_·ge
(
q
, 
bio
, 
·ge
, 
rb
->
£g_size
, 0) !=

600 
rb
->
£g_size
) {

601 
	`pblk_”r
(
pblk
, "could‚ot‡dd…ageo write bio\n");

602 
æags
 &ð~
PBLK_WRITTEN_DATA
;

603 
æags
 |ð
PBLK_SUBMITTED_ENTRY
;

605 
	`smp_¡Üe_»Ëa£
(&
’Œy
->
w_ùx
.
æags
, flags);

606  
NVM_IO_ERR
;

609 
æags
 &ð~
PBLK_WRITTEN_DATA
;

610 
æags
 |ð
PBLK_SUBMITTED_ENTRY
;

613 
	`smp_¡Üe_»Ëa£
(&
’Œy
->
w_ùx
.
æags
, flags);

615 
pos
 = 
	`pblk_rb_±r_w¿p
(
rb
,…os, 1);

618 ià(
·d
) {

619 ià(
	`pblk_bio_add_·ges
(
pblk
, 
bio
, 
GFP_KERNEL
, 
·d
)) {

620 
	`pblk_”r
(
pblk
, "could‚ot…ad…age in write bio\n");

621  
NVM_IO_ERR
;

624 ià(
·d
 < 
pblk
->
mš_wr™e_pgs
)

625 
	`©omic64_šc
(&
pblk
->
·d_di¡
[
·d
 - 1]);

627 
	`pblk_w¬n
(
pblk
, "padding morehan min. sectors\n");

629 
	`©omic64_add
(
·d
, &
pblk
->
·d_wa
);

632 #ifdeà
CONFIG_NVM_PBLK_DEBUG


633 
	`©omic_lÚg_add
(
·d
, &
pblk
->
·dded_wr™es
);

636  
NVM_IO_OK
;

637 
	}
}

644 
	$pblk_rb_cÝy_to_bio
(
pblk_rb
 *
rb
, 
bio
 *bio, 
£ùÜ_t
 
lba
,

645 
µa_addr
 
µa
)

647 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

648 
pblk_rb_’Œy
 *
’Œy
;

649 
pblk_w_ùx
 *
w_ùx
;

650 
µa_addr
 
l2p_µa
;

651 
u64
 
pos
 = 
	`pblk_addr_to_ÿch–še
(
µa
);

652 *
d©a
;

653 
æags
;

654 
»t
 = 1;

657 #ifdeà
CONFIG_NVM_PBLK_DEBUG


659 
	`BUG_ON
(
pos
 >ð
rb
->
Ä_’Œ›s
);

661 
’Œy
 = &
rb
->
’Œ›s
[
pos
];

662 
w_ùx
 = &
’Œy
->w_ctx;

663 
æags
 = 
	`READ_ONCE
(
w_ùx
->flags);

665 
	`¥š_lock
(&
rb
->
w_lock
);

666 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

667 
l2p_µa
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

668 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

671 ià(!
	`pblk_µa_comp
(
l2p_µa
, 
µa
è|| 
w_ùx
->
lba
 !=†ba ||

672 
æags
 & 
PBLK_WRITABLE_ENTRY
) {

673 
»t
 = 0;

674 
out
;

676 
d©a
 = 
	`bio_d©a
(
bio
);

677 
	`memýy
(
d©a
, 
’Œy
->d©a, 
rb
->
£g_size
);

679 
out
:

680 
	`¥š_uÆock
(&
rb
->
w_lock
);

681  
»t
;

682 
	}
}

684 
pblk_w_ùx
 *
	$pblk_rb_w_ùx
(
pblk_rb
 *
rb
, 
pos
)

686 
’Œy
 = 
	`pblk_rb_±r_w¿p
(
rb
, 
pos
, 0);

688  &
rb
->
’Œ›s
[
’Œy
].
w_ùx
;

689 
	}
}

691 
	$pblk_rb_sync_š™
(
pblk_rb
 *
rb
, *
æags
)

692 
	`__acquœes
(&
rb
->
s_lock
)

694 ià(
æags
)

695 
	`¥š_lock_œq§ve
(&
rb
->
s_lock
, *
æags
);

697 
	`¥š_lock_œq
(&
rb
->
s_lock
);

699  
rb
->
sync
;

700 
	}
}

702 
	$pblk_rb_sync_’d
(
pblk_rb
 *
rb
, *
æags
)

703 
	`__»Ëa£s
(&
rb
->
s_lock
)

705 
	`lockd•_as£¹_h–d
(&
rb
->
s_lock
);

707 ià(
æags
)

708 
	`¥š_uÆock_œq»¡Üe
(&
rb
->
s_lock
, *
æags
);

710 
	`¥š_uÆock_œq
(&
rb
->
s_lock
);

711 
	}
}

713 
	$pblk_rb_sync_advªû
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
)

715 
sync
, 
æush_pošt
;

716 
	`lockd•_as£¹_h–d
(&
rb
->
s_lock
);

718 
sync
 = 
	`READ_ONCE
(
rb
->sync);

719 
æush_pošt
 = 
	`READ_ONCE
(
rb
->flush_point);

721 ià(
æush_pošt
 !ð
EMPTY_ENTRY
) {

722 
£cs_to_æush
;

724 
£cs_to_æush
 = 
	`pblk_rb_ršg_couÁ
(
æush_pošt
, 
sync
,

725 
rb
->
Ä_’Œ›s
);

726 ià(
£cs_to_æush
 < 
Ä_’Œ›s
) {

728 
	`smp_¡Üe_»Ëa£
(&
rb
->
æush_pošt
, 
EMPTY_ENTRY
);

732 
sync
 = 
	`pblk_rb_±r_w¿p
(
rb
, sync, 
Ä_’Œ›s
);

735 
	`smp_¡Üe_»Ëa£
(&
rb
->
sync
, sync);

737  
sync
;

738 
	}
}

741 
	$pblk_rb_æush_pošt_couÁ
(
pblk_rb
 *
rb
)

743 
subm
, 
sync
, 
æush_pošt
;

744 
subm™‹d
, 
to_æush
;

747 
æush_pošt
 = 
	`smp_lßd_acquœe
(&
rb
->flush_point);

748 ià(
æush_pošt
 =ð
EMPTY_ENTRY
)

752 
sync
 = 
	`smp_lßd_acquœe
(&
rb
->sync);

754 
subm
 = 
	`READ_ONCE
(
rb
->subm);

755 
subm™‹d
 = 
	`pblk_rb_ršg_couÁ
(
subm
, 
sync
, 
rb
->
Ä_’Œ›s
);

758 
to_æush
 = 
	`pblk_rb_ršg_couÁ
(
æush_pošt
, 
sync
, 
rb
->
Ä_’Œ›s
) + 1;

760  (
subm™‹d
 < 
to_æush
) ? (to_flush - submitted) : 0;

761 
	}
}

763 
	$pblk_rb_‹¬_down_check
(
pblk_rb
 *
rb
)

765 
pblk_rb_’Œy
 *
’Œy
;

766 
i
;

767 
»t
 = 0;

769 
	`¥š_lock
(&
rb
->
w_lock
);

770 
	`¥š_lock_œq
(&
rb
->
s_lock
);

772 ià((
rb
->
mem
 =ðrb->
subm
è&& (rb->subm =ðrb->
sync
) &&

773 (
rb
->
sync
 =ðrb->
l2p_upd©e
) &&

774 (
rb
->
æush_pošt
 =ð
EMPTY_ENTRY
)) {

775 
out
;

778 ià(!
rb
->
’Œ›s
) {

779 
»t
 = 1;

780 
out
;

783 
i
 = 0; i < 
rb
->
Ä_’Œ›s
; i++) {

784 
’Œy
 = &
rb
->
’Œ›s
[
i
];

786 ià(!
’Œy
->
d©a
) {

787 
»t
 = 1;

788 
out
;

792 
out
:

793 
	`¥š_uÆock_œq
(&
rb
->
s_lock
);

794 
	`¥š_uÆock
(&
rb
->
w_lock
);

796  
»t
;

797 
	}
}

799 
	$pblk_rb_w¿p_pos
(
pblk_rb
 *
rb
, 
pos
)

801  (
pos
 & (
rb
->
Ä_’Œ›s
 - 1));

802 
	}
}

804 
	$pblk_rb_pos_oob
(
pblk_rb
 *
rb
, 
u64
 
pos
)

806  (
pos
 >ð
rb
->
Ä_’Œ›s
);

807 
	}
}

809 
ssize_t
 
	$pblk_rb_sysfs
(
pblk_rb
 *
rb
, *
buf
)

811 
pblk
 *pblk = 
	`cÚš”_of
(
rb
, pblk, 
rwb
);

812 
pblk_c_ùx
 *
c
;

813 
ssize_t
 
off£t
;

814 
queued_’Œ›s
 = 0;

816 
	`¥š_lock_œq
(&
rb
->
s_lock
);

817 
	`li¡_fÜ_—ch_’Œy
(
c
, &
pblk
->
com¶_li¡
, 
li¡
)

818 
queued_’Œ›s
++;

819 
	`¥š_uÆock_œq
(&
rb
->
s_lock
);

821 ià(
rb
->
æush_pošt
 !ð
EMPTY_ENTRY
)

822 
off£t
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
,

824 
rb
->
Ä_’Œ›s
,

825 
rb
->
mem
,

826 
rb
->
subm
,

827 
rb
->
sync
,

828 
rb
->
l2p_upd©e
,

829 #ifdeà
CONFIG_NVM_PBLK_DEBUG


830 
	`©omic_»ad
(&
rb
->
šæight_æush_pošt
),

834 
rb
->
æush_pošt
,

835 
	`pblk_rb_»ad_couÁ
(
rb
),

836 
	`pblk_rb_¥aû
(
rb
),

837 
	`pblk_rb_æush_pošt_couÁ
(
rb
),

838 
queued_’Œ›s
);

840 
off£t
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
,

842 
rb
->
Ä_’Œ›s
,

843 
rb
->
mem
,

844 
rb
->
subm
,

845 
rb
->
sync
,

846 
rb
->
l2p_upd©e
,

847 #ifdeà
CONFIG_NVM_PBLK_DEBUG


848 
	`©omic_»ad
(&
rb
->
šæight_æush_pošt
),

852 
	`pblk_rb_»ad_couÁ
(
rb
),

853 
	`pblk_rb_¥aû
(
rb
),

854 
	`pblk_rb_æush_pošt_couÁ
(
rb
),

855 
queued_’Œ›s
);

857  
off£t
;

858 
	}
}

	@pblk-read.c

19 
	~"pblk.h
"

28 
	$pblk_»ad_äom_ÿche
(
pblk
 *pblk, 
bio
 *bio,

29 
£ùÜ_t
 
lba
, 
µa_addr
 
µa
)

31 #ifdeà
CONFIG_NVM_PBLK_DEBUG


33 
	`BUG_ON
(
	`pblk_µa_em±y
(
µa
));

34 
	`BUG_ON
(!
	`pblk_addr_š_ÿche
(
µa
));

37  
	`pblk_rb_cÝy_to_bio
(&
pblk
->
rwb
, 
bio
, 
lba
, 
µa
);

38 
	}
}

40 
	$pblk_»ad_µ®i¡_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

41 
bio
 *bio, 
£ùÜ_t
 
blba
,

42 
boÞ
 *
äom_ÿche
)

44 *
m‘a_li¡
 = 
rqd
->meta_list;

45 
Ä_£cs
, 
i
;

47 
»Œy
:

48 
Ä_£cs
 = 
	`pblk_lookup_l2p_£q
(
pblk
, 
rqd
->
µa_li¡
, 
blba
,„qd->
Ä_µas
,

49 
äom_ÿche
);

51 ià(!*
äom_ÿche
)

52 
’d
;

54 
i
 = 0; i < 
Ä_£cs
; i++) {

55 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

56 
£ùÜ_t
 
lba
 = 
blba
 + 
i
;

58 ià(
	`pblk_µa_em±y
(
rqd
->
µa_li¡
[
i
])) {

59 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

61 
m‘a
->
lba
 = 
addr_em±y
;

62 } ià(
	`pblk_addr_š_ÿche
(
rqd
->
µa_li¡
[
i
])) {

68 ià(!
	`pblk_»ad_äom_ÿche
(
pblk
, 
bio
, 
lba
,

69 
rqd
->
µa_li¡
[
i
])) {

70 ià(
i
 == 0) {

75 
»Œy
;

85 
Ä_£cs
 = 
i
;

86 
’d
;

89 
m‘a
->
lba
 = 
	`ýu_to_Ë64
(lba);

90 #ifdeà
CONFIG_NVM_PBLK_DEBUG


91 
	`©omic_lÚg_šc
(&
pblk
->
ÿche_»ads
);

94 
	`bio_advªû
(
bio
, 
PBLK_EXPOSED_PAGE_SIZE
);

97 
’d
:

98 ià(
	`pblk_io_®igÃd
(
pblk
, 
Ä_£cs
))

99 
rqd
->
is_£q
 = 1;

101 #ifdeà
CONFIG_NVM_PBLK_DEBUG


102 
	`©omic_lÚg_add
(
Ä_£cs
, &
pblk
->
šæight_»ads
);

105  
Ä_£cs
;

106 
	}
}

109 
	$pblk_»ad_check_£q
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

110 
£ùÜ_t
 
blba
)

112 *
m‘a_li¡
 = 
rqd
->meta_list;

113 
Ä_lbas
 = 
rqd
->
Ä_µas
;

114 
i
;

116 ià(!
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
))

119 
i
 = 0; i < 
Ä_lbas
; i++) {

120 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

121 
u64
 
lba
 = 
	`Ë64_to_ýu
(
m‘a
->lba);

123 ià(
lba
 =ð
ADDR_EMPTY
)

126 ià(
lba
 !ð
blba
 + 
i
) {

127 #ifdeà
CONFIG_NVM_PBLK_DEBUG


128 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

130 
	`´št_µa
(
pblk
, &
µa_li¡
[
i
], "seq", i);

132 
	`pblk_”r
(
pblk
, "corrupted„ead LBA (%llu/%llu)\n",

133 
lba
, (
u64
)
blba
 + 
i
);

134 
	`WARN_ON
(1);

137 
	}
}

142 
	$pblk_»ad_check_¿nd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

143 
u64
 *
lba_li¡
, 
Ä_lbas
)

145 *
m‘a_lba_li¡
 = 
rqd
->
m‘a_li¡
;

146 
i
, 
j
;

148 ià(!
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
))

151 
i
 = 0, 
j
 = 0; i < 
Ä_lbas
; i++) {

152 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
,

153 
m‘a_lba_li¡
, 
j
);

154 
u64
 
lba
 = 
lba_li¡
[
i
];

155 
u64
 
m‘a_lba
;

157 ià(
lba
 =ð
ADDR_EMPTY
)

160 
m‘a_lba
 = 
	`Ë64_to_ýu
(
m‘a
->
lba
);

162 ià(
lba
 !ð
m‘a_lba
) {

163 #ifdeà
CONFIG_NVM_PBLK_DEBUG


164 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

166 
	`´št_µa
(
pblk
, &
µa_li¡
[
j
], "rnd", j);

168 
	`pblk_”r
(
pblk
, "corrupted„ead LBA (%llu/%llu)\n",

169 
m‘a_lba
, 
lba
);

170 
	`WARN_ON
(1);

173 
j
++;

176 
	`WARN_ONCE
(
j
 !ð
rqd
->
Ä_µas
, "pblk: corrupted„andom„equest\n");

177 
	}
}

179 
	$pblk_’d_u£r_»ad
(
bio
 *bio, 
”rÜ
)

181 ià(
”rÜ
 &&ƒ¼Ü !ð
NVM_RSP_WARN_HIGHECC
)

182 
	`bio_io_”rÜ
(
bio
);

184 
	`bio_’dio
(
bio
);

185 
	}
}

187 
	$__pblk_’d_io_»ad
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

188 
boÞ
 
put_lše
)

190 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

191 
pblk_g_ùx
 *
r_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

192 
bio
 *
št_bio
 = 
rqd
->bio;

193 
¡¬t_time
 = 
r_ùx
->start_time;

195 
	`g’”ic_’d_io_acù
(
dev
->
q
, 
REQ_OP_READ
, &
pblk
->
disk
->
·¹0
, 
¡¬t_time
);

197 ià(
rqd
->
”rÜ
)

198 
	`pblk_log_»ad_”r
(
pblk
, 
rqd
);

200 
	`pblk_»ad_check_£q
(
pblk
, 
rqd
, 
r_ùx
->
lba
);

201 
	`bio_put
(
št_bio
);

203 ià(
put_lše
)

204 
	`pblk_rq_to_lše_put
(
pblk
, 
rqd
);

206 #ifdeà
CONFIG_NVM_PBLK_DEBUG


207 
	`©omic_lÚg_add
(
rqd
->
Ä_µas
, &
pblk
->
sync_»ads
);

208 
	`©omic_lÚg_sub
(
rqd
->
Ä_µas
, &
pblk
->
šæight_»ads
);

211 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_READ
);

212 
	`©omic_dec
(&
pblk
->
šæight_io
);

213 
	}
}

215 
	$pblk_’d_io_»ad
(
nvm_rq
 *
rqd
)

217 
pblk
 *pblk = 
rqd
->
´iv©e
;

218 
pblk_g_ùx
 *
r_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

219 
bio
 *biØð(biØ*)
r_ùx
->
´iv©e
;

221 
	`pblk_’d_u£r_»ad
(
bio
, 
rqd
->
”rÜ
);

222 
	`__pblk_’d_io_»ad
(
pblk
, 
rqd
, 
Œue
);

223 
	}
}

225 
	$pblk_»ad_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
bio
 *bio,

226 
£ùÜ_t
 
lba
, 
boÞ
 *
äom_ÿche
)

228 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
rqd
->
m‘a_li¡
, 0);

229 
µa_addr
 
µa
;

231 
	`pblk_lookup_l2p_£q
(
pblk
, &
µa
, 
lba
, 1, 
äom_ÿche
);

233 #ifdeà
CONFIG_NVM_PBLK_DEBUG


234 
	`©omic_lÚg_šc
(&
pblk
->
šæight_»ads
);

237 
»Œy
:

238 ià(
	`pblk_µa_em±y
(
µa
)) {

239 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

241 
m‘a
->
lba
 = 
addr_em±y
;

248 ià(
	`pblk_addr_š_ÿche
(
µa
)) {

249 ià(!
	`pblk_»ad_äom_ÿche
(
pblk
, 
bio
, 
lba
, 
µa
)) {

250 
	`pblk_lookup_l2p_£q
(
pblk
, &
µa
, 
lba
, 1, 
äom_ÿche
);

251 
»Œy
;

254 
m‘a
->
lba
 = 
	`ýu_to_Ë64
(lba);

256 #ifdeà
CONFIG_NVM_PBLK_DEBUG


257 
	`©omic_lÚg_šc
(&
pblk
->
ÿche_»ads
);

260 
rqd
->
µa_addr
 = 
µa
;

262 
	}
}

264 
	$pblk_subm™_»ad
(
pblk
 *pblk, 
bio
 *bio)

266 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

267 
»que¡_queue
 *
q
 = 
dev
->q;

268 
£ùÜ_t
 
blba
 = 
	`pblk_g‘_lba
(
bio
);

269 
Ä_£cs
 = 
	`pblk_g‘_£cs
(
bio
);

270 
boÞ
 
äom_ÿche
;

271 
pblk_g_ùx
 *
r_ùx
;

272 
nvm_rq
 *
rqd
;

273 
bio
 *
št_bio
, *
¥l™_bio
;

275 
	`g’”ic_¡¬t_io_acù
(
q
, 
REQ_OP_READ
, 
	`bio_£ùÜs
(
bio
),

276 &
pblk
->
disk
->
·¹0
);

278 
rqd
 = 
	`pblk_®loc_rqd
(
pblk
, 
PBLK_READ
);

280 
rqd
->
Ýcode
 = 
NVM_OP_PREAD
;

281 
rqd
->
Ä_µas
 = 
Ä_£cs
;

282 
rqd
->
´iv©e
 = 
pblk
;

283 
rqd
->
’d_io
 = 
pblk_’d_io_»ad
;

285 
r_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

286 
r_ùx
->
¡¬t_time
 = 
jiff›s
;

287 
r_ùx
->
lba
 = 
blba
;

289 ià(
	`pblk_®loc_rqd_m‘a
(
pblk
, 
rqd
)) {

290 
	`bio_io_”rÜ
(
bio
);

291 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_READ
);

299 
št_bio
 = 
	`bio_þÚe_ç¡
(
bio
, 
GFP_KERNEL
, &
pblk_bio_£t
);

301 ià(
Ä_£cs
 > 1)

302 
Ä_£cs
 = 
	`pblk_»ad_µ®i¡_rq
(
pblk
, 
rqd
, 
št_bio
, 
blba
,

303 &
äom_ÿche
);

305 
	`pblk_»ad_rq
(
pblk
, 
rqd
, 
št_bio
, 
blba
, &
äom_ÿche
);

307 
¥l™_»Œy
:

308 
r_ùx
->
´iv©e
 = 
bio
;

309 
rqd
->
bio
 = 
št_bio
;

311 ià(
äom_ÿche
 && 
Ä_£cs
 =ð
rqd
->
Ä_µas
) {

313 
	`pblk_’d_u£r_»ad
(
bio
, 0);

314 
	`©omic_šc
(&
pblk
->
šæight_io
);

315 
	`__pblk_’d_io_»ad
(
pblk
, 
rqd
, 
çl£
);

316 } ià(
Ä_£cs
 !ð
rqd
->
Ä_µas
) {

323 
¥l™_bio
 = 
	`bio_¥l™
(
bio
, 
Ä_£cs
 * 
NR_PHY_IN_LOG
, 
GFP_KERNEL
,

324 &
pblk_bio_£t
);

325 
	`bio_chaš
(
¥l™_bio
, 
bio
);

326 
	`g’”ic_make_»que¡
(
bio
);

334 
bio
 = 
¥l™_bio
;

335 
rqd
->
Ä_µas
 = 
Ä_£cs
;

336 ià(
rqd
->
Ä_µas
 == 1)

337 
rqd
->
µa_addr
 =„qd->
µa_li¡
[0];

342 
	`bio_put
(
št_bio
);

343 
št_bio
 = 
	`bio_þÚe_ç¡
(
bio
, 
GFP_KERNEL
, &
pblk_bio_£t
);

344 
¥l™_»Œy
;

345 } ià(
	`pblk_subm™_io
(
pblk
, 
rqd
)) {

347 
rqd
->
”rÜ
 = -
ENODEV
;

348 
	`pblk_’d_io_»ad
(
rqd
);

350 
	}
}

352 
	$»ad_µ®i¡_rq_gc
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

353 
pblk_lše
 *
lše
, 
u64
 *
lba_li¡
,

354 
u64
 *
·ddr_li¡_gc
, 
Ä_£cs
)

356 
µa_addr
 
µa_li¡_l2p
[
NVM_MAX_VLBA
];

357 
µa_addr
 
µa_gc
;

358 
v®id_£cs
 = 0;

359 
i
;

361 
	`pblk_lookup_l2p_¿nd
(
pblk
, 
µa_li¡_l2p
, 
lba_li¡
, 
Ä_£cs
);

363 
i
 = 0; i < 
Ä_£cs
; i++) {

364 ià(
lba_li¡
[
i
] =ð
ADDR_EMPTY
)

367 
µa_gc
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr_li¡_gc
[
i
], 
lše
->
id
);

368 ià(!
	`pblk_µa_comp
(
µa_li¡_l2p
[
i
], 
µa_gc
)) {

369 
·ddr_li¡_gc
[
i
] = 
lba_li¡
[i] = 
ADDR_EMPTY
;

373 
rqd
->
µa_li¡
[
v®id_£cs
++] = 
µa_li¡_l2p
[
i
];

376 #ifdeà
CONFIG_NVM_PBLK_DEBUG


377 
	`©omic_lÚg_add
(
v®id_£cs
, &
pblk
->
šæight_»ads
);

380  
v®id_£cs
;

381 
	}
}

383 
	$»ad_rq_gc
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

384 
pblk_lše
 *
lše
, 
£ùÜ_t
 
lba
,

385 
u64
 
·ddr_gc
)

387 
µa_addr
 
µa_l2p
, 
µa_gc
;

388 
v®id_£cs
 = 0;

390 ià(
lba
 =ð
ADDR_EMPTY
)

391 
out
;

394 ià(
lba
 >ð
pblk
->
ÿ·c™y
) {

395 
	`WARN
(1, "pblk:„ead†ba out of bounds\n");

396 
out
;

399 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

400 
µa_l2p
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
lba
);

401 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

403 
µa_gc
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr_gc
, 
lše
->
id
);

404 ià(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_gc
))

405 
out
;

407 
rqd
->
µa_addr
 = 
µa_l2p
;

408 
v®id_£cs
 = 1;

410 #ifdeà
CONFIG_NVM_PBLK_DEBUG


411 
	`©omic_lÚg_šc
(&
pblk
->
šæight_»ads
);

414 
out
:

415  
v®id_£cs
;

416 
	}
}

418 
	$pblk_subm™_»ad_gc
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
)

420 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

421 
nvm_geo
 *
geo
 = &
dev
->geo;

422 
bio
 *bio;

423 
nvm_rq
 
rqd
;

424 
d©a_Ën
;

425 
»t
 = 
NVM_IO_OK
;

427 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

429 
»t
 = 
	`pblk_®loc_rqd_m‘a
(
pblk
, &
rqd
);

430 ià(
»t
)

431  
»t
;

433 ià(
gc_rq
->
Ä_£cs
 > 1) {

434 
gc_rq
->
£cs_to_gc
 = 
	`»ad_µ®i¡_rq_gc
(
pblk
, &
rqd
, gc_rq->
lše
,

435 
gc_rq
->
lba_li¡
,

436 
gc_rq
->
·ddr_li¡
,

437 
gc_rq
->
Ä_£cs
);

438 ià(
gc_rq
->
£cs_to_gc
 == 1)

439 
rqd
.
µa_addr
 =„qd.
µa_li¡
[0];

441 
gc_rq
->
£cs_to_gc
 = 
	`»ad_rq_gc
(
pblk
, &
rqd
, gc_rq->
lše
,

442 
gc_rq
->
lba_li¡
[0],

443 
gc_rq
->
·ddr_li¡
[0]);

446 ià(!(
gc_rq
->
£cs_to_gc
))

447 
out
;

449 
d©a_Ën
 = (
gc_rq
->
£cs_to_gc
è* 
geo
->
c£cs
;

450 
bio
 = 
	`pblk_bio_m­_addr
(
pblk
, 
gc_rq
->
d©a
, gc_rq->
£cs_to_gc
, 
d©a_Ën
,

451 
PBLK_VMALLOC_META
, 
GFP_KERNEL
);

452 ià(
	`IS_ERR
(
bio
)) {

453 
	`pblk_”r
(
pblk
, "could‚ot‡llocate GC bio (%lu)\n",

454 
	`PTR_ERR
(
bio
));

455 
»t
 = 
	`PTR_ERR
(
bio
);

456 
”r_ä“_dma
;

459 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

460 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

462 
rqd
.
Ýcode
 = 
NVM_OP_PREAD
;

463 
rqd
.
Ä_µas
 = 
gc_rq
->
£cs_to_gc
;

464 
rqd
.
bio
 = bio;

466 ià(
	`pblk_subm™_io_sync
(
pblk
, &
rqd
)) {

467 
»t
 = -
EIO
;

468 
”r_ä“_bio
;

471 
	`pblk_»ad_check_¿nd
(
pblk
, &
rqd
, 
gc_rq
->
lba_li¡
, gc_rq->
Ä_£cs
);

473 
	`©omic_dec
(&
pblk
->
šæight_io
);

475 ià(
rqd
.
”rÜ
) {

476 
	`©omic_lÚg_šc
(&
pblk
->
»ad_çžed_gc
);

477 #ifdeà
CONFIG_NVM_PBLK_DEBUG


478 
	`pblk_´št_çžed_rqd
(
pblk
, &
rqd
,„qd.
”rÜ
);

482 #ifdeà
CONFIG_NVM_PBLK_DEBUG


483 
	`©omic_lÚg_add
(
gc_rq
->
£cs_to_gc
, &
pblk
->
sync_»ads
);

484 
	`©omic_lÚg_add
(
gc_rq
->
£cs_to_gc
, &
pblk
->
»cov_gc_»ads
);

485 
	`©omic_lÚg_sub
(
gc_rq
->
£cs_to_gc
, &
pblk
->
šæight_»ads
);

488 
out
:

489 
	`pblk_ä“_rqd_m‘a
(
pblk
, &
rqd
);

490  
»t
;

492 
”r_ä“_bio
:

493 
	`bio_put
(
bio
);

494 
”r_ä“_dma
:

495 
	`pblk_ä“_rqd_m‘a
(
pblk
, &
rqd
);

496  
»t
;

497 
	}
}

	@pblk-recovery.c

21 
	~"pblk.h
"

22 
	~"pblk-Œaû.h
"

24 
	$pblk_»cov_check_em‘a
(
pblk
 *pblk, 
lše_em‘a
 *
em‘a_buf
)

26 
u32
 
üc
;

28 
üc
 = 
	`pblk_ÿlc_em‘a_üc
(
pblk
, 
em‘a_buf
);

29 ià(
	`Ë32_to_ýu
(
em‘a_buf
->
üc
) != crc)

32 ià(
	`Ë32_to_ýu
(
em‘a_buf
->
h—d”
.
id’tif›r
è!ð
PBLK_MAGIC
)

36 
	}
}

38 
	$pblk_»cov_l2p_äom_em‘a
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

40 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

41 
nvm_geo
 *
geo
 = &
dev
->geo;

42 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

43 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

44 
lše_em‘a
 *
em‘a_buf
 = 
em‘a
->
buf
;

45 
__Ë64
 *
lba_li¡
;

46 
u64
 
d©a_¡¬t
, 
d©a_’d
;

47 
u64
 
Ä_v®id_lbas
, 
Ä_lbas
 = 0;

48 
u64
 
i
;

50 
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
em‘a_buf
);

51 ià(!
lba_li¡
)

54 
d©a_¡¬t
 = 
	`pblk_lše_sm‘a_¡¬t
(
pblk
, 
lše
è+ 
lm
->
sm‘a_£c
;

55 
d©a_’d
 = 
lše
->
em‘a_s£c
;

56 
Ä_v®id_lbas
 = 
	`Ë64_to_ýu
(
em‘a_buf
->nr_valid_lbas);

58 
i
 = 
d©a_¡¬t
; i < 
d©a_’d
; i++) {

59 
µa_addr
 
µa
;

60 
pos
;

62 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
i
, 
lše
->
id
);

63 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

66 ià(
	`‹¡_b™
(
pos
, 
lše
->
blk_b™m­
))

69 ià(
	`Ë64_to_ýu
(
lba_li¡
[
i
]è=ð
ADDR_EMPTY
) {

70 
	`¥š_lock
(&
lše
->
lock
);

71 ià(
	`‹¡_ªd_£t_b™
(
i
, 
lše
->
šv®id_b™m­
))

72 
	`WARN_ONCE
(1, "pblk:„ec. double invalidate:\n");

74 
	`Ë32_add_ýu
(
lše
->
vsc
, -1);

75 
	`¥š_uÆock
(&
lše
->
lock
);

80 
	`pblk_upd©e_m­
(
pblk
, 
	`Ë64_to_ýu
(
lba_li¡
[
i
]), 
µa
);

81 
Ä_lbas
++;

84 ià(
Ä_v®id_lbas
 !ð
Ä_lbas
)

85 
	`pblk_”r
(
pblk
, "line %d - inconsistent†ba†ist(%llu/%llu)\n",

86 
lše
->
id
, 
Ä_v®id_lbas
, 
Ä_lbas
);

88 
lše
->
Ëá_m£cs
 = 0;

91 
	}
}

93 
	$pblk_upd©e_lše_wp
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

94 
u64
 
wr™‹n_£cs
)

96 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

97 
i
;

99 
i
 = 0; i < 
wr™‹n_£cs
; i +ð
pblk
->
mš_wr™e_pgs
)

100 
	`__pblk_®loc_·ge
(
pblk
, 
lše
,…blk->
mš_wr™e_pgs
);

102 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

103 ià(
wr™‹n_£cs
 > 
lše
->
Ëá_m£cs
) {

108 
lše
->
Ëá_m£cs
 = 0;

111 
lše
->
Ëá_m£cs
 -ð
wr™‹n_£cs
;

113 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

114 
	}
}

116 
u64
 
	$pblk_£c_š_Ý’_lše
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

118 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

119 
Ä_bb
 = 
	`b™m­_weight
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

120 
u64
 
wr™‹n_£cs
 = 0;

121 
v®id_chunks
 = 0;

122 
i
;

124 
i
 = 0; i < 
lm
->
blk_³r_lše
; i++) {

125 
nvm_chk_m‘a
 *
chunk
 = &
lše
->
chks
[
i
];

127 ià(
chunk
->
¡©e
 & 
NVM_CHK_ST_OFFLINE
)

130 
wr™‹n_£cs
 +ð
chunk
->
wp
;

131 
v®id_chunks
++;

134 ià(
lm
->
blk_³r_lše
 - 
Ä_bb
 !ð
v®id_chunks
)

135 
	`pblk_”r
(
pblk
, "»cov”y†š%d i bad\n", 
lše
->
id
);

137 
	`pblk_upd©e_lše_wp
(
pblk
, 
lše
, 
wr™‹n_£cs
 - 
lm
->
sm‘a_£c
);

139  
wr™‹n_£cs
;

140 
	}
}

142 
	spblk_»cov_®loc
 {

143 
µa_addr
 *
	mµa_li¡
;

144 *
	mm‘a_li¡
;

145 
nvm_rq
 *
	mrqd
;

146 *
	md©a
;

147 
dma_addr_t
 
	mdma_µa_li¡
;

148 
dma_addr_t
 
	mdma_m‘a_li¡
;

151 
	$pblk_»cov_com¶‘e
(
k»f
 *
»f
)

153 
pblk_·d_rq
 *
·d_rq
 = 
	`cÚš”_of
(
»f
, pblk_pad_rq,„ef);

155 
	`com¶‘e
(&
·d_rq
->
wa™
);

156 
	}
}

158 
	$pblk_’d_io_»cov
(
nvm_rq
 *
rqd
)

160 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

161 
pblk_·d_rq
 *
·d_rq
 = 
rqd
->
´iv©e
;

162 
pblk
 *pblk = 
·d_rq
->pblk;

164 
	`pblk_up_chunk
(
pblk
, 
µa_li¡
[0]);

166 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

168 
	`©omic_dec
(&
pblk
->
šæight_io
);

169 
	`k»f_put
(&
·d_rq
->
»f
, 
pblk_»cov_com¶‘e
);

170 
	}
}

173 
	$pblk_»cov_·d_lše
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

174 
Ëá_µas
)

176 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

177 
nvm_geo
 *
geo
 = &
dev
->geo;

178 *
m‘a_li¡
;

179 
pblk_·d_rq
 *
·d_rq
;

180 
nvm_rq
 *
rqd
;

181 
bio
 *bio;

182 
µa_addr
 *
µa_li¡
;

183 *
d©a
;

184 
__Ë64
 *
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
lše
->
em‘a
->
buf
);

185 
u64
 
w_±r
 = 
lše
->
cur_£c
;

186 
Ëá_lše_µas
, 
rq_µas
, 
rq_Ën
;

187 
i
, 
j
;

188 
»t
 = 0;

190 
	`¥š_lock
(&
lše
->
lock
);

191 
Ëá_lše_µas
 = 
lše
->
Ëá_m£cs
;

192 
	`¥š_uÆock
(&
lše
->
lock
);

194 
·d_rq
 = 
	`km®loc
((
pblk_·d_rq
), 
GFP_KERNEL
);

195 ià(!
·d_rq
)

196  -
ENOMEM
;

198 
d©a
 = 
	`vz®loc
(
	`¬¿y_size
(
pblk
->
max_wr™e_pgs
, 
geo
->
c£cs
));

199 ià(!
d©a
) {

200 
»t
 = -
ENOMEM
;

201 
ä“_rq
;

204 
·d_rq
->
pblk
 =…blk;

205 
	`š™_com¶‘iÚ
(&
·d_rq
->
wa™
);

206 
	`k»f_š™
(&
·d_rq
->
»f
);

208 
Ãxt_·d_rq
:

209 
rq_µas
 = 
	`pblk_ÿlc_£cs
(
pblk
, 
Ëá_µas
, 0, 
çl£
);

210 ià(
rq_µas
 < 
pblk
->
mš_wr™e_pgs
) {

211 
	`pblk_”r
(
pblk
, "cÜru±ed…ad†š%d\n", 
lše
->
id
);

212 
çž_com¶‘e
;

215 
rq_Ën
 = 
rq_µas
 * 
geo
->
c£cs
;

217 
bio
 = 
	`pblk_bio_m­_addr
(
pblk
, 
d©a
, 
rq_µas
, 
rq_Ën
,

218 
PBLK_VMALLOC_META
, 
GFP_KERNEL
);

219 ià(
	`IS_ERR
(
bio
)) {

220 
»t
 = 
	`PTR_ERR
(
bio
);

221 
çž_com¶‘e
;

224 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

225 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

227 
rqd
 = 
	`pblk_®loc_rqd
(
pblk
, 
PBLK_WRITE_INT
);

229 
»t
 = 
	`pblk_®loc_rqd_m‘a
(
pblk
, 
rqd
);

230 ià(
»t
) {

231 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

232 
	`bio_put
(
bio
);

233 
çž_com¶‘e
;

236 
rqd
->
bio
 = bio;

237 
rqd
->
Ýcode
 = 
NVM_OP_PWRITE
;

238 
rqd
->
is_£q
 = 1;

239 
rqd
->
Ä_µas
 = 
rq_µas
;

240 
rqd
->
’d_io
 = 
pblk_’d_io_»cov
;

241 
rqd
->
´iv©e
 = 
·d_rq
;

243 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

244 
m‘a_li¡
 = 
rqd
->meta_list;

246 
i
 = 0; i < 
rqd
->
Ä_µas
; ) {

247 
µa_addr
 
µa
;

248 
pos
;

250 
w_±r
 = 
	`pblk_®loc_·ge
(
pblk
, 
lše
,…blk->
mš_wr™e_pgs
);

251 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
w_±r
, 
lše
->
id
);

252 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

254 
	`‹¡_b™
(
pos
, 
lše
->
blk_b™m­
)) {

255 
w_±r
 +ð
pblk
->
mš_wr™e_pgs
;

256 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
w_±r
, 
lše
->
id
);

257 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

260 
j
 = 0; j < 
pblk
->
mš_wr™e_pgs
; j++, 
i
++, 
w_±r
++) {

261 
µa_addr
 
dev_µa
;

262 
pblk_£c_m‘a
 *
m‘a
;

263 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

265 
dev_µa
 = 
	`addr_to_g’_µa
(
pblk
, 
w_±r
, 
lše
->
id
);

267 
	`pblk_m­_šv®id©e
(
pblk
, 
dev_µa
);

268 
lba_li¡
[
w_±r
] = 
addr_em±y
;

269 
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

270 
m‘a
->
lba
 = 
addr_em±y
;

271 
µa_li¡
[
i
] = 
dev_µa
;

275 
	`k»f_g‘
(&
·d_rq
->
»f
);

276 
	`pblk_down_chunk
(
pblk
, 
µa_li¡
[0]);

278 
»t
 = 
	`pblk_subm™_io
(
pblk
, 
rqd
);

279 ià(
»t
) {

280 
	`pblk_”r
(
pblk
, "I/O submissiÚ fažed: %d\n", 
»t
);

281 
	`pblk_up_chunk
(
pblk
, 
µa_li¡
[0]);

282 
	`k»f_put
(&
·d_rq
->
»f
, 
pblk_»cov_com¶‘e
);

283 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

284 
	`bio_put
(
bio
);

285 
çž_com¶‘e
;

288 
Ëá_lše_µas
 -ð
rq_µas
;

289 
Ëá_µas
 -ð
rq_µas
;

290 ià(
Ëá_µas
 && 
Ëá_lše_µas
)

291 
Ãxt_·d_rq
;

293 
çž_com¶‘e
:

294 
	`k»f_put
(&
·d_rq
->
»f
, 
pblk_»cov_com¶‘e
);

295 
	`wa™_fÜ_com¶‘iÚ
(&
·d_rq
->
wa™
);

297 ià(!
	`pblk_lše_is_fuÎ
(
lše
))

298 
	`pblk_”r
(
pblk
, "cÜru±ed…added†še: %d\n", 
lše
->
id
);

300 
	`vä“
(
d©a
);

301 
ä“_rq
:

302 
	`kä“
(
·d_rq
);

303  
»t
;

304 
	}
}

306 
	$pblk_·d_di¡ªû
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

308 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

309 
nvm_geo
 *
geo
 = &
dev
->geo;

310 
di¡ªû
 = 
geo
->
mw_cun™s
 * geo->
®l_luns
 * geo->
ws_Ýt
;

312  (
di¡ªû
 > 
lše
->
Ëá_m£cs
) ?†ine->left_msecs : distance;

313 
	}
}

316 
nvm_chk_m‘a
 *
	$pblk_g‘_¡re_chunk
(
pblk
 *pblk,

317 
pblk_lše
 *
lše
,

318 
šdex
)

320 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

321 
nvm_geo
 *
geo
 = &
dev
->geo;

322 
pblk_lun
 *
¾un
;

323 
µa_addr
 
µa
;

324 
pos
;

326 
¾un
 = &
pblk
->
luns
[
šdex
];

327 
µa
 = 
¾un
->
bµa
;

328 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

330  &
lše
->
chks
[
pos
];

331 
	}
}

333 
	$pblk_lše_wps_¬e_unb®ªûd
(
pblk
 *pblk,

334 
pblk_lše
 *
lše
)

336 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

337 
blk_š_lše
 = 
lm
->
blk_³r_lše
;

338 
nvm_chk_m‘a
 *
chunk
;

339 
u64
 
max_wp
, 
mš_wp
;

340 
i
;

342 
i
 = 
	`fšd_fœ¡_z”o_b™
(
lše
->
blk_b™m­
, 
blk_š_lše
);

347 ià(
i
 >ð(
blk_š_lše
 - 1))

350 
chunk
 = 
	`pblk_g‘_¡re_chunk
(
pblk
, 
lše
, 
i
);

351 
max_wp
 = 
chunk
->
wp
;

352 ià(
max_wp
 > 
pblk
->
max_wr™e_pgs
)

353 
mš_wp
 = 
max_wp
 - 
pblk
->
max_wr™e_pgs
;

355 
mš_wp
 = 0;

357 
i
 = 
	`fšd_Ãxt_z”o_b™
(
lše
->
blk_b™m­
, 
blk_š_lše
, i + 1);

358 
i
 < 
blk_š_lše
) {

359 
chunk
 = 
	`pblk_g‘_¡re_chunk
(
pblk
, 
lše
, 
i
);

360 ià(
chunk
->
wp
 > 
max_wp
 || chunk->w°< 
mš_wp
)

363 
i
 = 
	`fšd_Ãxt_z”o_b™
(
lše
->
blk_b™m­
, 
blk_š_lše
, i + 1);

367 
	}
}

369 
	$pblk_»cov_sÿn_oob
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

370 
pblk_»cov_®loc
 
p
)

372 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

373 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

374 
nvm_geo
 *
geo
 = &
dev
->geo;

375 
µa_addr
 *
µa_li¡
;

376 *
m‘a_li¡
;

377 
nvm_rq
 *
rqd
;

378 
bio
 *bio;

379 *
d©a
;

380 
dma_addr_t
 
dma_µa_li¡
, 
dma_m‘a_li¡
;

381 
__Ë64
 *
lba_li¡
;

382 
u64
 
·ddr
 = 
	`pblk_lše_sm‘a_¡¬t
(
pblk
, 
lše
è+ 
lm
->
sm‘a_£c
;

383 
boÞ
 
·dded
 = 
çl£
;

384 
rq_µas
, 
rq_Ën
;

385 
i
, 
j
;

386 
»t
;

387 
u64
 
Ëá_µas
 = 
	`pblk_£c_š_Ý’_lše
(
pblk
, 
lše
è- 
lm
->
sm‘a_£c
;

389 ià(
	`pblk_lše_wps_¬e_unb®ªûd
(
pblk
, 
lše
))

390 
	`pblk_w¬n
(
pblk
, "»cov”šg unb®ªûd†š(%d)\n", 
lše
->
id
);

392 
µa_li¡
 = 
p
.ppa_list;

393 
m‘a_li¡
 = 
p
.meta_list;

394 
rqd
 = 
p
.rqd;

395 
d©a
 = 
p
.data;

396 
dma_µa_li¡
 = 
p
.dma_ppa_list;

397 
dma_m‘a_li¡
 = 
p
.dma_meta_list;

399 
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
lše
->
em‘a
->
buf
);

401 
Ãxt_rq
:

402 
	`mem£t
(
rqd
, 0, 
pblk_g_rq_size
);

404 
rq_µas
 = 
	`pblk_ÿlc_£cs
(
pblk
, 
Ëá_µas
, 0, 
çl£
);

405 ià(!
rq_µas
)

406 
rq_µas
 = 
pblk
->
mš_wr™e_pgs
;

407 
rq_Ën
 = 
rq_µas
 * 
geo
->
c£cs
;

409 
»Œy_rq
:

410 
bio
 = 
	`bio_m­_k”n
(
dev
->
q
, 
d©a
, 
rq_Ën
, 
GFP_KERNEL
);

411 ià(
	`IS_ERR
(
bio
))

412  
	`PTR_ERR
(
bio
);

414 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

415 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

416 
	`bio_g‘
(
bio
);

418 
rqd
->
bio
 = bio;

419 
rqd
->
Ýcode
 = 
NVM_OP_PREAD
;

420 
rqd
->
m‘a_li¡
 = meta_list;

421 
rqd
->
Ä_µas
 = 
rq_µas
;

422 
rqd
->
µa_li¡
 =…pa_list;

423 
rqd
->
dma_µa_li¡
 = dma_ppa_list;

424 
rqd
->
dma_m‘a_li¡
 = dma_meta_list;

425 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

427 ià(
	`pblk_io_®igÃd
(
pblk
, 
rq_µas
))

428 
rqd
->
is_£q
 = 1;

430 
i
 = 0; i < 
rqd
->
Ä_µas
; ) {

431 
µa_addr
 
µa
;

432 
pos
;

434 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše
->
id
);

435 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

437 
	`‹¡_b™
(
pos
, 
lše
->
blk_b™m­
)) {

438 
·ddr
 +ð
pblk
->
mš_wr™e_pgs
;

439 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
lše
->
id
);

440 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

443 
j
 = 0; j < 
pblk
->
mš_wr™e_pgs
; j++, 
i
++)

444 
µa_li¡
[
i
] =

445 
	`addr_to_g’_µa
(
pblk
, 
·ddr
 + 
j
, 
lše
->
id
);

448 
»t
 = 
	`pblk_subm™_io_sync
(
pblk
, 
rqd
);

449 ià(
»t
) {

450 
	`pblk_”r
(
pblk
, "I/O submissiÚ fažed: %d\n", 
»t
);

451 
	`bio_put
(
bio
);

452  
»t
;

455 
	`©omic_dec
(&
pblk
->
šæight_io
);

458 ià(
rqd
->
”rÜ
 &&„qd->”rÜ !ð
NVM_RSP_WARN_HIGHECC
) {

459 
·d_di¡ªû
, 
»t
;

461 ià(
·dded
) {

462 
	`pblk_log_»ad_”r
(
pblk
, 
rqd
);

463 
	`bio_put
(
bio
);

464  -
EINTR
;

467 
·d_di¡ªû
 = 
	`pblk_·d_di¡ªû
(
pblk
, 
lše
);

468 
»t
 = 
	`pblk_»cov_·d_lše
(
pblk
, 
lše
, 
·d_di¡ªû
);

469 ià(
»t
) {

470 
	`bio_put
(
bio
);

471  
»t
;

474 
·dded
 = 
Œue
;

475 
	`bio_put
(
bio
);

476 
»Œy_rq
;

479 
	`pblk_g‘_·cked_m‘a
(
pblk
, 
rqd
);

480 
	`bio_put
(
bio
);

482 
i
 = 0; i < 
rqd
->
Ä_µas
; i++) {

483 
pblk_£c_m‘a
 *
m‘a
 = 
	`pblk_g‘_m‘a
(
pblk
, 
m‘a_li¡
, 
i
);

484 
u64
 
lba
 = 
	`Ë64_to_ýu
(
m‘a
->lba);

486 
lba_li¡
[
·ddr
++] = 
	`ýu_to_Ë64
(
lba
);

488 ià(
lba
 =ð
ADDR_EMPTY
 ||†b¨>ð
pblk
->
ÿ·c™y
)

491 
lše
->
Ä_v®id_lbas
++;

492 
	`pblk_upd©e_m­
(
pblk
, 
lba
, 
µa_li¡
[
i
]);

495 
Ëá_µas
 -ð
rq_µas
;

496 ià(
Ëá_µas
 > 0)

497 
Ãxt_rq
;

499 #ifdeà
CONFIG_NVM_PBLK_DEBUG


500 
	`WARN_ON
(
·dded
 && !
	`pblk_lše_is_fuÎ
(
lše
));

504 
	}
}

507 
	$pblk_»cov_l2p_äom_oob
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

509 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

510 
nvm_geo
 *
geo
 = &
dev
->geo;

511 
nvm_rq
 *
rqd
;

512 
µa_addr
 *
µa_li¡
;

513 *
m‘a_li¡
;

514 
pblk_»cov_®loc
 
p
;

515 *
d©a
;

516 
dma_addr_t
 
dma_µa_li¡
, 
dma_m‘a_li¡
;

517 
»t
 = 0;

519 
m‘a_li¡
 = 
	`nvm_dev_dma_®loc
(
dev
->
·»Á
, 
GFP_KERNEL
, &
dma_m‘a_li¡
);

520 ià(!
m‘a_li¡
)

521  -
ENOMEM
;

523 
µa_li¡
 = (*)(
m‘a_li¡
è+ 
	`pblk_dma_m‘a_size
(
pblk
);

524 
dma_µa_li¡
 = 
dma_m‘a_li¡
 + 
	`pblk_dma_m‘a_size
(
pblk
);

526 
d©a
 = 
	`kÿÎoc
(
pblk
->
max_wr™e_pgs
, 
geo
->
c£cs
, 
GFP_KERNEL
);

527 ià(!
d©a
) {

528 
»t
 = -
ENOMEM
;

529 
ä“_m‘a_li¡
;

532 
rqd
 = 
	`mempoÞ_®loc
(&
pblk
->
r_rq_poÞ
, 
GFP_KERNEL
);

533 
	`mem£t
(
rqd
, 0, 
pblk_g_rq_size
);

535 
p
.
µa_li¡
 =…pa_list;

536 
p
.
m‘a_li¡
 = meta_list;

537 
p
.
rqd
 =„qd;

538 
p
.
d©a
 = data;

539 
p
.
dma_µa_li¡
 = dma_ppa_list;

540 
p
.
dma_m‘a_li¡
 = dma_meta_list;

542 
»t
 = 
	`pblk_»cov_sÿn_oob
(
pblk
, 
lše
, 
p
);

543 ià(
»t
) {

544 
	`pblk_”r
(
pblk
, "could‚ot„ecover L2P form OOB\n");

545 
out
;

548 ià(
	`pblk_lše_is_fuÎ
(
lše
))

549 
	`pblk_lše_»cov_þo£
(
pblk
, 
lše
);

551 
out
:

552 
	`mempoÞ_ä“
(
rqd
, &
pblk
->
r_rq_poÞ
);

553 
	`kä“
(
d©a
);

554 
ä“_m‘a_li¡
:

555 
	`nvm_dev_dma_ä“
(
dev
->
·»Á
, 
m‘a_li¡
, 
dma_m‘a_li¡
);

557  
»t
;

558 
	}
}

561 
	$pblk_»cov_lše_add_Üd”ed
(
li¡_h—d
 *
h—d
,

562 
pblk_lše
 *
lše
)

564 
pblk_lše
 *
t
 = 
NULL
;

566 
	`li¡_fÜ_—ch_’Œy
(
t
, 
h—d
, 
li¡
)

567 ià(
t
->
£q_Ä
 > 
lše
->seq_nr)

570 
	`__li¡_add
(&
lše
->
li¡
, 
t
->li¡.
´ev
, &t->list);

571 
	}
}

573 
u64
 
	$pblk_lše_em‘a_¡¬t
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

575 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

576 
nvm_geo
 *
geo
 = &
dev
->geo;

577 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

578 
em‘a_£cs
;

579 
u64
 
em‘a_¡¬t
;

580 
µa_addr
 
µa
;

581 
pos
;

583 
em‘a_£cs
 = 
lm
->
em‘a_£c
[0];

584 
em‘a_¡¬t
 = 
lm
->
£c_³r_lše
;

586 
em‘a_£cs
) {

587 
em‘a_¡¬t
--;

588 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
em‘a_¡¬t
, 
lše
->
id
);

589 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

590 ià(!
	`‹¡_b™
(
pos
, 
lše
->
blk_b™m­
))

591 
em‘a_£cs
--;

594  
em‘a_¡¬t
;

595 
	}
}

597 
	$pblk_»cov_check_lše_v”siÚ
(
pblk
 *pblk,

598 
lše_em‘a
 *
em‘a
)

600 
lše_h—d”
 *
h—d”
 = &
em‘a
->header;

602 ià(
h—d”
->
v”siÚ_majÜ
 !ð
EMETA_VERSION_MAJOR
) {

603 
	`pblk_”r
(
pblk
, "line major version mismatch: %d,ƒxpected: %d\n",

604 
h—d”
->
v”siÚ_majÜ
, 
EMETA_VERSION_MAJOR
);

608 #ifdeà
CONFIG_NVM_PBLK_DEBUG


609 ià(
h—d”
->
v”siÚ_mšÜ
 > 
EMETA_VERSION_MINOR
)

610 
	`pblk_šfo
(
pblk
, "newer†ine minor version found: %d\n",

611 
h—d”
->
v”siÚ_mšÜ
);

615 
	}
}

617 
	$pblk_»cov_wa_couÁ”s
(
pblk
 *pblk,

618 
lše_em‘a
 *
em‘a
)

620 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

621 
lše_h—d”
 *
h—d”
 = &
em‘a
->header;

622 
wa_couÁ”s
 *
wa
 = 
	`em‘a_to_wa
(
lm
, 
em‘a
);

625 ià(
h—d”
->
v”siÚ_majÜ
 > 0 || h—d”->
v”siÚ_mšÜ
 >= 2) {

626 
u64
 
u£r
 = 
	`Ë64_to_ýu
(
wa
->user);

627 
u64
 
·d
 = 
	`Ë64_to_ýu
(
wa
->pad);

628 
u64
 
gc
 = 
	`Ë64_to_ýu
(
wa
->gc);

630 
	`©omic64_£t
(&
pblk
->
u£r_wa
, 
u£r
);

631 
	`©omic64_£t
(&
pblk
->
·d_wa
, 
·d
);

632 
	`©omic64_£t
(&
pblk
->
gc_wa
, 
gc
);

634 
pblk
->
u£r_r¡_wa
 = 
u£r
;

635 
pblk
->
·d_r¡_wa
 = 
·d
;

636 
pblk
->
gc_r¡_wa
 = 
gc
;

638 
	}
}

640 
	$pblk_lše_was_wr™‹n
(
pblk_lše
 *
lše
,

641 
pblk
 *pblk)

644 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

645 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

646 
nvm_geo
 *
geo
 = &
dev
->geo;

647 
nvm_chk_m‘a
 *
chunk
;

648 
µa_addr
 
bµa
;

649 
sm‘a_blk
;

651 ià(
lše
->
¡©e
 =ð
PBLK_LINESTATE_BAD
)

654 
sm‘a_blk
 = 
	`fšd_fœ¡_z”o_b™
(
lše
->
blk_b™m­
, 
lm
->
blk_³r_lše
);

655 ià(
sm‘a_blk
 >ð
lm
->
blk_³r_lše
)

658 
bµa
 = 
pblk
->
luns
[
sm‘a_blk
].bppa;

659 
chunk
 = &
lše
->
chks
[
	`pblk_µa_to_pos
(
geo
, 
bµa
)];

661 ià(
chunk
->
¡©e
 & 
NVM_CHK_ST_CLOSED
 ||

662 (
chunk
->
¡©e
 & 
NVM_CHK_ST_OPEN


663 && 
chunk
->
wp
 >ð
lm
->
sm‘a_£c
))

667 
	}
}

669 
boÞ
 
	$pblk_lše_is_Ý’
(
pblk
 *pblk, 
pblk_lše
 *
lše
)

671 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

672 
i
;

674 
i
 = 0; i < 
lm
->
blk_³r_lše
; i++)

675 ià(
lše
->
chks
[
i
].
¡©e
 & 
NVM_CHK_ST_OPEN
)

676  
Œue
;

678  
çl£
;

679 
	}
}

681 
pblk_lše
 *
	$pblk_»cov_l2p
(
pblk
 *pblk)

683 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

684 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

685 
pblk_lše
 *
lše
, *
Žše
, *
d©a_lše
 = 
NULL
;

686 
pblk_sm‘a
 *
sm‘a
;

687 
pblk_em‘a
 *
em‘a
;

688 
lše_sm‘a
 *
sm‘a_buf
;

689 
found_lšes
 = 0, 
»cov”ed_lšes
 = 0, 
Ý’_lšes
 = 0;

690 
is_Ãxt
 = 0;

691 
m‘a_lše
;

692 
i
, 
v®id_uuid
 = 0;

693 
	`LIST_HEAD
(
»cov_li¡
);

698 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

699 
m‘a_lše
 = 
	`fšd_fœ¡_z”o_b™
(&
l_mg
->
m‘a_b™m­
, 
PBLK_DATA_LINES
);

700 
	`£t_b™
(
m‘a_lše
, &
l_mg
->
m‘a_b™m­
);

701 
sm‘a
 = 
l_mg
->
¦še_m‘a
[
m‘a_lše
];

702 
em‘a
 = 
l_mg
->
–še_m‘a
[
m‘a_lše
];

703 
sm‘a_buf
 = (
lše_sm‘a
 *)
sm‘a
;

704 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

707 
i
 = 0; i < 
l_mg
->
Ä_lšes
; i++) {

708 
u32
 
üc
;

710 
lše
 = &
pblk
->
lšes
[
i
];

712 
	`mem£t
(
sm‘a
, 0, 
lm
->
sm‘a_Ën
);

713 
lše
->
sm‘a
 = smeta;

714 
lše
->
lun_b™m­
 = ((*)(
sm‘a_buf
)) +

715 (
lše_sm‘a
);

717 ià(!
	`pblk_lše_was_wr™‹n
(
lše
, 
pblk
))

721 ià(
	`pblk_lše_sm‘a_»ad
(
pblk
, 
lše
))

724 
üc
 = 
	`pblk_ÿlc_sm‘a_üc
(
pblk
, 
sm‘a_buf
);

725 ià(
	`Ë32_to_ýu
(
sm‘a_buf
->
üc
) != crc)

728 ià(
	`Ë32_to_ýu
(
sm‘a_buf
->
h—d”
.
id’tif›r
è!ð
PBLK_MAGIC
)

731 ià(
sm‘a_buf
->
h—d”
.
v”siÚ_majÜ
 !ð
SMETA_VERSION_MAJOR
) {

732 
	`pblk_”r
(
pblk
, "found incompatible†ine version %u\n",

733 
sm‘a_buf
->
h—d”
.
v”siÚ_majÜ
);

734  
	`ERR_PTR
(-
EINVAL
);

738 ià(!
v®id_uuid
) {

739 
	`guid_cÝy
(&
pblk
->
š¡ªû_uuid
,

740 (
guid_t
 *)&
sm‘a_buf
->
h—d”
.
uuid
);

741 
v®id_uuid
 = 1;

744 ià(!
	`guid_equ®
(&
pblk
->
š¡ªû_uuid
,

745 (
guid_t
 *)&
sm‘a_buf
->
h—d”
.
uuid
)) {

746 
	`pblk_debug
(
pblk
, "ignore†ine %u dueo uuid mismatch\n",

747 
i
);

752 
	`¥š_lock
(&
lše
->
lock
);

753 
lše
->
id
 = 
	`Ë32_to_ýu
(
sm‘a_buf
->
h—d”
.id);

754 
lše
->
ty³
 = 
	`Ë16_to_ýu
(
sm‘a_buf
->
h—d”
.type);

755 
lše
->
£q_Ä
 = 
	`Ë64_to_ýu
(
sm‘a_buf
->seq_nr);

756 
	`¥š_uÆock
(&
lše
->
lock
);

759 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

760 ià(
lše
->
£q_Ä
 >ð
l_mg
->
d_£q_Ä
)

761 
l_mg
->
d_£q_Ä
 = 
lše
->
£q_Ä
 + 1;

762 
l_mg
->
Ä_ä“_lšes
--;

763 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

765 ià(
	`pblk_lše_»cov_®loc
(
pblk
, 
lše
))

766 
out
;

768 
	`pblk_»cov_lše_add_Üd”ed
(&
»cov_li¡
, 
lše
);

769 
found_lšes
++;

770 
	`pblk_debug
(
pblk
, "recovering data†ine %d, seq:%llu\n",

771 
lše
->
id
, 
sm‘a_buf
->
£q_Ä
);

774 ià(!
found_lšes
) {

775 
	`guid_g’
(&
pblk
->
š¡ªû_uuid
);

777 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

778 
	`WARN_ON_ONCE
(!
	`‹¡_ªd_þ—r_b™
(
m‘a_lše
,

779 &
l_mg
->
m‘a_b™m­
));

780 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

782 
out
;

786 
	`li¡_fÜ_—ch_’Œy_§ã
(
lše
, 
Žše
, &
»cov_li¡
, 
li¡
) {

787 
»cov”ed_lšes
++;

789 
lše
->
em‘a_s£c
 = 
	`pblk_lše_em‘a_¡¬t
(
pblk
,†ine);

790 
lše
->
em‘a
 =ƒmeta;

791 
	`mem£t
(
lše
->
em‘a
->
buf
, 0, 
lm
->
em‘a_Ën
[0]);

793 ià(
	`pblk_lše_is_Ý’
(
pblk
, 
lše
)) {

794 
	`pblk_»cov_l2p_äom_oob
(
pblk
, 
lše
);

795 
Ãxt
;

798 ià(
	`pblk_lše_em‘a_»ad
(
pblk
, 
lše
,†še->
em‘a
->
buf
)) {

799 
	`pblk_»cov_l2p_äom_oob
(
pblk
, 
lše
);

800 
Ãxt
;

803 ià(
	`pblk_»cov_check_em‘a
(
pblk
, 
lše
->
em‘a
->
buf
)) {

804 
	`pblk_»cov_l2p_äom_oob
(
pblk
, 
lše
);

805 
Ãxt
;

808 ià(
	`pblk_»cov_check_lše_v”siÚ
(
pblk
, 
lše
->
em‘a
->
buf
))

809  
	`ERR_PTR
(-
EINVAL
);

811 
	`pblk_»cov_wa_couÁ”s
(
pblk
, 
lše
->
em‘a
->
buf
);

813 ià(
	`pblk_»cov_l2p_äom_em‘a
(
pblk
, 
lše
))

814 
	`pblk_»cov_l2p_äom_oob
(
pblk
, 
lše
);

816 
Ãxt
:

817 ià(
	`pblk_lše_is_fuÎ
(
lše
)) {

818 
li¡_h—d
 *
move_li¡
;

820 
	`¥š_lock
(&
lše
->
lock
);

821 
lše
->
¡©e
 = 
PBLK_LINESTATE_CLOSED
;

822 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

823 
lše
->
¡©e
);

824 
move_li¡
 = 
	`pblk_lše_gc_li¡
(
pblk
, 
lše
);

825 
	`¥š_uÆock
(&
lše
->
lock
);

827 
	`¥š_lock
(&
l_mg
->
gc_lock
);

828 
	`li¡_move_ž
(&
lše
->
li¡
, 
move_li¡
);

829 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

831 
	`mempoÞ_ä“
(
lše
->
m­_b™m­
, 
l_mg
->
b™m­_poÞ
);

832 
lše
->
m­_b™m­
 = 
NULL
;

833 
lše
->
sm‘a
 = 
NULL
;

834 
lše
->
em‘a
 = 
NULL
;

836 
	`¥š_lock
(&
lše
->
lock
);

837 
lše
->
¡©e
 = 
PBLK_LINESTATE_OPEN
;

838 
	`¥š_uÆock
(&
lše
->
lock
);

840 
lše
->
em‘a
->
mem
 = 0;

841 
	`©omic_£t
(&
lše
->
em‘a
->
sync
, 0);

843 
	`Œaû_pblk_lše_¡©e
(
	`pblk_disk_Çme
(
pblk
), 
lše
->
id
,

844 
lše
->
¡©e
);

846 
d©a_lše
 = 
lše
;

847 
lše
->
m‘a_lše
 = meta_line;

849 
Ý’_lšes
++;

853 ià(!
Ý’_lšes
) {

854 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

855 
	`WARN_ON_ONCE
(!
	`‹¡_ªd_þ—r_b™
(
m‘a_lše
,

856 &
l_mg
->
m‘a_b™m­
));

857 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

859 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

860 
l_mg
->
d©a_lše
 = data_line;

862 
l_mg
->
d©a_Ãxt
 = 
	`pblk_lše_g‘
(
pblk
);

863 ià(
l_mg
->
d©a_Ãxt
) {

864 
l_mg
->
d©a_Ãxt
->
£q_Ä
 =†_mg->
d_£q_Ä
++;

865 
l_mg
->
d©a_Ãxt
->
ty³
 = 
PBLK_LINETYPE_DATA
;

866 
is_Ãxt
 = 1;

868 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

871 ià(
is_Ãxt
)

872 
	`pblk_lše_”a£
(
pblk
, 
l_mg
->
d©a_Ãxt
);

874 
out
:

875 ià(
found_lšes
 !ð
»cov”ed_lšes
)

876 
	`pblk_”r
(
pblk
, "failedo„ecover‡ll found†ines %d/%d\n",

877 
found_lšes
, 
»cov”ed_lšes
);

879  
d©a_lše
;

880 
	}
}

885 
	$pblk_»cov_·d
(
pblk
 *pblk)

887 
pblk_lše
 *
lše
;

888 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

889 
Ëá_m£cs
;

890 
»t
 = 0;

892 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

893 
lše
 = 
l_mg
->
d©a_lše
;

894 
Ëá_m£cs
 = 
lše
->left_msecs;

895 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

897 
»t
 = 
	`pblk_»cov_·d_lše
(
pblk
, 
lše
, 
Ëá_m£cs
);

898 ià(
»t
) {

899 
	`pblk_”r
(
pblk
, "‹¬ dowÀ·ddšg fažed (%d)\n", 
»t
);

900  
»t
;

903 
	`pblk_lše_þo£_m‘a
(
pblk
, 
lše
);

904  
»t
;

905 
	}
}

	@pblk-rl.c

20 
	~"pblk.h
"

22 
	$pblk_¾_kick_u_tim”
(
pblk_¾
 *
¾
)

24 
	`mod_tim”
(&
¾
->
u_tim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(5000));

25 
	}
}

27 
	$pblk_¾_is_lim™
(
pblk_¾
 *
¾
)

29 
rb_¥aû
;

31 
rb_¥aû
 = 
	`©omic_»ad
(&
¾
->rb_space);

33  (
rb_¥aû
 == 0);

34 
	}
}

36 
	$pblk_¾_u£r_may_š£¹
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
)

38 
rb_u£r_út
 = 
	`©omic_»ad
(&
¾
->rb_user_cnt);

39 
rb_¥aû
 = 
	`©omic_»ad
(&
¾
->rb_space);

41 ià(
	`uÆik–y
(
rb_¥aû
 >ð0è&& (rb_¥aû - 
Ä_’Œ›s
 < 0))

42  
NVM_IO_ERR
;

44 ià(
rb_u£r_út
 >ð
¾
->
rb_u£r_max
)

45  
NVM_IO_REQUEUE
;

47  
NVM_IO_OK
;

48 
	}
}

50 
	$pblk_¾_š£¹ed
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
)

52 
rb_¥aû
 = 
	`©omic_»ad
(&
¾
->rb_space);

54 ià(
	`uÆik–y
(
rb_¥aû
 >= 0))

55 
	`©omic_sub
(
Ä_’Œ›s
, &
¾
->
rb_¥aû
);

56 
	}
}

58 
	$pblk_¾_gc_may_š£¹
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
)

60 
rb_gc_út
 = 
	`©omic_»ad
(&
¾
->rb_gc_cnt);

61 
rb_u£r_aùive
;

64 
rb_u£r_aùive
 = 
	`READ_ONCE
(
¾
->rb_user_active);

65  (!(
rb_gc_út
 >ð
¾
->
rb_gc_max
 && 
rb_u£r_aùive
));

66 
	}
}

68 
	$pblk_¾_u£r_š
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
)

70 
	`©omic_add
(
Ä_’Œ›s
, &
¾
->
rb_u£r_út
);

73 
	`smp_¡Üe_»Ëa£
(&
¾
->
rb_u£r_aùive
, 1);

74 
	`pblk_¾_kick_u_tim”
(
¾
);

75 
	}
}

77 
	$pblk_¾_w”r_lše_š
(
pblk_¾
 *
¾
)

79 
	`©omic_šc
(&
¾
->
w”r_lšes
);

80 
	}
}

82 
	$pblk_¾_w”r_lše_out
(
pblk_¾
 *
¾
)

84 
	`©omic_dec
(&
¾
->
w”r_lšes
);

85 
	}
}

87 
	$pblk_¾_gc_š
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
)

89 
	`©omic_add
(
Ä_’Œ›s
, &
¾
->
rb_gc_út
);

90 
	}
}

92 
	$pblk_¾_out
(
pblk_¾
 *
¾
, 
Ä_u£r
, 
Ä_gc
)

94 
	`©omic_sub
(
Ä_u£r
, &
¾
->
rb_u£r_út
);

95 
	`©omic_sub
(
Ä_gc
, &
¾
->
rb_gc_út
);

96 
	}
}

98 
	$pblk_¾_Ä_ä“_blks
(
pblk_¾
 *
¾
)

100  
	`©omic_»ad
(&
¾
->
ä“_blocks
);

101 
	}
}

103 
	$pblk_¾_Ä_u£r_ä“_blks
(
pblk_¾
 *
¾
)

105  
	`©omic_»ad
(&
¾
->
ä“_u£r_blocks
);

106 
	}
}

108 
	$__pblk_¾_upd©e_¿‹s
(
pblk_¾
 *
¾
,

109 
ä“_blocks
)

111 
pblk
 *pblk = 
	`cÚš”_of
(
¾
, pblk,„l);

112 
max
 = 
¾
->
rb_budg‘
;

113 
w”r_gc_Ãeded
 = 
	`©omic_»ad
(&
¾
->
w”r_lšes
);

115 ià(
ä“_blocks
 >ð
¾
->
high
) {

116 ià(
w”r_gc_Ãeded
) {

120 
¾
->
rb_gc_max
 = 1 <<„l->
rb_wšdows_pw
;

121 
¾
->
rb_u£r_max
 = 
max
 -„l->
rb_gc_max
;

122 
¾
->
rb_¡©e
 = 
PBLK_RL_WERR
;

124 
¾
->
rb_u£r_max
 = 
max
;

125 
¾
->
rb_gc_max
 = 0;

126 
¾
->
rb_¡©e
 = 
PBLK_RL_OFF
;

128 } ià(
ä“_blocks
 < 
¾
->
high
) {

129 
shiá
 = 
¾
->
high_pw
 -„l->
rb_wšdows_pw
;

130 
u£r_wšdows
 = 
ä“_blocks
 >> 
shiá
;

131 
u£r_max
 = 
u£r_wšdows
 << 
	`žog2
(
NVM_MAX_VLBA
);

133 
¾
->
rb_u£r_max
 = 
u£r_max
;

134 
¾
->
rb_gc_max
 = 
max
 - 
u£r_max
;

136 ià(
ä“_blocks
 <ð
¾
->
rsv_blocks
) {

137 
¾
->
rb_u£r_max
 = 0;

138 
¾
->
rb_gc_max
 = 
max
;

145 
¾
->
rb_¡©e
 = 
PBLK_RL_LOW
;

148 ià(
¾
->
rb_¡©e
 !ð
PBLK_RL_OFF
)

149 
	`pblk_gc_should_¡¬t
(
pblk
);

151 
	`pblk_gc_should_¡Ý
(
pblk
);

152 
	}
}

154 
	$pblk_¾_upd©e_¿‹s
(
pblk_¾
 *
¾
)

156 
	`__pblk_¾_upd©e_¿‹s
(
¾
, 
	`pblk_¾_Ä_u£r_ä“_blks
(rl));

157 
	}
}

159 
	$pblk_¾_ä“_lšes_šc
(
pblk_¾
 *
¾
, 
pblk_lše
 *
lše
)

161 
blk_š_lše
 = 
	`©omic_»ad
(&
lše
->blk_in_line);

162 
ä“_blocks
;

164 
	`©omic_add
(
blk_š_lše
, &
¾
->
ä“_blocks
);

165 
ä“_blocks
 = 
	`©omic_add_»tuº
(
blk_š_lše
, &
¾
->
ä“_u£r_blocks
);

167 
	`__pblk_¾_upd©e_¿‹s
(
¾
, 
ä“_blocks
);

168 
	}
}

170 
	$pblk_¾_ä“_lšes_dec
(
pblk_¾
 *
¾
, 
pblk_lše
 *
lše
,

171 
boÞ
 
u£d
)

173 
blk_š_lše
 = 
	`©omic_»ad
(&
lše
->blk_in_line);

174 
ä“_blocks
;

176 
	`©omic_sub
(
blk_š_lše
, &
¾
->
ä“_blocks
);

178 ià(
u£d
)

179 
ä“_blocks
 = 
	`©omic_sub_»tuº
(
blk_š_lše
,

180 &
¾
->
ä“_u£r_blocks
);

182 
ä“_blocks
 = 
	`©omic_»ad
(&
¾
->
ä“_u£r_blocks
);

184 
	`__pblk_¾_upd©e_¿‹s
(
¾
, 
ä“_blocks
);

185 
	}
}

187 
	$pblk_¾_high_thrs
(
pblk_¾
 *
¾
)

189  
¾
->
high
;

190 
	}
}

192 
	$pblk_¾_max_io
(
pblk_¾
 *
¾
)

194  
¾
->
rb_max_io
;

195 
	}
}

197 
	$pblk_¾_u_tim”
(
tim”_li¡
 *
t
)

199 
pblk_¾
 *
¾
 = 
	`äom_tim”
Ôl, 
t
, 
u_tim”
);

202 
	`smp_¡Üe_»Ëa£
(&
¾
->
rb_u£r_aùive
, 0);

203 
	}
}

205 
	$pblk_¾_ä“
(
pblk_¾
 *
¾
)

207 
	`d–_tim”
(&
¾
->
u_tim”
);

208 
	}
}

210 
	$pblk_¾_š™
(
pblk_¾
 *
¾
, 
budg‘
, 
th»shÞd
)

212 
pblk
 *pblk = 
	`cÚš”_of
(
¾
, pblk,„l);

213 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

214 
nvm_geo
 *
geo
 = &
dev
->geo;

215 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

216 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

217 
£c_m‘a
, 
blk_m‘a
;

218 
rb_wšdows
;

221 
£c_m‘a
 = (
lm
->
sm‘a_£c
 +†m->
em‘a_£c
[0]è* 
l_mg
->
Ä_ä“_lšes
;

222 
blk_m‘a
 = 
	`DIV_ROUND_UP
(
£c_m‘a
, 
geo
->
þba
);

224 
¾
->
high
 = 
pblk
->
Ý_blks
 - 
blk_m‘a
 - 
lm
->
blk_³r_lše
;

225 
¾
->
high_pw
 = 
	`g‘_couÁ_Üd”
Ôl->
high
);

227 
¾
->
rsv_blocks
 = 
	`pblk_g‘_mš_chks
(
pblk
);

230 
rb_wšdows
 = 
budg‘
 / 
NVM_MAX_VLBA
;

231 
¾
->
rb_wšdows_pw
 = 
	`g‘_couÁ_Üd”
(
rb_wšdows
);

234 
¾
->
rb_budg‘
 = 
budg‘
;

235 
¾
->
rb_u£r_max
 = 
budg‘
;

236 
¾
->
rb_gc_max
 = 0;

237 
¾
->
rb_¡©e
 = 
PBLK_RL_HIGH
;

240 ià(
th»shÞd
)

241 
¾
->
rb_max_io
 = 
budg‘
 - 
pblk
->
mš_wr™e_pgs_d©a
 - 
th»shÞd
;

243 
¾
->
rb_max_io
 = 
budg‘
 - 
pblk
->
mš_wr™e_pgs_d©a
 - 1;

245 
	`©omic_£t
(&
¾
->
rb_u£r_út
, 0);

246 
	`©omic_£t
(&
¾
->
rb_gc_út
, 0);

247 
	`©omic_£t
(&
¾
->
rb_¥aû
, -1);

248 
	`©omic_£t
(&
¾
->
w”r_lšes
, 0);

250 
	`tim”_£tup
(&
¾
->
u_tim”
, 
pblk_¾_u_tim”
, 0);

252 
¾
->
rb_u£r_aùive
 = 0;

253 
¾
->
rb_gc_aùive
 = 0;

254 
	}
}

	@pblk-sysfs.c

22 
	~"pblk.h
"

24 
ssize_t
 
	$pblk_sysfs_luns_show
(
pblk
 *pblk, *
·ge
)

26 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

27 
nvm_geo
 *
geo
 = &
dev
->geo;

28 
pblk_lun
 *
¾un
;

29 
ssize_t
 
sz
 = 0;

30 
i
;

32 
i
 = 0; i < 
geo
->
®l_luns
; i++) {

33 
aùive
 = 1;

35 
¾un
 = &
pblk
->
luns
[
i
];

36 ià(!
	`down_Œylock
(&
¾un
->
wr_£m
)) {

37 
aùive
 = 0;

38 
	`up
(&
¾un
->
wr_£m
);

40 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

42 
i
,

43 
¾un
->
bµa
.
a
.
ch
,

44 
¾un
->
bµa
.
a
.
lun
,

45 
aùive
);

48  
sz
;

49 
	}
}

51 
ssize_t
 
	$pblk_sysfs_¿‹_lim™”
(
pblk
 *pblk, *
·ge
)

53 
ä“_blocks
, 
ä“_u£r_blocks
, 
tÙ®_blocks
;

54 
rb_u£r_max
, 
rb_u£r_út
;

55 
rb_gc_max
, 
rb_gc_út
, 
rb_budg‘
, 
rb_¡©e
;

57 
ä“_blocks
 = 
	`pblk_¾_Ä_ä“_blks
(&
pblk
->
¾
);

58 
ä“_u£r_blocks
 = 
	`pblk_¾_Ä_u£r_ä“_blks
(&
pblk
->
¾
);

59 
rb_u£r_max
 = 
pblk
->
¾
.rb_user_max;

60 
rb_u£r_út
 = 
	`©omic_»ad
(&
pblk
->
¾
.rb_user_cnt);

61 
rb_gc_max
 = 
pblk
->
¾
.rb_gc_max;

62 
rb_gc_út
 = 
	`©omic_»ad
(&
pblk
->
¾
.rb_gc_cnt);

63 
rb_budg‘
 = 
pblk
->
¾
.rb_budget;

64 
rb_¡©e
 = 
pblk
->
¾
.rb_state;

66 
tÙ®_blocks
 = 
pblk
->
¾
.total_blocks;

68  
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

70 
rb_u£r_út
,

71 
rb_u£r_max
,

72 
rb_gc_út
,

73 
rb_gc_max
,

74 
rb_¡©e
,

75 
rb_budg‘
,

76 
pblk
->
¾
.
high
,

77 
ä“_blocks
,

78 
ä“_u£r_blocks
,

79 
tÙ®_blocks
,

80 
	`READ_ONCE
(
pblk
->
¾
.
rb_u£r_aùive
));

81 
	}
}

83 
ssize_t
 
	$pblk_sysfs_gc_¡©e_show
(
pblk
 *pblk, *
·ge
)

85 
gc_’abËd
, 
gc_aùive
;

87 
	`pblk_gc_sysfs_¡©e_show
(
pblk
, &
gc_’abËd
, &
gc_aùive
);

88  
	`¢´štf
(
·ge
, 
PAGE_SIZE
, "gc_enabled=%d, gc_active=%d\n",

89 
gc_’abËd
, 
gc_aùive
);

90 
	}
}

92 
ssize_t
 
	$pblk_sysfs_¡©s
(
pblk
 *pblk, *
·ge
)

94 
ssize_t
 
sz
;

96 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

98 
	`©omic_lÚg_»ad
(&
pblk
->
»ad_çžed
),

99 
	`©omic_lÚg_»ad
(&
pblk
->
»ad_high_ecc
),

100 
	`©omic_lÚg_»ad
(&
pblk
->
»ad_em±y
),

101 
	`©omic_lÚg_»ad
(&
pblk
->
»ad_çžed_gc
),

102 
	`©omic_lÚg_»ad
(&
pblk
->
wr™e_çžed
),

103 
	`©omic_lÚg_»ad
(&
pblk
->
”a£_çžed
));

105  
sz
;

106 
	}
}

108 
ssize_t
 
	$pblk_sysfs_wr™e_bufãr
(
pblk
 *pblk, *
·ge
)

110  
	`pblk_rb_sysfs
(&
pblk
->
rwb
, 
·ge
);

111 
	}
}

113 
ssize_t
 
	$pblk_sysfs_µaf
(
pblk
 *pblk, *
·ge
)

115 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

116 
nvm_geo
 *
geo
 = &
dev
->geo;

117 
ssize_t
 
sz
 = 0;

119 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
) {

120 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

121 
nvm_addrf_12
 *
gµaf
 = (nvm_addrf_12 *)&
geo
->
addrf
;

123 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

125 
pblk
->
addrf_Ën
,

126 
µaf
->
blk_off£t
,…·f->
blk_Ën
,

127 
µaf
->
pg_off£t
,…·f->
pg_Ën
,

128 
µaf
->
lun_off£t
,…·f->
lun_Ën
,

129 
µaf
->
ch_off£t
,…·f->
ch_Ën
,

130 
µaf
->
¶n_off£t
,…·f->
¶n_Ën
,

131 
µaf
->
£c_off£t
,…·f->
£c_Ën
);

133 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

135 
gµaf
->
blk_off£t
, gµaf->
blk_Ën
,

136 
gµaf
->
pg_off£t
, gµaf->
pg_Ën
,

137 
gµaf
->
lun_off£t
, gµaf->
lun_Ën
,

138 
gµaf
->
ch_off£t
, gµaf->
ch_Ën
,

139 
gµaf
->
¶n_off£t
, gµaf->
¶n_Ën
,

140 
gµaf
->
£c_off£t
, gµaf->
£c_Ën
);

142 
nvm_addrf
 *
µaf
 = &
pblk
->
addrf
;

143 
nvm_addrf
 *
gµaf
 = &
geo
->
addrf
;

145 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

147 
pblk
->
addrf_Ën
,

148 
µaf
->
ch_off£t
,…·f->
ch_Ën
,

149 
µaf
->
lun_off£t
,…·f->
lun_Ën
,

150 
µaf
->
chk_off£t
,…·f->
chk_Ën
,

151 
µaf
->
£c_off£t
,…·f->
£c_Ën
);

153 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

155 
gµaf
->
ch_off£t
, gµaf->
ch_Ën
,

156 
gµaf
->
lun_off£t
, gµaf->
lun_Ën
,

157 
gµaf
->
chk_off£t
, gµaf->
chk_Ën
,

158 
gµaf
->
£c_off£t
, gµaf->
£c_Ën
);

161  
sz
;

162 
	}
}

164 
ssize_t
 
	$pblk_sysfs_lšes
(
pblk
 *pblk, *
·ge
)

166 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

167 
nvm_geo
 *
geo
 = &
dev
->geo;

168 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

169 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

170 
pblk_lše
 *
lše
;

171 
ssize_t
 
sz
 = 0;

172 
Ä_ä“_lšes
;

173 
cur_d©a
, 
cur_log
;

174 
ä“_lše_út
 = 0, 
þo£d_lše_út
 = 0, 
em‘a_lše_út
 = 0;

175 
d_lše_út
 = 0, 
l_lše_út
 = 0;

176 
gc_fuÎ
 = 0, 
gc_high
 = 0, 
gc_mid
 = 0, 
gc_low
 = 0, 
gc_em±y
 = 0;

177 
gc_w”r
 = 0;

179 
bad
 = 0, 
cÜ
 = 0;

180 
m£cs
 = 0, 
cur_£c
 = 0, 
vsc
 = 0, 
£c_š_lše
 = 0;

181 
m­_weight
 = 0, 
m‘a_weight
 = 0;

183 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

184 
cur_d©a
 = (
l_mg
->
d©a_lše
è?†_mg->d©a_lše->
id
 : -1;

185 
cur_log
 = (
l_mg
->
log_lše
è?†_mg->log_lše->
id
 : -1;

186 
Ä_ä“_lšes
 = 
l_mg
->nr_free_lines;

188 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
ä“_li¡
, 
li¡
)

189 
ä“_lše_út
++;

190 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

192 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

193 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
em‘a_li¡
, 
li¡
)

194 
em‘a_lše_út
++;

195 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

197 
	`¥š_lock
(&
l_mg
->
gc_lock
);

198 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_fuÎ_li¡
, 
li¡
) {

199 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

200 
d_lše_út
++;

201 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

202 
l_lše_út
++;

203 
þo£d_lše_út
++;

204 
gc_fuÎ
++;

207 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_high_li¡
, 
li¡
) {

208 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

209 
d_lše_út
++;

210 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

211 
l_lše_út
++;

212 
þo£d_lše_út
++;

213 
gc_high
++;

216 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_mid_li¡
, 
li¡
) {

217 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

218 
d_lše_út
++;

219 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

220 
l_lše_út
++;

221 
þo£d_lše_út
++;

222 
gc_mid
++;

225 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_low_li¡
, 
li¡
) {

226 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

227 
d_lše_út
++;

228 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

229 
l_lše_út
++;

230 
þo£d_lše_út
++;

231 
gc_low
++;

234 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_em±y_li¡
, 
li¡
) {

235 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

236 
d_lše_út
++;

237 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

238 
l_lše_út
++;

239 
þo£d_lše_út
++;

240 
gc_em±y
++;

243 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
gc_w”r_li¡
, 
li¡
) {

244 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_DATA
)

245 
d_lše_út
++;

246 ià(
lše
->
ty³
 =ð
PBLK_LINETYPE_LOG
)

247 
l_lše_út
++;

248 
þo£d_lše_út
++;

249 
gc_w”r
++;

252 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
bad_li¡
, 
li¡
)

253 
bad
++;

254 
	`li¡_fÜ_—ch_’Œy
(
lše
, &
l_mg
->
cÜru±_li¡
, 
li¡
)

255 
cÜ
++;

256 
	`¥š_uÆock
(&
l_mg
->
gc_lock
);

258 
	`¥š_lock
(&
l_mg
->
ä“_lock
);

259 ià(
l_mg
->
d©a_lše
) {

260 
cur_£c
 = 
l_mg
->
d©a_lše
->cur_sec;

261 
m£cs
 = 
l_mg
->
d©a_lše
->
Ëá_m£cs
;

262 
vsc
 = 
	`Ë32_to_ýu
(*
l_mg
->
d©a_lše
->vsc);

263 
£c_š_lše
 = 
l_mg
->
d©a_lše
->sec_in_line;

264 
m‘a_weight
 = 
	`b™m­_weight
(&
l_mg
->
m‘a_b™m­
,

265 
PBLK_DATA_LINES
);

267 
	`¥š_lock
(&
l_mg
->
d©a_lše
->
lock
);

268 ià(
l_mg
->
d©a_lše
->
m­_b™m­
)

269 
m­_weight
 = 
	`b™m­_weight
(
l_mg
->
d©a_lše
->
m­_b™m­
,

270 
lm
->
£c_³r_lše
);

272 
m­_weight
 = 0;

273 
	`¥š_uÆock
(&
l_mg
->
d©a_lše
->
lock
);

275 
	`¥š_uÆock
(&
l_mg
->
ä“_lock
);

277 ià(
Ä_ä“_lšes
 !ð
ä“_lše_út
)

278 
	`pblk_”r
(
pblk
, "corrupted free†ine†ist:%d/%d\n",

279 
Ä_ä“_lšes
, 
ä“_lše_út
);

281 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
 - sz,

283 
geo
->
®l_luns
, 
lm
->
blk_³r_lše
,†m->
£c_³r_lše
);

285 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

287 
cur_d©a
, 
cur_log
,

288 
Ä_ä“_lšes
,

289 
em‘a_lše_út
, 
m‘a_weight
,

290 
þo£d_lše_út
,

291 
bad
, 
cÜ
,

292 
d_lše_út
, 
l_lše_út
,

293 
l_mg
->
Ä_lšes
);

295 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

297 
gc_fuÎ
, 
gc_high
, 
gc_mid
, 
gc_low
, 
gc_em±y
, 
gc_w”r
,

298 
	`©omic_»ad
(&
pblk
->
gc
.
»ad_šæight_gc
));

300 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

302 
cur_d©a
, 
cur_£c
, 
m£cs
, 
vsc
, 
£c_š_lše
,

303 
m­_weight
, 
lm
->
£c_³r_lše
,

304 
	`©omic_»ad
(&
pblk
->
šæight_io
));

306  
sz
;

307 
	}
}

309 
ssize_t
 
	$pblk_sysfs_lšes_šfo
(
pblk
 *pblk, *
·ge
)

311 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

312 
nvm_geo
 *
geo
 = &
dev
->geo;

313 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

314 
ssize_t
 
sz
 = 0;

316 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
 - sz,

318 
lm
->
sm‘a_Ën
,†m->
sm‘a_£c
);

319 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

321 
lm
->
em‘a_Ën
[0],†m->
em‘a_£c
[0],

322 
lm
->
em‘a_bb
);

323 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

325 
lm
->
£c_b™m­_Ën
,

326 
lm
->
blk_b™m­_Ën
,

327 
lm
->
lun_b™m­_Ën
);

328 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

330 
lm
->
blk_³r_lše
,

331 
lm
->
£c_³r_lše
,

332 
geo
->
þba
);

334  
sz
;

335 
	}
}

337 
ssize_t
 
	$pblk_sysfs_g‘_£c_³r_wr™e
(
pblk
 *pblk, *
·ge
)

339  
	`¢´štf
(
·ge
, 
PAGE_SIZE
, "%d\n", 
pblk
->
£c_³r_wr™e
);

340 
	}
}

342 
ssize_t
 
	$pblk_g‘_wr™e_amp
(
u64
 
u£r
, u64 
gc
, u64 
·d
,

343 *
·ge
)

345 
sz
;

347 
sz
 = 
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

349 
u£r
, 
gc
, 
·d
);

351 ià(!
u£r
) {

352 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "NaN\n");

354 
u64
 
wa_št
;

355 
u32
 
wa_äac
;

357 
wa_št
 = (
u£r
 + 
gc
 + 
·d
) * 100000;

358 
wa_št
 = 
	`div64_u64
(wa_št, 
u£r
);

359 
wa_št
 = 
	`div_u64_»m
(wa_št, 100000, &
wa_äac
);

361 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "%llu.%05u\n",

362 
wa_št
, 
wa_äac
);

365  
sz
;

366 
	}
}

368 
ssize_t
 
	$pblk_sysfs_g‘_wr™e_amp_mž—ge
(
pblk
 *pblk, *
·ge
)

370  
	`pblk_g‘_wr™e_amp
(
	`©omic64_»ad
(&
pblk
->
u£r_wa
),

371 
	`©omic64_»ad
(&
pblk
->
gc_wa
),‡tomic64_»ad(&pblk->
·d_wa
),

372 
·ge
);

373 
	}
}

375 
ssize_t
 
	$pblk_sysfs_g‘_wr™e_amp_Œ
(
pblk
 *pblk, *
·ge
)

377  
	`pblk_g‘_wr™e_amp
(

378 
	`©omic64_»ad
(&
pblk
->
u£r_wa
è-…blk->
u£r_r¡_wa
,

379 
	`©omic64_»ad
(&
pblk
->
gc_wa
è-…blk->
gc_r¡_wa
,

380 
	`©omic64_»ad
(&
pblk
->
·d_wa
è-…blk->
·d_r¡_wa
, 
·ge
);

381 
	}
}

383 
	$buck‘_³rûÁage
(
buck‘
,

384 
tÙ®
)

386 
p
 = 
buck‘
 * 100;

388 
p
 = 
	`div_u64
Õ, 
tÙ®
);

390  
p
;

391 
	}
}

393 
ssize_t
 
	$pblk_sysfs_g‘_·ddšg_di¡
(
pblk
 *pblk, *
·ge
)

395 
sz
 = 0;

396 
tÙ®
;

397 
tÙ®_buck‘s
 = 0;

398 
buck‘s
 = 
pblk
->
mš_wr™e_pgs
 - 1;

399 
i
;

401 
tÙ®
 = 
	`©omic64_»ad
(&
pblk
->
Ä_æush
è-…blk->
Ä_æush_r¡
;

402 ià(!
tÙ®
) {

403 
i
 = 0; i < (
buck‘s
 + 1); i++)

404 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz,

405 "%d:0 ", 
i
);

406 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "\n");

408  
sz
;

411 
i
 = 0; i < 
buck‘s
; i++)

412 
tÙ®_buck‘s
 +ð
	`©omic64_»ad
(&
pblk
->
·d_di¡
[
i
]);

414 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "0:%lld%% ",

415 
	`buck‘_³rûÁage
(
tÙ®
 - 
tÙ®_buck‘s
,otal));

417 
i
 = 0; i < 
buck‘s
; i++) {

418 
p
;

420 
p
 = 
	`buck‘_³rûÁage
(
	`©omic64_»ad
(&
pblk
->
·d_di¡
[
i
]),

421 
tÙ®
);

422 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "%d:%lld%% ",

423 
i
 + 1, 
p
);

425 
sz
 +ð
	`¢´štf
(
·ge
 + sz, 
PAGE_SIZE
 - sz, "\n");

427  
sz
;

428 
	}
}

430 #ifdeà
CONFIG_NVM_PBLK_DEBUG


431 
ssize_t
 
	$pblk_sysfs_¡©s_debug
(
pblk
 *pblk, *
·ge
)

433  
	`¢´štf
(
·ge
, 
PAGE_SIZE
,

435 
	`©omic_lÚg_»ad
(&
pblk
->
šæight_wr™es
),

436 
	`©omic_lÚg_»ad
(&
pblk
->
šæight_»ads
),

437 
	`©omic_lÚg_»ad
(&
pblk
->
»q_wr™es
),

438 (
u64
)
	`©omic64_»ad
(&
pblk
->
Ä_æush
),

439 
	`©omic_lÚg_»ad
(&
pblk
->
·dded_wr™es
),

440 
	`©omic_lÚg_»ad
(&
pblk
->
·dded_wb
),

441 
	`©omic_lÚg_»ad
(&
pblk
->
sub_wr™es
),

442 
	`©omic_lÚg_»ad
(&
pblk
->
sync_wr™es
),

443 
	`©omic_lÚg_»ad
(&
pblk
->
»cov_wr™es
),

444 
	`©omic_lÚg_»ad
(&
pblk
->
»cov_gc_wr™es
),

445 
	`©omic_lÚg_»ad
(&
pblk
->
»cov_gc_»ads
),

446 
	`©omic_lÚg_»ad
(&
pblk
->
ÿche_»ads
),

447 
	`©omic_lÚg_»ad
(&
pblk
->
sync_»ads
));

448 
	}
}

451 
ssize_t
 
	$pblk_sysfs_gc_fÜû
(
pblk
 *pblk, cÚ¡ *
·ge
,

452 
size_t
 
Ën
)

454 
size_t
 
c_Ën
;

455 
fÜû
;

457 
c_Ën
 = 
	`¡rc¥n
(
·ge
, "\n");

458 ià(
c_Ën
 >ð
Ën
)

459  -
EINVAL
;

461 ià(
	`k¡¹oušt
(
·ge
, 0, &
fÜû
))

462  -
EINVAL
;

464 
	`pblk_gc_sysfs_fÜû
(
pblk
, 
fÜû
);

466  
Ën
;

467 
	}
}

469 
ssize_t
 
	$pblk_sysfs_£t_£c_³r_wr™e
(
pblk
 *pblk,

470 cÚ¡ *
·ge
, 
size_t
 
Ën
)

472 
size_t
 
c_Ën
;

473 
£c_³r_wr™e
;

475 
c_Ën
 = 
	`¡rc¥n
(
·ge
, "\n");

476 ià(
c_Ën
 >ð
Ën
)

477  -
EINVAL
;

479 ià(
	`k¡¹oušt
(
·ge
, 0, &
£c_³r_wr™e
))

480  -
EINVAL
;

482 ià(!
	`pblk_is_oob_m‘a_suµÜ‹d
(
pblk
)) {

486  -
EINVAL
;

489 ià(
£c_³r_wr™e
 < 
pblk
->
mš_wr™e_pgs


490 || 
£c_³r_wr™e
 > 
pblk
->
max_wr™e_pgs


491 || 
£c_³r_wr™e
 % 
pblk
->
mš_wr™e_pgs
 != 0)

492  -
EINVAL
;

494 
	`pblk_£t_£c_³r_wr™e
(
pblk
, 
£c_³r_wr™e
);

496  
Ën
;

497 
	}
}

499 
ssize_t
 
	$pblk_sysfs_£t_wr™e_amp_Œ
(
pblk
 *pblk,

500 cÚ¡ *
·ge
, 
size_t
 
Ën
)

502 
size_t
 
c_Ën
;

503 
»£t_v®ue
;

505 
c_Ën
 = 
	`¡rc¥n
(
·ge
, "\n");

506 ià(
c_Ën
 >ð
Ën
)

507  -
EINVAL
;

509 ià(
	`k¡¹oušt
(
·ge
, 0, &
»£t_v®ue
))

510  -
EINVAL
;

512 ià(
»£t_v®ue
 != 0)

513  -
EINVAL
;

515 
pblk
->
u£r_r¡_wa
 = 
	`©omic64_»ad
(&pblk->
u£r_wa
);

516 
pblk
->
·d_r¡_wa
 = 
	`©omic64_»ad
(&pblk->
·d_wa
);

517 
pblk
->
gc_r¡_wa
 = 
	`©omic64_»ad
(&pblk->
gc_wa
);

519  
Ën
;

520 
	}
}

523 
ssize_t
 
	$pblk_sysfs_£t_·ddšg_di¡
(
pblk
 *pblk,

524 cÚ¡ *
·ge
, 
size_t
 
Ën
)

526 
size_t
 
c_Ën
;

527 
»£t_v®ue
;

528 
buck‘s
 = 
pblk
->
mš_wr™e_pgs
 - 1;

529 
i
;

531 
c_Ën
 = 
	`¡rc¥n
(
·ge
, "\n");

532 ià(
c_Ën
 >ð
Ën
)

533  -
EINVAL
;

535 ià(
	`k¡¹oušt
(
·ge
, 0, &
»£t_v®ue
))

536  -
EINVAL
;

538 ià(
»£t_v®ue
 != 0)

539  -
EINVAL
;

541 
i
 = 0; i < 
buck‘s
; i++)

542 
	`©omic64_£t
(&
pblk
->
·d_di¡
[
i
], 0);

544 
pblk
->
Ä_æush_r¡
 = 
	`©omic64_»ad
(&pblk->
Ä_æush
);

546  
Ën
;

547 
	}
}

549 
©Œibu‹
 
	gsys_wr™e_luns
 = {

550 .
Çme
 = "write_luns",

551 .
	gmode
 = 0444,

554 
©Œibu‹
 
	gsys_¿‹_lim™”_©Œ
 = {

555 .
Çme
 = "rate_limiter",

556 .
	gmode
 = 0444,

559 
©Œibu‹
 
	gsys_gc_¡©e
 = {

560 .
Çme
 = "gc_state",

561 .
	gmode
 = 0444,

564 
©Œibu‹
 
	gsys_”rÜs_©Œ
 = {

565 .
Çme
 = "errors",

566 .
	gmode
 = 0444,

569 
©Œibu‹
 
	gsys_rb_©Œ
 = {

570 .
Çme
 = "write_buffer",

571 .
	gmode
 = 0444,

574 
©Œibu‹
 
	gsys_¡©s_µaf_©Œ
 = {

575 .
Çme
 = "ppa_format",

576 .
	gmode
 = 0444,

579 
©Œibu‹
 
	gsys_lšes_©Œ
 = {

580 .
Çme
 = "lines",

581 .
	gmode
 = 0444,

584 
©Œibu‹
 
	gsys_lšes_šfo_©Œ
 = {

585 .
Çme
 = "lines_info",

586 .
	gmode
 = 0444,

589 
©Œibu‹
 
	gsys_gc_fÜû
 = {

590 .
Çme
 = "gc_force",

591 .
	gmode
 = 0200,

594 
©Œibu‹
 
	gsys_max_£c_³r_wr™e
 = {

595 .
Çme
 = "max_sec_per_write",

596 .
	gmode
 = 0644,

599 
©Œibu‹
 
	gsys_wr™e_amp_mž—ge
 = {

600 .
Çme
 = "write_amp_mileage",

601 .
	gmode
 = 0444,

604 
©Œibu‹
 
	gsys_wr™e_amp_Œ
 = {

605 .
Çme
 = "write_amp_trip",

606 .
	gmode
 = 0644,

609 
©Œibu‹
 
	gsys_·ddšg_di¡
 = {

610 .
Çme
 = "padding_dist",

611 .
	gmode
 = 0644,

614 #ifdeà
CONFIG_NVM_PBLK_DEBUG


615 
©Œibu‹
 
	gsys_¡©s_debug_©Œ
 = {

616 .
Çme
 = "stats",

617 .
	gmode
 = 0444,

621 
©Œibu‹
 *
	gpblk_©Œs
[] = {

622 &
sys_wr™e_luns
,

623 &
sys_¿‹_lim™”_©Œ
,

624 &
sys_”rÜs_©Œ
,

625 &
sys_gc_¡©e
,

626 &
sys_gc_fÜû
,

627 &
sys_max_£c_³r_wr™e
,

628 &
sys_rb_©Œ
,

629 &
sys_¡©s_µaf_©Œ
,

630 &
sys_lšes_©Œ
,

631 &
sys_lšes_šfo_©Œ
,

632 &
sys_wr™e_amp_mž—ge
,

633 &
sys_wr™e_amp_Œ
,

634 &
sys_·ddšg_di¡
,

635 #ifdeà
CONFIG_NVM_PBLK_DEBUG


636 &
sys_¡©s_debug_©Œ
,

638 
NULL
,

641 
ssize_t
 
	$pblk_sysfs_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

642 *
buf
)

644 
pblk
 *pblk = 
	`cÚš”_of
(
kobj
, pblk, kobj);

646 ià(
	`¡rcmp
(
©Œ
->
Çme
, "rate_limiter") == 0)

647  
	`pblk_sysfs_¿‹_lim™”
(
pblk
, 
buf
);

648 ià(
	`¡rcmp
(
©Œ
->
Çme
, "write_luns") == 0)

649  
	`pblk_sysfs_luns_show
(
pblk
, 
buf
);

650 ià(
	`¡rcmp
(
©Œ
->
Çme
, "gc_state") == 0)

651  
	`pblk_sysfs_gc_¡©e_show
(
pblk
, 
buf
);

652 ià(
	`¡rcmp
(
©Œ
->
Çme
, "errors") == 0)

653  
	`pblk_sysfs_¡©s
(
pblk
, 
buf
);

654 ià(
	`¡rcmp
(
©Œ
->
Çme
, "write_buffer") == 0)

655  
	`pblk_sysfs_wr™e_bufãr
(
pblk
, 
buf
);

656 ià(
	`¡rcmp
(
©Œ
->
Çme
, "ppa_format") == 0)

657  
	`pblk_sysfs_µaf
(
pblk
, 
buf
);

658 ià(
	`¡rcmp
(
©Œ
->
Çme
, "lines") == 0)

659  
	`pblk_sysfs_lšes
(
pblk
, 
buf
);

660 ià(
	`¡rcmp
(
©Œ
->
Çme
, "lines_info") == 0)

661  
	`pblk_sysfs_lšes_šfo
(
pblk
, 
buf
);

662 ià(
	`¡rcmp
(
©Œ
->
Çme
, "max_sec_per_write") == 0)

663  
	`pblk_sysfs_g‘_£c_³r_wr™e
(
pblk
, 
buf
);

664 ià(
	`¡rcmp
(
©Œ
->
Çme
, "write_amp_mileage") == 0)

665  
	`pblk_sysfs_g‘_wr™e_amp_mž—ge
(
pblk
, 
buf
);

666 ià(
	`¡rcmp
(
©Œ
->
Çme
, "write_amp_trip") == 0)

667  
	`pblk_sysfs_g‘_wr™e_amp_Œ
(
pblk
, 
buf
);

668 ià(
	`¡rcmp
(
©Œ
->
Çme
, "padding_dist") == 0)

669  
	`pblk_sysfs_g‘_·ddšg_di¡
(
pblk
, 
buf
);

670 #ifdeà
CONFIG_NVM_PBLK_DEBUG


671 ià(
	`¡rcmp
(
©Œ
->
Çme
, "stats") == 0)

672  
	`pblk_sysfs_¡©s_debug
(
pblk
, 
buf
);

675 
	}
}

677 
ssize_t
 
	$pblk_sysfs_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

678 cÚ¡ *
buf
, 
size_t
 
Ën
)

680 
pblk
 *pblk = 
	`cÚš”_of
(
kobj
, pblk, kobj);

682 ià(
	`¡rcmp
(
©Œ
->
Çme
, "gc_force") == 0)

683  
	`pblk_sysfs_gc_fÜû
(
pblk
, 
buf
, 
Ën
);

684 ià(
	`¡rcmp
(
©Œ
->
Çme
, "max_sec_per_write") == 0)

685  
	`pblk_sysfs_£t_£c_³r_wr™e
(
pblk
, 
buf
, 
Ën
);

686 ià(
	`¡rcmp
(
©Œ
->
Çme
, "write_amp_trip") == 0)

687  
	`pblk_sysfs_£t_wr™e_amp_Œ
(
pblk
, 
buf
, 
Ën
);

688 ià(
	`¡rcmp
(
©Œ
->
Çme
, "padding_dist") == 0)

689  
	`pblk_sysfs_£t_·ddšg_di¡
(
pblk
, 
buf
, 
Ën
);

691 
	}
}

693 cÚ¡ 
sysfs_Ýs
 
	gpblk_sysfs_Ýs
 = {

694 .
show
 = 
pblk_sysfs_show
,

695 .
	g¡Üe
 = 
pblk_sysfs_¡Üe
,

698 
kobj_ty³
 
	gpblk_kty³
 = {

699 .
sysfs_Ýs
 = &
pblk_sysfs_Ýs
,

700 .
	gdeçuÉ_©Œs
 = 
pblk_©Œs
,

703 
	$pblk_sysfs_š™
(
g’disk
 *
tdisk
)

705 
pblk
 *pblk = 
tdisk
->
´iv©e_d©a
;

706 
deviû
 *
·»Á_dev
 = 
	`disk_to_dev
(
pblk
->
disk
);

707 
»t
;

709 
»t
 = 
	`kobjeù_š™_ªd_add
(&
pblk
->
kobj
, &
pblk_kty³
,

710 
	`kobjeù_g‘
(&
·»Á_dev
->
kobj
),

712 ià(
»t
) {

713 
	`pblk_”r
(
pblk
, "could‚ot„egister\n");

714  
»t
;

717 
	`kobjeù_uev’t
(&
pblk
->
kobj
, 
KOBJ_ADD
);

719 
	}
}

721 
	$pblk_sysfs_ex™
(
g’disk
 *
tdisk
)

723 
pblk
 *pblk = 
tdisk
->
´iv©e_d©a
;

725 
	`kobjeù_uev’t
(&
pblk
->
kobj
, 
KOBJ_REMOVE
);

726 
	`kobjeù_d–
(&
pblk
->
kobj
);

727 
	`kobjeù_put
(&
pblk
->
kobj
);

728 
	}
}

	@pblk-trace.h

2 #undeà
TRACE_SYSTEM


3 
	#TRACE_SYSTEM
 
pblk


	)

5 #ià!
defšed
(
_TRACE_PBLK_H
è|| defšed(
TRACE_HEADER_MULTI_READ
)

6 
	#_TRACE_PBLK_H


	)

8 
	~<lšux/Œaûpošt.h
>

10 
	gµa_addr
;

12 
	#show_chunk_æags
(
¡©e
è
	`__´št_æags
(state, "", \

13 { 
NVM_CHK_ST_FREE
, "FREE", }, \

14 { 
NVM_CHK_ST_CLOSED
, "CLOSED", }, \

15 { 
NVM_CHK_ST_OPEN
, "OPEN", }, \

16 { 
NVM_CHK_ST_OFFLINE
, "OFFLINE", })

	)

18 
	#show_lše_¡©e
(
¡©e
è
	`__´št_symbÞic
(state, \

19 { 
PBLK_LINESTATE_NEW
, "NEW", }, \

20 { 
PBLK_LINESTATE_FREE
, "FREE", }, \

21 { 
PBLK_LINESTATE_OPEN
, "OPEN", }, \

22 { 
PBLK_LINESTATE_CLOSED
, "CLOSED", }, \

23 { 
PBLK_LINESTATE_GC
, "GC", }, \

24 { 
PBLK_LINESTATE_BAD
, "BAD", }, \

25 { 
PBLK_LINESTATE_CORRUPT
, "CORRUPT" })

	)

28 
	#show_pblk_¡©e
(
¡©e
è
	`__´št_symbÞic
(state, \

29 { 
PBLK_STATE_RUNNING
, "RUNNING", }, \

30 { 
PBLK_STATE_STOPPING
, "STOPPING", }, \

31 { 
PBLK_STATE_RECOVERING
, "RECOVERING", }, \

32 { 
PBLK_STATE_STOPPED
, "STOPPED" })

	)

34 
	#show_chunk_”a£_¡©e
(
¡©e
è
	`__´št_symbÞic
(state, \

35 { 
PBLK_CHUNK_RESET_START
, "START", }, \

36 { 
PBLK_CHUNK_RESET_DONE
, "OK", }, \

37 { 
PBLK_CHUNK_RESET_FAILED
, "FAILED" })

	)

40 
TRACE_EVENT
(
pblk_chunk_»£t
,

42 
TP_PROTO
(cÚ¡ *
Çme
, 
µa_addr
 *
µa
, 
¡©e
),

44 
TP_ARGS
(
Çme
, 
µa
, 
¡©e
),

46 
TP_STRUCT__’Œy
(

47 
	$__¡ršg
(
Çme
,‚ame)

48 
	$__f›ld
(
u64
, 
µa
)

49 
	`__f›ld
(, 
¡©e
);

52 
	`TP_ç¡_assign
(

53 
	`__assign_¡r
(
Çme
,‚ame);

54 
__’Œy
->
µa
 =…pa->ppa;

55 
__’Œy
->
¡©e
 = state;

58 
	`TP_´štk
("dev=% g½=%Îu…u=%Îu chk=%Îu s‹=%s", 
	`__g‘_¡r
(
Çme
),

59 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
g½
),

60 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
pu
),

61 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
chk
),

62 
	`show_chunk_”a£_¡©e
(()
__’Œy
->
¡©e
))

66 
	`TRACE_EVENT
(
pblk_chunk_¡©e
,

68 
	`TP_PROTO
(cÚ¡ *
Çme
, 
µa_addr
 *
µa
, 
¡©e
),

70 
	`TP_ARGS
(
Çme
, 
µa
, 
¡©e
),

72 
	`TP_STRUCT__’Œy
(

73 
	$__¡ršg
(
Çme
,‚ame)

74 
	$__f›ld
(
u64
, 
µa
)

75 
	`__f›ld
(, 
¡©e
);

78 
	`TP_ç¡_assign
(

79 
	`__assign_¡r
(
Çme
,‚ame);

80 
__’Œy
->
µa
 =…pa->ppa;

81 
__’Œy
->
¡©e
 = state;

84 
	`TP_´štk
("dev=% g½=%Îu…u=%Îu chk=%Îu s‹=%s", 
	`__g‘_¡r
(
Çme
),

85 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
g½
),

86 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
pu
),

87 (
u64
)(((
µa_addr
 *)(&
__’Œy
->
µa
))->
m
.
chk
),

88 
	`show_chunk_æags
(()
__’Œy
->
¡©e
))

92 
	`TRACE_EVENT
(
pblk_lše_¡©e
,

94 
	`TP_PROTO
(cÚ¡ *
Çme
, 
lše
, 
¡©e
),

96 
	`TP_ARGS
(
Çme
, 
lše
, 
¡©e
),

98 
	`TP_STRUCT__’Œy
(

99 
	$__¡ršg
(
Çme
,‚ame)

100 
	$__f›ld
(, 
lše
)

101 
	`__f›ld
(, 
¡©e
);

104 
	`TP_ç¡_assign
(

105 
	`__assign_¡r
(
Çme
,‚ame);

106 
__’Œy
->
lše
 =†ine;

107 
__’Œy
->
¡©e
 = state;

110 
	`TP_´štk
("dev=% lše=%d s‹=%s", 
	`__g‘_¡r
(
Çme
),

111 ()
__’Œy
->
lše
,

112 
	`show_lše_¡©e
(()
__’Œy
->
¡©e
))

116 
	`TRACE_EVENT
(
pblk_¡©e
,

118 
	`TP_PROTO
(cÚ¡ *
Çme
, 
¡©e
),

120 
	`TP_ARGS
(
Çme
, 
¡©e
),

122 
	`TP_STRUCT__’Œy
(

123 
	$__¡ršg
(
Çme
,‚ame)

124 
	`__f›ld
(, 
¡©e
);

127 
	`TP_ç¡_assign
(

128 
	`__assign_¡r
(
Çme
,‚ame);

129 
__’Œy
->
¡©e
 = state;

132 
	`TP_´štk
("dev=% ¡©e=%s", 
	`__g‘_¡r
(
Çme
),

133 
	`show_pblk_¡©e
(()
__’Œy
->
¡©e
))

141 #undeà
TRACE_INCLUDE_PATH


142 
	#TRACE_INCLUDE_PATH
 ../../
driv”s
/
lighŠvm


	)

143 #undeà
TRACE_INCLUDE_FILE


144 
	#TRACE_INCLUDE_FILE
 
pblk
-
Œaû


	)

145 
	~<Œaû/defše_Œaû.h
>

	@pblk-write.c

19 
	~"pblk.h
"

20 
	~"pblk-Œaû.h
"

22 
	$pblk_’d_w_bio
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

23 
pblk_c_ùx
 *
c_ùx
)

25 
bio
 *
Üigš®_bio
;

26 
pblk_rb
 *
rwb
 = &
pblk
->rwb;

27 
»t
;

28 
i
;

30 
i
 = 0; i < 
c_ùx
->
Ä_v®id
; i++) {

31 
pblk_w_ùx
 *
w_ùx
;

32 
pos
 = 
c_ùx
->
£Áry
 + 
i
;

33 
æags
;

35 
w_ùx
 = 
	`pblk_rb_w_ùx
(
rwb
, 
pos
);

36 
æags
 = 
	`READ_ONCE
(
w_ùx
->flags);

38 ià(
æags
 & 
PBLK_FLUSH_ENTRY
) {

39 
æags
 &ð~
PBLK_FLUSH_ENTRY
;

41 
	`smp_¡Üe_»Ëa£
(&
w_ùx
->
æags
, flags);

43 #ifdeà
CONFIG_NVM_PBLK_DEBUG


44 
	`©omic_dec
(&
rwb
->
šæight_æush_pošt
);

48 (
Üigš®_bio
 = 
	`bio_li¡_pÝ
(&
w_ùx
->
bios
)))

49 
	`bio_’dio
(
Üigš®_bio
);

52 ià(
c_ùx
->
Ä_·dded
)

53 
	`pblk_bio_ä“_·ges
(
pblk
, 
rqd
->
bio
, 
c_ùx
->
Ä_v®id
,

54 
c_ùx
->
Ä_·dded
);

56 #ifdeà
CONFIG_NVM_PBLK_DEBUG


57 
	`©omic_lÚg_add
(
rqd
->
Ä_µas
, &
pblk
->
sync_wr™es
);

60 
»t
 = 
	`pblk_rb_sync_advªû
(&
pblk
->
rwb
, 
c_ùx
->
Ä_v®id
);

62 
	`bio_put
(
rqd
->
bio
);

63 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

65  
»t
;

66 
	}
}

68 
	$pblk_’d_queued_w_bio
(
pblk
 *pblk,

69 
nvm_rq
 *
rqd
,

70 
pblk_c_ùx
 *
c_ùx
)

72 
	`li¡_d–
(&
c_ùx
->
li¡
);

73  
	`pblk_’d_w_bio
(
pblk
, 
rqd
, 
c_ùx
);

74 
	}
}

76 
	$pblk_com¶‘e_wr™e
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

77 
pblk_c_ùx
 *
c_ùx
)

79 
pblk_c_ùx
 *
c
, *
r
;

80 
æags
;

81 
pos
;

83 #ifdeà
CONFIG_NVM_PBLK_DEBUG


84 
	`©omic_lÚg_sub
(
c_ùx
->
Ä_v®id
, &
pblk
->
šæight_wr™es
);

86 
	`pblk_up_rq
(
pblk
, 
c_ùx
->
lun_b™m­
);

88 
pos
 = 
	`pblk_rb_sync_š™
(&
pblk
->
rwb
, &
æags
);

89 ià(
pos
 =ð
c_ùx
->
£Áry
) {

90 
pos
 = 
	`pblk_’d_w_bio
(
pblk
, 
rqd
, 
c_ùx
);

92 
»Œy
:

93 
	`li¡_fÜ_—ch_’Œy_§ã
(
c
, 
r
, &
pblk
->
com¶_li¡
, 
li¡
) {

94 
rqd
 = 
	`nvm_rq_äom_c_ùx
(
c
);

95 ià(
c
->
£Áry
 =ð
pos
) {

96 
pos
 = 
	`pblk_’d_queued_w_bio
(
pblk
, 
rqd
, 
c
);

97 
»Œy
;

101 
	`WARN_ON
(
	`nvm_rq_äom_c_ùx
(
c_ùx
è!ð
rqd
);

102 
	`li¡_add_ž
(&
c_ùx
->
li¡
, &
pblk
->
com¶_li¡
);

104 
	`pblk_rb_sync_’d
(&
pblk
->
rwb
, &
æags
);

105 
	}
}

108 
	$pblk_m­_»maššg
(
pblk
 *pblk, 
µa_addr
 *
µa
,

109 
rqd_µas
)

111 
pblk_lše
 *
lše
;

112 
µa_addr
 
m­_µa
 = *
µa
;

113 
__Ë64
 
addr_em±y
 = 
	`ýu_to_Ë64
(
ADDR_EMPTY
);

114 
__Ë64
 *
lba_li¡
;

115 
u64
 
·ddr
;

116 
dÚe
 = 0;

117 
n
 = 0;

119 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, *
µa
);

120 
lba_li¡
 = 
	`em‘a_to_lbas
(
pblk
, 
lše
->
em‘a
->
buf
);

122 
	`¥š_lock
(&
lše
->
lock
);

124 !
dÚe
) {

125 
·ddr
 = 
	`pblk_dev_µa_to_lše_addr
(
pblk
, 
m­_µa
);

127 ià(!
	`‹¡_ªd_£t_b™
(
·ddr
, 
lše
->
m­_b™m­
))

128 
lše
->
Ëá_m£cs
--;

130 ià(
n
 < 
rqd_µas
 && 
lba_li¡
[
·ddr
] !ð
addr_em±y
)

131 
lše
->
Ä_v®id_lbas
--;

133 
lba_li¡
[
·ddr
] = 
addr_em±y
;

135 ià(!
	`‹¡_ªd_£t_b™
(
·ddr
, 
lše
->
šv®id_b™m­
))

136 
	`Ë32_add_ýu
(
lše
->
vsc
, -1);

138 
dÚe
 = 
	`nvm_Ãxt_µa_š_chk
(
pblk
->
dev
, &
m­_µa
);

140 
n
++;

143 
lše
->
w_”r_gc
->
has_wr™e_”r
 = 1;

144 
	`¥š_uÆock
(&
lše
->
lock
);

145 
	}
}

147 
	$pblk_´•¬e_»subm™
(
pblk
 *pblk, 
£Áry
,

148 
Ä_’Œ›s
)

150 
pblk_rb
 *
rb
 = &
pblk
->
rwb
;

151 
pblk_rb_’Œy
 *
’Œy
;

152 
pblk_lše
 *
lše
;

153 
pblk_w_ùx
 *
w_ùx
;

154 
µa_addr
 
µa_l2p
;

155 
æags
;

156 
i
;

158 
	`¥š_lock
(&
pblk
->
Œªs_lock
);

159 
i
 = 0; i < 
Ä_’Œ›s
; i++) {

160 
’Œy
 = &
rb
->
’Œ›s
[
	`pblk_rb_±r_w¿p
Ôb, 
£Áry
, 
i
)];

161 
w_ùx
 = &
’Œy
->w_ctx;

164 ià(
w_ùx
->
lba
 !ð
ADDR_EMPTY
) {

165 
µa_l2p
 = 
	`pblk_Œªs_m­_g‘
(
pblk
, 
w_ùx
->
lba
);

166 ià(!
	`pblk_µa_comp
(
µa_l2p
, 
’Œy
->
ÿch–še
))

167 
w_ùx
->
lba
 = 
ADDR_EMPTY
;

171 
æags
 = 
	`READ_ONCE
(
w_ùx
->flags);

172 
æags
 |ð
PBLK_WRITTEN_DATA
;

174 
	`smp_¡Üe_»Ëa£
(&
w_ùx
->
æags
, flags);

179 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
w_ùx
->
µa
);

180 
	`©omic_dec
(&
lše
->
£c_to_upd©e
);

181 
	`k»f_put
(&
lše
->
»f
, 
pblk_lše_put
);

183 
	`¥š_uÆock
(&
pblk
->
Œªs_lock
);

184 
	}
}

186 
	$pblk_queue_»subm™
(
pblk
 *pblk, 
pblk_c_ùx
 *
c_ùx
)

188 
pblk_c_ùx
 *
r_ùx
;

190 
r_ùx
 = 
	`kz®loc
((
pblk_c_ùx
), 
GFP_KERNEL
);

191 ià(!
r_ùx
)

194 
r_ùx
->
lun_b™m­
 = 
NULL
;

195 
r_ùx
->
£Áry
 = 
c_ùx
->sentry;

196 
r_ùx
->
Ä_v®id
 = 
c_ùx
->nr_valid;

197 
r_ùx
->
Ä_·dded
 = 
c_ùx
->nr_padded;

199 
	`¥š_lock
(&
pblk
->
»subm™_lock
);

200 
	`li¡_add_ž
(&
r_ùx
->
li¡
, &
pblk
->
»subm™_li¡
);

201 
	`¥š_uÆock
(&
pblk
->
»subm™_lock
);

203 #ifdeà
CONFIG_NVM_PBLK_DEBUG


204 
	`©omic_lÚg_add
(
c_ùx
->
Ä_v®id
, &
pblk
->
»cov_wr™es
);

206 
	}
}

208 
	$pblk_subm™_»c
(
wÜk_¡ruù
 *
wÜk
)

210 
pblk_»c_ùx
 *
»cov”y
 =

211 
	`cÚš”_of
(
wÜk
, 
pblk_»c_ùx
, 
ws_»c
);

212 
pblk
 *pblk = 
»cov”y
->pblk;

213 
nvm_rq
 *
rqd
 = 
»cov”y
->rqd;

214 
pblk_c_ùx
 *
c_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

215 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

217 
	`pblk_log_wr™e_”r
(
pblk
, 
rqd
);

219 
	`pblk_m­_»maššg
(
pblk
, 
µa_li¡
, 
rqd
->
Ä_µas
);

220 
	`pblk_queue_»subm™
(
pblk
, 
c_ùx
);

222 
	`pblk_up_rq
(
pblk
, 
c_ùx
->
lun_b™m­
);

223 ià(
c_ùx
->
Ä_·dded
)

224 
	`pblk_bio_ä“_·ges
(
pblk
, 
rqd
->
bio
, 
c_ùx
->
Ä_v®id
,

225 
c_ùx
->
Ä_·dded
);

226 
	`bio_put
(
rqd
->
bio
);

227 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

228 
	`mempoÞ_ä“
(
»cov”y
, &
pblk
->
»c_poÞ
);

230 
	`©omic_dec
(&
pblk
->
šæight_io
);

231 
	`pblk_wr™e_kick
(
pblk
);

232 
	}
}

235 
	$pblk_’d_w_çž
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

237 
pblk_»c_ùx
 *
»cov”y
;

239 
»cov”y
 = 
	`mempoÞ_®loc
(&
pblk
->
»c_poÞ
, 
GFP_ATOMIC
);

240 ià(!
»cov”y
) {

241 
	`pblk_”r
(
pblk
, "could‚ot‡llocate„ecovery work\n");

245 
»cov”y
->
pblk
 =…blk;

246 
»cov”y
->
rqd
 =„qd;

248 
	`INIT_WORK
(&
»cov”y
->
ws_»c
, 
pblk_subm™_»c
);

249 
	`queue_wÜk
(
pblk
->
þo£_wq
, &
»cov”y
->
ws_»c
);

250 
	}
}

252 
	$pblk_’d_io_wr™e
(
nvm_rq
 *
rqd
)

254 
pblk
 *pblk = 
rqd
->
´iv©e
;

255 
pblk_c_ùx
 *
c_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

257 ià(
rqd
->
”rÜ
) {

258 
	`pblk_’d_w_çž
(
pblk
, 
rqd
);

261 ià(
	`Œaû_pblk_chunk_¡©e_’abËd
())

262 
	`pblk_check_chunk_¡©e_upd©e
(
pblk
, 
rqd
);

263 #ifdeà
CONFIG_NVM_PBLK_DEBUG


264 
	`WARN_ONCE
(
rqd
->
bio
->
bi_¡©us
, "pblk: corrupted writeƒrror\n");

268 
	`pblk_com¶‘e_wr™e
(
pblk
, 
rqd
, 
c_ùx
);

269 
	`©omic_dec
(&
pblk
->
šæight_io
);

270 
	}
}

272 
	$pblk_’d_io_wr™e_m‘a
(
nvm_rq
 *
rqd
)

274 
pblk
 *pblk = 
rqd
->
´iv©e
;

275 
pblk_g_ùx
 *
m_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

276 
pblk_lše
 *
lše
 = 
m_ùx
->
´iv©e
;

277 
pblk_em‘a
 *
em‘a
 = 
lše
->emeta;

278 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

279 
sync
;

281 
	`pblk_up_chunk
(
pblk
, 
µa_li¡
[0]);

283 ià(
rqd
->
”rÜ
) {

284 
	`pblk_log_wr™e_”r
(
pblk
, 
rqd
);

285 
	`pblk_”r
(
pblk
, "m‘ad©¨I/O fažed. Lš%d\n", 
lše
->
id
);

286 
lše
->
w_”r_gc
->
has_wr™e_”r
 = 1;

288 ià(
	`Œaû_pblk_chunk_¡©e_’abËd
())

289 
	`pblk_check_chunk_¡©e_upd©e
(
pblk
, 
rqd
);

292 
sync
 = 
	`©omic_add_»tuº
(
rqd
->
Ä_µas
, &
em‘a
->sync);

293 ià(
sync
 =ð
em‘a
->
Ä_’Œ›s
)

294 
	`pblk_g’_run_ws
(
pblk
, 
lše
, 
NULL
, 
pblk_lše_þo£_ws
,

295 
GFP_ATOMIC
, 
pblk
->
þo£_wq
);

297 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

299 
	`©omic_dec
(&
pblk
->
šæight_io
);

300 
	}
}

302 
pblk_®loc_w_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

303 
Ä_£cs
, 
	$nvm_’d_io_â
(*
’d_io
))

306 
rqd
->
Ýcode
 = 
NVM_OP_PWRITE
;

307 
rqd
->
Ä_µas
 = 
Ä_£cs
;

308 
rqd
->
is_£q
 = 1;

309 
rqd
->
´iv©e
 = 
pblk
;

310 
rqd
->
’d_io
 =ƒnd_io;

312  
	`pblk_®loc_rqd_m‘a
(
pblk
, 
rqd
);

313 
	}
}

315 
	$pblk_£tup_w_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

316 
µa_addr
 *
”a£_µa
)

318 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

319 
pblk_lše
 *
e_lše
 = 
	`pblk_lše_g‘_”a£
(
pblk
);

320 
pblk_c_ùx
 *
c_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

321 
v®id
 = 
c_ùx
->
Ä_v®id
;

322 
·dded
 = 
c_ùx
->
Ä_·dded
;

323 
Ä_£cs
 = 
v®id
 + 
·dded
;

324 *
lun_b™m­
;

325 
»t
;

327 
lun_b™m­
 = 
	`kz®loc
(
lm
->
lun_b™m­_Ën
, 
GFP_KERNEL
);

328 ià(!
lun_b™m­
)

329  -
ENOMEM
;

330 
c_ùx
->
lun_b™m­
 =†un_bitmap;

332 
»t
 = 
	`pblk_®loc_w_rq
(
pblk
, 
rqd
, 
Ä_£cs
, 
pblk_’d_io_wr™e
);

333 ià(
»t
) {

334 
	`kä“
(
lun_b™m­
);

335  
»t
;

338 ià(
	`lik–y
(!
e_lše
 || !
	`©omic_»ad
(&e_lše->
Ëá_eblks
)))

339 
»t
 = 
	`pblk_m­_rq
(
pblk
, 
rqd
, 
c_ùx
->
£Áry
, 
lun_b™m­
,

340 
v®id
, 0);

342 
»t
 = 
	`pblk_m­_”a£_rq
(
pblk
, 
rqd
, 
c_ùx
->
£Áry
, 
lun_b™m­
,

343 
v®id
, 
”a£_µa
);

345  
»t
;

346 
	}
}

348 
	$pblk_ÿlc_£cs_to_sync
(
pblk
 *pblk, 
£cs_avaž
,

349 
£cs_to_æush
)

351 
£cs_to_sync
;

353 
£cs_to_sync
 = 
	`pblk_ÿlc_£cs
(
pblk
, 
£cs_avaž
, 
£cs_to_æush
, 
Œue
);

355 #ifdeà
CONFIG_NVM_PBLK_DEBUG


356 ià((!
£cs_to_sync
 && 
£cs_to_æush
)

357 || (
£cs_to_sync
 < 0)

358 || (
£cs_to_sync
 > 
£cs_avaž
 && !
£cs_to_æush
)) {

359 
	`pblk_”r
(
pblk
, "bad sector calculation (a:%d,s:%d,f:%d)\n",

360 
£cs_avaž
, 
£cs_to_sync
, 
£cs_to_æush
);

364  
£cs_to_sync
;

365 
	}
}

367 
	$pblk_subm™_m‘a_io
(
pblk
 *pblk, 
pblk_lše
 *
m‘a_lše
)

369 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

370 
nvm_geo
 *
geo
 = &
dev
->geo;

371 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

372 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

373 
pblk_em‘a
 *
em‘a
 = 
m‘a_lše
->emeta;

374 
µa_addr
 *
µa_li¡
;

375 
pblk_g_ùx
 *
m_ùx
;

376 
bio
 *bio;

377 
nvm_rq
 *
rqd
;

378 *
d©a
;

379 
u64
 
·ddr
;

380 
rq_µas
 = 
pblk
->
mš_wr™e_pgs
;

381 
id
 = 
m‘a_lše
->id;

382 
rq_Ën
;

383 
i
, 
j
;

384 
»t
;

386 
rqd
 = 
	`pblk_®loc_rqd
(
pblk
, 
PBLK_WRITE_INT
);

388 
m_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

389 
m_ùx
->
´iv©e
 = 
m‘a_lše
;

391 
rq_Ën
 = 
rq_µas
 * 
geo
->
c£cs
;

392 
d©a
 = ((*)
em‘a
->
buf
è+ƒm‘a->
mem
;

394 
bio
 = 
	`pblk_bio_m­_addr
(
pblk
, 
d©a
, 
rq_µas
, 
rq_Ën
,

395 
l_mg
->
em‘a_®loc_ty³
, 
GFP_KERNEL
);

396 ià(
	`IS_ERR
(
bio
)) {

397 
	`pblk_”r
(
pblk
, "failedo mapƒmeta io");

398 
»t
 = 
	`PTR_ERR
(
bio
);

399 
çž_ä“_rqd
;

401 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

402 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

403 
rqd
->
bio
 = bio;

405 
»t
 = 
	`pblk_®loc_w_rq
(
pblk
, 
rqd
, 
rq_µas
, 
pblk_’d_io_wr™e_m‘a
);

406 ià(
»t
)

407 
çž_ä“_bio
;

409 
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

410 
i
 = 0; i < 
rqd
->
Ä_µas
; ) {

411 
	`¥š_lock
(&
m‘a_lše
->
lock
);

412 
·ddr
 = 
	`__pblk_®loc_·ge
(
pblk
, 
m‘a_lše
, 
rq_µas
);

413 
	`¥š_uÆock
(&
m‘a_lše
->
lock
);

414 
j
 = 0; j < 
rq_µas
; j++, 
i
++, 
·ddr
++)

415 
µa_li¡
[
i
] = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 
id
);

418 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

419 
em‘a
->
mem
 +ð
rq_Ën
;

420 ià(
em‘a
->
mem
 >ð
lm
->
em‘a_Ën
[0])

421 
	`li¡_d–
(&
m‘a_lše
->
li¡
);

422 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

424 
	`pblk_down_chunk
(
pblk
, 
µa_li¡
[0]);

426 
»t
 = 
	`pblk_subm™_io
(
pblk
, 
rqd
);

427 ià(
»t
) {

428 
	`pblk_”r
(
pblk
, "em‘¨I/O submissiÚ fažed: %d\n", 
»t
);

429 
çž_rÞlback
;

432  
NVM_IO_OK
;

434 
çž_rÞlback
:

435 
	`pblk_up_chunk
(
pblk
, 
µa_li¡
[0]);

436 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

437 
	`pblk_d—Îoc_·ge
(
pblk
, 
m‘a_lše
, 
rq_µas
);

438 
	`li¡_add
(&
m‘a_lše
->
li¡
, &meta_line->list);

439 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

440 
çž_ä“_bio
:

441 
	`bio_put
(
bio
);

442 
çž_ä“_rqd
:

443 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

444  
»t
;

445 
	}
}

447 
šlše
 
boÞ
 
	$pblk_v®id_m‘a_µa
(
pblk
 *pblk,

448 
pblk_lše
 *
m‘a_lše
,

449 
nvm_rq
 *
d©a_rqd
)

451 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

452 
nvm_geo
 *
geo
 = &
dev
->geo;

453 
pblk_c_ùx
 *
d©a_c_ùx
 = 
	`nvm_rq_to_pdu
(
d©a_rqd
);

454 
pblk_lše
 *
d©a_lše
 = 
	`pblk_lše_g‘_d©a
(
pblk
);

455 
µa_addr
 
µa
, 
µa_Ýt
;

456 
u64
 
·ddr
;

457 
pos_Ýt
;

468 
·ddr
 = 
	`pblk_lookup_·ge
(
pblk
, 
m‘a_lše
);

469 
µa
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
, 0);

470 
µa_Ýt
 = 
	`addr_to_g’_µa
(
pblk
, 
·ddr
 + 
d©a_lše
->
m‘a_di¡ªû
, 0);

471 
pos_Ýt
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_Ýt
);

473 ià(
	`‹¡_b™
(
pos_Ýt
, 
d©a_c_ùx
->
lun_b™m­
) ||

474 
	`‹¡_b™
(
pos_Ýt
, 
d©a_lše
->
blk_b™m­
))

475  
Œue
;

477 ià(
	`uÆik–y
(
	`pblk_µa_comp
(
µa_Ýt
, 
µa
)))

478 
d©a_lše
->
m‘a_di¡ªû
--;

480  
çl£
;

481 
	}
}

483 
pblk_lše
 *
	$pblk_should_subm™_m‘a_io
(
pblk
 *pblk,

484 
nvm_rq
 *
d©a_rqd
)

486 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

487 
pblk_lše_mgmt
 *
l_mg
 = &
pblk
->l_mg;

488 
pblk_lše
 *
m‘a_lše
;

490 
	`¥š_lock
(&
l_mg
->
þo£_lock
);

491 ià(
	`li¡_em±y
(&
l_mg
->
em‘a_li¡
)) {

492 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

493  
NULL
;

495 
m‘a_lše
 = 
	`li¡_fœ¡_’Œy
(&
l_mg
->
em‘a_li¡
, 
pblk_lše
, 
li¡
);

496 ià(
m‘a_lše
->
em‘a
->
mem
 >ð
lm
->
em‘a_Ën
[0]) {

497 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

498  
NULL
;

500 
	`¥š_uÆock
(&
l_mg
->
þo£_lock
);

502 ià(!
	`pblk_v®id_m‘a_µa
(
pblk
, 
m‘a_lše
, 
d©a_rqd
))

503  
NULL
;

505  
m‘a_lše
;

506 
	}
}

508 
	$pblk_subm™_io_£t
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

510 
µa_addr
 
”a£_µa
;

511 
pblk_lše
 *
m‘a_lše
;

512 
”r
;

514 
	`pblk_µa_£t_em±y
(&
”a£_µa
);

517 
”r
 = 
	`pblk_£tup_w_rq
(
pblk
, 
rqd
, &
”a£_µa
);

518 ià(
”r
) {

519 
	`pblk_”r
(
pblk
, "could‚Ù s‘u°wr™»que¡: %d\n", 
”r
);

520  
NVM_IO_ERR
;

523 
m‘a_lše
 = 
	`pblk_should_subm™_m‘a_io
(
pblk
, 
rqd
);

526 
”r
 = 
	`pblk_subm™_io
(
pblk
, 
rqd
);

527 ià(
”r
) {

528 
	`pblk_”r
(
pblk
, "d©¨I/O submissiÚ fažed: %d\n", 
”r
);

529  
NVM_IO_ERR
;

532 ià(!
	`pblk_µa_em±y
(
”a£_µa
)) {

534 ià(
	`pblk_blk_”a£_async
(
pblk
, 
”a£_µa
)) {

535 
pblk_lše
 *
e_lše
 = 
	`pblk_lše_g‘_”a£
(
pblk
);

536 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

537 
nvm_geo
 *
geo
 = &
dev
->geo;

538 
b™
;

540 
	`©omic_šc
(&
e_lše
->
Ëá_eblks
);

541 
b™
 = 
	`pblk_µa_to_pos
(
geo
, 
”a£_µa
);

542 
	`WARN_ON
(!
	`‹¡_ªd_þ—r_b™
(
b™
, 
e_lše
->
”a£_b™m­
));

546 ià(
m‘a_lše
) {

548 
”r
 = 
	`pblk_subm™_m‘a_io
(
pblk
, 
m‘a_lše
);

549 ià(
”r
) {

550 
	`pblk_”r
(
pblk
, "metadata I/O submission failed: %d",

551 
”r
);

552  
NVM_IO_ERR
;

556  
NVM_IO_OK
;

557 
	}
}

559 
	$pblk_ä“_wr™e_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

561 
pblk_c_ùx
 *
c_ùx
 = 
	`nvm_rq_to_pdu
(
rqd
);

562 
bio
 *biØð
rqd
->bio;

564 ià(
c_ùx
->
Ä_·dded
)

565 
	`pblk_bio_ä“_·ges
(
pblk
, 
bio
, 
c_ùx
->
Ä_v®id
,

566 
c_ùx
->
Ä_·dded
);

567 
	}
}

569 
	$pblk_subm™_wr™e
(
pblk
 *pblk, *
£cs_Ëá
)

571 
bio
 *bio;

572 
nvm_rq
 *
rqd
;

573 
£cs_avaž
, 
£cs_to_sync
, 
£cs_to_com
;

574 
£cs_to_æush
, 
·cked_m‘a_pgs
;

575 
pos
;

576 
»subm™
;

578 *
£cs_Ëá
 = 0;

580 
	`¥š_lock
(&
pblk
->
»subm™_lock
);

581 
»subm™
 = !
	`li¡_em±y
(&
pblk
->
»subm™_li¡
);

582 
	`¥š_uÆock
(&
pblk
->
»subm™_lock
);

585 ià(
»subm™
) {

586 
pblk_c_ùx
 *
r_ùx
;

588 
	`¥š_lock
(&
pblk
->
»subm™_lock
);

589 
r_ùx
 = 
	`li¡_fœ¡_’Œy
(&
pblk
->
»subm™_li¡
,

590 
pblk_c_ùx
, 
li¡
);

591 
	`li¡_d–
(&
r_ùx
->
li¡
);

592 
	`¥š_uÆock
(&
pblk
->
»subm™_lock
);

594 
£cs_avaž
 = 
r_ùx
->
Ä_v®id
;

595 
pos
 = 
r_ùx
->
£Áry
;

597 
	`pblk_´•¬e_»subm™
(
pblk
, 
pos
, 
£cs_avaž
);

598 
£cs_to_sync
 = 
	`pblk_ÿlc_£cs_to_sync
(
pblk
, 
£cs_avaž
,

599 
£cs_avaž
);

601 
	`kä“
(
r_ùx
);

607 
£cs_avaž
 = 
	`pblk_rb_»ad_couÁ
(&
pblk
->
rwb
);

608 ià(!
£cs_avaž
)

611 
£cs_to_æush
 = 
	`pblk_rb_æush_pošt_couÁ
(&
pblk
->
rwb
);

612 ià(!
£cs_to_æush
 && 
£cs_avaž
 < 
pblk
->
mš_wr™e_pgs_d©a
)

615 
£cs_to_sync
 = 
	`pblk_ÿlc_£cs_to_sync
(
pblk
, 
£cs_avaž
,

616 
£cs_to_æush
);

617 ià(
£cs_to_sync
 > 
pblk
->
max_wr™e_pgs
) {

618 
	`pblk_”r
(
pblk
, "bad buffer sync calculation\n");

622 
£cs_to_com
 = (
£cs_to_sync
 > 
£cs_avaž
) ?

623 
£cs_avaž
 : 
£cs_to_sync
;

624 
pos
 = 
	`pblk_rb_»ad_comm™
(&
pblk
->
rwb
, 
£cs_to_com
);

627 
·cked_m‘a_pgs
 = (
pblk
->
mš_wr™e_pgs
 -…blk->
mš_wr™e_pgs_d©a
);

628 
bio
 = 
	`bio_®loc
(
GFP_KERNEL
, 
£cs_to_sync
 + 
·cked_m‘a_pgs
);

630 
bio
->
bi_™”
.
bi_£ùÜ
 = 0;

631 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

633 
rqd
 = 
	`pblk_®loc_rqd
(
pblk
, 
PBLK_WRITE
);

634 
rqd
->
bio
 = bio;

636 ià(
	`pblk_rb_»ad_to_bio
(&
pblk
->
rwb
, 
rqd
, 
pos
, 
£cs_to_sync
,

637 
£cs_avaž
)) {

638 
	`pblk_”r
(
pblk
, "corrupted write bio\n");

639 
çž_put_bio
;

642 ià(
	`pblk_subm™_io_£t
(
pblk
, 
rqd
))

643 
çž_ä“_bio
;

645 #ifdeà
CONFIG_NVM_PBLK_DEBUG


646 
	`©omic_lÚg_add
(
£cs_to_sync
, &
pblk
->
sub_wr™es
);

649 *
£cs_Ëá
 = 1;

652 
çž_ä“_bio
:

653 
	`pblk_ä“_wr™e_rqd
(
pblk
, 
rqd
);

654 
çž_put_bio
:

655 
	`bio_put
(
bio
);

656 
	`pblk_ä“_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

658  -
EINTR
;

659 
	}
}

661 
	$pblk_wr™e_ts
(*
d©a
)

663 
pblk
 *pblk = 
d©a
;

664 
£cs_Ëá
;

665 
wr™e_çžu»
 = 0;

667 !
	`kth»ad_should_¡Ý
()) {

668 ià(!
wr™e_çžu»
) {

669 
wr™e_çžu»
 = 
	`pblk_subm™_wr™e
(
pblk
, &
£cs_Ëá
);

671 ià(
£cs_Ëá
)

674 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

675 
	`io_scheduË
();

679 
	}
}

	@pblk.h

21 #iâdeà
PBLK_H_


22 
	#PBLK_H_


	)

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/blk-mq.h
>

26 
	~<lšux/bio.h
>

27 
	~<lšux/moduË.h
>

28 
	~<lšux/kth»ad.h
>

29 
	~<lšux/vm®loc.h
>

30 
	~<lšux/üc32.h
>

31 
	~<lšux/uuid.h
>

33 
	~<lšux/lighŠvm.h
>

36 
	#GC_LIMIT_INVERSE
 5

	)

37 
	#GC_TIME_MSECS
 1000

	)

39 
	#PBLK_SECTOR
 (512)

	)

40 
	#PBLK_EXPOSED_PAGE_SIZE
 (4096)

	)

42 
	#PBLK_NR_CLOSE_JOBS
 (4)

	)

44 
	#PBLK_CACHE_NAME_LEN
 (
DISK_NAME_LEN
 + 16)

	)

47 
	#PBLK_MAX_LUNS_BITMAP
 (4)

	)

49 
	#NR_PHY_IN_LOG
 (
PBLK_EXPOSED_PAGE_SIZE
 / 
PBLK_SECTOR
)

	)

52 
	#PBLK_GEN_WS_POOL_SIZE
 (2)

	)

54 
	#PBLK_DEFAULT_OP
 (11)

	)

57 
	mPBLK_READ
 = 
READ
,

58 
	mPBLK_WRITE
 = 
WRITE
,

59 
	mPBLK_WRITE_INT
,

60 
	mPBLK_READ_RECOV
,

61 
	mPBLK_ERASE
,

66 
	mPBLK_IOTYPE_USER
 = 1 << 0,

67 
	mPBLK_IOTYPE_GC
 = 1 << 1,

70 
	mPBLK_FLUSH_ENTRY
 = 1 << 2,

71 
	mPBLK_WRITTEN_DATA
 = 1 << 3,

72 
	mPBLK_SUBMITTED_ENTRY
 = 1 << 4,

73 
	mPBLK_WRITABLE_ENTRY
 = 1 << 5,

77 
	mPBLK_BLK_ST_OPEN
 = 0x1,

78 
	mPBLK_BLK_ST_CLOSED
 = 0x2,

82 
	mPBLK_CHUNK_RESET_START
,

83 
	mPBLK_CHUNK_RESET_DONE
,

84 
	mPBLK_CHUNK_RESET_FAILED
,

87 
	spblk_£c_m‘a
 {

88 
u64
 
	m»£rved
;

89 
__Ë64
 
	mlba
;

95 
	#PBLK_GC_NR_LISTS
 4

	)

98 
	mPBLK_RL_OFF
 = 0,

99 
	mPBLK_RL_WERR
 = 1,

100 
	mPBLK_RL_HIGH
 = 2,

101 
	mPBLK_RL_MID
 = 3,

102 
	mPBLK_RL_LOW
 = 4

105 
	#pblk_dma_µa_size
 ((
u64
è* 
NVM_MAX_VLBA
)

	)

108 
	spblk_c_ùx
 {

109 
li¡_h—d
 
	mli¡
;

111 *
	mlun_b™m­
;

112 
	m£Áry
;

113 
	mÄ_v®id
;

114 
	mÄ_·dded
;

118 
	spblk_g_ùx
 {

119 *
	m´iv©e
;

120 
	m¡¬t_time
;

121 
u64
 
	mlba
;

125 
	spblk_·d_rq
 {

126 
pblk
 *
	mpblk
;

127 
com¶‘iÚ
 
	mwa™
;

128 
k»f
 
	m»f
;

132 
	spblk_»c_ùx
 {

133 
pblk
 *
	mpblk
;

134 
nvm_rq
 *
	mrqd
;

135 
wÜk_¡ruù
 
	mws_»c
;

139 
	spblk_w_ùx
 {

140 
bio_li¡
 
	mbios
;

143 
u64
 
	mlba
;

144 
µa_addr
 
	mµa
;

145 
	mæags
;

148 
	spblk_rb_’Œy
 {

149 
µa_addr
 
	mÿch–še
;

150 *
	md©a
;

151 
pblk_w_ùx
 
	mw_ùx
;

152 
li¡_h—d
 
	mšdex
;

155 
	#EMPTY_ENTRY
 (~0U)

	)

157 
	spblk_rb_·ges
 {

158 
·ge
 *
	m·ges
;

159 
	mÜd”
;

160 
li¡_h—d
 
	mli¡
;

163 
	spblk_rb
 {

164 
pblk_rb_’Œy
 *
	m’Œ›s
;

165 
	mmem
;

168 
	msubm
;

172 
	msync
;

176 
	mæush_pošt
;

180 
	ml2p_upd©e
;

185 
	mÄ_’Œ›s
;

188 
	m£g_size
;

193 
	mback_th»s
;

198 
li¡_h—d
 
	m·ges
;

200 
¥šlock_t
 
	mw_lock
;

201 
¥šlock_t
 
	ms_lock
;

203 #ifdeà
CONFIG_NVM_PBLK_DEBUG


204 
©omic_t
 
	mšæight_æush_pošt
;

208 
	#PBLK_RECOVERY_SECTORS
 16

	)

210 
	spblk_lun
 {

211 
µa_addr
 
	mbµa
;

212 
£m­hÜe
 
	mwr_£m
;

215 
	spblk_gc_rq
 {

216 
pblk_lše
 *
	mlše
;

217 *
	md©a
;

218 
u64
 
	m·ddr_li¡
[
NVM_MAX_VLBA
];

219 
u64
 
	mlba_li¡
[
NVM_MAX_VLBA
];

220 
	mÄ_£cs
;

221 
	m£cs_to_gc
;

222 
li¡_h—d
 
	mli¡
;

225 
	spblk_gc
 {

229 
	mgc_aùive
;

230 
	mgc_’abËd
;

231 
	mgc_fÜûd
;

233 
sk_¡ruù
 *
	mgc_ts
;

234 
sk_¡ruù
 *
	mgc_wr™”_ts
;

235 
sk_¡ruù
 *
	mgc_»ad”_ts
;

237 
wÜkqueue_¡ruù
 *
	mgc_lše_»ad”_wq
;

238 
wÜkqueue_¡ruù
 *
	mgc_»ad”_wq
;

240 
tim”_li¡
 
	mgc_tim”
;

242 
£m­hÜe
 
	mgc_£m
;

243 
©omic_t
 
	m»ad_šæight_gc
;

244 
©omic_t
 
	mp–še_gc
;

247 
	mw_’Œ›s
;

249 
li¡_h—d
 
	mw_li¡
;

250 
li¡_h—d
 
	mr_li¡
;

252 
¥šlock_t
 
	mlock
;

253 
¥šlock_t
 
	mw_lock
;

254 
¥šlock_t
 
	mr_lock
;

257 
	spblk_¾
 {

258 
	mhigh
;

261 
	mhigh_pw
;

263 
	#PBLK_USER_HIGH_THRS
 8

	)

264 
	#PBLK_USER_LOW_THRS
 10

	)

266 
	mrb_wšdows_pw
;

274 
	mrb_budg‘
;

275 
	mrb_u£r_max
;

276 
	mrb_gc_max
;

277 
	mrb_gc_rsv
;

278 
	mrb_¡©e
;

279 
	mrb_max_io
;

281 
©omic_t
 
	mrb_u£r_út
;

282 
©omic_t
 
	mrb_gc_út
;

283 
©omic_t
 
	mrb_¥aû
;

285 
	mrsv_blocks
;

287 
	mrb_u£r_aùive
;

288 
	mrb_gc_aùive
;

290 
©omic_t
 
	mw”r_lšes
;

292 
tim”_li¡
 
	mu_tim”
;

294 
	mtÙ®_blocks
;

296 
©omic_t
 
	mä“_blocks
;

297 
©omic_t
 
	mä“_u£r_blocks
;

300 
	#PBLK_LINE_EMPTY
 (~0U)

	)

304 
	mPBLK_LINETYPE_FREE
 = 0,

305 
	mPBLK_LINETYPE_LOG
 = 1,

306 
	mPBLK_LINETYPE_DATA
 = 2,

309 
	mPBLK_LINESTATE_NEW
 = 9,

310 
	mPBLK_LINESTATE_FREE
 = 10,

311 
	mPBLK_LINESTATE_OPEN
 = 11,

312 
	mPBLK_LINESTATE_CLOSED
 = 12,

313 
	mPBLK_LINESTATE_GC
 = 13,

314 
	mPBLK_LINESTATE_BAD
 = 14,

315 
	mPBLK_LINESTATE_CORRUPT
 = 15,

318 
	mPBLK_LINEGC_NONE
 = 20,

319 
	mPBLK_LINEGC_EMPTY
 = 21,

320 
	mPBLK_LINEGC_LOW
 = 22,

321 
	mPBLK_LINEGC_MID
 = 23,

322 
	mPBLK_LINEGC_HIGH
 = 24,

323 
	mPBLK_LINEGC_FULL
 = 25,

324 
	mPBLK_LINEGC_WERR
 = 26

327 
	#PBLK_MAGIC
 0x70626c6b

	)

335 
	#SMETA_VERSION_MAJOR
 (0)

	)

336 
	#SMETA_VERSION_MINOR
 (1)

	)

338 
	#EMETA_VERSION_MAJOR
 (0)

	)

339 
	#EMETA_VERSION_MINOR
 (2)

	)

341 
	slše_h—d”
 {

342 
__Ë32
 
	müc
;

343 
__Ë32
 
	mid’tif›r
;

344 
__u8
 
	muuid
[16];

345 
__Ë16
 
	mty³
;

346 
__u8
 
	mv”siÚ_majÜ
;

347 
__u8
 
	mv”siÚ_mšÜ
;

348 
__Ë32
 
	mid
;

351 
	slše_sm‘a
 {

352 
lše_h—d”
 
	mh—d”
;

354 
__Ë32
 
	müc
;

356 
__Ë32
 
	m´ev_id
;

359 
__Ë64
 
	m£q_Ä
;

362 
__Ë32
 
	mwšdow_wr_lun
;

364 
__Ë32
 
	mrsvd
[2];

366 
__Ë64
 
	mlun_b™m­
[];

381 
	slše_em‘a
 {

382 
lše_h—d”
 
	mh—d”
;

384 
__Ë32
 
	müc
;

387 
__Ë32
 
	m´ev_id
;

390 
__Ë64
 
	m£q_Ä
;

393 
__Ë32
 
	mwšdow_wr_lun
;

396 
__Ë32
 
	mÃxt_id
;

397 
__Ë64
 
	mÄ_lbas
;

398 
__Ë64
 
	mÄ_v®id_lbas
;

399 
__Ë64
 
	mbb_b™m­
[];

404 
	swa_couÁ”s
 {

405 
__Ë64
 
	mu£r
;

406 
__Ë64
 
	mgc
;

407 
__Ë64
 
	m·d
;

410 
	spblk_em‘a
 {

411 
lše_em‘a
 *
	mbuf
;

412 
	mmem
;

415 
©omic_t
 
	msync
;

419 
	mÄ_’Œ›s
;

422 
	spblk_sm‘a
 {

423 
lše_sm‘a
 *
	mbuf
;

426 
	spblk_w_”r_gc
 {

427 
	mhas_wr™e_”r
;

428 
	mhas_gc_”r
;

429 
__Ë64
 *
	mlba_li¡
;

432 
	spblk_lše
 {

433 
pblk
 *
	mpblk
;

434 
	mid
;

437 
	m£q_Ä
;

439 
	m¡©e
;

440 
	mty³
;

441 
	mgc_group
;

442 
li¡_h—d
 
	mli¡
;

444 *
	mlun_b™m­
;

446 
nvm_chk_m‘a
 *
	mchks
;

448 
pblk_sm‘a
 *
	msm‘a
;

449 
pblk_em‘a
 *
	mem‘a
;

451 
	mm‘a_lše
;

452 
	mm‘a_di¡ªû
;

454 
u64
 
	mem‘a_s£c
;

456 
	m£c_š_lše
;

458 
©omic_t
 
	mblk_š_lše
;

459 *
	mblk_b™m­
;

460 *
	m”a£_b™m­
;

462 *
	mm­_b™m­
;

463 *
	mšv®id_b™m­
;

465 
©omic_t
 
	mËá_eblks
;

466 
©omic_t
 
	mËá_£blks
;

468 
	mËá_m£cs
;

469 
	mcur_£c
;

470 
	mÄ_v®id_lbas
;

472 
__Ë32
 *
	mvsc
;

474 
k»f
 
	m»f
;

475 
©omic_t
 
	m£c_to_upd©e
;

477 
pblk_w_”r_gc
 *
	mw_”r_gc
;

479 
¥šlock_t
 
	mlock
;

482 
	#PBLK_DATA_LINES
 4

	)

485 
	mPBLK_KMALLOC_META
 = 1,

486 
	mPBLK_VMALLOC_META
 = 2,

490 
	mPBLK_EMETA_TYPE_HEADER
 = 1,

491 
	mPBLK_EMETA_TYPE_LLBA
 = 2,

492 
	mPBLK_EMETA_TYPE_VSC
 = 3,

495 
	spblk_lše_mgmt
 {

496 
	mÄ_lšes
;

497 
	mÄ_ä“_lšes
;

500 
li¡_h—d
 
	mä“_li¡
;

501 
li¡_h—d
 
	mcÜru±_li¡
;

502 
li¡_h—d
 
	mbad_li¡
;

505 
li¡_h—d
 *
	mgc_li¡s
[
PBLK_GC_NR_LISTS
];

506 
li¡_h—d
 
	mgc_high_li¡
;

507 
li¡_h—d
 
	mgc_mid_li¡
;

508 
li¡_h—d
 
	mgc_low_li¡
;

510 
li¡_h—d
 
	mgc_w”r_li¡
;

512 
li¡_h—d
 
	mgc_fuÎ_li¡
;

513 
li¡_h—d
 
	mgc_em±y_li¡
;

515 
pblk_lše
 *
	mlog_lše
;

516 
pblk_lše
 *
	md©a_lše
;

517 
pblk_lše
 *
	mlog_Ãxt
;

518 
pblk_lše
 *
	md©a_Ãxt
;

520 
li¡_h—d
 
	mem‘a_li¡
;

522 
__Ë32
 *
	mvsc_li¡
;

525 
	mem‘a_®loc_ty³
;

528 
pblk_sm‘a
 *
	m¦še_m‘a
[
PBLK_DATA_LINES
];

529 
pblk_em‘a
 *
	m–še_m‘a
[
PBLK_DATA_LINES
];

530 
	mm‘a_b™m­
;

533 
kmem_ÿche
 *
	mb™m­_ÿche
;

534 
mempoÞ_t
 *
	mb™m­_poÞ
;

537 *
	mbb_‹m¶©e
;

538 *
	mbb_aux
;

540 
	md_£q_Ä
;

541 
	ml_£q_Ä
;

543 
¥šlock_t
 
	mä“_lock
;

544 
¥šlock_t
 
	mþo£_lock
;

545 
¥šlock_t
 
	mgc_lock
;

548 
	spblk_lše_m‘a
 {

549 
	msm‘a_Ën
;

550 
	msm‘a_£c
;

552 
	mem‘a_Ën
[4];

559 
	mem‘a_£c
[4];

563 
	mem‘a_bb
;

565 
	mvsc_li¡_Ën
;

566 
	m£c_b™m­_Ën
;

567 
	mblk_b™m­_Ën
;

568 
	mlun_b™m­_Ën
;

570 
	mblk_³r_lše
;

571 
	m£c_³r_lše
;

572 
	md£c_³r_lše
;

573 
	mmš_blk_lše
;

575 
	mmid_thrs
;

576 
	mhigh_thrs
;

578 
	mm‘a_di¡ªû
;

582 
	mPBLK_STATE_RUNNING
 = 0,

583 
	mPBLK_STATE_STOPPING
 = 1,

584 
	mPBLK_STATE_RECOVERING
 = 2,

585 
	mPBLK_STATE_STOPPED
 = 3,

589 
	spblk_addrf
 {

591 
	m£c_¡re
;

592 
	mch_¡re
;

593 
	mlun_¡re
;

596 
	m£c_lun_¡re
;

597 
	m£c_ws_¡re
;

600 
	spblk
 {

601 
nvm_tgt_dev
 *
	mdev
;

602 
g’disk
 *
	mdisk
;

604 
kobjeù
 
	mkobj
;

606 
pblk_lun
 *
	mluns
;

608 
pblk_lše
 *
	mlšes
;

609 
pblk_lše_mgmt
 
	ml_mg
;

610 
pblk_lše_m‘a
 
	mlm
;

612 
nvm_addrf
 
	maddrf
;

613 
pblk_addrf
 
	muaddrf
;

614 
	maddrf_Ën
;

616 
pblk_rb
 
	mrwb
;

618 
	m¡©e
;

620 
	mmš_wr™e_pgs
;

621 
	mmš_wr™e_pgs_d©a
;

622 
	mmax_wr™e_pgs
;

623 
	moob_m‘a_size
;

625 
£ùÜ_t
 
	mÿ·c™y
;

627 
	mÝ
;

628 
	mÝ_blks
;

631 
pblk_¾
 
	m¾
;

633 
	m£c_³r_wr™e
;

635 
guid_t
 
	mš¡ªû_uuid
;

638 
©omic64_t
 
	mu£r_wa
;

639 
©omic64_t
 
	mgc_wa
;

640 
©omic64_t
 
	m·d_wa
;

643 
u64
 
	mu£r_r¡_wa
;

644 
u64
 
	mgc_r¡_wa
;

645 
u64
 
	m·d_r¡_wa
;

648 
©omic64_t
 *
	m·d_di¡
;

649 
u64
 
	mÄ_æush_r¡
;

650 
©omic64_t
 
	mÄ_æush
;

652 #ifdeà
CONFIG_NVM_PBLK_DEBUG


654 
©omic_lÚg_t
 
	mšæight_wr™es
;

655 
©omic_lÚg_t
 
	m·dded_wr™es
;

656 
©omic_lÚg_t
 
	m·dded_wb
;

657 
©omic_lÚg_t
 
	m»q_wr™es
;

658 
©omic_lÚg_t
 
	msub_wr™es
;

659 
©omic_lÚg_t
 
	msync_wr™es
;

660 
©omic_lÚg_t
 
	mšæight_»ads
;

661 
©omic_lÚg_t
 
	mÿche_»ads
;

662 
©omic_lÚg_t
 
	msync_»ads
;

663 
©omic_lÚg_t
 
	m»cov_wr™es
;

664 
©omic_lÚg_t
 
	m»cov_gc_wr™es
;

665 
©omic_lÚg_t
 
	m»cov_gc_»ads
;

668 
¥šlock_t
 
	mlock
;

670 
©omic_lÚg_t
 
	m»ad_çžed
;

671 
©omic_lÚg_t
 
	m»ad_em±y
;

672 
©omic_lÚg_t
 
	m»ad_high_ecc
;

673 
©omic_lÚg_t
 
	m»ad_çžed_gc
;

674 
©omic_lÚg_t
 
	mwr™e_çžed
;

675 
©omic_lÚg_t
 
	m”a£_çžed
;

677 
©omic_t
 
	mšæight_io
;

679 
sk_¡ruù
 *
	mwr™”_ts
;

685 *
	mŒªs_m­
;

686 
¥šlock_t
 
	mŒªs_lock
;

688 
li¡_h—d
 
	mcom¶_li¡
;

690 
¥šlock_t
 
	m»subm™_lock
;

691 
li¡_h—d
 
	m»subm™_li¡
;

693 
mempoÞ_t
 
	m·ge_bio_poÞ
;

694 
mempoÞ_t
 
	mg’_ws_poÞ
;

695 
mempoÞ_t
 
	m»c_poÞ
;

696 
mempoÞ_t
 
	mr_rq_poÞ
;

697 
mempoÞ_t
 
	mw_rq_poÞ
;

698 
mempoÞ_t
 
	me_rq_poÞ
;

700 
wÜkqueue_¡ruù
 *
	mþo£_wq
;

701 
wÜkqueue_¡ruù
 *
	mbb_wq
;

702 
wÜkqueue_¡ruù
 *
	mr_’d_wq
;

704 
tim”_li¡
 
	mwtim”
;

706 
pblk_gc
 
	mgc
;

709 
	spblk_lše_ws
 {

710 
pblk
 *
	mpblk
;

711 
pblk_lše
 *
	mlše
;

712 *
	m´iv
;

713 
wÜk_¡ruù
 
	mws
;

716 
	#pblk_g_rq_size
 ((
nvm_rq
è+ (
pblk_g_ùx
))

	)

717 
	#pblk_w_rq_size
 ((
nvm_rq
è+ (
pblk_c_ùx
))

	)

719 
	#pblk_”r
(
pblk
, 
fmt
, ...) \

720 
	`´_”r
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_Çme
, ##
__VA_ARGS__
)

	)

721 
	#pblk_šfo
(
pblk
, 
fmt
, ...) \

722 
	`´_šfo
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_Çme
, ##
__VA_ARGS__
)

	)

723 
	#pblk_w¬n
(
pblk
, 
fmt
, ...) \

724 
	`´_w¬n
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_Çme
, ##
__VA_ARGS__
)

	)

725 
	#pblk_debug
(
pblk
, 
fmt
, ...) \

726 
	`´_debug
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_Çme
, ##
__VA_ARGS__
)

	)

731 
pblk_rb_š™
(
pblk_rb
 *
rb
, 
size
, 
th»shÞd
,

732 
£g_sz
);

733 
pblk_rb_may_wr™e_u£r
(
pblk_rb
 *
rb
, 
bio
 *bio,

734 
Ä_’Œ›s
, *
pos
);

735 
pblk_rb_may_wr™e_gc
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
,

736 *
pos
);

737 
pblk_rb_wr™e_’Œy_u£r
(
pblk_rb
 *
rb
, *
d©a
,

738 
pblk_w_ùx
 
w_ùx
, 
pos
);

739 
pblk_rb_wr™e_’Œy_gc
(
pblk_rb
 *
rb
, *
d©a
,

740 
pblk_w_ùx
 
w_ùx
, 
pblk_lše
 *
lše
,

741 
u64
 
·ddr
, 
pos
);

742 
pblk_w_ùx
 *
pblk_rb_w_ùx
(
pblk_rb
 *
rb
, 
pos
);

743 
pblk_rb_æush
(
pblk_rb
 *
rb
);

745 
pblk_rb_sync_l2p
(
pblk_rb
 *
rb
);

746 
pblk_rb_»ad_to_bio
(
pblk_rb
 *
rb
, 
nvm_rq
 *
rqd
,

747 
pos
, 
Ä_’Œ›s
,

748 
couÁ
);

749 
pblk_rb_cÝy_to_bio
(
pblk_rb
 *
rb
, 
bio
 *bio, 
£ùÜ_t
 
lba
,

750 
µa_addr
 
µa
);

751 
pblk_rb_»ad_comm™
(
pblk_rb
 *
rb
, 
’Œ›s
);

753 
pblk_rb_sync_š™
(
pblk_rb
 *
rb
, *
æags
);

754 
pblk_rb_sync_advªû
(
pblk_rb
 *
rb
, 
Ä_’Œ›s
);

755 
pblk_rb_±r_w¿p
(
pblk_rb
 *
rb
, 
p
,

756 
Ä_’Œ›s
);

757 
pblk_rb_sync_’d
(
pblk_rb
 *
rb
, *
æags
);

758 
pblk_rb_æush_pošt_couÁ
(
pblk_rb
 *
rb
);

760 
pblk_rb_»ad_couÁ
(
pblk_rb
 *
rb
);

761 
pblk_rb_sync_couÁ
(
pblk_rb
 *
rb
);

762 
pblk_rb_w¿p_pos
(
pblk_rb
 *
rb
, 
pos
);

764 
pblk_rb_‹¬_down_check
(
pblk_rb
 *
rb
);

765 
pblk_rb_pos_oob
(
pblk_rb
 *
rb
, 
u64
 
pos
);

766 
pblk_rb_ä“
(
pblk_rb
 *
rb
);

767 
ssize_t
 
pblk_rb_sysfs
(
pblk_rb
 *
rb
, *
buf
);

772 
nvm_rq
 *
pblk_®loc_rqd
(
pblk
 *pblk, 
ty³
);

773 
pblk_ä“_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
ty³
);

774 
pblk_®loc_rqd_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

775 
pblk_ä“_rqd_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

776 
pblk_£t_£c_³r_wr™e
(
pblk
 *pblk, 
£c_³r_wr™e
);

777 
pblk_£tup_w_»c_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

778 
pblk_c_ùx
 *
c_ùx
);

779 
pblk_disÿrd
(
pblk
 *pblk, 
bio
 *bio);

780 
nvm_chk_m‘a
 *
pblk_g‘_chunk_m‘a
(
pblk
 *pblk);

781 
nvm_chk_m‘a
 *
pblk_chunk_g‘_off
(
pblk
 *pblk,

782 
nvm_chk_m‘a
 *
Í
,

783 
µa_addr
 
µa
);

784 
pblk_log_wr™e_”r
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

785 
pblk_log_»ad_”r
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

786 
pblk_subm™_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

787 
pblk_subm™_io_sync
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

788 
pblk_subm™_io_sync_£m
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

789 
pblk_subm™_m‘a_io
(
pblk
 *pblk, 
pblk_lše
 *
m‘a_lše
);

790 
pblk_check_chunk_¡©e_upd©e
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

791 
bio
 *
pblk_bio_m­_addr
(
pblk
 *pblk, *
d©a
,

792 
Ä_£cs
, 
Ën
,

793 
®loc_ty³
, 
gå_t
 
gå_mask
);

794 
pblk_lše
 *
pblk_lše_g‘
(
pblk
 *pblk);

795 
pblk_lše
 *
pblk_lše_g‘_fœ¡_d©a
(
pblk
 *pblk);

796 
pblk_lše
 *
pblk_lše_»¶aû_d©a
(
pblk
 *pblk);

797 
pblk_µa_to_lše_put
(
pblk
 *pblk, 
µa_addr
 
µa
);

798 
pblk_rq_to_lše_put
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

799 
pblk_lše_»cov_®loc
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

800 
pblk_lše_»cov_þo£
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

801 
pblk_lše
 *
pblk_lše_g‘_d©a
(
pblk
 *pblk);

802 
pblk_lše
 *
pblk_lše_g‘_”a£
(
pblk
 *pblk);

803 
pblk_lše_”a£
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

804 
pblk_lše_is_fuÎ
(
pblk_lše
 *
lše
);

805 
pblk_lše_ä“
(
pblk_lše
 *
lše
);

806 
pblk_lše_þo£_m‘a
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

807 
pblk_lše_þo£
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

808 
pblk_lše_þo£_ws
(
wÜk_¡ruù
 *
wÜk
);

809 
pblk_p–še_¡Ý
(
pblk
 *pblk);

810 
__pblk_p–še_¡Ý
(
pblk
 *pblk);

811 
__pblk_p–še_æush
(
pblk
 *pblk);

812 
pblk_g’_run_ws
(
pblk
 *pblk, 
pblk_lše
 *
lše
, *
´iv
,

813 (*
wÜk
)(
wÜk_¡ruù
 *), 
gå_t
 
gå_mask
,

814 
wÜkqueue_¡ruù
 *
wq
);

815 
u64
 
	`pblk_lše_sm‘a_¡¬t
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

816 
	`pblk_lše_sm‘a_»ad
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

817 
	`pblk_lše_em‘a_»ad
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

818 *
em‘a_buf
);

819 
	`pblk_blk_”a£_async
(
pblk
 *pblk, 
µa_addr
 
”a£_µa
);

820 
	`pblk_lše_put
(
k»f
 *
»f
);

821 
	`pblk_lše_put_wq
(
k»f
 *
»f
);

822 
li¡_h—d
 *
	`pblk_lše_gc_li¡
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

823 
u64
 
	`pblk_lookup_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

824 
	`pblk_d—Îoc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
);

825 
u64
 
	`pblk_®loc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
);

826 
u64
 
	`__pblk_®loc_·ge
(
pblk
 *pblk, 
pblk_lše
 *
lše
, 
Ä_£cs
);

827 
	`pblk_ÿlc_£cs
(
pblk
 *pblk, 
£cs_avaž
,

828 
£cs_to_æush
, 
boÞ
 
sk_m‘a
);

829 
	`pblk_down_rq
(
pblk
 *pblk, 
µa_addr
 
µa
,

830 *
lun_b™m­
);

831 
	`pblk_down_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
);

832 
	`pblk_up_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
);

833 
	`pblk_up_rq
(
pblk
 *pblk, *
lun_b™m­
);

834 
	`pblk_bio_add_·ges
(
pblk
 *pblk, 
bio
 *bio, 
gå_t
 
æags
,

835 
Ä_·ges
);

836 
	`pblk_bio_ä“_·ges
(
pblk
 *pblk, 
bio
 *bio, 
off
,

837 
Ä_·ges
);

838 
	`pblk_m­_šv®id©e
(
pblk
 *pblk, 
µa_addr
 
µa
);

839 
	`__pblk_m­_šv®id©e
(
pblk
 *pblk, 
pblk_lše
 *
lše
,

840 
u64
 
·ddr
);

841 
	`pblk_upd©e_m­
(
pblk
 *pblk, 
£ùÜ_t
 
lba
, 
µa_addr
 
µa
);

842 
	`pblk_upd©e_m­_ÿche
(
pblk
 *pblk, 
£ùÜ_t
 
lba
,

843 
µa_addr
 
µa
);

844 
	`pblk_upd©e_m­_dev
(
pblk
 *pblk, 
£ùÜ_t
 
lba
,

845 
µa_addr
 
µa
, µa_add¸
’Œy_lše
);

846 
	`pblk_upd©e_m­_gc
(
pblk
 *pblk, 
£ùÜ_t
 
lba
, 
µa_addr
 
µa
,

847 
pblk_lše
 *
gc_lše
, 
u64
 
·ddr
);

848 
	`pblk_lookup_l2p_¿nd
(
pblk
 *pblk, 
µa_addr
 *
µas
,

849 
u64
 *
lba_li¡
, 
Ä_£cs
);

850 
	`pblk_lookup_l2p_£q
(
pblk
 *pblk, 
µa_addr
 *
µas
,

851 
£ùÜ_t
 
blba
, 
Ä_£cs
, 
boÞ
 *
äom_ÿche
);

852 *
	`pblk_g‘_m‘a_fÜ_wr™es
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

853 
	`pblk_g‘_·cked_m‘a
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

858 
	`pblk_wr™e_to_ÿche
(
pblk
 *pblk, 
bio
 *bio,

859 
æags
);

860 
	`pblk_wr™e_gc_to_ÿche
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
);

865 
	`pblk_m­_”a£_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

866 
£Áry
, *
lun_b™m­
,

867 
v®id_£cs
, 
µa_addr
 *
”a£_µa
);

868 
	`pblk_m­_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
£Áry
,

869 *
lun_b™m­
, 
v®id_£cs
,

870 
off
);

875 
	`pblk_wr™e_ts
(*
d©a
);

876 
	`pblk_wr™e_tim”_â
(
tim”_li¡
 *
t
);

877 
	`pblk_wr™e_should_kick
(
pblk
 *pblk);

878 
	`pblk_wr™e_kick
(
pblk
 *pblk);

883 
bio_£t
 
pblk_bio_£t
;

884 
	`pblk_subm™_»ad
(
pblk
 *pblk, 
bio
 *bio);

885 
	`pblk_subm™_»ad_gc
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
);

889 
pblk_lše
 *
	`pblk_»cov_l2p
(
pblk
 *pblk);

890 
	`pblk_»cov_·d
(
pblk
 *pblk);

891 
	`pblk_»cov_check_em‘a
(
pblk
 *pblk, 
lše_em‘a
 *
em‘a
);

896 
	#PBLK_GC_MAX_READERS
 8

	)

897 
	#PBLK_GC_RQ_QD
 128

	)

898 
	#PBLK_GC_L_QD
 4

	)

900 
	`pblk_gc_š™
(
pblk
 *pblk);

901 
	`pblk_gc_ex™
(
pblk
 *pblk, 
boÞ
 
g¿ûful
);

902 
	`pblk_gc_should_¡¬t
(
pblk
 *pblk);

903 
	`pblk_gc_should_¡Ý
(
pblk
 *pblk);

904 
	`pblk_gc_should_kick
(
pblk
 *pblk);

905 
	`pblk_gc_ä“_fuÎ_lšes
(
pblk
 *pblk);

906 
	`pblk_gc_sysfs_¡©e_show
(
pblk
 *pblk, *
gc_’abËd
,

907 *
gc_aùive
);

908 
	`pblk_gc_sysfs_fÜû
(
pblk
 *pblk, 
fÜû
);

909 
	`pblk_put_lše_back
(
pblk
 *pblk, 
pblk_lše
 *
lše
);

914 
	`pblk_¾_š™
(
pblk_¾
 *
¾
, 
budg‘
, 
th»shÞd
);

915 
	`pblk_¾_ä“
(
pblk_¾
 *
¾
);

916 
	`pblk_¾_upd©e_¿‹s
(
pblk_¾
 *
¾
);

917 
	`pblk_¾_high_thrs
(
pblk_¾
 *
¾
);

918 
	`pblk_¾_Ä_ä“_blks
(
pblk_¾
 *
¾
);

919 
	`pblk_¾_Ä_u£r_ä“_blks
(
pblk_¾
 *
¾
);

920 
	`pblk_¾_u£r_may_š£¹
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
);

921 
	`pblk_¾_š£¹ed
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
);

922 
	`pblk_¾_u£r_š
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
);

923 
	`pblk_¾_gc_may_š£¹
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
);

924 
	`pblk_¾_gc_š
(
pblk_¾
 *
¾
, 
Ä_’Œ›s
);

925 
	`pblk_¾_out
(
pblk_¾
 *
¾
, 
Ä_u£r
, 
Ä_gc
);

926 
	`pblk_¾_max_io
(
pblk_¾
 *
¾
);

927 
	`pblk_¾_ä“_lšes_šc
(
pblk_¾
 *
¾
, 
pblk_lše
 *
lše
);

928 
	`pblk_¾_ä“_lšes_dec
(
pblk_¾
 *
¾
, 
pblk_lše
 *
lše
,

929 
boÞ
 
u£d
);

930 
	`pblk_¾_is_lim™
(
pblk_¾
 *
¾
);

932 
	`pblk_¾_w”r_lše_š
(
pblk_¾
 *
¾
);

933 
	`pblk_¾_w”r_lše_out
(
pblk_¾
 *
¾
);

938 
	`pblk_sysfs_š™
(
g’disk
 *
tdisk
);

939 
	`pblk_sysfs_ex™
(
g’disk
 *
tdisk
);

941 
šlše
 *
	$pblk_m®loc
(
size_t
 
size
, 
ty³
, 
gå_t
 
æags
)

943 ià(
ty³
 =ð
PBLK_KMALLOC_META
)

944  
	`km®loc
(
size
, 
æags
);

945  
	`vm®loc
(
size
);

946 
	}
}

948 
šlše
 
	$pblk_mä“
(*
±r
, 
ty³
)

950 ià(
ty³
 =ð
PBLK_KMALLOC_META
)

951 
	`kä“
(
±r
);

953 
	`vä“
(
±r
);

954 
	}
}

956 
šlše
 
nvm_rq
 *
	$nvm_rq_äom_c_ùx
(*
c_ùx
)

958  
c_ùx
 - (
nvm_rq
);

959 
	}
}

961 
šlše
 *
	$em‘a_to_bb
(
lše_em‘a
 *
em‘a
)

963  
em‘a
->
bb_b™m­
;

964 
	}
}

966 
šlše
 *
	$em‘a_to_wa
(
pblk_lše_m‘a
 *
lm
,

967 
lše_em‘a
 *
em‘a
)

969  
em‘a
->
bb_b™m­
 + 
lm
->
blk_b™m­_Ën
;

970 
	}
}

972 
šlše
 *
	$em‘a_to_lbas
(
pblk
 *pblk, 
lše_em‘a
 *
em‘a
)

974  ((*)
em‘a
 + 
pblk
->
lm
.
em‘a_Ën
[1]);

975 
	}
}

977 
šlše
 *
	$em‘a_to_vsc
(
pblk
 *pblk, 
lše_em‘a
 *
em‘a
)

979  (
	`em‘a_to_lbas
(
pblk
, 
em‘a
è+…blk->
lm
.
em‘a_Ën
[2]);

980 
	}
}

982 
šlše
 
	$pblk_lše_vsc
(
pblk_lše
 *
lše
)

984  
	`Ë32_to_ýu
(*
lše
->
vsc
);

985 
	}
}

987 
šlše
 
	$pblk_µa_to_lše_id
(
µa_addr
 
p
)

989  
p
.
a
.
blk
;

990 
	}
}

992 
šlše
 
pblk_lše
 *
	$pblk_µa_to_lše
(
pblk
 *pblk,

993 
µa_addr
 
p
)

995  &
pblk
->
lšes
[
	`pblk_µa_to_lše_id
(
p
)];

996 
	}
}

998 
šlše
 
	$pblk_µa_to_pos
(
nvm_geo
 *
geo
, 
µa_addr
 
p
)

1000  
p
.
a
.
lun
 * 
geo
->
num_ch
 +….a.
ch
;

1001 
	}
}

1003 
šlše
 
µa_addr
 
	$addr_to_g’_µa
(
pblk
 *pblk, 
u64
 
·ddr
,

1004 
u64
 
lše_id
)

1006 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1007 
nvm_geo
 *
geo
 = &
dev
->geo;

1008 
µa_addr
 
µa
;

1010 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
) {

1011 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

1013 
µa
.ppa = 0;

1014 
µa
.
g
.
blk
 = 
lše_id
;

1015 
µa
.
g
.
pg
 = (
·ddr
 & 
µaf
->
pg_mask
è>>…·f->
pg_off£t
;

1016 
µa
.
g
.
lun
 = (
·ddr
 & 
µaf
->
lun_mask
è>>…·f->
lun_off£t
;

1017 
µa
.
g
.
ch
 = (
·ddr
 & 
µaf
->
ch_mask
è>>…·f->
ch_off£t
;

1018 
µa
.
g
.
¶
 = (
·ddr
 & 
µaf
->
¶n_mask
è>>…·f->
¶n_off£t
;

1019 
µa
.
g
.
£c
 = (
·ddr
 & 
µaf
->
£c_mask
è>>…·f->
£c_off£t
;

1021 
pblk_addrf
 *
uaddrf
 = &
pblk
->uaddrf;

1022 
£cs
, 
chÆs
, 
luns
;

1024 
µa
.ppa = 0;

1026 
µa
.
m
.
chk
 = 
lše_id
;

1028 
·ddr
 = 
	`div_u64_»m
Õaddr, 
uaddrf
->
£c_¡re
, &
£cs
);

1029 
µa
.
m
.
£c
 = 
£cs
;

1031 
·ddr
 = 
	`div_u64_»m
Õaddr, 
uaddrf
->
ch_¡re
, &
chÆs
);

1032 
µa
.
m
.
g½
 = 
chÆs
;

1034 
·ddr
 = 
	`div_u64_»m
Õaddr, 
uaddrf
->
lun_¡re
, &
luns
);

1035 
µa
.
m
.
pu
 = 
luns
;

1037 
µa
.
m
.
£c
 +ð
uaddrf
->
£c_¡re
 * 
·ddr
;

1040  
µa
;

1041 
	}
}

1043 
šlše
 
nvm_chk_m‘a
 *
	$pblk_dev_µa_to_chunk
(
pblk
 *pblk,

1044 
µa_addr
 
p
)

1046 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1047 
nvm_geo
 *
geo
 = &
dev
->geo;

1048 
pblk_lše
 *
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
p
);

1049 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
p
);

1051  &
lše
->
chks
[
pos
];

1052 
	}
}

1054 
šlše
 
u64
 
	$pblk_dev_µa_to_chunk_addr
(
pblk
 *pblk,

1055 
µa_addr
 
p
)

1057 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1059  
	`dev_to_chunk_addr
(
dev
->
·»Á
, &
pblk
->
addrf
, 
p
);

1060 
	}
}

1062 
šlše
 
u64
 
	$pblk_dev_µa_to_lše_addr
(
pblk
 *pblk,

1063 
µa_addr
 
p
)

1065 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1066 
nvm_geo
 *
geo
 = &
dev
->geo;

1067 
u64
 
·ddr
;

1069 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
) {

1070 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

1072 
·ddr
 = (
u64
)
p
.
g
.
ch
 << 
µaf
->
ch_off£t
;

1073 
·ddr
 |ð(
u64
)
p
.
g
.
lun
 << 
µaf
->
lun_off£t
;

1074 
·ddr
 |ð(
u64
)
p
.
g
.
pg
 << 
µaf
->
pg_off£t
;

1075 
·ddr
 |ð(
u64
)
p
.
g
.
¶
 << 
µaf
->
¶n_off£t
;

1076 
·ddr
 |ð(
u64
)
p
.
g
.
£c
 << 
µaf
->
£c_off£t
;

1078 
pblk_addrf
 *
uaddrf
 = &
pblk
->uaddrf;

1079 
u64
 
£cs
 = 
p
.
m
.
£c
;

1080 
£c_¡re
;

1082 
·ddr
 = (
u64
)
p
.
m
.
g½
 * 
uaddrf
->
£c_¡re
;

1083 
·ddr
 +ð(
u64
)
p
.
m
.
pu
 * 
uaddrf
->
£c_lun_¡re
;

1085 
£cs
 = 
	`div_u64_»m
(£cs, 
uaddrf
->
£c_¡re
, &sec_stripe);

1086 
·ddr
 +ð
£cs
 * 
uaddrf
->
£c_ws_¡re
;

1087 
·ddr
 +ð
£c_¡re
;

1090  
·ddr
;

1091 
	}
}

1093 
šlše
 
µa_addr
 
	$pblk_µa32_to_µa64
(
pblk
 *pblk, 
u32
 
µa32
)

1095 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1097  
	`nvm_µa32_to_µa64
(
dev
->
·»Á
, &
pblk
->
addrf
, 
µa32
);

1098 
	}
}

1100 
šlše
 
u32
 
	$pblk_µa64_to_µa32
(
pblk
 *pblk, 
µa_addr
 
µa64
)

1102 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1104  
	`nvm_µa64_to_µa32
(
dev
->
·»Á
, &
pblk
->
addrf
, 
µa64
);

1105 
	}
}

1107 
šlše
 
µa_addr
 
	$pblk_Œªs_m­_g‘
(
pblk
 *pblk,

1108 
£ùÜ_t
 
lba
)

1110 
µa_addr
 
µa
;

1112 ià(
pblk
->
addrf_Ën
 < 32) {

1113 
u32
 *
m­
 = (u32 *)
pblk
->
Œªs_m­
;

1115 
µa
 = 
	`pblk_µa32_to_µa64
(
pblk
, 
m­
[
lba
]);

1117 
µa_addr
 *
m­
 = (µa_add¸*)
pblk
->
Œªs_m­
;

1119 
µa
 = 
m­
[
lba
];

1122  
µa
;

1123 
	}
}

1125 
šlše
 
	$pblk_Œªs_m­_£t
(
pblk
 *pblk, 
£ùÜ_t
 
lba
,

1126 
µa_addr
 
µa
)

1128 ià(
pblk
->
addrf_Ën
 < 32) {

1129 
u32
 *
m­
 = (u32 *)
pblk
->
Œªs_m­
;

1131 
m­
[
lba
] = 
	`pblk_µa64_to_µa32
(
pblk
, 
µa
);

1133 
u64
 *
m­
 = (u64 *)
pblk
->
Œªs_m­
;

1135 
m­
[
lba
] = 
µa
.ppa;

1137 
	}
}

1139 
šlše
 
	$pblk_µa_em±y
(
µa_addr
…pa_addr)

1141  (
µa_addr
.
µa
 =ð
ADDR_EMPTY
);

1142 
	}
}

1144 
šlše
 
	$pblk_µa_£t_em±y
(
µa_addr
 *ppa_addr)

1146 
µa_addr
->
µa
 = 
ADDR_EMPTY
;

1147 
	}
}

1149 
šlše
 
boÞ
 
	$pblk_µa_comp
(
µa_addr
 
Í·
, µa_add¸
½·
)

1151  (
Í·
.
µa
 =ð
½·
.ppa);

1152 
	}
}

1154 
šlše
 
	$pblk_addr_š_ÿche
(
µa_addr
 
µa
)

1156  (
µa
.µ¨!ð
ADDR_EMPTY
 &&…·.
c
.
is_ÿched
);

1157 
	}
}

1159 
šlše
 
	$pblk_addr_to_ÿch–še
(
µa_addr
 
µa
)

1161  
µa
.
c
.
lše
;

1162 
	}
}

1164 
šlše
 
µa_addr
 
	$pblk_ÿch–še_to_addr
(
addr
)

1166 
µa_addr
 
p
;

1168 
p
.
c
.
lše
 = 
addr
;

1169 
p
.
c
.
is_ÿched
 = 1;

1171  
p
;

1172 
	}
}

1174 
šlše
 
u32
 
	$pblk_ÿlc_m‘a_h—d”_üc
(
pblk
 *pblk,

1175 
lše_h—d”
 *
h—d”
)

1177 
u32
 
üc
 = ~(u32)0;

1179 
üc
 = 
	`üc32_Ë
(üc, (*)
h—d”
 + (crc),

1180 (
lše_h—d”
è- (
üc
));

1182  
üc
;

1183 
	}
}

1185 
šlše
 
u32
 
	$pblk_ÿlc_sm‘a_üc
(
pblk
 *pblk,

1186 
lše_sm‘a
 *
sm‘a
)

1188 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1189 
u32
 
üc
 = ~(u32)0;

1191 
üc
 = 
	`üc32_Ë
(üc, (*)
sm‘a
 +

1192 (
lše_h—d”
è+ (
üc
),

1193 
lm
->
sm‘a_Ën
 -

1194 (
lše_h—d”
è- (
üc
));

1196  
üc
;

1197 
	}
}

1199 
šlše
 
u32
 
	$pblk_ÿlc_em‘a_üc
(
pblk
 *pblk,

1200 
lše_em‘a
 *
em‘a
)

1202 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1203 
u32
 
üc
 = ~(u32)0;

1205 
üc
 = 
	`üc32_Ë
(üc, (*)
em‘a
 +

1206 (
lše_h—d”
è+ (
üc
),

1207 
lm
->
em‘a_Ën
[0] -

1208 (
lše_h—d”
è- (
üc
));

1210  
üc
;

1211 
	}
}

1213 
šlše
 
	$pblk_io_®igÃd
(
pblk
 *pblk, 
Ä_£cs
)

1215  !(
Ä_£cs
 % 
pblk
->
mš_wr™e_pgs
);

1216 
	}
}

1218 #ifdeà
CONFIG_NVM_PBLK_DEBUG


1219 
šlše
 
	$´št_µa
(
pblk
 *pblk, 
µa_addr
 *
p
,

1220 *
msg
, 
”rÜ
)

1222 
nvm_geo
 *
geo
 = &
pblk
->
dev
->geo;

1224 ià(
p
->
c
.
is_ÿched
) {

1225 
	`pblk_”r
(
pblk
, "ppa: (%s: %x) cache†ine: %llu\n",

1226 
msg
, 
”rÜ
, (
u64
)
p
->
c
.
lše
);

1227 } ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
) {

1228 
	`pblk_”r
(
pblk
, "ppa: (%s: %x):ch:%d,lun:%d,blk:%d,pg:%d,pl:%d,sec:%d\n",

1229 
msg
, 
”rÜ
,

1230 
p
->
g
.
ch
,…->g.
lun
,…->g.
blk
,

1231 
p
->
g
.
pg
,…->g.
¶
,…->g.
£c
);

1233 
	`pblk_”r
(
pblk
, "ppa: (%s: %x):ch:%d,lun:%d,chk:%d,sec:%d\n",

1234 
msg
, 
”rÜ
,

1235 
p
->
m
.
g½
,…->m.
pu
,…->m.
chk
,…->m.
£c
);

1237 
	}
}

1239 
šlše
 
	$pblk_´št_çžed_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

1240 
”rÜ
)

1242 
b™
 = -1;

1244 ià(
rqd
->
Ä_µas
 == 1) {

1245 
	`´št_µa
(
pblk
, &
rqd
->
µa_addr
, "rqd", 
”rÜ
);

1249 (
b™
 = 
	`fšd_Ãxt_b™
((*)&
rqd
->
µa_¡©us
,„qd->
Ä_µas
,

1250 
b™
 + 1)è< 
rqd
->
Ä_µas
) {

1251 
	`´št_µa
(
pblk
, &
rqd
->
µa_li¡
[
b™
], "rqd", 
”rÜ
);

1254 
	`pblk_”r
(
pblk
, "”rÜ:%d,…·_¡©us:%Îx\n", 
”rÜ
, 
rqd
->
µa_¡©us
);

1255 
	}
}

1257 
šlše
 
	$pblk_bound¬y_µa_checks
(
nvm_tgt_dev
 *
tgt_dev
,

1258 
µa_addr
 *
µas
, 
Ä_µas
)

1260 
nvm_geo
 *
geo
 = &
tgt_dev
->geo;

1261 
µa_addr
 *
µa
;

1262 
i
;

1264 
i
 = 0; i < 
Ä_µas
; i++) {

1265 
µa
 = &
µas
[
i
];

1267 ià(
geo
->
v”siÚ
 =ð
NVM_OCSSD_SPEC_12
) {

1268 ià(!
µa
->
c
.
is_ÿched
 &&

1269 
µa
->
g
.
ch
 < 
geo
->
num_ch
 &&

1270 
µa
->
g
.
lun
 < 
geo
->
num_lun
 &&

1271 
µa
->
g
.
¶
 < 
geo
->
num_¶n
 &&

1272 
µa
->
g
.
blk
 < 
geo
->
num_chk
 &&

1273 
µa
->
g
.
pg
 < 
geo
->
num_pg
 &&

1274 
µa
->
g
.
£c
 < 
geo
->
ws_mš
)

1277 ià(!
µa
->
c
.
is_ÿched
 &&

1278 
µa
->
m
.
g½
 < 
geo
->
num_ch
 &&

1279 
µa
->
m
.
pu
 < 
geo
->
num_lun
 &&

1280 
µa
->
m
.
chk
 < 
geo
->
num_chk
 &&

1281 
µa
->
m
.
£c
 < 
geo
->
þba
)

1285 
	`´št_µa
(
tgt_dev
->
q
->
queued©a
, 
µa
, "bound¬y", 
i
);

1290 
	}
}

1292 
šlše
 
	$pblk_check_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

1294 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1295 
µa_addr
 *
µa_li¡
 = 
	`nvm_rq_to_µa_li¡
(
rqd
);

1297 ià(
	`pblk_bound¬y_µa_checks
(
dev
, 
µa_li¡
, 
rqd
->
Ä_µas
)) {

1298 
	`WARN_ON
(1);

1299  -
EINVAL
;

1302 ià(
rqd
->
Ýcode
 =ð
NVM_OP_PWRITE
) {

1303 
pblk_lše
 *
lše
;

1304 
i
;

1306 
i
 = 0; i < 
rqd
->
Ä_µas
; i++) {

1307 
lše
 = 
	`pblk_µa_to_lše
(
pblk
, 
µa_li¡
[
i
]);

1309 
	`¥š_lock
(&
lše
->
lock
);

1310 ià(
lše
->
¡©e
 !ð
PBLK_LINESTATE_OPEN
) {

1311 
	`pblk_”r
(
pblk
, "bad…pa:†ine:%d,state:%d\n",

1312 
lše
->
id
,†še->
¡©e
);

1313 
	`WARN_ON
(1);

1314 
	`¥š_uÆock
(&
lše
->
lock
);

1315  -
EINVAL
;

1317 
	`¥š_uÆock
(&
lše
->
lock
);

1322 
	}
}

1325 
šlše
 
	$pblk_bound¬y_·ddr_checks
(
pblk
 *pblk, 
u64
 
·ddr
)

1327 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1329 ià(
·ddr
 > 
lm
->
£c_³r_lše
)

1333 
	}
}

1335 
šlše
 
	$pblk_g‘_bi_idx
(
bio
 *bio)

1337  
bio
->
bi_™”
.
bi_idx
;

1338 
	}
}

1340 
šlše
 
£ùÜ_t
 
	$pblk_g‘_lba
(
bio
 *bio)

1342  
bio
->
bi_™”
.
bi_£ùÜ
 / 
NR_PHY_IN_LOG
;

1343 
	}
}

1345 
šlše
 
	$pblk_g‘_£cs
(
bio
 *bio)

1347  
bio
->
bi_™”
.
bi_size
 / 
PBLK_EXPOSED_PAGE_SIZE
;

1348 
	}
}

1350 
šlše
 *
	$pblk_disk_Çme
(
pblk
 *pblk)

1352 
g’disk
 *
disk
 = 
pblk
->disk;

1354  
disk
->
disk_Çme
;

1355 
	}
}

1357 
šlše
 
	$pblk_g‘_mš_chks
(
pblk
 *pblk)

1359 
pblk_lše_m‘a
 *
lm
 = &
pblk
->lm;

1364  
	`DIV_ROUND_UP
(100, 
pblk
->
Ý
è* 
lm
->
blk_³r_lše
;

1365 
	}
}

1367 
šlše
 
pblk_£c_m‘a
 *
	$pblk_g‘_m‘a
(
pblk
 *pblk,

1368 *
m‘a
, 
šdex
)

1370  
m‘a
 +

1371 
	`max_t
(, (
pblk_£c_m‘a
), 
pblk
->
oob_m‘a_size
)

1372 * 
šdex
;

1373 
	}
}

1375 
šlše
 
	$pblk_dma_m‘a_size
(
pblk
 *pblk)

1377  
	`max_t
(, (
pblk_£c_m‘a
), 
pblk
->
oob_m‘a_size
)

1378 * 
NVM_MAX_VLBA
;

1379 
	}
}

1381 
šlše
 
	$pblk_is_oob_m‘a_suµÜ‹d
(
pblk
 *pblk)

1383  
pblk
->
oob_m‘a_size
 >ð(
pblk_£c_m‘a
);

1384 
	}
}

	@/usr/include/linux/lightnvm.h

20 #iâdeà
_LINUX_LIGHTNVM_H


21 
	#_LINUX_LIGHTNVM_H


	)

23 
	~<¡dio.h
>

24 
	~<sys/ioùl.h
>

25 
	#DISK_NAME_LEN
 32

	)

27 
	~<lšux/ty³s.h
>

28 
	~<lšux/ioùl.h
>

30 
	#NVM_TTYPE_NAME_MAX
 48

	)

31 
	#NVM_TTYPE_MAX
 63

	)

32 
	#NVM_MMTYPE_LEN
 8

	)

34 
	#NVM_CTRL_FILE
 "/dev/lighŠvm/cÚŒÞ"

	)

36 
	snvm_ioùl_šfo_tgt
 {

37 
__u32
 
	mv”siÚ
[3];

38 
__u32
 
	m»£rved
;

39 
	mtgŠame
[
NVM_TTYPE_NAME_MAX
];

42 
	snvm_ioùl_šfo
 {

43 
__u32
 
	mv”siÚ
[3];

44 
__u16
 
	mtgtsize
;

45 
__u16
 
	m»£rved16
;

46 
__u32
 
	m»£rved
[12];

47 
nvm_ioùl_šfo_tgt
 
	mtgts
[
NVM_TTYPE_MAX
];

51 
	mNVM_DEVICE_ACTIVE
 = 1 << 0,

54 
	snvm_ioùl_deviû_šfo
 {

55 
	mdevÇme
[
DISK_NAME_LEN
];

56 
	mbmÇme
[
NVM_TTYPE_NAME_MAX
];

57 
__u32
 
	mbmv”siÚ
[3];

58 
__u32
 
	mæags
;

59 
__u32
 
	m»£rved
[8];

62 
	snvm_ioùl_g‘_deviûs
 {

63 
__u32
 
	mÄ_deviûs
;

64 
__u32
 
	m»£rved
[31];

65 
nvm_ioùl_deviû_šfo
 
	mšfo
[31];

68 
	snvm_ioùl_ü—‹_sim¶e
 {

69 
__u32
 
	mlun_begš
;

70 
__u32
 
	mlun_’d
;

73 
	snvm_ioùl_ü—‹_ex‹nded
 {

74 
__u16
 
	mlun_begš
;

75 
__u16
 
	mlun_’d
;

76 
__u16
 
	mÝ
;

77 
__u16
 
	mrsv
;

81 
	mNVM_CONFIG_TYPE_SIMPLE
 = 0,

82 
	mNVM_CONFIG_TYPE_EXTENDED
 = 1,

85 
	snvm_ioùl_ü—‹_cÚf
 {

86 
__u32
 
	mty³
;

88 
nvm_ioùl_ü—‹_sim¶e
 
	ms
;

89 
nvm_ioùl_ü—‹_ex‹nded
 
	me
;

94 
	mNVM_TARGET_FACTORY
 = 1 << 0,

97 
	snvm_ioùl_ü—‹
 {

98 
	mdev
[
DISK_NAME_LEN
];

99 
	mtg‰y³
[
NVM_TTYPE_NAME_MAX
];

100 
	mtgŠame
[
DISK_NAME_LEN
];

102 
__u32
 
	mæags
;

104 
nvm_ioùl_ü—‹_cÚf
 
	mcÚf
;

107 
	snvm_ioùl_»move
 {

108 
	mtgŠame
[
DISK_NAME_LEN
];

110 
__u32
 
	mæags
;

113 
	snvm_ioùl_dev_š™
 {

114 
	mdev
[
DISK_NAME_LEN
];

115 
	mmmty³
[
NVM_MMTYPE_LEN
];

117 
__u32
 
	mæags
;

121 
	mNVM_FACTORY_ERASE_ONLY_USER
 = 1 << 0,

123 
	mNVM_FACTORY_RESET_HOST_BLKS
 = 1 << 1,

124 
	mNVM_FACTORY_RESET_GRWN_BBLKS
 = 1 << 2,

125 
	mNVM_FACTORY_NR_BITS
 = 1 << 3,

128 
	snvm_ioùl_dev_çùÜy
 {

129 
	mdev
[
DISK_NAME_LEN
];

131 
__u32
 
	mæags
;

134 
	snvm_u£r_vio
 {

135 
__u8
 
	mÝcode
;

136 
__u8
 
	mæags
;

137 
__u16
 
	mcÚŒÞ
;

138 
__u16
 
	mÅ·s
;

139 
__u16
 
	mrsvd
;

140 
__u64
 
	mm‘ad©a
;

141 
__u64
 
	maddr
;

142 
__u64
 
	mµa_li¡
;

143 
__u32
 
	mm‘ad©a_Ën
;

144 
__u32
 
	md©a_Ën
;

145 
__u64
 
	m¡©us
;

146 
__u32
 
	m»suÉ
;

147 
__u32
 
	mrsvd3
[3];

150 
	snvm_·s¡hru_vio
 {

151 
__u8
 
	mÝcode
;

152 
__u8
 
	mæags
;

153 
__u8
 
	mrsvd
[2];

154 
__u32
 
	mnsid
;

155 
__u32
 
	mcdw2
;

156 
__u32
 
	mcdw3
;

157 
__u64
 
	mm‘ad©a
;

158 
__u64
 
	maddr
;

159 
__u32
 
	mm‘ad©a_Ën
;

160 
__u32
 
	md©a_Ën
;

161 
__u64
 
	mµa_li¡
;

162 
__u16
 
	mÅ·s
;

163 
__u16
 
	mcÚŒÞ
;

164 
__u32
 
	mcdw13
;

165 
__u32
 
	mcdw14
;

166 
__u32
 
	mcdw15
;

167 
__u64
 
	m¡©us
;

168 
__u32
 
	m»suÉ
;

169 
__u32
 
	mtimeout_ms
;

175 
	mNVM_INFO_CMD
 = 0x20,

176 
	mNVM_GET_DEVICES_CMD
,

179 
	mNVM_DEV_CREATE_CMD
,

180 
	mNVM_DEV_REMOVE_CMD
,

183 
	mNVM_DEV_INIT_CMD
,

186 
	mNVM_DEV_FACTORY_CMD
,

189 
	mNVM_DEV_VIO_ADMIN_CMD
 = 0x41,

190 
	mNVM_DEV_VIO_CMD
 = 0x42,

191 
	mNVM_DEV_VIO_USER_CMD
 = 0x43,

194 
	#NVM_IOCTL
 'L'

	)

196 
	#NVM_INFO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_INFO_CMD
, \

197 
nvm_ioùl_šfo
)

	)

198 
	#NVM_GET_DEVICES
 
	`_IOR
(
NVM_IOCTL
, 
NVM_GET_DEVICES_CMD
, \

199 
nvm_ioùl_g‘_deviûs
)

	)

200 
	#NVM_DEV_CREATE
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_CREATE_CMD
, \

201 
nvm_ioùl_ü—‹
)

	)

202 
	#NVM_DEV_REMOVE
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_REMOVE_CMD
, \

203 
nvm_ioùl_»move
)

	)

204 
	#NVM_DEV_INIT
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_INIT_CMD
, \

205 
nvm_ioùl_dev_š™
)

	)

206 
	#NVM_DEV_FACTORY
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_FACTORY_CMD
, \

207 
nvm_ioùl_dev_çùÜy
)

	)

209 
	#NVME_NVM_IOCTL_IO_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_USER_CMD
, \

210 
nvm_·s¡hru_vio
)

	)

211 
	#NVME_NVM_IOCTL_ADMIN_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_ADMIN_CMD
,\

212 
nvm_·s¡hru_vio
)

	)

213 
	#NVME_NVM_IOCTL_SUBMIT_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_CMD
,\

214 
nvm_u£r_vio
)

	)

216 
	#NVM_VERSION_MAJOR
 1

	)

217 
	#NVM_VERSION_MINOR
 0

	)

218 
	#NVM_VERSION_PATCHLEVEL
 0

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/sem.h

2 #iâdeà
_LINUX_SEM_H


3 
	#_LINUX_SEM_H


	)

5 
	~<lšux/c.h
>

8 
	#SEM_UNDO
 0x1000

	)

11 
	#GETPID
 11

	)

12 
	#GETVAL
 12

	)

13 
	#GETALL
 13

	)

14 
	#GETNCNT
 14

	)

15 
	#GETZCNT
 15

	)

16 
	#SETVAL
 16

	)

17 
	#SETALL
 17

	)

20 
	#SEM_STAT
 18

	)

21 
	#SEM_INFO
 19

	)

22 
	#SEM_STAT_ANY
 20

	)

25 
	s£mid_ds
 {

26 
c_³rm
 
	m£m_³rm
;

27 
__k”Ãl_time_t
 
	m£m_Ùime
;

28 
__k”Ãl_time_t
 
	m£m_ùime
;

29 
£m
 *
	m£m_ba£
;

30 
£m_queue
 *
	m£m_³ndšg
;

31 
£m_queue
 **
	m£m_³ndšg_Ï¡
;

32 
£m_undo
 *
	mundo
;

33 
	m£m_n£ms
;

37 
	~<asm/£mbuf.h
>

40 
	s£mbuf
 {

41 
	m£m_num
;

42 
	m£m_Ý
;

43 
	m£m_æg
;

47 
	u£mun
 {

48 
	mv®
;

49 
£mid_ds
 *
	mbuf
;

50 *
	m¬¿y
;

51 
£mšfo
 *
	m__buf
;

52 *
	m__·d
;

55 
	s£mšfo
 {

56 
	m£mm­
;

57 
	m£mmni
;

58 
	m£mmns
;

59 
	m£mmnu
;

60 
	m£mm¦
;

61 
	m£mÝm
;

62 
	m£mume
;

63 
	m£musz
;

64 
	m£mvmx
;

65 
	m£m«m
;

80 
	#SEMMNI
 32000

	)

81 
	#SEMMSL
 32000

	)

82 
	#SEMMNS
 (
SEMMNI
*
SEMMSL
è

	)

83 
	#SEMOPM
 500

	)

84 
	#SEMVMX
 32767

	)

85 
	#SEMAEM
 
SEMVMX


	)

88 
	#SEMUME
 
SEMOPM


	)

89 
	#SEMMNU
 
SEMMNS


	)

90 
	#SEMMAP
 
SEMMNS


	)

91 
	#SEMUSZ
 20

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pÞl_t
;

	@/usr/include/linux/uuid.h

18 #iâdeà
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<lšux/ty³s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

35 
guid_t
 
	tuuid_Ë
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/ipc.h

2 #iâdeà
_LINUX_IPC_H


3 
	#_LINUX_IPC_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#IPC_PRIVATE
 ((
__k”Ãl_key_t
è0)

	)

10 
	sc_³rm


12 
__k”Ãl_key_t
 
	mkey
;

13 
__k”Ãl_uid_t
 
	muid
;

14 
__k”Ãl_gid_t
 
	mgid
;

15 
__k”Ãl_uid_t
 
	mcuid
;

16 
__k”Ãl_gid_t
 
	mcgid
;

17 
__k”Ãl_mode_t
 
	mmode
;

18 
	m£q
;

22 
	~<asm/cbuf.h
>

25 
	#IPC_CREAT
 00001000

	)

26 
	#IPC_EXCL
 00002000

	)

27 
	#IPC_NOWAIT
 00004000

	)

32 
	#IPC_DIPC
 00010000

	)

33 
	#IPC_OWN
 00020000

	)

39 
	#IPC_RMID
 0

	)

40 
	#IPC_SET
 1

	)

41 
	#IPC_STAT
 2

	)

42 
	#IPC_INFO
 3

	)

48 
	#IPC_OLD
 0

	)

50 
	#IPC_64
 0x0100

	)

58 
	sc_kludge
 {

59 
msgbuf
 *
	mmsgp
;

60 
	mmsgtyp
;

63 
	#SEMOP
 1

	)

64 
	#SEMGET
 2

	)

65 
	#SEMCTL
 3

	)

66 
	#SEMTIMEDOP
 4

	)

67 
	#MSGSND
 11

	)

68 
	#MSGRCV
 12

	)

69 
	#MSGGET
 13

	)

70 
	#MSGCTL
 14

	)

71 
	#SHMAT
 21

	)

72 
	#SHMDT
 22

	)

73 
	#SHMGET
 23

	)

74 
	#SHMCTL
 24

	)

77 
	#DIPC
 25

	)

79 
	#IPCCALL
(
v”siÚ
,
Ý
è((v”siÚ)<<16 | (Ý))

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


24 
	#_STDIO_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<b™s/libc-h—d”-¡¬t.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	#__Ãed___va_li¡


	)

36 
	~<¡d¬g.h
>

38 
	~<b™s/ty³s.h
>

39 
	~<b™s/ty³s/__åos_t.h
>

40 
	~<b™s/ty³s/__åos64_t.h
>

41 
	~<b™s/ty³s/__FILE.h
>

42 
	~<b™s/ty³s/FILE.h
>

43 
	~<b™s/ty³s/¡ruù_FILE.h
>

45 #ifdeà
__USE_GNU


46 
	~<b™s/ty³s/cook›_io_funùiÚs_t.h
>

49 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


50 #ifdeà
__GNUC__


51 #iâdeà
_VA_LIST_DEFINED


52 
__gnuc_va_li¡
 
	tva_li¡
;

53 
	#_VA_LIST_DEFINED


	)

56 
	~<¡d¬g.h
>

60 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


61 #iâdeà
__off_t_defšed


62 #iâdeà
__USE_FILE_OFFSET64


63 
__off_t
 
	toff_t
;

65 
__off64_t
 
	toff_t
;

67 
	#__off_t_defšed


	)

69 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


70 
__off64_t
 
	toff64_t
;

71 
	#__off64_t_defšed


	)

75 #ifdeà
__USE_XOPEN2K8


76 #iâdeà
__ssize_t_defšed


77 
__ssize_t
 
	tssize_t
;

78 
	#__ssize_t_defšed


	)

83 #iâdeà
__USE_FILE_OFFSET64


84 
__åos_t
 
	tåos_t
;

86 
__åos64_t
 
	tåos_t
;

88 #ifdeà
__USE_LARGEFILE64


89 
__åos64_t
 
	tåos64_t
;

93 
	#_IOFBF
 0

	)

94 
	#_IOLBF
 1

	)

95 
	#_IONBF
 2

	)

99 
	#BUFSIZ
 8192

	)

104 
	#EOF
 (-1)

	)

109 
	#SEEK_SET
 0

	)

110 
	#SEEK_CUR
 1

	)

111 
	#SEEK_END
 2

	)

112 #ifdeà
__USE_GNU


113 
	#SEEK_DATA
 3

	)

114 
	#SEEK_HOLE
 4

	)

118 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


120 
	#P_tmpdœ
 "/tmp"

	)

133 
	~<b™s/¡dio_lim.h
>

137 
FILE
 *
¡dš
;

138 
FILE
 *
¡dout
;

139 
FILE
 *
¡d”r
;

141 
	#¡dš
 
¡dš


	)

142 
	#¡dout
 
¡dout


	)

143 
	#¡d”r
 
¡d”r


	)

146 
	$»move
 (cÚ¡ *
__fž’ame
è
__THROW
;

148 
	$»Çme
 (cÚ¡ *
__Þd
, cÚ¡ *
__Ãw
è
__THROW
;

150 #ifdeà
__USE_ATFILE


152 
	$»Çm—t
 (
__Þdfd
, cÚ¡ *
__Þd
, 
__Ãwfd
,

153 cÚ¡ *
__Ãw
è
__THROW
;

156 #ifdeà
__USE_GNU


158 
	#RENAME_NOREPLACE
 (1 << 0)

	)

159 
	#RENAME_EXCHANGE
 (1 << 1)

	)

160 
	#RENAME_WHITEOUT
 (1 << 2)

	)

164 
	$»Çm—t2
 (
__Þdfd
, cÚ¡ *
__Þd
, 
__Ãwfd
,

165 cÚ¡ *
__Ãw
, 
__æags
è
__THROW
;

172 #iâdeà
__USE_FILE_OFFSET64


173 
FILE
 *
	$tmpfže
 (è
__wur
;

175 #ifdeà
__REDIRECT


176 
FILE
 *
	`__REDIRECT
 (
tmpfže
, (), 
tmpfže64
è
__wur
;

178 
	#tmpfže
 
tmpfže64


	)

182 #ifdeà
__USE_LARGEFILE64


183 
FILE
 *
	$tmpfže64
 (è
__wur
;

187 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

189 #ifdeà
__USE_MISC


192 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

196 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


204 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

205 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

213 
	`fþo£
 (
FILE
 *
__¡»am
);

218 
	`fæush
 (
FILE
 *
__¡»am
);

220 #ifdeà
__USE_MISC


227 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

230 #ifdeà
__USE_GNU


237 
	`fþo£®l
 ();

241 #iâdeà
__USE_FILE_OFFSET64


246 
FILE
 *
	$fÝ’
 (cÚ¡ *
__»¡riù
 
__fž’ame
,

247 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

252 
FILE
 *
	$äeÝ’
 (cÚ¡ *
__»¡riù
 
__fž’ame
,

253 cÚ¡ *
__»¡riù
 
__modes
,

254 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

256 #ifdeà
__REDIRECT


257 
FILE
 *
	`__REDIRECT
 (
fÝ’
, (cÚ¡ *
__»¡riù
 
__fž’ame
,

258 cÚ¡ *
__»¡riù
 
__modes
), 
fÝ’64
)

259 
__wur
;

260 
FILE
 *
	`__REDIRECT
 (
äeÝ’
, (cÚ¡ *
__»¡riù
 
__fž’ame
,

261 cÚ¡ *
__»¡riù
 
__modes
,

262 
FILE
 *
__»¡riù
 
__¡»am
), 
äeÝ’64
)

263 
__wur
;

265 
	#fÝ’
 
fÝ’64


	)

266 
	#äeÝ’
 
äeÝ’64


	)

269 #ifdeà
__USE_LARGEFILE64


270 
FILE
 *
	$fÝ’64
 (cÚ¡ *
__»¡riù
 
__fž’ame
,

271 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

272 
FILE
 *
	$äeÝ’64
 (cÚ¡ *
__»¡riù
 
__fž’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
,

274 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

277 #ifdef 
__USE_POSIX


279 
FILE
 *
	$fdÝ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

282 #ifdef 
__USE_GNU


285 
FILE
 *
	$fÝ’cook›
 (*
__»¡riù
 
__magic_cook›
,

286 cÚ¡ *
__»¡riù
 
__modes
,

287 
cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

290 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

292 
FILE
 *
	$fmemÝ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

293 
__THROW
 
__wur
;

298 
FILE
 *
	$Ý’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

304 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

308 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

309 
__modes
, 
size_t
 
__n
è
__THROW
;

311 #ifdef 
__USE_MISC


314 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

315 
size_t
 
__size
è
__THROW
;

318 
	$£Žšebuf
 (
FILE
 *
__¡»am
è
__THROW
;

326 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

327 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

332 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

334 
	$¥rštf
 (*
__»¡riù
 
__s
,

335 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

341 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

342 
__gnuc_va_li¡
 
__¬g
);

347 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
__gnuc_va_li¡
 
__¬g
);

349 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

350 
__gnuc_va_li¡
 
__¬g
è
__THROWNL
;

352 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


354 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

355 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

356 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

358 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

359 cÚ¡ *
__»¡riù
 
__fÜm©
, 
__gnuc_va_li¡
 
__¬g
)

360 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

363 #ià
	`__GLIBC_USE
 (
LIB_EXT2
)

366 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

367 
__gnuc_va_li¡
 
__¬g
)

368 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

369 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

370 cÚ¡ *
__»¡riù
 
__fmt
, ...)

371 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

372 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

373 cÚ¡ *
__»¡riù
 
__fmt
, ...)

374 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

377 #ifdeà
__USE_XOPEN2K8


379 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

380 
__gnuc_va_li¡
 
__¬g
)

381 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

382 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

383 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

391 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

392 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

397 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

399 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

400 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

405 #ià!
	`__GLIBC_USE
 (
DEPRECATED_SCANF
è&& !
defšed
 
__LDBL_COMPAT


406 #ifdeà
__REDIRECT


407 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

408 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

409 
__isoc99_fsÿnf
è
__wur
;

410 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

411 
__isoc99_sÿnf
è
__wur
;

412 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

413 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

414 
__isoc99_ssÿnf
);

416 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

417 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

418 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

419 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

420 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

421 
	#fsÿnf
 
__isoc99_fsÿnf


	)

422 
	#sÿnf
 
__isoc99_sÿnf


	)

423 
	#ssÿnf
 
__isoc99_ssÿnf


	)

427 #ifdef 
__USE_ISOC99


432 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

433 
__gnuc_va_li¡
 
__¬g
)

434 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

440 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
__gnuc_va_li¡
 
__¬g
)

441 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

444 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

445 cÚ¡ *
__»¡riù
 
__fÜm©
, 
__gnuc_va_li¡
 
__¬g
)

446 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

449 #ià!
	`__GLIBC_USE
 (
DEPRECATED_SCANF
)

450 #ià
defšed
 
__REDIRECT
 && !defšed 
__LDBL_COMPAT


451 
	`__REDIRECT
 (
vfsÿnf
,

452 (
FILE
 *
__»¡riù
 
__s
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, 
__gnuc_va_li¡
 
__¬g
),

454 
__isoc99_vfsÿnf
)

455 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

456 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

457 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

458 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

459 
	`__REDIRECT_NTH
 (
vssÿnf
,

460 (cÚ¡ *
__»¡riù
 
__s
,

461 cÚ¡ *
__»¡riù
 
__fÜm©
,

462 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

463 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

464 #–ià!
defšed
 
__REDIRECT


465 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

466 cÚ¡ *
__»¡riù
 
__fÜm©
,

467 
__gnuc_va_li¡
 
__¬g
è
__wur
;

468 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

469 
__gnuc_va_li¡
 
__¬g
è
__wur
;

470 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

471 cÚ¡ *
__»¡riù
 
__fÜm©
,

472 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

473 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

474 
	#vsÿnf
 
__isoc99_vsÿnf


	)

475 
	#vssÿnf
 
__isoc99_vssÿnf


	)

485 
	`fg‘c
 (
FILE
 *
__¡»am
);

486 
	`g‘c
 (
FILE
 *
__¡»am
);

492 
	`g‘ch¬
 ();

494 #ifdeà
__USE_POSIX199506


499 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

500 
	`g‘ch¬_uÆocked
 ();

503 #ifdeà
__USE_MISC


510 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

521 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

522 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

528 
	`putch¬
 (
__c
);

530 #ifdeà
__USE_MISC


537 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

540 #ifdeà
__USE_POSIX199506


545 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

546 
	`putch¬_uÆocked
 (
__c
);

550 #ià
defšed
 
__USE_MISC
 \

551 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

553 
	`g‘w
 (
FILE
 *
__¡»am
);

556 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

564 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

565 
__wur
;

567 #ià
	`__GLIBC_USE
 (
DEPRECATED_GETS
)

577 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

580 #ifdeà
__USE_GNU


587 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

588 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

592 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

603 
__ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

604 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

605 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

606 
__ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

607 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

608 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

616 
__ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

617 
size_t
 *
__»¡riù
 
__n
,

618 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

626 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

632 
	`puts
 (cÚ¡ *
__s
);

639 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

646 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

647 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

652 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

653 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

655 #ifdeà
__USE_GNU


662 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

663 
FILE
 *
__»¡riù
 
__¡»am
);

666 #ifdeà
__USE_MISC


673 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

674 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

675 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

676 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

684 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

689 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

694 
	`»wšd
 (
FILE
 *
__¡»am
);

701 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


702 #iâdeà
__USE_FILE_OFFSET64


707 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

712 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

714 #ifdeà
__REDIRECT


715 
	`__REDIRECT
 (
f£eko
,

716 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

717 
f£eko64
);

718 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

720 
	#f£eko
 
f£eko64


	)

721 
	#á–lo
 
á–lo64


	)

726 #iâdeà
__USE_FILE_OFFSET64


731 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

736 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

738 #ifdeà
__REDIRECT


739 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

740 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

741 
	`__REDIRECT
 (
f£os
,

742 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

744 
	#fg‘pos
 
fg‘pos64


	)

745 
	#f£os
 
f£os64


	)

749 #ifdeà
__USE_LARGEFILE64


750 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

751 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

752 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

753 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

757 
	$þ—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

759 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

761 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

763 #ifdeà
__USE_MISC


765 
	$þ—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

766 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

767 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

775 
	`³¼Ü
 (cÚ¡ *
__s
);

781 
	~<b™s/sys_”¾i¡.h
>

784 #ifdef 
__USE_POSIX


786 
	$fž’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

789 #ifdeà
__USE_MISC


791 
	$fž’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

795 #ifdeà
__USE_POSIX2


800 
FILE
 *
	$pÝ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

806 
	`pþo£
 (
FILE
 *
__¡»am
);

810 #ifdef 
__USE_POSIX


812 *
	$ù”mid
 (*
__s
è
__THROW
;

816 #ià(
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
è|| defšed 
__USE_GNU


818 *
	`cu£rid
 (*
__s
);

822 #ifdef 
__USE_GNU


823 
ob¡ack
;

826 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

827 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

828 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

829 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

830 cÚ¡ *
__»¡riù
 
__fÜm©
,

831 
__gnuc_va_li¡
 
__¬gs
)

832 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

836 #ifdeà
__USE_POSIX199506


840 
	$æockfže
 (
FILE
 *
__¡»am
è
__THROW
;

844 
	$árylockfže
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

847 
	$fuÆockfže
 (
FILE
 *
__¡»am
è
__THROW
;

850 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


853 
	~<b™s/g‘Ýt_posix.h
>

858 
	`__uæow
 (
FILE
 *);

859 
	`__ov”æow
 (
FILE
 *, );

863 #ifdeà
__USE_EXTERN_INLINES


864 
	~<b™s/¡dio.h
>

866 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


867 
	~<b™s/¡dio2.h
>

869 #ifdeà
__LDBL_COMPAT


870 
	~<b™s/¡dio-ldbl.h
>

873 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@
1
.
1
/usr/include
24
429
core.c
pblk-cache.c
pblk-core.c
pblk-gc.c
pblk-init.c
pblk-map.c
pblk-rb.c
pblk-read.c
pblk-recovery.c
pblk-rl.c
pblk-sysfs.c
pblk-trace.h
pblk-write.c
pblk.h
/usr/include/linux/lightnvm.h
/usr/include/linux/module.h
/usr/include/linux/sem.h
/usr/include/linux/types.h
/usr/include/linux/uuid.h
/usr/include/linux/ioctl.h
/usr/include/linux/ipc.h
/usr/include/linux/posix_types.h
/usr/include/stdio.h
/usr/include/linux/stddef.h
