cscope 15 $HOME/git/linux/drivers/lightnvm               0000289401
	@core.c

7 
	#¥_fmt
(
fmt
Ë"nvm: " 
	)
fmt

9 
	~<löux/li°.h
>

10 
	~<löux/ty≥s.h
>

11 
	~<löux/£m.h
>

12 
	~<löux/bôm≠.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/moduÀ∑øm.h
>

15 
	~<löux/miscdevi˚.h
>

16 
	~<löux/lighävm.h
>

17 
	~<löux/sched/sys˘l.h
>

19 
LIST_HEAD
(
nvm_tgt_ty≥s
);

20 
DECLARE_RWSEM
(
nvm_tgâ_lock
);

21 
LIST_HEAD
(
nvm_devi˚s
);

22 
DECLARE_RWSEM
(
nvm_lock
);

25 
	snvm_ch_m≠
 {

26 
	mch_off
;

27 
	mnum_lun
;

28 *
	mlun_offs
;

31 
	snvm_dev_m≠
 {

32 
nvm_ch_m≠
 *
	mch∆s
;

33 
	mnum_ch
;

36 
nvm_‰ì
(
kªf
 *
ªf
);

38 
nvm_èrgë
 *
	$nvm_föd_èrgë
(
nvm_dev
 *
dev
, c⁄° *
«me
)

40 
nvm_èrgë
 *
tgt
;

42 
	`li°_f‹_óch_íåy
(
tgt
, &
dev
->
èrgës
, 
li°
)

43 i‡(!
	`°rcmp
(
«me
, 
tgt
->
disk
->
disk_«me
))

44  
tgt
;

46  
NULL
;

47 
	}
}

49 
boﬁ
 
	$nvm_èrgë_exi°s
(c⁄° *
«me
)

51 
nvm_dev
 *
dev
;

52 
nvm_èrgë
 *
tgt
;

53 
boﬁ
 
ªt
 = 
Ál£
;

55 
	`down_wrôe
(&
nvm_lock
);

56 
	`li°_f‹_óch_íåy
(
dev
, &
nvm_devi˚s
, 
devi˚s
) {

57 
	`muãx_lock
(&
dev
->
mlock
);

58 
	`li°_f‹_óch_íåy
(
tgt
, &
dev
->
èrgës
, 
li°
) {

59 i‡(!
	`°rcmp
(
«me
, 
tgt
->
disk
->
disk_«me
)) {

60 
ªt
 = 
åue
;

61 
	`muãx_u∆ock
(&
dev
->
mlock
);

62 
out
;

65 
	`muãx_u∆ock
(&
dev
->
mlock
);

68 
out
:

69 
	`up_wrôe
(&
nvm_lock
);

70  
ªt
;

71 
	}
}

73 
	$nvm_ª£rve_luns
(
nvm_dev
 *
dev
, 
lun_begö
, 
lun_íd
)

75 
i
;

77 
i
 = 
lun_begö
; i <
lun_íd
; i++) {

78 i‡(
	`ã°_™d_£t_bô
(
i
, 
dev
->
lun_m≠
)) {

79 
	`¥_îr
("lu¿%dáÃódyáŒoˇãd\n", 
i
);

80 
îr
;

85 
îr
:

86 --
i
 >
lun_begö
)

87 
	`˛ór_bô
(
i
, 
dev
->
lun_m≠
);

89  -
EBUSY
;

90 
	}
}

92 
	$nvm_ªÀa£_luns_îr
(
nvm_dev
 *
dev
, 
lun_begö
,

93 
lun_íd
)

95 
i
;

97 
i
 = 
lun_begö
; i <
lun_íd
; i++)

98 
	`WARN_ON
(!
	`ã°_™d_˛ór_bô
(
i
, 
dev
->
lun_m≠
));

99 
	}
}

101 
	$nvm_ªmove_tgt_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
˛ór
)

103 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

104 
nvm_dev_m≠
 *
dev_m≠
 = 
tgt_dev
->
m≠
;

105 
i
, 
j
;

107 
i
 = 0; i < 
dev_m≠
->
num_ch
; i++) {

108 
nvm_ch_m≠
 *
ch_m≠
 = &
dev_m≠
->
ch∆s
[
i
];

109 *
lun_offs
 = 
ch_m≠
->lun_offs;

110 
ch
 = 
i
 + 
ch_m≠
->
ch_off
;

112 i‡(
˛ór
) {

113 
j
 = 0; j < 
ch_m≠
->
num_lun
; j++) {

114 
lun
 = 
j
 + 
lun_offs
[j];

115 
lunid
 = (
ch
 * 
dev
->
geo
.
num_lun
Ë+ 
lun
;

117 
	`WARN_ON
(!
	`ã°_™d_˛ór_bô
(
lunid
,

118 
dev
->
lun_m≠
));

122 
	`k‰ì
(
ch_m≠
->
lun_offs
);

125 
	`k‰ì
(
dev_m≠
->
ch∆s
);

126 
	`k‰ì
(
dev_m≠
);

128 
	`k‰ì
(
tgt_dev
->
luns
);

129 
	`k‰ì
(
tgt_dev
);

130 
	}
}

132 
nvm_tgt_dev
 *
	$nvm_¸óã_tgt_dev
(
nvm_dev
 *
dev
,

133 
u16
 
lun_begö
, u16 
lun_íd
,

134 
u16
 
›
)

136 
nvm_tgt_dev
 *
tgt_dev
 = 
NULL
;

137 
nvm_dev_m≠
 *
dev_rm≠
 = 
dev
->
rm≠
;

138 
nvm_dev_m≠
 *
dev_m≠
;

139 
µa_addr
 *
luns
;

140 
num_lun
 = 
lun_íd
 - 
lun_begö
 + 1;

141 
luns_À·
 = 
num_lun
;

142 
num_ch
 = 
num_lun
 / 
dev
->
geo
.num_lun;

143 
num_ch_mod
 = 
num_lun
 % 
dev
->
geo
.num_lun;

144 
bch
 = 
lun_begö
 / 
dev
->
geo
.
num_lun
;

145 
blun
 = 
lun_begö
 % 
dev
->
geo
.
num_lun
;

146 
lunid
 = 0;

147 
lun_bÆ™˚d
 = 1;

148 
£c_≥r_lun
, 
¥ev_num_lun
;

149 
i
, 
j
;

151 
num_ch
 = (
num_ch_mod
 == 0) ?Çum_ch :Çum_ch + 1;

153 
dev_m≠
 = 
	`kmÆloc
((
nvm_dev_m≠
), 
GFP_KERNEL
);

154 i‡(!
dev_m≠
)

155 
îr_dev
;

157 
dev_m≠
->
ch∆s
 = 
	`kˇŒoc
(
num_ch
, (
nvm_ch_m≠
), 
GFP_KERNEL
);

158 i‡(!
dev_m≠
->
ch∆s
)

159 
îr_ch∆s
;

161 
luns
 = 
	`kˇŒoc
(
num_lun
, (
µa_addr
), 
GFP_KERNEL
);

162 i‡(!
luns
)

163 
îr_luns
;

165 
¥ev_num_lun
 = (
luns_À·
 > 
dev
->
geo
.
num_lun
) ?

166 
dev
->
geo
.
num_lun
 : 
luns_À·
;

167 
i
 = 0; i < 
num_ch
; i++) {

168 
nvm_ch_m≠
 *
ch_rm≠
 = &
dev_rm≠
->
ch∆s
[
i
 + 
bch
];

169 *
lun_roffs
 = 
ch_rm≠
->
lun_offs
;

170 
nvm_ch_m≠
 *
ch_m≠
 = &
dev_m≠
->
ch∆s
[
i
];

171 *
lun_offs
;

172 
luns_ö_ch∆
 = (
luns_À·
 > 
dev
->
geo
.
num_lun
) ?

173 
dev
->
geo
.
num_lun
 : 
luns_À·
;

175 i‡(
lun_bÆ™˚d
 && 
¥ev_num_lun
 !
luns_ö_ch∆
)

176 
lun_bÆ™˚d
 = 0;

178 
ch_m≠
->
ch_off
 = 
ch_rm≠
->ch_of‡
bch
;

179 
ch_m≠
->
num_lun
 = 
luns_ö_ch∆
;

181 
lun_offs
 = 
	`kˇŒoc
(
luns_ö_ch∆
, (), 
GFP_KERNEL
);

182 i‡(!
lun_offs
)

183 
îr_ch
;

185 
j
 = 0; j < 
luns_ö_ch∆
; j++) {

186 
luns
[
lunid
].
µa
 = 0;

187 
luns
[
lunid
].
a
.
ch
 = 
i
;

188 
luns
[
lunid
++].
a
.
lun
 = 
j
;

190 
lun_offs
[
j
] = 
blun
;

191 
lun_roffs
[
j
 + 
blun
] = blun;

194 
ch_m≠
->
lun_offs
 =Üun_offs;

197 
blun
 = 0;

198 
luns_À·
 -
luns_ö_ch∆
;

201 
dev_m≠
->
num_ch
 =Çum_ch;

203 
tgt_dev
 = 
	`kmÆloc
((
nvm_tgt_dev
), 
GFP_KERNEL
);

204 i‡(!
tgt_dev
)

205 
îr_ch
;

208 
	`mem˝y
(&
tgt_dev
->
geo
, &
dev
->geo, (
nvm_geo
));

211 
tgt_dev
->
geo
.
num_ch
 =Çum_ch;

212 
tgt_dev
->
geo
.
num_lun
 = (
lun_bÆ™˚d
Ë? 
¥ev_num_lun
 : -1;

213 
tgt_dev
->
geo
.
Æl_luns
 = 
num_lun
;

214 
tgt_dev
->
geo
.
Æl_chunks
 = 
num_lun
 * 
dev
->geo.
num_chk
;

216 
tgt_dev
->
geo
.
›
 = op;

218 
£c_≥r_lun
 = 
dev
->
geo
.
˛ba
 * dev->geo.
num_chk
;

219 
tgt_dev
->
geo
.
tŸÆ_£cs
 = 
num_lun
 * 
£c_≥r_lun
;

221 
tgt_dev
->
q
 = 
dev
->q;

222 
tgt_dev
->
m≠
 = 
dev_m≠
;

223 
tgt_dev
->
luns
 =Üuns;

224 
tgt_dev
->
∑ª¡
 = 
dev
;

226  
tgt_dev
;

227 
îr_ch
:

228 --
i
 >= 0)

229 
	`k‰ì
(
dev_m≠
->
ch∆s
[
i
].
lun_offs
);

230 
	`k‰ì
(
luns
);

231 
îr_luns
:

232 
	`k‰ì
(
dev_m≠
->
ch∆s
);

233 
îr_ch∆s
:

234 
	`k‰ì
(
dev_m≠
);

235 
îr_dev
:

236  
tgt_dev
;

237 
	}
}

239 c⁄° 
block_devi˚_›î©i⁄s
 
	gnvm_f›s
 = {

240 .
ow√r
 = 
THIS_MODULE
,

243 
nvm_tgt_ty≥
 *
	$__nvm_föd_èrgë_ty≥
(c⁄° *
«me
)

245 
nvm_tgt_ty≥
 *
â
;

247 
	`li°_f‹_óch_íåy
(
â
, &
nvm_tgt_ty≥s
, 
li°
)

248 i‡(!
	`°rcmp
(
«me
, 
â
->name))

249  
â
;

251  
NULL
;

252 
	}
}

254 
nvm_tgt_ty≥
 *
	$nvm_föd_èrgë_ty≥
(c⁄° *
«me
)

256 
nvm_tgt_ty≥
 *
â
;

258 
	`down_wrôe
(&
nvm_tgâ_lock
);

259 
â
 = 
	`__nvm_föd_èrgë_ty≥
(
«me
);

260 
	`up_wrôe
(&
nvm_tgâ_lock
);

262  
â
;

263 
	}
}

265 
	$nvm_c⁄fig_check_luns
(
nvm_geo
 *
geo
, 
lun_begö
,

266 
lun_íd
)

268 i‡(
lun_begö
 > 
lun_íd
 ||Üun_íd >
geo
->
Æl_luns
) {

269 
	`¥_îr
("lun out of bound (%u:%u > %u)\n",

270 
lun_begö
, 
lun_íd
, 
geo
->
Æl_luns
 - 1);

271  -
EINVAL
;

275 
	}
}

277 
	$__nvm_c⁄fig_sim∂e
(
nvm_dev
 *
dev
,

278 
nvm_io˘l_¸óã_sim∂e
 *
s
)

280 
nvm_geo
 *
geo
 = &
dev
->geo;

282 i‡(
s
->
lun_begö
 =-1 && s->
lun_íd
 == -1) {

283 
s
->
lun_begö
 = 0;

284 
s
->
lun_íd
 = 
geo
->
Æl_luns
 - 1;

287  
	`nvm_c⁄fig_check_luns
(
geo
, 
s
->
lun_begö
, s->
lun_íd
);

288 
	}
}

290 
	$__nvm_c⁄fig_exãnded
(
nvm_dev
 *
dev
,

291 
nvm_io˘l_¸óã_exãnded
 *
e
)

293 i‡(
e
->
lun_begö
 =0xFFFF &&É->
lun_íd
 == 0xFFFF) {

294 
e
->
lun_begö
 = 0;

295 
e
->
lun_íd
 = 
dev
->
geo
.
Æl_luns
 - 1;

299 i‡(
e
->
›
 == 0xFFFF) {

300 
e
->
›
 = 
NVM_TARGET_DEFAULT_OP
;

301 } i‡(
e
->
›
 < 
NVM_TARGET_MIN_OP
 ||É->› > 
NVM_TARGET_MAX_OP
) {

302 
	`¥_îr
("invalid overÖrovisioning value\n");

303  -
EINVAL
;

306  
	`nvm_c⁄fig_check_luns
(&
dev
->
geo
, 
e
->
lun_begö
,É->
lun_íd
);

307 
	}
}

309 
	$nvm_¸óã_tgt
(
nvm_dev
 *
dev
, 
nvm_io˘l_¸óã
 *
¸óã
)

311 
nvm_io˘l_¸óã_exãnded
 
e
;

312 
ªque°_queue
 *
tqueue
;

313 
gídisk
 *
tdisk
;

314 
nvm_tgt_ty≥
 *
â
;

315 
nvm_èrgë
 *
t
;

316 
nvm_tgt_dev
 *
tgt_dev
;

317 *
èrgëd©a
;

318 
mdts
;

319 
ªt
;

321 
¸óã
->
c⁄f
.
ty≥
) {

322 
NVM_CONFIG_TYPE_SIMPLE
:

323 
ªt
 = 
	`__nvm_c⁄fig_sim∂e
(
dev
, &
¸óã
->
c⁄f
.
s
);

324 i‡(
ªt
)

325  
ªt
;

327 
e
.
lun_begö
 = 
¸óã
->
c⁄f
.
s
.lun_begin;

328 
e
.
lun_íd
 = 
¸óã
->
c⁄f
.
s
.lun_end;

329 
e
.
›
 = 
NVM_TARGET_DEFAULT_OP
;

331 
NVM_CONFIG_TYPE_EXTENDED
:

332 
ªt
 = 
	`__nvm_c⁄fig_exãnded
(
dev
, &
¸óã
->
c⁄f
.
e
);

333 i‡(
ªt
)

334  
ªt
;

336 
e
 = 
¸óã
->
c⁄f
.e;

339 
	`¥_îr
("configÅypeÇot valid\n");

340  -
EINVAL
;

343 
â
 = 
	`nvm_föd_èrgë_ty≥
(
¸óã
->
tgây≥
);

344 i‡(!
â
) {

345 
	`¥_îr
("èrgëÅy≥ %†nŸ found\n", 
¸óã
->
tgây≥
);

346  -
EINVAL
;

349 i‡((
â
->
Êags
 & 
NVM_TGT_F_HOST_L2P
Ë!(
dev
->
geo
.
dom
 & 
NVM_RSP_L2P
)) {

350 
	`¥_îr
("device is incompatible withÅarget L2PÅype.\n");

351  -
EINVAL
;

354 i‡(
	`nvm_èrgë_exi°s
(
¸óã
->
tgäame
)) {

355 
	`¥_îr
("targetÇameálreadyÉxists (%s)\n",

356 
¸óã
->
tgäame
);

357  -
EINVAL
;

360 
ªt
 = 
	`nvm_ª£rve_luns
(
dev
, 
e
.
lun_begö
,É.
lun_íd
);

361 i‡(
ªt
)

362  
ªt
;

364 
t
 = 
	`kmÆloc
((
nvm_èrgë
), 
GFP_KERNEL
);

365 i‡(!
t
) {

366 
ªt
 = -
ENOMEM
;

367 
îr_ª£rve
;

370 
tgt_dev
 = 
	`nvm_¸óã_tgt_dev
(
dev
, 
e
.
lun_begö
,É.
lun_íd
,É.
›
);

371 i‡(!
tgt_dev
) {

372 
	`¥_îr
("couldÇot createÅarget device\n");

373 
ªt
 = -
ENOMEM
;

374 
îr_t
;

377 
tdisk
 = 
	`Æloc_disk
(0);

378 i‡(!
tdisk
) {

379 
ªt
 = -
ENOMEM
;

380 
îr_dev
;

383 
tqueue
 = 
	`blk_Æloc_queue
(
â
->
make_rq
, 
dev
->
q
->
node
);

384 i‡(!
tqueue
) {

385 
ªt
 = -
ENOMEM
;

386 
îr_disk
;

389 
	`°æ˝y
(
tdisk
->
disk_«me
, 
¸óã
->
tgäame
, (tdisk->disk_name));

390 
tdisk
->
Êags
 = 
GENHD_FL_EXT_DEVT
;

391 
tdisk
->
maj‹
 = 0;

392 
tdisk
->
fú°_mö‹
 = 0;

393 
tdisk
->
f›s
 = &
nvm_f›s
;

394 
tdisk
->
queue
 = 
tqueue
;

396 
èrgëd©a
 = 
â
->
	`öô
(
tgt_dev
, 
tdisk
, 
¸óã
->
Êags
);

397 i‡(
	`IS_ERR
(
èrgëd©a
)) {

398 
ªt
 = 
	`PTR_ERR
(
èrgëd©a
);

399 
îr_öô
;

402 
tdisk
->
¥iv©e_d©a
 = 
èrgëd©a
;

403 
tqueue
->
queued©a
 = 
èrgëd©a
;

405 
mdts
 = (
dev
->
geo
.
c£cs
 >> 9Ë* 
NVM_MAX_VLBA
;

406 i‡(
dev
->
geo
.
mdts
) {

407 
mdts
 = 
	`mö_t
(
u32
, 
dev
->
geo
.mdts,

408 (
dev
->
geo
.
c£cs
 >> 9Ë* 
NVM_MAX_VLBA
);

410 
	`blk_queue_max_hw_£˘‹s
(
tqueue
, 
mdts
);

412 
	`£t_ˇ∑côy
(
tdisk
, 
â
->
	`ˇ∑côy
(
èrgëd©a
));

413 
	`add_disk
(
tdisk
);

415 i‡(
â
->
sysfs_öô
 &&Åt->
	`sysfs_öô
(
tdisk
)) {

416 
ªt
 = -
ENOMEM
;

417 
îr_sysfs
;

420 
t
->
ty≥
 = 
â
;

421 
t
->
disk
 = 
tdisk
;

422 
t
->
dev
 = 
tgt_dev
;

424 
	`muãx_lock
(&
dev
->
mlock
);

425 
	`li°_add_èû
(&
t
->
li°
, &
dev
->
èrgës
);

426 
	`muãx_u∆ock
(&
dev
->
mlock
);

428 
	`__moduÀ_gë
(
â
->
ow√r
);

431 
îr_sysfs
:

432 i‡(
â
->
exô
)

433 
â
->
	`exô
(
èrgëd©a
, 
åue
);

434 
îr_öô
:

435 
	`blk_˛ónup_queue
(
tqueue
);

436 
tdisk
->
queue
 = 
NULL
;

437 
îr_disk
:

438 
	`put_disk
(
tdisk
);

439 
îr_dev
:

440 
	`nvm_ªmove_tgt_dev
(
tgt_dev
, 0);

441 
îr_t
:

442 
	`k‰ì
(
t
);

443 
îr_ª£rve
:

444 
	`nvm_ªÀa£_luns_îr
(
dev
, 
e
.
lun_begö
,É.
lun_íd
);

445  
ªt
;

446 
	}
}

448 
	$__nvm_ªmove_èrgë
(
nvm_èrgë
 *
t
, 
boﬁ
 
gø˚ful
)

450 
nvm_tgt_ty≥
 *
â
 = 
t
->
ty≥
;

451 
gídisk
 *
tdisk
 = 
t
->
disk
;

452 
ªque°_queue
 *
q
 = 
tdisk
->
queue
;

454 
	`dñ_gídisk
(
tdisk
);

455 
	`blk_˛ónup_queue
(
q
);

457 i‡(
â
->
sysfs_exô
)

458 
â
->
	`sysfs_exô
(
tdisk
);

460 i‡(
â
->
exô
)

461 
â
->
	`exô
(
tdisk
->
¥iv©e_d©a
, 
gø˚ful
);

463 
	`nvm_ªmove_tgt_dev
(
t
->
dev
, 1);

464 
	`put_disk
(
tdisk
);

465 
	`moduÀ_put
(
t
->
ty≥
->
ow√r
);

467 
	`li°_dñ
(&
t
->
li°
);

468 
	`k‰ì
(
t
);

469 
	}
}

480 
	$nvm_ªmove_tgt
(
nvm_io˘l_ªmove
 *
ªmove
)

482 
nvm_èrgë
 *
t
 = 
NULL
;

483 
nvm_dev
 *
dev
;

485 
	`down_ªad
(&
nvm_lock
);

486 
	`li°_f‹_óch_íåy
(
dev
, &
nvm_devi˚s
, 
devi˚s
) {

487 
	`muãx_lock
(&
dev
->
mlock
);

488 
t
 = 
	`nvm_föd_èrgë
(
dev
, 
ªmove
->
tgäame
);

489 i‡(
t
) {

490 
	`muãx_u∆ock
(&
dev
->
mlock
);

493 
	`muãx_u∆ock
(&
dev
->
mlock
);

495 
	`up_ªad
(&
nvm_lock
);

497 i‡(!
t
) {

498 
	`¥_îr
("failedÅoÑemoveÅarget %s\n",

499 
ªmove
->
tgäame
);

503 
	`__nvm_ªmove_èrgë
(
t
, 
åue
);

504 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

507 
	}
}

509 
	$nvm_ªgi°î_m≠
(
nvm_dev
 *
dev
)

511 
nvm_dev_m≠
 *
rm≠
;

512 
i
, 
j
;

514 
rm≠
 = 
	`kmÆloc
((
nvm_dev_m≠
), 
GFP_KERNEL
);

515 i‡(!
rm≠
)

516 
îr_rm≠
;

518 
rm≠
->
ch∆s
 = 
	`kˇŒoc
(
dev
->
geo
.
num_ch
, (
nvm_ch_m≠
),

519 
GFP_KERNEL
);

520 i‡(!
rm≠
->
ch∆s
)

521 
îr_ch∆s
;

523 
i
 = 0; i < 
dev
->
geo
.
num_ch
; i++) {

524 
nvm_ch_m≠
 *
ch_rm≠
;

525 *
lun_roffs
;

526 
luns_ö_ch∆
 = 
dev
->
geo
.
num_lun
;

528 
ch_rm≠
 = &
rm≠
->
ch∆s
[
i
];

530 
ch_rm≠
->
ch_off
 = -1;

531 
ch_rm≠
->
num_lun
 = 
luns_ö_ch∆
;

533 
lun_roffs
 = 
	`kˇŒoc
(
luns_ö_ch∆
, (), 
GFP_KERNEL
);

534 i‡(!
lun_roffs
)

535 
îr_ch
;

537 
j
 = 0; j < 
luns_ö_ch∆
; j++)

538 
lun_roffs
[
j
] = -1;

540 
ch_rm≠
->
lun_offs
 = 
lun_roffs
;

543 
dev
->
rm≠
 =Ñmap;

546 
îr_ch
:

547 --
i
 >= 0)

548 
	`k‰ì
(
rm≠
->
ch∆s
[
i
].
lun_offs
);

549 
îr_ch∆s
:

550 
	`k‰ì
(
rm≠
);

551 
îr_rm≠
:

552  -
ENOMEM
;

553 
	}
}

555 
	$nvm_uƒegi°î_m≠
(
nvm_dev
 *
dev
)

557 
nvm_dev_m≠
 *
rm≠
 = 
dev
->rmap;

558 
i
;

560 
i
 = 0; i < 
dev
->
geo
.
num_ch
; i++)

561 
	`k‰ì
(
rm≠
->
ch∆s
[
i
].
lun_offs
);

563 
	`k‰ì
(
rm≠
->
ch∆s
);

564 
	`k‰ì
(
rm≠
);

565 
	}
}

567 
	$nvm_m≠_to_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
p
)

569 
nvm_dev_m≠
 *
dev_m≠
 = 
tgt_dev
->
m≠
;

570 
nvm_ch_m≠
 *
ch_m≠
 = &
dev_m≠
->
ch∆s
[
p
->
a
.
ch
];

571 
lun_off
 = 
ch_m≠
->
lun_offs
[
p
->
a
.
lun
];

573 
p
->
a
.
ch
 +
ch_m≠
->
ch_off
;

574 
p
->
a
.
lun
 +
lun_off
;

575 
	}
}

577 
	$nvm_m≠_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
p
)

579 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

580 
nvm_dev_m≠
 *
dev_rm≠
 = 
dev
->
rm≠
;

581 
nvm_ch_m≠
 *
ch_rm≠
 = &
dev_rm≠
->
ch∆s
[
p
->
a
.
ch
];

582 
lun_roff
 = 
ch_rm≠
->
lun_offs
[
p
->
a
.
lun
];

584 
p
->
a
.
ch
 -
ch_rm≠
->
ch_off
;

585 
p
->
a
.
lun
 -
lun_roff
;

586 
	}
}

588 
	$nvm_µa_tgt_to_dev
(
nvm_tgt_dev
 *
tgt_dev
,

589 
µa_addr
 *
µa_li°
, 
ƒ_µas
)

591 
i
;

593 
i
 = 0; i < 
ƒ_µas
; i++) {

594 
	`nvm_m≠_to_dev
(
tgt_dev
, &
µa_li°
[
i
]);

595 
µa_li°
[
i
] = 
	`gíîic_to_dev_addr
(
tgt_dev
->
∑ª¡
,Öpa_list[i]);

597 
	}
}

599 
	$nvm_µa_dev_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
,

600 
µa_addr
 *
µa_li°
, 
ƒ_µas
)

602 
i
;

604 
i
 = 0; i < 
ƒ_µas
; i++) {

605 
µa_li°
[
i
] = 
	`dev_to_gíîic_addr
(
tgt_dev
->
∑ª¡
,Öpa_list[i]);

606 
	`nvm_m≠_to_tgt
(
tgt_dev
, &
µa_li°
[
i
]);

608 
	}
}

610 
	$nvm_rq_tgt_to_dev
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

612 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

614 
	`nvm_µa_tgt_to_dev
(
tgt_dev
, 
µa_li°
, 
rqd
->
ƒ_µas
);

615 
	}
}

617 
	$nvm_rq_dev_to_tgt
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
)

619 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

621 
	`nvm_µa_dev_to_tgt
(
tgt_dev
, 
µa_li°
, 
rqd
->
ƒ_µas
);

622 
	}
}

624 
	$nvm_ªgi°î_tgt_ty≥
(
nvm_tgt_ty≥
 *
â
)

626 
ªt
 = 0;

628 
	`down_wrôe
(&
nvm_tgâ_lock
);

629 i‡(
	`__nvm_föd_èrgë_ty≥
(
â
->
«me
))

630 
ªt
 = -
EEXIST
;

632 
	`li°_add
(&
â
->
li°
, &
nvm_tgt_ty≥s
);

633 
	`up_wrôe
(&
nvm_tgâ_lock
);

635  
ªt
;

636 
	}
}

637 
EXPORT_SYMBOL
(
nvm_ªgi°î_tgt_ty≥
);

639 
	$nvm_uƒegi°î_tgt_ty≥
(
nvm_tgt_ty≥
 *
â
)

641 i‡(!
â
)

644 
	`down_wrôe
(&
nvm_tgâ_lock
);

645 
	`li°_dñ
(&
â
->
li°
);

646 
	`up_wrôe
(&
nvm_tgâ_lock
);

647 
	}
}

648 
EXPORT_SYMBOL
(
nvm_uƒegi°î_tgt_ty≥
);

650 *
	$nvm_dev_dma_Æloc
(
nvm_dev
 *
dev
, 
gÂ_t
 
mem_Êags
,

651 
dma_addr_t
 *
dma_h™dÀr
)

653  
dev
->
›s
->
	`dev_dma_Æloc
(dev, dev->
dma_poﬁ
, 
mem_Êags
,

654 
dma_h™dÀr
);

655 
	}
}

656 
EXPORT_SYMBOL
(
nvm_dev_dma_Æloc
);

658 
	$nvm_dev_dma_‰ì
(
nvm_dev
 *
dev
, *
addr
, 
dma_addr_t
 
dma_h™dÀr
)

660 
dev
->
›s
->
	`dev_dma_‰ì
(dev->
dma_poﬁ
, 
addr
, 
dma_h™dÀr
);

661 
	}
}

662 
EXPORT_SYMBOL
(
nvm_dev_dma_‰ì
);

664 
nvm_dev
 *
	$nvm_föd_nvm_dev
(c⁄° *
«me
)

666 
nvm_dev
 *
dev
;

668 
	`li°_f‹_óch_íåy
(
dev
, &
nvm_devi˚s
, 
devi˚s
)

669 i‡(!
	`°rcmp
(
«me
, 
dev
->name))

670  
dev
;

672  
NULL
;

673 
	}
}

675 
	$nvm_£t_rqd_µÆi°
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
,

676 c⁄° 
µa_addr
 *
µas
, 
ƒ_µas
)

678 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

679 
nvm_geo
 *
geo
 = &
tgt_dev
->geo;

680 
i
, 
∂™e_˙t
, 
∂_idx
;

681 
µa_addr
 
µa
;

683 i‡(
geo
->
∂n_mode
 =
NVM_PLANE_SINGLE
 && 
ƒ_µas
 == 1) {

684 
rqd
->
ƒ_µas
 =Çr_ppas;

685 
rqd
->
µa_addr
 = 
µas
[0];

690 
rqd
->
ƒ_µas
 =Çr_ppas;

691 
rqd
->
µa_li°
 = 
	`nvm_dev_dma_Æloc
(
dev
, 
GFP_KERNEL
, &rqd->
dma_µa_li°
);

692 i‡(!
rqd
->
µa_li°
) {

693 
	`¥_îr
("failedÅoállocate dma memory\n");

694  -
ENOMEM
;

697 
∂™e_˙t
 = 
geo
->
∂n_mode
;

698 
rqd
->
ƒ_µas
 *
∂™e_˙t
;

700 
i
 = 0; i < 
ƒ_µas
; i++) {

701 
∂_idx
 = 0;Öl_idx < 
∂™e_˙t
;Öl_idx++) {

702 
µa
 = 
µas
[
i
];

703 
µa
.
g
.
∂
 = 
∂_idx
;

704 
rqd
->
µa_li°
[(
∂_idx
 * 
ƒ_µas
Ë+ 
i
] = 
µa
;

709 
	}
}

711 
	$nvm_‰ì_rqd_µÆi°
(
nvm_tgt_dev
 *
tgt_dev
,

712 
nvm_rq
 *
rqd
)

714 i‡(!
rqd
->
µa_li°
)

717 
	`nvm_dev_dma_‰ì
(
tgt_dev
->
∑ª¡
, 
rqd
->
µa_li°
,Ñqd->
dma_µa_li°
);

718 
	}
}

720 
	$nvm_£t_Êags
(
nvm_geo
 *
geo
, 
nvm_rq
 *
rqd
)

722 
Êags
 = 0;

724 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_20
)

727 i‡(
rqd
->
is_£q
)

728 
Êags
 |
geo
->
∂n_mode
 >> 1;

730 i‡(
rqd
->
›code
 =
NVM_OP_PREAD
)

731 
Êags
 |(
NVM_IO_SCRAMBLE_ENABLE
 | 
NVM_IO_SUSPEND
);

732 i‡(
rqd
->
›code
 =
NVM_OP_PWRITE
)

733 
Êags
 |
NVM_IO_SCRAMBLE_ENABLE
;

735  
Êags
;

736 
	}
}

738 
	$nvm_submô_io
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
, *
buf
)

740 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

741 
ªt
;

743 i‡(!
dev
->
›s
->
submô_io
)

744  -
ENODEV
;

746 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, 
rqd
);

748 
rqd
->
dev
 = 
tgt_dev
;

749 
rqd
->
Êags
 = 
	`nvm_£t_Êags
(&
tgt_dev
->
geo
,Ñqd);

752 
ªt
 = 
dev
->
›s
->
	`submô_io
(dev, 
rqd
, 
buf
);

753 i‡(
ªt
)

754 
	`nvm_rq_dev_to_tgt
(
tgt_dev
, 
rqd
);

755  
ªt
;

756 
	}
}

757 
EXPORT_SYMBOL
(
nvm_submô_io
);

759 
	$nvm_sync_íd_io
(
nvm_rq
 *
rqd
)

761 
com∂ëi⁄
 *
waôög
 = 
rqd
->
¥iv©e
;

763 
	`com∂ëe
(
waôög
);

764 
	}
}

766 
	$nvm_submô_io_waô
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
,

767 *
buf
)

769 
	`DECLARE_COMPLETION_ONSTACK
(
waô
);

770 
ªt
 = 0;

772 
rqd
->
íd_io
 = 
nvm_sync_íd_io
;

773 
rqd
->
¥iv©e
 = &
waô
;

775 
ªt
 = 
dev
->
›s
->
	`submô_io
(dev, 
rqd
, 
buf
);

776 i‡(
ªt
)

777  
ªt
;

779 
	`waô_f‹_com∂ëi⁄_io
(&
waô
);

782 
	}
}

784 
	$nvm_submô_io_sync
(
nvm_tgt_dev
 *
tgt_dev
, 
nvm_rq
 *
rqd
,

785 *
buf
)

787 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

788 
ªt
;

790 i‡(!
dev
->
›s
->
submô_io
)

791  -
ENODEV
;

793 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, 
rqd
);

795 
rqd
->
dev
 = 
tgt_dev
;

796 
rqd
->
Êags
 = 
	`nvm_£t_Êags
(&
tgt_dev
->
geo
,Ñqd);

798 
ªt
 = 
	`nvm_submô_io_waô
(
dev
, 
rqd
, 
buf
);

800  
ªt
;

801 
	}
}

802 
EXPORT_SYMBOL
(
nvm_submô_io_sync
);

804 
	$nvm_íd_io
(
nvm_rq
 *
rqd
)

806 
nvm_tgt_dev
 *
tgt_dev
 = 
rqd
->
dev
;

809 i‡(
tgt_dev
)

810 
	`nvm_rq_dev_to_tgt
(
tgt_dev
, 
rqd
);

812 i‡(
rqd
->
íd_io
)

813 
rqd
->
	`íd_io
(rqd);

814 
	}
}

815 
EXPORT_SYMBOL
(
nvm_íd_io
);

817 
	$nvm_submô_io_sync_øw
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

819 i‡(!
dev
->
›s
->
submô_io
)

820  -
ENODEV
;

822 
rqd
->
dev
 = 
NULL
;

823 
rqd
->
Êags
 = 
	`nvm_£t_Êags
(&
dev
->
geo
,Ñqd);

825  
	`nvm_submô_io_waô
(
dev
, 
rqd
, 
NULL
);

826 
	}
}

828 
	$nvm_bb_chunk_£n£
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
)

830 
nvm_rq
 
rqd
 = { 
NULL
 };

831 
bio
 bio;

832 
bio_vec
 bio_vec;

833 
∑ge
 *page;

834 
ªt
;

836 
∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

837 i‡(!
∑ge
)

838  -
ENOMEM
;

840 
	`bio_öô
(&
bio
, &
bio_vec
, 1);

841 
	`bio_add_∑ge
(&
bio
, 
∑ge
, 
PAGE_SIZE
, 0);

842 
	`bio_£t_›_©ås
(&
bio
, 
REQ_OP_READ
, 0);

844 
rqd
.
bio
 = &bio;

845 
rqd
.
›code
 = 
NVM_OP_PREAD
;

846 
rqd
.
is_£q
 = 1;

847 
rqd
.
ƒ_µas
 = 1;

848 
rqd
.
µa_addr
 = 
	`gíîic_to_dev_addr
(
dev
, 
µa
);

850 
ªt
 = 
	`nvm_submô_io_sync_øw
(
dev
, &
rqd
);

851 i‡(
ªt
)

852  
ªt
;

854 
	`__‰ì_∑ge
(
∑ge
);

856  
rqd
.
îr‹
;

857 
	}
}

864 
	$nvm_bb_chunk_sˇn
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
,

865 
nvm_chk_mëa
 *
mëa
)

867 
nvm_geo
 *
geo
 = &
dev
->geo;

868 
ªt
, 
pg
, 
∂
;

871 
ªt
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

872 i‡(
ªt
 < 0)

873  
ªt
;

874 i‡(
ªt
 == 0)

875 
mëa
->
°©e
 = 
NVM_CHK_ST_OPEN
;

876 i‡(
ªt
 > 0) {

881 
ªt
) {

882 
NVM_RSP_ERR_EMPTYPAGE
:

883 
mëa
->
°©e
 = 
NVM_CHK_ST_FREE
;

885 
NVM_RSP_ERR_FAILCRC
:

886 
NVM_RSP_ERR_FAILECC
:

887 
NVM_RSP_WARN_HIGHECC
:

888 
mëa
->
°©e
 = 
NVM_CHK_ST_OPEN
;

889 
sˇn
;

891  -
ªt
;

896 
µa
.
g
.
pg
 = 
geo
->
num_pg
 - 1;

897 
µa
.
g
.
∂
 = 
geo
->
num_∂n
 - 1;

899 
ªt
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

900 i‡(
ªt
 < 0)

901  
ªt
;

902 i‡(
ªt
 == 0) {

903 
mëa
->
°©e
 = 
NVM_CHK_ST_CLOSED
;

904 
mëa
->
wp
 = 
geo
->
˛ba
;

906 } i‡(
ªt
 > 0) {

907 
ªt
) {

908 
NVM_RSP_ERR_EMPTYPAGE
:

909 
NVM_RSP_ERR_FAILCRC
:

910 
NVM_RSP_ERR_FAILECC
:

911 
NVM_RSP_WARN_HIGHECC
:

912 
mëa
->
°©e
 = 
NVM_CHK_ST_OPEN
;

915  -
ªt
;

919 
sˇn
:

925 
pg
 = 0;Ög < 
geo
->
num_pg
;Ög++) {

926 
∂
 = 0;Ö»< 
geo
->
num_∂n
;Öl++) {

927 
µa
.
g
.
pg
 =Ög;

928 
µa
.
g
.
∂
 =Öl;

930 
ªt
 = 
	`nvm_bb_chunk_£n£
(
dev
, 
µa
);

931 i‡(
ªt
 < 0)

932  
ªt
;

933 i‡(
ªt
 == 0) {

934 
mëa
->
wp
 +
geo
->
ws_mö
;

935 } i‡(
ªt
 > 0) {

936 
ªt
) {

937 
NVM_RSP_ERR_EMPTYPAGE
:

939 
NVM_RSP_ERR_FAILCRC
:

940 
NVM_RSP_ERR_FAILECC
:

941 
NVM_RSP_WARN_HIGHECC
:

942 
mëa
->
wp
 +
geo
->
ws_mö
;

945  -
ªt
;

952 
	}
}

961 
	$nvm_bb_to_chunk
(
nvm_dev
 *
dev
, 
µa_addr
 
µa
,

962 
u8
 *
blks
, 
ƒ_blks
, 
nvm_chk_mëa
 *
mëa
)

964 
nvm_geo
 *
geo
 = &
dev
->geo;

965 
ªt
, 
blk
, 
∂
, 
off£t
, 
blkty≥
;

967 
blk
 = 0; blk < 
geo
->
num_chk
; blk++) {

968 
off£t
 = 
blk
 * 
geo
->
∂n_mode
;

969 
blkty≥
 = 
blks
[
off£t
];

971 
∂
 = 0;Ö»< 
geo
->
∂n_mode
;Öl++) {

972 i‡(
blks
[
off£t
 + 
∂
] &

973 (
NVM_BLK_T_BAD
|
NVM_BLK_T_GRWN_BAD
)) {

974 
blkty≥
 = 
blks
[
off£t
 + 
∂
];

979 
µa
.
g
.
blk
 = blk;

981 
mëa
->
wp
 = 0;

982 
mëa
->
ty≥
 = 
NVM_CHK_TP_W_SEQ
;

983 
mëa
->
wi
 = 0;

984 
mëa
->
¶ba
 = 
	`gíîic_to_dev_addr
(
dev
, 
µa
).ppa;

985 
mëa
->
˙lb
 = 
dev
->
geo
.
˛ba
;

987 i‡(
blkty≥
 =
NVM_BLK_T_FREE
) {

988 
ªt
 = 
	`nvm_bb_chunk_sˇn
(
dev
, 
µa
, 
mëa
);

989 i‡(
ªt
)

990  
ªt
;

992 
mëa
->
°©e
 = 
NVM_CHK_ST_OFFLINE
;

995 
mëa
++;

999 
	}
}

1001 
	$nvm_gë_bb_mëa
(
nvm_dev
 *
dev
, 
£˘‹_t
 
¶ba
,

1002 
nchks
, 
nvm_chk_mëa
 *
mëa
)

1004 
nvm_geo
 *
geo
 = &
dev
->geo;

1005 
µa_addr
 
µa
;

1006 
u8
 *
blks
;

1007 
ch
, 
lun
, 
ƒ_blks
;

1008 
ªt
 = 0;

1010 
µa
.µ®
¶ba
;

1011 
µa
 = 
	`dev_to_gíîic_addr
(
dev
,Öpa);

1013 i‡(
µa
.
g
.
blk
 != 0)

1014  -
EINVAL
;

1016 i‡((
nchks
 % 
geo
->
num_chk
) != 0)

1017  -
EINVAL
;

1019 
ƒ_blks
 = 
geo
->
num_chk
 * geo->
∂n_mode
;

1021 
blks
 = 
	`kmÆloc
(
ƒ_blks
, 
GFP_KERNEL
);

1022 i‡(!
blks
)

1023  -
ENOMEM
;

1025 
ch
 = 
µa
.
g
.ch; ch < 
geo
->
num_ch
; ch++) {

1026 
lun
 = 
µa
.
g
.lun;Üu¿< 
geo
->
num_lun
;Üun++) {

1027 
µa_addr
 
µa_gí
, 
µa_dev
;

1029 i‡(!
nchks
)

1030 
d⁄e
;

1032 
µa_gí
.
µa
 = 0;

1033 
µa_gí
.
g
.
ch
 = ch;

1034 
µa_gí
.
g
.
lun
 =Üun;

1035 
µa_dev
 = 
	`gíîic_to_dev_addr
(
dev
, 
µa_gí
);

1037 
ªt
 = 
dev
->
›s
->
	`gë_bb_tbl
(dev, 
µa_dev
, 
blks
);

1038 i‡(
ªt
)

1039 
d⁄e
;

1041 
ªt
 = 
	`nvm_bb_to_chunk
(
dev
, 
µa_gí
, 
blks
, 
ƒ_blks
,

1042 
mëa
);

1043 i‡(
ªt
)

1044 
d⁄e
;

1046 
mëa
 +
geo
->
num_chk
;

1047 
nchks
 -
geo
->
num_chk
;

1050 
d⁄e
:

1051 
	`k‰ì
(
blks
);

1052  
ªt
;

1053 
	}
}

1055 
	$nvm_gë_chunk_mëa
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 
µa
,

1056 
nchks
, 
nvm_chk_mëa
 *
mëa
)

1058 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

1060 
	`nvm_µa_tgt_to_dev
(
tgt_dev
, &
µa
, 1);

1062 i‡(
dev
->
geo
.
vîsi⁄
 =
NVM_OCSSD_SPEC_12
)

1063  
	`nvm_gë_bb_mëa
(
dev
, (
£˘‹_t
)
µa
.µa, 
nchks
, 
mëa
);

1065  
dev
->
›s
->
	`gë_chk_mëa
(dev, (
£˘‹_t
)
µa
.µa, 
nchks
, 
mëa
);

1066 
	}
}

1067 
EXPORT_SYMBOL_GPL
(
nvm_gë_chunk_mëa
);

1069 
	$nvm_£t_chunk_mëa
(
nvm_tgt_dev
 *
tgt_dev
, 
µa_addr
 *
µas
,

1070 
ƒ_µas
, 
ty≥
)

1072 
nvm_dev
 *
dev
 = 
tgt_dev
->
∑ª¡
;

1073 
nvm_rq
 
rqd
;

1074 
ªt
;

1076 i‡(
dev
->
geo
.
vîsi⁄
 =
NVM_OCSSD_SPEC_20
)

1079 i‡(
ƒ_µas
 > 
NVM_MAX_VLBA
) {

1080 
	`¥_îr
("unableÅo updateáll blocksátomically\n");

1081  -
EINVAL
;

1084 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

1086 
	`nvm_£t_rqd_µÆi°
(
tgt_dev
, &
rqd
, 
µas
, 
ƒ_µas
);

1087 
	`nvm_rq_tgt_to_dev
(
tgt_dev
, &
rqd
);

1089 
ªt
 = 
dev
->
›s
->
	`£t_bb_tbl
(dev, &
rqd
.
µa_addr
,Ñqd.
ƒ_µas
, 
ty≥
);

1090 
	`nvm_‰ì_rqd_µÆi°
(
tgt_dev
, &
rqd
);

1091 i‡(
ªt
)

1092  -
EINVAL
;

1095 
	}
}

1096 
EXPORT_SYMBOL_GPL
(
nvm_£t_chunk_mëa
);

1098 
	$nvm_c‹e_öô
(
nvm_dev
 *
dev
)

1100 
nvm_geo
 *
geo
 = &
dev
->geo;

1101 
ªt
;

1103 
dev
->
lun_m≠
 = 
	`kˇŒoc
(
	`BITS_TO_LONGS
(
geo
->
Æl_luns
),

1104 (), 
GFP_KERNEL
);

1105 i‡(!
dev
->
lun_m≠
)

1106  -
ENOMEM
;

1108 
	`INIT_LIST_HEAD
(&
dev
->
¨ó_li°
);

1109 
	`INIT_LIST_HEAD
(&
dev
->
èrgës
);

1110 
	`muãx_öô
(&
dev
->
mlock
);

1111 
	`•ö_lock_öô
(&
dev
->
lock
);

1113 
ªt
 = 
	`nvm_ªgi°î_m≠
(
dev
);

1114 i‡(
ªt
)

1115 
îr_fmty≥
;

1118 
îr_fmty≥
:

1119 
	`k‰ì
(
dev
->
lun_m≠
);

1120  
ªt
;

1121 
	}
}

1123 
	$nvm_‰ì
(
kªf
 *
ªf
)

1125 
nvm_dev
 *
dev
 = 
	`c⁄èöî_of
(
ªf
, nvm_dev,Ñef);

1127 i‡(
dev
->
dma_poﬁ
)

1128 
dev
->
›s
->
	`de°roy_dma_poﬁ
(dev->
dma_poﬁ
);

1130 i‡(
dev
->
rm≠
)

1131 
	`nvm_uƒegi°î_m≠
(
dev
);

1133 
	`k‰ì
(
dev
->
lun_m≠
);

1134 
	`k‰ì
(
dev
);

1135 
	}
}

1137 
	$nvm_öô
(
nvm_dev
 *
dev
)

1139 
nvm_geo
 *
geo
 = &
dev
->geo;

1140 
ªt
 = -
EINVAL
;

1142 i‡(
dev
->
›s
->
	`idítôy
(dev)) {

1143 
	`¥_îr
("device couldÇot be identified\n");

1144 
îr
;

1147 
	`¥_debug
("vî:%u.%uÇvm_víd‹:%x\n", 
geo
->
maj‹_vî_id
,

1148 
geo
->
mö‹_vî_id
, geo->
vm¡
);

1150 
ªt
 = 
	`nvm_c‹e_öô
(
dev
);

1151 i‡(
ªt
) {

1152 
	`¥_îr
("couldÇot initialize core structures.\n");

1153 
îr
;

1156 
	`¥_öfo
("registered %s [%u/%u/%u/%u/%u]\n",

1157 
dev
->
«me
, dev->
geo
.
ws_mö
, dev->geo.
ws_›t
,

1158 
dev
->
geo
.
num_chk
, dev->geo.
Æl_luns
,

1159 
dev
->
geo
.
num_ch
);

1161 
îr
:

1162 
	`¥_îr
("failedÅo initializeÇvm\n");

1163  
ªt
;

1164 
	}
}

1166 
nvm_dev
 *
	$nvm_Æloc_dev
(
node
)

1168 
nvm_dev
 *
dev
;

1170 
dev
 = 
	`kzÆloc_node
((
nvm_dev
), 
GFP_KERNEL
, 
node
);

1171 i‡(
dev
)

1172 
	`kªf_öô
(&
dev
->
ªf
);

1174  
dev
;

1175 
	}
}

1176 
EXPORT_SYMBOL
(
nvm_Æloc_dev
);

1178 
	$nvm_ªgi°î
(
nvm_dev
 *
dev
)

1180 
ªt
, 
exp_poﬁ_size
;

1182 i‡(!
dev
->
q
 || !dev->
›s
) {

1183 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1184  -
EINVAL
;

1187 
ªt
 = 
	`nvm_öô
(
dev
);

1188 i‡(
ªt
) {

1189 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1190  
ªt
;

1193 
exp_poﬁ_size
 = 
	`max_t
(, 
PAGE_SIZE
,

1194 (
NVM_MAX_VLBA
 * ((
u64
Ë+ 
dev
->
geo
.
sos
)));

1195 
exp_poﬁ_size
 = 
	`round_up
”xp_poﬁ_size, 
PAGE_SIZE
);

1197 
dev
->
dma_poﬁ
 = dev->
›s
->
	`¸óã_dma_poﬁ
(dev, "ppalist",

1198 
exp_poﬁ_size
);

1199 i‡(!
dev
->
dma_poﬁ
) {

1200 
	`¥_îr
("couldÇot create dmaÖool\n");

1201 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1202  -
ENOMEM
;

1206 
	`down_wrôe
(&
nvm_lock
);

1207 
	`li°_add
(&
dev
->
devi˚s
, &
nvm_devi˚s
);

1208 
	`up_wrôe
(&
nvm_lock
);

1211 
	}
}

1212 
EXPORT_SYMBOL
(
nvm_ªgi°î
);

1214 
	$nvm_uƒegi°î
(
nvm_dev
 *
dev
)

1216 
nvm_èrgë
 *
t
, *
tmp
;

1218 
	`muãx_lock
(&
dev
->
mlock
);

1219 
	`li°_f‹_óch_íåy_ß„
(
t
, 
tmp
, &
dev
->
èrgës
, 
li°
) {

1220 i‡(
t
->
dev
->
∑ª¡
 != dev)

1222 
	`__nvm_ªmove_èrgë
(
t
, 
Ál£
);

1223 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1225 
	`muãx_u∆ock
(&
dev
->
mlock
);

1227 
	`down_wrôe
(&
nvm_lock
);

1228 
	`li°_dñ
(&
dev
->
devi˚s
);

1229 
	`up_wrôe
(&
nvm_lock
);

1231 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1232 
	}
}

1233 
EXPORT_SYMBOL
(
nvm_uƒegi°î
);

1235 
	$__nvm_c⁄figuª_¸óã
(
nvm_io˘l_¸óã
 *
¸óã
)

1237 
nvm_dev
 *
dev
;

1238 
ªt
;

1240 
	`down_wrôe
(&
nvm_lock
);

1241 
dev
 = 
	`nvm_föd_nvm_dev
(
¸óã
->dev);

1242 
	`up_wrôe
(&
nvm_lock
);

1244 i‡(!
dev
) {

1245 
	`¥_îr
("deviceÇot found\n");

1246  -
EINVAL
;

1249 
	`kªf_gë
(&
dev
->
ªf
);

1250 
ªt
 = 
	`nvm_¸óã_tgt
(
dev
, 
¸óã
);

1251 i‡(
ªt
)

1252 
	`kªf_put
(&
dev
->
ªf
, 
nvm_‰ì
);

1254  
ªt
;

1255 
	}
}

1257 
	$nvm_io˘l_öfo
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1259 
nvm_io˘l_öfo
 *
öfo
;

1260 
nvm_tgt_ty≥
 *
â
;

1261 
tgt_ôî
 = 0;

1263 
öfo
 = 
	`memdup_u£r
(
¨g
, (
nvm_io˘l_öfo
));

1264 i‡(
	`IS_ERR
(
öfo
))

1265  -
EFAULT
;

1267 
öfo
->
vîsi⁄
[0] = 
NVM_VERSION_MAJOR
;

1268 
öfo
->
vîsi⁄
[1] = 
NVM_VERSION_MINOR
;

1269 
öfo
->
vîsi⁄
[2] = 
NVM_VERSION_PATCH
;

1271 
	`down_wrôe
(&
nvm_tgâ_lock
);

1272 
	`li°_f‹_óch_íåy
(
â
, &
nvm_tgt_ty≥s
, 
li°
) {

1273 
nvm_io˘l_öfo_tgt
 *
tgt
 = &
öfo
->
tgts
[
tgt_ôî
];

1275 
tgt
->
vîsi⁄
[0] = 
â
->version[0];

1276 
tgt
->
vîsi⁄
[1] = 
â
->version[1];

1277 
tgt
->
vîsi⁄
[2] = 
â
->version[2];

1278 
	`°∫˝y
(
tgt
->
tgäame
, 
â
->
«me
, 
NVM_TTYPE_NAME_MAX
);

1280 
tgt_ôî
++;

1283 
öfo
->
tgtsize
 = 
tgt_ôî
;

1284 
	`up_wrôe
(&
nvm_tgâ_lock
);

1286 i‡(
	`c›y_to_u£r
(
¨g
, 
öfo
, (
nvm_io˘l_öfo
))) {

1287 
	`k‰ì
(
öfo
);

1288  -
EFAULT
;

1291 
	`k‰ì
(
öfo
);

1293 
	}
}

1295 
	$nvm_io˘l_gë_devi˚s
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1297 
nvm_io˘l_gë_devi˚s
 *
devi˚s
;

1298 
nvm_dev
 *
dev
;

1299 
i
 = 0;

1301 
devi˚s
 = 
	`kzÆloc
((
nvm_io˘l_gë_devi˚s
), 
GFP_KERNEL
);

1302 i‡(!
devi˚s
)

1303  -
ENOMEM
;

1305 
	`down_wrôe
(&
nvm_lock
);

1306 
	`li°_f‹_óch_íåy
(
dev
, &
nvm_devi˚s
, 
devi˚s
) {

1307 
nvm_io˘l_devi˚_öfo
 *
öfo
 = &
devi˚s
->öfo[
i
];

1309 
	`°æ˝y
(
öfo
->
dev«me
, 
dev
->
«me
, (info->devname));

1312 
öfo
->
bmvîsi⁄
[0] = 1;

1313 
öfo
->
bmvîsi⁄
[1] = 0;

1314 
öfo
->
bmvîsi⁄
[2] = 0;

1315 
	`°æ˝y
(
öfo
->
bm«me
, "gennvm", (info->bmname));

1316 
i
++;

1318 i‡(
i
 > 31) {

1319 
	`¥_îr
("max 31 devices can beÑeported.\n");

1323 
	`up_wrôe
(&
nvm_lock
);

1325 
devi˚s
->
ƒ_devi˚s
 = 
i
;

1327 i‡(
	`c›y_to_u£r
(
¨g
, 
devi˚s
,

1328 (
nvm_io˘l_gë_devi˚s
))) {

1329 
	`k‰ì
(
devi˚s
);

1330  -
EFAULT
;

1333 
	`k‰ì
(
devi˚s
);

1335 
	}
}

1337 
	$nvm_io˘l_dev_¸óã
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1339 
nvm_io˘l_¸óã
 
¸óã
;

1341 i‡(
	`c›y_‰om_u£r
(&
¸óã
, 
¨g
, (
nvm_io˘l_¸óã
)))

1342  -
EFAULT
;

1344 i‡(
¸óã
.
c⁄f
.
ty≥
 =
NVM_CONFIG_TYPE_EXTENDED
 &&

1345 
¸óã
.
c⁄f
.
e
.
rsv
 != 0) {

1346 
	`¥_îr
("reserved config field in use\n");

1347  -
EINVAL
;

1350 
¸óã
.
dev
[
DISK_NAME_LEN
 - 1] = '\0';

1351 
¸óã
.
tgây≥
[
NVM_TTYPE_NAME_MAX
 - 1] = '\0';

1352 
¸óã
.
tgäame
[
DISK_NAME_LEN
 - 1] = '\0';

1354 i‡(
¸óã
.
Êags
 != 0) {

1355 
__u32
 
Êags
 = 
¸óã
.flags;

1358 i‡(
Êags
 & 
NVM_TARGET_FACTORY
)

1359 
Êags
 &~
NVM_TARGET_FACTORY
;

1361 i‡(
Êags
) {

1362 
	`¥_îr
("flagÇot supported\n");

1363  -
EINVAL
;

1367  
	`__nvm_c⁄figuª_¸óã
(&
¸óã
);

1368 
	}
}

1370 
	$nvm_io˘l_dev_ªmove
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1372 
nvm_io˘l_ªmove
 
ªmove
;

1374 i‡(
	`c›y_‰om_u£r
(&
ªmove
, 
¨g
, (
nvm_io˘l_ªmove
)))

1375  -
EFAULT
;

1377 
ªmove
.
tgäame
[
DISK_NAME_LEN
 - 1] = '\0';

1379 i‡(
ªmove
.
Êags
 != 0) {

1380 
	`¥_îr
("no flags supported\n");

1381  -
EINVAL
;

1384  
	`nvm_ªmove_tgt
(&
ªmove
);

1385 
	}
}

1388 
	$nvm_io˘l_dev_öô
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1390 
nvm_io˘l_dev_öô
 
öô
;

1392 i‡(
	`c›y_‰om_u£r
(&
öô
, 
¨g
, (
nvm_io˘l_dev_öô
)))

1393  -
EFAULT
;

1395 i‡(
öô
.
Êags
 != 0) {

1396 
	`¥_îr
("no flags supported\n");

1397  -
EINVAL
;

1401 
	}
}

1404 
	$nvm_io˘l_dev_Á˘‹y
(
fûe
 *fûe, 
__u£r
 *
¨g
)

1406 
nvm_io˘l_dev_Á˘‹y
 
Á˘
;

1408 i‡(
	`c›y_‰om_u£r
(&
Á˘
, 
¨g
, (
nvm_io˘l_dev_Á˘‹y
)))

1409  -
EFAULT
;

1411 
Á˘
.
dev
[
DISK_NAME_LEN
 - 1] = '\0';

1413 i‡(
Á˘
.
Êags
 & ~(
NVM_FACTORY_NR_BITS
 - 1))

1414  -
EINVAL
;

1417 
	}
}

1419 
	$nvm_˘l_io˘l
(
fûe
 *fûe, 
uöt
 
cmd
, 
¨g
)

1421 
__u£r
 *
¨gp
 = (__u£∏*)
¨g
;

1423 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1424  -
EPERM
;

1426 
cmd
) {

1427 
NVM_INFO
:

1428  
	`nvm_io˘l_öfo
(
fûe
, 
¨gp
);

1429 
NVM_GET_DEVICES
:

1430  
	`nvm_io˘l_gë_devi˚s
(
fûe
, 
¨gp
);

1431 
NVM_DEV_CREATE
:

1432  
	`nvm_io˘l_dev_¸óã
(
fûe
, 
¨gp
);

1433 
NVM_DEV_REMOVE
:

1434  
	`nvm_io˘l_dev_ªmove
(
fûe
, 
¨gp
);

1435 
NVM_DEV_INIT
:

1436  
	`nvm_io˘l_dev_öô
(
fûe
, 
¨gp
);

1437 
NVM_DEV_FACTORY
:

1438  
	`nvm_io˘l_dev_Á˘‹y
(
fûe
, 
¨gp
);

1441 
	}
}

1443 c⁄° 
fûe_›î©i⁄s
 
	g_˘l_f›s
 = {

1444 .
›í
 = 
n⁄£ekabÀ_›í
,

1445 .
	gu∆ocked_io˘l
 = 
nvm_˘l_io˘l
,

1446 .
	gow√r
 = 
THIS_MODULE
,

1447 .
	gŒ£ek
 = 
no›_Œ£ek
,

1450 
miscdevi˚
 
	g_nvm_misc
 = {

1451 .
mö‹
 = 
MISC_DYNAMIC_MINOR
,

1452 .
	g«me
 = "lightnvm",

1453 .
	gnodíame
 = "lightnvm/control",

1454 .
	gf›s
 = &
_˘l_f›s
,

1456 
buûtö_misc_devi˚
(
_nvm_misc
);

	@pblk-cache.c

19 
	~"pblk.h
"

21 
	$pblk_wrôe_to_ˇche
(
pblk
 *pblk, 
bio
 *bio,

22 
Êags
)

24 
ªque°_queue
 *
q
 = 
pblk
->
dev
->q;

25 
pblk_w_˘x
 
w_˘x
;

26 
£˘‹_t
 
lba
 = 
	`pblk_gë_lba
(
bio
);

27 
°¨t_time
 = 
jiffõs
;

28 
bpos
, 
pos
;

29 
ƒ_íåõs
 = 
	`pblk_gë_£cs
(
bio
);

30 
i
, 
ªt
;

32 
	`gíîic_°¨t_io_ac˘
(
q
, 
REQ_OP_WRITE
, 
	`bio_£˘‹s
(
bio
),

33 &
pblk
->
disk
->
∑π0
);

39 
ªåy
:

40 
ªt
 = 
	`pblk_rb_may_wrôe_u£r
(&
pblk
->
rwb
, 
bio
, 
ƒ_íåõs
, &
bpos
);

41 
ªt
) {

42 
NVM_IO_REQUEUE
:

43 
	`io_scheduÀ
();

44 
ªåy
;

45 
NVM_IO_ERR
:

46 
	`pblk_pùñöe_°›
(
pblk
);

47 
	`bio_io_îr‹
(
bio
);

48 
out
;

51 
	`pblk_µa_£t_em±y
(&
w_˘x
.
µa
);

52 
w_˘x
.
Êags
 = flags;

53 i‡(
bio
->
bi_›f
 & 
REQ_PREFLUSH
) {

54 
w_˘x
.
Êags
 |
PBLK_FLUSH_ENTRY
;

55 
	`pblk_wrôe_kick
(
pblk
);

58 i‡(
	`u∆ikñy
(!
	`bio_has_d©a
(
bio
)))

59 
out
;

61 
i
 = 0; i < 
ƒ_íåõs
; i++) {

62 *
d©a
 = 
	`bio_d©a
(
bio
);

64 
w_˘x
.
lba
 =Üb®+ 
i
;

66 
pos
 = 
	`pblk_rb_wøp_pos
(&
pblk
->
rwb
, 
bpos
 + 
i
);

67 
	`pblk_rb_wrôe_íåy_u£r
(&
pblk
->
rwb
, 
d©a
, 
w_˘x
, 
pos
);

69 
	`bio_adv™˚
(
bio
, 
PBLK_EXPOSED_PAGE_SIZE
);

72 
	`©omic64_add
(
ƒ_íåõs
, &
pblk
->
u£r_wa
);

74 #ifde‡
CONFIG_NVM_PBLK_DEBUG


75 
	`©omic_l⁄g_add
(
ƒ_íåõs
, &
pblk
->
öÊight_wrôes
);

76 
	`©omic_l⁄g_add
(
ƒ_íåõs
, &
pblk
->
ªq_wrôes
);

79 
	`pblk_æ_ö£πed
(&
pblk
->
æ
, 
ƒ_íåõs
);

81 
out
:

82 
	`gíîic_íd_io_ac˘
(
q
, 
REQ_OP_WRITE
, &
pblk
->
disk
->
∑π0
, 
°¨t_time
);

83 
	`pblk_wrôe_should_kick
(
pblk
);

85 i‡(
ªt
 =
NVM_IO_DONE
)

86 
	`bio_ídio
(
bio
);

87 
	}
}

93 
	$pblk_wrôe_gc_to_ˇche
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
)

95 
pblk_w_˘x
 
w_˘x
;

96 
bpos
, 
pos
;

97 *
d©a
 = 
gc_rq
->data;

98 
i
, 
vÆid_íåõs
;

104 
ªåy
:

105 i‡(!
	`pblk_rb_may_wrôe_gc
(&
pblk
->
rwb
, 
gc_rq
->
£cs_to_gc
, &
bpos
)) {

106 
	`io_scheduÀ
();

107 
ªåy
;

110 
w_˘x
.
Êags
 = 
PBLK_IOTYPE_GC
;

111 
	`pblk_µa_£t_em±y
(&
w_˘x
.
µa
);

114 
	`¥ötk
("MYOCSSDÖblkcache: GC start copying valid dataÅo host write buffer.\n");

118 
i
 = 0, 
vÆid_íåõs
 = 0; i < 
gc_rq
->
ƒ_£cs
; i++) {

119 i‡(
gc_rq
->
lba_li°
[
i
] =
ADDR_EMPTY
)

122 
w_˘x
.
lba
 = 
gc_rq
->
lba_li°
[
i
];

124 
pos
 = 
	`pblk_rb_wøp_pos
(&
pblk
->
rwb
, 
bpos
 + 
vÆid_íåõs
);

125 
	`pblk_rb_wrôe_íåy_gc
(&
pblk
->
rwb
, 
d©a
, 
w_˘x
, 
gc_rq
->
löe
,

126 
gc_rq
->
∑ddr_li°
[
i
], 
pos
);

128 
	`¥ötk
("lba: %u,Öpa: %u,Üine: %d\n");

130 
d©a
 +
PBLK_EXPOSED_PAGE_SIZE
;

131 
vÆid_íåõs
++;

135 
	`¥ötk
("MYOCSSDÖblkˇche(%d): GC föish c›yög vÆid d©®which occupy %dÉ¡rõ†o‡ho° wrôêbuf„r.\n", 
vÆid_íåõs
, valid_entries);

139 
	`WARN_ONCE
(
gc_rq
->
£cs_to_gc
 !
vÆid_íåõs
,

142 
	`©omic64_add
(
vÆid_íåõs
, &
pblk
->
gc_wa
);

144 #ifde‡
CONFIG_NVM_PBLK_DEBUG


145 
	`©omic_l⁄g_add
(
vÆid_íåõs
, &
pblk
->
öÊight_wrôes
);

146 
	`©omic_l⁄g_add
(
vÆid_íåõs
, &
pblk
->
ªcov_gc_wrôes
);

149 
	`pblk_wrôe_should_kick
(
pblk
);

150  
NVM_IO_OK
;

151 
	}
}

	@pblk-core.c

20 
	#CREATE_TRACE_POINTS


	)

22 
	~"pblk.h
"

23 
	~"pblk-åa˚.h
"

25 
	$pblk_löe_m¨k_bb
(
w‹k_°ru˘
 *
w‹k
)

27 
pblk_löe_ws
 *
löe_ws
 = 
	`c⁄èöî_of
(
w‹k
, pblk_line_ws,

28 
ws
);

29 
pblk
 *pblk = 
löe_ws
->pblk;

30 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

31 
µa_addr
 *
µa
 = 
löe_ws
->
¥iv
;

32 
ªt
;

34 
ªt
 = 
	`nvm_£t_chunk_mëa
(
dev
, 
µa
, 1, 
NVM_BLK_T_GRWN_BAD
);

35 i‡(
ªt
) {

36 
pblk_löe
 *
löe
;

37 
pos
;

39 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, *
µa
);

40 
pos
 = 
	`pblk_µa_to_pos
(&
dev
->
geo
, *
µa
);

42 
	`pblk_îr
(
pblk
, "failedÅo mark bb,Üine:%d,Öos:%d\n",

43 
löe
->
id
, 
pos
);

46 
	`k‰ì
(
µa
);

47 
	`mempoﬁ_‰ì
(
löe_ws
, &
pblk
->
gí_ws_poﬁ
);

48 
	}
}

50 
	$pblk_m¨k_bb
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

51 
µa_addr
Öpa_addr)

53 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

54 
nvm_geo
 *
geo
 = &
dev
->geo;

55 
µa_addr
 *
µa
;

56 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_addr
);

58 
	`pblk_debug
(
pblk
, "îa£ faûed:Üöe:%d,Öos:%d\n", 
löe
->
id
, 
pos
);

59 
	`©omic_l⁄g_öc
(&
pblk
->
îa£_Áûed
);

61 
	`©omic_dec
(&
löe
->
blk_ö_löe
);

62 i‡(
	`ã°_™d_£t_bô
(
pos
, 
löe
->
blk_bôm≠
))

63 
	`pblk_îr
(
pblk
, "attemptedÅoÉrase bb:Üine:%d,Öos:%d\n",

64 
löe
->
id
, 
pos
);

67 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_20
)

70 
µa
 = 
	`kmÆloc
((
µa_addr
), 
GFP_ATOMIC
);

71 i‡(!
µa
)

74 *
µa
 = 
µa_addr
;

75 
	`pblk_gí_run_ws
(
pblk
, 
NULL
, 
µa
, 
pblk_löe_m¨k_bb
,

76 
GFP_ATOMIC
, 
pblk
->
bb_wq
);

77 
	}
}

79 
	$__pblk_íd_io_îa£
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

81 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

82 
nvm_geo
 *
geo
 = &
dev
->geo;

83 
nvm_chk_mëa
 *
chunk
;

84 
pblk_löe
 *
löe
;

85 
pos
;

87 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
rqd
->
µa_addr
);

88 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
rqd
->
µa_addr
);

89 
chunk
 = &
löe
->
chks
[
pos
];

91 
	`©omic_dec
(&
löe
->
À·_£blks
);

93 i‡(
rqd
->
îr‹
) {

94 
	`åa˚_pblk_chunk_ª£t
(
	`pblk_disk_«me
(
pblk
),

95 &
rqd
->
µa_addr
, 
PBLK_CHUNK_RESET_FAILED
);

97 
chunk
->
°©e
 = 
NVM_CHK_ST_OFFLINE
;

98 
	`pblk_m¨k_bb
(
pblk
, 
löe
, 
rqd
->
µa_addr
);

100 
	`åa˚_pblk_chunk_ª£t
(
	`pblk_disk_«me
(
pblk
),

101 &
rqd
->
µa_addr
, 
PBLK_CHUNK_RESET_DONE
);

103 
chunk
->
°©e
 = 
NVM_CHK_ST_FREE
;

106 
	`åa˚_pblk_chunk_°©e
(
	`pblk_disk_«me
(
pblk
), &
rqd
->
µa_addr
,

107 
chunk
->
°©e
);

109 
	`©omic_dec
(&
pblk
->
öÊight_io
);

110 
	}
}

113 
	$pblk_íd_io_îa£
(
nvm_rq
 *
rqd
)

115 
pblk
 *pblk = 
rqd
->
¥iv©e
;

117 
	`__pblk_íd_io_îa£
(
pblk
, 
rqd
);

118 
	`mempoﬁ_‰ì
(
rqd
, &
pblk
->
e_rq_poﬁ
);

119 
	}
}

126 
nvm_chk_mëa
 *
	$pblk_gë_chunk_mëa
(
pblk
 *pblk)

128 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

129 
nvm_geo
 *
geo
 = &
dev
->geo;

130 
nvm_chk_mëa
 *
mëa
;

131 
µa_addr
 
µa
;

132 
Àn
;

133 
ªt
;

135 
µa
.ppa = 0;

137 
Àn
 = 
geo
->
Æl_chunks
 * (*
mëa
);

138 
mëa
 = 
	`vzÆloc
(
Àn
);

139 i‡(!
mëa
)

140  
	`ERR_PTR
(-
ENOMEM
);

142 
ªt
 = 
	`nvm_gë_chunk_mëa
(
dev
, 
µa
, 
geo
->
Æl_chunks
, 
mëa
);

143 i‡(
ªt
) {

144 
	`v‰ì
(
mëa
);

145  
	`ERR_PTR
(-
EIO
);

148  
mëa
;

149 
	}
}

151 
nvm_chk_mëa
 *
	$pblk_chunk_gë_off
(
pblk
 *pblk,

152 
nvm_chk_mëa
 *
mëa
,

153 
µa_addr
 
µa
)

155 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

156 
nvm_geo
 *
geo
 = &
dev
->geo;

157 
ch_off
 = 
µa
.
m
.
gΩ
 * 
geo
->
num_chk
 * geo->
num_lun
;

158 
lun_off
 = 
µa
.
m
.
pu
 * 
geo
->
num_chk
;

159 
chk_off
 = 
µa
.
m
.
chk
;

161  
mëa
 + 
ch_off
 + 
lun_off
 + 
chk_off
;

162 
	}
}

164 
	$__pblk_m≠_övÆid©e
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

165 
u64
 
∑ddr
)

167 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

168 
li°_hód
 *
move_li°
 = 
NULL
;

174 
	`•ö_lock
(&
löe
->
lock
);

175 
	`WARN_ON
(
löe
->
°©e
 =
PBLK_LINESTATE_FREE
);

177 i‡(
	`ã°_™d_£t_bô
(
∑ddr
, 
löe
->
övÆid_bôm≠
)) {

178 
	`WARN_ONCE
(1, "pblk: double invalidate\n");

179 
	`•ö_u∆ock
(&
löe
->
lock
);

182 
	`À32_add_˝u
(
löe
->
vsc
, -1);

184 i‡(
löe
->
°©e
 =
PBLK_LINESTATE_CLOSED
)

185 
move_li°
 = 
	`pblk_löe_gc_li°
(
pblk
, 
löe
);

186 
	`•ö_u∆ock
(&
löe
->
lock
);

188 i‡(
move_li°
) {

189 
	`•ö_lock
(&
l_mg
->
gc_lock
);

190 
	`•ö_lock
(&
löe
->
lock
);

192 i‡(
löe
->
°©e
 =
PBLK_LINESTATE_GC
) {

193 
	`•ö_u∆ock
(&
löe
->
lock
);

194 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

197 
	`•ö_u∆ock
(&
löe
->
lock
);

199 
	`li°_move_èû
(&
löe
->
li°
, 
move_li°
);

200 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

202 
	}
}

204 
	$pblk_m≠_övÆid©e
(
pblk
 *pblk, 
µa_addr
 
µa
)

206 
pblk_löe
 *
löe
;

207 
u64
 
∑ddr
;

209 #ifde‡
CONFIG_NVM_PBLK_DEBUG


211 
	`BUG_ON
(
	`pblk_addr_ö_ˇche
(
µa
));

212 
	`BUG_ON
(
	`pblk_µa_em±y
(
µa
));

215 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
µa
);

216 
∑ddr
 = 
	`pblk_dev_µa_to_löe_addr
(
pblk
, 
µa
);

218 
	`__pblk_m≠_övÆid©e
(
pblk
, 
löe
, 
∑ddr
);

219 
	}
}

221 
	$pblk_övÆid©e_ønge
(
pblk
 *pblk, 
£˘‹_t
 
¶ba
,

222 
ƒ_£cs
)

224 
£˘‹_t
 
lba
;

226 
	`•ö_lock
(&
pblk
->
å™s_lock
);

227 
lba
 = 
¶ba
;Üb®< slb®+ 
ƒ_£cs
;Üba++) {

228 
µa_addr
 
µa
;

230 
µa
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

232 i‡(!
	`pblk_addr_ö_ˇche
(
µa
Ë&& !
	`pblk_µa_em±y
(ppa))

233 
	`pblk_m≠_övÆid©e
(
pblk
, 
µa
);

235 
	`pblk_µa_£t_em±y
(&
µa
);

236 
	`pblk_å™s_m≠_£t
(
pblk
, 
lba
, 
µa
);

238 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

239 
	}
}

241 
	$pblk_Æloc_rqd_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

243 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

245 
rqd
->
mëa_li°
 = 
	`nvm_dev_dma_Æloc
(
dev
->
∑ª¡
, 
GFP_KERNEL
,

246 &
rqd
->
dma_mëa_li°
);

247 i‡(!
rqd
->
mëa_li°
)

248  -
ENOMEM
;

250 i‡(
rqd
->
ƒ_µas
 == 1)

253 
rqd
->
µa_li°
 =Ñqd->
mëa_li°
 + 
	`pblk_dma_mëa_size
(
pblk
);

254 
rqd
->
dma_µa_li°
 =Ñqd->
dma_mëa_li°
 + 
	`pblk_dma_mëa_size
(
pblk
);

257 
	}
}

259 
	$pblk_‰ì_rqd_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

261 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

263 i‡(
rqd
->
mëa_li°
)

264 
	`nvm_dev_dma_‰ì
(
dev
->
∑ª¡
, 
rqd
->
mëa_li°
,

265 
rqd
->
dma_mëa_li°
);

266 
	}
}

269 
nvm_rq
 *
	$pblk_Æloc_rqd
(
pblk
 *pblk, 
ty≥
)

271 
mempoﬁ_t
 *
poﬁ
;

272 
nvm_rq
 *
rqd
;

273 
rq_size
;

275 
ty≥
) {

276 
PBLK_WRITE
:

277 
PBLK_WRITE_INT
:

278 
poﬁ
 = &
pblk
->
w_rq_poﬁ
;

279 
rq_size
 = 
pblk_w_rq_size
;

281 
PBLK_READ
:

282 
poﬁ
 = &
pblk
->
r_rq_poﬁ
;

283 
rq_size
 = 
pblk_g_rq_size
;

286 
poﬁ
 = &
pblk
->
e_rq_poﬁ
;

287 
rq_size
 = 
pblk_g_rq_size
;

290 
rqd
 = 
	`mempoﬁ_Æloc
(
poﬁ
, 
GFP_KERNEL
);

291 
	`mem£t
(
rqd
, 0, 
rq_size
);

293  
rqd
;

294 
	}
}

297 
	$pblk_‰ì_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
ty≥
)

299 
mempoﬁ_t
 *
poﬁ
;

301 
ty≥
) {

302 
PBLK_WRITE
:

303 
	`k‰ì
(((
pblk_c_˘x
 *)
	`nvm_rq_to_pdu
(
rqd
))->
lun_bôm≠
);

305 
PBLK_WRITE_INT
:

306 
poﬁ
 = &
pblk
->
w_rq_poﬁ
;

308 
PBLK_READ
:

309 
poﬁ
 = &
pblk
->
r_rq_poﬁ
;

311 
PBLK_ERASE
:

312 
poﬁ
 = &
pblk
->
e_rq_poﬁ
;

315 
	`pblk_îr
(
pblk
, "tryingÅo free unknownÑqdÅype\n");

319 
	`pblk_‰ì_rqd_mëa
(
pblk
, 
rqd
);

320 
	`mempoﬁ_‰ì
(
rqd
, 
poﬁ
);

321 
	}
}

323 
	$pblk_bio_‰ì_∑ges
(
pblk
 *pblk, 
bio
 *bio, 
off
,

324 
ƒ_∑ges
)

326 
bio_vec
 *
bv
;

327 
∑ge
 *page;

328 
i
, 
e
, 
nbv
 = 0;

330 
i
 = 0; i < 
bio
->
bi_v˙t
; i++) {

331 
bv
 = &
bio
->
bi_io_vec
[
i
];

332 
∑ge
 = 
bv
->
bv_∑ge
;

333 
e
 = 0;É < 
bv
->
bv_Àn
;É +
PBLK_EXPOSED_PAGE_SIZE
, 
nbv
++)

334 i‡(
nbv
 >
off
)

335 
	`mempoﬁ_‰ì
(
∑ge
++, &
pblk
->
∑ge_bio_poﬁ
);

337 
	}
}

339 
	$pblk_bio_add_∑ges
(
pblk
 *pblk, 
bio
 *bio, 
gÂ_t
 
Êags
,

340 
ƒ_∑ges
)

342 
ªque°_queue
 *
q
 = 
pblk
->
dev
->q;

343 
∑ge
 *page;

344 
i
, 
ªt
;

346 
i
 = 0; i < 
ƒ_∑ges
; i++) {

347 
∑ge
 = 
	`mempoﬁ_Æloc
(&
pblk
->
∑ge_bio_poﬁ
, 
Êags
);

349 
ªt
 = 
	`bio_add_pc_∑ge
(
q
, 
bio
, 
∑ge
, 
PBLK_EXPOSED_PAGE_SIZE
, 0);

350 i‡(
ªt
 !
PBLK_EXPOSED_PAGE_SIZE
) {

351 
	`pblk_îr
(
pblk
, "couldÇotáddÖageÅo bio\n");

352 
	`mempoﬁ_‰ì
(
∑ge
, &
pblk
->
∑ge_bio_poﬁ
);

353 
îr
;

358 
îr
:

359 
	`pblk_bio_‰ì_∑ges
(
pblk
, 
bio
, (bio->
bi_v˙t
 - 
i
), i);

361 
	}
}

363 
	$pblk_wrôe_kick
(
pblk
 *pblk)

365 
	`wake_up_¥o˚ss
(
pblk
->
wrôî_ts
);

366 
	`mod_timî
(&
pblk
->
wtimî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(1000));

367 
	}
}

369 
	$pblk_wrôe_timî_‚
(
timî_li°
 *
t
)

371 
pblk
 *pblk = 
	`‰om_timî
’blk, 
t
, 
wtimî
);

374 
	`pblk_wrôe_kick
(
pblk
);

375 
	}
}

377 
	$pblk_wrôe_should_kick
(
pblk
 *pblk)

379 
£cs_avaû
 = 
	`pblk_rb_ªad_cou¡
(&
pblk
->
rwb
);

381 i‡(
£cs_avaû
 >
pblk
->
mö_wrôe_pgs_d©a
)

382 
	`pblk_wrôe_kick
(
pblk
);

383 
	}
}

385 
	$pblk_waô_f‹_mëa
(
pblk
 *pblk)

388 i‡(!
	`©omic_ªad
(&
pblk
->
öÊight_io
))

391 
	`scheduÀ
();

393 
	}
}

395 
	$pblk_Êush_wrôî
(
pblk
 *pblk)

397 
	`pblk_rb_Êush
(&
pblk
->
rwb
);

399 i‡(!
	`pblk_rb_sync_cou¡
(&
pblk
->
rwb
))

402 
	`pblk_wrôe_kick
(
pblk
);

403 
	`scheduÀ
();

405 
	}
}

407 
li°_hód
 *
	$pblk_löe_gc_li°
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

409 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

410 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

411 
li°_hód
 *
move_li°
 = 
NULL
;

412 
∑cked_mëa
 = (
	`À32_to_˝u
(*
löe
->
vsc
Ë/ 
pblk
->
mö_wrôe_pgs_d©a
)

413 * (
pblk
->
mö_wrôe_pgs
 -Öblk->
mö_wrôe_pgs_d©a
);

414 
vsc
 = 
	`À32_to_˝u
(*
löe
->vscË+ 
∑cked_mëa
;

416 
	`lockdï_as£π_hñd
(&
löe
->
lock
);

418 i‡(
löe
->
w_îr_gc
->
has_wrôe_îr
) {

419 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_WERR
) {

420 
löe
->
gc_group
 = 
PBLK_LINEGC_WERR
;

421 
move_li°
 = &
l_mg
->
gc_wîr_li°
;

422 
	`pblk_æ_wîr_löe_ö
(&
pblk
->
æ
);

424 } i‡(!
vsc
) {

425 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_FULL
) {

426 
löe
->
gc_group
 = 
PBLK_LINEGC_FULL
;

427 
move_li°
 = &
l_mg
->
gc_fuŒ_li°
;

429 } i‡(
vsc
 < 
lm
->
high_thrs
) {

430 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_HIGH
) {

431 
löe
->
gc_group
 = 
PBLK_LINEGC_HIGH
;

432 
move_li°
 = &
l_mg
->
gc_high_li°
;

434 } i‡(
vsc
 < 
lm
->
mid_thrs
) {

435 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_MID
) {

436 
löe
->
gc_group
 = 
PBLK_LINEGC_MID
;

437 
move_li°
 = &
l_mg
->
gc_mid_li°
;

439 } i‡(
vsc
 < 
löe
->
£c_ö_löe
) {

440 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_LOW
) {

441 
löe
->
gc_group
 = 
PBLK_LINEGC_LOW
;

442 
move_li°
 = &
l_mg
->
gc_low_li°
;

444 } i‡(
vsc
 =
löe
->
£c_ö_löe
) {

445 i‡(
löe
->
gc_group
 !
PBLK_LINEGC_EMPTY
) {

446 
löe
->
gc_group
 = 
PBLK_LINEGC_EMPTY
;

447 
move_li°
 = &
l_mg
->
gc_em±y_li°
;

450 
löe
->
°©e
 = 
PBLK_LINESTATE_CORRUPT
;

451 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

452 
löe
->
°©e
);

454 
löe
->
gc_group
 = 
PBLK_LINEGC_NONE
;

455 
move_li°
 = &
l_mg
->
c‹ru±_li°
;

456 
	`pblk_îr
(
pblk
, "corrupted vsc forÜine %d, vsc:%d (%d/%d/%d)\n",

457 
löe
->
id
, 
vsc
,

458 
löe
->
£c_ö_löe
,

459 
lm
->
high_thrs
,Üm->
mid_thrs
);

462  
move_li°
;

463 
	}
}

465 
	$pblk_disˇrd
(
pblk
 *pblk, 
bio
 *bio)

467 
£˘‹_t
 
¶ba
 = 
	`pblk_gë_lba
(
bio
);

468 
£˘‹_t
 
ƒ_£cs
 = 
	`pblk_gë_£cs
(
bio
);

470 
	`pblk_övÆid©e_ønge
(
pblk
, 
¶ba
, 
ƒ_£cs
);

471 
	}
}

473 
	$pblk_log_wrôe_îr
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

475 
	`©omic_l⁄g_öc
(&
pblk
->
wrôe_Áûed
);

476 #ifde‡
CONFIG_NVM_PBLK_DEBUG


477 
	`pblk_¥öt_Áûed_rqd
(
pblk
, 
rqd
,Ñqd->
îr‹
);

479 
	}
}

481 
	$pblk_log_ªad_îr
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

484 i‡(
rqd
->
îr‹
 =
NVM_RSP_ERR_EMPTYPAGE
) {

485 
	`©omic_l⁄g_öc
(&
pblk
->
ªad_em±y
);

489 
rqd
->
îr‹
) {

490 
NVM_RSP_WARN_HIGHECC
:

491 
	`©omic_l⁄g_öc
(&
pblk
->
ªad_high_ecc
);

493 
NVM_RSP_ERR_FAILECC
:

494 
NVM_RSP_ERR_FAILCRC
:

495 
	`©omic_l⁄g_öc
(&
pblk
->
ªad_Áûed
);

498 
	`pblk_îr
(
pblk
, "unknow¿ªadÉº‹:%d\n", 
rqd
->
îr‹
);

500 #ifde‡
CONFIG_NVM_PBLK_DEBUG


501 
	`pblk_¥öt_Áûed_rqd
(
pblk
, 
rqd
,Ñqd->
îr‹
);

503 
	}
}

505 
	$pblk_£t_£c_≥r_wrôe
(
pblk
 *pblk, 
£c_≥r_wrôe
)

507 
pblk
->
£c_≥r_wrôe
 = sec_per_write;

508 
	}
}

510 
	$pblk_submô_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, *
buf
)

512 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

514 
	`©omic_öc
(&
pblk
->
öÊight_io
);

516 #ifde‡
CONFIG_NVM_PBLK_DEBUG


517 i‡(
	`pblk_check_io
(
pblk
, 
rqd
))

518  
NVM_IO_ERR
;

521  
	`nvm_submô_io
(
dev
, 
rqd
, 
buf
);

522 
	}
}

524 
	$pblk_check_chunk_°©e_upd©e
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

526 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

528 
i
;

530 
i
 = 0; i < 
rqd
->
ƒ_µas
; i++) {

531 
µa_addr
 *
µa
 = &
µa_li°
[
i
];

532 
nvm_chk_mëa
 *
chunk
 = 
	`pblk_dev_µa_to_chunk
(
pblk
, *
µa
);

533 
u64
 
ˇddr
 = 
	`pblk_dev_µa_to_chunk_addr
(
pblk
, *
µa
);

535 i‡(
ˇddr
 == 0)

536 
	`åa˚_pblk_chunk_°©e
(
	`pblk_disk_«me
(
pblk
),

537 
µa
, 
NVM_CHK_ST_OPEN
);

538 i‡(
ˇddr
 =(
chunk
->
˙lb
 - 1))

539 
	`åa˚_pblk_chunk_°©e
(
	`pblk_disk_«me
(
pblk
),

540 
µa
, 
NVM_CHK_ST_CLOSED
);

542 
	}
}

544 
	$pblk_submô_io_sync
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, *
buf
)

546 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

547 
ªt
;

549 
	`©omic_öc
(&
pblk
->
öÊight_io
);

551 #ifde‡
CONFIG_NVM_PBLK_DEBUG


552 i‡(
	`pblk_check_io
(
pblk
, 
rqd
))

553  
NVM_IO_ERR
;

556 
ªt
 = 
	`nvm_submô_io_sync
(
dev
, 
rqd
, 
buf
);

558 i‡(
	`åa˚_pblk_chunk_°©e_íabÀd
(Ë&& !
ªt
 &&

559 
rqd
->
›code
 =
NVM_OP_PWRITE
)

560 
	`pblk_check_chunk_°©e_upd©e
(
pblk
, 
rqd
);

562  
ªt
;

563 
	}
}

565 
	$pblk_submô_io_sync_£m
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

566 *
buf
)

568 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

569 
ªt
;

571 
	`pblk_down_chunk
(
pblk
, 
µa_li°
[0]);

572 
ªt
 = 
	`pblk_submô_io_sync
(
pblk
, 
rqd
, 
buf
);

573 
	`pblk_up_chunk
(
pblk
, 
µa_li°
[0]);

575  
ªt
;

576 
	}
}

578 
	$pblk_ˇlc_£cs
(
pblk
 *pblk, 
£cs_avaû
,

579 
£cs_to_Êush
, 
boﬁ
 
skù_mëa
)

581 
max
 = 
pblk
->
£c_≥r_wrôe
;

582 
mö
 = 
pblk
->
mö_wrôe_pgs
;

583 
£cs_to_sync
 = 0;

585 i‡(
skù_mëa
 && 
pblk
->
mö_wrôe_pgs_d©a
 !pblk->
mö_wrôe_pgs
)

586 
mö
 = 
max
 = 
pblk
->
mö_wrôe_pgs_d©a
;

588 i‡(
£cs_avaû
 >
max
)

589 
£cs_to_sync
 = 
max
;

590 i‡(
£cs_avaû
 >
mö
)

591 
£cs_to_sync
 = 
mö
 * (
£cs_avaû
 / min);

592 i‡(
£cs_to_Êush
)

593 
£cs_to_sync
 = 
mö
;

595  
£cs_to_sync
;

596 
	}
}

598 
	$pblk_dóŒoc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
)

600 
u64
 
addr
;

601 
i
;

603 
	`•ö_lock
(&
löe
->
lock
);

604 
addr
 = 
	`föd_√xt_zîo_bô
(
löe
->
m≠_bôm≠
,

605 
pblk
->
lm
.
£c_≥r_löe
, 
löe
->
cur_£c
);

606 
löe
->
cur_£c
 = 
addr
 - 
ƒ_£cs
;

608 
i
 = 0; i < 
ƒ_£cs
; i++, 
löe
->
cur_£c
--)

609 
	`WARN_ON
(!
	`ã°_™d_˛ór_bô
(
löe
->
cur_£c
,Üöe->
m≠_bôm≠
));

610 
	`•ö_u∆ock
(&
löe
->
lock
);

611 
	}
}

613 
u64
 
	$__pblk_Æloc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
)

615 
u64
 
addr
;

616 
i
;

618 
	`lockdï_as£π_hñd
(&
löe
->
lock
);

621 i‡(
löe
->
cur_£c
 + 
ƒ_£cs
 > 
pblk
->
lm
.
£c_≥r_löe
) {

622 
	`WARN
(1, "pblk:Öageállocation out of bounds\n");

623 
ƒ_£cs
 = 
pblk
->
lm
.
£c_≥r_löe
 - 
löe
->
cur_£c
;

626 
löe
->
cur_£c
 = 
addr
 = 
	`föd_√xt_zîo_bô
÷öe->
m≠_bôm≠
,

627 
pblk
->
lm
.
£c_≥r_löe
, 
löe
->
cur_£c
);

628 
i
 = 0; i < 
ƒ_£cs
; i++, 
löe
->
cur_£c
++)

629 
	`WARN_ON
(
	`ã°_™d_£t_bô
(
löe
->
cur_£c
,Üöe->
m≠_bôm≠
));

631  
addr
;

632 
	}
}

634 
u64
 
	$pblk_Æloc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
)

636 
u64
 
addr
;

641 
	`•ö_lock
(&
löe
->
lock
);

642 
addr
 = 
	`__pblk_Æloc_∑ge
(
pblk
, 
löe
, 
ƒ_£cs
);

643 
löe
->
À·_m£cs
 -
ƒ_£cs
;

644 
	`WARN
(
löe
->
À·_m£cs
 < 0, "pblk:Öageállocation out of bounds\n");

645 
	`•ö_u∆ock
(&
löe
->
lock
);

647  
addr
;

648 
	}
}

650 
u64
 
	$pblk_lookup_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

652 
u64
 
∑ddr
;

654 
	`•ö_lock
(&
löe
->
lock
);

655 
∑ddr
 = 
	`föd_√xt_zîo_bô
(
löe
->
m≠_bôm≠
,

656 
pblk
->
lm
.
£c_≥r_löe
, 
löe
->
cur_£c
);

657 
	`•ö_u∆ock
(&
löe
->
lock
);

659  
∑ddr
;

660 
	}
}

662 
u64
 
	$pblk_löe_smëa_°¨t
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

664 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

665 
nvm_geo
 *
geo
 = &
dev
->geo;

666 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

667 
bô
;

670 
bô
 = 
	`föd_fú°_zîo_bô
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

671 i‡(
bô
 >
lm
->
blk_≥r_löe
)

674  
bô
 * 
geo
->
ws_›t
;

675 
	}
}

677 
	$pblk_löe_smëa_ªad
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

679 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

680 
µa_addr
 *
µa_li°
;

681 
nvm_rq
 
rqd
;

682 
u64
 
∑ddr
 = 
	`pblk_löe_smëa_°¨t
(
pblk
, 
löe
);

683 
i
, 
ªt
;

685 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

687 
ªt
 = 
	`pblk_Æloc_rqd_mëa
(
pblk
, &
rqd
);

688 i‡(
ªt
)

689  
ªt
;

691 
rqd
.
›code
 = 
NVM_OP_PREAD
;

692 
rqd
.
ƒ_µas
 = 
lm
->
smëa_£c
;

693 
rqd
.
is_£q
 = 1;

694 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(&
rqd
);

696 
i
 = 0; i < 
lm
->
smëa_£c
; i++, 
∑ddr
++)

697 
µa_li°
[
i
] = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe
->
id
);

699 
ªt
 = 
	`pblk_submô_io_sync
(
pblk
, &
rqd
, 
löe
->
smëa
);

700 i‡(
ªt
) {

701 
	`pblk_îr
(
pblk
, "smë®I/O submissi⁄ faûed: %d\n", 
ªt
);

702 
˛ór_rqd
;

705 
	`©omic_dec
(&
pblk
->
öÊight_io
);

707 i‡(
rqd
.
îr‹
 &&Ñqd.îr‹ !
NVM_RSP_WARN_HIGHECC
) {

708 
	`pblk_log_ªad_îr
(
pblk
, &
rqd
);

709 
ªt
 = -
EIO
;

712 
˛ór_rqd
:

713 
	`pblk_‰ì_rqd_mëa
(
pblk
, &
rqd
);

714  
ªt
;

715 
	}
}

717 
	$pblk_löe_smëa_wrôe
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

718 
u64
 
∑ddr
)

720 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

721 
µa_addr
 *
µa_li°
;

722 
nvm_rq
 
rqd
;

723 
__À64
 *
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
löe
->
emëa
->
buf
);

724 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

725 
i
, 
ªt
;

727 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

729 
ªt
 = 
	`pblk_Æloc_rqd_mëa
(
pblk
, &
rqd
);

730 i‡(
ªt
)

731  
ªt
;

733 
rqd
.
›code
 = 
NVM_OP_PWRITE
;

734 
rqd
.
ƒ_µas
 = 
lm
->
smëa_£c
;

735 
rqd
.
is_£q
 = 1;

736 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(&
rqd
);

738 
i
 = 0; i < 
lm
->
smëa_£c
; i++, 
∑ddr
++) {

739 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
,

740 
rqd
.
mëa_li°
, 
i
);

742 
µa_li°
[
i
] = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe
->
id
);

743 
mëa
->
lba
 = 
lba_li°
[
∑ddr
] = 
addr_em±y
;

746 
ªt
 = 
	`pblk_submô_io_sync_£m
(
pblk
, &
rqd
, 
löe
->
smëa
);

747 i‡(
ªt
) {

748 
	`pblk_îr
(
pblk
, "smë®I/O submissi⁄ faûed: %d\n", 
ªt
);

749 
˛ór_rqd
;

752 
	`©omic_dec
(&
pblk
->
öÊight_io
);

754 i‡(
rqd
.
îr‹
) {

755 
	`pblk_log_wrôe_îr
(
pblk
, &
rqd
);

756 
ªt
 = -
EIO
;

759 
˛ór_rqd
:

760 
	`pblk_‰ì_rqd_mëa
(
pblk
, &
rqd
);

761  
ªt
;

762 
	}
}

764 
	$pblk_löe_emëa_ªad
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

765 *
emëa_buf
)

767 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

768 
nvm_geo
 *
geo
 = &
dev
->geo;

769 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

770 *
µa_li°_buf
, *
mëa_li°
;

771 
µa_addr
 *
µa_li°
;

772 
nvm_rq
 
rqd
;

773 
u64
 
∑ddr
 = 
löe
->
emëa_s£c
;

774 
dma_addr_t
 
dma_µa_li°
, 
dma_mëa_li°
;

775 
mö
 = 
pblk
->
mö_wrôe_pgs
;

776 
À·_µas
 = 
lm
->
emëa_£c
[0];

777 
löe_id
 = 
löe
->
id
;

778 
rq_µas
, 
rq_Àn
;

779 
i
, 
j
;

780 
ªt
;

782 
mëa_li°
 = 
	`nvm_dev_dma_Æloc
(
dev
->
∑ª¡
, 
GFP_KERNEL
,

783 &
dma_mëa_li°
);

784 i‡(!
mëa_li°
)

785  -
ENOMEM
;

787 
µa_li°_buf
 = 
mëa_li°
 + 
	`pblk_dma_mëa_size
(
pblk
);

788 
dma_µa_li°
 = 
dma_mëa_li°
 + 
	`pblk_dma_mëa_size
(
pblk
);

790 
√xt_rq
:

791 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

793 
rq_µas
 = 
	`pblk_ˇlc_£cs
(
pblk
, 
À·_µas
, 0, 
Ál£
);

794 
rq_Àn
 = 
rq_µas
 * 
geo
->
c£cs
;

796 
rqd
.
mëa_li°
 = meta_list;

797 
rqd
.
µa_li°
 = 
µa_li°_buf
;

798 
rqd
.
dma_mëa_li°
 = dma_meta_list;

799 
rqd
.
dma_µa_li°
 = dma_ppa_list;

800 
rqd
.
›code
 = 
NVM_OP_PREAD
;

801 
rqd
.
ƒ_µas
 = 
rq_µas
;

802 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(&
rqd
);

804 
i
 = 0; i < 
rqd
.
ƒ_µas
; ) {

805 
µa_addr
 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe_id
);

806 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

808 i‡(
	`pblk_io_Æig√d
(
pblk
, 
rq_µas
))

809 
rqd
.
is_£q
 = 1;

811 
	`ã°_bô
(
pos
, 
löe
->
blk_bôm≠
)) {

812 
∑ddr
 +
mö
;

813 i‡(
	`pblk_bound¨y_∑ddr_checks
(
pblk
, 
∑ddr
)) {

814 
ªt
 = -
EINTR
;

815 
‰ì_rqd_dma
;

818 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe_id
);

819 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

822 i‡(
	`pblk_bound¨y_∑ddr_checks
(
pblk
, 
∑ddr
 + 
mö
)) {

823 
ªt
 = -
EINTR
;

824 
‰ì_rqd_dma
;

827 
j
 = 0; j < 
mö
; j++, 
i
++, 
∑ddr
++)

828 
µa_li°
[
i
] = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe_id
);

831 
ªt
 = 
	`pblk_submô_io_sync
(
pblk
, &
rqd
, 
emëa_buf
);

832 i‡(
ªt
) {

833 
	`pblk_îr
(
pblk
, "emë®I/O submissi⁄ faûed: %d\n", 
ªt
);

834 
‰ì_rqd_dma
;

837 
	`©omic_dec
(&
pblk
->
öÊight_io
);

839 i‡(
rqd
.
îr‹
 &&Ñqd.îr‹ !
NVM_RSP_WARN_HIGHECC
) {

840 
	`pblk_log_ªad_îr
(
pblk
, &
rqd
);

841 
ªt
 = -
EIO
;

842 
‰ì_rqd_dma
;

845 
emëa_buf
 +
rq_Àn
;

846 
À·_µas
 -
rq_µas
;

847 i‡(
À·_µas
)

848 
√xt_rq
;

850 
‰ì_rqd_dma
:

851 
	`nvm_dev_dma_‰ì
(
dev
->
∑ª¡
, 
rqd
.
mëa_li°
,Ñqd.
dma_mëa_li°
);

852  
ªt
;

853 
	}
}

855 
	$pblk_£tup_e_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

856 
µa_addr
 
µa
)

858 
rqd
->
›code
 = 
NVM_OP_ERASE
;

859 
rqd
->
µa_addr
 = 
µa
;

860 
rqd
->
ƒ_µas
 = 1;

861 
rqd
->
is_£q
 = 1;

862 
rqd
->
bio
 = 
NULL
;

863 
	}
}

865 
	$pblk_blk_îa£_sync
(
pblk
 *pblk, 
µa_addr
 
µa
)

867 
nvm_rq
 
rqd
 = {
NULL
};

868 
ªt
;

870 
	`åa˚_pblk_chunk_ª£t
(
	`pblk_disk_«me
(
pblk
), &
µa
,

871 
PBLK_CHUNK_RESET_START
);

873 
	`pblk_£tup_e_rq
(
pblk
, &
rqd
, 
µa
);

878 
ªt
 = 
	`pblk_submô_io_sync
(
pblk
, &
rqd
, 
NULL
);

879 
rqd
.
¥iv©e
 = 
pblk
;

880 
	`__pblk_íd_io_îa£
(
pblk
, &
rqd
);

882  
ªt
;

883 
	}
}

885 
	$pblk_löe_îa£
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

887 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

888 
µa_addr
 
µa
;

889 
ªt
, 
bô
 = -1;

893 
	`•ö_lock
(&
löe
->
lock
);

894 
bô
 = 
	`föd_√xt_zîo_bô
(
löe
->
îa£_bôm≠
, 
lm
->
blk_≥r_löe
,

895 
bô
 + 1);

896 i‡(
bô
 >
lm
->
blk_≥r_löe
) {

897 
	`•ö_u∆ock
(&
löe
->
lock
);

901 
µa
 = 
pblk
->
luns
[
bô
].
bµa
;

902 
µa
.
a
.
blk
 = 
löe
->
id
;

904 
	`©omic_dec
(&
löe
->
À·_eblks
);

905 
	`WARN_ON
(
	`ã°_™d_£t_bô
(
bô
, 
löe
->
îa£_bôm≠
));

906 
	`•ö_u∆ock
(&
löe
->
lock
);

908 
ªt
 = 
	`pblk_blk_îa£_sync
(
pblk
, 
µa
);

909 i‡(
ªt
) {

910 
	`pblk_îr
(
pblk
, "ÁûedÅÿîa£Üöê%d\n", 
löe
->
id
);

911  
ªt
;

916 
	}
}

918 
	$pblk_löe_£tup_mëad©a
(
pblk_löe
 *
löe
,

919 
pblk_löe_mgmt
 *
l_mg
,

920 
pblk_löe_mëa
 *
lm
)

922 
mëa_löe
;

924 
	`lockdï_as£π_hñd
(&
l_mg
->
‰ì_lock
);

926 
ªåy_mëa
:

927 
mëa_löe
 = 
	`föd_fú°_zîo_bô
(&
l_mg
->
mëa_bôm≠
, 
PBLK_DATA_LINES
);

928 i‡(
mëa_löe
 =
PBLK_DATA_LINES
) {

929 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

930 
	`io_scheduÀ
();

931 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

932 
ªåy_mëa
;

935 
	`£t_bô
(
mëa_löe
, &
l_mg
->
mëa_bôm≠
);

936 
löe
->
mëa_löe
 = meta_line;

938 
löe
->
smëa
 = 
l_mg
->
¶öe_mëa
[
mëa_löe
];

939 
löe
->
emëa
 = 
l_mg
->
ñöe_mëa
[
mëa_löe
];

941 
	`mem£t
(
löe
->
smëa
, 0, 
lm
->
smëa_Àn
);

942 
	`mem£t
(
löe
->
emëa
->
buf
, 0, 
lm
->
emëa_Àn
[0]);

944 
löe
->
emëa
->
mem
 = 0;

945 
	`©omic_£t
(&
löe
->
emëa
->
sync
, 0);

946 
	}
}

951 
	$pblk_löe_öô_mëad©a
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

952 
pblk_löe
 *
cur
)

954 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

955 
nvm_geo
 *
geo
 = &
dev
->geo;

956 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

957 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

958 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

959 
löe_emëa
 *
emëa_buf
 = 
emëa
->
buf
;

960 
löe_smëa
 *
smëa_buf
 = (löe_smë®*)
löe
->
smëa
;

961 
ƒ_blk_löe
;

966 
ƒ_blk_löe
 = 
lm
->
blk_≥r_löe
 -

967 
	`bôm≠_weight
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

968 i‡(
ƒ_blk_löe
 < 
lm
->
mö_blk_löe
) {

969 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

970 
	`•ö_lock
(&
löe
->
lock
);

971 
löe
->
°©e
 = 
PBLK_LINESTATE_BAD
;

972 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

973 
löe
->
°©e
);

974 
	`•ö_u∆ock
(&
löe
->
lock
);

976 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
bad_li°
);

977 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

979 
	`pblk_debug
(
pblk
, "löê%d i†bad\n", 
löe
->
id
);

985 
löe
->
lun_bôm≠
 = ((*)(
smëa_buf
)Ë+ (
löe_smëa
);

988 
	`bôm≠_£t
(
löe
->
lun_bôm≠
, 0, 
lm
->
lun_bôm≠_Àn
);

990 
smëa_buf
->
hódî
.
idítifõr
 = 
	`˝u_to_À32
(
PBLK_MAGIC
);

991 
	`guid_c›y
((
guid_t
 *)&
smëa_buf
->
hódî
.
uuid
, &
pblk
->
ö°™˚_uuid
);

992 
smëa_buf
->
hódî
.
id
 = 
	`˝u_to_À32
(
löe
->id);

993 
smëa_buf
->
hódî
.
ty≥
 = 
	`˝u_to_À16
(
löe
->type);

994 
smëa_buf
->
hódî
.
vîsi⁄_maj‹
 = 
SMETA_VERSION_MAJOR
;

995 
smëa_buf
->
hódî
.
vîsi⁄_mö‹
 = 
SMETA_VERSION_MINOR
;

998 
smëa_buf
->
£q_ƒ
 = 
	`˝u_to_À64
(
löe
->seq_nr);

999 
smëa_buf
->
wödow_wr_lun
 = 
	`˝u_to_À32
(
geo
->
Æl_luns
);

1002 i‡(
cur
) {

1003 
	`mem˝y
(
löe
->
lun_bôm≠
, 
cur
->lun_bôm≠, 
lm
->
lun_bôm≠_Àn
);

1004 
smëa_buf
->
¥ev_id
 = 
	`˝u_to_À32
(
cur
->
id
);

1005 
cur
->
emëa
->
buf
->
√xt_id
 = 
	`˝u_to_À32
(
löe
->
id
);

1007 
smëa_buf
->
¥ev_id
 = 
	`˝u_to_À32
(
PBLK_LINE_EMPTY
);

1011 
smëa_buf
->
hódî
.
¸c
 = 
	`˝u_to_À32
(

1012 
	`pblk_ˇlc_mëa_hódî_¸c
(
pblk
, &
smëa_buf
->
hódî
));

1013 
smëa_buf
->
¸c
 = 
	`˝u_to_À32
(
	`pblk_ˇlc_smëa_¸c
(
pblk
, smeta_buf));

1016 
	`mem˝y
(&
emëa_buf
->
hódî
, &
smëa_buf
->header,

1017 (
löe_hódî
));

1019 
emëa_buf
->
hódî
.
vîsi⁄_maj‹
 = 
EMETA_VERSION_MAJOR
;

1020 
emëa_buf
->
hódî
.
vîsi⁄_mö‹
 = 
EMETA_VERSION_MINOR
;

1021 
emëa_buf
->
hódî
.
¸c
 = 
	`˝u_to_À32
(

1022 
	`pblk_ˇlc_mëa_hódî_¸c
(
pblk
, &
emëa_buf
->
hódî
));

1024 
emëa_buf
->
£q_ƒ
 = 
	`˝u_to_À64
(
löe
->seq_nr);

1025 
emëa_buf
->
ƒ_lbas
 = 
	`˝u_to_À64
(
löe
->
£c_ö_löe
);

1026 
emëa_buf
->
ƒ_vÆid_lbas
 = 
	`˝u_to_À64
(0);

1027 
emëa_buf
->
√xt_id
 = 
	`˝u_to_À32
(
PBLK_LINE_EMPTY
);

1028 
emëa_buf
->
¸c
 = 
	`˝u_to_À32
(0);

1029 
emëa_buf
->
¥ev_id
 = 
smëa_buf
->prev_id;

1032 
	}
}

1034 
	$pblk_löe_Æloc_bôm≠s
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1036 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1037 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1039 
löe
->
m≠_bôm≠
 = 
	`mempoﬁ_Æloc
(
l_mg
->
bôm≠_poﬁ
, 
GFP_KERNEL
);

1040 i‡(!
löe
->
m≠_bôm≠
)

1041  -
ENOMEM
;

1043 
	`mem£t
(
löe
->
m≠_bôm≠
, 0, 
lm
->
£c_bôm≠_Àn
);

1046 
löe
->
övÆid_bôm≠
 = 
	`mempoﬁ_Æloc
(
l_mg
->
bôm≠_poﬁ
, 
GFP_KERNEL
);

1047 i‡(!
löe
->
övÆid_bôm≠
) {

1048 
	`mempoﬁ_‰ì
(
löe
->
m≠_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

1049 
löe
->
m≠_bôm≠
 = 
NULL
;

1050  -
ENOMEM
;

1054 
	}
}

1059 
	$pblk_löe_öô_bb
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

1060 
öô
)

1062 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1063 
nvm_geo
 *
geo
 = &
dev
->geo;

1064 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1065 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1066 
u64
 
off
;

1067 
bô
 = -1;

1068 
emëa_£cs
;

1070 
löe
->
£c_ö_löe
 = 
lm
->
£c_≥r_löe
;

1073 (
bô
 = 
	`föd_√xt_bô
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
,

1074 
bô
 + 1)Ë< 
lm
->
blk_≥r_löe
) {

1075 
off
 = 
bô
 * 
geo
->
ws_›t
;

1076 
	`bôm≠_shi·_À·
(
l_mg
->
bb_aux
,Ü_mg->
bb_ãm∂©e
, 
off
,

1077 
lm
->
£c_≥r_löe
);

1078 
	`bôm≠_‹
(
löe
->
m≠_bôm≠
,Üöe->m≠_bôm≠, 
l_mg
->
bb_aux
,

1079 
lm
->
£c_≥r_löe
);

1080 
löe
->
£c_ö_löe
 -
geo
->
˛ba
;

1084 
bô
 = 
	`föd_fú°_zîo_bô
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

1085 
off
 = 
bô
 * 
geo
->
ws_›t
;

1086 
	`bôm≠_£t
(
löe
->
m≠_bôm≠
, 
off
, 
lm
->
smëa_£c
);

1087 
löe
->
£c_ö_löe
 -
lm
->
smëa_£c
;

1088 
löe
->
cur_£c
 = 
off
 + 
lm
->
smëa_£c
;

1090 i‡(
öô
 && 
	`pblk_löe_smëa_wrôe
(
pblk
, 
löe
, 
off
)) {

1091 
	`pblk_debug
(
pblk
, "line smeta I/O failed. Retry\n");

1095 
	`bôm≠_c›y
(
löe
->
övÆid_bôm≠
,Üöe->
m≠_bôm≠
, 
lm
->
£c_≥r_löe
);

1100 
emëa_£cs
 = 
lm
->
emëa_£c
[0];

1101 
off
 = 
lm
->
£c_≥r_löe
;

1102 
emëa_£cs
) {

1103 
off
 -
geo
->
ws_›t
;

1104 i‡(!
	`ã°_bô
(
off
, 
löe
->
övÆid_bôm≠
)) {

1105 
	`bôm≠_£t
(
löe
->
övÆid_bôm≠
, 
off
, 
geo
->
ws_›t
);

1106 
emëa_£cs
 -
geo
->
ws_›t
;

1110 
löe
->
emëa_s£c
 = 
off
;

1111 
löe
->
£c_ö_löe
 -
lm
->
emëa_£c
[0];

1112 
löe
->
ƒ_vÆid_lbas
 = 0;

1113 
löe
->
À·_m£cs
 =Üöe->
£c_ö_löe
;

1114 *
löe
->
vsc
 = 
	`˝u_to_À32
÷öe->
£c_ö_löe
);

1116 i‡(
lm
->
£c_≥r_löe
 - 
löe
->
£c_ö_löe
 !=

1117 
	`bôm≠_weight
(
löe
->
övÆid_bôm≠
, 
lm
->
£c_≥r_löe
)) {

1118 
	`•ö_lock
(&
löe
->
lock
);

1119 
löe
->
°©e
 = 
PBLK_LINESTATE_BAD
;

1120 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1121 
löe
->
°©e
);

1122 
	`•ö_u∆ock
(&
löe
->
lock
);

1124 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
bad_li°
);

1125 
	`pblk_îr
(
pblk
, "u√x≥˘edÜöê%d i†bad\n", 
löe
->
id
);

1131 
	}
}

1133 
	$pblk_¥ï¨e_√w_löe
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1135 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1136 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1137 
nvm_geo
 *
geo
 = &
dev
->geo;

1138 
blk_to_îa£
 = 
	`©omic_ªad
(&
löe
->
blk_ö_löe
);

1139 
i
;

1141 
i
 = 0; i < 
lm
->
blk_≥r_löe
; i++) {

1142 
pblk_lun
 *
æun
 = &
pblk
->
luns
[
i
];

1143 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
æun
->
bµa
);

1144 
°©e
 = 
löe
->
chks
[
pos
].state;

1147 i‡(
°©e
 & 
NVM_CHK_ST_FREE
) {

1148 
	`£t_bô
(
	`pblk_µa_to_pos
(
geo
, 
æun
->
bµa
),

1149 
löe
->
îa£_bôm≠
);

1150 
blk_to_îa£
--;

1154  
blk_to_îa£
;

1155 
	}
}

1157 
	$pblk_löe_¥ï¨e
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1159 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1160 
blk_ö_löe
 = 
	`©omic_ªad
(&
löe
->blk_in_line);

1161 
blk_to_îa£
;

1164 
	`bôm≠_c›y
(
löe
->
îa£_bôm≠
,Üöe->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

1166 
	`•ö_lock
(&
löe
->
lock
);

1171 i‡(
löe
->
°©e
 =
PBLK_LINESTATE_NEW
) {

1172 
blk_to_îa£
 = 
	`pblk_¥ï¨e_√w_löe
(
pblk
, 
löe
);

1173 
löe
->
°©e
 = 
PBLK_LINESTATE_FREE
;

1174 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1175 
löe
->
°©e
);

1177 
blk_to_îa£
 = 
blk_ö_löe
;

1180 i‡(
blk_ö_löe
 < 
lm
->
mö_blk_löe
) {

1181 
	`•ö_u∆ock
(&
löe
->
lock
);

1182  -
EAGAIN
;

1185 i‡(
löe
->
°©e
 !
PBLK_LINESTATE_FREE
) {

1186 
	`WARN
(1, "pblk: corruptedÜine %d, state %d\n",

1187 
löe
->
id
,Üöe->
°©e
);

1188 
	`•ö_u∆ock
(&
löe
->
lock
);

1189  -
EINTR
;

1192 
löe
->
°©e
 = 
PBLK_LINESTATE_OPEN
;

1193 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1194 
löe
->
°©e
);

1196 
	`©omic_£t
(&
löe
->
À·_eblks
, 
blk_to_îa£
);

1197 
	`©omic_£t
(&
löe
->
À·_£blks
, 
blk_to_îa£
);

1199 
löe
->
mëa_di°™˚
 = 
lm
->meta_distance;

1200 
	`•ö_u∆ock
(&
löe
->
lock
);

1202 
	`kªf_öô
(&
löe
->
ªf
);

1203 
	`©omic_£t
(&
löe
->
£c_to_upd©e
, 0);

1206 
	}
}

1209 
	$pblk_löe_ªcov_Æloc
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1211 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1212 
ªt
;

1214 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1215 
l_mg
->
d©a_löe
 = 
löe
;

1216 
	`li°_dñ
(&
löe
->
li°
);

1218 
ªt
 = 
	`pblk_löe_¥ï¨e
(
pblk
, 
löe
);

1219 i‡(
ªt
) {

1220 
	`li°_add
(&
löe
->
li°
, &
l_mg
->
‰ì_li°
);

1221 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1222  
ªt
;

1224 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1226 
ªt
 = 
	`pblk_löe_Æloc_bôm≠s
(
pblk
, 
löe
);

1227 i‡(
ªt
)

1228 
Áû
;

1230 i‡(!
	`pblk_löe_öô_bb
(
pblk
, 
löe
, 0)) {

1231 
ªt
 = -
EINTR
;

1232 
Áû
;

1235 
	`pblk_æ_‰ì_löes_dec
(&
pblk
->
æ
, 
löe
, 
åue
);

1238 
Áû
:

1239 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1240 
	`li°_add
(&
löe
->
li°
, &
l_mg
->
‰ì_li°
);

1241 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1243  
ªt
;

1244 
	}
}

1246 
	$pblk_löe_ªcov_˛o£
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1248 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1250 
	`mempoﬁ_‰ì
(
löe
->
m≠_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

1251 
löe
->
m≠_bôm≠
 = 
NULL
;

1252 
löe
->
smëa
 = 
NULL
;

1253 
löe
->
emëa
 = 
NULL
;

1254 
	}
}

1256 
	$pblk_löe_ªöô
(
pblk_löe
 *
löe
)

1258 *
löe
->
vsc
 = 
	`˝u_to_À32
(
EMPTY_ENTRY
);

1260 
löe
->
m≠_bôm≠
 = 
NULL
;

1261 
löe
->
övÆid_bôm≠
 = 
NULL
;

1262 
löe
->
smëa
 = 
NULL
;

1263 
löe
->
emëa
 = 
NULL
;

1264 
	}
}

1266 
	$pblk_löe_‰ì
(
pblk_löe
 *
löe
)

1268 
pblk
 *pblk = 
löe
->pblk;

1269 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1271 
	`mempoﬁ_‰ì
(
löe
->
m≠_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

1272 
	`mempoﬁ_‰ì
(
löe
->
övÆid_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

1274 
	`pblk_löe_ªöô
(
löe
);

1275 
	}
}

1277 
pblk_löe
 *
	$pblk_löe_gë
(
pblk
 *pblk)

1279 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1280 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1281 
pblk_löe
 *
löe
;

1282 
ªt
, 
bô
;

1284 
	`lockdï_as£π_hñd
(&
l_mg
->
‰ì_lock
);

1286 
ªåy
:

1287 i‡(
	`li°_em±y
(&
l_mg
->
‰ì_li°
)) {

1288 
	`pblk_îr
(
pblk
, "no freeÜines\n");

1289  
NULL
;

1292 
löe
 = 
	`li°_fú°_íåy
(&
l_mg
->
‰ì_li°
, 
pblk_löe
, 
li°
);

1293 
	`li°_dñ
(&
löe
->
li°
);

1294 
l_mg
->
ƒ_‰ì_löes
--;

1296 
bô
 = 
	`föd_fú°_zîo_bô
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

1297 i‡(
	`u∆ikñy
(
bô
 >
lm
->
blk_≥r_löe
)) {

1298 
	`•ö_lock
(&
löe
->
lock
);

1299 
löe
->
°©e
 = 
PBLK_LINESTATE_BAD
;

1300 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1301 
löe
->
°©e
);

1302 
	`•ö_u∆ock
(&
löe
->
lock
);

1304 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
bad_li°
);

1306 
	`pblk_debug
(
pblk
, "löê%d i†bad\n", 
löe
->
id
);

1307 
ªåy
;

1310 
ªt
 = 
	`pblk_löe_¥ï¨e
(
pblk
, 
löe
);

1311 i‡(
ªt
) {

1312 
ªt
) {

1313 -
EAGAIN
:

1314 
	`li°_add
(&
löe
->
li°
, &
l_mg
->
bad_li°
);

1315 
ªåy
;

1316 -
EINTR
:

1317 
	`li°_add
(&
löe
->
li°
, &
l_mg
->
c‹ru±_li°
);

1318 
ªåy
;

1320 
	`pblk_îr
(
pblk
, "ÁûedÅÿ¥ï¨êlöê%d\n", 
löe
->
id
);

1321 
	`li°_add
(&
löe
->
li°
, &
l_mg
->
‰ì_li°
);

1322 
l_mg
->
ƒ_‰ì_löes
++;

1323  
NULL
;

1327  
löe
;

1328 
	}
}

1330 
pblk_löe
 *
	$pblk_löe_ªåy
(
pblk
 *pblk,

1331 
pblk_löe
 *
löe
)

1333 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1334 
pblk_löe
 *
ªåy_löe
;

1336 
ªåy
:

1337 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1338 
ªåy_löe
 = 
	`pblk_löe_gë
(
pblk
);

1339 i‡(!
ªåy_löe
) {

1340 
l_mg
->
d©a_löe
 = 
NULL
;

1341 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1342  
NULL
;

1345 
ªåy_löe
->
m≠_bôm≠
 = 
löe
->map_bitmap;

1346 
ªåy_löe
->
övÆid_bôm≠
 = 
löe
->invalid_bitmap;

1347 
ªåy_löe
->
smëa
 = 
löe
->smeta;

1348 
ªåy_löe
->
emëa
 = 
löe
->emeta;

1349 
ªåy_löe
->
mëa_löe
 = 
löe
->meta_line;

1351 
	`pblk_löe_ªöô
(
löe
);

1353 
l_mg
->
d©a_löe
 = 
ªåy_löe
;

1354 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1356 
	`pblk_æ_‰ì_löes_dec
(&
pblk
->
æ
, 
löe
, 
Ál£
);

1358 i‡(
	`pblk_löe_îa£
(
pblk
, 
ªåy_löe
))

1359 
ªåy
;

1361  
ªåy_löe
;

1362 
	}
}

1364 
	$pblk_£t_•a˚_limô
(
pblk
 *pblk)

1366 
pblk_æ
 *
æ
 = &
pblk
->rl;

1368 
	`©omic_£t
(&
æ
->
rb_•a˚
, 0);

1369 
	}
}

1371 
pblk_löe
 *
	$pblk_löe_gë_fú°_d©a
(
pblk
 *pblk)

1373 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1374 
pblk_löe
 *
löe
;

1376 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1377 
löe
 = 
	`pblk_löe_gë
(
pblk
);

1378 i‡(!
löe
) {

1379 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1380  
NULL
;

1383 
löe
->
£q_ƒ
 = 
l_mg
->
d_£q_ƒ
++;

1384 
löe
->
ty≥
 = 
PBLK_LINETYPE_DATA
;

1385 
l_mg
->
d©a_löe
 = 
löe
;

1387 
	`pblk_löe_£tup_mëad©a
(
löe
, 
l_mg
, &
pblk
->
lm
);

1390 
l_mg
->
d©a_√xt
 = 
	`pblk_löe_gë
(
pblk
);

1391 i‡(!
l_mg
->
d©a_√xt
) {

1396 
	`pblk_£t_•a˚_limô
(
pblk
);

1398 
l_mg
->
d©a_√xt
 = 
NULL
;

1400 
l_mg
->
d©a_√xt
->
£q_ƒ
 =Ü_mg->
d_£q_ƒ
++;

1401 
l_mg
->
d©a_√xt
->
ty≥
 = 
PBLK_LINETYPE_DATA
;

1403 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1405 i‡(
	`pblk_löe_Æloc_bôm≠s
(
pblk
, 
löe
))

1406  
NULL
;

1408 i‡(
	`pblk_löe_îa£
(
pblk
, 
löe
)) {

1409 
löe
 = 
	`pblk_löe_ªåy
(
pblk
,Üine);

1410 i‡(!
löe
)

1411  
NULL
;

1414 
ªåy_£tup
:

1415 i‡(!
	`pblk_löe_öô_mëad©a
(
pblk
, 
löe
, 
NULL
)) {

1416 
löe
 = 
	`pblk_löe_ªåy
(
pblk
,Üine);

1417 i‡(!
löe
)

1418  
NULL
;

1420 
ªåy_£tup
;

1423 i‡(!
	`pblk_löe_öô_bb
(
pblk
, 
löe
, 1)) {

1424 
löe
 = 
	`pblk_löe_ªåy
(
pblk
,Üine);

1425 i‡(!
löe
)

1426  
NULL
;

1428 
ªåy_£tup
;

1431 
	`pblk_æ_‰ì_löes_dec
(&
pblk
->
æ
, 
löe
, 
åue
);

1433  
löe
;

1434 
	}
}

1436 
	$pblk_µa_to_löe_put
(
pblk
 *pblk, 
µa_addr
 
µa
)

1438 
pblk_löe
 *
löe
;

1440 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
µa
);

1441 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put_wq
);

1442 
	}
}

1444 
	$pblk_rq_to_löe_put
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

1446 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

1447 
i
;

1449 
i
 = 0; i < 
rqd
->
ƒ_µas
; i++)

1450 
	`pblk_µa_to_löe_put
(
pblk
, 
µa_li°
[
i
]);

1451 
	}
}

1453 
	$pblk_°›_wrôes
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1455 
	`lockdï_as£π_hñd
(&
pblk
->
l_mg
.
‰ì_lock
);

1457 
	`pblk_£t_•a˚_limô
(
pblk
);

1458 
pblk
->
°©e
 = 
PBLK_STATE_STOPPING
;

1459 
	`åa˚_pblk_°©e
(
	`pblk_disk_«me
(
pblk
),Öblk->
°©e
);

1460 
	}
}

1462 
	$pblk_löe_˛o£_mëa_sync
(
pblk
 *pblk)

1464 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1465 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1466 
pblk_löe
 *
löe
, *
éöe
;

1467 
	`LIST_HEAD
(
li°
);

1469 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

1470 i‡(
	`li°_em±y
(&
l_mg
->
emëa_li°
)) {

1471 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

1475 
	`li°_cut_posôi⁄
(&
li°
, &
l_mg
->
emëa_li°
,Ü_mg->emëa_li°.
¥ev
);

1476 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

1478 
	`li°_f‹_óch_íåy_ß„
(
löe
, 
éöe
, &
li°
,Üist) {

1479 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

1481 
emëa
->
mem
 < 
lm
->
emëa_Àn
[0]) {

1482 
ªt
;

1484 
ªt
 = 
	`pblk_submô_mëa_io
(
pblk
, 
löe
);

1485 i‡(
ªt
) {

1486 
	`pblk_îr
(
pblk
, "sync metaÜine %d failed (%d)\n",

1487 
löe
->
id
, 
ªt
);

1493 
	`pblk_waô_f‹_mëa
(
pblk
);

1494 
	`Êush_w‹kqueue
(
pblk
->
˛o£_wq
);

1495 
	}
}

1497 
	$__pblk_pùñöe_Êush
(
pblk
 *pblk)

1499 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1500 
ªt
;

1502 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1503 i‡(
pblk
->
°©e
 =
PBLK_STATE_RECOVERING
 ||

1504 
pblk
->
°©e
 =
PBLK_STATE_STOPPED
) {

1505 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1508 
pblk
->
°©e
 = 
PBLK_STATE_RECOVERING
;

1509 
	`åa˚_pblk_°©e
(
	`pblk_disk_«me
(
pblk
),Öblk->
°©e
);

1510 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1512 
	`pblk_Êush_wrôî
(
pblk
);

1513 
	`pblk_waô_f‹_mëa
(
pblk
);

1515 
ªt
 = 
	`pblk_ªcov_∑d
(
pblk
);

1516 i‡(
ªt
) {

1517 
	`pblk_îr
(
pblk
, "couldÇŸ clo£ d©®⁄Åórdown(%d)\n", 
ªt
);

1521 
	`Êush_w‹kqueue
(
pblk
->
bb_wq
);

1522 
	`pblk_löe_˛o£_mëa_sync
(
pblk
);

1523 
	}
}

1525 
	$__pblk_pùñöe_°›
(
pblk
 *pblk)

1527 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1529 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1530 
pblk
->
°©e
 = 
PBLK_STATE_STOPPED
;

1531 
	`åa˚_pblk_°©e
(
	`pblk_disk_«me
(
pblk
),Öblk->
°©e
);

1532 
l_mg
->
d©a_löe
 = 
NULL
;

1533 
l_mg
->
d©a_√xt
 = 
NULL
;

1534 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1535 
	}
}

1537 
	$pblk_pùñöe_°›
(
pblk
 *pblk)

1539 
	`__pblk_pùñöe_Êush
(
pblk
);

1540 
	`__pblk_pùñöe_°›
(
pblk
);

1541 
	}
}

1543 
pblk_löe
 *
	$pblk_löe_ª∂a˚_d©a
(
pblk
 *pblk)

1545 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1546 
pblk_löe
 *
cur
, *
√w
 = 
NULL
;

1547 
À·_£blks
;

1549 
√w
 = 
l_mg
->
d©a_√xt
;

1550 i‡(!
√w
)

1551 
out
;

1553 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1554 
cur
 = 
l_mg
->
d©a_löe
;

1555 
l_mg
->
d©a_löe
 = 
√w
;

1557 
	`pblk_löe_£tup_mëad©a
(
√w
, 
l_mg
, &
pblk
->
lm
);

1558 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1560 
ªåy_îa£
:

1561 
À·_£blks
 = 
	`©omic_ªad
(&
√w
->left_seblks);

1562 i‡(
À·_£blks
) {

1564 i‡(
	`©omic_ªad
(&
√w
->
À·_eblks
)) {

1565 i‡(
	`pblk_löe_îa£
(
pblk
, 
√w
))

1566 
out
;

1568 
	`io_scheduÀ
();

1570 
ªåy_îa£
;

1573 i‡(
	`pblk_löe_Æloc_bôm≠s
(
pblk
, 
√w
))

1574  
NULL
;

1576 
ªåy_£tup
:

1577 i‡(!
	`pblk_löe_öô_mëad©a
(
pblk
, 
√w
, 
cur
)) {

1578 
√w
 = 
	`pblk_löe_ªåy
(
pblk
,Çew);

1579 i‡(!
√w
)

1580 
out
;

1582 
ªåy_£tup
;

1585 i‡(!
	`pblk_löe_öô_bb
(
pblk
, 
√w
, 1)) {

1586 
√w
 = 
	`pblk_löe_ªåy
(
pblk
,Çew);

1587 i‡(!
√w
)

1588 
out
;

1590 
ªåy_£tup
;

1593 
	`pblk_æ_‰ì_löes_dec
(&
pblk
->
æ
, 
√w
, 
åue
);

1596 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1597 
l_mg
->
d©a_√xt
 = 
	`pblk_löe_gë
(
pblk
);

1598 i‡(!
l_mg
->
d©a_√xt
) {

1603 
	`pblk_°›_wrôes
(
pblk
, 
√w
);

1604 
l_mg
->
d©a_√xt
 = 
NULL
;

1606 
l_mg
->
d©a_√xt
->
£q_ƒ
 =Ü_mg->
d_£q_ƒ
++;

1607 
l_mg
->
d©a_√xt
->
ty≥
 = 
PBLK_LINETYPE_DATA
;

1609 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1611 
out
:

1612  
√w
;

1613 
	}
}

1615 
	$__pblk_löe_put
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1617 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1618 
pblk_gc
 *
gc
 = &
pblk
->gc;

1620 
	`•ö_lock
(&
löe
->
lock
);

1621 
	`WARN_ON
(
löe
->
°©e
 !
PBLK_LINESTATE_GC
);

1622 i‡(
löe
->
w_îr_gc
->
has_gc_îr
) {

1623 
	`•ö_u∆ock
(&
löe
->
lock
);

1624 
	`pblk_îr
(
pblk
, "löê%d hadÉº‹†durög GC\n", 
löe
->
id
);

1625 
	`pblk_put_löe_back
(
pblk
, 
löe
);

1626 
löe
->
w_îr_gc
->
has_gc_îr
 = 0;

1630 
löe
->
°©e
 = 
PBLK_LINESTATE_FREE
;

1631 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1632 
löe
->
°©e
);

1633 
löe
->
gc_group
 = 
PBLK_LINEGC_NONE
;

1634 
	`pblk_löe_‰ì
(
löe
);

1636 i‡(
löe
->
w_îr_gc
->
has_wrôe_îr
) {

1637 
	`pblk_æ_wîr_löe_out
(&
pblk
->
æ
);

1638 
löe
->
w_îr_gc
->
has_wrôe_îr
 = 0;

1641 
	`•ö_u∆ock
(&
löe
->
lock
);

1642 
	`©omic_dec
(&
gc
->
pùñöe_gc
);

1644 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1645 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
‰ì_li°
);

1646 
l_mg
->
ƒ_‰ì_löes
++;

1647 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1649 
	`pblk_æ_‰ì_löes_öc
(&
pblk
->
æ
, 
löe
);

1650 
	}
}

1652 
	$pblk_löe_put_ws
(
w‹k_°ru˘
 *
w‹k
)

1654 
pblk_löe_ws
 *
löe_put_ws
 = 
	`c⁄èöî_of
(
w‹k
,

1655 
pblk_löe_ws
, 
ws
);

1656 
pblk
 *pblk = 
löe_put_ws
->pblk;

1657 
pblk_löe
 *
löe
 = 
löe_put_ws
->line;

1659 
	`__pblk_löe_put
(
pblk
, 
löe
);

1660 
	`mempoﬁ_‰ì
(
löe_put_ws
, &
pblk
->
gí_ws_poﬁ
);

1661 
	}
}

1663 
	$pblk_löe_put
(
kªf
 *
ªf
)

1665 
pblk_löe
 *
löe
 = 
	`c⁄èöî_of
(
ªf
, pblk_line,Ñef);

1666 
pblk
 *pblk = 
löe
->pblk;

1668 
	`__pblk_löe_put
(
pblk
, 
löe
);

1669 
	}
}

1671 
	$pblk_löe_put_wq
(
kªf
 *
ªf
)

1673 
pblk_löe
 *
löe
 = 
	`c⁄èöî_of
(
ªf
, pblk_line,Ñef);

1674 
pblk
 *pblk = 
löe
->pblk;

1675 
pblk_löe_ws
 *
löe_put_ws
;

1677 
löe_put_ws
 = 
	`mempoﬁ_Æloc
(&
pblk
->
gí_ws_poﬁ
, 
GFP_ATOMIC
);

1678 i‡(!
löe_put_ws
)

1681 
löe_put_ws
->
pblk
 =Öblk;

1682 
löe_put_ws
->
löe
 =Üine;

1683 
löe_put_ws
->
¥iv
 = 
NULL
;

1685 
	`INIT_WORK
(&
löe_put_ws
->
ws
, 
pblk_löe_put_ws
);

1686 
	`queue_w‹k
(
pblk
->
r_íd_wq
, &
löe_put_ws
->
ws
);

1687 
	}
}

1689 
	$pblk_blk_îa£_async
(
pblk
 *pblk, 
µa_addr
 
µa
)

1691 
nvm_rq
 *
rqd
;

1692 
îr
;

1694 
rqd
 = 
	`pblk_Æloc_rqd
(
pblk
, 
PBLK_ERASE
);

1696 
	`pblk_£tup_e_rq
(
pblk
, 
rqd
, 
µa
);

1698 
rqd
->
íd_io
 = 
pblk_íd_io_îa£
;

1699 
rqd
->
¥iv©e
 = 
pblk
;

1701 
	`åa˚_pblk_chunk_ª£t
(
	`pblk_disk_«me
(
pblk
),

1702 &
µa
, 
PBLK_CHUNK_RESET_START
);

1707 
îr
 = 
	`pblk_submô_io
(
pblk
, 
rqd
, 
NULL
);

1708 i‡(
îr
) {

1709 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1710 
nvm_geo
 *
geo
 = &
dev
->geo;

1712 
	`pblk_îr
(
pblk
, "couldÇotásyncÉraseÜine:%d,blk:%d\n",

1713 
	`pblk_µa_to_löe_id
(
µa
),

1714 
	`pblk_µa_to_pos
(
geo
, 
µa
));

1717  
îr
;

1718 
	}
}

1720 
pblk_löe
 *
	$pblk_löe_gë_d©a
(
pblk
 *pblk)

1722  
pblk
->
l_mg
.
d©a_löe
;

1723 
	}
}

1726 
pblk_löe
 *
	$pblk_löe_gë_îa£
(
pblk
 *pblk)

1728  
pblk
->
l_mg
.
d©a_√xt
;

1729 
	}
}

1731 
	$pblk_löe_is_fuŒ
(
pblk_löe
 *
löe
)

1733  (
löe
->
À·_m£cs
 == 0);

1734 
	}
}

1736 
	$pblk_löe_should_sync_mëa
(
pblk
 *pblk)

1738 i‡(
	`pblk_æ_is_limô
(&
pblk
->
æ
))

1739 
	`pblk_löe_˛o£_mëa_sync
(
pblk
);

1740 
	}
}

1742 
	$pblk_löe_˛o£
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1744 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1745 
nvm_geo
 *
geo
 = &
dev
->geo;

1746 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1747 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1748 
li°_hód
 *
move_li°
;

1749 
i
;

1751 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1752 
	`WARN
(!
	`bôm≠_fuŒ
(
löe
->
m≠_bôm≠
, 
lm
->
£c_≥r_löe
),

1753 "pblk: c‹ru± clo£dÜöê%d\n", 
löe
->
id
);

1756 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

1757 
	`WARN_ON
(!
	`ã°_™d_˛ór_bô
(
löe
->
mëa_löe
, &
l_mg
->
mëa_bôm≠
));

1758 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

1760 
	`•ö_lock
(&
l_mg
->
gc_lock
);

1761 
	`•ö_lock
(&
löe
->
lock
);

1762 
	`WARN_ON
(
löe
->
°©e
 !
PBLK_LINESTATE_OPEN
);

1763 
löe
->
°©e
 = 
PBLK_LINESTATE_CLOSED
;

1764 
move_li°
 = 
	`pblk_löe_gc_li°
(
pblk
, 
löe
);

1765 
	`li°_add_èû
(&
löe
->
li°
, 
move_li°
);

1767 
	`mempoﬁ_‰ì
(
löe
->
m≠_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

1768 
löe
->
m≠_bôm≠
 = 
NULL
;

1769 
löe
->
smëa
 = 
NULL
;

1770 
löe
->
emëa
 = 
NULL
;

1772 
i
 = 0; i < 
lm
->
blk_≥r_löe
; i++) {

1773 
pblk_lun
 *
æun
 = &
pblk
->
luns
[
i
];

1774 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
æun
->
bµa
);

1775 
°©e
 = 
löe
->
chks
[
pos
].state;

1777 i‡(!(
°©e
 & 
NVM_CHK_ST_OFFLINE
))

1778 
°©e
 = 
NVM_CHK_ST_CLOSED
;

1781 
	`•ö_u∆ock
(&
löe
->
lock
);

1782 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

1784 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1785 
löe
->
°©e
);

1786 
	}
}

1788 
	$pblk_löe_˛o£_mëa
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1790 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

1791 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1792 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

1793 
löe_emëa
 *
emëa_buf
 = 
emëa
->
buf
;

1794 
wa_cou¡îs
 *
wa
 = 
	`emëa_to_wa
(
lm
, 
emëa_buf
);

1797 
	`mem˝y
(
	`emëa_to_vsc
(
pblk
, 
emëa_buf
), 
l_mg
->
vsc_li°
, 
lm
->
vsc_li°_Àn
);

1798 
	`mem˝y
(
	`emëa_to_bb
(
emëa_buf
), 
löe
->
blk_bôm≠
, 
lm
->
blk_bôm≠_Àn
);

1800 
wa
->
u£r
 = 
	`˝u_to_À64
(
	`©omic64_ªad
(&
pblk
->
u£r_wa
));

1801 
wa
->
∑d
 = 
	`˝u_to_À64
(
	`©omic64_ªad
(&
pblk
->
∑d_wa
));

1802 
wa
->
gc
 = 
	`˝u_to_À64
(
	`©omic64_ªad
(&
pblk
->
gc_wa
));

1804 i‡(
	`À32_to_˝u
(
emëa_buf
->
hódî
.
idítifõr
Ë!
PBLK_MAGIC
) {

1805 
emëa_buf
->
hódî
.
idítifõr
 = 
	`˝u_to_À32
(
PBLK_MAGIC
);

1806 
	`guid_c›y
((
guid_t
 *)&
emëa_buf
->
hódî
.
uuid
,

1807 &
pblk
->
ö°™˚_uuid
);

1808 
emëa_buf
->
hódî
.
id
 = 
	`˝u_to_À32
(
löe
->id);

1809 
emëa_buf
->
hódî
.
ty≥
 = 
	`˝u_to_À16
(
löe
->type);

1810 
emëa_buf
->
hódî
.
vîsi⁄_maj‹
 = 
EMETA_VERSION_MAJOR
;

1811 
emëa_buf
->
hódî
.
vîsi⁄_mö‹
 = 
EMETA_VERSION_MINOR
;

1812 
emëa_buf
->
hódî
.
¸c
 = 
	`˝u_to_À32
(

1813 
	`pblk_ˇlc_mëa_hódî_¸c
(
pblk
, &
emëa_buf
->
hódî
));

1816 
emëa_buf
->
ƒ_vÆid_lbas
 = 
	`˝u_to_À64
(
löe
->nr_valid_lbas);

1817 
emëa_buf
->
¸c
 = 
	`˝u_to_À32
(
	`pblk_ˇlc_emëa_¸c
(
pblk
,Émeta_buf));

1819 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

1820 
	`•ö_lock
(&
löe
->
lock
);

1825 i‡(
löe
->
emëa_s£c
 !löe->
cur_£c
)

1826 
löe
->
emëa_s£c
 =Üöe->
cur_£c
;

1828 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
emëa_li°
);

1829 
	`•ö_u∆ock
(&
löe
->
lock
);

1830 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

1832 
	`pblk_löe_should_sync_mëa
(
pblk
);

1833 
	}
}

1835 
	$pblk_ßve_lba_li°
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

1837 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1838 
lba_li°_size
 = 
lm
->
emëa_Àn
[2];

1839 
pblk_w_îr_gc
 *
w_îr_gc
 = 
löe
->w_err_gc;

1840 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

1842 
w_îr_gc
->
lba_li°
 = 
	`kvmÆloc
(
lba_li°_size
, 
GFP_KERNEL
);

1843 
	`mem˝y
(
w_îr_gc
->
lba_li°
, 
	`emëa_to_lbas
(
pblk
, 
emëa
->
buf
),

1844 
lba_li°_size
);

1845 
	}
}

1847 
	$pblk_löe_˛o£_ws
(
w‹k_°ru˘
 *
w‹k
)

1849 
pblk_löe_ws
 *
löe_ws
 = 
	`c⁄èöî_of
(
w‹k
, pblk_line_ws,

1850 
ws
);

1851 
pblk
 *pblk = 
löe_ws
->pblk;

1852 
pblk_löe
 *
löe
 = 
löe_ws
->line;

1853 
pblk_w_îr_gc
 *
w_îr_gc
 = 
löe
->w_err_gc;

1858 i‡(
w_îr_gc
->
has_wrôe_îr
)

1859 
	`pblk_ßve_lba_li°
(
pblk
, 
löe
);

1861 
	`pblk_löe_˛o£
(
pblk
, 
löe
);

1862 
	`mempoﬁ_‰ì
(
löe_ws
, &
pblk
->
gí_ws_poﬁ
);

1863 
	}
}

1865 
	$pblk_gí_run_ws
(
pblk
 *pblk, 
pblk_löe
 *
löe
, *
¥iv
,

1866 (*
w‹k
)(
w‹k_°ru˘
 *), 
gÂ_t
 
gÂ_mask
,

1867 
w‹kqueue_°ru˘
 *
wq
)

1869 
pblk_löe_ws
 *
löe_ws
;

1871 
löe_ws
 = 
	`mempoﬁ_Æloc
(&
pblk
->
gí_ws_poﬁ
, 
gÂ_mask
);

1873 
löe_ws
->
pblk
 =Öblk;

1874 
löe_ws
->
löe
 =Üine;

1875 
löe_ws
->
¥iv
 =Öriv;

1877 
	`INIT_WORK
(&
löe_ws
->
ws
, 
w‹k
);

1878 
	`queue_w‹k
(
wq
, &
löe_ws
->
ws
);

1879 
	}
}

1881 
	$__pblk_down_chunk
(
pblk
 *pblk, 
pos
)

1883 
pblk_lun
 *
æun
 = &
pblk
->
luns
[
pos
];

1884 
ªt
;

1891 
ªt
 = 
	`down_timeout
(&
æun
->
wr_£m
, 
	`m£cs_to_jiffõs
(30000));

1892 i‡(
ªt
 =-
ETIME
 ||Ñë =-
EINTR
)

1893 
	`pblk_îr
(
pblk
, "takingÜun semaphoreÅimed out:Érr %d\n",

1894 -
ªt
);

1895 
	}
}

1897 
	$pblk_down_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
)

1899 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1900 
nvm_geo
 *
geo
 = &
dev
->geo;

1901 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

1903 
	`__pblk_down_chunk
(
pblk
, 
pos
);

1904 
	}
}

1906 
	$pblk_down_rq
(
pblk
 *pblk, 
µa_addr
 
µa
,

1907 *
lun_bôm≠
)

1909 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1910 
nvm_geo
 *
geo
 = &
dev
->geo;

1911 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

1916 i‡(
	`ã°_™d_£t_bô
(
pos
, 
lun_bôm≠
))

1919 
	`__pblk_down_chunk
(
pblk
, 
pos
);

1920 
	}
}

1922 
	$pblk_up_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
)

1924 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1925 
nvm_geo
 *
geo
 = &
dev
->geo;

1926 
pblk_lun
 *
æun
;

1927 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

1929 
æun
 = &
pblk
->
luns
[
pos
];

1930 
	`up
(&
æun
->
wr_£m
);

1931 
	}
}

1933 
	$pblk_up_rq
(
pblk
 *pblk, *
lun_bôm≠
)

1935 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1936 
nvm_geo
 *
geo
 = &
dev
->geo;

1937 
pblk_lun
 *
æun
;

1938 
num_lun
 = 
geo
->
Æl_luns
;

1939 
bô
 = -1;

1941 (
bô
 = 
	`föd_√xt_bô
(
lun_bôm≠
, 
num_lun
, bit + 1)) <Çum_lun) {

1942 
æun
 = &
pblk
->
luns
[
bô
];

1943 
	`up
(&
æun
->
wr_£m
);

1945 
	}
}

1947 
	$pblk_upd©e_m≠
(
pblk
 *pblk, 
£˘‹_t
 
lba
, 
µa_addr
 
µa
)

1949 
µa_addr
 
µa_l2p
;

1952 i‡(!(
lba
 < 
pblk
->
ˇ∑côy
)) {

1953 
	`WARN
(1, "pblk: corrupted L2P mapÑequest\n");

1957 
	`•ö_lock
(&
pblk
->
å™s_lock
);

1958 
µa_l2p
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

1960 i‡(!
	`pblk_addr_ö_ˇche
(
µa_l2p
Ë&& !
	`pblk_µa_em±y
(ppa_l2p))

1961 
	`pblk_m≠_övÆid©e
(
pblk
, 
µa_l2p
);

1963 
	`pblk_å™s_m≠_£t
(
pblk
, 
lba
, 
µa
);

1964 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

1965 
	}
}

1967 
	$pblk_upd©e_m≠_ˇche
(
pblk
 *pblk, 
£˘‹_t
 
lba
, 
µa_addr
 
µa
)

1970 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1972 
	`BUG_ON
(!
	`pblk_addr_ö_ˇche
(
µa
));

1973 
	`BUG_ON
(
	`pblk_rb_pos_oob
(&
pblk
->
rwb
, 
	`pblk_addr_to_ˇchñöe
(
µa
)));

1976 
	`pblk_upd©e_m≠
(
pblk
, 
lba
, 
µa
);

1977 
	}
}

1979 
	$pblk_upd©e_m≠_gc
(
pblk
 *pblk, 
£˘‹_t
 
lba
, 
µa_addr
 
µa_√w
,

1980 
pblk_löe
 *
gc_löe
, 
u64
 
∑ddr_gc
)

1982 
µa_addr
 
µa_l2p
, 
µa_gc
;

1983 
ªt
 = 1;

1985 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1987 
	`BUG_ON
(!
	`pblk_addr_ö_ˇche
(
µa_√w
));

1988 
	`BUG_ON
(
	`pblk_rb_pos_oob
(&
pblk
->
rwb
, 
	`pblk_addr_to_ˇchñöe
(
µa_√w
)));

1992 i‡(!(
lba
 < 
pblk
->
ˇ∑côy
)) {

1993 
	`WARN
(1, "pblk: corrupted L2P mapÑequest\n");

1997 
	`•ö_lock
(&
pblk
->
å™s_lock
);

1998 
µa_l2p
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

1999 
µa_gc
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr_gc
, 
gc_löe
->
id
);

2001 i‡(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_gc
)) {

2002 
	`•ö_lock
(&
gc_löe
->
lock
);

2003 
	`WARN
(!
	`ã°_bô
(
∑ddr_gc
, 
gc_löe
->
övÆid_bôm≠
),

2005 
	`•ö_u∆ock
(&
gc_löe
->
lock
);

2007 
ªt
 = 0;

2008 
out
;

2011 
	`pblk_å™s_m≠_£t
(
pblk
, 
lba
, 
µa_√w
);

2012 
out
:

2013 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

2014  
ªt
;

2015 
	}
}

2017 
	$pblk_upd©e_m≠_dev
(
pblk
 *pblk, 
£˘‹_t
 
lba
,

2018 
µa_addr
 
µa_m≠≥d
, µa_add∏
µa_ˇche
)

2020 
µa_addr
 
µa_l2p
;

2022 #ifde‡
CONFIG_NVM_PBLK_DEBUG


2024 
	`BUG_ON
(
	`pblk_addr_ö_ˇche
(
µa_m≠≥d
));

2027 i‡(
lba
 =
ADDR_EMPTY
) {

2028 
	`©omic64_öc
(&
pblk
->
∑d_wa
);

2029 #ifde‡
CONFIG_NVM_PBLK_DEBUG


2030 
	`©omic_l⁄g_öc
(&
pblk
->
∑dded_wb
);

2032 i‡(!
	`pblk_µa_em±y
(
µa_m≠≥d
))

2033 
	`pblk_m≠_övÆid©e
(
pblk
, 
µa_m≠≥d
);

2038 i‡(!(
lba
 < 
pblk
->
ˇ∑côy
)) {

2039 
	`WARN
(1, "pblk: corrupted L2P mapÑequest\n");

2043 
	`•ö_lock
(&
pblk
->
å™s_lock
);

2044 
µa_l2p
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

2049 i‡(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_ˇche
)) {

2050 i‡(!
	`pblk_µa_em±y
(
µa_m≠≥d
))

2051 
	`pblk_m≠_övÆid©e
(
pblk
, 
µa_m≠≥d
);

2052 
out
;

2055 #ifde‡
CONFIG_NVM_PBLK_DEBUG


2056 
	`WARN_ON
(!
	`pblk_addr_ö_ˇche
(
µa_l2p
Ë&& !
	`pblk_µa_em±y
(ppa_l2p));

2059 
	`pblk_å™s_m≠_£t
(
pblk
, 
lba
, 
µa_m≠≥d
);

2060 
out
:

2061 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

2062 
	}
}

2064 
	$pblk_lookup_l2p_£q
(
pblk
 *pblk, 
µa_addr
 *
µas
,

2065 
£˘‹_t
 
blba
, 
ƒ_£cs
, 
boﬁ
 *
‰om_ˇche
)

2067 
i
;

2069 
	`•ö_lock
(&
pblk
->
å™s_lock
);

2070 
i
 = 0; i < 
ƒ_£cs
; i++) {

2071 
µa_addr
 
µa
;

2073 
µa
 = 
µas
[
i
] = 
	`pblk_å™s_m≠_gë
(
pblk
, 
blba
 + i);

2076 i‡(!
	`pblk_µa_em±y
(
µa
Ë&& !
	`pblk_addr_ö_ˇche
(ppa)) {

2077 
pblk_löe
 *
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
µa
);

2079 i‡(
i
 > 0 && *
‰om_ˇche
)

2081 *
‰om_ˇche
 = 
Ál£
;

2083 
	`kªf_gë
(&
löe
->
ªf
);

2085 i‡(
i
 > 0 && !*
‰om_ˇche
)

2087 *
‰om_ˇche
 = 
åue
;

2090 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

2091  
i
;

2092 
	}
}

2094 
	$pblk_lookup_l2p_ønd
(
pblk
 *pblk, 
µa_addr
 *
µas
,

2095 
u64
 *
lba_li°
, 
ƒ_£cs
)

2097 
u64
 
lba
;

2098 
i
;

2100 
	`•ö_lock
(&
pblk
->
å™s_lock
);

2101 
i
 = 0; i < 
ƒ_£cs
; i++) {

2102 
lba
 = 
lba_li°
[
i
];

2103 i‡(
lba
 !
ADDR_EMPTY
) {

2105 i‡(!(
lba
 < 
pblk
->
ˇ∑côy
)) {

2106 
	`WARN
(1, "pblk: corrupted L2P mapÑequest\n");

2109 
µas
[
i
] = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

2112 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

2113 
	}
}

2115 *
	$pblk_gë_mëa_f‹_wrôes
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

2117 *
buf„r
;

2119 i‡(
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
)) {

2121 
buf„r
 = 
rqd
->
mëa_li°
;

2126 
buf„r
 = 
	`∑ge_to_vút
(

2127 
rqd
->
bio
->
bi_io_vec
[rqd->bio->
bi_v˙t
 - 1].
bv_∑ge
);

2130  
buf„r
;

2131 
	}
}

2133 
	$pblk_gë_∑cked_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

2135 *
mëa_li°
 = 
rqd
->meta_list;

2136 *
∑ge
;

2137 
i
 = 0;

2139 i‡(
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
))

2142 
∑ge
 = 
	`∑ge_to_vút
(
rqd
->
bio
->
bi_io_vec
[rqd->bio->
bi_v˙t
 - 1].
bv_∑ge
);

2144 ; 
i
 < 
rqd
->
ƒ_µas
; i++)

2145 
	`mem˝y
(
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
),

2146 
∑ge
 + (
i
 * (
pblk_£c_mëa
)),

2147 (
pblk_£c_mëa
));

2148 
	}
}

	@pblk-gc.c

19 
	~"pblk.h
"

20 
	~"pblk-åa˚.h
"

21 
	~<löux/dñay.h
>

24 
	$pblk_gc_‰ì_gc_rq
(
pblk_gc_rq
 *
gc_rq
)

26 i‡(
gc_rq
->
d©a
)

27 
	`v‰ì
(
gc_rq
->
d©a
);

28 
	`k‰ì
(
gc_rq
);

29 
	}
}

31 
	$pblk_gc_wrôe
(
pblk
 *pblk)

33 
pblk_gc
 *
gc
 = &
pblk
->gc;

34 
pblk_gc_rq
 *
gc_rq
, *
tgc_rq
;

35 
	`LIST_HEAD
(
w_li°
);

37 
	`•ö_lock
(&
gc
->
w_lock
);

38 i‡(
	`li°_em±y
(&
gc
->
w_li°
)) {

39 
	`•ö_u∆ock
(&
gc
->
w_lock
);

43 
	`li°_cut_posôi⁄
(&
w_li°
, &
gc
->w_li°, gc->w_li°.
¥ev
);

44 
gc
->
w_íåõs
 = 0;

45 
	`•ö_u∆ock
(&
gc
->
w_lock
);

47 
	`li°_f‹_óch_íåy_ß„
(
gc_rq
, 
tgc_rq
, &
w_li°
, 
li°
) {

48 
	`pblk_wrôe_gc_to_ˇche
(
pblk
, 
gc_rq
);

49 
	`li°_dñ
(&
gc_rq
->
li°
);

50 
	`kªf_put
(&
gc_rq
->
löe
->
ªf
, 
pblk_löe_put
);

51 
	`pblk_gc_‰ì_gc_rq
(
gc_rq
);

55 
	}
}

57 
	$pblk_gc_wrôî_kick
(
pblk_gc
 *
gc
)

59 
	`wake_up_¥o˚ss
(
gc
->
gc_wrôî_ts
);

60 
	}
}

62 
	$pblk_put_löe_back
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

64 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

65 
li°_hód
 *
move_li°
;

67 
	`•ö_lock
(&
l_mg
->
gc_lock
);

68 
	`•ö_lock
(&
löe
->
lock
);

69 
	`WARN_ON
(
löe
->
°©e
 !
PBLK_LINESTATE_GC
);

70 
löe
->
°©e
 = 
PBLK_LINESTATE_CLOSED
;

71 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

72 
löe
->
°©e
);

79 
löe
->
gc_group
 = 
PBLK_LINEGC_NONE
;

80 
move_li°
 = 
	`pblk_löe_gc_li°
(
pblk
, 
löe
);

81 
	`•ö_u∆ock
(&
löe
->
lock
);

82 
	`li°_add_èû
(&
löe
->
li°
, 
move_li°
);

83 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

84 
	}
}

86 
	$pblk_gc_löe_ws
(
w‹k_°ru˘
 *
w‹k
)

88 
pblk_löe_ws
 *
gc_rq_ws
 = 
	`c⁄èöî_of
(
w‹k
,

89 
pblk_löe_ws
, 
ws
);

90 
pblk
 *pblk = 
gc_rq_ws
->pblk;

91 
pblk_gc
 *
gc
 = &
pblk
->gc;

92 
pblk_löe
 *
löe
 = 
gc_rq_ws
->line;

93 
pblk_gc_rq
 *
gc_rq
 = 
gc_rq_ws
->
¥iv
;

94 
ªt
;

96 
	`up
(&
gc
->
gc_£m
);

99 
ªt
 = 
	`pblk_submô_ªad_gc
(
pblk
, 
gc_rq
);

100 i‡(
ªt
) {

101 
löe
->
w_îr_gc
->
has_gc_îr
 = 1;

102 
out
;

105 i‡(!
gc_rq
->
£cs_to_gc
)

106 
out
;

108 
ªåy
:

109 
	`•ö_lock
(&
gc
->
w_lock
);

110 i‡(
gc
->
w_íåõs
 >
PBLK_GC_RQ_QD
) {

111 
	`•ö_u∆ock
(&
gc
->
w_lock
);

112 
	`pblk_gc_wrôî_kick
(&
pblk
->
gc
);

113 
	`u¶ìp_ønge
(128, 256);

114 
ªåy
;

116 
gc
->
w_íåõs
++;

117 
	`li°_add_èû
(&
gc_rq
->
li°
, &
gc
->
w_li°
);

118 
	`•ö_u∆ock
(&
gc
->
w_lock
);

120 
	`pblk_gc_wrôî_kick
(&
pblk
->
gc
);

122 
	`k‰ì
(
gc_rq_ws
);

125 
out
:

126 
	`pblk_gc_‰ì_gc_rq
(
gc_rq
);

127 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put
);

128 
	`k‰ì
(
gc_rq_ws
);

129 
	}
}

131 
__À64
 *
	$gë_lba_li°_‰om_emëa
(
pblk
 *pblk,

132 
pblk_löe
 *
löe
)

134 
löe_emëa
 *
emëa_buf
;

135 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

136 
lba_li°_size
 = 
lm
->
emëa_Àn
[2];

137 
__À64
 *
lba_li°
;

138 
ªt
;

140 
emëa_buf
 = 
	`kvmÆloc
(
lm
->
emëa_Àn
[0], 
GFP_KERNEL
);

141 i‡(!
emëa_buf
)

142  
NULL
;

144 
ªt
 = 
	`pblk_löe_emëa_ªad
(
pblk
, 
löe
, 
emëa_buf
);

145 i‡(
ªt
) {

146 
	`pblk_îr
(
pblk
, "line %dÑeadÉmeta failed (%d)\n",

147 
löe
->
id
, 
ªt
);

148 
	`kv‰ì
(
emëa_buf
);

149  
NULL
;

158 
ªt
 = 
	`pblk_ªcov_check_emëa
(
pblk
, 
emëa_buf
);

159 i‡(
ªt
) {

160 
	`pblk_îr
(
pblk
, "inconsistentÉmeta (line %d)\n",

161 
löe
->
id
);

162 
	`kv‰ì
(
emëa_buf
);

163  
NULL
;

166 
lba_li°
 = 
	`kvmÆloc
(
lba_li°_size
, 
GFP_KERNEL
);

168 i‡(
lba_li°
)

169 
	`mem˝y
(
lba_li°
, 
	`emëa_to_lbas
(
pblk
, 
emëa_buf
), 
lba_li°_size
);

171 
	`kv‰ì
(
emëa_buf
);

173  
lba_li°
;

174 
	}
}

176 
	$pblk_gc_löe_¥ï¨e_ws
(
w‹k_°ru˘
 *
w‹k
)

178 
pblk_löe_ws
 *
löe_ws
 = 
	`c⁄èöî_of
(
w‹k
, pblk_line_ws,

179 
ws
);

180 
pblk
 *pblk = 
löe_ws
->pblk;

181 
pblk_löe
 *
löe
 = 
löe_ws
->line;

182 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

183 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

184 
nvm_geo
 *
geo
 = &
dev
->geo;

185 
pblk_gc
 *
gc
 = &
pblk
->gc;

186 
pblk_löe_ws
 *
gc_rq_ws
;

187 
pblk_gc_rq
 *
gc_rq
;

188 
__À64
 *
lba_li°
;

189 *
övÆid_bôm≠
;

190 
£c_À·
, 
ƒ_£cs
, 
bô
;

192 
övÆid_bôm≠
 = 
	`kmÆloc
(
lm
->
£c_bôm≠_Àn
, 
GFP_KERNEL
);

193 i‡(!
övÆid_bôm≠
)

194 
Áû_‰ì_ws
;

196 i‡(
löe
->
w_îr_gc
->
has_wrôe_îr
) {

197 
lba_li°
 = 
löe
->
w_îr_gc
->lba_list;

198 
löe
->
w_îr_gc
->
lba_li°
 = 
NULL
;

200 
lba_li°
 = 
	`gë_lba_li°_‰om_emëa
(
pblk
, 
löe
);

201 i‡(!
lba_li°
) {

202 
	`pblk_îr
(
pblk
, "couldÇot interpretÉmeta (line %d)\n",

203 
löe
->
id
);

204 
Áû_‰ì_övÆid_bôm≠
;

208 
	`•ö_lock
(&
löe
->
lock
);

209 
	`bôm≠_c›y
(
övÆid_bôm≠
, 
löe
->övÆid_bôm≠, 
lm
->
£c_≥r_löe
);

210 
£c_À·
 = 
	`pblk_löe_vsc
(
löe
);

211 
	`•ö_u∆ock
(&
löe
->
lock
);

213 i‡(
£c_À·
 < 0) {

214 
	`pblk_îr
(
pblk
, "c‹ru±ed GCÜöê(%d)\n", 
löe
->
id
);

215 
Áû_‰ì_lba_li°
;

218 
bô
 = -1;

219 
√xt_rq
:

220 
gc_rq
 = 
	`kmÆloc
((
pblk_gc_rq
), 
GFP_KERNEL
);

221 i‡(!
gc_rq
)

222 
Áû_‰ì_lba_li°
;

224 
ƒ_£cs
 = 0;

226 
bô
 = 
	`föd_√xt_zîo_bô
(
övÆid_bôm≠
, 
lm
->
£c_≥r_löe
,

227 
bô
 + 1);

228 i‡(
bô
 > 
löe
->
emëa_s£c
)

231 
gc_rq
->
∑ddr_li°
[
ƒ_£cs
] = 
bô
;

232 
gc_rq
->
lba_li°
[
ƒ_£cs
++] = 
	`À64_to_˝u
÷ba_li°[
bô
]);

233 } 
ƒ_£cs
 < 
pblk
->
max_wrôe_pgs
);

235 i‡(
	`u∆ikñy
(!
ƒ_£cs
)) {

236 
	`k‰ì
(
gc_rq
);

237 
out
;

240 
gc_rq
->
ƒ_£cs
 =Çr_secs;

241 
gc_rq
->
löe
 =Üine;

243 
gc_rq
->
d©a
 = 
	`vmÆloc
(
	`¨øy_size
(gc_rq->
ƒ_£cs
, 
geo
->
c£cs
));

244 i‡(!
gc_rq
->
d©a
)

245 
Áû_‰ì_gc_rq
;

247 
gc_rq_ws
 = 
	`kmÆloc
((
pblk_löe_ws
), 
GFP_KERNEL
);

248 i‡(!
gc_rq_ws
)

249 
Áû_‰ì_gc_d©a
;

251 
gc_rq_ws
->
pblk
 =Öblk;

252 
gc_rq_ws
->
löe
 =Üine;

253 
gc_rq_ws
->
¥iv
 = 
gc_rq
;

259 
	`down_timeout
(&
gc
->
gc_£m
, 
	`m£cs_to_jiffõs
(30000)))

260 
	`io_scheduÀ
();

262 
	`kªf_gë
(&
löe
->
ªf
);

264 
	`INIT_WORK
(&
gc_rq_ws
->
ws
, 
pblk_gc_löe_ws
);

265 
	`queue_w‹k
(
gc
->
gc_löe_ªadî_wq
, &
gc_rq_ws
->
ws
);

267 
£c_À·
 -
ƒ_£cs
;

268 i‡(
£c_À·
 > 0)

269 
√xt_rq
;

271 
out
:

272 
	`kv‰ì
(
lba_li°
);

273 
	`k‰ì
(
löe_ws
);

274 
	`k‰ì
(
övÆid_bôm≠
);

276 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put
);

277 
	`©omic_dec
(&
gc
->
ªad_öÊight_gc
);

281 
Áû_‰ì_gc_d©a
:

282 
	`v‰ì
(
gc_rq
->
d©a
);

283 
Áû_‰ì_gc_rq
:

284 
	`k‰ì
(
gc_rq
);

285 
Áû_‰ì_lba_li°
:

286 
	`kv‰ì
(
lba_li°
);

287 
Áû_‰ì_övÆid_bôm≠
:

288 
	`k‰ì
(
övÆid_bôm≠
);

289 
Áû_‰ì_ws
:

290 
	`k‰ì
(
löe_ws
);

296 
	`pblk_put_löe_back
(
pblk
, 
löe
);

297 
	`©omic_dec
(&
gc
->
ªad_öÊight_gc
);

299 
	`pblk_îr
(
pblk
, "ÁûedÅÿGCÜöê%d\n", 
löe
->
id
);

300 
	}
}

302 
	$pblk_gc_löe
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

304 
pblk_gc
 *
gc
 = &
pblk
->gc;

305 
pblk_löe_ws
 *
löe_ws
;

307 
	`pblk_debug
(
pblk
, "löê'%d' beögÑe˛aimed f‹ GC\n", 
löe
->
id
);

309 
löe_ws
 = 
	`kmÆloc
((
pblk_löe_ws
), 
GFP_KERNEL
);

310 i‡(!
löe_ws
)

311  -
ENOMEM
;

313 
löe_ws
->
pblk
 =Öblk;

314 
löe_ws
->
löe
 =Üine;

316 
	`©omic_öc
(&
gc
->
pùñöe_gc
);

317 
	`INIT_WORK
(&
löe_ws
->
ws
, 
pblk_gc_löe_¥ï¨e_ws
);

318 
	`queue_w‹k
(
gc
->
gc_ªadî_wq
, &
löe_ws
->
ws
);

321 
	}
}

323 
	$pblk_gc_ªadî_kick
(
pblk_gc
 *
gc
)

325 
	`wake_up_¥o˚ss
(
gc
->
gc_ªadî_ts
);

326 
	}
}

328 
	$pblk_gc_kick
(
pblk
 *pblk)

330 
pblk_gc
 *
gc
 = &
pblk
->gc;

332 
	`pblk_gc_wrôî_kick
(
gc
);

333 
	`pblk_gc_ªadî_kick
(
gc
);

336 i‡(
gc
->
gc_íabÀd
) {

337 
	`wake_up_¥o˚ss
(
gc
->
gc_ts
);

338 
	`mod_timî
(&
gc
->
gc_timî
,

339 
jiffõs
 + 
	`m£cs_to_jiffõs
(
GC_TIME_MSECS
));

341 
	}
}

343 
	$pblk_gc_ªad
(
pblk
 *pblk)

345 
pblk_gc
 *
gc
 = &
pblk
->gc;

346 
pblk_löe
 *
löe
;

348 
	`•ö_lock
(&
gc
->
r_lock
);

349 i‡(
	`li°_em±y
(&
gc
->
r_li°
)) {

350 
	`•ö_u∆ock
(&
gc
->
r_lock
);

354 
löe
 = 
	`li°_fú°_íåy
(&
gc
->
r_li°
, 
pblk_löe
, 
li°
);

355 
	`li°_dñ
(&
löe
->
li°
);

356 
	`•ö_u∆ock
(&
gc
->
r_lock
);

358 
	`pblk_gc_kick
(
pblk
);

360 i‡(
	`pblk_gc_löe
(
pblk
, 
löe
)) {

361 
	`pblk_îr
(
pblk
, "ÁûedÅÿGCÜöê%d\n", 
löe
->
id
);

363 
	`•ö_lock
(&
gc
->
r_lock
);

364 
	`li°_add_èû
(&
löe
->
li°
, &
gc
->
r_li°
);

365 
	`•ö_u∆ock
(&
gc
->
r_lock
);

369 
	}
}

371 
pblk_löe
 *
	$pblk_gc_gë_vi˘im_löe
(
pblk
 *pblk,

372 
li°_hód
 *
group_li°
)

374 
pblk_löe
 *
löe
, *
vi˘im
;

375 
löe_vsc
 = ~0x0L, 
vi˘im_vsc
 = ~0x0L;

377 
vi˘im
 = 
	`li°_fú°_íåy
(
group_li°
, 
pblk_löe
, 
li°
);

379 
	`li°_f‹_óch_íåy
(
löe
, 
group_li°
, 
li°
) {

380 i‡(!
	`©omic_ªad
(&
löe
->
£c_to_upd©e
))

381 
löe_vsc
 = 
	`À32_to_˝u
(*
löe
->
vsc
);

382 i‡(
löe_vsc
 < 
vi˘im_vsc
) {

383 
vi˘im
 = 
löe
;

384 
vi˘im_vsc
 = 
	`À32_to_˝u
(*
vi˘im
->
vsc
);

388 i‡(
vi˘im_vsc
 == ~0x0)

389  
NULL
;

391  
vi˘im
;

392 
	}
}

394 
boﬁ
 
	$pblk_gc_should_run
(
pblk_gc
 *
gc
, 
pblk_æ
 *
æ
)

396 
ƒ_blocks_‰ì
, 
ƒ_blocks_√ed
;

397 
wîr_löes
 = 
	`©omic_ªad
(&
æ
->werr_lines);

399 
ƒ_blocks_√ed
 = 
	`pblk_æ_high_thrs
(
æ
);

400 
ƒ_blocks_‰ì
 = 
	`pblk_æ_ƒ_‰ì_blks
(
æ
);

403  ((
wîr_löes
 > 0) ||

404 ((
gc
->
gc_a˘ive
Ë&& (
ƒ_blocks_√ed
 > 
ƒ_blocks_‰ì
)));

405 
	}
}

407 
	$pblk_gc_‰ì_fuŒ_löes
(
pblk
 *pblk)

409 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

410 
pblk_gc
 *
gc
 = &
pblk
->gc;

411 
pblk_löe
 *
löe
;

414 
	`•ö_lock
(&
l_mg
->
gc_lock
);

415 i‡(
	`li°_em±y
(&
l_mg
->
gc_fuŒ_li°
)) {

416 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

420 
löe
 = 
	`li°_fú°_íåy
(&
l_mg
->
gc_fuŒ_li°
,

421 
pblk_löe
, 
li°
);

423 
	`•ö_lock
(&
löe
->
lock
);

424 
	`WARN_ON
(
löe
->
°©e
 !
PBLK_LINESTATE_CLOSED
);

425 
löe
->
°©e
 = 
PBLK_LINESTATE_GC
;

426 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

427 
löe
->
°©e
);

428 
	`•ö_u∆ock
(&
löe
->
lock
);

430 
	`li°_dñ
(&
löe
->
li°
);

431 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

433 
	`©omic_öc
(&
gc
->
pùñöe_gc
);

434 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put
);

436 
	}
}

444 
	$pblk_gc_run
(
pblk
 *pblk)

446 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

447 
pblk_gc
 *
gc
 = &
pblk
->gc;

448 
pblk_löe
 *
löe
;

449 
li°_hód
 *
group_li°
;

450 
boﬁ
 
run_gc
;

451 
ªad_öÊight_gc
, 
gc_group
 = 0, 
¥ev_group
 = 0;

453 
	`pblk_gc_‰ì_fuŒ_löes
(
pblk
);

455 
run_gc
 = 
	`pblk_gc_should_run
(&
pblk
->
gc
, &pblk->
æ
);

456 i‡(!
run_gc
 || (
	`©omic_ªad
(&
gc
->
ªad_öÊight_gc
Ë>
PBLK_GC_L_QD
))

459 
√xt_gc_group
:

460 
group_li°
 = 
l_mg
->
gc_li°s
[
gc_group
++];

463 
	`•ö_lock
(&
l_mg
->
gc_lock
);

465 
löe
 = 
	`pblk_gc_gë_vi˘im_löe
(
pblk
, 
group_li°
);

466 i‡(!
löe
) {

467 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

471 
	`•ö_lock
(&
löe
->
lock
);

472 
	`WARN_ON
(
löe
->
°©e
 !
PBLK_LINESTATE_CLOSED
);

473 
löe
->
°©e
 = 
PBLK_LINESTATE_GC
;

474 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

475 
löe
->
°©e
);

476 
	`•ö_u∆ock
(&
löe
->
lock
);

478 
	`li°_dñ
(&
löe
->
li°
);

479 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

481 
	`•ö_lock
(&
gc
->
r_lock
);

482 
	`li°_add_èû
(&
löe
->
li°
, &
gc
->
r_li°
);

483 
	`•ö_u∆ock
(&
gc
->
r_lock
);

485 
ªad_öÊight_gc
 = 
	`©omic_öc_ªtu∫
(&
gc
->read_inflight_gc);

486 
	`pblk_gc_ªadî_kick
(
gc
);

488 
¥ev_group
 = 1;

491 
run_gc
 = 
	`pblk_gc_should_run
(&
pblk
->
gc
, &pblk->
æ
);

492 i‡(!
run_gc
 || 
ªad_öÊight_gc
 >
PBLK_GC_L_QD
)

496 i‡(!
¥ev_group
 && 
pblk
->
æ
.
rb_°©e
 > 
gc_group
 &&

497 
gc_group
 < 
PBLK_GC_NR_LISTS
)

498 
√xt_gc_group
;

499 
	}
}

501 
	$pblk_gc_timî
(
timî_li°
 *
t
)

503 
pblk
 *pblk = 
	`‰om_timî
’blk, 
t
, 
gc
.
gc_timî
);

505 
	`pblk_gc_kick
(
pblk
);

506 
	}
}

508 
	$pblk_gc_ts
(*
d©a
)

510 
pblk
 *pblk = 
d©a
;

512 !
	`kthªad_should_°›
()) {

513 
	`pblk_gc_run
(
pblk
);

514 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

515 
	`io_scheduÀ
();

519 
	}
}

521 
	$pblk_gc_wrôî_ts
(*
d©a
)

523 
pblk
 *pblk = 
d©a
;

525 !
	`kthªad_should_°›
()) {

526 i‡(!
	`pblk_gc_wrôe
(
pblk
))

528 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

529 
	`io_scheduÀ
();

533 
	}
}

535 
	$pblk_gc_ªadî_ts
(*
d©a
)

537 
pblk
 *pblk = 
d©a
;

538 
pblk_gc
 *
gc
 = &
pblk
->gc;

540 !
	`kthªad_should_°›
()) {

541 i‡(!
	`pblk_gc_ªad
(
pblk
))

543 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

544 
	`io_scheduÀ
();

547 #ifde‡
CONFIG_NVM_PBLK_DEBUG


548 
	`pblk_öfo
(
pblk
, "flushing gcÖipeline, %dÜinesÜeft\n",

549 
	`©omic_ªad
(&
gc
->
pùñöe_gc
));

553 i‡(!
	`©omic_ªad
(&
gc
->
pùñöe_gc
))

556 
	`scheduÀ
();

560 
	}
}

562 
	$pblk_gc_°¨t
(
pblk
 *pblk)

564 
pblk
->
gc
.
gc_a˘ive
 = 1;

565 
	`pblk_debug
(
pblk
, "gc start\n");

566 
	}
}

568 
	$pblk_gc_should_°¨t
(
pblk
 *pblk)

570 
pblk_gc
 *
gc
 = &
pblk
->gc;

572 i‡(
gc
->
gc_íabÀd
 && !gc->
gc_a˘ive
) {

573 
	`pblk_gc_°¨t
(
pblk
);

574 
	`pblk_gc_kick
(
pblk
);

576 
	}
}

578 
	$pblk_gc_should_°›
(
pblk
 *pblk)

580 
pblk_gc
 *
gc
 = &
pblk
->gc;

582 i‡(
gc
->
gc_a˘ive
 && !gc->
gc_f‹˚d
)

583 
gc
->
gc_a˘ive
 = 0;

584 
	}
}

586 
	$pblk_gc_should_kick
(
pblk
 *pblk)

588 
	`pblk_æ_upd©e_øãs
(&
pblk
->
æ
);

589 
	}
}

591 
	$pblk_gc_sysfs_°©e_show
(
pblk
 *pblk, *
gc_íabÀd
,

592 *
gc_a˘ive
)

594 
pblk_gc
 *
gc
 = &
pblk
->gc;

596 
	`•ö_lock
(&
gc
->
lock
);

597 *
gc_íabÀd
 = 
gc
->gc_enabled;

598 *
gc_a˘ive
 = 
gc
->gc_active;

599 
	`•ö_u∆ock
(&
gc
->
lock
);

600 
	}
}

602 
	$pblk_gc_sysfs_f‹˚
(
pblk
 *pblk, 
f‹˚
)

604 
pblk_gc
 *
gc
 = &
pblk
->gc;

606 i‡(
f‹˚
 < 0 || force > 1)

607  -
EINVAL
;

609 
	`•ö_lock
(&
gc
->
lock
);

610 
gc
->
gc_f‹˚d
 = 
f‹˚
;

612 i‡(
f‹˚
)

613 
gc
->
gc_íabÀd
 = 1;

615 
gc
->
gc_íabÀd
 = 0;

616 
	`•ö_u∆ock
(&
gc
->
lock
);

618 
	`pblk_gc_should_°¨t
(
pblk
);

621 
	}
}

623 
	$pblk_gc_öô
(
pblk
 *pblk)

625 
pblk_gc
 *
gc
 = &
pblk
->gc;

626 
ªt
;

628 
gc
->
gc_ts
 = 
	`kthªad_¸óã
(
pblk_gc_ts
, 
pblk
, "pblk-gc-ts");

629 i‡(
	`IS_ERR
(
gc
->
gc_ts
)) {

630 
	`pblk_îr
(
pblk
, "couldÇotállocate GC main kthread\n");

631  
	`PTR_ERR
(
gc
->
gc_ts
);

634 
gc
->
gc_wrôî_ts
 = 
	`kthªad_¸óã
(
pblk_gc_wrôî_ts
, 
pblk
,

636 i‡(
	`IS_ERR
(
gc
->
gc_wrôî_ts
)) {

637 
	`pblk_îr
(
pblk
, "couldÇotállocate GC writer kthread\n");

638 
ªt
 = 
	`PTR_ERR
(
gc
->
gc_wrôî_ts
);

639 
Áû_‰ì_maö_kthªad
;

642 
gc
->
gc_ªadî_ts
 = 
	`kthªad_¸óã
(
pblk_gc_ªadî_ts
, 
pblk
,

644 i‡(
	`IS_ERR
(
gc
->
gc_ªadî_ts
)) {

645 
	`pblk_îr
(
pblk
, "couldÇotállocate GCÑeader kthread\n");

646 
ªt
 = 
	`PTR_ERR
(
gc
->
gc_ªadî_ts
);

647 
Áû_‰ì_wrôî_kthªad
;

650 
	`timî_£tup
(&
gc
->
gc_timî
, 
pblk_gc_timî
, 0);

651 
	`mod_timî
(&
gc
->
gc_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(
GC_TIME_MSECS
));

653 
gc
->
gc_a˘ive
 = 0;

654 
gc
->
gc_f‹˚d
 = 0;

655 
gc
->
gc_íabÀd
 = 1;

656 
gc
->
w_íåõs
 = 0;

657 
	`©omic_£t
(&
gc
->
ªad_öÊight_gc
, 0);

658 
	`©omic_£t
(&
gc
->
pùñöe_gc
, 0);

663 
gc
->
gc_löe_ªadî_wq
 = 
	`Æloc_w‹kqueue
("pblk-gc-line-reader-wq",

664 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 
PBLK_GC_MAX_READERS
);

665 i‡(!
gc
->
gc_löe_ªadî_wq
) {

666 
	`pblk_îr
(
pblk
, "couldÇotállocate GCÜineÑeader workqueue\n");

667 
ªt
 = -
ENOMEM
;

668 
Áû_‰ì_ªadî_kthªad
;

672 
gc
->
gc_ªadî_wq
 = 
	`Æloc_w‹kqueue
("pblk-gc-line_wq",

673 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

674 i‡(!
gc
->
gc_ªadî_wq
) {

675 
	`pblk_îr
(
pblk
, "couldÇotállocate GCÑeader workqueue\n");

676 
ªt
 = -
ENOMEM
;

677 
Áû_‰ì_ªadî_löe_wq
;

680 
	`•ö_lock_öô
(&
gc
->
lock
);

681 
	`•ö_lock_öô
(&
gc
->
w_lock
);

682 
	`•ö_lock_öô
(&
gc
->
r_lock
);

684 
	`£ma_öô
(&
gc
->
gc_£m
, 
PBLK_GC_RQ_QD
);

686 
	`INIT_LIST_HEAD
(&
gc
->
w_li°
);

687 
	`INIT_LIST_HEAD
(&
gc
->
r_li°
);

691 
Áû_‰ì_ªadî_löe_wq
:

692 
	`de°roy_w‹kqueue
(
gc
->
gc_löe_ªadî_wq
);

693 
Áû_‰ì_ªadî_kthªad
:

694 
	`kthªad_°›
(
gc
->
gc_ªadî_ts
);

695 
Áû_‰ì_wrôî_kthªad
:

696 
	`kthªad_°›
(
gc
->
gc_wrôî_ts
);

697 
Áû_‰ì_maö_kthªad
:

698 
	`kthªad_°›
(
gc
->
gc_ts
);

700  
ªt
;

701 
	}
}

703 
	$pblk_gc_exô
(
pblk
 *pblk, 
boﬁ
 
gø˚ful
)

705 
pblk_gc
 *
gc
 = &
pblk
->gc;

707 
gc
->
gc_íabÀd
 = 0;

708 
	`dñ_timî_sync
(&
gc
->
gc_timî
);

709 
gc
->
gc_a˘ive
 = 0;

711 i‡(
gc
->
gc_ts
)

712 
	`kthªad_°›
(
gc
->
gc_ts
);

714 i‡(
gc
->
gc_ªadî_ts
)

715 
	`kthªad_°›
(
gc
->
gc_ªadî_ts
);

717 i‡(
gø˚ful
) {

718 
	`Êush_w‹kqueue
(
gc
->
gc_ªadî_wq
);

719 
	`Êush_w‹kqueue
(
gc
->
gc_löe_ªadî_wq
);

722 
	`de°roy_w‹kqueue
(
gc
->
gc_ªadî_wq
);

723 
	`de°roy_w‹kqueue
(
gc
->
gc_löe_ªadî_wq
);

725 i‡(
gc
->
gc_wrôî_ts
)

726 
	`kthªad_°›
(
gc
->
gc_wrôî_ts
);

727 
	}
}

	@pblk-init.c

22 
	~"pblk.h
"

23 
	~"pblk-åa˚.h
"

25 
	gwrôe_buf„r_size
;

27 
moduÀ_∑øm
(
wrôe_buf„r_size
, 
uöt
, 0644);

28 
MODULE_PARM_DESC
(
wrôe_buf„r_size
, "number ofÉntries iná write buffer");

30 
	spblk_globÆ_ˇches
 {

31 
kmem_ˇche
 *
	mws
;

32 
kmem_ˇche
 *
	mªc
;

33 
kmem_ˇche
 *
	mg_rq
;

34 
kmem_ˇche
 *
	mw_rq
;

36 
kªf
 
	mkªf
;

38 
muãx
 
	mmuãx
;

43 
pblk_globÆ_ˇches
 
	gpblk_ˇches
 = {

44 .
muãx
 = 
__MUTEX_INITIALIZER
(
pblk_ˇches
.mutex),

45 .
	gkªf
 = 
KREF_INIT
(0),

48 
bio_£t
 
	gpblk_bio_£t
;

50 
blk_qc_t
 
	$pblk_make_rq
(
ªque°_queue
 *
q
, 
bio
 *bio)

52 
pblk
 *pblk = 
q
->
queued©a
;

54 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_DISCARD
) {

55 
	`pblk_disˇrd
(
pblk
, 
bio
);

56 i‡(!(
bio
->
bi_›f
 & 
REQ_PREFLUSH
)) {

57 
	`bio_ídio
(
bio
);

58  
BLK_QC_T_NONE
;

65 i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
) {

66 
	`blk_queue_•lô
(
q
, &
bio
);

67 
	`pblk_submô_ªad
(
pblk
, 
bio
);

73 i‡(
	`pblk_gë_£cs
(
bio
Ë> 
	`pblk_æ_max_io
(&
pblk
->
æ
))

74 
	`blk_queue_•lô
(
q
, &
bio
);

76 
	`pblk_wrôe_to_ˇche
(
pblk
, 
bio
, 
PBLK_IOTYPE_USER
);

79  
BLK_QC_T_NONE
;

80 
	}
}

82 
size_t
 
	$pblk_å™s_m≠_size
(
pblk
 *pblk)

84 
íåy_size
 = 8;

86 i‡(
pblk
->
addrf_Àn
 < 32)

87 
íåy_size
 = 4;

89  
íåy_size
 * 
pblk
->
ˇ∑côy
;

90 
	}
}

92 #ifde‡
CONFIG_NVM_PBLK_DEBUG


93 
u32
 
	$pblk_l2p_¸c
(
pblk
 *pblk)

95 
size_t
 
m≠_size
;

96 
u32
 
¸c
 = ~(u32)0;

98 
m≠_size
 = 
	`pblk_å™s_m≠_size
(
pblk
);

99 
¸c
 = 
	`¸c32_À
(¸c, 
pblk
->
å™s_m≠
, 
m≠_size
);

100  
¸c
;

101 
	}
}

104 
	$pblk_l2p_‰ì
(
pblk
 *pblk)

106 
	`v‰ì
(
pblk
->
å™s_m≠
);

107 
	}
}

109 
	$pblk_l2p_ªcovî
(
pblk
 *pblk, 
boﬁ
 
Á˘‹y_öô
)

111 
pblk_löe
 *
löe
 = 
NULL
;

113 i‡(
Á˘‹y_öô
) {

114 
	`guid_gí
(&
pblk
->
ö°™˚_uuid
);

116 
löe
 = 
	`pblk_ªcov_l2p
(
pblk
);

117 i‡(
	`IS_ERR
(
löe
)) {

118 
	`pblk_îr
(
pblk
, "couldÇotÑecoverÜ2pÅable\n");

119  -
EFAULT
;

123 #ifde‡
CONFIG_NVM_PBLK_DEBUG


124 
	`pblk_öfo
(
pblk
, "öô: L2P CRC: %x\n", 
	`pblk_l2p_¸c
(pblk));

128 
	`pblk_gc_‰ì_fuŒ_löes
(
pblk
);

130 i‡(!
löe
) {

132 
löe
 = 
	`pblk_löe_gë_fú°_d©a
(
pblk
);

133 i‡(!
löe
)

134  -
EFAULT
;

138 
	}
}

140 
	$pblk_l2p_öô
(
pblk
 *pblk, 
boﬁ
 
Á˘‹y_öô
)

142 
£˘‹_t
 
i
;

143 
µa_addr
 
µa
;

144 
size_t
 
m≠_size
;

145 
ªt
 = 0;

147 
m≠_size
 = 
	`pblk_å™s_m≠_size
(
pblk
);

148 
pblk
->
å™s_m≠
 = 
	`__vmÆloc
(
m≠_size
, 
GFP_KERNEL
 | 
__GFP_NOWARN


149 | 
__GFP_RETRY_MAYFAIL
 | 
__GFP_HIGHMEM
,

150 
PAGE_KERNEL
);

151 i‡(!
pblk
->
å™s_m≠
) {

152 
	`pblk_îr
(
pblk
, "failedÅoállocate L2P (need %zu of memory)\n",

153 
m≠_size
);

154  -
ENOMEM
;

157 
	`pblk_µa_£t_em±y
(&
µa
);

159 
i
 = 0; i < 
pblk
->
ˇ∑côy
; i++)

160 
	`pblk_å™s_m≠_£t
(
pblk
, 
i
, 
µa
);

162 
ªt
 = 
	`pblk_l2p_ªcovî
(
pblk
, 
Á˘‹y_öô
);

163 i‡(
ªt
)

164 
	`v‰ì
(
pblk
->
å™s_m≠
);

166  
ªt
;

167 
	}
}

169 
	$pblk_rwb_‰ì
(
pblk
 *pblk)

171 i‡(
	`pblk_rb_ã¨_down_check
(&
pblk
->
rwb
))

172 
	`pblk_îr
(
pblk
, "write bufferÉrror onÅear down\n");

174 
	`pblk_rb_‰ì
(&
pblk
->
rwb
);

175 
	}
}

177 
	$pblk_rwb_öô
(
pblk
 *pblk)

179 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

180 
nvm_geo
 *
geo
 = &
dev
->geo;

181 
buf„r_size
;

182 
pgs_ö_buf„r
, 
thªshﬁd
;

184 
thªshﬁd
 = 
geo
->
mw_cunôs
 * geo->
Æl_luns
;

185 
pgs_ö_buf„r
 = (
	`max
(
geo
->
mw_cunôs
, geo->
ws_›t
) + geo->ws_opt)

186 * 
geo
->
Æl_luns
;

188 i‡(
wrôe_buf„r_size
 && (wrôe_buf„r_sizê> 
pgs_ö_buf„r
))

189 
buf„r_size
 = 
wrôe_buf„r_size
;

191 
buf„r_size
 = 
pgs_ö_buf„r
;

193  
	`pblk_rb_öô
(&
pblk
->
rwb
, 
buf„r_size
, 
thªshﬁd
, 
geo
->
c£cs
);

194 
	}
}

196 
	$pblk_£t_addrf_12
(
pblk
 *pblk, 
nvm_geo
 *
geo
,

197 
nvm_addrf_12
 *
d°
)

199 
nvm_addrf_12
 *
§c
 = (nvm_addrf_12 *)&
geo
->
addrf
;

200 
powî_Àn
;

203 
powî_Àn
 = 
	`gë_cou¡_‹dî
(
geo
->
num_ch
);

204 i‡(1 << 
powî_Àn
 !
geo
->
num_ch
) {

205 
	`pblk_îr
(
pblk
, "supports onlyÖower-of-two channel config.\n");

206  -
EINVAL
;

208 
d°
->
ch_Àn
 = 
powî_Àn
;

210 
powî_Àn
 = 
	`gë_cou¡_‹dî
(
geo
->
num_lun
);

211 i‡(1 << 
powî_Àn
 !
geo
->
num_lun
) {

212 
	`pblk_îr
(
pblk
, "supports onlyÖower-of-two LUN config.\n");

213  -
EINVAL
;

215 
d°
->
lun_Àn
 = 
powî_Àn
;

217 
d°
->
blk_Àn
 = 
§c
->blk_len;

218 
d°
->
pg_Àn
 = 
§c
->pg_len;

219 
d°
->
∂n_Àn
 = 
§c
->pln_len;

220 
d°
->
£c_Àn
 = 
§c
->sec_len;

222 
d°
->
£c_off£t
 = 0;

223 
d°
->
∂n_off£t
 = d°->
£c_Àn
;

224 
d°
->
ch_off£t
 = d°->
∂n_off£t
 + d°->
∂n_Àn
;

225 
d°
->
lun_off£t
 = d°->
ch_off£t
 + d°->
ch_Àn
;

226 
d°
->
pg_off£t
 = d°->
lun_off£t
 + d°->
lun_Àn
;

227 
d°
->
blk_off£t
 = d°->
pg_off£t
 + d°->
pg_Àn
;

229 
d°
->
£c_mask
 = ((1ULL << d°->
£c_Àn
Ë- 1Ë<< d°->
£c_off£t
;

230 
d°
->
∂n_mask
 = ((1ULL << d°->
∂n_Àn
Ë- 1Ë<< d°->
∂n_off£t
;

231 
d°
->
ch_mask
 = ((1ULL << d°->
ch_Àn
Ë- 1Ë<< d°->
ch_off£t
;

232 
d°
->
lun_mask
 = ((1ULL << d°->
lun_Àn
Ë- 1Ë<< d°->
lun_off£t
;

233 
d°
->
pg_mask
 = ((1ULL << d°->
pg_Àn
Ë- 1Ë<< d°->
pg_off£t
;

234 
d°
->
blk_mask
 = ((1ULL << d°->
blk_Àn
Ë- 1Ë<< d°->
blk_off£t
;

236  
d°
->
blk_off£t
 + 
§c
->
blk_Àn
;

237 
	}
}

239 
	$pblk_£t_addrf_20
(
nvm_geo
 *
geo
, 
nvm_addrf
 *
ad°
,

240 
pblk_addrf
 *
ud°
)

242 
nvm_addrf
 *
§c
 = &
geo
->
addrf
;

244 
ad°
->
ch_Àn
 = 
	`gë_cou¡_‹dî
(
geo
->
num_ch
);

245 
ad°
->
lun_Àn
 = 
	`gë_cou¡_‹dî
(
geo
->
num_lun
);

246 
ad°
->
chk_Àn
 = 
§c
->chk_len;

247 
ad°
->
£c_Àn
 = 
§c
->sec_len;

249 
ad°
->
£c_off£t
 = 0;

250 
ad°
->
ch_off£t
 =ád°->
£c_Àn
;

251 
ad°
->
lun_off£t
 =ád°->
ch_off£t
 +ád°->
ch_Àn
;

252 
ad°
->
chk_off£t
 =ád°->
lun_off£t
 +ád°->
lun_Àn
;

254 
ad°
->
£c_mask
 = ((1ULL <<ád°->
£c_Àn
Ë- 1Ë<<ád°->
£c_off£t
;

255 
ad°
->
chk_mask
 = ((1ULL <<ád°->
chk_Àn
Ë- 1Ë<<ád°->
chk_off£t
;

256 
ad°
->
lun_mask
 = ((1ULL <<ád°->
lun_Àn
Ë- 1Ë<<ád°->
lun_off£t
;

257 
ad°
->
ch_mask
 = ((1ULL <<ád°->
ch_Àn
Ë- 1Ë<<ád°->
ch_off£t
;

259 
ud°
->
£c_°rùe
 = 
geo
->
ws_›t
;

260 
ud°
->
ch_°rùe
 = 
geo
->
num_ch
;

261 
ud°
->
lun_°rùe
 = 
geo
->
num_lun
;

263 
ud°
->
£c_lun_°rùe
 = ud°->
£c_°rùe
 * ud°->
ch_°rùe
;

264 
ud°
->
£c_ws_°rùe
 = ud°->
£c_lun_°rùe
 * ud°->
lun_°rùe
;

266  
ad°
->
chk_off£t
 +ád°->
chk_Àn
;

267 
	}
}

269 
	$pblk_£t_addrf
(
pblk
 *pblk)

271 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

272 
nvm_geo
 *
geo
 = &
dev
->geo;

273 
mod
;

275 
geo
->
vîsi⁄
) {

276 
NVM_OCSSD_SPEC_12
:

277 
	`div_u64_ªm
(
geo
->
˛ba
, 
pblk
->
mö_wrôe_pgs
, &
mod
);

278 i‡(
mod
) {

279 
	`pblk_îr
(
pblk
, "bad configuration of sectors/pages\n");

280  -
EINVAL
;

283 
pblk
->
addrf_Àn
 = 
	`pblk_£t_addrf_12
’blk, 
geo
,

284 (*)&
pblk
->
addrf
);

286 
NVM_OCSSD_SPEC_20
:

287 
pblk
->
addrf_Àn
 = 
	`pblk_£t_addrf_20
(
geo
, (*)&pblk->
addrf
,

288 &
pblk
->
uaddrf
);

291 
	`pblk_îr
(
pblk
, "OCSSDÑevisionÇot supported (%d)\n",

292 
geo
->
vîsi⁄
);

293  -
EINVAL
;

297 
	}
}

299 
	$pblk_¸óã_globÆ_ˇches
()

302 
pblk_ˇches
.
ws
 = 
	`kmem_ˇche_¸óã
("pblk_blk_ws",

303 (
pblk_löe_ws
), 0, 0, 
NULL
);

304 i‡(!
pblk_ˇches
.
ws
)

305  -
ENOMEM
;

307 
pblk_ˇches
.
ªc
 = 
	`kmem_ˇche_¸óã
("pblk_rec",

308 (
pblk_ªc_˘x
), 0, 0, 
NULL
);

309 i‡(!
pblk_ˇches
.
ªc
)

310 
Áû_de°roy_ws
;

312 
pblk_ˇches
.
g_rq
 = 
	`kmem_ˇche_¸óã
("pblk_g_rq", 
pblk_g_rq_size
,

313 0, 0, 
NULL
);

314 i‡(!
pblk_ˇches
.
g_rq
)

315 
Áû_de°roy_ªc
;

317 
pblk_ˇches
.
w_rq
 = 
	`kmem_ˇche_¸óã
("pblk_w_rq", 
pblk_w_rq_size
,

318 0, 0, 
NULL
);

319 i‡(!
pblk_ˇches
.
w_rq
)

320 
Áû_de°roy_g_rq
;

324 
Áû_de°roy_g_rq
:

325 
	`kmem_ˇche_de°roy
(
pblk_ˇches
.
g_rq
);

326 
Áû_de°roy_ªc
:

327 
	`kmem_ˇche_de°roy
(
pblk_ˇches
.
ªc
);

328 
Áû_de°roy_ws
:

329 
	`kmem_ˇche_de°roy
(
pblk_ˇches
.
ws
);

331  -
ENOMEM
;

332 
	}
}

334 
	$pblk_gë_globÆ_ˇches
()

336 
ªt
 = 0;

338 
	`muãx_lock
(&
pblk_ˇches
.
muãx
);

340 i‡(
	`kªf_gë_u∆ess_zîo
(&
pblk_ˇches
.
kªf
))

341 
out
;

343 
ªt
 = 
	`pblk_¸óã_globÆ_ˇches
();

344 i‡(!
ªt
)

345 
	`kªf_öô
(&
pblk_ˇches
.
kªf
);

347 
out
:

348 
	`muãx_u∆ock
(&
pblk_ˇches
.
muãx
);

349  
ªt
;

350 
	}
}

352 
	$pblk_de°roy_globÆ_ˇches
(
kªf
 *
ªf
)

354 
pblk_globÆ_ˇches
 *
c
;

356 
c
 = 
	`c⁄èöî_of
(
ªf
, 
pblk_globÆ_ˇches
, 
kªf
);

358 
	`kmem_ˇche_de°roy
(
c
->
ws
);

359 
	`kmem_ˇche_de°roy
(
c
->
ªc
);

360 
	`kmem_ˇche_de°roy
(
c
->
g_rq
);

361 
	`kmem_ˇche_de°roy
(
c
->
w_rq
);

362 
	}
}

364 
	$pblk_put_globÆ_ˇches
()

366 
	`muãx_lock
(&
pblk_ˇches
.
muãx
);

367 
	`kªf_put
(&
pblk_ˇches
.
kªf
, 
pblk_de°roy_globÆ_ˇches
);

368 
	`muãx_u∆ock
(&
pblk_ˇches
.
muãx
);

369 
	}
}

371 
	$pblk_c‹e_öô
(
pblk
 *pblk)

373 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

374 
nvm_geo
 *
geo
 = &
dev
->geo;

375 
ªt
, 
max_wrôe_µas
;

377 
	`©omic64_£t
(&
pblk
->
u£r_wa
, 0);

378 
	`©omic64_£t
(&
pblk
->
∑d_wa
, 0);

379 
	`©omic64_£t
(&
pblk
->
gc_wa
, 0);

380 
pblk
->
u£r_r°_wa
 = 0;

381 
pblk
->
∑d_r°_wa
 = 0;

382 
pblk
->
gc_r°_wa
 = 0;

384 
	`©omic64_£t
(&
pblk
->
ƒ_Êush
, 0);

385 
pblk
->
ƒ_Êush_r°
 = 0;

387 
pblk
->
mö_wrôe_pgs
 = 
geo
->
ws_›t
;

388 
pblk
->
mö_wrôe_pgs_d©a
 =Öblk->
mö_wrôe_pgs
;

389 
max_wrôe_µas
 = 
pblk
->
mö_wrôe_pgs
 * 
geo
->
Æl_luns
;

390 
pblk
->
max_wrôe_pgs
 = 
	`mö_t
(, 
max_wrôe_µas
, 
NVM_MAX_VLBA
);

391 
pblk
->
max_wrôe_pgs
 = 
	`mö_t
(,Öblk->max_write_pgs,

392 
	`queue_max_hw_£˘‹s
(
dev
->
q
Ë/ (
geo
->
c£cs
 >> 
SECTOR_SHIFT
));

393 
	`pblk_£t_£c_≥r_wrôe
(
pblk
,Öblk->
mö_wrôe_pgs
);

395 
pblk
->
oob_mëa_size
 = 
geo
->
sos
;

396 i‡(!
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
)) {

404 i‡(
pblk
->
mö_wrôe_pgs


405 * (
pblk_£c_mëa
Ë> 
PAGE_SIZE
) {

414 
	`pblk_îr
(
pblk
, "Not supported min write size\n");

415  -
EINVAL
;

423 
pblk
->
max_wrôe_pgs
 =Öblk->
mö_wrôe_pgs
;

424 
pblk
->
mö_wrôe_pgs_d©a
 =Öblk->
mö_wrôe_pgs
 - 1;

427 
pblk
->
∑d_di°
 = 
	`kˇŒoc
’blk->
mö_wrôe_pgs
 - 1, (
©omic64_t
),

428 
GFP_KERNEL
);

429 i‡(!
pblk
->
∑d_di°
)

430  -
ENOMEM
;

432 i‡(
	`pblk_gë_globÆ_ˇches
())

433 
Áû_‰ì_∑d_di°
;

436 
ªt
 = 
	`mempoﬁ_öô_∑ge_poﬁ
(&
pblk
->
∑ge_bio_poﬁ
, 
NVM_MAX_VLBA
, 0);

437 i‡(
ªt
)

438 
‰ì_globÆ_ˇches
;

440 
ªt
 = 
	`mempoﬁ_öô_¶ab_poﬁ
(&
pblk
->
gí_ws_poﬁ
, 
PBLK_GEN_WS_POOL_SIZE
,

441 
pblk_ˇches
.
ws
);

442 i‡(
ªt
)

443 
‰ì_∑ge_bio_poﬁ
;

445 
ªt
 = 
	`mempoﬁ_öô_¶ab_poﬁ
(&
pblk
->
ªc_poﬁ
, 
geo
->
Æl_luns
,

446 
pblk_ˇches
.
ªc
);

447 i‡(
ªt
)

448 
‰ì_gí_ws_poﬁ
;

450 
ªt
 = 
	`mempoﬁ_öô_¶ab_poﬁ
(&
pblk
->
r_rq_poﬁ
, 
geo
->
Æl_luns
,

451 
pblk_ˇches
.
g_rq
);

452 i‡(
ªt
)

453 
‰ì_ªc_poﬁ
;

455 
ªt
 = 
	`mempoﬁ_öô_¶ab_poﬁ
(&
pblk
->
e_rq_poﬁ
, 
geo
->
Æl_luns
,

456 
pblk_ˇches
.
g_rq
);

457 i‡(
ªt
)

458 
‰ì_r_rq_poﬁ
;

460 
ªt
 = 
	`mempoﬁ_öô_¶ab_poﬁ
(&
pblk
->
w_rq_poﬁ
, 
geo
->
Æl_luns
,

461 
pblk_ˇches
.
w_rq
);

462 i‡(
ªt
)

463 
‰ì_e_rq_poﬁ
;

465 
pblk
->
˛o£_wq
 = 
	`Æloc_w‹kqueue
("pblk-close-wq",

466 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 
PBLK_NR_CLOSE_JOBS
);

467 i‡(!
pblk
->
˛o£_wq
)

468 
‰ì_w_rq_poﬁ
;

470 
pblk
->
bb_wq
 = 
	`Æloc_w‹kqueue
("pblk-bb-wq",

471 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 0);

472 i‡(!
pblk
->
bb_wq
)

473 
‰ì_˛o£_wq
;

475 
pblk
->
r_íd_wq
 = 
	`Æloc_w‹kqueue
("pblk-read-end-wq",

476 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 0);

477 i‡(!
pblk
->
r_íd_wq
)

478 
‰ì_bb_wq
;

480 i‡(
	`pblk_£t_addrf
(
pblk
))

481 
‰ì_r_íd_wq
;

483 
	`INIT_LIST_HEAD
(&
pblk
->
com∂_li°
);

484 
	`INIT_LIST_HEAD
(&
pblk
->
ªsubmô_li°
);

488 
‰ì_r_íd_wq
:

489 
	`de°roy_w‹kqueue
(
pblk
->
r_íd_wq
);

490 
‰ì_bb_wq
:

491 
	`de°roy_w‹kqueue
(
pblk
->
bb_wq
);

492 
‰ì_˛o£_wq
:

493 
	`de°roy_w‹kqueue
(
pblk
->
˛o£_wq
);

494 
‰ì_w_rq_poﬁ
:

495 
	`mempoﬁ_exô
(&
pblk
->
w_rq_poﬁ
);

496 
‰ì_e_rq_poﬁ
:

497 
	`mempoﬁ_exô
(&
pblk
->
e_rq_poﬁ
);

498 
‰ì_r_rq_poﬁ
:

499 
	`mempoﬁ_exô
(&
pblk
->
r_rq_poﬁ
);

500 
‰ì_ªc_poﬁ
:

501 
	`mempoﬁ_exô
(&
pblk
->
ªc_poﬁ
);

502 
‰ì_gí_ws_poﬁ
:

503 
	`mempoﬁ_exô
(&
pblk
->
gí_ws_poﬁ
);

504 
‰ì_∑ge_bio_poﬁ
:

505 
	`mempoﬁ_exô
(&
pblk
->
∑ge_bio_poﬁ
);

506 
‰ì_globÆ_ˇches
:

507 
	`pblk_put_globÆ_ˇches
();

508 
Áû_‰ì_∑d_di°
:

509 
	`k‰ì
(
pblk
->
∑d_di°
);

510  -
ENOMEM
;

511 
	}
}

513 
	$pblk_c‹e_‰ì
(
pblk
 *pblk)

515 i‡(
pblk
->
˛o£_wq
)

516 
	`de°roy_w‹kqueue
(
pblk
->
˛o£_wq
);

518 i‡(
pblk
->
r_íd_wq
)

519 
	`de°roy_w‹kqueue
(
pblk
->
r_íd_wq
);

521 i‡(
pblk
->
bb_wq
)

522 
	`de°roy_w‹kqueue
(
pblk
->
bb_wq
);

524 
	`mempoﬁ_exô
(&
pblk
->
∑ge_bio_poﬁ
);

525 
	`mempoﬁ_exô
(&
pblk
->
gí_ws_poﬁ
);

526 
	`mempoﬁ_exô
(&
pblk
->
ªc_poﬁ
);

527 
	`mempoﬁ_exô
(&
pblk
->
r_rq_poﬁ
);

528 
	`mempoﬁ_exô
(&
pblk
->
e_rq_poﬁ
);

529 
	`mempoﬁ_exô
(&
pblk
->
w_rq_poﬁ
);

531 
	`pblk_put_globÆ_ˇches
();

532 
	`k‰ì
(
pblk
->
∑d_di°
);

533 
	}
}

535 
	$pblk_löe_mg_‰ì
(
pblk
 *pblk)

537 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

538 
i
;

540 
	`k‰ì
(
l_mg
->
bb_ãm∂©e
);

541 
	`k‰ì
(
l_mg
->
bb_aux
);

542 
	`k‰ì
(
l_mg
->
vsc_li°
);

544 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

545 
	`k‰ì
(
l_mg
->
¶öe_mëa
[
i
]);

546 
	`kv‰ì
(
l_mg
->
ñöe_mëa
[
i
]->
buf
);

547 
	`k‰ì
(
l_mg
->
ñöe_mëa
[
i
]);

550 
	`mempoﬁ_de°roy
(
l_mg
->
bôm≠_poﬁ
);

551 
	`kmem_ˇche_de°roy
(
l_mg
->
bôm≠_ˇche
);

552 
	}
}

554 
	$pblk_löe_mëa_‰ì
(
pblk_löe_mgmt
 *
l_mg
,

555 
pblk_löe
 *
löe
)

557 
pblk_w_îr_gc
 *
w_îr_gc
 = 
löe
->w_err_gc;

559 
	`k‰ì
(
löe
->
blk_bôm≠
);

560 
	`k‰ì
(
löe
->
îa£_bôm≠
);

561 
	`k‰ì
(
löe
->
chks
);

563 
	`kv‰ì
(
w_îr_gc
->
lba_li°
);

564 
	`k‰ì
(
w_îr_gc
);

565 
	}
}

567 
	$pblk_löes_‰ì
(
pblk
 *pblk)

569 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

570 
pblk_löe
 *
löe
;

571 
i
;

573 
i
 = 0; i < 
l_mg
->
ƒ_löes
; i++) {

574 
löe
 = &
pblk
->
löes
[
i
];

576 
	`pblk_löe_‰ì
(
löe
);

577 
	`pblk_löe_mëa_‰ì
(
l_mg
, 
löe
);

580 
	`pblk_löe_mg_‰ì
(
pblk
);

582 
	`k‰ì
(
pblk
->
luns
);

583 
	`k‰ì
(
pblk
->
löes
);

584 
	}
}

586 
	$pblk_luns_öô
(
pblk
 *pblk)

588 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

589 
nvm_geo
 *
geo
 = &
dev
->geo;

590 
pblk_lun
 *
æun
;

591 
i
;

594 i‡(
geo
->
num_lun
 < 0) {

595 
	`pblk_îr
(
pblk
, "unbalanced LUN config.\n");

596  -
EINVAL
;

599 
pblk
->
luns
 = 
	`kˇŒoc
(
geo
->
Æl_luns
, (
pblk_lun
),

600 
GFP_KERNEL
);

601 i‡(!
pblk
->
luns
)

602  -
ENOMEM
;

604 
i
 = 0; i < 
geo
->
Æl_luns
; i++) {

606 
ch
 = 
i
 % 
geo
->
num_ch
;

607 
lun_øw
 = 
i
 / 
geo
->
num_ch
;

608 
lunid
 = 
lun_øw
 + 
ch
 * 
geo
->
num_lun
;

610 
æun
 = &
pblk
->
luns
[
i
];

611 
æun
->
bµa
 = 
dev
->
luns
[
lunid
];

613 
	`£ma_öô
(&
æun
->
wr_£m
, 1);

617 
	}
}

620 
	$ˇlc_emëa_Àn
(
pblk
 *pblk)

622 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

623 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

624 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

625 
nvm_geo
 *
geo
 = &
dev
->geo;

628 
lm
->
emëa_£c
[1] = 
	`DIV_ROUND_UP
(

629 (
löe_emëa
Ë+ 
lm
->
blk_bôm≠_Àn
 +

630 (
wa_cou¡îs
), 
geo
->
c£cs
);

631 
lm
->
emëa_Àn
[1] =Üm->
emëa_£c
[1] * 
geo
->
c£cs
;

634 
lm
->
d£c_≥r_löe
 =Üm->
£c_≥r_löe
 -Üm->
emëa_£c
[0];

635 
lm
->
emëa_£c
[2] = 
	`DIV_ROUND_UP
÷m->
d£c_≥r_löe
 * (
u64
),

636 
geo
->
c£cs
);

637 
lm
->
emëa_Àn
[2] =Üm->
emëa_£c
[2] * 
geo
->
c£cs
;

639 
lm
->
emëa_£c
[3] = 
	`DIV_ROUND_UP
(
l_mg
->
ƒ_löes
 * (
u32
),

640 
geo
->
c£cs
);

641 
lm
->
emëa_Àn
[3] =Üm->
emëa_£c
[3] * 
geo
->
c£cs
;

643 
lm
->
vsc_li°_Àn
 = 
l_mg
->
ƒ_löes
 * (
u32
);

645  (
lm
->
emëa_Àn
[1] +Üm->emeta_len[2] +Üm->emeta_len[3]);

646 
	}
}

648 
	$pblk_£t_¥ovisi⁄
(
pblk
 *pblk, 
ƒ_‰ì_chks
)

650 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

651 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

652 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

653 
nvm_geo
 *
geo
 = &
dev
->geo;

654 
£˘‹_t
 
¥ovisi⁄ed
;

655 
£c_mëa
, 
blk_mëa
, 
˛ba
;

656 
möimum
;

658 i‡(
geo
->
›
 =
NVM_TARGET_DEFAULT_OP
)

659 
pblk
->
›
 = 
PBLK_DEFAULT_OP
;

661 
pblk
->
›
 = 
geo
->op;

663 
möimum
 = 
	`pblk_gë_mö_chks
(
pblk
);

664 
¥ovisi⁄ed
 = 
ƒ_‰ì_chks
;

665 
¥ovisi⁄ed
 *(100 - 
pblk
->
›
);

666 
	`£˘‹_div
(
¥ovisi⁄ed
, 100);

668 i‡((
ƒ_‰ì_chks
 - 
¥ovisi⁄ed
Ë< 
möimum
) {

669 i‡(
geo
->
›
 !
NVM_TARGET_DEFAULT_OP
) {

670 
	`pblk_îr
(
pblk
, "OPÅoo smallÅo createá sane instance\n");

671  -
EINTR
;

678 
¥ovisi⁄ed
 = 
ƒ_‰ì_chks
 - 
möimum
;

679 
pblk
->
›
 = (100 * 
möimum
Ë/ 
ƒ_‰ì_chks
;

680 
	`pblk_öfo
(
pblk
, "Default OP insufficient,ádjusting OPÅo %d\n",

681 
pblk
->
›
);

684 
pblk
->
›_blks
 = 
ƒ_‰ì_chks
 - 
¥ovisi⁄ed
;

689 
pblk
->
æ
.
tŸÆ_blocks
 = 
ƒ_‰ì_chks
;

692 
£c_mëa
 = (
lm
->
smëa_£c
 +Üm->
emëa_£c
[0]Ë* 
l_mg
->
ƒ_‰ì_löes
;

693 
blk_mëa
 = 
	`DIV_ROUND_UP
(
£c_mëa
, 
geo
->
˛ba
);

695 
˛ba
 = (
geo
->˛b®/ 
pblk
->
mö_wrôe_pgs
Ë*Öblk->
mö_wrôe_pgs_d©a
;

696 
pblk
->
ˇ∑côy
 = (
¥ovisi⁄ed
 - 
blk_mëa
Ë* 
˛ba
;

698 
	`©omic_£t
(&
pblk
->
æ
.
‰ì_blocks
, 
ƒ_‰ì_chks
);

699 
	`©omic_£t
(&
pblk
->
æ
.
‰ì_u£r_blocks
, 
ƒ_‰ì_chks
);

702 
	}
}

704 
	$pblk_£tup_löe_mëa_chk
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

705 
nvm_chk_mëa
 *
mëa
)

707 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

708 
nvm_geo
 *
geo
 = &
dev
->geo;

709 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

710 
i
, 
ƒ_bad_chks
 = 0;

712 
i
 = 0; i < 
lm
->
blk_≥r_löe
; i++) {

713 
pblk_lun
 *
æun
 = &
pblk
->
luns
[
i
];

714 
nvm_chk_mëa
 *
chunk
;

715 
nvm_chk_mëa
 *
chunk_mëa
;

716 
µa_addr
 
µa
;

717 
pos
;

719 
µa
 = 
æun
->
bµa
;

720 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

721 
chunk
 = &
löe
->
chks
[
pos
];

723 
µa
.
m
.
chk
 = 
löe
->
id
;

724 
chunk_mëa
 = 
	`pblk_chunk_gë_off
(
pblk
, 
mëa
, 
µa
);

726 
chunk
->
°©e
 = 
chunk_mëa
->state;

727 
chunk
->
ty≥
 = 
chunk_mëa
->type;

728 
chunk
->
wi
 = 
chunk_mëa
->wi;

729 
chunk
->
¶ba
 = 
chunk_mëa
->slba;

730 
chunk
->
˙lb
 = 
chunk_mëa
->cnlb;

731 
chunk
->
wp
 = 
chunk_mëa
->wp;

733 
	`åa˚_pblk_chunk_°©e
(
	`pblk_disk_«me
(
pblk
), &
µa
,

734 
chunk
->
°©e
);

736 i‡(
chunk
->
ty≥
 & 
NVM_CHK_TP_SZ_SPEC
) {

737 
	`WARN_ONCE
(1, "pblk: custom-sized chunks unsupported\n");

741 i‡(!(
chunk
->
°©e
 & 
NVM_CHK_ST_OFFLINE
))

744 
	`£t_bô
(
pos
, 
löe
->
blk_bôm≠
);

745 
ƒ_bad_chks
++;

748  
ƒ_bad_chks
;

749 
	}
}

751 
	$pblk_£tup_löe_mëa
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

752 *
chunk_mëa
, 
löe_id
)

754 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

755 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

756 
ƒ_bad_chks
, 
chk_ö_löe
;

758 
löe
->
pblk
 =Öblk;

759 
löe
->
id
 = 
löe_id
;

760 
löe
->
ty≥
 = 
PBLK_LINETYPE_FREE
;

761 
löe
->
°©e
 = 
PBLK_LINESTATE_NEW
;

762 
löe
->
gc_group
 = 
PBLK_LINEGC_NONE
;

763 
löe
->
vsc
 = &
l_mg
->
vsc_li°
[
löe_id
];

764 
	`•ö_lock_öô
(&
löe
->
lock
);

766 
ƒ_bad_chks
 = 
	`pblk_£tup_löe_mëa_chk
(
pblk
, 
löe
, 
chunk_mëa
);

768 
chk_ö_löe
 = 
lm
->
blk_≥r_löe
 - 
ƒ_bad_chks
;

769 i‡(
ƒ_bad_chks
 < 0 ||Çr_bad_chk†> 
lm
->
blk_≥r_löe
 ||

770 
chk_ö_löe
 < 
lm
->
mö_blk_löe
) {

771 
löe
->
°©e
 = 
PBLK_LINESTATE_BAD
;

772 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
bad_li°
);

776 
	`©omic_£t
(&
löe
->
blk_ö_löe
, 
chk_ö_löe
);

777 
	`li°_add_èû
(&
löe
->
li°
, &
l_mg
->
‰ì_li°
);

778 
l_mg
->
ƒ_‰ì_löes
++;

780  
chk_ö_löe
;

781 
	}
}

783 
	$pblk_Æloc_löe_mëa
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

785 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

787 
löe
->
blk_bôm≠
 = 
	`kzÆloc
(
lm
->
blk_bôm≠_Àn
, 
GFP_KERNEL
);

788 i‡(!
löe
->
blk_bôm≠
)

789  -
ENOMEM
;

791 
löe
->
îa£_bôm≠
 = 
	`kzÆloc
(
lm
->
blk_bôm≠_Àn
, 
GFP_KERNEL
);

792 i‡(!
löe
->
îa£_bôm≠
)

793 
‰ì_blk_bôm≠
;

796 
löe
->
chks
 = 
	`kmÆloc_¨øy
(
lm
->
blk_≥r_löe
,

797 (
nvm_chk_mëa
), 
GFP_KERNEL
);

798 i‡(!
löe
->
chks
)

799 
‰ì_îa£_bôm≠
;

801 
löe
->
w_îr_gc
 = 
	`kzÆloc
((
pblk_w_îr_gc
), 
GFP_KERNEL
);

802 i‡(!
löe
->
w_îr_gc
)

803 
‰ì_chks
;

807 
‰ì_chks
:

808 
	`k‰ì
(
löe
->
chks
);

809 
‰ì_îa£_bôm≠
:

810 
	`k‰ì
(
löe
->
îa£_bôm≠
);

811 
‰ì_blk_bôm≠
:

812 
	`k‰ì
(
löe
->
blk_bôm≠
);

813  -
ENOMEM
;

814 
	}
}

816 
	$pblk_löe_mg_öô
(
pblk
 *pblk)

818 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

819 
nvm_geo
 *
geo
 = &
dev
->geo;

820 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

821 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

822 
i
, 
bb_di°™˚
;

824 
l_mg
->
ƒ_löes
 = 
geo
->
num_chk
;

825 
l_mg
->
log_löe
 =Ü_mg->
d©a_löe
 = 
NULL
;

826 
l_mg
->
l_£q_ƒ
 =Ü_mg->
d_£q_ƒ
 = 0;

827 
l_mg
->
ƒ_‰ì_löes
 = 0;

828 
	`bôm≠_zîo
(&
l_mg
->
mëa_bôm≠
, 
PBLK_DATA_LINES
);

830 
	`INIT_LIST_HEAD
(&
l_mg
->
‰ì_li°
);

831 
	`INIT_LIST_HEAD
(&
l_mg
->
c‹ru±_li°
);

832 
	`INIT_LIST_HEAD
(&
l_mg
->
bad_li°
);

833 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_fuŒ_li°
);

834 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_high_li°
);

835 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_mid_li°
);

836 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_low_li°
);

837 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_em±y_li°
);

838 
	`INIT_LIST_HEAD
(&
l_mg
->
gc_wîr_li°
);

840 
	`INIT_LIST_HEAD
(&
l_mg
->
emëa_li°
);

842 
l_mg
->
gc_li°s
[0] = &l_mg->
gc_wîr_li°
;

843 
l_mg
->
gc_li°s
[1] = &l_mg->
gc_high_li°
;

844 
l_mg
->
gc_li°s
[2] = &l_mg->
gc_mid_li°
;

845 
l_mg
->
gc_li°s
[3] = &l_mg->
gc_low_li°
;

847 
	`•ö_lock_öô
(&
l_mg
->
‰ì_lock
);

848 
	`•ö_lock_öô
(&
l_mg
->
˛o£_lock
);

849 
	`•ö_lock_öô
(&
l_mg
->
gc_lock
);

851 
l_mg
->
vsc_li°
 = 
	`kˇŒoc
÷_mg->
ƒ_löes
, (
__À32
), 
GFP_KERNEL
);

852 i‡(!
l_mg
->
vsc_li°
)

853 
Áû
;

855 
l_mg
->
bb_ãm∂©e
 = 
	`kzÆloc
(
lm
->
£c_bôm≠_Àn
, 
GFP_KERNEL
);

856 i‡(!
l_mg
->
bb_ãm∂©e
)

857 
Áû_‰ì_vsc_li°
;

859 
l_mg
->
bb_aux
 = 
	`kzÆloc
(
lm
->
£c_bôm≠_Àn
, 
GFP_KERNEL
);

860 i‡(!
l_mg
->
bb_aux
)

861 
Áû_‰ì_bb_ãm∂©e
;

866 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

867 
l_mg
->
¶öe_mëa
[
i
] = 
	`kmÆloc
(
lm
->
smëa_Àn
, 
GFP_KERNEL
);

868 i‡(!
l_mg
->
¶öe_mëa
[
i
])

869 
Áû_‰ì_smëa
;

872 
l_mg
->
bôm≠_ˇche
 = 
	`kmem_ˇche_¸óã
("pblk_lm_bitmap",

873 
lm
->
£c_bôm≠_Àn
, 0, 0, 
NULL
);

874 i‡(!
l_mg
->
bôm≠_ˇche
)

875 
Áû_‰ì_smëa
;

878 
l_mg
->
bôm≠_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
PBLK_DATA_LINES
 * 2,

879 
l_mg
->
bôm≠_ˇche
);

880 i‡(!
l_mg
->
bôm≠_poﬁ
)

881 
Áû_de°roy_bôm≠_ˇche
;

886 
i
 = 0; i < 
PBLK_DATA_LINES
; i++) {

887 
pblk_emëa
 *
emëa
;

889 
emëa
 = 
	`kmÆloc
((
pblk_emëa
), 
GFP_KERNEL
);

890 i‡(!
emëa
)

891 
Áû_‰ì_emëa
;

893 
emëa
->
buf
 = 
	`kvmÆloc
(
lm
->
emëa_Àn
[0], 
GFP_KERNEL
);

894 i‡(!
emëa
->
buf
) {

895 
	`k‰ì
(
emëa
);

896 
Áû_‰ì_emëa
;

899 
emëa
->
ƒ_íåõs
 = 
lm
->
emëa_£c
[0];

900 
l_mg
->
ñöe_mëa
[
i
] = 
emëa
;

903 
i
 = 0; i < 
l_mg
->
ƒ_löes
; i++)

904 
l_mg
->
vsc_li°
[
i
] = 
	`˝u_to_À32
(
EMPTY_ENTRY
);

906 
bb_di°™˚
 = (
geo
->
Æl_luns
Ë* geo->
ws_›t
;

907 
i
 = 0; i < 
lm
->
£c_≥r_löe
; i +
bb_di°™˚
)

908 
	`bôm≠_£t
(
l_mg
->
bb_ãm∂©e
, 
i
, 
geo
->
ws_›t
);

912 
Áû_‰ì_emëa
:

913 --
i
 >= 0) {

914 
	`kv‰ì
(
l_mg
->
ñöe_mëa
[
i
]->
buf
);

915 
	`k‰ì
(
l_mg
->
ñöe_mëa
[
i
]);

918 
	`mempoﬁ_de°roy
(
l_mg
->
bôm≠_poﬁ
);

919 
Áû_de°roy_bôm≠_ˇche
:

920 
	`kmem_ˇche_de°roy
(
l_mg
->
bôm≠_ˇche
);

921 
Áû_‰ì_smëa
:

922 
i
 = 0; i < 
PBLK_DATA_LINES
; i++)

923 
	`k‰ì
(
l_mg
->
¶öe_mëa
[
i
]);

924 
	`k‰ì
(
l_mg
->
bb_aux
);

925 
Áû_‰ì_bb_ãm∂©e
:

926 
	`k‰ì
(
l_mg
->
bb_ãm∂©e
);

927 
Áû_‰ì_vsc_li°
:

928 
	`k‰ì
(
l_mg
->
vsc_li°
);

929 
Áû
:

930  -
ENOMEM
;

931 
	}
}

933 
	$pblk_löe_mëa_öô
(
pblk
 *pblk)

935 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

936 
nvm_geo
 *
geo
 = &
dev
->geo;

937 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

938 
smëa_Àn
, 
emëa_Àn
;

939 
i
;

941 
lm
->
£c_≥r_löe
 = 
geo
->
˛ba
 * geo->
Æl_luns
;

942 
lm
->
blk_≥r_löe
 = 
geo
->
Æl_luns
;

943 
lm
->
blk_bôm≠_Àn
 = 
	`BITS_TO_LONGS
(
geo
->
Æl_luns
) * ();

944 
lm
->
£c_bôm≠_Àn
 = 
	`BITS_TO_LONGS
÷m->
£c_≥r_löe
) * ();

945 
lm
->
lun_bôm≠_Àn
 = 
	`BITS_TO_LONGS
(
geo
->
Æl_luns
) * ();

946 
lm
->
mid_thrs
 =Üm->
£c_≥r_löe
 / 2;

947 
lm
->
high_thrs
 =Üm->
£c_≥r_löe
 / 4;

948 
lm
->
mëa_di°™˚
 = (
geo
->
Æl_luns
 / 2Ë* 
pblk
->
mö_wrôe_pgs
;

953 
i
 = 1;

954 
add_smëa_∑ge
:

955 
lm
->
smëa_£c
 = 
i
 * 
geo
->
ws_›t
;

956 
lm
->
smëa_Àn
 =Üm->
smëa_£c
 * 
geo
->
c£cs
;

958 
smëa_Àn
 = (
löe_smëa
Ë+ 
lm
->
lun_bôm≠_Àn
;

959 i‡(
smëa_Àn
 > 
lm
->smeta_len) {

960 
i
++;

961 
add_smëa_∑ge
;

967 
i
 = 1;

968 
add_emëa_∑ge
:

969 
lm
->
emëa_£c
[0] = 
i
 * 
geo
->
ws_›t
;

970 
lm
->
emëa_Àn
[0] =Üm->
emëa_£c
[0] * 
geo
->
c£cs
;

972 
emëa_Àn
 = 
	`ˇlc_emëa_Àn
(
pblk
);

973 i‡(
emëa_Àn
 > 
lm
->emeta_len[0]) {

974 
i
++;

975 
add_emëa_∑ge
;

978 
lm
->
emëa_bb
 = 
geo
->
Æl_luns
 > 
i
 ? geo->all_luns - i : 0;

980 
lm
->
mö_blk_löe
 = 1;

981 i‡(
geo
->
Æl_luns
 > 1)

982 
lm
->
mö_blk_löe
 +
	`DIV_ROUND_UP
÷m->
smëa_£c
 +

983 
lm
->
emëa_£c
[0], 
geo
->
˛ba
);

985 i‡(
lm
->
mö_blk_löe
 >Üm->
blk_≥r_löe
) {

986 
	`pblk_îr
(
pblk
, "config.Çot supported. Min. LUN inÜine:%d\n",

987 
lm
->
blk_≥r_löe
);

988  -
EINVAL
;

992 
	}
}

994 
	$pblk_löes_öô
(
pblk
 *pblk)

996 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

997 
pblk_löe
 *
löe
;

998 *
chunk_mëa
;

999 
ƒ_‰ì_chks
 = 0;

1000 
i
, 
ªt
;

1002 
ªt
 = 
	`pblk_löe_mëa_öô
(
pblk
);

1003 i‡(
ªt
)

1004  
ªt
;

1006 
ªt
 = 
	`pblk_löe_mg_öô
(
pblk
);

1007 i‡(
ªt
)

1008  
ªt
;

1010 
ªt
 = 
	`pblk_luns_öô
(
pblk
);

1011 i‡(
ªt
)

1012 
Áû_‰ì_mëa
;

1014 
chunk_mëa
 = 
	`pblk_gë_chunk_mëa
(
pblk
);

1015 i‡(
	`IS_ERR
(
chunk_mëa
)) {

1016 
ªt
 = 
	`PTR_ERR
(
chunk_mëa
);

1017 
Áû_‰ì_luns
;

1020 
pblk
->
löes
 = 
	`kˇŒoc
(
l_mg
->
ƒ_löes
, (
pblk_löe
),

1021 
GFP_KERNEL
);

1022 i‡(!
pblk
->
löes
) {

1023 
ªt
 = -
ENOMEM
;

1024 
Áû_‰ì_chunk_mëa
;

1027 
i
 = 0; i < 
l_mg
->
ƒ_löes
; i++) {

1028 
löe
 = &
pblk
->
löes
[
i
];

1030 
ªt
 = 
	`pblk_Æloc_löe_mëa
(
pblk
, 
löe
);

1031 i‡(
ªt
)

1032 
Áû_‰ì_löes
;

1034 
ƒ_‰ì_chks
 +
	`pblk_£tup_löe_mëa
(
pblk
, 
löe
, 
chunk_mëa
, 
i
);

1036 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

1037 
löe
->
°©e
);

1040 i‡(!
ƒ_‰ì_chks
) {

1041 
	`pblk_îr
(
pblk
, "too many bad blocksÖrevent for sane instance\n");

1042 
ªt
 = -
EINTR
;

1043 
Áû_‰ì_löes
;

1046 
ªt
 = 
	`pblk_£t_¥ovisi⁄
(
pblk
, 
ƒ_‰ì_chks
);

1047 i‡(
ªt
)

1048 
Áû_‰ì_löes
;

1050 
	`v‰ì
(
chunk_mëa
);

1053 
Áû_‰ì_löes
:

1054 --
i
 >= 0)

1055 
	`pblk_löe_mëa_‰ì
(
l_mg
, &
pblk
->
löes
[
i
]);

1056 
	`k‰ì
(
pblk
->
löes
);

1057 
Áû_‰ì_chunk_mëa
:

1058 
	`v‰ì
(
chunk_mëa
);

1059 
Áû_‰ì_luns
:

1060 
	`k‰ì
(
pblk
->
luns
);

1061 
Áû_‰ì_mëa
:

1062 
	`pblk_löe_mg_‰ì
(
pblk
);

1064  
ªt
;

1065 
	}
}

1067 
	$pblk_wrôî_öô
(
pblk
 *pblk)

1069 
pblk
->
wrôî_ts
 = 
	`kthªad_¸óã
(
pblk_wrôe_ts
,Öblk, "pblk-writer-t");

1070 i‡(
	`IS_ERR
(
pblk
->
wrôî_ts
)) {

1071 
îr
 = 
	`PTR_ERR
(
pblk
->
wrôî_ts
);

1073 i‡(
îr
 !-
EINTR
)

1074 
	`pblk_îr
(
pblk
, "couldÇotállocate writer kthread (%d)\n",

1075 
îr
);

1076  
îr
;

1079 
	`timî_£tup
(&
pblk
->
wtimî
, 
pblk_wrôe_timî_‚
, 0);

1080 
	`mod_timî
(&
pblk
->
wtimî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(100));

1083 
	}
}

1085 
	$pblk_wrôî_°›
(
pblk
 *pblk)

1090 
	`WARN
(
	`pblk_rb_ªad_cou¡
(&
pblk
->
rwb
),

1093 
	`WARN
(
	`pblk_rb_sync_cou¡
(&
pblk
->
rwb
),

1096 
	`dñ_timî_sync
(&
pblk
->
wtimî
);

1097 i‡(
pblk
->
wrôî_ts
)

1098 
	`kthªad_°›
(
pblk
->
wrôî_ts
);

1099 
	}
}

1101 
	$pblk_‰ì
(
pblk
 *pblk)

1103 
	`pblk_löes_‰ì
(
pblk
);

1104 
	`pblk_l2p_‰ì
(
pblk
);

1105 
	`pblk_rwb_‰ì
(
pblk
);

1106 
	`pblk_c‹e_‰ì
(
pblk
);

1108 
	`k‰ì
(
pblk
);

1109 
	}
}

1111 
	$pblk_ã¨_down
(
pblk
 *pblk, 
boﬁ
 
gø˚ful
)

1113 i‡(
gø˚ful
)

1114 
	`__pblk_pùñöe_Êush
(
pblk
);

1115 
	`__pblk_pùñöe_°›
(
pblk
);

1116 
	`pblk_wrôî_°›
(
pblk
);

1117 
	`pblk_rb_sync_l2p
(&
pblk
->
rwb
);

1118 
	`pblk_æ_‰ì
(&
pblk
->
æ
);

1120 
	`pblk_debug
(
pblk
, "c⁄si°íàã¨ dow¿(gø˚ful:%d)\n", 
gø˚ful
);

1121 
	}
}

1123 
	$pblk_exô
(*
¥iv©e
, 
boﬁ
 
gø˚ful
)

1125 
pblk
 *pblk = 
¥iv©e
;

1127 
	`pblk_gc_exô
(
pblk
, 
gø˚ful
);

1128 
	`pblk_ã¨_down
(
pblk
, 
gø˚ful
);

1130 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1131 
	`pblk_öfo
(
pblk
, "exô: L2P CRC: %x\n", 
	`pblk_l2p_¸c
(pblk));

1134 
	`pblk_‰ì
(
pblk
);

1135 
	}
}

1137 
£˘‹_t
 
	$pblk_ˇ∑côy
(*
¥iv©e
)

1139 
pblk
 *pblk = 
¥iv©e
;

1141  
pblk
->
ˇ∑côy
 * 
NR_PHY_IN_LOG
;

1142 
	}
}

1144 *
	$pblk_öô
(
nvm_tgt_dev
 *
dev
, 
gídisk
 *
tdisk
,

1145 
Êags
)

1147 
nvm_geo
 *
geo
 = &
dev
->geo;

1148 
ªque°_queue
 *
bqueue
 = 
dev
->
q
;

1149 
ªque°_queue
 *
tqueue
 = 
tdisk
->
queue
;

1150 
pblk
 *pblk;

1151 
ªt
;

1153 
pblk
 = 
	`kzÆloc
((pblk), 
GFP_KERNEL
);

1154 i‡(!
pblk
)

1155  
	`ERR_PTR
(-
ENOMEM
);

1157 
pblk
->
dev
 = dev;

1158 
pblk
->
disk
 = 
tdisk
;

1159 
pblk
->
°©e
 = 
PBLK_STATE_RUNNING
;

1160 
	`åa˚_pblk_°©e
(
	`pblk_disk_«me
(
pblk
),Öblk->
°©e
);

1161 
pblk
->
gc
.
gc_íabÀd
 = 0;

1163 i‡(!(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
 ||

1164 
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_20
)) {

1165 
	`pblk_îr
(
pblk
, "OCSSD versionÇot supported (%u)\n",

1166 
geo
->
vîsi⁄
);

1167 
	`k‰ì
(
pblk
);

1168  
	`ERR_PTR
(-
EINVAL
);

1171 i‡(
geo
->
ext
) {

1172 
	`pblk_îr
(
pblk
, "extended metadataÇot supported\n");

1173 
	`k‰ì
(
pblk
);

1174  
	`ERR_PTR
(-
EINVAL
);

1177 
	`•ö_lock_öô
(&
pblk
->
ªsubmô_lock
);

1178 
	`•ö_lock_öô
(&
pblk
->
å™s_lock
);

1179 
	`•ö_lock_öô
(&
pblk
->
lock
);

1181 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1182 
	`©omic_l⁄g_£t
(&
pblk
->
öÊight_wrôes
, 0);

1183 
	`©omic_l⁄g_£t
(&
pblk
->
∑dded_wrôes
, 0);

1184 
	`©omic_l⁄g_£t
(&
pblk
->
∑dded_wb
, 0);

1185 
	`©omic_l⁄g_£t
(&
pblk
->
ªq_wrôes
, 0);

1186 
	`©omic_l⁄g_£t
(&
pblk
->
sub_wrôes
, 0);

1187 
	`©omic_l⁄g_£t
(&
pblk
->
sync_wrôes
, 0);

1188 
	`©omic_l⁄g_£t
(&
pblk
->
öÊight_ªads
, 0);

1189 
	`©omic_l⁄g_£t
(&
pblk
->
ˇche_ªads
, 0);

1190 
	`©omic_l⁄g_£t
(&
pblk
->
sync_ªads
, 0);

1191 
	`©omic_l⁄g_£t
(&
pblk
->
ªcov_wrôes
, 0);

1192 
	`©omic_l⁄g_£t
(&
pblk
->
ªcov_wrôes
, 0);

1193 
	`©omic_l⁄g_£t
(&
pblk
->
ªcov_gc_wrôes
, 0);

1194 
	`©omic_l⁄g_£t
(&
pblk
->
ªcov_gc_ªads
, 0);

1197 
	`©omic_l⁄g_£t
(&
pblk
->
ªad_Áûed
, 0);

1198 
	`©omic_l⁄g_£t
(&
pblk
->
ªad_em±y
, 0);

1199 
	`©omic_l⁄g_£t
(&
pblk
->
ªad_high_ecc
, 0);

1200 
	`©omic_l⁄g_£t
(&
pblk
->
ªad_Áûed_gc
, 0);

1201 
	`©omic_l⁄g_£t
(&
pblk
->
wrôe_Áûed
, 0);

1202 
	`©omic_l⁄g_£t
(&
pblk
->
îa£_Áûed
, 0);

1204 
ªt
 = 
	`pblk_c‹e_öô
(
pblk
);

1205 i‡(
ªt
) {

1206 
	`pblk_îr
(
pblk
, "couldÇot initialize core\n");

1207 
Áû
;

1210 
ªt
 = 
	`pblk_löes_öô
(
pblk
);

1211 i‡(
ªt
) {

1212 
	`pblk_îr
(
pblk
, "couldÇot initializeÜines\n");

1213 
Áû_‰ì_c‹e
;

1216 
ªt
 = 
	`pblk_rwb_öô
(
pblk
);

1217 i‡(
ªt
) {

1218 
	`pblk_îr
(
pblk
, "couldÇot initialize write buffer\n");

1219 
Áû_‰ì_löes
;

1222 
ªt
 = 
	`pblk_l2p_öô
(
pblk
, 
Êags
 & 
NVM_TARGET_FACTORY
);

1223 i‡(
ªt
) {

1224 
	`pblk_îr
(
pblk
, "couldÇot initialize maps\n");

1225 
Áû_‰ì_rwb
;

1228 
ªt
 = 
	`pblk_wrôî_öô
(
pblk
);

1229 i‡(
ªt
) {

1230 i‡(
ªt
 !-
EINTR
)

1231 
	`pblk_îr
(
pblk
, "couldÇot initialize writeÅhread\n");

1232 
Áû_‰ì_l2p
;

1235 
ªt
 = 
	`pblk_gc_öô
(
pblk
);

1236 i‡(
ªt
) {

1237 
	`pblk_îr
(
pblk
, "couldÇot initialize gc\n");

1238 
Áû_°›_wrôî
;

1242 
	`blk_queue_logiˇl_block_size
(
tqueue
, 
	`queue_physiˇl_block_size
(
bqueue
));

1243 
	`blk_queue_max_hw_£˘‹s
(
tqueue
, 
	`queue_max_hw_£˘‹s
(
bqueue
));

1245 
	`blk_queue_wrôe_ˇche
(
tqueue
, 
åue
, 
Ál£
);

1247 
tqueue
->
limôs
.
disˇrd_gønuœrôy
 = 
geo
->
˛ba
 * geo->
c£cs
;

1248 
tqueue
->
limôs
.
disˇrd_Æignmít
 = 0;

1249 
	`blk_queue_max_disˇrd_£˘‹s
(
tqueue
, 
UINT_MAX
 >> 9);

1250 
	`blk_queue_Êag_£t
(
QUEUE_FLAG_DISCARD
, 
tqueue
);

1252 
	`pblk_öfo
(
pblk
, "luns:%u,Üines:%d, secs:%llu, bufÉntries:%u\n",

1253 
geo
->
Æl_luns
, 
pblk
->
l_mg
.
ƒ_löes
,

1254 ()
pblk
->
ˇ∑côy
,

1255 
pblk
->
rwb
.
ƒ_íåõs
);

1257 
	`wake_up_¥o˚ss
(
pblk
->
wrôî_ts
);

1260 
	`pblk_gc_should_kick
(
pblk
);

1262  
pblk
;

1264 
Áû_°›_wrôî
:

1265 
	`pblk_wrôî_°›
(
pblk
);

1266 
Áû_‰ì_l2p
:

1267 
	`pblk_l2p_‰ì
(
pblk
);

1268 
Áû_‰ì_rwb
:

1269 
	`pblk_rwb_‰ì
(
pblk
);

1270 
Áû_‰ì_löes
:

1271 
	`pblk_löes_‰ì
(
pblk
);

1272 
Áû_‰ì_c‹e
:

1273 
	`pblk_c‹e_‰ì
(
pblk
);

1274 
Áû
:

1275 
	`k‰ì
(
pblk
);

1276  
	`ERR_PTR
(
ªt
);

1277 
	}
}

1280 
nvm_tgt_ty≥
 
	gâ_pblk
 = {

1281 .
«me
 = "pblk",

1282 .
	gvîsi⁄
 = {1, 0, 0},

1284 .
	gmake_rq
 = 
pblk_make_rq
,

1285 .
	gˇ∑côy
 = 
pblk_ˇ∑côy
,

1287 .
	göô
 = 
pblk_öô
,

1288 .
	gexô
 = 
pblk_exô
,

1290 .
	gsysfs_öô
 = 
pblk_sysfs_öô
,

1291 .
	gsysfs_exô
 = 
pblk_sysfs_exô
,

1292 .
	gow√r
 = 
THIS_MODULE
,

1295 
__öô
 
	$pblk_moduÀ_öô
()

1297 
ªt
;

1299 
ªt
 = 
	`bio£t_öô
(&
pblk_bio_£t
, 
BIO_POOL_SIZE
, 0, 0);

1300 i‡(
ªt
)

1301  
ªt
;

1302 
ªt
 = 
	`nvm_ªgi°î_tgt_ty≥
(&
â_pblk
);

1303 i‡(
ªt
)

1304 
	`bio£t_exô
(&
pblk_bio_£t
);

1305  
ªt
;

1306 
	}
}

1308 
	$pblk_moduÀ_exô
()

1310 
	`bio£t_exô
(&
pblk_bio_£t
);

1311 
	`nvm_uƒegi°î_tgt_ty≥
(&
â_pblk
);

1312 
	}
}

1314 
moduÀ_öô
(
pblk_moduÀ_öô
);

1315 
moduÀ_exô
(
pblk_moduÀ_exô
);

1316 
MODULE_AUTHOR
("Javier Gonzalez <javier@cnexlabs.com>");

1317 
MODULE_AUTHOR
("Matias Bjorling <matias@cnexlabs.com>");

1318 
MODULE_LICENSE
("GPL v2");

1319 
MODULE_DESCRIPTION
("Physical Block-Device for Open-Channel SSDs");

	@pblk-map.c

20 
	~"pblk.h
"

22 
	$pblk_m≠_∑ge_d©a
(
pblk
 *pblk, 
£¡ry
,

23 
µa_addr
 *
µa_li°
,

24 *
lun_bôm≠
,

25 *
mëa_li°
,

26 
vÆid_£cs
)

28 
pblk_löe
 *
löe
 = 
	`pblk_löe_gë_d©a
(
pblk
);

29 
pblk_emëa
 *
emëa
;

30 
pblk_w_˘x
 *
w_˘x
;

31 
__À64
 *
lba_li°
;

32 
u64
 
∑ddr
;

33 
ƒ_£cs
 = 
pblk
->
mö_wrôe_pgs
;

34 
i
;

36 i‡(!
löe
)

37  -
ENOSPC
;

39 i‡(
	`pblk_löe_is_fuŒ
(
löe
)) {

40 
pblk_löe
 *
¥ev_löe
 = 
löe
;

45 
löe
 = 
	`pblk_löe_ª∂a˚_d©a
(
pblk
);

46 
	`pblk_löe_˛o£_mëa
(
pblk
, 
¥ev_löe
);

48 i‡(!
löe
) {

49 
	`pblk_pùñöe_°›
(
pblk
);

50  -
ENOSPC
;

55 
emëa
 = 
löe
->emeta;

56 
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
emëa
->
buf
);

58 
∑ddr
 = 
	`pblk_Æloc_∑ge
(
pblk
, 
löe
, 
ƒ_£cs
);

60 
i
 = 0; i < 
ƒ_£cs
; i++, 
∑ddr
++) {

61 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

62 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

65 
µa_li°
[
i
] = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe
->
id
);

74 i‡(
i
 < 
vÆid_£cs
) {

75 
	`kªf_gë
(&
löe
->
ªf
);

76 
	`©omic_öc
(&
löe
->
£c_to_upd©e
);

77 
w_˘x
 = 
	`pblk_rb_w_˘x
(&
pblk
->
rwb
, 
£¡ry
 + 
i
);

78 
w_˘x
->
µa
 = 
µa_li°
[
i
];

79 
mëa
->
lba
 = 
	`˝u_to_À64
(
w_˘x
->lba);

80 
lba_li°
[
∑ddr
] = 
	`˝u_to_À64
(
w_˘x
->
lba
);

81 i‡(
lba_li°
[
∑ddr
] !
addr_em±y
)

82 
löe
->
ƒ_vÆid_lbas
++;

84 
	`©omic64_öc
(&
pblk
->
∑d_wa
);

86 
lba_li°
[
∑ddr
] = 
addr_em±y
;

87 
mëa
->
lba
 = 
addr_em±y
;

88 
	`__pblk_m≠_övÆid©e
(
pblk
, 
löe
, 
∑ddr
);

92 
	`pblk_down_rq
(
pblk
, 
µa_li°
[0], 
lun_bôm≠
);

94 
	}
}

96 
	$pblk_m≠_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
£¡ry
,

97 *
lun_bôm≠
, 
vÆid_£cs
,

98 
off
)

100 *
mëa_li°
 = 
	`pblk_gë_mëa_f‹_wrôes
(
pblk
, 
rqd
);

101 *
mëa_buf„r
;

102 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

103 
m≠_£cs
;

104 
mö
 = 
pblk
->
mö_wrôe_pgs
;

105 
i
;

106 
ªt
;

108 
i
 = 
off
; i < 
rqd
->
ƒ_µas
; i +
mö
) {

109 
m≠_£cs
 = (
i
 + 
mö
 > 
vÆid_£cs
) ? (valid_secs % min) : min;

110 
mëa_buf„r
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

112 
ªt
 = 
	`pblk_m≠_∑ge_d©a
(
pblk
, 
£¡ry
 + 
i
, &
µa_li°
[i],

113 
lun_bôm≠
, 
mëa_buf„r
, 
m≠_£cs
);

114 i‡(
ªt
)

115  
ªt
;

119 
	}
}

122 
	$pblk_m≠_îa£_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

123 
£¡ry
, *
lun_bôm≠
,

124 
vÆid_£cs
, 
µa_addr
 *
îa£_µa
)

126 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

127 
nvm_geo
 *
geo
 = &
dev
->geo;

128 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

129 *
mëa_li°
 = 
	`pblk_gë_mëa_f‹_wrôes
(
pblk
, 
rqd
);

130 *
mëa_buf„r
;

131 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

132 
pblk_löe
 *
e_löe
, *
d_löe
;

133 
m≠_£cs
;

134 
mö
 = 
pblk
->
mö_wrôe_pgs
;

135 
i
, 
îa£_lun
;

136 
ªt
;

139 
i
 = 0; i < 
rqd
->
ƒ_µas
; i +
mö
) {

140 
m≠_£cs
 = (
i
 + 
mö
 > 
vÆid_£cs
) ? (valid_secs % min) : min;

141 
mëa_buf„r
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

143 
ªt
 = 
	`pblk_m≠_∑ge_d©a
(
pblk
, 
£¡ry
 + 
i
, &
µa_li°
[i],

144 
lun_bôm≠
, 
mëa_buf„r
, 
m≠_£cs
);

145 i‡(
ªt
)

146  
ªt
;

148 
îa£_lun
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_li°
[
i
]);

153 
e_löe
 = 
	`pblk_löe_gë_îa£
(
pblk
);

154 i‡(!
e_löe
)

155  
	`pblk_m≠_rq
(
pblk
, 
rqd
, 
£¡ry
, 
lun_bôm≠
,

156 
vÆid_£cs
, 
i
 + 
mö
);

158 
	`•ö_lock
(&
e_löe
->
lock
);

159 i‡(!
	`ã°_bô
(
îa£_lun
, 
e_löe
->
îa£_bôm≠
)) {

160 
	`£t_bô
(
îa£_lun
, 
e_löe
->
îa£_bôm≠
);

161 
	`©omic_dec
(&
e_löe
->
À·_eblks
);

163 *
îa£_µa
 = 
µa_li°
[
i
];

164 
îa£_µa
->
a
.
blk
 = 
e_löe
->
id
;

165 
îa£_µa
->
a
.
ª£rved
 = 0;

167 
	`•ö_u∆ock
(&
e_löe
->
lock
);

170  
	`pblk_m≠_rq
(
pblk
, 
rqd
, 
£¡ry
, 
lun_bôm≠
,

171 
vÆid_£cs
, 
i
 + 
mö
);

173 
	`•ö_u∆ock
(&
e_löe
->
lock
);

176 
d_löe
 = 
	`pblk_löe_gë_d©a
(
pblk
);

181 
e_löe
 = 
	`pblk_löe_gë_îa£
(
pblk
);

182 i‡(!
e_löe
)

183  -
ENOSPC
;

186 i‡(
	`u∆ikñy
(
	`pblk_µa_em±y
(*
îa£_µa
)) &&

187 
	`bôm≠_weight
(
d_löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
)) {

188 
bô
 = -1;

190 
ªåy
:

191 
bô
 = 
	`föd_√xt_bô
(
d_löe
->
blk_bôm≠
,

192 
lm
->
blk_≥r_löe
, 
bô
 + 1);

193 i‡(
bô
 >
lm
->
blk_≥r_löe
)

196 
	`•ö_lock
(&
e_löe
->
lock
);

197 i‡(
	`ã°_bô
(
bô
, 
e_löe
->
îa£_bôm≠
)) {

198 
	`•ö_u∆ock
(&
e_löe
->
lock
);

199 
ªåy
;

201 
	`•ö_u∆ock
(&
e_löe
->
lock
);

203 
	`£t_bô
(
bô
, 
e_löe
->
îa£_bôm≠
);

204 
	`©omic_dec
(&
e_löe
->
À·_eblks
);

205 *
îa£_µa
 = 
pblk
->
luns
[
bô
].
bµa
;

206 
îa£_µa
->
a
.
blk
 = 
e_löe
->
id
;

210 
	}
}

	@pblk-rb.c

20 
	~<löux/cúc_buf.h
>

22 
	~"pblk.h
"

24 
DECLARE_RWSEM
(
pblk_rb_lock
);

26 
	$pblk_rb_d©a_‰ì
(
pblk_rb
 *
rb
)

28 
pblk_rb_∑ges
 *
p
, *
t
;

30 
	`down_wrôe
(&
pblk_rb_lock
);

31 
	`li°_f‹_óch_íåy_ß„
(
p
, 
t
, &
rb
->
∑ges
, 
li°
) {

32 
	`‰ì_∑ges
(()
	`∑ge_addªss
(
p
->
∑ges
),Ö->
‹dî
);

33 
	`li°_dñ
(&
p
->
li°
);

34 
	`k‰ì
(
p
);

36 
	`up_wrôe
(&
pblk_rb_lock
);

37 
	}
}

39 
	$pblk_rb_‰ì
(
pblk_rb
 *
rb
)

41 
	`pblk_rb_d©a_‰ì
(
rb
);

42 
	`v‰ì
(
rb
->
íåõs
);

43 
	}
}

48 
	$pblk_rb_ˇlcuœã_size
(
ƒ_íåõs
,

49 
thªshﬁd
)

51 
thr_sz
 = 1 << (
	`gë_cou¡_‹dî
(
thªshﬁd
 + 
NVM_MAX_VLBA
));

52 
max_sz
 = 
	`max
(
thr_sz
, 
ƒ_íåõs
);

53 
max_io
;

59 
max_io
 = (1 << 
	`max
(()(
	`gë_cou¡_‹dî
(
max_sz
)),

60 ()(
	`gë_cou¡_‹dî
(
NVM_MAX_VLBA
 << 1))));

61 i‡((
thªshﬁd
 + 
NVM_MAX_VLBA
Ë>
max_io
)

62 
max_io
 <<= 1;

64  
max_io
;

65 
	}
}

72 
	$pblk_rb_öô
(
pblk_rb
 *
rb
, 
size
, 
thªshﬁd
,

73 
£g_size
)

75 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

76 
pblk_rb_íåy
 *
íåõs
;

77 
öô_íåy
 = 0;

78 
max_‹dî
 = 
MAX_ORDER
 - 1;

79 
powî_size
, 
powî_£g_sz
;

80 
Æloc_‹dî
, 
‹dî
, 
ôî
;

81 
ƒ_íåõs
;

83 
ƒ_íåõs
 = 
	`pblk_rb_ˇlcuœã_size
(
size
, 
thªshﬁd
);

84 
íåõs
 = 
	`vzÆloc
(
	`¨øy_size
(
ƒ_íåõs
, (
pblk_rb_íåy
)));

85 i‡(!
íåõs
)

86  -
ENOMEM
;

88 
powî_size
 = 
	`gë_cou¡_‹dî
(
ƒ_íåõs
);

89 
powî_£g_sz
 = 
	`gë_cou¡_‹dî
(
£g_size
);

91 
	`down_wrôe
(&
pblk_rb_lock
);

92 
rb
->
íåõs
 =Éntries;

93 
rb
->
£g_size
 = (1 << 
powî_£g_sz
);

94 
rb
->
ƒ_íåõs
 = (1 << 
powî_size
);

95 
rb
->
mem
 =Ñb->
subm
 =Ñb->
sync
 =Ñb->
l2p_upd©e
 = 0;

96 
rb
->
back_thªs
 = 
thªshﬁd
;

97 
rb
->
Êush_poöt
 = 
EMPTY_ENTRY
;

99 
	`•ö_lock_öô
(&
rb
->
w_lock
);

100 
	`•ö_lock_öô
(&
rb
->
s_lock
);

102 
	`INIT_LIST_HEAD
(&
rb
->
∑ges
);

104 
Æloc_‹dî
 = 
powî_size
;

105 i‡(
Æloc_‹dî
 >
max_‹dî
) {

106 
‹dî
 = 
max_‹dî
;

107 
ôî
 = (1 << (
Æloc_‹dî
 - 
max_‹dî
));

109 
‹dî
 = 
Æloc_‹dî
;

110 
ôî
 = 1;

114 
pblk_rb_íåy
 *
íåy
;

115 
pblk_rb_∑ges
 *
∑ge_£t
;

116 *
kaddr
;

117 
£t_size
;

118 
i
;

120 
∑ge_£t
 = 
	`kmÆloc
((
pblk_rb_∑ges
), 
GFP_KERNEL
);

121 i‡(!
∑ge_£t
) {

122 
	`up_wrôe
(&
pblk_rb_lock
);

123 
	`v‰ì
(
íåõs
);

124  -
ENOMEM
;

127 
∑ge_£t
->
‹dî
 = order;

128 
∑ge_£t
->
∑ges
 = 
	`Æloc_∑ges
(
GFP_KERNEL
, 
‹dî
);

129 i‡(!
∑ge_£t
->
∑ges
) {

130 
	`k‰ì
(
∑ge_£t
);

131 
	`pblk_rb_d©a_‰ì
(
rb
);

132 
	`up_wrôe
(&
pblk_rb_lock
);

133 
	`v‰ì
(
íåõs
);

134  -
ENOMEM
;

136 
kaddr
 = 
	`∑ge_addªss
(
∑ge_£t
->
∑ges
);

138 
íåy
 = &
rb
->
íåõs
[
öô_íåy
];

139 
íåy
->
d©a
 = 
kaddr
;

140 
íåy
->
ˇchñöe
 = 
	`pblk_ˇchñöe_to_addr
(
öô_íåy
++);

141 
íåy
->
w_˘x
.
Êags
 = 
PBLK_WRITABLE_ENTRY
;

143 
£t_size
 = (1 << 
‹dî
);

144 
i
 = 1; i < 
£t_size
; i++) {

145 
íåy
 = &
rb
->
íåõs
[
öô_íåy
];

146 
íåy
->
ˇchñöe
 = 
	`pblk_ˇchñöe_to_addr
(
öô_íåy
++);

147 
íåy
->
d©a
 = 
kaddr
 + (
i
 * 
rb
->
£g_size
);

148 
íåy
->
w_˘x
.
Êags
 = 
PBLK_WRITABLE_ENTRY
;

149 
	`bio_li°_öô
(&
íåy
->
w_˘x
.
bios
);

152 
	`li°_add_èû
(&
∑ge_£t
->
li°
, &
rb
->
∑ges
);

153 
ôî
--;

154 } 
ôî
 > 0);

155 
	`up_wrôe
(&
pblk_rb_lock
);

157 #ifde‡
CONFIG_NVM_PBLK_DEBUG


158 
	`©omic_£t
(&
rb
->
öÊight_Êush_poöt
, 0);

165 
	`pblk_æ_öô
(&
pblk
->
æ
, 
rb
->
ƒ_íåõs
, 
thªshﬁd
);

168 
	}
}

170 
	$˛ón_w˘x
(
pblk_w_˘x
 *
w_˘x
)

172 
Êags
;

174 
Êags
 = 
	`READ_ONCE
(
w_˘x
->flags);

175 
	`WARN_ONCE
(!(
Êags
 & 
PBLK_SUBMITTED_ENTRY
),

179 
	`smp_°‹e_ªÀa£
(&
w_˘x
->
Êags
, 
PBLK_WRITABLE_ENTRY
);

180 
	`pblk_µa_£t_em±y
(&
w_˘x
->
µa
);

181 
w_˘x
->
lba
 = 
ADDR_EMPTY
;

182 
	}
}

184 
	#pblk_rb_rög_cou¡
(
hód
, 
èû
, 
size
Ë
	`CIRC_CNT
(hód,Åaû, size)

	)

185 
	#pblk_rb_rög_•a˚
(
rb
, 
hód
, 
èû
, 
size
) \

186 (
	`CIRC_SPACE
(
hód
, 
èû
, 
size
))

	)

192 
	$pblk_rb_•a˚
(
pblk_rb
 *
rb
)

194 
mem
 = 
	`READ_ONCE
(
rb
->mem);

195 
sync
 = 
	`READ_ONCE
(
rb
->sync);

197  
	`pblk_rb_rög_•a˚
(
rb
, 
mem
, 
sync
,Ñb->
ƒ_íåõs
);

198 
	}
}

200 
	$pblk_rb_±r_wøp
(
pblk_rb
 *
rb
, 
p
,

201 
ƒ_íåõs
)

203  (
p
 + 
ƒ_íåõs
Ë& (
rb
->nr_entries - 1);

204 
	}
}

210 
	$pblk_rb_ªad_cou¡
(
pblk_rb
 *
rb
)

212 
mem
 = 
	`READ_ONCE
(
rb
->mem);

213 
subm
 = 
	`READ_ONCE
(
rb
->subm);

215  
	`pblk_rb_rög_cou¡
(
mem
, 
subm
, 
rb
->
ƒ_íåõs
);

216 
	}
}

218 
	$pblk_rb_sync_cou¡
(
pblk_rb
 *
rb
)

220 
mem
 = 
	`READ_ONCE
(
rb
->mem);

221 
sync
 = 
	`READ_ONCE
(
rb
->sync);

223  
	`pblk_rb_rög_cou¡
(
mem
, 
sync
, 
rb
->
ƒ_íåõs
);

224 
	}
}

226 
	$pblk_rb_ªad_commô
(
pblk_rb
 *
rb
, 
ƒ_íåõs
)

228 
subm
;

230 
subm
 = 
	`READ_ONCE
(
rb
->subm);

232 
	`smp_°‹e_ªÀa£
(&
rb
->
subm
, 
	`pblk_rb_±r_wøp
‘b, subm, 
ƒ_íåõs
));

234  
subm
;

235 
	}
}

237 
	$__pblk_rb_upd©e_l2p
(
pblk_rb
 *
rb
, 
to_upd©e
)

239 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

240 
pblk_löe
 *
löe
;

241 
pblk_rb_íåy
 *
íåy
;

242 
pblk_w_˘x
 *
w_˘x
;

243 
u£r_io
 = 0, 
gc_io
 = 0;

244 
i
;

245 
Êags
;

247 
i
 = 0; i < 
to_upd©e
; i++) {

248 
íåy
 = &
rb
->
íåõs
[rb->
l2p_upd©e
];

249 
w_˘x
 = &
íåy
->w_ctx;

251 
Êags
 = 
	`READ_ONCE
(
íåy
->
w_˘x
.flags);

252 i‡(
Êags
 & 
PBLK_IOTYPE_USER
)

253 
u£r_io
++;

254 i‡(
Êags
 & 
PBLK_IOTYPE_GC
)

255 
gc_io
++;

257 
	`WARN
(1, "pblk: unknown IOÅype\n");

259 
	`pblk_upd©e_m≠_dev
(
pblk
, 
w_˘x
->
lba
, w_˘x->
µa
,

260 
íåy
->
ˇchñöe
);

262 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
w_˘x
->
µa
);

263 
	`©omic_dec
(&
löe
->
£c_to_upd©e
);

264 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put
);

265 
	`˛ón_w˘x
(
w_˘x
);

266 
rb
->
l2p_upd©e
 = 
	`pblk_rb_±r_wøp
(rb,Ñb->l2p_update, 1);

269 
	`pblk_æ_out
(&
pblk
->
æ
, 
u£r_io
, 
gc_io
);

272 
	}
}

279 
	$pblk_rb_upd©e_l2p
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

280 
mem
, 
sync
)

282 
•a˚
, 
cou¡
;

283 
ªt
 = 0;

285 
	`lockdï_as£π_hñd
(&
rb
->
w_lock
);

288 
•a˚
 = 
	`pblk_rb_rög_•a˚
(
rb
, 
mem
,Ñb->
l2p_upd©e
,Ñb->
ƒ_íåõs
);

289 i‡(
•a˚
 > 
ƒ_íåõs
)

290 
out
;

292 
cou¡
 = 
ƒ_íåõs
 - 
•a˚
;

294 
ªt
 = 
	`__pblk_rb_upd©e_l2p
(
rb
, 
cou¡
);

296 
out
:

297  
ªt
;

298 
	}
}

305 
	$pblk_rb_sync_l2p
(
pblk_rb
 *
rb
)

307 
sync
;

308 
to_upd©e
;

310 
	`•ö_lock
(&
rb
->
w_lock
);

313 
sync
 = 
	`smp_lﬂd_acquúe
(&
rb
->sync);

315 
to_upd©e
 = 
	`pblk_rb_rög_cou¡
(
sync
, 
rb
->
l2p_upd©e
,Ñb->
ƒ_íåõs
);

316 
	`__pblk_rb_upd©e_l2p
(
rb
, 
to_upd©e
);

318 
	`•ö_u∆ock
(&
rb
->
w_lock
);

319 
	}
}

327 
	$__pblk_rb_wrôe_íåy
(
pblk_rb
 *
rb
, *
d©a
,

328 
pblk_w_˘x
 
w_˘x
,

329 
pblk_rb_íåy
 *
íåy
)

331 
	`mem˝y
(
íåy
->
d©a
, d©a, 
rb
->
£g_size
);

333 
íåy
->
w_˘x
.
lba
 = w_ctx.lba;

334 
íåy
->
w_˘x
.
µa
 = w_ctx.ppa;

335 
	}
}

337 
	$pblk_rb_wrôe_íåy_u£r
(
pblk_rb
 *
rb
, *
d©a
,

338 
pblk_w_˘x
 
w_˘x
, 
rög_pos
)

340 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

341 
pblk_rb_íåy
 *
íåy
;

342 
Êags
;

344 
íåy
 = &
rb
->
íåõs
[
rög_pos
];

345 
Êags
 = 
	`READ_ONCE
(
íåy
->
w_˘x
.flags);

346 #ifde‡
CONFIG_NVM_PBLK_DEBUG


348 
	`BUG_ON
(!(
Êags
 & 
PBLK_WRITABLE_ENTRY
));

351 
	`__pblk_rb_wrôe_íåy
(
rb
, 
d©a
, 
w_˘x
, 
íåy
);

353 
	`pblk_upd©e_m≠_ˇche
(
pblk
, 
w_˘x
.
lba
, 
íåy
->
ˇchñöe
);

354 
Êags
 = 
w_˘x
.Êag†| 
PBLK_WRITTEN_DATA
;

357 
	`smp_°‹e_ªÀa£
(&
íåy
->
w_˘x
.
Êags
, flags);

358 
	}
}

360 
	$pblk_rb_wrôe_íåy_gc
(
pblk_rb
 *
rb
, *
d©a
,

361 
pblk_w_˘x
 
w_˘x
, 
pblk_löe
 *
löe
,

362 
u64
 
∑ddr
, 
rög_pos
)

364 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

365 
pblk_rb_íåy
 *
íåy
;

366 
Êags
;

368 
íåy
 = &
rb
->
íåõs
[
rög_pos
];

369 
Êags
 = 
	`READ_ONCE
(
íåy
->
w_˘x
.flags);

370 #ifde‡
CONFIG_NVM_PBLK_DEBUG


372 
	`BUG_ON
(!(
Êags
 & 
PBLK_WRITABLE_ENTRY
));

375 
	`__pblk_rb_wrôe_íåy
(
rb
, 
d©a
, 
w_˘x
, 
íåy
);

377 i‡(!
	`pblk_upd©e_m≠_gc
(
pblk
, 
w_˘x
.
lba
, 
íåy
->
ˇchñöe
, 
löe
, 
∑ddr
))

378 
íåy
->
w_˘x
.
lba
 = 
ADDR_EMPTY
;

380 
Êags
 = 
w_˘x
.Êag†| 
PBLK_WRITTEN_DATA
;

383 
	`smp_°‹e_ªÀa£
(&
íåy
->
w_˘x
.
Êags
, flags);

384 
	}
}

386 
	$pblk_rb_Êush_poöt_£t
(
pblk_rb
 *
rb
, 
bio
 *bio,

387 
pos
)

389 
pblk_rb_íåy
 *
íåy
;

390 
sync
, 
Êush_poöt
;

392 
	`pblk_rb_sync_öô
(
rb
, 
NULL
);

393 
sync
 = 
	`READ_ONCE
(
rb
->sync);

395 i‡(
pos
 =
sync
) {

396 
	`pblk_rb_sync_íd
(
rb
, 
NULL
);

400 #ifde‡
CONFIG_NVM_PBLK_DEBUG


401 
	`©omic_öc
(&
rb
->
öÊight_Êush_poöt
);

404 
Êush_poöt
 = (
pos
 =0Ë? (
rb
->
ƒ_íåõs
 - 1) : (pos - 1);

405 
íåy
 = &
rb
->
íåõs
[
Êush_poöt
];

408 
	`smp_°‹e_ªÀa£
(&
rb
->
Êush_poöt
, flush_point);

410 i‡(
bio
)

411 
	`bio_li°_add
(&
íåy
->
w_˘x
.
bios
, 
bio
);

413 
	`pblk_rb_sync_íd
(
rb
, 
NULL
);

415  
bio
 ? 1 : 0;

416 
	}
}

418 
	$__pblk_rb_may_wrôe
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

419 *
pos
)

421 
mem
;

422 
sync
;

423 
thªshﬁd
;

425 
sync
 = 
	`READ_ONCE
(
rb
->sync);

426 
mem
 = 
	`READ_ONCE
(
rb
->mem);

428 
thªshﬁd
 = 
ƒ_íåõs
 + 
rb
->
back_thªs
;

430 i‡(
	`pblk_rb_rög_•a˚
(
rb
, 
mem
, 
sync
,Ñb->
ƒ_íåõs
Ë< 
thªshﬁd
)

433 i‡(
	`pblk_rb_upd©e_l2p
(
rb
, 
ƒ_íåõs
, 
mem
, 
sync
))

436 *
pos
 = 
mem
;

439 
	}
}

441 
	$pblk_rb_may_wrôe
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

442 *
pos
)

444 i‡(!
	`__pblk_rb_may_wrôe
(
rb
, 
ƒ_íåõs
, 
pos
))

448 
	`smp_°‹e_ªÀa£
(&
rb
->
mem
, 
	`pblk_rb_±r_wøp
‘b, *
pos
, 
ƒ_íåõs
));

450 
	}
}

452 
	$pblk_rb_Êush
(
pblk_rb
 *
rb
)

454 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

455 
mem
 = 
	`READ_ONCE
(
rb
->mem);

457 i‡(
	`pblk_rb_Êush_poöt_£t
(
rb
, 
NULL
, 
mem
))

460 
	`pblk_wrôe_kick
(
pblk
);

461 
	}
}

463 
	$pblk_rb_may_wrôe_Êush
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

464 *
pos
, 
bio
 *bio,

465 *
io_ªt
)

467 
mem
;

469 i‡(!
	`__pblk_rb_may_wrôe
(
rb
, 
ƒ_íåõs
, 
pos
))

472 
mem
 = 
	`pblk_rb_±r_wøp
(
rb
, *
pos
, 
ƒ_íåõs
);

473 *
io_ªt
 = 
NVM_IO_DONE
;

475 i‡(
bio
->
bi_›f
 & 
REQ_PREFLUSH
) {

476 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

478 
	`©omic64_öc
(&
pblk
->
ƒ_Êush
);

479 i‡(
	`pblk_rb_Êush_poöt_£t
(&
pblk
->
rwb
, 
bio
, 
mem
))

480 *
io_ªt
 = 
NVM_IO_OK
;

484 
	`smp_°‹e_ªÀa£
(&
rb
->
mem
, mem);

487 
	}
}

494 
	$pblk_rb_may_wrôe_u£r
(
pblk_rb
 *
rb
, 
bio
 *bio,

495 
ƒ_íåõs
, *
pos
)

497 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

498 
io_ªt
;

500 
	`•ö_lock
(&
rb
->
w_lock
);

501 
io_ªt
 = 
	`pblk_æ_u£r_may_ö£π
(&
pblk
->
æ
, 
ƒ_íåõs
);

502 i‡(
io_ªt
) {

503 
	`•ö_u∆ock
(&
rb
->
w_lock
);

504  
io_ªt
;

507 i‡(!
	`pblk_rb_may_wrôe_Êush
(
rb
, 
ƒ_íåõs
, 
pos
, 
bio
, &
io_ªt
)) {

508 
	`•ö_u∆ock
(&
rb
->
w_lock
);

509  
NVM_IO_REQUEUE
;

512 
	`pblk_æ_u£r_ö
(&
pblk
->
æ
, 
ƒ_íåõs
);

513 
	`•ö_u∆ock
(&
rb
->
w_lock
);

515  
io_ªt
;

516 
	}
}

521 
	$pblk_rb_may_wrôe_gc
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

522 *
pos
)

524 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

526 
	`•ö_lock
(&
rb
->
w_lock
);

527 i‡(!
	`pblk_æ_gc_may_ö£π
(&
pblk
->
æ
, 
ƒ_íåõs
)) {

528 
	`•ö_u∆ock
(&
rb
->
w_lock
);

532 i‡(!
	`pblk_rb_may_wrôe
(
rb
, 
ƒ_íåõs
, 
pos
)) {

533 
	`•ö_u∆ock
(&
rb
->
w_lock
);

537 
	`pblk_æ_gc_ö
(&
pblk
->
æ
, 
ƒ_íåõs
);

538 
	`•ö_u∆ock
(&
rb
->
w_lock
);

541 
	}
}

550 
	$pblk_rb_ªad_to_bio
(
pblk_rb
 *
rb
, 
nvm_rq
 *
rqd
,

551 
pos
, 
ƒ_íåõs
,

552 
cou¡
)

554 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

555 
ªque°_queue
 *
q
 = 
pblk
->
dev
->q;

556 
pblk_c_˘x
 *
c_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

557 
bio
 *biÿ
rqd
->bio;

558 
pblk_rb_íåy
 *
íåy
;

559 
∑ge
 *page;

560 
∑d
 = 0, 
to_ªad
 = 
ƒ_íåõs
;

561 
i
;

562 
Êags
;

564 i‡(
cou¡
 < 
ƒ_íåõs
) {

565 
∑d
 = 
ƒ_íåõs
 - 
cou¡
;

566 
to_ªad
 = 
cou¡
;

570 
∑d
 +(
pblk
->
mö_wrôe_pgs
 -Öblk->
mö_wrôe_pgs_d©a
);

572 
c_˘x
->
£¡ry
 = 
pos
;

573 
c_˘x
->
ƒ_vÆid
 = 
to_ªad
;

574 
c_˘x
->
ƒ_∑dded
 = 
∑d
;

576 
i
 = 0; i < 
to_ªad
; i++) {

577 
íåy
 = &
rb
->
íåõs
[
pos
];

582 
åy
:

583 
Êags
 = 
	`READ_ONCE
(
íåy
->
w_˘x
.flags);

584 i‡(!(
Êags
 & 
PBLK_WRITTEN_DATA
)) {

585 
	`io_scheduÀ
();

586 
åy
;

589 
∑ge
 = 
	`vút_to_∑ge
(
íåy
->
d©a
);

590 i‡(!
∑ge
) {

591 
	`pblk_îr
(
pblk
, "couldÇotállocate write bioÖage\n");

592 
Êags
 &~
PBLK_WRITTEN_DATA
;

593 
Êags
 |
PBLK_SUBMITTED_ENTRY
;

595 
	`smp_°‹e_ªÀa£
(&
íåy
->
w_˘x
.
Êags
, flags);

596  
NVM_IO_ERR
;

599 i‡(
	`bio_add_pc_∑ge
(
q
, 
bio
, 
∑ge
, 
rb
->
£g_size
, 0) !=

600 
rb
->
£g_size
) {

601 
	`pblk_îr
(
pblk
, "couldÇotáddÖageÅo write bio\n");

602 
Êags
 &~
PBLK_WRITTEN_DATA
;

603 
Êags
 |
PBLK_SUBMITTED_ENTRY
;

605 
	`smp_°‹e_ªÀa£
(&
íåy
->
w_˘x
.
Êags
, flags);

606  
NVM_IO_ERR
;

609 
Êags
 &~
PBLK_WRITTEN_DATA
;

610 
Êags
 |
PBLK_SUBMITTED_ENTRY
;

613 
	`smp_°‹e_ªÀa£
(&
íåy
->
w_˘x
.
Êags
, flags);

615 
pos
 = 
	`pblk_rb_±r_wøp
(
rb
,Öos, 1);

618 i‡(
∑d
) {

619 i‡(
	`pblk_bio_add_∑ges
(
pblk
, 
bio
, 
GFP_KERNEL
, 
∑d
)) {

620 
	`pblk_îr
(
pblk
, "couldÇotÖadÖage in write bio\n");

621  
NVM_IO_ERR
;

624 i‡(
∑d
 < 
pblk
->
mö_wrôe_pgs
)

625 
	`©omic64_öc
(&
pblk
->
∑d_di°
[
∑d
 - 1]);

627 
	`pblk_w¨n
(
pblk
, "padding moreÅhan min. sectors\n");

629 
	`©omic64_add
(
∑d
, &
pblk
->
∑d_wa
);

632 #ifde‡
CONFIG_NVM_PBLK_DEBUG


633 
	`©omic_l⁄g_add
(
∑d
, &
pblk
->
∑dded_wrôes
);

636  
NVM_IO_OK
;

637 
	}
}

644 
	$pblk_rb_c›y_to_bio
(
pblk_rb
 *
rb
, 
bio
 *bio, 
£˘‹_t
 
lba
,

645 
µa_addr
 
µa
)

647 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

648 
pblk_rb_íåy
 *
íåy
;

649 
pblk_w_˘x
 *
w_˘x
;

650 
µa_addr
 
l2p_µa
;

651 
u64
 
pos
 = 
	`pblk_addr_to_ˇchñöe
(
µa
);

652 *
d©a
;

653 
Êags
;

654 
ªt
 = 1;

657 #ifde‡
CONFIG_NVM_PBLK_DEBUG


659 
	`BUG_ON
(
pos
 >
rb
->
ƒ_íåõs
);

661 
íåy
 = &
rb
->
íåõs
[
pos
];

662 
w_˘x
 = &
íåy
->w_ctx;

663 
Êags
 = 
	`READ_ONCE
(
w_˘x
->flags);

665 
	`•ö_lock
(&
rb
->
w_lock
);

666 
	`•ö_lock
(&
pblk
->
å™s_lock
);

667 
l2p_µa
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

668 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

671 i‡(!
	`pblk_µa_comp
(
l2p_µa
, 
µa
Ë|| 
w_˘x
->
lba
 !=Üba ||

672 
Êags
 & 
PBLK_WRITABLE_ENTRY
) {

673 
ªt
 = 0;

674 
out
;

676 
d©a
 = 
	`bio_d©a
(
bio
);

677 
	`mem˝y
(
d©a
, 
íåy
->d©a, 
rb
->
£g_size
);

679 
out
:

680 
	`•ö_u∆ock
(&
rb
->
w_lock
);

681  
ªt
;

682 
	}
}

684 
pblk_w_˘x
 *
	$pblk_rb_w_˘x
(
pblk_rb
 *
rb
, 
pos
)

686 
íåy
 = 
	`pblk_rb_±r_wøp
(
rb
, 
pos
, 0);

688  &
rb
->
íåõs
[
íåy
].
w_˘x
;

689 
	}
}

691 
	$pblk_rb_sync_öô
(
pblk_rb
 *
rb
, *
Êags
)

692 
	`__acquúes
(&
rb
->
s_lock
)

694 i‡(
Êags
)

695 
	`•ö_lock_úqßve
(&
rb
->
s_lock
, *
Êags
);

697 
	`•ö_lock_úq
(&
rb
->
s_lock
);

699  
rb
->
sync
;

700 
	}
}

702 
	$pblk_rb_sync_íd
(
pblk_rb
 *
rb
, *
Êags
)

703 
	`__ªÀa£s
(&
rb
->
s_lock
)

705 
	`lockdï_as£π_hñd
(&
rb
->
s_lock
);

707 i‡(
Êags
)

708 
	`•ö_u∆ock_úqª°‹e
(&
rb
->
s_lock
, *
Êags
);

710 
	`•ö_u∆ock_úq
(&
rb
->
s_lock
);

711 
	}
}

713 
	$pblk_rb_sync_adv™˚
(
pblk_rb
 *
rb
, 
ƒ_íåõs
)

715 
sync
, 
Êush_poöt
;

716 
	`lockdï_as£π_hñd
(&
rb
->
s_lock
);

718 
sync
 = 
	`READ_ONCE
(
rb
->sync);

719 
Êush_poöt
 = 
	`READ_ONCE
(
rb
->flush_point);

721 i‡(
Êush_poöt
 !
EMPTY_ENTRY
) {

722 
£cs_to_Êush
;

724 
£cs_to_Êush
 = 
	`pblk_rb_rög_cou¡
(
Êush_poöt
, 
sync
,

725 
rb
->
ƒ_íåõs
);

726 i‡(
£cs_to_Êush
 < 
ƒ_íåõs
) {

728 
	`smp_°‹e_ªÀa£
(&
rb
->
Êush_poöt
, 
EMPTY_ENTRY
);

732 
sync
 = 
	`pblk_rb_±r_wøp
(
rb
, sync, 
ƒ_íåõs
);

735 
	`smp_°‹e_ªÀa£
(&
rb
->
sync
, sync);

737  
sync
;

738 
	}
}

741 
	$pblk_rb_Êush_poöt_cou¡
(
pblk_rb
 *
rb
)

743 
subm
, 
sync
, 
Êush_poöt
;

744 
submôãd
, 
to_Êush
;

747 
Êush_poöt
 = 
	`smp_lﬂd_acquúe
(&
rb
->flush_point);

748 i‡(
Êush_poöt
 =
EMPTY_ENTRY
)

752 
sync
 = 
	`smp_lﬂd_acquúe
(&
rb
->sync);

754 
subm
 = 
	`READ_ONCE
(
rb
->subm);

755 
submôãd
 = 
	`pblk_rb_rög_cou¡
(
subm
, 
sync
, 
rb
->
ƒ_íåõs
);

758 
to_Êush
 = 
	`pblk_rb_rög_cou¡
(
Êush_poöt
, 
sync
, 
rb
->
ƒ_íåõs
) + 1;

760  (
submôãd
 < 
to_Êush
) ? (to_flush - submitted) : 0;

761 
	}
}

763 
	$pblk_rb_ã¨_down_check
(
pblk_rb
 *
rb
)

765 
pblk_rb_íåy
 *
íåy
;

766 
i
;

767 
ªt
 = 0;

769 
	`•ö_lock
(&
rb
->
w_lock
);

770 
	`•ö_lock_úq
(&
rb
->
s_lock
);

772 i‡((
rb
->
mem
 =rb->
subm
Ë&& (rb->subm =rb->
sync
) &&

773 (
rb
->
sync
 =rb->
l2p_upd©e
) &&

774 (
rb
->
Êush_poöt
 =
EMPTY_ENTRY
)) {

775 
out
;

778 i‡(!
rb
->
íåõs
) {

779 
ªt
 = 1;

780 
out
;

783 
i
 = 0; i < 
rb
->
ƒ_íåõs
; i++) {

784 
íåy
 = &
rb
->
íåõs
[
i
];

786 i‡(!
íåy
->
d©a
) {

787 
ªt
 = 1;

788 
out
;

792 
out
:

793 
	`•ö_u∆ock_úq
(&
rb
->
s_lock
);

794 
	`•ö_u∆ock
(&
rb
->
w_lock
);

796  
ªt
;

797 
	}
}

799 
	$pblk_rb_wøp_pos
(
pblk_rb
 *
rb
, 
pos
)

801  (
pos
 & (
rb
->
ƒ_íåõs
 - 1));

802 
	}
}

804 
	$pblk_rb_pos_oob
(
pblk_rb
 *
rb
, 
u64
 
pos
)

806  (
pos
 >
rb
->
ƒ_íåõs
);

807 
	}
}

809 
ssize_t
 
	$pblk_rb_sysfs
(
pblk_rb
 *
rb
, *
buf
)

811 
pblk
 *pblk = 
	`c⁄èöî_of
(
rb
, pblk, 
rwb
);

812 
pblk_c_˘x
 *
c
;

813 
ssize_t
 
off£t
;

814 
queued_íåõs
 = 0;

816 
	`•ö_lock_úq
(&
rb
->
s_lock
);

817 
	`li°_f‹_óch_íåy
(
c
, &
pblk
->
com∂_li°
, 
li°
)

818 
queued_íåõs
++;

819 
	`•ö_u∆ock_úq
(&
rb
->
s_lock
);

821 i‡(
rb
->
Êush_poöt
 !
EMPTY_ENTRY
)

822 
off£t
 = 
	`s˙¥ötf
(
buf
, 
PAGE_SIZE
,

824 
rb
->
ƒ_íåõs
,

825 
rb
->
mem
,

826 
rb
->
subm
,

827 
rb
->
sync
,

828 
rb
->
l2p_upd©e
,

829 #ifde‡
CONFIG_NVM_PBLK_DEBUG


830 
	`©omic_ªad
(&
rb
->
öÊight_Êush_poöt
),

834 
rb
->
Êush_poöt
,

835 
	`pblk_rb_ªad_cou¡
(
rb
),

836 
	`pblk_rb_•a˚
(
rb
),

837 
	`pblk_rb_Êush_poöt_cou¡
(
rb
),

838 
queued_íåõs
);

840 
off£t
 = 
	`s˙¥ötf
(
buf
, 
PAGE_SIZE
,

842 
rb
->
ƒ_íåõs
,

843 
rb
->
mem
,

844 
rb
->
subm
,

845 
rb
->
sync
,

846 
rb
->
l2p_upd©e
,

847 #ifde‡
CONFIG_NVM_PBLK_DEBUG


848 
	`©omic_ªad
(&
rb
->
öÊight_Êush_poöt
),

852 
	`pblk_rb_ªad_cou¡
(
rb
),

853 
	`pblk_rb_•a˚
(
rb
),

854 
	`pblk_rb_Êush_poöt_cou¡
(
rb
),

855 
queued_íåõs
);

857  
off£t
;

858 
	}
}

	@pblk-read.c

19 
	~"pblk.h
"

28 
	$pblk_ªad_‰om_ˇche
(
pblk
 *pblk, 
bio
 *bio,

29 
£˘‹_t
 
lba
, 
µa_addr
 
µa
)

31 #ifde‡
CONFIG_NVM_PBLK_DEBUG


33 
	`BUG_ON
(
	`pblk_µa_em±y
(
µa
));

34 
	`BUG_ON
(!
	`pblk_addr_ö_ˇche
(
µa
));

37  
	`pblk_rb_c›y_to_bio
(&
pblk
->
rwb
, 
bio
, 
lba
, 
µa
);

38 
	}
}

40 
	$pblk_ªad_µÆi°_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

41 
bio
 *bio, 
£˘‹_t
 
blba
,

42 
boﬁ
 *
‰om_ˇche
)

44 *
mëa_li°
 = 
rqd
->meta_list;

45 
ƒ_£cs
, 
i
;

47 
ªåy
:

48 
ƒ_£cs
 = 
	`pblk_lookup_l2p_£q
(
pblk
, 
rqd
->
µa_li°
, 
blba
,Ñqd->
ƒ_µas
,

49 
‰om_ˇche
);

51 i‡(!*
‰om_ˇche
)

52 
íd
;

54 
i
 = 0; i < 
ƒ_£cs
; i++) {

55 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

56 
£˘‹_t
 
lba
 = 
blba
 + 
i
;

58 i‡(
	`pblk_µa_em±y
(
rqd
->
µa_li°
[
i
])) {

59 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

61 
mëa
->
lba
 = 
addr_em±y
;

62 } i‡(
	`pblk_addr_ö_ˇche
(
rqd
->
µa_li°
[
i
])) {

68 i‡(!
	`pblk_ªad_‰om_ˇche
(
pblk
, 
bio
, 
lba
,

69 
rqd
->
µa_li°
[
i
])) {

70 i‡(
i
 == 0) {

75 
ªåy
;

85 
ƒ_£cs
 = 
i
;

86 
íd
;

89 
mëa
->
lba
 = 
	`˝u_to_À64
(lba);

90 #ifde‡
CONFIG_NVM_PBLK_DEBUG


91 
	`©omic_l⁄g_öc
(&
pblk
->
ˇche_ªads
);

94 
	`bio_adv™˚
(
bio
, 
PBLK_EXPOSED_PAGE_SIZE
);

97 
íd
:

98 i‡(
	`pblk_io_Æig√d
(
pblk
, 
ƒ_£cs
))

99 
rqd
->
is_£q
 = 1;

101 #ifde‡
CONFIG_NVM_PBLK_DEBUG


102 
	`©omic_l⁄g_add
(
ƒ_£cs
, &
pblk
->
öÊight_ªads
);

105  
ƒ_£cs
;

106 
	}
}

109 
	$pblk_ªad_check_£q
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

110 
£˘‹_t
 
blba
)

112 *
mëa_li°
 = 
rqd
->meta_list;

113 
ƒ_lbas
 = 
rqd
->
ƒ_µas
;

114 
i
;

116 i‡(!
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
))

119 
i
 = 0; i < 
ƒ_lbas
; i++) {

120 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

121 
u64
 
lba
 = 
	`À64_to_˝u
(
mëa
->lba);

123 i‡(
lba
 =
ADDR_EMPTY
)

126 i‡(
lba
 !
blba
 + 
i
) {

127 #ifde‡
CONFIG_NVM_PBLK_DEBUG


128 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

130 
	`¥öt_µa
(
pblk
, &
µa_li°
[
i
], "seq", i);

132 
	`pblk_îr
(
pblk
, "corruptedÑead LBA (%llu/%llu)\n",

133 
lba
, (
u64
)
blba
 + 
i
);

134 
	`WARN_ON
(1);

137 
	}
}

142 
	$pblk_ªad_check_ønd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

143 
u64
 *
lba_li°
, 
ƒ_lbas
)

145 *
mëa_lba_li°
 = 
rqd
->
mëa_li°
;

146 
i
, 
j
;

148 i‡(!
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
))

151 
i
 = 0, 
j
 = 0; i < 
ƒ_lbas
; i++) {

152 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
,

153 
mëa_lba_li°
, 
j
);

154 
u64
 
lba
 = 
lba_li°
[
i
];

155 
u64
 
mëa_lba
;

157 i‡(
lba
 =
ADDR_EMPTY
)

160 
mëa_lba
 = 
	`À64_to_˝u
(
mëa
->
lba
);

162 i‡(
lba
 !
mëa_lba
) {

163 #ifde‡
CONFIG_NVM_PBLK_DEBUG


164 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

166 
	`¥öt_µa
(
pblk
, &
µa_li°
[
j
], "rnd", j);

168 
	`pblk_îr
(
pblk
, "corruptedÑead LBA (%llu/%llu)\n",

169 
mëa_lba
, 
lba
);

170 
	`WARN_ON
(1);

173 
j
++;

176 
	`WARN_ONCE
(
j
 !
rqd
->
ƒ_µas
, "pblk: corruptedÑandomÑequest\n");

177 
	}
}

179 
	$pblk_íd_u£r_ªad
(
bio
 *bio, 
îr‹
)

181 i‡(
îr‹
 &&Éº‹ !
NVM_RSP_WARN_HIGHECC
)

182 
	`bio_io_îr‹
(
bio
);

184 
	`bio_ídio
(
bio
);

185 
	}
}

187 
	$__pblk_íd_io_ªad
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

188 
boﬁ
 
put_löe
)

190 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

191 
pblk_g_˘x
 *
r_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

192 
bio
 *
öt_bio
 = 
rqd
->bio;

193 
°¨t_time
 = 
r_˘x
->start_time;

195 
	`gíîic_íd_io_ac˘
(
dev
->
q
, 
REQ_OP_READ
, &
pblk
->
disk
->
∑π0
, 
°¨t_time
);

197 i‡(
rqd
->
îr‹
)

198 
	`pblk_log_ªad_îr
(
pblk
, 
rqd
);

200 
	`pblk_ªad_check_£q
(
pblk
, 
rqd
, 
r_˘x
->
lba
);

201 
	`bio_put
(
öt_bio
);

203 i‡(
put_löe
)

204 
	`pblk_rq_to_löe_put
(
pblk
, 
rqd
);

206 #ifde‡
CONFIG_NVM_PBLK_DEBUG


207 
	`©omic_l⁄g_add
(
rqd
->
ƒ_µas
, &
pblk
->
sync_ªads
);

208 
	`©omic_l⁄g_sub
(
rqd
->
ƒ_µas
, &
pblk
->
öÊight_ªads
);

211 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_READ
);

212 
	`©omic_dec
(&
pblk
->
öÊight_io
);

213 
	}
}

215 
	$pblk_íd_io_ªad
(
nvm_rq
 *
rqd
)

217 
pblk
 *pblk = 
rqd
->
¥iv©e
;

218 
pblk_g_˘x
 *
r_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

219 
bio
 *biÿ(biÿ*)
r_˘x
->
¥iv©e
;

221 
	`pblk_íd_u£r_ªad
(
bio
, 
rqd
->
îr‹
);

222 
	`__pblk_íd_io_ªad
(
pblk
, 
rqd
, 
åue
);

223 
	}
}

225 
	$pblk_ªad_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
bio
 *bio,

226 
£˘‹_t
 
lba
, 
boﬁ
 *
‰om_ˇche
)

228 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
rqd
->
mëa_li°
, 0);

229 
µa_addr
 
µa
;

231 
	`pblk_lookup_l2p_£q
(
pblk
, &
µa
, 
lba
, 1, 
‰om_ˇche
);

233 #ifde‡
CONFIG_NVM_PBLK_DEBUG


234 
	`©omic_l⁄g_öc
(&
pblk
->
öÊight_ªads
);

237 
ªåy
:

238 i‡(
	`pblk_µa_em±y
(
µa
)) {

239 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

241 
mëa
->
lba
 = 
addr_em±y
;

248 i‡(
	`pblk_addr_ö_ˇche
(
µa
)) {

249 i‡(!
	`pblk_ªad_‰om_ˇche
(
pblk
, 
bio
, 
lba
, 
µa
)) {

250 
	`pblk_lookup_l2p_£q
(
pblk
, &
µa
, 
lba
, 1, 
‰om_ˇche
);

251 
ªåy
;

254 
mëa
->
lba
 = 
	`˝u_to_À64
(lba);

256 #ifde‡
CONFIG_NVM_PBLK_DEBUG


257 
	`©omic_l⁄g_öc
(&
pblk
->
ˇche_ªads
);

260 
rqd
->
µa_addr
 = 
µa
;

262 
	}
}

264 
	$pblk_submô_ªad
(
pblk
 *pblk, 
bio
 *bio)

266 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

267 
ªque°_queue
 *
q
 = 
dev
->q;

268 
£˘‹_t
 
blba
 = 
	`pblk_gë_lba
(
bio
);

269 
ƒ_£cs
 = 
	`pblk_gë_£cs
(
bio
);

270 
boﬁ
 
‰om_ˇche
;

271 
pblk_g_˘x
 *
r_˘x
;

272 
nvm_rq
 *
rqd
;

273 
bio
 *
öt_bio
, *
•lô_bio
;

275 
	`gíîic_°¨t_io_ac˘
(
q
, 
REQ_OP_READ
, 
	`bio_£˘‹s
(
bio
),

276 &
pblk
->
disk
->
∑π0
);

278 
rqd
 = 
	`pblk_Æloc_rqd
(
pblk
, 
PBLK_READ
);

280 
rqd
->
›code
 = 
NVM_OP_PREAD
;

281 
rqd
->
ƒ_µas
 = 
ƒ_£cs
;

282 
rqd
->
¥iv©e
 = 
pblk
;

283 
rqd
->
íd_io
 = 
pblk_íd_io_ªad
;

285 
r_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

286 
r_˘x
->
°¨t_time
 = 
jiffõs
;

287 
r_˘x
->
lba
 = 
blba
;

289 i‡(
	`pblk_Æloc_rqd_mëa
(
pblk
, 
rqd
)) {

290 
	`bio_io_îr‹
(
bio
);

291 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_READ
);

299 
öt_bio
 = 
	`bio_˛⁄e_Á°
(
bio
, 
GFP_KERNEL
, &
pblk_bio_£t
);

301 i‡(
ƒ_£cs
 > 1)

302 
ƒ_£cs
 = 
	`pblk_ªad_µÆi°_rq
(
pblk
, 
rqd
, 
öt_bio
, 
blba
,

303 &
‰om_ˇche
);

305 
	`pblk_ªad_rq
(
pblk
, 
rqd
, 
öt_bio
, 
blba
, &
‰om_ˇche
);

307 
•lô_ªåy
:

308 
r_˘x
->
¥iv©e
 = 
bio
;

309 
rqd
->
bio
 = 
öt_bio
;

311 i‡(
‰om_ˇche
 && 
ƒ_£cs
 =
rqd
->
ƒ_µas
) {

313 
	`pblk_íd_u£r_ªad
(
bio
, 0);

314 
	`©omic_öc
(&
pblk
->
öÊight_io
);

315 
	`__pblk_íd_io_ªad
(
pblk
, 
rqd
, 
Ál£
);

316 } i‡(
ƒ_£cs
 !
rqd
->
ƒ_µas
) {

323 
•lô_bio
 = 
	`bio_•lô
(
bio
, 
ƒ_£cs
 * 
NR_PHY_IN_LOG
, 
GFP_KERNEL
,

324 &
pblk_bio_£t
);

325 
	`bio_chaö
(
•lô_bio
, 
bio
);

326 
	`gíîic_make_ªque°
(
bio
);

334 
bio
 = 
•lô_bio
;

335 
rqd
->
ƒ_µas
 = 
ƒ_£cs
;

336 i‡(
rqd
->
ƒ_µas
 == 1)

337 
rqd
->
µa_addr
 =Ñqd->
µa_li°
[0];

342 
	`bio_put
(
öt_bio
);

343 
öt_bio
 = 
	`bio_˛⁄e_Á°
(
bio
, 
GFP_KERNEL
, &
pblk_bio_£t
);

344 
•lô_ªåy
;

345 } i‡(
	`pblk_submô_io
(
pblk
, 
rqd
, 
NULL
)) {

347 
rqd
->
îr‹
 = -
ENODEV
;

348 
	`pblk_íd_io_ªad
(
rqd
);

350 
	}
}

352 
	$ªad_µÆi°_rq_gc
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

353 
pblk_löe
 *
löe
, 
u64
 *
lba_li°
,

354 
u64
 *
∑ddr_li°_gc
, 
ƒ_£cs
)

356 
µa_addr
 
µa_li°_l2p
[
NVM_MAX_VLBA
];

357 
µa_addr
 
µa_gc
;

358 
vÆid_£cs
 = 0;

359 
i
;

361 
	`pblk_lookup_l2p_ønd
(
pblk
, 
µa_li°_l2p
, 
lba_li°
, 
ƒ_£cs
);

363 
i
 = 0; i < 
ƒ_£cs
; i++) {

364 i‡(
lba_li°
[
i
] =
ADDR_EMPTY
)

367 
µa_gc
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr_li°_gc
[
i
], 
löe
->
id
);

368 i‡(!
	`pblk_µa_comp
(
µa_li°_l2p
[
i
], 
µa_gc
)) {

369 
∑ddr_li°_gc
[
i
] = 
lba_li°
[i] = 
ADDR_EMPTY
;

373 
rqd
->
µa_li°
[
vÆid_£cs
++] = 
µa_li°_l2p
[
i
];

376 #ifde‡
CONFIG_NVM_PBLK_DEBUG


377 
	`©omic_l⁄g_add
(
vÆid_£cs
, &
pblk
->
öÊight_ªads
);

380  
vÆid_£cs
;

381 
	}
}

383 
	$ªad_rq_gc
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

384 
pblk_löe
 *
löe
, 
£˘‹_t
 
lba
,

385 
u64
 
∑ddr_gc
)

387 
µa_addr
 
µa_l2p
, 
µa_gc
;

388 
vÆid_£cs
 = 0;

390 i‡(
lba
 =
ADDR_EMPTY
)

391 
out
;

394 i‡(
lba
 >
pblk
->
ˇ∑côy
) {

395 
	`WARN
(1, "pblk:ÑeadÜba out of bounds\n");

396 
out
;

399 
	`•ö_lock
(&
pblk
->
å™s_lock
);

400 
µa_l2p
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
lba
);

401 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

403 
µa_gc
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr_gc
, 
löe
->
id
);

404 i‡(!
	`pblk_µa_comp
(
µa_l2p
, 
µa_gc
))

405 
out
;

407 
rqd
->
µa_addr
 = 
µa_l2p
;

408 
vÆid_£cs
 = 1;

410 #ifde‡
CONFIG_NVM_PBLK_DEBUG


411 
	`©omic_l⁄g_öc
(&
pblk
->
öÊight_ªads
);

414 
out
:

415  
vÆid_£cs
;

416 
	}
}

418 
	$pblk_submô_ªad_gc
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
)

420 
nvm_rq
 
rqd
;

421 
ªt
 = 
NVM_IO_OK
;

423 
	`mem£t
(&
rqd
, 0, (
nvm_rq
));

425 
ªt
 = 
	`pblk_Æloc_rqd_mëa
(
pblk
, &
rqd
);

426 i‡(
ªt
)

427  
ªt
;

429 i‡(
gc_rq
->
ƒ_£cs
 > 1) {

430 
gc_rq
->
£cs_to_gc
 = 
	`ªad_µÆi°_rq_gc
(
pblk
, &
rqd
, gc_rq->
löe
,

431 
gc_rq
->
lba_li°
,

432 
gc_rq
->
∑ddr_li°
,

433 
gc_rq
->
ƒ_£cs
);

434 i‡(
gc_rq
->
£cs_to_gc
 == 1)

435 
rqd
.
µa_addr
 =Ñqd.
µa_li°
[0];

437 
gc_rq
->
£cs_to_gc
 = 
	`ªad_rq_gc
(
pblk
, &
rqd
, gc_rq->
löe
,

438 
gc_rq
->
lba_li°
[0],

439 
gc_rq
->
∑ddr_li°
[0]);

442 i‡(!(
gc_rq
->
£cs_to_gc
))

443 
out
;

445 
rqd
.
›code
 = 
NVM_OP_PREAD
;

446 
rqd
.
ƒ_µas
 = 
gc_rq
->
£cs_to_gc
;

448 i‡(
	`pblk_submô_io_sync
(
pblk
, &
rqd
, 
gc_rq
->
d©a
)) {

449 
ªt
 = -
EIO
;

450 
îr_‰ì_dma
;

453 
	`pblk_ªad_check_ønd
(
pblk
, &
rqd
, 
gc_rq
->
lba_li°
, gc_rq->
ƒ_£cs
);

455 
	`©omic_dec
(&
pblk
->
öÊight_io
);

457 i‡(
rqd
.
îr‹
) {

458 
	`©omic_l⁄g_öc
(&
pblk
->
ªad_Áûed_gc
);

459 #ifde‡
CONFIG_NVM_PBLK_DEBUG


460 
	`pblk_¥öt_Áûed_rqd
(
pblk
, &
rqd
,Ñqd.
îr‹
);

464 #ifde‡
CONFIG_NVM_PBLK_DEBUG


465 
	`©omic_l⁄g_add
(
gc_rq
->
£cs_to_gc
, &
pblk
->
sync_ªads
);

466 
	`©omic_l⁄g_add
(
gc_rq
->
£cs_to_gc
, &
pblk
->
ªcov_gc_ªads
);

467 
	`©omic_l⁄g_sub
(
gc_rq
->
£cs_to_gc
, &
pblk
->
öÊight_ªads
);

470 
out
:

471 
	`pblk_‰ì_rqd_mëa
(
pblk
, &
rqd
);

472  
ªt
;

474 
îr_‰ì_dma
:

475 
	`pblk_‰ì_rqd_mëa
(
pblk
, &
rqd
);

476  
ªt
;

477 
	}
}

	@pblk-recovery.c

21 
	~"pblk.h
"

22 
	~"pblk-åa˚.h
"

24 
	$pblk_ªcov_check_emëa
(
pblk
 *pblk, 
löe_emëa
 *
emëa_buf
)

26 
u32
 
¸c
;

28 
¸c
 = 
	`pblk_ˇlc_emëa_¸c
(
pblk
, 
emëa_buf
);

29 i‡(
	`À32_to_˝u
(
emëa_buf
->
¸c
) != crc)

32 i‡(
	`À32_to_˝u
(
emëa_buf
->
hódî
.
idítifõr
Ë!
PBLK_MAGIC
)

36 
	}
}

38 
	$pblk_ªcov_l2p_‰om_emëa
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

40 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

41 
nvm_geo
 *
geo
 = &
dev
->geo;

42 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

43 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

44 
löe_emëa
 *
emëa_buf
 = 
emëa
->
buf
;

45 
__À64
 *
lba_li°
;

46 
u64
 
d©a_°¨t
, 
d©a_íd
;

47 
u64
 
ƒ_vÆid_lbas
, 
ƒ_lbas
 = 0;

48 
u64
 
i
;

50 
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
emëa_buf
);

51 i‡(!
lba_li°
)

54 
d©a_°¨t
 = 
	`pblk_löe_smëa_°¨t
(
pblk
, 
löe
Ë+ 
lm
->
smëa_£c
;

55 
d©a_íd
 = 
löe
->
emëa_s£c
;

56 
ƒ_vÆid_lbas
 = 
	`À64_to_˝u
(
emëa_buf
->nr_valid_lbas);

58 
i
 = 
d©a_°¨t
; i < 
d©a_íd
; i++) {

59 
µa_addr
 
µa
;

60 
pos
;

62 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
i
, 
löe
->
id
);

63 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

66 i‡(
	`ã°_bô
(
pos
, 
löe
->
blk_bôm≠
))

69 i‡(
	`À64_to_˝u
(
lba_li°
[
i
]Ë=
ADDR_EMPTY
) {

70 
	`•ö_lock
(&
löe
->
lock
);

71 i‡(
	`ã°_™d_£t_bô
(
i
, 
löe
->
övÆid_bôm≠
))

72 
	`WARN_ONCE
(1, "pblk:Ñec. double invalidate:\n");

74 
	`À32_add_˝u
(
löe
->
vsc
, -1);

75 
	`•ö_u∆ock
(&
löe
->
lock
);

80 
	`pblk_upd©e_m≠
(
pblk
, 
	`À64_to_˝u
(
lba_li°
[
i
]), 
µa
);

81 
ƒ_lbas
++;

84 i‡(
ƒ_vÆid_lbas
 !
ƒ_lbas
)

85 
	`pblk_îr
(
pblk
, "line %d - inconsistentÜbaÜist(%llu/%llu)\n",

86 
löe
->
id
, 
ƒ_vÆid_lbas
, 
ƒ_lbas
);

88 
löe
->
À·_m£cs
 = 0;

91 
	}
}

93 
	$pblk_upd©e_löe_wp
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

94 
u64
 
wrôãn_£cs
)

96 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

97 
i
;

99 
i
 = 0; i < 
wrôãn_£cs
; i +
pblk
->
mö_wrôe_pgs
)

100 
	`__pblk_Æloc_∑ge
(
pblk
, 
löe
,Öblk->
mö_wrôe_pgs
);

102 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

103 i‡(
wrôãn_£cs
 > 
löe
->
À·_m£cs
) {

108 
löe
->
À·_m£cs
 = 0;

111 
löe
->
À·_m£cs
 -
wrôãn_£cs
;

113 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

114 
	}
}

116 
u64
 
	$pblk_£c_ö_›í_löe
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

118 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

119 
ƒ_bb
 = 
	`bôm≠_weight
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

120 
u64
 
wrôãn_£cs
 = 0;

121 
vÆid_chunks
 = 0;

122 
i
;

124 
i
 = 0; i < 
lm
->
blk_≥r_löe
; i++) {

125 
nvm_chk_mëa
 *
chunk
 = &
löe
->
chks
[
i
];

127 i‡(
chunk
->
°©e
 & 
NVM_CHK_ST_OFFLINE
)

130 
wrôãn_£cs
 +
chunk
->
wp
;

131 
vÆid_chunks
++;

134 i‡(
lm
->
blk_≥r_löe
 - 
ƒ_bb
 !
vÆid_chunks
)

135 
	`pblk_îr
(
pblk
, "ªcovîyÜöê%d i†bad\n", 
löe
->
id
);

137 
	`pblk_upd©e_löe_wp
(
pblk
, 
löe
, 
wrôãn_£cs
 - 
lm
->
smëa_£c
);

139  
wrôãn_£cs
;

140 
	}
}

142 
	spblk_ªcov_Æloc
 {

143 
µa_addr
 *
	mµa_li°
;

144 *
	mmëa_li°
;

145 
nvm_rq
 *
	mrqd
;

146 *
	md©a
;

147 
dma_addr_t
 
	mdma_µa_li°
;

148 
dma_addr_t
 
	mdma_mëa_li°
;

151 
	$pblk_ªcov_com∂ëe
(
kªf
 *
ªf
)

153 
pblk_∑d_rq
 *
∑d_rq
 = 
	`c⁄èöî_of
(
ªf
, pblk_pad_rq,Ñef);

155 
	`com∂ëe
(&
∑d_rq
->
waô
);

156 
	}
}

158 
	$pblk_íd_io_ªcov
(
nvm_rq
 *
rqd
)

160 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

161 
pblk_∑d_rq
 *
∑d_rq
 = 
rqd
->
¥iv©e
;

162 
pblk
 *pblk = 
∑d_rq
->pblk;

164 
	`pblk_up_chunk
(
pblk
, 
µa_li°
[0]);

166 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

168 
	`©omic_dec
(&
pblk
->
öÊight_io
);

169 
	`kªf_put
(&
∑d_rq
->
ªf
, 
pblk_ªcov_com∂ëe
);

170 
	}
}

173 
	$pblk_ªcov_∑d_löe
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

174 
À·_µas
)

176 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

177 
nvm_geo
 *
geo
 = &
dev
->geo;

178 *
mëa_li°
;

179 
pblk_∑d_rq
 *
∑d_rq
;

180 
nvm_rq
 *
rqd
;

181 
µa_addr
 *
µa_li°
;

182 *
d©a
;

183 
__À64
 *
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
löe
->
emëa
->
buf
);

184 
u64
 
w_±r
 = 
löe
->
cur_£c
;

185 
À·_löe_µas
, 
rq_µas
;

186 
i
, 
j
;

187 
ªt
 = 0;

189 
	`•ö_lock
(&
löe
->
lock
);

190 
À·_löe_µas
 = 
löe
->
À·_m£cs
;

191 
	`•ö_u∆ock
(&
löe
->
lock
);

193 
∑d_rq
 = 
	`kmÆloc
((
pblk_∑d_rq
), 
GFP_KERNEL
);

194 i‡(!
∑d_rq
)

195  -
ENOMEM
;

197 
d©a
 = 
	`vzÆloc
(
	`¨øy_size
(
pblk
->
max_wrôe_pgs
, 
geo
->
c£cs
));

198 i‡(!
d©a
) {

199 
ªt
 = -
ENOMEM
;

200 
‰ì_rq
;

203 
∑d_rq
->
pblk
 =Öblk;

204 
	`öô_com∂ëi⁄
(&
∑d_rq
->
waô
);

205 
	`kªf_öô
(&
∑d_rq
->
ªf
);

207 
√xt_∑d_rq
:

208 
rq_µas
 = 
	`pblk_ˇlc_£cs
(
pblk
, 
À·_µas
, 0, 
Ál£
);

209 i‡(
rq_µas
 < 
pblk
->
mö_wrôe_pgs
) {

210 
	`pblk_îr
(
pblk
, "c‹ru±edÖadÜöê%d\n", 
löe
->
id
);

211 
Áû_com∂ëe
;

214 
rqd
 = 
	`pblk_Æloc_rqd
(
pblk
, 
PBLK_WRITE_INT
);

216 
ªt
 = 
	`pblk_Æloc_rqd_mëa
(
pblk
, 
rqd
);

217 i‡(
ªt
) {

218 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

219 
Áû_com∂ëe
;

222 
rqd
->
bio
 = 
NULL
;

223 
rqd
->
›code
 = 
NVM_OP_PWRITE
;

224 
rqd
->
is_£q
 = 1;

225 
rqd
->
ƒ_µas
 = 
rq_µas
;

226 
rqd
->
íd_io
 = 
pblk_íd_io_ªcov
;

227 
rqd
->
¥iv©e
 = 
∑d_rq
;

229 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

230 
mëa_li°
 = 
rqd
->meta_list;

232 
i
 = 0; i < 
rqd
->
ƒ_µas
; ) {

233 
µa_addr
 
µa
;

234 
pos
;

236 
w_±r
 = 
	`pblk_Æloc_∑ge
(
pblk
, 
löe
,Öblk->
mö_wrôe_pgs
);

237 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
w_±r
, 
löe
->
id
);

238 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

240 
	`ã°_bô
(
pos
, 
löe
->
blk_bôm≠
)) {

241 
w_±r
 +
pblk
->
mö_wrôe_pgs
;

242 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
w_±r
, 
löe
->
id
);

243 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

246 
j
 = 0; j < 
pblk
->
mö_wrôe_pgs
; j++, 
i
++, 
w_±r
++) {

247 
µa_addr
 
dev_µa
;

248 
pblk_£c_mëa
 *
mëa
;

249 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

251 
dev_µa
 = 
	`addr_to_gí_µa
(
pblk
, 
w_±r
, 
löe
->
id
);

253 
	`pblk_m≠_övÆid©e
(
pblk
, 
dev_µa
);

254 
lba_li°
[
w_±r
] = 
addr_em±y
;

255 
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

256 
mëa
->
lba
 = 
addr_em±y
;

257 
µa_li°
[
i
] = 
dev_µa
;

261 
	`kªf_gë
(&
∑d_rq
->
ªf
);

262 
	`pblk_down_chunk
(
pblk
, 
µa_li°
[0]);

264 
ªt
 = 
	`pblk_submô_io
(
pblk
, 
rqd
, 
d©a
);

265 i‡(
ªt
) {

266 
	`pblk_îr
(
pblk
, "I/O submissi⁄ faûed: %d\n", 
ªt
);

267 
	`pblk_up_chunk
(
pblk
, 
µa_li°
[0]);

268 
	`kªf_put
(&
∑d_rq
->
ªf
, 
pblk_ªcov_com∂ëe
);

269 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

270 
Áû_com∂ëe
;

273 
À·_löe_µas
 -
rq_µas
;

274 
À·_µas
 -
rq_µas
;

275 i‡(
À·_µas
 && 
À·_löe_µas
)

276 
√xt_∑d_rq
;

278 
Áû_com∂ëe
:

279 
	`kªf_put
(&
∑d_rq
->
ªf
, 
pblk_ªcov_com∂ëe
);

280 
	`waô_f‹_com∂ëi⁄
(&
∑d_rq
->
waô
);

282 i‡(!
	`pblk_löe_is_fuŒ
(
löe
))

283 
	`pblk_îr
(
pblk
, "c‹ru±edÖaddedÜöe: %d\n", 
löe
->
id
);

285 
	`v‰ì
(
d©a
);

286 
‰ì_rq
:

287 
	`k‰ì
(
∑d_rq
);

288  
ªt
;

289 
	}
}

291 
	$pblk_∑d_di°™˚
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

293 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

294 
nvm_geo
 *
geo
 = &
dev
->geo;

295 
di°™˚
 = 
geo
->
mw_cunôs
 * geo->
Æl_luns
 * geo->
ws_›t
;

297  (
di°™˚
 > 
löe
->
À·_m£cs
) ?Üine->left_msecs : distance;

298 
	}
}

301 
nvm_chk_mëa
 *
	$pblk_gë_°rùe_chunk
(
pblk
 *pblk,

302 
pblk_löe
 *
löe
,

303 
ödex
)

305 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

306 
nvm_geo
 *
geo
 = &
dev
->geo;

307 
pblk_lun
 *
æun
;

308 
µa_addr
 
µa
;

309 
pos
;

311 
æun
 = &
pblk
->
luns
[
ödex
];

312 
µa
 = 
æun
->
bµa
;

313 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

315  &
löe
->
chks
[
pos
];

316 
	}
}

318 
	$pblk_löe_wps_¨e_unbÆ™˚d
(
pblk
 *pblk,

319 
pblk_löe
 *
löe
)

321 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

322 
blk_ö_löe
 = 
lm
->
blk_≥r_löe
;

323 
nvm_chk_mëa
 *
chunk
;

324 
u64
 
max_wp
, 
mö_wp
;

325 
i
;

327 
i
 = 
	`föd_fú°_zîo_bô
(
löe
->
blk_bôm≠
, 
blk_ö_löe
);

332 i‡(
i
 >(
blk_ö_löe
 - 1))

335 
chunk
 = 
	`pblk_gë_°rùe_chunk
(
pblk
, 
löe
, 
i
);

336 
max_wp
 = 
chunk
->
wp
;

337 i‡(
max_wp
 > 
pblk
->
max_wrôe_pgs
)

338 
mö_wp
 = 
max_wp
 - 
pblk
->
max_wrôe_pgs
;

340 
mö_wp
 = 0;

342 
i
 = 
	`föd_√xt_zîo_bô
(
löe
->
blk_bôm≠
, 
blk_ö_löe
, i + 1);

343 
i
 < 
blk_ö_löe
) {

344 
chunk
 = 
	`pblk_gë_°rùe_chunk
(
pblk
, 
löe
, 
i
);

345 i‡(
chunk
->
wp
 > 
max_wp
 || chunk->w∞< 
mö_wp
)

348 
i
 = 
	`föd_√xt_zîo_bô
(
löe
->
blk_bôm≠
, 
blk_ö_löe
, i + 1);

352 
	}
}

354 
	$pblk_ªcov_sˇn_oob
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

355 
pblk_ªcov_Æloc
 
p
)

357 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

358 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

359 
nvm_geo
 *
geo
 = &
dev
->geo;

360 
µa_addr
 *
µa_li°
;

361 *
mëa_li°
;

362 
nvm_rq
 *
rqd
;

363 *
d©a
;

364 
dma_addr_t
 
dma_µa_li°
, 
dma_mëa_li°
;

365 
__À64
 *
lba_li°
;

366 
u64
 
∑ddr
 = 
	`pblk_löe_smëa_°¨t
(
pblk
, 
löe
Ë+ 
lm
->
smëa_£c
;

367 
boﬁ
 
∑dded
 = 
Ál£
;

368 
rq_µas
;

369 
i
, 
j
;

370 
ªt
;

371 
u64
 
À·_µas
 = 
	`pblk_£c_ö_›í_löe
(
pblk
, 
löe
Ë- 
lm
->
smëa_£c
;

373 i‡(
	`pblk_löe_wps_¨e_unbÆ™˚d
(
pblk
, 
löe
))

374 
	`pblk_w¨n
(
pblk
, "ªcovîög unbÆ™˚dÜöê(%d)\n", 
löe
->
id
);

376 
µa_li°
 = 
p
.ppa_list;

377 
mëa_li°
 = 
p
.meta_list;

378 
rqd
 = 
p
.rqd;

379 
d©a
 = 
p
.data;

380 
dma_µa_li°
 = 
p
.dma_ppa_list;

381 
dma_mëa_li°
 = 
p
.dma_meta_list;

383 
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
löe
->
emëa
->
buf
);

385 
√xt_rq
:

386 
	`mem£t
(
rqd
, 0, 
pblk_g_rq_size
);

388 
rq_µas
 = 
	`pblk_ˇlc_£cs
(
pblk
, 
À·_µas
, 0, 
Ál£
);

389 i‡(!
rq_µas
)

390 
rq_µas
 = 
pblk
->
mö_wrôe_pgs
;

392 
ªåy_rq
:

393 
rqd
->
bio
 = 
NULL
;

394 
rqd
->
›code
 = 
NVM_OP_PREAD
;

395 
rqd
->
mëa_li°
 = meta_list;

396 
rqd
->
ƒ_µas
 = 
rq_µas
;

397 
rqd
->
µa_li°
 =Öpa_list;

398 
rqd
->
dma_µa_li°
 = dma_ppa_list;

399 
rqd
->
dma_mëa_li°
 = dma_meta_list;

400 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

402 i‡(
	`pblk_io_Æig√d
(
pblk
, 
rq_µas
))

403 
rqd
->
is_£q
 = 1;

405 
i
 = 0; i < 
rqd
->
ƒ_µas
; ) {

406 
µa_addr
 
µa
;

407 
pos
;

409 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe
->
id
);

410 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

412 
	`ã°_bô
(
pos
, 
löe
->
blk_bôm≠
)) {

413 
∑ddr
 +
pblk
->
mö_wrôe_pgs
;

414 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
löe
->
id
);

415 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

418 
j
 = 0; j < 
pblk
->
mö_wrôe_pgs
; j++, 
i
++)

419 
µa_li°
[
i
] =

420 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
 + 
j
, 
löe
->
id
);

423 
ªt
 = 
	`pblk_submô_io_sync
(
pblk
, 
rqd
, 
d©a
);

424 i‡(
ªt
) {

425 
	`pblk_îr
(
pblk
, "I/O submissi⁄ faûed: %d\n", 
ªt
);

426  
ªt
;

429 
	`©omic_dec
(&
pblk
->
öÊight_io
);

432 i‡(
rqd
->
îr‹
 &&Ñqd->îr‹ !
NVM_RSP_WARN_HIGHECC
) {

433 
∑d_di°™˚
, 
ªt
;

435 i‡(
∑dded
) {

436 
	`pblk_log_ªad_îr
(
pblk
, 
rqd
);

437  -
EINTR
;

440 
∑d_di°™˚
 = 
	`pblk_∑d_di°™˚
(
pblk
, 
löe
);

441 
ªt
 = 
	`pblk_ªcov_∑d_löe
(
pblk
, 
löe
, 
∑d_di°™˚
);

442 i‡(
ªt
) {

443  
ªt
;

446 
∑dded
 = 
åue
;

447 
ªåy_rq
;

450 
	`pblk_gë_∑cked_mëa
(
pblk
, 
rqd
);

452 
i
 = 0; i < 
rqd
->
ƒ_µas
; i++) {

453 
pblk_£c_mëa
 *
mëa
 = 
	`pblk_gë_mëa
(
pblk
, 
mëa_li°
, 
i
);

454 
u64
 
lba
 = 
	`À64_to_˝u
(
mëa
->lba);

456 
lba_li°
[
∑ddr
++] = 
	`˝u_to_À64
(
lba
);

458 i‡(
lba
 =
ADDR_EMPTY
 ||Üb®>
pblk
->
ˇ∑côy
)

461 
löe
->
ƒ_vÆid_lbas
++;

462 
	`pblk_upd©e_m≠
(
pblk
, 
lba
, 
µa_li°
[
i
]);

465 
À·_µas
 -
rq_µas
;

466 i‡(
À·_µas
 > 0)

467 
√xt_rq
;

469 #ifde‡
CONFIG_NVM_PBLK_DEBUG


470 
	`WARN_ON
(
∑dded
 && !
	`pblk_löe_is_fuŒ
(
löe
));

474 
	}
}

477 
	$pblk_ªcov_l2p_‰om_oob
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

479 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

480 
nvm_geo
 *
geo
 = &
dev
->geo;

481 
nvm_rq
 *
rqd
;

482 
µa_addr
 *
µa_li°
;

483 *
mëa_li°
;

484 
pblk_ªcov_Æloc
 
p
;

485 *
d©a
;

486 
dma_addr_t
 
dma_µa_li°
, 
dma_mëa_li°
;

487 
ªt
 = 0;

489 
mëa_li°
 = 
	`nvm_dev_dma_Æloc
(
dev
->
∑ª¡
, 
GFP_KERNEL
, &
dma_mëa_li°
);

490 i‡(!
mëa_li°
)

491  -
ENOMEM
;

493 
µa_li°
 = (*)(
mëa_li°
Ë+ 
	`pblk_dma_mëa_size
(
pblk
);

494 
dma_µa_li°
 = 
dma_mëa_li°
 + 
	`pblk_dma_mëa_size
(
pblk
);

496 
d©a
 = 
	`kˇŒoc
(
pblk
->
max_wrôe_pgs
, 
geo
->
c£cs
, 
GFP_KERNEL
);

497 i‡(!
d©a
) {

498 
ªt
 = -
ENOMEM
;

499 
‰ì_mëa_li°
;

502 
rqd
 = 
	`mempoﬁ_Æloc
(&
pblk
->
r_rq_poﬁ
, 
GFP_KERNEL
);

503 
	`mem£t
(
rqd
, 0, 
pblk_g_rq_size
);

505 
p
.
µa_li°
 =Öpa_list;

506 
p
.
mëa_li°
 = meta_list;

507 
p
.
rqd
 =Ñqd;

508 
p
.
d©a
 = data;

509 
p
.
dma_µa_li°
 = dma_ppa_list;

510 
p
.
dma_mëa_li°
 = dma_meta_list;

512 
ªt
 = 
	`pblk_ªcov_sˇn_oob
(
pblk
, 
löe
, 
p
);

513 i‡(
ªt
) {

514 
	`pblk_îr
(
pblk
, "couldÇotÑecover L2P form OOB\n");

515 
out
;

518 i‡(
	`pblk_löe_is_fuŒ
(
löe
))

519 
	`pblk_löe_ªcov_˛o£
(
pblk
, 
löe
);

521 
out
:

522 
	`mempoﬁ_‰ì
(
rqd
, &
pblk
->
r_rq_poﬁ
);

523 
	`k‰ì
(
d©a
);

524 
‰ì_mëa_li°
:

525 
	`nvm_dev_dma_‰ì
(
dev
->
∑ª¡
, 
mëa_li°
, 
dma_mëa_li°
);

527  
ªt
;

528 
	}
}

531 
	$pblk_ªcov_löe_add_‹dîed
(
li°_hód
 *
hód
,

532 
pblk_löe
 *
löe
)

534 
pblk_löe
 *
t
 = 
NULL
;

536 
	`li°_f‹_óch_íåy
(
t
, 
hód
, 
li°
)

537 i‡(
t
->
£q_ƒ
 > 
löe
->seq_nr)

540 
	`__li°_add
(&
löe
->
li°
, 
t
->li°.
¥ev
, &t->list);

541 
	}
}

543 
u64
 
	$pblk_löe_emëa_°¨t
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

545 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

546 
nvm_geo
 *
geo
 = &
dev
->geo;

547 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

548 
emëa_£cs
;

549 
u64
 
emëa_°¨t
;

550 
µa_addr
 
µa
;

551 
pos
;

553 
emëa_£cs
 = 
lm
->
emëa_£c
[0];

554 
emëa_°¨t
 = 
lm
->
£c_≥r_löe
;

556 
emëa_£cs
) {

557 
emëa_°¨t
--;

558 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
emëa_°¨t
, 
löe
->
id
);

559 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
µa
);

560 i‡(!
	`ã°_bô
(
pos
, 
löe
->
blk_bôm≠
))

561 
emëa_£cs
--;

564  
emëa_°¨t
;

565 
	}
}

567 
	$pblk_ªcov_check_löe_vîsi⁄
(
pblk
 *pblk,

568 
löe_emëa
 *
emëa
)

570 
löe_hódî
 *
hódî
 = &
emëa
->header;

572 i‡(
hódî
->
vîsi⁄_maj‹
 !
EMETA_VERSION_MAJOR
) {

573 
	`pblk_îr
(
pblk
, "line major version mismatch: %d,Éxpected: %d\n",

574 
hódî
->
vîsi⁄_maj‹
, 
EMETA_VERSION_MAJOR
);

578 #ifde‡
CONFIG_NVM_PBLK_DEBUG


579 i‡(
hódî
->
vîsi⁄_mö‹
 > 
EMETA_VERSION_MINOR
)

580 
	`pblk_öfo
(
pblk
, "newerÜine minor version found: %d\n",

581 
hódî
->
vîsi⁄_mö‹
);

585 
	}
}

587 
	$pblk_ªcov_wa_cou¡îs
(
pblk
 *pblk,

588 
löe_emëa
 *
emëa
)

590 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

591 
löe_hódî
 *
hódî
 = &
emëa
->header;

592 
wa_cou¡îs
 *
wa
 = 
	`emëa_to_wa
(
lm
, 
emëa
);

595 i‡(
hódî
->
vîsi⁄_maj‹
 > 0 || hódî->
vîsi⁄_mö‹
 >= 2) {

596 
u64
 
u£r
 = 
	`À64_to_˝u
(
wa
->user);

597 
u64
 
∑d
 = 
	`À64_to_˝u
(
wa
->pad);

598 
u64
 
gc
 = 
	`À64_to_˝u
(
wa
->gc);

600 
	`©omic64_£t
(&
pblk
->
u£r_wa
, 
u£r
);

601 
	`©omic64_£t
(&
pblk
->
∑d_wa
, 
∑d
);

602 
	`©omic64_£t
(&
pblk
->
gc_wa
, 
gc
);

604 
pblk
->
u£r_r°_wa
 = 
u£r
;

605 
pblk
->
∑d_r°_wa
 = 
∑d
;

606 
pblk
->
gc_r°_wa
 = 
gc
;

608 
	}
}

610 
	$pblk_löe_was_wrôãn
(
pblk_löe
 *
löe
,

611 
pblk
 *pblk)

614 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

615 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

616 
nvm_geo
 *
geo
 = &
dev
->geo;

617 
nvm_chk_mëa
 *
chunk
;

618 
µa_addr
 
bµa
;

619 
smëa_blk
;

621 i‡(
löe
->
°©e
 =
PBLK_LINESTATE_BAD
)

624 
smëa_blk
 = 
	`föd_fú°_zîo_bô
(
löe
->
blk_bôm≠
, 
lm
->
blk_≥r_löe
);

625 i‡(
smëa_blk
 >
lm
->
blk_≥r_löe
)

628 
bµa
 = 
pblk
->
luns
[
smëa_blk
].bppa;

629 
chunk
 = &
löe
->
chks
[
	`pblk_µa_to_pos
(
geo
, 
bµa
)];

631 i‡(
chunk
->
°©e
 & 
NVM_CHK_ST_CLOSED
 ||

632 (
chunk
->
°©e
 & 
NVM_CHK_ST_OPEN


633 && 
chunk
->
wp
 >
lm
->
smëa_£c
))

637 
	}
}

639 
boﬁ
 
	$pblk_löe_is_›í
(
pblk
 *pblk, 
pblk_löe
 *
löe
)

641 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

642 
i
;

644 
i
 = 0; i < 
lm
->
blk_≥r_löe
; i++)

645 i‡(
löe
->
chks
[
i
].
°©e
 & 
NVM_CHK_ST_OPEN
)

646  
åue
;

648  
Ál£
;

649 
	}
}

651 
pblk_löe
 *
	$pblk_ªcov_l2p
(
pblk
 *pblk)

653 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

654 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

655 
pblk_löe
 *
löe
, *
éöe
, *
d©a_löe
 = 
NULL
;

656 
pblk_smëa
 *
smëa
;

657 
pblk_emëa
 *
emëa
;

658 
löe_smëa
 *
smëa_buf
;

659 
found_löes
 = 0, 
ªcovîed_löes
 = 0, 
›í_löes
 = 0;

660 
is_√xt
 = 0;

661 
mëa_löe
;

662 
i
, 
vÆid_uuid
 = 0;

663 
	`LIST_HEAD
(
ªcov_li°
);

668 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

669 
mëa_löe
 = 
	`föd_fú°_zîo_bô
(&
l_mg
->
mëa_bôm≠
, 
PBLK_DATA_LINES
);

670 
	`£t_bô
(
mëa_löe
, &
l_mg
->
mëa_bôm≠
);

671 
smëa
 = 
l_mg
->
¶öe_mëa
[
mëa_löe
];

672 
emëa
 = 
l_mg
->
ñöe_mëa
[
mëa_löe
];

673 
smëa_buf
 = (
löe_smëa
 *)
smëa
;

674 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

677 
i
 = 0; i < 
l_mg
->
ƒ_löes
; i++) {

678 
u32
 
¸c
;

680 
löe
 = &
pblk
->
löes
[
i
];

682 
	`mem£t
(
smëa
, 0, 
lm
->
smëa_Àn
);

683 
löe
->
smëa
 = smeta;

684 
löe
->
lun_bôm≠
 = ((*)(
smëa_buf
)) +

685 (
löe_smëa
);

687 i‡(!
	`pblk_löe_was_wrôãn
(
löe
, 
pblk
))

691 i‡(
	`pblk_löe_smëa_ªad
(
pblk
, 
löe
))

694 
¸c
 = 
	`pblk_ˇlc_smëa_¸c
(
pblk
, 
smëa_buf
);

695 i‡(
	`À32_to_˝u
(
smëa_buf
->
¸c
) != crc)

698 i‡(
	`À32_to_˝u
(
smëa_buf
->
hódî
.
idítifõr
Ë!
PBLK_MAGIC
)

701 i‡(
smëa_buf
->
hódî
.
vîsi⁄_maj‹
 !
SMETA_VERSION_MAJOR
) {

702 
	`pblk_îr
(
pblk
, "found incompatibleÜine version %u\n",

703 
smëa_buf
->
hódî
.
vîsi⁄_maj‹
);

704  
	`ERR_PTR
(-
EINVAL
);

708 i‡(!
vÆid_uuid
) {

709 
	`guid_c›y
(&
pblk
->
ö°™˚_uuid
,

710 (
guid_t
 *)&
smëa_buf
->
hódî
.
uuid
);

711 
vÆid_uuid
 = 1;

714 i‡(!
	`guid_equÆ
(&
pblk
->
ö°™˚_uuid
,

715 (
guid_t
 *)&
smëa_buf
->
hódî
.
uuid
)) {

716 
	`pblk_debug
(
pblk
, "ignoreÜine %u dueÅo uuid mismatch\n",

717 
i
);

722 
	`•ö_lock
(&
löe
->
lock
);

723 
löe
->
id
 = 
	`À32_to_˝u
(
smëa_buf
->
hódî
.id);

724 
löe
->
ty≥
 = 
	`À16_to_˝u
(
smëa_buf
->
hódî
.type);

725 
löe
->
£q_ƒ
 = 
	`À64_to_˝u
(
smëa_buf
->seq_nr);

726 
	`•ö_u∆ock
(&
löe
->
lock
);

729 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

730 i‡(
löe
->
£q_ƒ
 >
l_mg
->
d_£q_ƒ
)

731 
l_mg
->
d_£q_ƒ
 = 
löe
->
£q_ƒ
 + 1;

732 
l_mg
->
ƒ_‰ì_löes
--;

733 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

735 i‡(
	`pblk_löe_ªcov_Æloc
(
pblk
, 
löe
))

736 
out
;

738 
	`pblk_ªcov_löe_add_‹dîed
(&
ªcov_li°
, 
löe
);

739 
found_löes
++;

740 
	`pblk_debug
(
pblk
, "recovering dataÜine %d, seq:%llu\n",

741 
löe
->
id
, 
smëa_buf
->
£q_ƒ
);

744 i‡(!
found_löes
) {

745 
	`guid_gí
(&
pblk
->
ö°™˚_uuid
);

747 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

748 
	`WARN_ON_ONCE
(!
	`ã°_™d_˛ór_bô
(
mëa_löe
,

749 &
l_mg
->
mëa_bôm≠
));

750 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

752 
out
;

756 
	`li°_f‹_óch_íåy_ß„
(
löe
, 
éöe
, &
ªcov_li°
, 
li°
) {

757 
ªcovîed_löes
++;

759 
löe
->
emëa_s£c
 = 
	`pblk_löe_emëa_°¨t
(
pblk
,Üine);

760 
löe
->
emëa
 =Émeta;

761 
	`mem£t
(
löe
->
emëa
->
buf
, 0, 
lm
->
emëa_Àn
[0]);

763 i‡(
	`pblk_löe_is_›í
(
pblk
, 
löe
)) {

764 
	`pblk_ªcov_l2p_‰om_oob
(
pblk
, 
löe
);

765 
√xt
;

768 i‡(
	`pblk_löe_emëa_ªad
(
pblk
, 
löe
,Üöe->
emëa
->
buf
)) {

769 
	`pblk_ªcov_l2p_‰om_oob
(
pblk
, 
löe
);

770 
√xt
;

773 i‡(
	`pblk_ªcov_check_emëa
(
pblk
, 
löe
->
emëa
->
buf
)) {

774 
	`pblk_ªcov_l2p_‰om_oob
(
pblk
, 
löe
);

775 
√xt
;

778 i‡(
	`pblk_ªcov_check_löe_vîsi⁄
(
pblk
, 
löe
->
emëa
->
buf
))

779  
	`ERR_PTR
(-
EINVAL
);

781 
	`pblk_ªcov_wa_cou¡îs
(
pblk
, 
löe
->
emëa
->
buf
);

783 i‡(
	`pblk_ªcov_l2p_‰om_emëa
(
pblk
, 
löe
))

784 
	`pblk_ªcov_l2p_‰om_oob
(
pblk
, 
löe
);

786 
√xt
:

787 i‡(
	`pblk_löe_is_fuŒ
(
löe
)) {

788 
li°_hód
 *
move_li°
;

790 
	`•ö_lock
(&
löe
->
lock
);

791 
löe
->
°©e
 = 
PBLK_LINESTATE_CLOSED
;

792 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

793 
löe
->
°©e
);

794 
move_li°
 = 
	`pblk_löe_gc_li°
(
pblk
, 
löe
);

795 
	`•ö_u∆ock
(&
löe
->
lock
);

797 
	`•ö_lock
(&
l_mg
->
gc_lock
);

798 
	`li°_move_èû
(&
löe
->
li°
, 
move_li°
);

799 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

801 
	`mempoﬁ_‰ì
(
löe
->
m≠_bôm≠
, 
l_mg
->
bôm≠_poﬁ
);

802 
löe
->
m≠_bôm≠
 = 
NULL
;

803 
löe
->
smëa
 = 
NULL
;

804 
löe
->
emëa
 = 
NULL
;

806 
	`•ö_lock
(&
löe
->
lock
);

807 
löe
->
°©e
 = 
PBLK_LINESTATE_OPEN
;

808 
	`•ö_u∆ock
(&
löe
->
lock
);

810 
löe
->
emëa
->
mem
 = 0;

811 
	`©omic_£t
(&
löe
->
emëa
->
sync
, 0);

813 
	`åa˚_pblk_löe_°©e
(
	`pblk_disk_«me
(
pblk
), 
löe
->
id
,

814 
löe
->
°©e
);

816 
d©a_löe
 = 
löe
;

817 
löe
->
mëa_löe
 = meta_line;

819 
›í_löes
++;

823 i‡(!
›í_löes
) {

824 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

825 
	`WARN_ON_ONCE
(!
	`ã°_™d_˛ór_bô
(
mëa_löe
,

826 &
l_mg
->
mëa_bôm≠
));

827 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

829 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

830 
l_mg
->
d©a_löe
 = data_line;

832 
l_mg
->
d©a_√xt
 = 
	`pblk_löe_gë
(
pblk
);

833 i‡(
l_mg
->
d©a_√xt
) {

834 
l_mg
->
d©a_√xt
->
£q_ƒ
 =Ü_mg->
d_£q_ƒ
++;

835 
l_mg
->
d©a_√xt
->
ty≥
 = 
PBLK_LINETYPE_DATA
;

836 
is_√xt
 = 1;

838 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

841 i‡(
is_√xt
)

842 
	`pblk_löe_îa£
(
pblk
, 
l_mg
->
d©a_√xt
);

844 
out
:

845 i‡(
found_löes
 !
ªcovîed_löes
)

846 
	`pblk_îr
(
pblk
, "failedÅoÑecoveráll foundÜines %d/%d\n",

847 
found_löes
, 
ªcovîed_löes
);

849  
d©a_löe
;

850 
	}
}

855 
	$pblk_ªcov_∑d
(
pblk
 *pblk)

857 
pblk_löe
 *
löe
;

858 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

859 
À·_m£cs
;

860 
ªt
 = 0;

862 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

863 
löe
 = 
l_mg
->
d©a_löe
;

864 
À·_m£cs
 = 
löe
->left_msecs;

865 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

867 
ªt
 = 
	`pblk_ªcov_∑d_löe
(
pblk
, 
löe
, 
À·_m£cs
);

868 i‡(
ªt
) {

869 
	`pblk_îr
(
pblk
, "ã¨ dow¿∑ddög faûed (%d)\n", 
ªt
);

870  
ªt
;

873 
	`pblk_löe_˛o£_mëa
(
pblk
, 
löe
);

874  
ªt
;

875 
	}
}

	@pblk-rl.c

20 
	~"pblk.h
"

22 
	$pblk_æ_kick_u_timî
(
pblk_æ
 *
æ
)

24 
	`mod_timî
(&
æ
->
u_timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(5000));

25 
	}
}

27 
	$pblk_æ_is_limô
(
pblk_æ
 *
æ
)

29 
rb_•a˚
;

31 
rb_•a˚
 = 
	`©omic_ªad
(&
æ
->rb_space);

33  (
rb_•a˚
 == 0);

34 
	}
}

36 
	$pblk_æ_u£r_may_ö£π
(
pblk_æ
 *
æ
, 
ƒ_íåõs
)

38 
rb_u£r_˙t
 = 
	`©omic_ªad
(&
æ
->rb_user_cnt);

39 
rb_•a˚
 = 
	`©omic_ªad
(&
æ
->rb_space);

41 i‡(
	`u∆ikñy
(
rb_•a˚
 >0Ë&& (rb_•a˚ - 
ƒ_íåõs
 < 0))

42  
NVM_IO_ERR
;

44 i‡(
rb_u£r_˙t
 >
æ
->
rb_u£r_max
)

45  
NVM_IO_REQUEUE
;

47  
NVM_IO_OK
;

48 
	}
}

50 
	$pblk_æ_ö£πed
(
pblk_æ
 *
æ
, 
ƒ_íåõs
)

52 
rb_•a˚
 = 
	`©omic_ªad
(&
æ
->rb_space);

54 i‡(
	`u∆ikñy
(
rb_•a˚
 >= 0))

55 
	`©omic_sub
(
ƒ_íåõs
, &
æ
->
rb_•a˚
);

56 
	}
}

58 
	$pblk_æ_gc_may_ö£π
(
pblk_æ
 *
æ
, 
ƒ_íåõs
)

60 
rb_gc_˙t
 = 
	`©omic_ªad
(&
æ
->rb_gc_cnt);

61 
rb_u£r_a˘ive
;

64 
rb_u£r_a˘ive
 = 
	`READ_ONCE
(
æ
->rb_user_active);

65  (!(
rb_gc_˙t
 >
æ
->
rb_gc_max
 && 
rb_u£r_a˘ive
));

66 
	}
}

68 
	$pblk_æ_u£r_ö
(
pblk_æ
 *
æ
, 
ƒ_íåõs
)

70 
	`©omic_add
(
ƒ_íåõs
, &
æ
->
rb_u£r_˙t
);

73 
	`smp_°‹e_ªÀa£
(&
æ
->
rb_u£r_a˘ive
, 1);

74 
	`pblk_æ_kick_u_timî
(
æ
);

75 
	}
}

77 
	$pblk_æ_wîr_löe_ö
(
pblk_æ
 *
æ
)

79 
	`©omic_öc
(&
æ
->
wîr_löes
);

80 
	}
}

82 
	$pblk_æ_wîr_löe_out
(
pblk_æ
 *
æ
)

84 
	`©omic_dec
(&
æ
->
wîr_löes
);

85 
	}
}

87 
	$pblk_æ_gc_ö
(
pblk_æ
 *
æ
, 
ƒ_íåõs
)

89 
	`©omic_add
(
ƒ_íåõs
, &
æ
->
rb_gc_˙t
);

90 
	}
}

92 
	$pblk_æ_out
(
pblk_æ
 *
æ
, 
ƒ_u£r
, 
ƒ_gc
)

94 
	`©omic_sub
(
ƒ_u£r
, &
æ
->
rb_u£r_˙t
);

95 
	`©omic_sub
(
ƒ_gc
, &
æ
->
rb_gc_˙t
);

96 
	}
}

98 
	$pblk_æ_ƒ_‰ì_blks
(
pblk_æ
 *
æ
)

100  
	`©omic_ªad
(&
æ
->
‰ì_blocks
);

101 
	}
}

103 
	$pblk_æ_ƒ_u£r_‰ì_blks
(
pblk_æ
 *
æ
)

105  
	`©omic_ªad
(&
æ
->
‰ì_u£r_blocks
);

106 
	}
}

108 
	$__pblk_æ_upd©e_øãs
(
pblk_æ
 *
æ
,

109 
‰ì_blocks
)

111 
pblk
 *pblk = 
	`c⁄èöî_of
(
æ
, pblk,Ñl);

112 
max
 = 
æ
->
rb_budgë
;

113 
wîr_gc_√eded
 = 
	`©omic_ªad
(&
æ
->
wîr_löes
);

115 i‡(
‰ì_blocks
 >
æ
->
high
) {

116 i‡(
wîr_gc_√eded
) {

120 
æ
->
rb_gc_max
 = 1 <<Ñl->
rb_wödows_pw
;

121 
æ
->
rb_u£r_max
 = 
max
 -Ñl->
rb_gc_max
;

122 
æ
->
rb_°©e
 = 
PBLK_RL_WERR
;

124 
æ
->
rb_u£r_max
 = 
max
;

125 
æ
->
rb_gc_max
 = 0;

126 
æ
->
rb_°©e
 = 
PBLK_RL_OFF
;

128 } i‡(
‰ì_blocks
 < 
æ
->
high
) {

129 
shi·
 = 
æ
->
high_pw
 -Ñl->
rb_wödows_pw
;

130 
u£r_wödows
 = 
‰ì_blocks
 >> 
shi·
;

131 
u£r_max
 = 
u£r_wödows
 << 
	`ûog2
(
NVM_MAX_VLBA
);

133 
æ
->
rb_u£r_max
 = 
u£r_max
;

134 
æ
->
rb_gc_max
 = 
max
 - 
u£r_max
;

136 i‡(
‰ì_blocks
 <
æ
->
rsv_blocks
) {

137 
æ
->
rb_u£r_max
 = 0;

138 
æ
->
rb_gc_max
 = 
max
;

145 
æ
->
rb_°©e
 = 
PBLK_RL_LOW
;

148 i‡(
æ
->
rb_°©e
 !
PBLK_RL_OFF
)

149 
	`pblk_gc_should_°¨t
(
pblk
);

151 
	`pblk_gc_should_°›
(
pblk
);

152 
	}
}

154 
	$pblk_æ_upd©e_øãs
(
pblk_æ
 *
æ
)

156 
	`__pblk_æ_upd©e_øãs
(
æ
, 
	`pblk_æ_ƒ_u£r_‰ì_blks
(rl));

157 
	}
}

159 
	$pblk_æ_‰ì_löes_öc
(
pblk_æ
 *
æ
, 
pblk_löe
 *
löe
)

161 
blk_ö_löe
 = 
	`©omic_ªad
(&
löe
->blk_in_line);

162 
‰ì_blocks
;

164 
	`©omic_add
(
blk_ö_löe
, &
æ
->
‰ì_blocks
);

165 
‰ì_blocks
 = 
	`©omic_add_ªtu∫
(
blk_ö_löe
, &
æ
->
‰ì_u£r_blocks
);

167 
	`__pblk_æ_upd©e_øãs
(
æ
, 
‰ì_blocks
);

168 
	}
}

170 
	$pblk_æ_‰ì_löes_dec
(
pblk_æ
 *
æ
, 
pblk_löe
 *
löe
,

171 
boﬁ
 
u£d
)

173 
blk_ö_löe
 = 
	`©omic_ªad
(&
löe
->blk_in_line);

174 
‰ì_blocks
;

176 
	`©omic_sub
(
blk_ö_löe
, &
æ
->
‰ì_blocks
);

178 i‡(
u£d
)

179 
‰ì_blocks
 = 
	`©omic_sub_ªtu∫
(
blk_ö_löe
,

180 &
æ
->
‰ì_u£r_blocks
);

182 
‰ì_blocks
 = 
	`©omic_ªad
(&
æ
->
‰ì_u£r_blocks
);

184 
	`__pblk_æ_upd©e_øãs
(
æ
, 
‰ì_blocks
);

185 
	}
}

187 
	$pblk_æ_high_thrs
(
pblk_æ
 *
æ
)

189  
æ
->
high
;

190 
	}
}

192 
	$pblk_æ_max_io
(
pblk_æ
 *
æ
)

194  
æ
->
rb_max_io
;

195 
	}
}

197 
	$pblk_æ_u_timî
(
timî_li°
 *
t
)

199 
pblk_æ
 *
æ
 = 
	`‰om_timî
‘l, 
t
, 
u_timî
);

202 
	`smp_°‹e_ªÀa£
(&
æ
->
rb_u£r_a˘ive
, 0);

203 
	}
}

205 
	$pblk_æ_‰ì
(
pblk_æ
 *
æ
)

207 
	`dñ_timî
(&
æ
->
u_timî
);

208 
	}
}

210 
	$pblk_æ_öô
(
pblk_æ
 *
æ
, 
budgë
, 
thªshﬁd
)

212 
pblk
 *pblk = 
	`c⁄èöî_of
(
æ
, pblk,Ñl);

213 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

214 
nvm_geo
 *
geo
 = &
dev
->geo;

215 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

216 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

217 
£c_mëa
, 
blk_mëa
;

218 
rb_wödows
;

221 
£c_mëa
 = (
lm
->
smëa_£c
 +Üm->
emëa_£c
[0]Ë* 
l_mg
->
ƒ_‰ì_löes
;

222 
blk_mëa
 = 
	`DIV_ROUND_UP
(
£c_mëa
, 
geo
->
˛ba
);

224 
æ
->
high
 = 
pblk
->
›_blks
 - 
blk_mëa
 - 
lm
->
blk_≥r_löe
;

225 
æ
->
high_pw
 = 
	`gë_cou¡_‹dî
‘l->
high
);

227 
æ
->
rsv_blocks
 = 
	`pblk_gë_mö_chks
(
pblk
);

230 
rb_wödows
 = 
budgë
 / 
NVM_MAX_VLBA
;

231 
æ
->
rb_wödows_pw
 = 
	`gë_cou¡_‹dî
(
rb_wödows
);

234 
æ
->
rb_budgë
 = 
budgë
;

235 
æ
->
rb_u£r_max
 = 
budgë
;

236 
æ
->
rb_gc_max
 = 0;

237 
æ
->
rb_°©e
 = 
PBLK_RL_HIGH
;

240 i‡(
thªshﬁd
)

241 
æ
->
rb_max_io
 = 
budgë
 - 
pblk
->
mö_wrôe_pgs_d©a
 - 
thªshﬁd
;

243 
æ
->
rb_max_io
 = 
budgë
 - 
pblk
->
mö_wrôe_pgs_d©a
 - 1;

245 
	`©omic_£t
(&
æ
->
rb_u£r_˙t
, 0);

246 
	`©omic_£t
(&
æ
->
rb_gc_˙t
, 0);

247 
	`©omic_£t
(&
æ
->
rb_•a˚
, -1);

248 
	`©omic_£t
(&
æ
->
wîr_löes
, 0);

250 
	`timî_£tup
(&
æ
->
u_timî
, 
pblk_æ_u_timî
, 0);

252 
æ
->
rb_u£r_a˘ive
 = 0;

253 
æ
->
rb_gc_a˘ive
 = 0;

254 
	}
}

	@pblk-sysfs.c

22 
	~"pblk.h
"

24 
ssize_t
 
	$pblk_sysfs_luns_show
(
pblk
 *pblk, *
∑ge
)

26 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

27 
nvm_geo
 *
geo
 = &
dev
->geo;

28 
pblk_lun
 *
æun
;

29 
ssize_t
 
sz
 = 0;

30 
i
;

32 
i
 = 0; i < 
geo
->
Æl_luns
; i++) {

33 
a˘ive
 = 1;

35 
æun
 = &
pblk
->
luns
[
i
];

36 i‡(!
	`down_åylock
(&
æun
->
wr_£m
)) {

37 
a˘ive
 = 0;

38 
	`up
(&
æun
->
wr_£m
);

40 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

42 
i
,

43 
æun
->
bµa
.
a
.
ch
,

44 
æun
->
bµa
.
a
.
lun
,

45 
a˘ive
);

48  
sz
;

49 
	}
}

51 
ssize_t
 
	$pblk_sysfs_øã_limôî
(
pblk
 *pblk, *
∑ge
)

53 
‰ì_blocks
, 
‰ì_u£r_blocks
, 
tŸÆ_blocks
;

54 
rb_u£r_max
, 
rb_u£r_˙t
;

55 
rb_gc_max
, 
rb_gc_˙t
, 
rb_budgë
, 
rb_°©e
;

57 
‰ì_blocks
 = 
	`pblk_æ_ƒ_‰ì_blks
(&
pblk
->
æ
);

58 
‰ì_u£r_blocks
 = 
	`pblk_æ_ƒ_u£r_‰ì_blks
(&
pblk
->
æ
);

59 
rb_u£r_max
 = 
pblk
->
æ
.rb_user_max;

60 
rb_u£r_˙t
 = 
	`©omic_ªad
(&
pblk
->
æ
.rb_user_cnt);

61 
rb_gc_max
 = 
pblk
->
æ
.rb_gc_max;

62 
rb_gc_˙t
 = 
	`©omic_ªad
(&
pblk
->
æ
.rb_gc_cnt);

63 
rb_budgë
 = 
pblk
->
æ
.rb_budget;

64 
rb_°©e
 = 
pblk
->
æ
.rb_state;

66 
tŸÆ_blocks
 = 
pblk
->
æ
.total_blocks;

68  
	`¢¥ötf
(
∑ge
, 
PAGE_SIZE
,

70 
rb_u£r_˙t
,

71 
rb_u£r_max
,

72 
rb_gc_˙t
,

73 
rb_gc_max
,

74 
rb_°©e
,

75 
rb_budgë
,

76 
pblk
->
æ
.
high
,

77 
‰ì_blocks
,

78 
‰ì_u£r_blocks
,

79 
tŸÆ_blocks
,

80 
	`READ_ONCE
(
pblk
->
æ
.
rb_u£r_a˘ive
));

81 
	}
}

83 
ssize_t
 
	$pblk_sysfs_gc_°©e_show
(
pblk
 *pblk, *
∑ge
)

85 
gc_íabÀd
, 
gc_a˘ive
;

87 
	`pblk_gc_sysfs_°©e_show
(
pblk
, &
gc_íabÀd
, &
gc_a˘ive
);

88  
	`¢¥ötf
(
∑ge
, 
PAGE_SIZE
, "gc_enabled=%d, gc_active=%d\n",

89 
gc_íabÀd
, 
gc_a˘ive
);

90 
	}
}

92 
ssize_t
 
	$pblk_sysfs_°©s
(
pblk
 *pblk, *
∑ge
)

94 
ssize_t
 
sz
;

96 
sz
 = 
	`¢¥ötf
(
∑ge
, 
PAGE_SIZE
,

98 
	`©omic_l⁄g_ªad
(&
pblk
->
ªad_Áûed
),

99 
	`©omic_l⁄g_ªad
(&
pblk
->
ªad_high_ecc
),

100 
	`©omic_l⁄g_ªad
(&
pblk
->
ªad_em±y
),

101 
	`©omic_l⁄g_ªad
(&
pblk
->
ªad_Áûed_gc
),

102 
	`©omic_l⁄g_ªad
(&
pblk
->
wrôe_Áûed
),

103 
	`©omic_l⁄g_ªad
(&
pblk
->
îa£_Áûed
));

105  
sz
;

106 
	}
}

108 
ssize_t
 
	$pblk_sysfs_wrôe_buf„r
(
pblk
 *pblk, *
∑ge
)

110  
	`pblk_rb_sysfs
(&
pblk
->
rwb
, 
∑ge
);

111 
	}
}

113 
ssize_t
 
	$pblk_sysfs_µaf
(
pblk
 *pblk, *
∑ge
)

115 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

116 
nvm_geo
 *
geo
 = &
dev
->geo;

117 
ssize_t
 
sz
 = 0;

119 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
) {

120 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

121 
nvm_addrf_12
 *
gµaf
 = (nvm_addrf_12 *)&
geo
->
addrf
;

123 
sz
 = 
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

125 
pblk
->
addrf_Àn
,

126 
µaf
->
blk_off£t
,Ö∑f->
blk_Àn
,

127 
µaf
->
pg_off£t
,Ö∑f->
pg_Àn
,

128 
µaf
->
lun_off£t
,Ö∑f->
lun_Àn
,

129 
µaf
->
ch_off£t
,Ö∑f->
ch_Àn
,

130 
µaf
->
∂n_off£t
,Ö∑f->
∂n_Àn
,

131 
µaf
->
£c_off£t
,Ö∑f->
£c_Àn
);

133 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

135 
gµaf
->
blk_off£t
, gµaf->
blk_Àn
,

136 
gµaf
->
pg_off£t
, gµaf->
pg_Àn
,

137 
gµaf
->
lun_off£t
, gµaf->
lun_Àn
,

138 
gµaf
->
ch_off£t
, gµaf->
ch_Àn
,

139 
gµaf
->
∂n_off£t
, gµaf->
∂n_Àn
,

140 
gµaf
->
£c_off£t
, gµaf->
£c_Àn
);

142 
nvm_addrf
 *
µaf
 = &
pblk
->
addrf
;

143 
nvm_addrf
 *
gµaf
 = &
geo
->
addrf
;

145 
sz
 = 
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

147 
pblk
->
addrf_Àn
,

148 
µaf
->
ch_off£t
,Ö∑f->
ch_Àn
,

149 
µaf
->
lun_off£t
,Ö∑f->
lun_Àn
,

150 
µaf
->
chk_off£t
,Ö∑f->
chk_Àn
,

151 
µaf
->
£c_off£t
,Ö∑f->
£c_Àn
);

153 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

155 
gµaf
->
ch_off£t
, gµaf->
ch_Àn
,

156 
gµaf
->
lun_off£t
, gµaf->
lun_Àn
,

157 
gµaf
->
chk_off£t
, gµaf->
chk_Àn
,

158 
gµaf
->
£c_off£t
, gµaf->
£c_Àn
);

161  
sz
;

162 
	}
}

164 
ssize_t
 
	$pblk_sysfs_löes
(
pblk
 *pblk, *
∑ge
)

166 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

167 
nvm_geo
 *
geo
 = &
dev
->geo;

168 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

169 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

170 
pblk_löe
 *
löe
;

171 
ssize_t
 
sz
 = 0;

172 
ƒ_‰ì_löes
;

173 
cur_d©a
, 
cur_log
;

174 
‰ì_löe_˙t
 = 0, 
˛o£d_löe_˙t
 = 0, 
emëa_löe_˙t
 = 0;

175 
d_löe_˙t
 = 0, 
l_löe_˙t
 = 0;

176 
gc_fuŒ
 = 0, 
gc_high
 = 0, 
gc_mid
 = 0, 
gc_low
 = 0, 
gc_em±y
 = 0;

177 
gc_wîr
 = 0;

179 
bad
 = 0, 
c‹
 = 0;

180 
m£cs
 = 0, 
cur_£c
 = 0, 
vsc
 = 0, 
£c_ö_löe
 = 0;

181 
m≠_weight
 = 0, 
mëa_weight
 = 0;

183 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

184 
cur_d©a
 = (
l_mg
->
d©a_löe
Ë?Ü_mg->d©a_löe->
id
 : -1;

185 
cur_log
 = (
l_mg
->
log_löe
Ë?Ü_mg->log_löe->
id
 : -1;

186 
ƒ_‰ì_löes
 = 
l_mg
->nr_free_lines;

188 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
‰ì_li°
, 
li°
)

189 
‰ì_löe_˙t
++;

190 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

192 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

193 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
emëa_li°
, 
li°
)

194 
emëa_löe_˙t
++;

195 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

197 
	`•ö_lock
(&
l_mg
->
gc_lock
);

198 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_fuŒ_li°
, 
li°
) {

199 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

200 
d_löe_˙t
++;

201 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

202 
l_löe_˙t
++;

203 
˛o£d_löe_˙t
++;

204 
gc_fuŒ
++;

207 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_high_li°
, 
li°
) {

208 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

209 
d_löe_˙t
++;

210 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

211 
l_löe_˙t
++;

212 
˛o£d_löe_˙t
++;

213 
gc_high
++;

216 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_mid_li°
, 
li°
) {

217 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

218 
d_löe_˙t
++;

219 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

220 
l_löe_˙t
++;

221 
˛o£d_löe_˙t
++;

222 
gc_mid
++;

225 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_low_li°
, 
li°
) {

226 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

227 
d_löe_˙t
++;

228 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

229 
l_löe_˙t
++;

230 
˛o£d_löe_˙t
++;

231 
gc_low
++;

234 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_em±y_li°
, 
li°
) {

235 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

236 
d_löe_˙t
++;

237 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

238 
l_löe_˙t
++;

239 
˛o£d_löe_˙t
++;

240 
gc_em±y
++;

243 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
gc_wîr_li°
, 
li°
) {

244 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_DATA
)

245 
d_löe_˙t
++;

246 i‡(
löe
->
ty≥
 =
PBLK_LINETYPE_LOG
)

247 
l_löe_˙t
++;

248 
˛o£d_löe_˙t
++;

249 
gc_wîr
++;

252 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
bad_li°
, 
li°
)

253 
bad
++;

254 
	`li°_f‹_óch_íåy
(
löe
, &
l_mg
->
c‹ru±_li°
, 
li°
)

255 
c‹
++;

256 
	`•ö_u∆ock
(&
l_mg
->
gc_lock
);

258 
	`•ö_lock
(&
l_mg
->
‰ì_lock
);

259 i‡(
l_mg
->
d©a_löe
) {

260 
cur_£c
 = 
l_mg
->
d©a_löe
->cur_sec;

261 
m£cs
 = 
l_mg
->
d©a_löe
->
À·_m£cs
;

262 
vsc
 = 
	`À32_to_˝u
(*
l_mg
->
d©a_löe
->vsc);

263 
£c_ö_löe
 = 
l_mg
->
d©a_löe
->sec_in_line;

264 
mëa_weight
 = 
	`bôm≠_weight
(&
l_mg
->
mëa_bôm≠
,

265 
PBLK_DATA_LINES
);

267 
	`•ö_lock
(&
l_mg
->
d©a_löe
->
lock
);

268 i‡(
l_mg
->
d©a_löe
->
m≠_bôm≠
)

269 
m≠_weight
 = 
	`bôm≠_weight
(
l_mg
->
d©a_löe
->
m≠_bôm≠
,

270 
lm
->
£c_≥r_löe
);

272 
m≠_weight
 = 0;

273 
	`•ö_u∆ock
(&
l_mg
->
d©a_löe
->
lock
);

275 
	`•ö_u∆ock
(&
l_mg
->
‰ì_lock
);

277 i‡(
ƒ_‰ì_löes
 !
‰ì_löe_˙t
)

278 
	`pblk_îr
(
pblk
, "corrupted freeÜineÜist:%d/%d\n",

279 
ƒ_‰ì_löes
, 
‰ì_löe_˙t
);

281 
sz
 = 
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
 - sz,

283 
geo
->
Æl_luns
, 
lm
->
blk_≥r_löe
,Üm->
£c_≥r_löe
);

285 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

287 
cur_d©a
, 
cur_log
,

288 
ƒ_‰ì_löes
,

289 
emëa_löe_˙t
, 
mëa_weight
,

290 
˛o£d_löe_˙t
,

291 
bad
, 
c‹
,

292 
d_löe_˙t
, 
l_löe_˙t
,

293 
l_mg
->
ƒ_löes
);

295 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

297 
gc_fuŒ
, 
gc_high
, 
gc_mid
, 
gc_low
, 
gc_em±y
, 
gc_wîr
,

298 
	`©omic_ªad
(&
pblk
->
gc
.
ªad_öÊight_gc
));

300 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

302 
cur_d©a
, 
cur_£c
, 
m£cs
, 
vsc
, 
£c_ö_löe
,

303 
m≠_weight
, 
lm
->
£c_≥r_löe
,

304 
	`©omic_ªad
(&
pblk
->
öÊight_io
));

306  
sz
;

307 
	}
}

309 
ssize_t
 
	$pblk_sysfs_löes_öfo
(
pblk
 *pblk, *
∑ge
)

311 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

312 
nvm_geo
 *
geo
 = &
dev
->geo;

313 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

314 
ssize_t
 
sz
 = 0;

316 
sz
 = 
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
 - sz,

318 
lm
->
smëa_Àn
,Üm->
smëa_£c
);

319 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

321 
lm
->
emëa_Àn
[0],Üm->
emëa_£c
[0],

322 
lm
->
emëa_bb
);

323 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

325 
lm
->
£c_bôm≠_Àn
,

326 
lm
->
blk_bôm≠_Àn
,

327 
lm
->
lun_bôm≠_Àn
);

328 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

330 
lm
->
blk_≥r_löe
,

331 
lm
->
£c_≥r_löe
,

332 
geo
->
˛ba
);

334  
sz
;

335 
	}
}

337 
ssize_t
 
	$pblk_sysfs_gë_£c_≥r_wrôe
(
pblk
 *pblk, *
∑ge
)

339  
	`¢¥ötf
(
∑ge
, 
PAGE_SIZE
, "%d\n", 
pblk
->
£c_≥r_wrôe
);

340 
	}
}

342 
ssize_t
 
	$pblk_gë_wrôe_amp
(
u64
 
u£r
, u64 
gc
, u64 
∑d
,

343 *
∑ge
)

345 
sz
;

347 
sz
 = 
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

349 
u£r
, 
gc
, 
∑d
);

351 i‡(!
u£r
) {

352 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "NaN\n");

354 
u64
 
wa_öt
;

355 
u32
 
wa_‰ac
;

357 
wa_öt
 = (
u£r
 + 
gc
 + 
∑d
) * 100000;

358 
wa_öt
 = 
	`div64_u64
(wa_öt, 
u£r
);

359 
wa_öt
 = 
	`div_u64_ªm
(wa_öt, 100000, &
wa_‰ac
);

361 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "%llu.%05u\n",

362 
wa_öt
, 
wa_‰ac
);

365  
sz
;

366 
	}
}

368 
ssize_t
 
	$pblk_sysfs_gë_wrôe_amp_mûóge
(
pblk
 *pblk, *
∑ge
)

370  
	`pblk_gë_wrôe_amp
(
	`©omic64_ªad
(&
pblk
->
u£r_wa
),

371 
	`©omic64_ªad
(&
pblk
->
gc_wa
),átomic64_ªad(&pblk->
∑d_wa
),

372 
∑ge
);

373 
	}
}

375 
ssize_t
 
	$pblk_sysfs_gë_wrôe_amp_åù
(
pblk
 *pblk, *
∑ge
)

377  
	`pblk_gë_wrôe_amp
(

378 
	`©omic64_ªad
(&
pblk
->
u£r_wa
Ë-Öblk->
u£r_r°_wa
,

379 
	`©omic64_ªad
(&
pblk
->
gc_wa
Ë-Öblk->
gc_r°_wa
,

380 
	`©omic64_ªad
(&
pblk
->
∑d_wa
Ë-Öblk->
∑d_r°_wa
, 
∑ge
);

381 
	}
}

383 
	$buckë_≥r˚¡age
(
buckë
,

384 
tŸÆ
)

386 
p
 = 
buckë
 * 100;

388 
p
 = 
	`div_u64
’, 
tŸÆ
);

390  
p
;

391 
	}
}

393 
ssize_t
 
	$pblk_sysfs_gë_∑ddög_di°
(
pblk
 *pblk, *
∑ge
)

395 
sz
 = 0;

396 
tŸÆ
;

397 
tŸÆ_buckës
 = 0;

398 
buckës
 = 
pblk
->
mö_wrôe_pgs
 - 1;

399 
i
;

401 
tŸÆ
 = 
	`©omic64_ªad
(&
pblk
->
ƒ_Êush
Ë-Öblk->
ƒ_Êush_r°
;

402 i‡(!
tŸÆ
) {

403 
i
 = 0; i < (
buckës
 + 1); i++)

404 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz,

405 "%d:0 ", 
i
);

406 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "\n");

408  
sz
;

411 
i
 = 0; i < 
buckës
; i++)

412 
tŸÆ_buckës
 +
	`©omic64_ªad
(&
pblk
->
∑d_di°
[
i
]);

414 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "0:%lld%% ",

415 
	`buckë_≥r˚¡age
(
tŸÆ
 - 
tŸÆ_buckës
,Åotal));

417 
i
 = 0; i < 
buckës
; i++) {

418 
p
;

420 
p
 = 
	`buckë_≥r˚¡age
(
	`©omic64_ªad
(&
pblk
->
∑d_di°
[
i
]),

421 
tŸÆ
);

422 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "%d:%lld%% ",

423 
i
 + 1, 
p
);

425 
sz
 +
	`s˙¥ötf
(
∑ge
 + sz, 
PAGE_SIZE
 - sz, "\n");

427  
sz
;

428 
	}
}

430 #ifde‡
CONFIG_NVM_PBLK_DEBUG


431 
ssize_t
 
	$pblk_sysfs_°©s_debug
(
pblk
 *pblk, *
∑ge
)

433  
	`¢¥ötf
(
∑ge
, 
PAGE_SIZE
,

435 
	`©omic_l⁄g_ªad
(&
pblk
->
öÊight_wrôes
),

436 
	`©omic_l⁄g_ªad
(&
pblk
->
öÊight_ªads
),

437 
	`©omic_l⁄g_ªad
(&
pblk
->
ªq_wrôes
),

438 (
u64
)
	`©omic64_ªad
(&
pblk
->
ƒ_Êush
),

439 
	`©omic_l⁄g_ªad
(&
pblk
->
∑dded_wrôes
),

440 
	`©omic_l⁄g_ªad
(&
pblk
->
∑dded_wb
),

441 
	`©omic_l⁄g_ªad
(&
pblk
->
sub_wrôes
),

442 
	`©omic_l⁄g_ªad
(&
pblk
->
sync_wrôes
),

443 
	`©omic_l⁄g_ªad
(&
pblk
->
ªcov_wrôes
),

444 
	`©omic_l⁄g_ªad
(&
pblk
->
ªcov_gc_wrôes
),

445 
	`©omic_l⁄g_ªad
(&
pblk
->
ªcov_gc_ªads
),

446 
	`©omic_l⁄g_ªad
(&
pblk
->
ˇche_ªads
),

447 
	`©omic_l⁄g_ªad
(&
pblk
->
sync_ªads
));

448 
	}
}

451 
ssize_t
 
	$pblk_sysfs_gc_f‹˚
(
pblk
 *pblk, c⁄° *
∑ge
,

452 
size_t
 
Àn
)

454 
size_t
 
c_Àn
;

455 
f‹˚
;

457 
c_Àn
 = 
	`°rc•n
(
∑ge
, "\n");

458 i‡(
c_Àn
 >
Àn
)

459  -
EINVAL
;

461 i‡(
	`k°πouöt
(
∑ge
, 0, &
f‹˚
))

462  -
EINVAL
;

464 
	`pblk_gc_sysfs_f‹˚
(
pblk
, 
f‹˚
);

466  
Àn
;

467 
	}
}

469 
ssize_t
 
	$pblk_sysfs_£t_£c_≥r_wrôe
(
pblk
 *pblk,

470 c⁄° *
∑ge
, 
size_t
 
Àn
)

472 
size_t
 
c_Àn
;

473 
£c_≥r_wrôe
;

475 
c_Àn
 = 
	`°rc•n
(
∑ge
, "\n");

476 i‡(
c_Àn
 >
Àn
)

477  -
EINVAL
;

479 i‡(
	`k°πouöt
(
∑ge
, 0, &
£c_≥r_wrôe
))

480  -
EINVAL
;

482 i‡(!
	`pblk_is_oob_mëa_suµ‹ãd
(
pblk
)) {

486  -
EINVAL
;

489 i‡(
£c_≥r_wrôe
 < 
pblk
->
mö_wrôe_pgs


490 || 
£c_≥r_wrôe
 > 
pblk
->
max_wrôe_pgs


491 || 
£c_≥r_wrôe
 % 
pblk
->
mö_wrôe_pgs
 != 0)

492  -
EINVAL
;

494 
	`pblk_£t_£c_≥r_wrôe
(
pblk
, 
£c_≥r_wrôe
);

496  
Àn
;

497 
	}
}

499 
ssize_t
 
	$pblk_sysfs_£t_wrôe_amp_åù
(
pblk
 *pblk,

500 c⁄° *
∑ge
, 
size_t
 
Àn
)

502 
size_t
 
c_Àn
;

503 
ª£t_vÆue
;

505 
c_Àn
 = 
	`°rc•n
(
∑ge
, "\n");

506 i‡(
c_Àn
 >
Àn
)

507  -
EINVAL
;

509 i‡(
	`k°πouöt
(
∑ge
, 0, &
ª£t_vÆue
))

510  -
EINVAL
;

512 i‡(
ª£t_vÆue
 != 0)

513  -
EINVAL
;

515 
pblk
->
u£r_r°_wa
 = 
	`©omic64_ªad
(&pblk->
u£r_wa
);

516 
pblk
->
∑d_r°_wa
 = 
	`©omic64_ªad
(&pblk->
∑d_wa
);

517 
pblk
->
gc_r°_wa
 = 
	`©omic64_ªad
(&pblk->
gc_wa
);

519  
Àn
;

520 
	}
}

523 
ssize_t
 
	$pblk_sysfs_£t_∑ddög_di°
(
pblk
 *pblk,

524 c⁄° *
∑ge
, 
size_t
 
Àn
)

526 
size_t
 
c_Àn
;

527 
ª£t_vÆue
;

528 
buckës
 = 
pblk
->
mö_wrôe_pgs
 - 1;

529 
i
;

531 
c_Àn
 = 
	`°rc•n
(
∑ge
, "\n");

532 i‡(
c_Àn
 >
Àn
)

533  -
EINVAL
;

535 i‡(
	`k°πouöt
(
∑ge
, 0, &
ª£t_vÆue
))

536  -
EINVAL
;

538 i‡(
ª£t_vÆue
 != 0)

539  -
EINVAL
;

541 
i
 = 0; i < 
buckës
; i++)

542 
	`©omic64_£t
(&
pblk
->
∑d_di°
[
i
], 0);

544 
pblk
->
ƒ_Êush_r°
 = 
	`©omic64_ªad
(&pblk->
ƒ_Êush
);

546  
Àn
;

547 
	}
}

549 
©åibuã
 
	gsys_wrôe_luns
 = {

550 .
«me
 = "write_luns",

551 .
	gmode
 = 0444,

554 
©åibuã
 
	gsys_øã_limôî_©å
 = {

555 .
«me
 = "rate_limiter",

556 .
	gmode
 = 0444,

559 
©åibuã
 
	gsys_gc_°©e
 = {

560 .
«me
 = "gc_state",

561 .
	gmode
 = 0444,

564 
©åibuã
 
	gsys_îr‹s_©å
 = {

565 .
«me
 = "errors",

566 .
	gmode
 = 0444,

569 
©åibuã
 
	gsys_rb_©å
 = {

570 .
«me
 = "write_buffer",

571 .
	gmode
 = 0444,

574 
©åibuã
 
	gsys_°©s_µaf_©å
 = {

575 .
«me
 = "ppa_format",

576 .
	gmode
 = 0444,

579 
©åibuã
 
	gsys_löes_©å
 = {

580 .
«me
 = "lines",

581 .
	gmode
 = 0444,

584 
©åibuã
 
	gsys_löes_öfo_©å
 = {

585 .
«me
 = "lines_info",

586 .
	gmode
 = 0444,

589 
©åibuã
 
	gsys_gc_f‹˚
 = {

590 .
«me
 = "gc_force",

591 .
	gmode
 = 0200,

594 
©åibuã
 
	gsys_max_£c_≥r_wrôe
 = {

595 .
«me
 = "max_sec_per_write",

596 .
	gmode
 = 0644,

599 
©åibuã
 
	gsys_wrôe_amp_mûóge
 = {

600 .
«me
 = "write_amp_mileage",

601 .
	gmode
 = 0444,

604 
©åibuã
 
	gsys_wrôe_amp_åù
 = {

605 .
«me
 = "write_amp_trip",

606 .
	gmode
 = 0644,

609 
©åibuã
 
	gsys_∑ddög_di°
 = {

610 .
«me
 = "padding_dist",

611 .
	gmode
 = 0644,

614 #ifde‡
CONFIG_NVM_PBLK_DEBUG


615 
©åibuã
 
	gsys_°©s_debug_©å
 = {

616 .
«me
 = "stats",

617 .
	gmode
 = 0444,

621 
©åibuã
 *
	gpblk_©ås
[] = {

622 &
sys_wrôe_luns
,

623 &
sys_øã_limôî_©å
,

624 &
sys_îr‹s_©å
,

625 &
sys_gc_°©e
,

626 &
sys_gc_f‹˚
,

627 &
sys_max_£c_≥r_wrôe
,

628 &
sys_rb_©å
,

629 &
sys_°©s_µaf_©å
,

630 &
sys_löes_©å
,

631 &
sys_löes_öfo_©å
,

632 &
sys_wrôe_amp_mûóge
,

633 &
sys_wrôe_amp_åù
,

634 &
sys_∑ddög_di°
,

635 #ifde‡
CONFIG_NVM_PBLK_DEBUG


636 &
sys_°©s_debug_©å
,

638 
NULL
,

641 
ssize_t
 
	$pblk_sysfs_show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

642 *
buf
)

644 
pblk
 *pblk = 
	`c⁄èöî_of
(
kobj
, pblk, kobj);

646 i‡(
	`°rcmp
(
©å
->
«me
, "rate_limiter") == 0)

647  
	`pblk_sysfs_øã_limôî
(
pblk
, 
buf
);

648 i‡(
	`°rcmp
(
©å
->
«me
, "write_luns") == 0)

649  
	`pblk_sysfs_luns_show
(
pblk
, 
buf
);

650 i‡(
	`°rcmp
(
©å
->
«me
, "gc_state") == 0)

651  
	`pblk_sysfs_gc_°©e_show
(
pblk
, 
buf
);

652 i‡(
	`°rcmp
(
©å
->
«me
, "errors") == 0)

653  
	`pblk_sysfs_°©s
(
pblk
, 
buf
);

654 i‡(
	`°rcmp
(
©å
->
«me
, "write_buffer") == 0)

655  
	`pblk_sysfs_wrôe_buf„r
(
pblk
, 
buf
);

656 i‡(
	`°rcmp
(
©å
->
«me
, "ppa_format") == 0)

657  
	`pblk_sysfs_µaf
(
pblk
, 
buf
);

658 i‡(
	`°rcmp
(
©å
->
«me
, "lines") == 0)

659  
	`pblk_sysfs_löes
(
pblk
, 
buf
);

660 i‡(
	`°rcmp
(
©å
->
«me
, "lines_info") == 0)

661  
	`pblk_sysfs_löes_öfo
(
pblk
, 
buf
);

662 i‡(
	`°rcmp
(
©å
->
«me
, "max_sec_per_write") == 0)

663  
	`pblk_sysfs_gë_£c_≥r_wrôe
(
pblk
, 
buf
);

664 i‡(
	`°rcmp
(
©å
->
«me
, "write_amp_mileage") == 0)

665  
	`pblk_sysfs_gë_wrôe_amp_mûóge
(
pblk
, 
buf
);

666 i‡(
	`°rcmp
(
©å
->
«me
, "write_amp_trip") == 0)

667  
	`pblk_sysfs_gë_wrôe_amp_åù
(
pblk
, 
buf
);

668 i‡(
	`°rcmp
(
©å
->
«me
, "padding_dist") == 0)

669  
	`pblk_sysfs_gë_∑ddög_di°
(
pblk
, 
buf
);

670 #ifde‡
CONFIG_NVM_PBLK_DEBUG


671 i‡(
	`°rcmp
(
©å
->
«me
, "stats") == 0)

672  
	`pblk_sysfs_°©s_debug
(
pblk
, 
buf
);

675 
	}
}

677 
ssize_t
 
	$pblk_sysfs_°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

678 c⁄° *
buf
, 
size_t
 
Àn
)

680 
pblk
 *pblk = 
	`c⁄èöî_of
(
kobj
, pblk, kobj);

682 i‡(
	`°rcmp
(
©å
->
«me
, "gc_force") == 0)

683  
	`pblk_sysfs_gc_f‹˚
(
pblk
, 
buf
, 
Àn
);

684 i‡(
	`°rcmp
(
©å
->
«me
, "max_sec_per_write") == 0)

685  
	`pblk_sysfs_£t_£c_≥r_wrôe
(
pblk
, 
buf
, 
Àn
);

686 i‡(
	`°rcmp
(
©å
->
«me
, "write_amp_trip") == 0)

687  
	`pblk_sysfs_£t_wrôe_amp_åù
(
pblk
, 
buf
, 
Àn
);

688 i‡(
	`°rcmp
(
©å
->
«me
, "padding_dist") == 0)

689  
	`pblk_sysfs_£t_∑ddög_di°
(
pblk
, 
buf
, 
Àn
);

691 
	}
}

693 c⁄° 
sysfs_›s
 
	gpblk_sysfs_›s
 = {

694 .
show
 = 
pblk_sysfs_show
,

695 .
	g°‹e
 = 
pblk_sysfs_°‹e
,

698 
kobj_ty≥
 
	gpblk_kty≥
 = {

699 .
sysfs_›s
 = &
pblk_sysfs_›s
,

700 .
	gdeÁu…_©ås
 = 
pblk_©ås
,

703 
	$pblk_sysfs_öô
(
gídisk
 *
tdisk
)

705 
pblk
 *pblk = 
tdisk
->
¥iv©e_d©a
;

706 
devi˚
 *
∑ª¡_dev
 = 
	`disk_to_dev
(
pblk
->
disk
);

707 
ªt
;

709 
ªt
 = 
	`kobje˘_öô_™d_add
(&
pblk
->
kobj
, &
pblk_kty≥
,

710 
	`kobje˘_gë
(&
∑ª¡_dev
->
kobj
),

712 i‡(
ªt
) {

713 
	`pblk_îr
(
pblk
, "couldÇotÑegister\n");

714  
ªt
;

717 
	`kobje˘_uevít
(&
pblk
->
kobj
, 
KOBJ_ADD
);

719 
	}
}

721 
	$pblk_sysfs_exô
(
gídisk
 *
tdisk
)

723 
pblk
 *pblk = 
tdisk
->
¥iv©e_d©a
;

725 
	`kobje˘_uevít
(&
pblk
->
kobj
, 
KOBJ_REMOVE
);

726 
	`kobje˘_dñ
(&
pblk
->
kobj
);

727 
	`kobje˘_put
(&
pblk
->
kobj
);

728 
	}
}

	@pblk-trace.h

2 #unde‡
TRACE_SYSTEM


3 
	#TRACE_SYSTEM
 
pblk


	)

5 #i‡!
deföed
(
_TRACE_PBLK_H
Ë|| deföed(
TRACE_HEADER_MULTI_READ
)

6 
	#_TRACE_PBLK_H


	)

8 
	~<löux/åa˚poöt.h
>

10 
	gµa_addr
;

12 
	#show_chunk_Êags
(
°©e
Ë
	`__¥öt_Êags
(state, "", \

13 { 
NVM_CHK_ST_FREE
, "FREE", }, \

14 { 
NVM_CHK_ST_CLOSED
, "CLOSED", }, \

15 { 
NVM_CHK_ST_OPEN
, "OPEN", }, \

16 { 
NVM_CHK_ST_OFFLINE
, "OFFLINE", })

	)

18 
	#show_löe_°©e
(
°©e
Ë
	`__¥öt_symbﬁic
(state, \

19 { 
PBLK_LINESTATE_NEW
, "NEW", }, \

20 { 
PBLK_LINESTATE_FREE
, "FREE", }, \

21 { 
PBLK_LINESTATE_OPEN
, "OPEN", }, \

22 { 
PBLK_LINESTATE_CLOSED
, "CLOSED", }, \

23 { 
PBLK_LINESTATE_GC
, "GC", }, \

24 { 
PBLK_LINESTATE_BAD
, "BAD", }, \

25 { 
PBLK_LINESTATE_CORRUPT
, "CORRUPT" })

	)

28 
	#show_pblk_°©e
(
°©e
Ë
	`__¥öt_symbﬁic
(state, \

29 { 
PBLK_STATE_RUNNING
, "RUNNING", }, \

30 { 
PBLK_STATE_STOPPING
, "STOPPING", }, \

31 { 
PBLK_STATE_RECOVERING
, "RECOVERING", }, \

32 { 
PBLK_STATE_STOPPED
, "STOPPED" })

	)

34 
	#show_chunk_îa£_°©e
(
°©e
Ë
	`__¥öt_symbﬁic
(state, \

35 { 
PBLK_CHUNK_RESET_START
, "START", }, \

36 { 
PBLK_CHUNK_RESET_DONE
, "OK", }, \

37 { 
PBLK_CHUNK_RESET_FAILED
, "FAILED" })

	)

40 
TRACE_EVENT
(
pblk_chunk_ª£t
,

42 
TP_PROTO
(c⁄° *
«me
, 
µa_addr
 *
µa
, 
°©e
),

44 
TP_ARGS
(
«me
, 
µa
, 
°©e
),

46 
TP_STRUCT__íåy
(

47 
	$__°rög
(
«me
,Çame)

48 
	$__fõld
(
u64
, 
µa
)

49 
	`__fõld
(, 
°©e
)

52 
	`TP_Á°_assign
(

53 
	`__assign_°r
(
«me
,Çame);

54 
__íåy
->
µa
 =Öpa->ppa;

55 
__íåy
->
°©e
 = state;

58 
	`TP_¥ötk
("dev=%†gΩ=%ŒuÖu=%Œu chk=%Œu sèã=%s", 
	`__gë_°r
(
«me
),

59 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
gΩ
),

60 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
pu
),

61 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
chk
),

62 
	`show_chunk_îa£_°©e
(()
__íåy
->
°©e
))

66 
	`TRACE_EVENT
(
pblk_chunk_°©e
,

68 
	`TP_PROTO
(c⁄° *
«me
, 
µa_addr
 *
µa
, 
°©e
),

70 
	`TP_ARGS
(
«me
, 
µa
, 
°©e
),

72 
	`TP_STRUCT__íåy
(

73 
	$__°rög
(
«me
,Çame)

74 
	$__fõld
(
u64
, 
µa
)

75 
	`__fõld
(, 
°©e
)

78 
	`TP_Á°_assign
(

79 
	`__assign_°r
(
«me
,Çame);

80 
__íåy
->
µa
 =Öpa->ppa;

81 
__íåy
->
°©e
 = state;

84 
	`TP_¥ötk
("dev=%†gΩ=%ŒuÖu=%Œu chk=%Œu sèã=%s", 
	`__gë_°r
(
«me
),

85 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
gΩ
),

86 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
pu
),

87 (
u64
)(((
µa_addr
 *)(&
__íåy
->
µa
))->
m
.
chk
),

88 
	`show_chunk_Êags
(()
__íåy
->
°©e
))

92 
	`TRACE_EVENT
(
pblk_löe_°©e
,

94 
	`TP_PROTO
(c⁄° *
«me
, 
löe
, 
°©e
),

96 
	`TP_ARGS
(
«me
, 
löe
, 
°©e
),

98 
	`TP_STRUCT__íåy
(

99 
	$__°rög
(
«me
,Çame)

100 
	$__fõld
(, 
löe
)

101 
	`__fõld
(, 
°©e
)

104 
	`TP_Á°_assign
(

105 
	`__assign_°r
(
«me
,Çame);

106 
__íåy
->
löe
 =Üine;

107 
__íåy
->
°©e
 = state;

110 
	`TP_¥ötk
("dev=%†löe=%d sèã=%s", 
	`__gë_°r
(
«me
),

111 ()
__íåy
->
löe
,

112 
	`show_löe_°©e
(()
__íåy
->
°©e
))

116 
	`TRACE_EVENT
(
pblk_°©e
,

118 
	`TP_PROTO
(c⁄° *
«me
, 
°©e
),

120 
	`TP_ARGS
(
«me
, 
°©e
),

122 
	`TP_STRUCT__íåy
(

123 
	$__°rög
(
«me
,Çame)

124 
	`__fõld
(, 
°©e
)

127 
	`TP_Á°_assign
(

128 
	`__assign_°r
(
«me
,Çame);

129 
__íåy
->
°©e
 = state;

132 
	`TP_¥ötk
("dev=%†°©e=%s", 
	`__gë_°r
(
«me
),

133 
	`show_pblk_°©e
(()
__íåy
->
°©e
))

141 #unde‡
TRACE_INCLUDE_PATH


142 
	#TRACE_INCLUDE_PATH
 ../../
drivîs
/
lighävm


	)

143 #unde‡
TRACE_INCLUDE_FILE


144 
	#TRACE_INCLUDE_FILE
 
pblk
-
åa˚


	)

145 
	~<åa˚/deföe_åa˚.h
>

	@pblk-write.c

19 
	~"pblk.h
"

20 
	~"pblk-åa˚.h
"

22 
	$pblk_íd_w_bio
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

23 
pblk_c_˘x
 *
c_˘x
)

25 
bio
 *
‹igöÆ_bio
;

26 
pblk_rb
 *
rwb
 = &
pblk
->rwb;

27 
ªt
;

28 
i
;

30 
i
 = 0; i < 
c_˘x
->
ƒ_vÆid
; i++) {

31 
pblk_w_˘x
 *
w_˘x
;

32 
pos
 = 
c_˘x
->
£¡ry
 + 
i
;

33 
Êags
;

35 
w_˘x
 = 
	`pblk_rb_w_˘x
(
rwb
, 
pos
);

36 
Êags
 = 
	`READ_ONCE
(
w_˘x
->flags);

38 i‡(
Êags
 & 
PBLK_FLUSH_ENTRY
) {

39 
Êags
 &~
PBLK_FLUSH_ENTRY
;

41 
	`smp_°‹e_ªÀa£
(&
w_˘x
->
Êags
, flags);

43 #ifde‡
CONFIG_NVM_PBLK_DEBUG


44 
	`©omic_dec
(&
rwb
->
öÊight_Êush_poöt
);

48 (
‹igöÆ_bio
 = 
	`bio_li°_p›
(&
w_˘x
->
bios
)))

49 
	`bio_ídio
(
‹igöÆ_bio
);

52 i‡(
c_˘x
->
ƒ_∑dded
)

53 
	`pblk_bio_‰ì_∑ges
(
pblk
, 
rqd
->
bio
, 
c_˘x
->
ƒ_vÆid
,

54 
c_˘x
->
ƒ_∑dded
);

56 #ifde‡
CONFIG_NVM_PBLK_DEBUG


57 
	`©omic_l⁄g_add
(
rqd
->
ƒ_µas
, &
pblk
->
sync_wrôes
);

60 
ªt
 = 
	`pblk_rb_sync_adv™˚
(&
pblk
->
rwb
, 
c_˘x
->
ƒ_vÆid
);

62 
	`bio_put
(
rqd
->
bio
);

63 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

65  
ªt
;

66 
	}
}

68 
	$pblk_íd_queued_w_bio
(
pblk
 *pblk,

69 
nvm_rq
 *
rqd
,

70 
pblk_c_˘x
 *
c_˘x
)

72 
	`li°_dñ
(&
c_˘x
->
li°
);

73  
	`pblk_íd_w_bio
(
pblk
, 
rqd
, 
c_˘x
);

74 
	}
}

76 
	$pblk_com∂ëe_wrôe
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

77 
pblk_c_˘x
 *
c_˘x
)

79 
pblk_c_˘x
 *
c
, *
r
;

80 
Êags
;

81 
pos
;

83 #ifde‡
CONFIG_NVM_PBLK_DEBUG


84 
	`©omic_l⁄g_sub
(
c_˘x
->
ƒ_vÆid
, &
pblk
->
öÊight_wrôes
);

86 
	`pblk_up_rq
(
pblk
, 
c_˘x
->
lun_bôm≠
);

88 
pos
 = 
	`pblk_rb_sync_öô
(&
pblk
->
rwb
, &
Êags
);

89 i‡(
pos
 =
c_˘x
->
£¡ry
) {

90 
pos
 = 
	`pblk_íd_w_bio
(
pblk
, 
rqd
, 
c_˘x
);

92 
ªåy
:

93 
	`li°_f‹_óch_íåy_ß„
(
c
, 
r
, &
pblk
->
com∂_li°
, 
li°
) {

94 
rqd
 = 
	`nvm_rq_‰om_c_˘x
(
c
);

95 i‡(
c
->
£¡ry
 =
pos
) {

96 
pos
 = 
	`pblk_íd_queued_w_bio
(
pblk
, 
rqd
, 
c
);

97 
ªåy
;

101 
	`WARN_ON
(
	`nvm_rq_‰om_c_˘x
(
c_˘x
Ë!
rqd
);

102 
	`li°_add_èû
(&
c_˘x
->
li°
, &
pblk
->
com∂_li°
);

104 
	`pblk_rb_sync_íd
(&
pblk
->
rwb
, &
Êags
);

105 
	}
}

108 
	$pblk_m≠_ªmaöög
(
pblk
 *pblk, 
µa_addr
 *
µa
,

109 
rqd_µas
)

111 
pblk_löe
 *
löe
;

112 
µa_addr
 
m≠_µa
 = *
µa
;

113 
__À64
 
addr_em±y
 = 
	`˝u_to_À64
(
ADDR_EMPTY
);

114 
__À64
 *
lba_li°
;

115 
u64
 
∑ddr
;

116 
d⁄e
 = 0;

117 
n
 = 0;

119 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, *
µa
);

120 
lba_li°
 = 
	`emëa_to_lbas
(
pblk
, 
löe
->
emëa
->
buf
);

122 
	`•ö_lock
(&
löe
->
lock
);

124 !
d⁄e
) {

125 
∑ddr
 = 
	`pblk_dev_µa_to_löe_addr
(
pblk
, 
m≠_µa
);

127 i‡(!
	`ã°_™d_£t_bô
(
∑ddr
, 
löe
->
m≠_bôm≠
))

128 
löe
->
À·_m£cs
--;

130 i‡(
n
 < 
rqd_µas
 && 
lba_li°
[
∑ddr
] !
addr_em±y
)

131 
löe
->
ƒ_vÆid_lbas
--;

133 
lba_li°
[
∑ddr
] = 
addr_em±y
;

135 i‡(!
	`ã°_™d_£t_bô
(
∑ddr
, 
löe
->
övÆid_bôm≠
))

136 
	`À32_add_˝u
(
löe
->
vsc
, -1);

138 
d⁄e
 = 
	`nvm_√xt_µa_ö_chk
(
pblk
->
dev
, &
m≠_µa
);

140 
n
++;

143 
löe
->
w_îr_gc
->
has_wrôe_îr
 = 1;

144 
	`•ö_u∆ock
(&
löe
->
lock
);

145 
	}
}

147 
	$pblk_¥ï¨e_ªsubmô
(
pblk
 *pblk, 
£¡ry
,

148 
ƒ_íåõs
)

150 
pblk_rb
 *
rb
 = &
pblk
->
rwb
;

151 
pblk_rb_íåy
 *
íåy
;

152 
pblk_löe
 *
löe
;

153 
pblk_w_˘x
 *
w_˘x
;

154 
µa_addr
 
µa_l2p
;

155 
Êags
;

156 
i
;

158 
	`•ö_lock
(&
pblk
->
å™s_lock
);

159 
i
 = 0; i < 
ƒ_íåõs
; i++) {

160 
íåy
 = &
rb
->
íåõs
[
	`pblk_rb_±r_wøp
‘b, 
£¡ry
, 
i
)];

161 
w_˘x
 = &
íåy
->w_ctx;

164 i‡(
w_˘x
->
lba
 !
ADDR_EMPTY
) {

165 
µa_l2p
 = 
	`pblk_å™s_m≠_gë
(
pblk
, 
w_˘x
->
lba
);

166 i‡(!
	`pblk_µa_comp
(
µa_l2p
, 
íåy
->
ˇchñöe
))

167 
w_˘x
->
lba
 = 
ADDR_EMPTY
;

171 
Êags
 = 
	`READ_ONCE
(
w_˘x
->flags);

172 
Êags
 |
PBLK_WRITTEN_DATA
;

174 
	`smp_°‹e_ªÀa£
(&
w_˘x
->
Êags
, flags);

179 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
w_˘x
->
µa
);

180 
	`©omic_dec
(&
löe
->
£c_to_upd©e
);

181 
	`kªf_put
(&
löe
->
ªf
, 
pblk_löe_put
);

183 
	`•ö_u∆ock
(&
pblk
->
å™s_lock
);

184 
	}
}

186 
	$pblk_queue_ªsubmô
(
pblk
 *pblk, 
pblk_c_˘x
 *
c_˘x
)

188 
pblk_c_˘x
 *
r_˘x
;

190 
r_˘x
 = 
	`kzÆloc
((
pblk_c_˘x
), 
GFP_KERNEL
);

191 i‡(!
r_˘x
)

194 
r_˘x
->
lun_bôm≠
 = 
NULL
;

195 
r_˘x
->
£¡ry
 = 
c_˘x
->sentry;

196 
r_˘x
->
ƒ_vÆid
 = 
c_˘x
->nr_valid;

197 
r_˘x
->
ƒ_∑dded
 = 
c_˘x
->nr_padded;

199 
	`•ö_lock
(&
pblk
->
ªsubmô_lock
);

200 
	`li°_add_èû
(&
r_˘x
->
li°
, &
pblk
->
ªsubmô_li°
);

201 
	`•ö_u∆ock
(&
pblk
->
ªsubmô_lock
);

203 #ifde‡
CONFIG_NVM_PBLK_DEBUG


204 
	`©omic_l⁄g_add
(
c_˘x
->
ƒ_vÆid
, &
pblk
->
ªcov_wrôes
);

206 
	}
}

208 
	$pblk_submô_ªc
(
w‹k_°ru˘
 *
w‹k
)

210 
pblk_ªc_˘x
 *
ªcovîy
 =

211 
	`c⁄èöî_of
(
w‹k
, 
pblk_ªc_˘x
, 
ws_ªc
);

212 
pblk
 *pblk = 
ªcovîy
->pblk;

213 
nvm_rq
 *
rqd
 = 
ªcovîy
->rqd;

214 
pblk_c_˘x
 *
c_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

215 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

217 
	`pblk_log_wrôe_îr
(
pblk
, 
rqd
);

219 
	`pblk_m≠_ªmaöög
(
pblk
, 
µa_li°
, 
rqd
->
ƒ_µas
);

220 
	`pblk_queue_ªsubmô
(
pblk
, 
c_˘x
);

222 
	`pblk_up_rq
(
pblk
, 
c_˘x
->
lun_bôm≠
);

223 i‡(
c_˘x
->
ƒ_∑dded
)

224 
	`pblk_bio_‰ì_∑ges
(
pblk
, 
rqd
->
bio
, 
c_˘x
->
ƒ_vÆid
,

225 
c_˘x
->
ƒ_∑dded
);

226 
	`bio_put
(
rqd
->
bio
);

227 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

228 
	`mempoﬁ_‰ì
(
ªcovîy
, &
pblk
->
ªc_poﬁ
);

230 
	`©omic_dec
(&
pblk
->
öÊight_io
);

231 
	`pblk_wrôe_kick
(
pblk
);

232 
	}
}

235 
	$pblk_íd_w_Áû
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

237 
pblk_ªc_˘x
 *
ªcovîy
;

239 
ªcovîy
 = 
	`mempoﬁ_Æloc
(&
pblk
->
ªc_poﬁ
, 
GFP_ATOMIC
);

240 i‡(!
ªcovîy
) {

241 
	`pblk_îr
(
pblk
, "couldÇotállocateÑecovery work\n");

245 
ªcovîy
->
pblk
 =Öblk;

246 
ªcovîy
->
rqd
 =Ñqd;

248 
	`INIT_WORK
(&
ªcovîy
->
ws_ªc
, 
pblk_submô_ªc
);

249 
	`queue_w‹k
(
pblk
->
˛o£_wq
, &
ªcovîy
->
ws_ªc
);

250 
	}
}

252 
	$pblk_íd_io_wrôe
(
nvm_rq
 *
rqd
)

254 
pblk
 *pblk = 
rqd
->
¥iv©e
;

255 
pblk_c_˘x
 *
c_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

257 i‡(
rqd
->
îr‹
) {

258 
	`pblk_íd_w_Áû
(
pblk
, 
rqd
);

261 i‡(
	`åa˚_pblk_chunk_°©e_íabÀd
())

262 
	`pblk_check_chunk_°©e_upd©e
(
pblk
, 
rqd
);

263 #ifde‡
CONFIG_NVM_PBLK_DEBUG


264 
	`WARN_ONCE
(
rqd
->
bio
->
bi_°©us
, "pblk: corrupted writeÉrror\n");

268 
	`pblk_com∂ëe_wrôe
(
pblk
, 
rqd
, 
c_˘x
);

269 
	`©omic_dec
(&
pblk
->
öÊight_io
);

270 
	}
}

272 
	$pblk_íd_io_wrôe_mëa
(
nvm_rq
 *
rqd
)

274 
pblk
 *pblk = 
rqd
->
¥iv©e
;

275 
pblk_g_˘x
 *
m_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

276 
pblk_löe
 *
löe
 = 
m_˘x
->
¥iv©e
;

277 
pblk_emëa
 *
emëa
 = 
löe
->emeta;

278 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

279 
sync
;

281 
	`pblk_up_chunk
(
pblk
, 
µa_li°
[0]);

283 i‡(
rqd
->
îr‹
) {

284 
	`pblk_log_wrôe_îr
(
pblk
, 
rqd
);

285 
	`pblk_îr
(
pblk
, "mëad©®I/O faûed. Löê%d\n", 
löe
->
id
);

286 
löe
->
w_îr_gc
->
has_wrôe_îr
 = 1;

288 i‡(
	`åa˚_pblk_chunk_°©e_íabÀd
())

289 
	`pblk_check_chunk_°©e_upd©e
(
pblk
, 
rqd
);

292 
sync
 = 
	`©omic_add_ªtu∫
(
rqd
->
ƒ_µas
, &
emëa
->sync);

293 i‡(
sync
 =
emëa
->
ƒ_íåõs
)

294 
	`pblk_gí_run_ws
(
pblk
, 
löe
, 
NULL
, 
pblk_löe_˛o£_ws
,

295 
GFP_ATOMIC
, 
pblk
->
˛o£_wq
);

297 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

299 
	`©omic_dec
(&
pblk
->
öÊight_io
);

300 
	}
}

302 
pblk_Æloc_w_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

303 
ƒ_£cs
, 
	$nvm_íd_io_‚
(*
íd_io
))

306 
rqd
->
›code
 = 
NVM_OP_PWRITE
;

307 
rqd
->
ƒ_µas
 = 
ƒ_£cs
;

308 
rqd
->
is_£q
 = 1;

309 
rqd
->
¥iv©e
 = 
pblk
;

310 
rqd
->
íd_io
 =Énd_io;

312  
	`pblk_Æloc_rqd_mëa
(
pblk
, 
rqd
);

313 
	}
}

315 
	$pblk_£tup_w_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

316 
µa_addr
 *
îa£_µa
)

318 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

319 
pblk_löe
 *
e_löe
 = 
	`pblk_löe_gë_îa£
(
pblk
);

320 
pblk_c_˘x
 *
c_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

321 
vÆid
 = 
c_˘x
->
ƒ_vÆid
;

322 
∑dded
 = 
c_˘x
->
ƒ_∑dded
;

323 
ƒ_£cs
 = 
vÆid
 + 
∑dded
;

324 *
lun_bôm≠
;

325 
ªt
;

327 
lun_bôm≠
 = 
	`kzÆloc
(
lm
->
lun_bôm≠_Àn
, 
GFP_KERNEL
);

328 i‡(!
lun_bôm≠
)

329  -
ENOMEM
;

330 
c_˘x
->
lun_bôm≠
 =Üun_bitmap;

332 
ªt
 = 
	`pblk_Æloc_w_rq
(
pblk
, 
rqd
, 
ƒ_£cs
, 
pblk_íd_io_wrôe
);

333 i‡(
ªt
) {

334 
	`k‰ì
(
lun_bôm≠
);

335  
ªt
;

338 i‡(
	`likñy
(!
e_löe
 || !
	`©omic_ªad
(&e_löe->
À·_eblks
)))

339 
ªt
 = 
	`pblk_m≠_rq
(
pblk
, 
rqd
, 
c_˘x
->
£¡ry
, 
lun_bôm≠
,

340 
vÆid
, 0);

342 
ªt
 = 
	`pblk_m≠_îa£_rq
(
pblk
, 
rqd
, 
c_˘x
->
£¡ry
, 
lun_bôm≠
,

343 
vÆid
, 
îa£_µa
);

345  
ªt
;

346 
	}
}

348 
	$pblk_ˇlc_£cs_to_sync
(
pblk
 *pblk, 
£cs_avaû
,

349 
£cs_to_Êush
)

351 
£cs_to_sync
;

353 
£cs_to_sync
 = 
	`pblk_ˇlc_£cs
(
pblk
, 
£cs_avaû
, 
£cs_to_Êush
, 
åue
);

355 #ifde‡
CONFIG_NVM_PBLK_DEBUG


356 i‡((!
£cs_to_sync
 && 
£cs_to_Êush
)

357 || (
£cs_to_sync
 < 0)

358 || (
£cs_to_sync
 > 
£cs_avaû
 && !
£cs_to_Êush
)) {

359 
	`pblk_îr
(
pblk
, "bad sector calculation (a:%d,s:%d,f:%d)\n",

360 
£cs_avaû
, 
£cs_to_sync
, 
£cs_to_Êush
);

364  
£cs_to_sync
;

365 
	}
}

367 
	$pblk_submô_mëa_io
(
pblk
 *pblk, 
pblk_löe
 *
mëa_löe
)

369 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

370 
nvm_geo
 *
geo
 = &
dev
->geo;

371 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

372 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

373 
pblk_emëa
 *
emëa
 = 
mëa_löe
->emeta;

374 
µa_addr
 *
µa_li°
;

375 
pblk_g_˘x
 *
m_˘x
;

376 
nvm_rq
 *
rqd
;

377 *
d©a
;

378 
u64
 
∑ddr
;

379 
rq_µas
 = 
pblk
->
mö_wrôe_pgs
;

380 
id
 = 
mëa_löe
->id;

381 
rq_Àn
;

382 
i
, 
j
;

383 
ªt
;

385 
rqd
 = 
	`pblk_Æloc_rqd
(
pblk
, 
PBLK_WRITE_INT
);

387 
m_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

388 
m_˘x
->
¥iv©e
 = 
mëa_löe
;

390 
rq_Àn
 = 
rq_µas
 * 
geo
->
c£cs
;

391 
d©a
 = ((*)
emëa
->
buf
Ë+Émëa->
mem
;

393 
ªt
 = 
	`pblk_Æloc_w_rq
(
pblk
, 
rqd
, 
rq_µas
, 
pblk_íd_io_wrôe_mëa
);

394 i‡(
ªt
)

395 
Áû_‰ì_rqd
;

397 
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

398 
i
 = 0; i < 
rqd
->
ƒ_µas
; ) {

399 
	`•ö_lock
(&
mëa_löe
->
lock
);

400 
∑ddr
 = 
	`__pblk_Æloc_∑ge
(
pblk
, 
mëa_löe
, 
rq_µas
);

401 
	`•ö_u∆ock
(&
mëa_löe
->
lock
);

402 
j
 = 0; j < 
rq_µas
; j++, 
i
++, 
∑ddr
++)

403 
µa_li°
[
i
] = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 
id
);

406 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

407 
emëa
->
mem
 +
rq_Àn
;

408 i‡(
emëa
->
mem
 >
lm
->
emëa_Àn
[0])

409 
	`li°_dñ
(&
mëa_löe
->
li°
);

410 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

412 
	`pblk_down_chunk
(
pblk
, 
µa_li°
[0]);

414 
ªt
 = 
	`pblk_submô_io
(
pblk
, 
rqd
, 
d©a
);

415 i‡(
ªt
) {

416 
	`pblk_îr
(
pblk
, "emë®I/O submissi⁄ faûed: %d\n", 
ªt
);

417 
Áû_rﬁlback
;

420  
NVM_IO_OK
;

422 
Áû_rﬁlback
:

423 
	`pblk_up_chunk
(
pblk
, 
µa_li°
[0]);

424 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

425 
	`pblk_dóŒoc_∑ge
(
pblk
, 
mëa_löe
, 
rq_µas
);

426 
	`li°_add
(&
mëa_löe
->
li°
, &meta_line->list);

427 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

428 
Áû_‰ì_rqd
:

429 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE_INT
);

430  
ªt
;

431 
	}
}

433 
ölöe
 
boﬁ
 
	$pblk_vÆid_mëa_µa
(
pblk
 *pblk,

434 
pblk_löe
 *
mëa_löe
,

435 
nvm_rq
 *
d©a_rqd
)

437 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

438 
nvm_geo
 *
geo
 = &
dev
->geo;

439 
pblk_c_˘x
 *
d©a_c_˘x
 = 
	`nvm_rq_to_pdu
(
d©a_rqd
);

440 
pblk_löe
 *
d©a_löe
 = 
	`pblk_löe_gë_d©a
(
pblk
);

441 
µa_addr
 
µa
, 
µa_›t
;

442 
u64
 
∑ddr
;

443 
pos_›t
;

454 
∑ddr
 = 
	`pblk_lookup_∑ge
(
pblk
, 
mëa_löe
);

455 
µa
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
, 0);

456 
µa_›t
 = 
	`addr_to_gí_µa
(
pblk
, 
∑ddr
 + 
d©a_löe
->
mëa_di°™˚
, 0);

457 
pos_›t
 = 
	`pblk_µa_to_pos
(
geo
, 
µa_›t
);

459 i‡(
	`ã°_bô
(
pos_›t
, 
d©a_c_˘x
->
lun_bôm≠
) ||

460 
	`ã°_bô
(
pos_›t
, 
d©a_löe
->
blk_bôm≠
))

461  
åue
;

463 i‡(
	`u∆ikñy
(
	`pblk_µa_comp
(
µa_›t
, 
µa
)))

464 
d©a_löe
->
mëa_di°™˚
--;

466  
Ál£
;

467 
	}
}

469 
pblk_löe
 *
	$pblk_should_submô_mëa_io
(
pblk
 *pblk,

470 
nvm_rq
 *
d©a_rqd
)

472 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

473 
pblk_löe_mgmt
 *
l_mg
 = &
pblk
->l_mg;

474 
pblk_löe
 *
mëa_löe
;

476 
	`•ö_lock
(&
l_mg
->
˛o£_lock
);

477 i‡(
	`li°_em±y
(&
l_mg
->
emëa_li°
)) {

478 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

479  
NULL
;

481 
mëa_löe
 = 
	`li°_fú°_íåy
(&
l_mg
->
emëa_li°
, 
pblk_löe
, 
li°
);

482 i‡(
mëa_löe
->
emëa
->
mem
 >
lm
->
emëa_Àn
[0]) {

483 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

484  
NULL
;

486 
	`•ö_u∆ock
(&
l_mg
->
˛o£_lock
);

488 i‡(!
	`pblk_vÆid_mëa_µa
(
pblk
, 
mëa_löe
, 
d©a_rqd
))

489  
NULL
;

491  
mëa_löe
;

492 
	}
}

494 
	$pblk_submô_io_£t
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

496 
µa_addr
 
îa£_µa
;

497 
pblk_löe
 *
mëa_löe
;

498 
îr
;

500 
	`pblk_µa_£t_em±y
(&
îa£_µa
);

503 
îr
 = 
	`pblk_£tup_w_rq
(
pblk
, 
rqd
, &
îa£_µa
);

504 i‡(
îr
) {

505 
	`pblk_îr
(
pblk
, "couldÇŸ sëu∞wrôêªque°: %d\n", 
îr
);

506  
NVM_IO_ERR
;

509 
mëa_löe
 = 
	`pblk_should_submô_mëa_io
(
pblk
, 
rqd
);

512 
îr
 = 
	`pblk_submô_io
(
pblk
, 
rqd
, 
NULL
);

513 i‡(
îr
) {

514 
	`pblk_îr
(
pblk
, "d©®I/O submissi⁄ faûed: %d\n", 
îr
);

515  
NVM_IO_ERR
;

518 i‡(!
	`pblk_µa_em±y
(
îa£_µa
)) {

520 i‡(
	`pblk_blk_îa£_async
(
pblk
, 
îa£_µa
)) {

521 
pblk_löe
 *
e_löe
 = 
	`pblk_löe_gë_îa£
(
pblk
);

522 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

523 
nvm_geo
 *
geo
 = &
dev
->geo;

524 
bô
;

526 
	`©omic_öc
(&
e_löe
->
À·_eblks
);

527 
bô
 = 
	`pblk_µa_to_pos
(
geo
, 
îa£_µa
);

528 
	`WARN_ON
(!
	`ã°_™d_˛ór_bô
(
bô
, 
e_löe
->
îa£_bôm≠
));

532 i‡(
mëa_löe
) {

534 
îr
 = 
	`pblk_submô_mëa_io
(
pblk
, 
mëa_löe
);

535 i‡(
îr
) {

536 
	`pblk_îr
(
pblk
, "metadata I/O submission failed: %d",

537 
îr
);

538  
NVM_IO_ERR
;

542  
NVM_IO_OK
;

543 
	}
}

545 
	$pblk_‰ì_wrôe_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

547 
pblk_c_˘x
 *
c_˘x
 = 
	`nvm_rq_to_pdu
(
rqd
);

548 
bio
 *biÿ
rqd
->bio;

550 i‡(
c_˘x
->
ƒ_∑dded
)

551 
	`pblk_bio_‰ì_∑ges
(
pblk
, 
bio
, 
c_˘x
->
ƒ_vÆid
,

552 
c_˘x
->
ƒ_∑dded
);

553 
	}
}

555 
	$pblk_submô_wrôe
(
pblk
 *pblk, *
£cs_À·
)

557 
bio
 *bio;

558 
nvm_rq
 *
rqd
;

559 
£cs_avaû
, 
£cs_to_sync
, 
£cs_to_com
;

560 
£cs_to_Êush
, 
∑cked_mëa_pgs
;

561 
pos
;

562 
ªsubmô
;

564 *
£cs_À·
 = 0;

566 
	`•ö_lock
(&
pblk
->
ªsubmô_lock
);

567 
ªsubmô
 = !
	`li°_em±y
(&
pblk
->
ªsubmô_li°
);

568 
	`•ö_u∆ock
(&
pblk
->
ªsubmô_lock
);

571 i‡(
ªsubmô
) {

572 
pblk_c_˘x
 *
r_˘x
;

574 
	`•ö_lock
(&
pblk
->
ªsubmô_lock
);

575 
r_˘x
 = 
	`li°_fú°_íåy
(&
pblk
->
ªsubmô_li°
,

576 
pblk_c_˘x
, 
li°
);

577 
	`li°_dñ
(&
r_˘x
->
li°
);

578 
	`•ö_u∆ock
(&
pblk
->
ªsubmô_lock
);

580 
£cs_avaû
 = 
r_˘x
->
ƒ_vÆid
;

581 
pos
 = 
r_˘x
->
£¡ry
;

583 
	`pblk_¥ï¨e_ªsubmô
(
pblk
, 
pos
, 
£cs_avaû
);

584 
£cs_to_sync
 = 
	`pblk_ˇlc_£cs_to_sync
(
pblk
, 
£cs_avaû
,

585 
£cs_avaû
);

587 
	`k‰ì
(
r_˘x
);

593 
£cs_avaû
 = 
	`pblk_rb_ªad_cou¡
(&
pblk
->
rwb
);

594 i‡(!
£cs_avaû
)

597 
£cs_to_Êush
 = 
	`pblk_rb_Êush_poöt_cou¡
(&
pblk
->
rwb
);

598 i‡(!
£cs_to_Êush
 && 
£cs_avaû
 < 
pblk
->
mö_wrôe_pgs_d©a
)

601 
£cs_to_sync
 = 
	`pblk_ˇlc_£cs_to_sync
(
pblk
, 
£cs_avaû
,

602 
£cs_to_Êush
);

603 i‡(
£cs_to_sync
 > 
pblk
->
max_wrôe_pgs
) {

604 
	`pblk_îr
(
pblk
, "bad buffer sync calculation\n");

608 
£cs_to_com
 = (
£cs_to_sync
 > 
£cs_avaû
) ?

609 
£cs_avaû
 : 
£cs_to_sync
;

610 
pos
 = 
	`pblk_rb_ªad_commô
(&
pblk
->
rwb
, 
£cs_to_com
);

613 
∑cked_mëa_pgs
 = (
pblk
->
mö_wrôe_pgs
 -Öblk->
mö_wrôe_pgs_d©a
);

614 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
, 
£cs_to_sync
 + 
∑cked_mëa_pgs
);

616 
bio
->
bi_ôî
.
bi_£˘‹
 = 0;

617 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_WRITE
, 0);

619 
rqd
 = 
	`pblk_Æloc_rqd
(
pblk
, 
PBLK_WRITE
);

620 
rqd
->
bio
 = bio;

622 i‡(
	`pblk_rb_ªad_to_bio
(&
pblk
->
rwb
, 
rqd
, 
pos
, 
£cs_to_sync
,

623 
£cs_avaû
)) {

624 
	`pblk_îr
(
pblk
, "corrupted write bio\n");

625 
Áû_put_bio
;

628 i‡(
	`pblk_submô_io_£t
(
pblk
, 
rqd
))

629 
Áû_‰ì_bio
;

631 #ifde‡
CONFIG_NVM_PBLK_DEBUG


632 
	`©omic_l⁄g_add
(
£cs_to_sync
, &
pblk
->
sub_wrôes
);

635 *
£cs_À·
 = 1;

638 
Áû_‰ì_bio
:

639 
	`pblk_‰ì_wrôe_rqd
(
pblk
, 
rqd
);

640 
Áû_put_bio
:

641 
	`bio_put
(
bio
);

642 
	`pblk_‰ì_rqd
(
pblk
, 
rqd
, 
PBLK_WRITE
);

644  -
EINTR
;

645 
	}
}

647 
	$pblk_wrôe_ts
(*
d©a
)

649 
pblk
 *pblk = 
d©a
;

650 
£cs_À·
;

651 
wrôe_Áûuª
 = 0;

653 !
	`kthªad_should_°›
()) {

654 i‡(!
wrôe_Áûuª
) {

655 
wrôe_Áûuª
 = 
	`pblk_submô_wrôe
(
pblk
, &
£cs_À·
);

657 i‡(
£cs_À·
)

660 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

661 
	`io_scheduÀ
();

665 
	}
}

	@pblk.h

21 #i‚de‡
PBLK_H_


22 
	#PBLK_H_


	)

24 
	~<löux/blkdev.h
>

25 
	~<löux/blk-mq.h
>

26 
	~<löux/bio.h
>

27 
	~<löux/moduÀ.h
>

28 
	~<löux/kthªad.h
>

29 
	~<löux/vmÆloc.h
>

30 
	~<löux/¸c32.h
>

31 
	~<löux/uuid.h
>

33 
	~<löux/lighävm.h
>

36 
	#GC_LIMIT_INVERSE
 5

	)

37 
	#GC_TIME_MSECS
 1000

	)

39 
	#PBLK_SECTOR
 (512)

	)

40 
	#PBLK_EXPOSED_PAGE_SIZE
 (4096)

	)

42 
	#PBLK_NR_CLOSE_JOBS
 (4)

	)

44 
	#PBLK_CACHE_NAME_LEN
 (
DISK_NAME_LEN
 + 16)

	)

47 
	#PBLK_MAX_LUNS_BITMAP
 (4)

	)

49 
	#NR_PHY_IN_LOG
 (
PBLK_EXPOSED_PAGE_SIZE
 / 
PBLK_SECTOR
)

	)

52 
	#PBLK_GEN_WS_POOL_SIZE
 (2)

	)

54 
	#PBLK_DEFAULT_OP
 (11)

	)

57 
	mPBLK_READ
 = 
READ
,

58 
	mPBLK_WRITE
 = 
WRITE
,

59 
	mPBLK_WRITE_INT
,

60 
	mPBLK_READ_RECOV
,

61 
	mPBLK_ERASE
,

66 
	mPBLK_IOTYPE_USER
 = 1 << 0,

67 
	mPBLK_IOTYPE_GC
 = 1 << 1,

70 
	mPBLK_FLUSH_ENTRY
 = 1 << 2,

71 
	mPBLK_WRITTEN_DATA
 = 1 << 3,

72 
	mPBLK_SUBMITTED_ENTRY
 = 1 << 4,

73 
	mPBLK_WRITABLE_ENTRY
 = 1 << 5,

77 
	mPBLK_BLK_ST_OPEN
 = 0x1,

78 
	mPBLK_BLK_ST_CLOSED
 = 0x2,

82 
	mPBLK_CHUNK_RESET_START
,

83 
	mPBLK_CHUNK_RESET_DONE
,

84 
	mPBLK_CHUNK_RESET_FAILED
,

87 
	spblk_£c_mëa
 {

88 
u64
 
	mª£rved
;

89 
__À64
 
	mlba
;

95 
	#PBLK_GC_NR_LISTS
 4

	)

98 
	mPBLK_RL_OFF
 = 0,

99 
	mPBLK_RL_WERR
 = 1,

100 
	mPBLK_RL_HIGH
 = 2,

101 
	mPBLK_RL_MID
 = 3,

102 
	mPBLK_RL_LOW
 = 4

105 
	#pblk_dma_µa_size
 ((
u64
Ë* 
NVM_MAX_VLBA
)

	)

108 
	spblk_c_˘x
 {

109 
li°_hód
 
	mli°
;

111 *
	mlun_bôm≠
;

112 
	m£¡ry
;

113 
	mƒ_vÆid
;

114 
	mƒ_∑dded
;

118 
	spblk_g_˘x
 {

119 *
	m¥iv©e
;

120 
	m°¨t_time
;

121 
u64
 
	mlba
;

125 
	spblk_∑d_rq
 {

126 
pblk
 *
	mpblk
;

127 
com∂ëi⁄
 
	mwaô
;

128 
kªf
 
	mªf
;

132 
	spblk_ªc_˘x
 {

133 
pblk
 *
	mpblk
;

134 
nvm_rq
 *
	mrqd
;

135 
w‹k_°ru˘
 
	mws_ªc
;

139 
	spblk_w_˘x
 {

140 
bio_li°
 
	mbios
;

143 
u64
 
	mlba
;

144 
µa_addr
 
	mµa
;

145 
	mÊags
;

148 
	spblk_rb_íåy
 {

149 
µa_addr
 
	mˇchñöe
;

150 *
	md©a
;

151 
pblk_w_˘x
 
	mw_˘x
;

152 
li°_hód
 
	mödex
;

155 
	#EMPTY_ENTRY
 (~0U)

	)

157 
	spblk_rb_∑ges
 {

158 
∑ge
 *
	m∑ges
;

159 
	m‹dî
;

160 
li°_hód
 
	mli°
;

163 
	spblk_rb
 {

164 
pblk_rb_íåy
 *
	míåõs
;

165 
	mmem
;

168 
	msubm
;

172 
	msync
;

176 
	mÊush_poöt
;

180 
	ml2p_upd©e
;

185 
	mƒ_íåõs
;

188 
	m£g_size
;

193 
	mback_thªs
;

198 
li°_hód
 
	m∑ges
;

200 
•ölock_t
 
	mw_lock
;

201 
•ölock_t
 
	ms_lock
;

203 #ifde‡
CONFIG_NVM_PBLK_DEBUG


204 
©omic_t
 
	möÊight_Êush_poöt
;

208 
	#PBLK_RECOVERY_SECTORS
 16

	)

210 
	spblk_lun
 {

211 
µa_addr
 
	mbµa
;

212 
£m≠h‹e
 
	mwr_£m
;

215 
	spblk_gc_rq
 {

216 
pblk_löe
 *
	mlöe
;

217 *
	md©a
;

218 
u64
 
	m∑ddr_li°
[
NVM_MAX_VLBA
];

219 
u64
 
	mlba_li°
[
NVM_MAX_VLBA
];

220 
	mƒ_£cs
;

221 
	m£cs_to_gc
;

222 
li°_hód
 
	mli°
;

225 
	spblk_gc
 {

229 
	mgc_a˘ive
;

230 
	mgc_íabÀd
;

231 
	mgc_f‹˚d
;

233 
èsk_°ru˘
 *
	mgc_ts
;

234 
èsk_°ru˘
 *
	mgc_wrôî_ts
;

235 
èsk_°ru˘
 *
	mgc_ªadî_ts
;

237 
w‹kqueue_°ru˘
 *
	mgc_löe_ªadî_wq
;

238 
w‹kqueue_°ru˘
 *
	mgc_ªadî_wq
;

240 
timî_li°
 
	mgc_timî
;

242 
£m≠h‹e
 
	mgc_£m
;

243 
©omic_t
 
	mªad_öÊight_gc
;

244 
©omic_t
 
	mpùñöe_gc
;

247 
	mw_íåõs
;

249 
li°_hód
 
	mw_li°
;

250 
li°_hód
 
	mr_li°
;

252 
•ölock_t
 
	mlock
;

253 
•ölock_t
 
	mw_lock
;

254 
•ölock_t
 
	mr_lock
;

257 
	spblk_æ
 {

258 
	mhigh
;

261 
	mhigh_pw
;

263 
	#PBLK_USER_HIGH_THRS
 8

	)

264 
	#PBLK_USER_LOW_THRS
 10

	)

266 
	mrb_wödows_pw
;

274 
	mrb_budgë
;

275 
	mrb_u£r_max
;

276 
	mrb_gc_max
;

277 
	mrb_gc_rsv
;

278 
	mrb_°©e
;

279 
	mrb_max_io
;

281 
©omic_t
 
	mrb_u£r_˙t
;

282 
©omic_t
 
	mrb_gc_˙t
;

283 
©omic_t
 
	mrb_•a˚
;

285 
	mrsv_blocks
;

287 
	mrb_u£r_a˘ive
;

288 
	mrb_gc_a˘ive
;

290 
©omic_t
 
	mwîr_löes
;

292 
timî_li°
 
	mu_timî
;

294 
	mtŸÆ_blocks
;

296 
©omic_t
 
	m‰ì_blocks
;

297 
©omic_t
 
	m‰ì_u£r_blocks
;

300 
	#PBLK_LINE_EMPTY
 (~0U)

	)

304 
	mPBLK_LINETYPE_FREE
 = 0,

305 
	mPBLK_LINETYPE_LOG
 = 1,

306 
	mPBLK_LINETYPE_DATA
 = 2,

309 
	mPBLK_LINESTATE_NEW
 = 9,

310 
	mPBLK_LINESTATE_FREE
 = 10,

311 
	mPBLK_LINESTATE_OPEN
 = 11,

312 
	mPBLK_LINESTATE_CLOSED
 = 12,

313 
	mPBLK_LINESTATE_GC
 = 13,

314 
	mPBLK_LINESTATE_BAD
 = 14,

315 
	mPBLK_LINESTATE_CORRUPT
 = 15,

318 
	mPBLK_LINEGC_NONE
 = 20,

319 
	mPBLK_LINEGC_EMPTY
 = 21,

320 
	mPBLK_LINEGC_LOW
 = 22,

321 
	mPBLK_LINEGC_MID
 = 23,

322 
	mPBLK_LINEGC_HIGH
 = 24,

323 
	mPBLK_LINEGC_FULL
 = 25,

324 
	mPBLK_LINEGC_WERR
 = 26

327 
	#PBLK_MAGIC
 0x70626c6b

	)

335 
	#SMETA_VERSION_MAJOR
 (0)

	)

336 
	#SMETA_VERSION_MINOR
 (1)

	)

338 
	#EMETA_VERSION_MAJOR
 (0)

	)

339 
	#EMETA_VERSION_MINOR
 (2)

	)

341 
	slöe_hódî
 {

342 
__À32
 
	m¸c
;

343 
__À32
 
	midítifõr
;

344 
__u8
 
	muuid
[16];

345 
__À16
 
	mty≥
;

346 
__u8
 
	mvîsi⁄_maj‹
;

347 
__u8
 
	mvîsi⁄_mö‹
;

348 
__À32
 
	mid
;

351 
	slöe_smëa
 {

352 
löe_hódî
 
	mhódî
;

354 
__À32
 
	m¸c
;

356 
__À32
 
	m¥ev_id
;

359 
__À64
 
	m£q_ƒ
;

362 
__À32
 
	mwödow_wr_lun
;

364 
__À32
 
	mrsvd
[2];

366 
__À64
 
	mlun_bôm≠
[];

381 
	slöe_emëa
 {

382 
löe_hódî
 
	mhódî
;

384 
__À32
 
	m¸c
;

387 
__À32
 
	m¥ev_id
;

390 
__À64
 
	m£q_ƒ
;

393 
__À32
 
	mwödow_wr_lun
;

396 
__À32
 
	m√xt_id
;

397 
__À64
 
	mƒ_lbas
;

398 
__À64
 
	mƒ_vÆid_lbas
;

399 
__À64
 
	mbb_bôm≠
[];

404 
	swa_cou¡îs
 {

405 
__À64
 
	mu£r
;

406 
__À64
 
	mgc
;

407 
__À64
 
	m∑d
;

410 
	spblk_emëa
 {

411 
löe_emëa
 *
	mbuf
;

412 
	mmem
;

415 
©omic_t
 
	msync
;

419 
	mƒ_íåõs
;

422 
	spblk_smëa
 {

423 
löe_smëa
 *
	mbuf
;

426 
	spblk_w_îr_gc
 {

427 
	mhas_wrôe_îr
;

428 
	mhas_gc_îr
;

429 
__À64
 *
	mlba_li°
;

432 
	spblk_löe
 {

433 
pblk
 *
	mpblk
;

434 
	mid
;

437 
	m£q_ƒ
;

439 
	m°©e
;

440 
	mty≥
;

441 
	mgc_group
;

442 
li°_hód
 
	mli°
;

444 *
	mlun_bôm≠
;

446 
nvm_chk_mëa
 *
	mchks
;

448 
pblk_smëa
 *
	msmëa
;

449 
pblk_emëa
 *
	memëa
;

451 
	mmëa_löe
;

452 
	mmëa_di°™˚
;

454 
u64
 
	memëa_s£c
;

456 
	m£c_ö_löe
;

458 
©omic_t
 
	mblk_ö_löe
;

459 *
	mblk_bôm≠
;

460 *
	mîa£_bôm≠
;

462 *
	mm≠_bôm≠
;

463 *
	mövÆid_bôm≠
;

465 
©omic_t
 
	mÀ·_eblks
;

466 
©omic_t
 
	mÀ·_£blks
;

468 
	mÀ·_m£cs
;

469 
	mcur_£c
;

470 
	mƒ_vÆid_lbas
;

472 
__À32
 *
	mvsc
;

474 
kªf
 
	mªf
;

475 
©omic_t
 
	m£c_to_upd©e
;

477 
pblk_w_îr_gc
 *
	mw_îr_gc
;

479 
•ölock_t
 
	mlock
;

482 
	#PBLK_DATA_LINES
 4

	)

485 
	mPBLK_EMETA_TYPE_HEADER
 = 1,

486 
	mPBLK_EMETA_TYPE_LLBA
 = 2,

487 
	mPBLK_EMETA_TYPE_VSC
 = 3,

490 
	spblk_löe_mgmt
 {

491 
	mƒ_löes
;

492 
	mƒ_‰ì_löes
;

495 
li°_hód
 
	m‰ì_li°
;

496 
li°_hód
 
	mc‹ru±_li°
;

497 
li°_hód
 
	mbad_li°
;

500 
li°_hód
 *
	mgc_li°s
[
PBLK_GC_NR_LISTS
];

501 
li°_hód
 
	mgc_high_li°
;

502 
li°_hód
 
	mgc_mid_li°
;

503 
li°_hód
 
	mgc_low_li°
;

505 
li°_hód
 
	mgc_wîr_li°
;

507 
li°_hód
 
	mgc_fuŒ_li°
;

508 
li°_hód
 
	mgc_em±y_li°
;

510 
pblk_löe
 *
	mlog_löe
;

511 
pblk_löe
 *
	md©a_löe
;

512 
pblk_löe
 *
	mlog_√xt
;

513 
pblk_löe
 *
	md©a_√xt
;

515 
li°_hód
 
	memëa_li°
;

517 
__À32
 *
	mvsc_li°
;

520 
pblk_smëa
 *
	m¶öe_mëa
[
PBLK_DATA_LINES
];

521 
pblk_emëa
 *
	mñöe_mëa
[
PBLK_DATA_LINES
];

522 
	mmëa_bôm≠
;

525 
kmem_ˇche
 *
	mbôm≠_ˇche
;

526 
mempoﬁ_t
 *
	mbôm≠_poﬁ
;

529 *
	mbb_ãm∂©e
;

530 *
	mbb_aux
;

532 
	md_£q_ƒ
;

533 
	ml_£q_ƒ
;

535 
•ölock_t
 
	m‰ì_lock
;

536 
•ölock_t
 
	m˛o£_lock
;

537 
•ölock_t
 
	mgc_lock
;

540 
	spblk_löe_mëa
 {

541 
	msmëa_Àn
;

542 
	msmëa_£c
;

544 
	memëa_Àn
[4];

551 
	memëa_£c
[4];

555 
	memëa_bb
;

557 
	mvsc_li°_Àn
;

558 
	m£c_bôm≠_Àn
;

559 
	mblk_bôm≠_Àn
;

560 
	mlun_bôm≠_Àn
;

562 
	mblk_≥r_löe
;

563 
	m£c_≥r_löe
;

564 
	md£c_≥r_löe
;

565 
	mmö_blk_löe
;

567 
	mmid_thrs
;

568 
	mhigh_thrs
;

570 
	mmëa_di°™˚
;

574 
	mPBLK_STATE_RUNNING
 = 0,

575 
	mPBLK_STATE_STOPPING
 = 1,

576 
	mPBLK_STATE_RECOVERING
 = 2,

577 
	mPBLK_STATE_STOPPED
 = 3,

581 
	spblk_addrf
 {

583 
	m£c_°rùe
;

584 
	mch_°rùe
;

585 
	mlun_°rùe
;

588 
	m£c_lun_°rùe
;

589 
	m£c_ws_°rùe
;

592 
	spblk
 {

593 
nvm_tgt_dev
 *
	mdev
;

594 
gídisk
 *
	mdisk
;

596 
kobje˘
 
	mkobj
;

598 
pblk_lun
 *
	mluns
;

600 
pblk_löe
 *
	mlöes
;

601 
pblk_löe_mgmt
 
	ml_mg
;

602 
pblk_löe_mëa
 
	mlm
;

604 
nvm_addrf
 
	maddrf
;

605 
pblk_addrf
 
	muaddrf
;

606 
	maddrf_Àn
;

608 
pblk_rb
 
	mrwb
;

610 
	m°©e
;

612 
	mmö_wrôe_pgs
;

613 
	mmö_wrôe_pgs_d©a
;

614 
	mmax_wrôe_pgs
;

615 
	moob_mëa_size
;

617 
£˘‹_t
 
	mˇ∑côy
;

619 
	m›
;

620 
	m›_blks
;

623 
pblk_æ
 
	mæ
;

625 
	m£c_≥r_wrôe
;

627 
guid_t
 
	mö°™˚_uuid
;

630 
©omic64_t
 
	mu£r_wa
;

631 
©omic64_t
 
	mgc_wa
;

632 
©omic64_t
 
	m∑d_wa
;

635 
u64
 
	mu£r_r°_wa
;

636 
u64
 
	mgc_r°_wa
;

637 
u64
 
	m∑d_r°_wa
;

640 
©omic64_t
 *
	m∑d_di°
;

641 
u64
 
	mƒ_Êush_r°
;

642 
©omic64_t
 
	mƒ_Êush
;

644 #ifde‡
CONFIG_NVM_PBLK_DEBUG


646 
©omic_l⁄g_t
 
	möÊight_wrôes
;

647 
©omic_l⁄g_t
 
	m∑dded_wrôes
;

648 
©omic_l⁄g_t
 
	m∑dded_wb
;

649 
©omic_l⁄g_t
 
	mªq_wrôes
;

650 
©omic_l⁄g_t
 
	msub_wrôes
;

651 
©omic_l⁄g_t
 
	msync_wrôes
;

652 
©omic_l⁄g_t
 
	möÊight_ªads
;

653 
©omic_l⁄g_t
 
	mˇche_ªads
;

654 
©omic_l⁄g_t
 
	msync_ªads
;

655 
©omic_l⁄g_t
 
	mªcov_wrôes
;

656 
©omic_l⁄g_t
 
	mªcov_gc_wrôes
;

657 
©omic_l⁄g_t
 
	mªcov_gc_ªads
;

660 
•ölock_t
 
	mlock
;

662 
©omic_l⁄g_t
 
	mªad_Áûed
;

663 
©omic_l⁄g_t
 
	mªad_em±y
;

664 
©omic_l⁄g_t
 
	mªad_high_ecc
;

665 
©omic_l⁄g_t
 
	mªad_Áûed_gc
;

666 
©omic_l⁄g_t
 
	mwrôe_Áûed
;

667 
©omic_l⁄g_t
 
	mîa£_Áûed
;

669 
©omic_t
 
	möÊight_io
;

671 
èsk_°ru˘
 *
	mwrôî_ts
;

677 *
	må™s_m≠
;

678 
•ölock_t
 
	må™s_lock
;

680 
li°_hód
 
	mcom∂_li°
;

682 
•ölock_t
 
	mªsubmô_lock
;

683 
li°_hód
 
	mªsubmô_li°
;

685 
mempoﬁ_t
 
	m∑ge_bio_poﬁ
;

686 
mempoﬁ_t
 
	mgí_ws_poﬁ
;

687 
mempoﬁ_t
 
	mªc_poﬁ
;

688 
mempoﬁ_t
 
	mr_rq_poﬁ
;

689 
mempoﬁ_t
 
	mw_rq_poﬁ
;

690 
mempoﬁ_t
 
	me_rq_poﬁ
;

692 
w‹kqueue_°ru˘
 *
	m˛o£_wq
;

693 
w‹kqueue_°ru˘
 *
	mbb_wq
;

694 
w‹kqueue_°ru˘
 *
	mr_íd_wq
;

696 
timî_li°
 
	mwtimî
;

698 
pblk_gc
 
	mgc
;

701 
	spblk_löe_ws
 {

702 
pblk
 *
	mpblk
;

703 
pblk_löe
 *
	mlöe
;

704 *
	m¥iv
;

705 
w‹k_°ru˘
 
	mws
;

708 
	#pblk_g_rq_size
 ((
nvm_rq
Ë+ (
pblk_g_˘x
))

	)

709 
	#pblk_w_rq_size
 ((
nvm_rq
Ë+ (
pblk_c_˘x
))

	)

711 
	#pblk_îr
(
pblk
, 
fmt
, ...) \

712 
	`¥_îr
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_«me
, ##
__VA_ARGS__
)

	)

713 
	#pblk_öfo
(
pblk
, 
fmt
, ...) \

714 
	`¥_öfo
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_«me
, ##
__VA_ARGS__
)

	)

715 
	#pblk_w¨n
(
pblk
, 
fmt
, ...) \

716 
	`¥_w¨n
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_«me
, ##
__VA_ARGS__
)

	)

717 
	#pblk_debug
(
pblk
, 
fmt
, ...) \

718 
	`¥_debug
("pblk %s: " 
fmt
, 
pblk
->
disk
->
disk_«me
, ##
__VA_ARGS__
)

	)

723 
pblk_rb_öô
(
pblk_rb
 *
rb
, 
size
, 
thªshﬁd
,

724 
£g_sz
);

725 
pblk_rb_may_wrôe_u£r
(
pblk_rb
 *
rb
, 
bio
 *bio,

726 
ƒ_íåõs
, *
pos
);

727 
pblk_rb_may_wrôe_gc
(
pblk_rb
 *
rb
, 
ƒ_íåõs
,

728 *
pos
);

729 
pblk_rb_wrôe_íåy_u£r
(
pblk_rb
 *
rb
, *
d©a
,

730 
pblk_w_˘x
 
w_˘x
, 
pos
);

731 
pblk_rb_wrôe_íåy_gc
(
pblk_rb
 *
rb
, *
d©a
,

732 
pblk_w_˘x
 
w_˘x
, 
pblk_löe
 *
löe
,

733 
u64
 
∑ddr
, 
pos
);

734 
pblk_w_˘x
 *
pblk_rb_w_˘x
(
pblk_rb
 *
rb
, 
pos
);

735 
pblk_rb_Êush
(
pblk_rb
 *
rb
);

737 
pblk_rb_sync_l2p
(
pblk_rb
 *
rb
);

738 
pblk_rb_ªad_to_bio
(
pblk_rb
 *
rb
, 
nvm_rq
 *
rqd
,

739 
pos
, 
ƒ_íåõs
,

740 
cou¡
);

741 
pblk_rb_c›y_to_bio
(
pblk_rb
 *
rb
, 
bio
 *bio, 
£˘‹_t
 
lba
,

742 
µa_addr
 
µa
);

743 
pblk_rb_ªad_commô
(
pblk_rb
 *
rb
, 
íåõs
);

745 
pblk_rb_sync_öô
(
pblk_rb
 *
rb
, *
Êags
);

746 
pblk_rb_sync_adv™˚
(
pblk_rb
 *
rb
, 
ƒ_íåõs
);

747 
pblk_rb_±r_wøp
(
pblk_rb
 *
rb
, 
p
,

748 
ƒ_íåõs
);

749 
pblk_rb_sync_íd
(
pblk_rb
 *
rb
, *
Êags
);

750 
pblk_rb_Êush_poöt_cou¡
(
pblk_rb
 *
rb
);

752 
pblk_rb_ªad_cou¡
(
pblk_rb
 *
rb
);

753 
pblk_rb_sync_cou¡
(
pblk_rb
 *
rb
);

754 
pblk_rb_wøp_pos
(
pblk_rb
 *
rb
, 
pos
);

756 
pblk_rb_ã¨_down_check
(
pblk_rb
 *
rb
);

757 
pblk_rb_pos_oob
(
pblk_rb
 *
rb
, 
u64
 
pos
);

758 
pblk_rb_‰ì
(
pblk_rb
 *
rb
);

759 
ssize_t
 
pblk_rb_sysfs
(
pblk_rb
 *
rb
, *
buf
);

764 
nvm_rq
 *
pblk_Æloc_rqd
(
pblk
 *pblk, 
ty≥
);

765 
pblk_‰ì_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
ty≥
);

766 
pblk_Æloc_rqd_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

767 
pblk_‰ì_rqd_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

768 
pblk_£t_£c_≥r_wrôe
(
pblk
 *pblk, 
£c_≥r_wrôe
);

769 
pblk_£tup_w_ªc_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

770 
pblk_c_˘x
 *
c_˘x
);

771 
pblk_disˇrd
(
pblk
 *pblk, 
bio
 *bio);

772 
nvm_chk_mëa
 *
pblk_gë_chunk_mëa
(
pblk
 *pblk);

773 
nvm_chk_mëa
 *
pblk_chunk_gë_off
(
pblk
 *pblk,

774 
nvm_chk_mëa
 *
Õ
,

775 
µa_addr
 
µa
);

776 
pblk_log_wrôe_îr
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

777 
pblk_log_ªad_îr
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

778 
pblk_submô_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, *
buf
);

779 
pblk_submô_io_sync
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, *
buf
);

780 
pblk_submô_mëa_io
(
pblk
 *pblk, 
pblk_löe
 *
mëa_löe
);

781 
pblk_check_chunk_°©e_upd©e
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

782 
pblk_löe
 *
pblk_löe_gë
(
pblk
 *pblk);

783 
pblk_löe
 *
pblk_löe_gë_fú°_d©a
(
pblk
 *pblk);

784 
pblk_löe
 *
pblk_löe_ª∂a˚_d©a
(
pblk
 *pblk);

785 
pblk_µa_to_löe_put
(
pblk
 *pblk, 
µa_addr
 
µa
);

786 
pblk_rq_to_löe_put
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

787 
pblk_löe_ªcov_Æloc
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

788 
pblk_löe_ªcov_˛o£
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

789 
pblk_löe
 *
pblk_löe_gë_d©a
(
pblk
 *pblk);

790 
pblk_löe
 *
pblk_löe_gë_îa£
(
pblk
 *pblk);

791 
pblk_löe_îa£
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

792 
pblk_löe_is_fuŒ
(
pblk_löe
 *
löe
);

793 
pblk_löe_‰ì
(
pblk_löe
 *
löe
);

794 
pblk_löe_˛o£_mëa
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

795 
pblk_löe_˛o£
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

796 
pblk_löe_˛o£_ws
(
w‹k_°ru˘
 *
w‹k
);

797 
pblk_pùñöe_°›
(
pblk
 *pblk);

798 
__pblk_pùñöe_°›
(
pblk
 *pblk);

799 
__pblk_pùñöe_Êush
(
pblk
 *pblk);

800 
pblk_gí_run_ws
(
pblk
 *pblk, 
pblk_löe
 *
löe
, *
¥iv
,

801 (*
w‹k
)(
w‹k_°ru˘
 *), 
gÂ_t
 
gÂ_mask
,

802 
w‹kqueue_°ru˘
 *
wq
);

803 
u64
 
	`pblk_löe_smëa_°¨t
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

804 
	`pblk_löe_smëa_ªad
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

805 
	`pblk_löe_emëa_ªad
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

806 *
emëa_buf
);

807 
	`pblk_blk_îa£_async
(
pblk
 *pblk, 
µa_addr
 
îa£_µa
);

808 
	`pblk_löe_put
(
kªf
 *
ªf
);

809 
	`pblk_löe_put_wq
(
kªf
 *
ªf
);

810 
li°_hód
 *
	`pblk_löe_gc_li°
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

811 
u64
 
	`pblk_lookup_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

812 
	`pblk_dóŒoc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
);

813 
u64
 
	`pblk_Æloc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
);

814 
u64
 
	`__pblk_Æloc_∑ge
(
pblk
 *pblk, 
pblk_löe
 *
löe
, 
ƒ_£cs
);

815 
	`pblk_ˇlc_£cs
(
pblk
 *pblk, 
£cs_avaû
,

816 
£cs_to_Êush
, 
boﬁ
 
skù_mëa
);

817 
	`pblk_down_rq
(
pblk
 *pblk, 
µa_addr
 
µa
,

818 *
lun_bôm≠
);

819 
	`pblk_down_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
);

820 
	`pblk_up_chunk
(
pblk
 *pblk, 
µa_addr
 
µa
);

821 
	`pblk_up_rq
(
pblk
 *pblk, *
lun_bôm≠
);

822 
	`pblk_bio_add_∑ges
(
pblk
 *pblk, 
bio
 *bio, 
gÂ_t
 
Êags
,

823 
ƒ_∑ges
);

824 
	`pblk_bio_‰ì_∑ges
(
pblk
 *pblk, 
bio
 *bio, 
off
,

825 
ƒ_∑ges
);

826 
	`pblk_m≠_övÆid©e
(
pblk
 *pblk, 
µa_addr
 
µa
);

827 
	`__pblk_m≠_övÆid©e
(
pblk
 *pblk, 
pblk_löe
 *
löe
,

828 
u64
 
∑ddr
);

829 
	`pblk_upd©e_m≠
(
pblk
 *pblk, 
£˘‹_t
 
lba
, 
µa_addr
 
µa
);

830 
	`pblk_upd©e_m≠_ˇche
(
pblk
 *pblk, 
£˘‹_t
 
lba
,

831 
µa_addr
 
µa
);

832 
	`pblk_upd©e_m≠_dev
(
pblk
 *pblk, 
£˘‹_t
 
lba
,

833 
µa_addr
 
µa
, µa_add∏
íåy_löe
);

834 
	`pblk_upd©e_m≠_gc
(
pblk
 *pblk, 
£˘‹_t
 
lba
, 
µa_addr
 
µa
,

835 
pblk_löe
 *
gc_löe
, 
u64
 
∑ddr
);

836 
	`pblk_lookup_l2p_ønd
(
pblk
 *pblk, 
µa_addr
 *
µas
,

837 
u64
 *
lba_li°
, 
ƒ_£cs
);

838 
	`pblk_lookup_l2p_£q
(
pblk
 *pblk, 
µa_addr
 *
µas
,

839 
£˘‹_t
 
blba
, 
ƒ_£cs
, 
boﬁ
 *
‰om_ˇche
);

840 *
	`pblk_gë_mëa_f‹_wrôes
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

841 
	`pblk_gë_∑cked_mëa
(
pblk
 *pblk, 
nvm_rq
 *
rqd
);

846 
	`pblk_wrôe_to_ˇche
(
pblk
 *pblk, 
bio
 *bio,

847 
Êags
);

848 
	`pblk_wrôe_gc_to_ˇche
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
);

853 
	`pblk_m≠_îa£_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

854 
£¡ry
, *
lun_bôm≠
,

855 
vÆid_£cs
, 
µa_addr
 *
îa£_µa
);

856 
	`pblk_m≠_rq
(
pblk
 *pblk, 
nvm_rq
 *
rqd
, 
£¡ry
,

857 *
lun_bôm≠
, 
vÆid_£cs
,

858 
off
);

863 
	`pblk_wrôe_ts
(*
d©a
);

864 
	`pblk_wrôe_timî_‚
(
timî_li°
 *
t
);

865 
	`pblk_wrôe_should_kick
(
pblk
 *pblk);

866 
	`pblk_wrôe_kick
(
pblk
 *pblk);

871 
bio_£t
 
pblk_bio_£t
;

872 
	`pblk_submô_ªad
(
pblk
 *pblk, 
bio
 *bio);

873 
	`pblk_submô_ªad_gc
(
pblk
 *pblk, 
pblk_gc_rq
 *
gc_rq
);

877 
pblk_löe
 *
	`pblk_ªcov_l2p
(
pblk
 *pblk);

878 
	`pblk_ªcov_∑d
(
pblk
 *pblk);

879 
	`pblk_ªcov_check_emëa
(
pblk
 *pblk, 
löe_emëa
 *
emëa
);

884 
	#PBLK_GC_MAX_READERS
 8

	)

885 
	#PBLK_GC_RQ_QD
 128

	)

886 
	#PBLK_GC_L_QD
 4

	)

888 
	`pblk_gc_öô
(
pblk
 *pblk);

889 
	`pblk_gc_exô
(
pblk
 *pblk, 
boﬁ
 
gø˚ful
);

890 
	`pblk_gc_should_°¨t
(
pblk
 *pblk);

891 
	`pblk_gc_should_°›
(
pblk
 *pblk);

892 
	`pblk_gc_should_kick
(
pblk
 *pblk);

893 
	`pblk_gc_‰ì_fuŒ_löes
(
pblk
 *pblk);

894 
	`pblk_gc_sysfs_°©e_show
(
pblk
 *pblk, *
gc_íabÀd
,

895 *
gc_a˘ive
);

896 
	`pblk_gc_sysfs_f‹˚
(
pblk
 *pblk, 
f‹˚
);

897 
	`pblk_put_löe_back
(
pblk
 *pblk, 
pblk_löe
 *
löe
);

902 
	`pblk_æ_öô
(
pblk_æ
 *
æ
, 
budgë
, 
thªshﬁd
);

903 
	`pblk_æ_‰ì
(
pblk_æ
 *
æ
);

904 
	`pblk_æ_upd©e_øãs
(
pblk_æ
 *
æ
);

905 
	`pblk_æ_high_thrs
(
pblk_æ
 *
æ
);

906 
	`pblk_æ_ƒ_‰ì_blks
(
pblk_æ
 *
æ
);

907 
	`pblk_æ_ƒ_u£r_‰ì_blks
(
pblk_æ
 *
æ
);

908 
	`pblk_æ_u£r_may_ö£π
(
pblk_æ
 *
æ
, 
ƒ_íåõs
);

909 
	`pblk_æ_ö£πed
(
pblk_æ
 *
æ
, 
ƒ_íåõs
);

910 
	`pblk_æ_u£r_ö
(
pblk_æ
 *
æ
, 
ƒ_íåõs
);

911 
	`pblk_æ_gc_may_ö£π
(
pblk_æ
 *
æ
, 
ƒ_íåõs
);

912 
	`pblk_æ_gc_ö
(
pblk_æ
 *
æ
, 
ƒ_íåõs
);

913 
	`pblk_æ_out
(
pblk_æ
 *
æ
, 
ƒ_u£r
, 
ƒ_gc
);

914 
	`pblk_æ_max_io
(
pblk_æ
 *
æ
);

915 
	`pblk_æ_‰ì_löes_öc
(
pblk_æ
 *
æ
, 
pblk_löe
 *
löe
);

916 
	`pblk_æ_‰ì_löes_dec
(
pblk_æ
 *
æ
, 
pblk_löe
 *
löe
,

917 
boﬁ
 
u£d
);

918 
	`pblk_æ_is_limô
(
pblk_æ
 *
æ
);

920 
	`pblk_æ_wîr_löe_ö
(
pblk_æ
 *
æ
);

921 
	`pblk_æ_wîr_löe_out
(
pblk_æ
 *
æ
);

926 
	`pblk_sysfs_öô
(
gídisk
 *
tdisk
);

927 
	`pblk_sysfs_exô
(
gídisk
 *
tdisk
);

929 
ölöe
 
nvm_rq
 *
	$nvm_rq_‰om_c_˘x
(*
c_˘x
)

931  
c_˘x
 - (
nvm_rq
);

932 
	}
}

934 
ölöe
 *
	$emëa_to_bb
(
löe_emëa
 *
emëa
)

936  
emëa
->
bb_bôm≠
;

937 
	}
}

939 
ölöe
 *
	$emëa_to_wa
(
pblk_löe_mëa
 *
lm
,

940 
löe_emëa
 *
emëa
)

942  
emëa
->
bb_bôm≠
 + 
lm
->
blk_bôm≠_Àn
;

943 
	}
}

945 
ölöe
 *
	$emëa_to_lbas
(
pblk
 *pblk, 
löe_emëa
 *
emëa
)

947  ((*)
emëa
 + 
pblk
->
lm
.
emëa_Àn
[1]);

948 
	}
}

950 
ölöe
 *
	$emëa_to_vsc
(
pblk
 *pblk, 
löe_emëa
 *
emëa
)

952  (
	`emëa_to_lbas
(
pblk
, 
emëa
Ë+Öblk->
lm
.
emëa_Àn
[2]);

953 
	}
}

955 
ölöe
 
	$pblk_löe_vsc
(
pblk_löe
 *
löe
)

957  
	`À32_to_˝u
(*
löe
->
vsc
);

958 
	}
}

960 
ölöe
 
	$pblk_µa_to_löe_id
(
µa_addr
 
p
)

962  
p
.
a
.
blk
;

963 
	}
}

965 
ölöe
 
pblk_löe
 *
	$pblk_µa_to_löe
(
pblk
 *pblk,

966 
µa_addr
 
p
)

968  &
pblk
->
löes
[
	`pblk_µa_to_löe_id
(
p
)];

969 
	}
}

971 
ölöe
 
	$pblk_µa_to_pos
(
nvm_geo
 *
geo
, 
µa_addr
 
p
)

973  
p
.
a
.
lun
 * 
geo
->
num_ch
 +Ö.a.
ch
;

974 
	}
}

976 
ölöe
 
µa_addr
 
	$addr_to_gí_µa
(
pblk
 *pblk, 
u64
 
∑ddr
,

977 
u64
 
löe_id
)

979 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

980 
nvm_geo
 *
geo
 = &
dev
->geo;

981 
µa_addr
 
µa
;

983 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
) {

984 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

986 
µa
.ppa = 0;

987 
µa
.
g
.
blk
 = 
löe_id
;

988 
µa
.
g
.
pg
 = (
∑ddr
 & 
µaf
->
pg_mask
Ë>>Ö∑f->
pg_off£t
;

989 
µa
.
g
.
lun
 = (
∑ddr
 & 
µaf
->
lun_mask
Ë>>Ö∑f->
lun_off£t
;

990 
µa
.
g
.
ch
 = (
∑ddr
 & 
µaf
->
ch_mask
Ë>>Ö∑f->
ch_off£t
;

991 
µa
.
g
.
∂
 = (
∑ddr
 & 
µaf
->
∂n_mask
Ë>>Ö∑f->
∂n_off£t
;

992 
µa
.
g
.
£c
 = (
∑ddr
 & 
µaf
->
£c_mask
Ë>>Ö∑f->
£c_off£t
;

994 
pblk_addrf
 *
uaddrf
 = &
pblk
->uaddrf;

995 
£cs
, 
ch∆s
, 
luns
;

997 
µa
.ppa = 0;

999 
µa
.
m
.
chk
 = 
löe_id
;

1001 
∑ddr
 = 
	`div_u64_ªm
’addr, 
uaddrf
->
£c_°rùe
, &
£cs
);

1002 
µa
.
m
.
£c
 = 
£cs
;

1004 
∑ddr
 = 
	`div_u64_ªm
’addr, 
uaddrf
->
ch_°rùe
, &
ch∆s
);

1005 
µa
.
m
.
gΩ
 = 
ch∆s
;

1007 
∑ddr
 = 
	`div_u64_ªm
’addr, 
uaddrf
->
lun_°rùe
, &
luns
);

1008 
µa
.
m
.
pu
 = 
luns
;

1010 
µa
.
m
.
£c
 +
uaddrf
->
£c_°rùe
 * 
∑ddr
;

1013  
µa
;

1014 
	}
}

1016 
ölöe
 
nvm_chk_mëa
 *
	$pblk_dev_µa_to_chunk
(
pblk
 *pblk,

1017 
µa_addr
 
p
)

1019 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1020 
nvm_geo
 *
geo
 = &
dev
->geo;

1021 
pblk_löe
 *
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
p
);

1022 
pos
 = 
	`pblk_µa_to_pos
(
geo
, 
p
);

1024  &
löe
->
chks
[
pos
];

1025 
	}
}

1027 
ölöe
 
u64
 
	$pblk_dev_µa_to_chunk_addr
(
pblk
 *pblk,

1028 
µa_addr
 
p
)

1030 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1032  
	`dev_to_chunk_addr
(
dev
->
∑ª¡
, &
pblk
->
addrf
, 
p
);

1033 
	}
}

1035 
ölöe
 
u64
 
	$pblk_dev_µa_to_löe_addr
(
pblk
 *pblk,

1036 
µa_addr
 
p
)

1038 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1039 
nvm_geo
 *
geo
 = &
dev
->geo;

1040 
u64
 
∑ddr
;

1042 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
) {

1043 
nvm_addrf_12
 *
µaf
 = (nvm_addrf_12 *)&
pblk
->
addrf
;

1045 
∑ddr
 = (
u64
)
p
.
g
.
ch
 << 
µaf
->
ch_off£t
;

1046 
∑ddr
 |(
u64
)
p
.
g
.
lun
 << 
µaf
->
lun_off£t
;

1047 
∑ddr
 |(
u64
)
p
.
g
.
pg
 << 
µaf
->
pg_off£t
;

1048 
∑ddr
 |(
u64
)
p
.
g
.
∂
 << 
µaf
->
∂n_off£t
;

1049 
∑ddr
 |(
u64
)
p
.
g
.
£c
 << 
µaf
->
£c_off£t
;

1051 
pblk_addrf
 *
uaddrf
 = &
pblk
->uaddrf;

1052 
u64
 
£cs
 = 
p
.
m
.
£c
;

1053 
£c_°rùe
;

1055 
∑ddr
 = (
u64
)
p
.
m
.
gΩ
 * 
uaddrf
->
£c_°rùe
;

1056 
∑ddr
 +(
u64
)
p
.
m
.
pu
 * 
uaddrf
->
£c_lun_°rùe
;

1058 
£cs
 = 
	`div_u64_ªm
(£cs, 
uaddrf
->
£c_°rùe
, &sec_stripe);

1059 
∑ddr
 +
£cs
 * 
uaddrf
->
£c_ws_°rùe
;

1060 
∑ddr
 +
£c_°rùe
;

1063  
∑ddr
;

1064 
	}
}

1066 
ölöe
 
µa_addr
 
	$pblk_µa32_to_µa64
(
pblk
 *pblk, 
u32
 
µa32
)

1068 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1070  
	`nvm_µa32_to_µa64
(
dev
->
∑ª¡
, &
pblk
->
addrf
, 
µa32
);

1071 
	}
}

1073 
ölöe
 
u32
 
	$pblk_µa64_to_µa32
(
pblk
 *pblk, 
µa_addr
 
µa64
)

1075 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1077  
	`nvm_µa64_to_µa32
(
dev
->
∑ª¡
, &
pblk
->
addrf
, 
µa64
);

1078 
	}
}

1080 
ölöe
 
µa_addr
 
	$pblk_å™s_m≠_gë
(
pblk
 *pblk,

1081 
£˘‹_t
 
lba
)

1083 
µa_addr
 
µa
;

1085 i‡(
pblk
->
addrf_Àn
 < 32) {

1086 
u32
 *
m≠
 = (u32 *)
pblk
->
å™s_m≠
;

1088 
µa
 = 
	`pblk_µa32_to_µa64
(
pblk
, 
m≠
[
lba
]);

1090 
µa_addr
 *
m≠
 = (µa_add∏*)
pblk
->
å™s_m≠
;

1092 
µa
 = 
m≠
[
lba
];

1095  
µa
;

1096 
	}
}

1098 
ölöe
 
	$pblk_å™s_m≠_£t
(
pblk
 *pblk, 
£˘‹_t
 
lba
,

1099 
µa_addr
 
µa
)

1101 i‡(
pblk
->
addrf_Àn
 < 32) {

1102 
u32
 *
m≠
 = (u32 *)
pblk
->
å™s_m≠
;

1104 
m≠
[
lba
] = 
	`pblk_µa64_to_µa32
(
pblk
, 
µa
);

1106 
u64
 *
m≠
 = (u64 *)
pblk
->
å™s_m≠
;

1108 
m≠
[
lba
] = 
µa
.ppa;

1110 
	}
}

1112 
ölöe
 
	$pblk_µa_em±y
(
µa_addr
Öpa_addr)

1114  (
µa_addr
.
µa
 =
ADDR_EMPTY
);

1115 
	}
}

1117 
ölöe
 
	$pblk_µa_£t_em±y
(
µa_addr
 *ppa_addr)

1119 
µa_addr
->
µa
 = 
ADDR_EMPTY
;

1120 
	}
}

1122 
ölöe
 
boﬁ
 
	$pblk_µa_comp
(
µa_addr
 
Õ∑
, µa_add∏
Ω∑
)

1124  (
Õ∑
.
µa
 =
Ω∑
.ppa);

1125 
	}
}

1127 
ölöe
 
	$pblk_addr_ö_ˇche
(
µa_addr
 
µa
)

1129  (
µa
.µ®!
ADDR_EMPTY
 &&Ö∑.
c
.
is_ˇched
);

1130 
	}
}

1132 
ölöe
 
	$pblk_addr_to_ˇchñöe
(
µa_addr
 
µa
)

1134  
µa
.
c
.
löe
;

1135 
	}
}

1137 
ölöe
 
µa_addr
 
	$pblk_ˇchñöe_to_addr
(
addr
)

1139 
µa_addr
 
p
;

1141 
p
.
c
.
löe
 = 
addr
;

1142 
p
.
c
.
is_ˇched
 = 1;

1144  
p
;

1145 
	}
}

1147 
ölöe
 
u32
 
	$pblk_ˇlc_mëa_hódî_¸c
(
pblk
 *pblk,

1148 
löe_hódî
 *
hódî
)

1150 
u32
 
¸c
 = ~(u32)0;

1152 
¸c
 = 
	`¸c32_À
(¸c, (*)
hódî
 + (crc),

1153 (
löe_hódî
Ë- (
¸c
));

1155  
¸c
;

1156 
	}
}

1158 
ölöe
 
u32
 
	$pblk_ˇlc_smëa_¸c
(
pblk
 *pblk,

1159 
löe_smëa
 *
smëa
)

1161 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1162 
u32
 
¸c
 = ~(u32)0;

1164 
¸c
 = 
	`¸c32_À
(¸c, (*)
smëa
 +

1165 (
löe_hódî
Ë+ (
¸c
),

1166 
lm
->
smëa_Àn
 -

1167 (
löe_hódî
Ë- (
¸c
));

1169  
¸c
;

1170 
	}
}

1172 
ölöe
 
u32
 
	$pblk_ˇlc_emëa_¸c
(
pblk
 *pblk,

1173 
löe_emëa
 *
emëa
)

1175 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1176 
u32
 
¸c
 = ~(u32)0;

1178 
¸c
 = 
	`¸c32_À
(¸c, (*)
emëa
 +

1179 (
löe_hódî
Ë+ (
¸c
),

1180 
lm
->
emëa_Àn
[0] -

1181 (
löe_hódî
Ë- (
¸c
));

1183  
¸c
;

1184 
	}
}

1186 
ölöe
 
	$pblk_io_Æig√d
(
pblk
 *pblk, 
ƒ_£cs
)

1188  !(
ƒ_£cs
 % 
pblk
->
mö_wrôe_pgs
);

1189 
	}
}

1191 #ifde‡
CONFIG_NVM_PBLK_DEBUG


1192 
ölöe
 
	$¥öt_µa
(
pblk
 *pblk, 
µa_addr
 *
p
,

1193 *
msg
, 
îr‹
)

1195 
nvm_geo
 *
geo
 = &
pblk
->
dev
->geo;

1197 i‡(
p
->
c
.
is_ˇched
) {

1198 
	`pblk_îr
(
pblk
, "ppa: (%s: %x) cacheÜine: %llu\n",

1199 
msg
, 
îr‹
, (
u64
)
p
->
c
.
löe
);

1200 } i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
) {

1201 
	`pblk_îr
(
pblk
, "ppa: (%s: %x):ch:%d,lun:%d,blk:%d,pg:%d,pl:%d,sec:%d\n",

1202 
msg
, 
îr‹
,

1203 
p
->
g
.
ch
,Ö->g.
lun
,Ö->g.
blk
,

1204 
p
->
g
.
pg
,Ö->g.
∂
,Ö->g.
£c
);

1206 
	`pblk_îr
(
pblk
, "ppa: (%s: %x):ch:%d,lun:%d,chk:%d,sec:%d\n",

1207 
msg
, 
îr‹
,

1208 
p
->
m
.
gΩ
,Ö->m.
pu
,Ö->m.
chk
,Ö->m.
£c
);

1210 
	}
}

1212 
ölöe
 
	$pblk_¥öt_Áûed_rqd
(
pblk
 *pblk, 
nvm_rq
 *
rqd
,

1213 
îr‹
)

1215 
bô
 = -1;

1217 i‡(
rqd
->
ƒ_µas
 == 1) {

1218 
	`¥öt_µa
(
pblk
, &
rqd
->
µa_addr
, "rqd", 
îr‹
);

1222 (
bô
 = 
	`föd_√xt_bô
((*)&
rqd
->
µa_°©us
,Ñqd->
ƒ_µas
,

1223 
bô
 + 1)Ë< 
rqd
->
ƒ_µas
) {

1224 
	`¥öt_µa
(
pblk
, &
rqd
->
µa_li°
[
bô
], "rqd", 
îr‹
);

1227 
	`pblk_îr
(
pblk
, "îr‹:%d,Ö∑_°©us:%Œx\n", 
îr‹
, 
rqd
->
µa_°©us
);

1228 
	}
}

1230 
ölöe
 
	$pblk_bound¨y_µa_checks
(
nvm_tgt_dev
 *
tgt_dev
,

1231 
µa_addr
 *
µas
, 
ƒ_µas
)

1233 
nvm_geo
 *
geo
 = &
tgt_dev
->geo;

1234 
µa_addr
 *
µa
;

1235 
i
;

1237 
i
 = 0; i < 
ƒ_µas
; i++) {

1238 
µa
 = &
µas
[
i
];

1240 i‡(
geo
->
vîsi⁄
 =
NVM_OCSSD_SPEC_12
) {

1241 i‡(!
µa
->
c
.
is_ˇched
 &&

1242 
µa
->
g
.
ch
 < 
geo
->
num_ch
 &&

1243 
µa
->
g
.
lun
 < 
geo
->
num_lun
 &&

1244 
µa
->
g
.
∂
 < 
geo
->
num_∂n
 &&

1245 
µa
->
g
.
blk
 < 
geo
->
num_chk
 &&

1246 
µa
->
g
.
pg
 < 
geo
->
num_pg
 &&

1247 
µa
->
g
.
£c
 < 
geo
->
ws_mö
)

1250 i‡(!
µa
->
c
.
is_ˇched
 &&

1251 
µa
->
m
.
gΩ
 < 
geo
->
num_ch
 &&

1252 
µa
->
m
.
pu
 < 
geo
->
num_lun
 &&

1253 
µa
->
m
.
chk
 < 
geo
->
num_chk
 &&

1254 
µa
->
m
.
£c
 < 
geo
->
˛ba
)

1258 
	`¥öt_µa
(
tgt_dev
->
q
->
queued©a
, 
µa
, "bound¨y", 
i
);

1263 
	}
}

1265 
ölöe
 
	$pblk_check_io
(
pblk
 *pblk, 
nvm_rq
 *
rqd
)

1267 
nvm_tgt_dev
 *
dev
 = 
pblk
->dev;

1268 
µa_addr
 *
µa_li°
 = 
	`nvm_rq_to_µa_li°
(
rqd
);

1270 i‡(
	`pblk_bound¨y_µa_checks
(
dev
, 
µa_li°
, 
rqd
->
ƒ_µas
)) {

1271 
	`WARN_ON
(1);

1272  -
EINVAL
;

1275 i‡(
rqd
->
›code
 =
NVM_OP_PWRITE
) {

1276 
pblk_löe
 *
löe
;

1277 
i
;

1279 
i
 = 0; i < 
rqd
->
ƒ_µas
; i++) {

1280 
löe
 = 
	`pblk_µa_to_löe
(
pblk
, 
µa_li°
[
i
]);

1282 
	`•ö_lock
(&
löe
->
lock
);

1283 i‡(
löe
->
°©e
 !
PBLK_LINESTATE_OPEN
) {

1284 
	`pblk_îr
(
pblk
, "badÖpa:Üine:%d,state:%d\n",

1285 
löe
->
id
,Üöe->
°©e
);

1286 
	`WARN_ON
(1);

1287 
	`•ö_u∆ock
(&
löe
->
lock
);

1288  -
EINVAL
;

1290 
	`•ö_u∆ock
(&
löe
->
lock
);

1295 
	}
}

1298 
ölöe
 
	$pblk_bound¨y_∑ddr_checks
(
pblk
 *pblk, 
u64
 
∑ddr
)

1300 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1302 i‡(
∑ddr
 > 
lm
->
£c_≥r_löe
)

1306 
	}
}

1308 
ölöe
 
	$pblk_gë_bi_idx
(
bio
 *bio)

1310  
bio
->
bi_ôî
.
bi_idx
;

1311 
	}
}

1313 
ölöe
 
£˘‹_t
 
	$pblk_gë_lba
(
bio
 *bio)

1315  
bio
->
bi_ôî
.
bi_£˘‹
 / 
NR_PHY_IN_LOG
;

1316 
	}
}

1318 
ölöe
 
	$pblk_gë_£cs
(
bio
 *bio)

1320  
bio
->
bi_ôî
.
bi_size
 / 
PBLK_EXPOSED_PAGE_SIZE
;

1321 
	}
}

1323 
ölöe
 *
	$pblk_disk_«me
(
pblk
 *pblk)

1325 
gídisk
 *
disk
 = 
pblk
->disk;

1327  
disk
->
disk_«me
;

1328 
	}
}

1330 
ölöe
 
	$pblk_gë_mö_chks
(
pblk
 *pblk)

1332 
pblk_löe_mëa
 *
lm
 = &
pblk
->lm;

1337  
	`DIV_ROUND_UP
(100, 
pblk
->
›
Ë* 
lm
->
blk_≥r_löe
;

1338 
	}
}

1340 
ölöe
 
pblk_£c_mëa
 *
	$pblk_gë_mëa
(
pblk
 *pblk,

1341 *
mëa
, 
ödex
)

1343  
mëa
 +

1344 
	`max_t
(, (
pblk_£c_mëa
), 
pblk
->
oob_mëa_size
)

1345 * 
ödex
;

1346 
	}
}

1348 
ölöe
 
	$pblk_dma_mëa_size
(
pblk
 *pblk)

1350  
	`max_t
(, (
pblk_£c_mëa
), 
pblk
->
oob_mëa_size
)

1351 * 
NVM_MAX_VLBA
;

1352 
	}
}

1354 
ölöe
 
	$pblk_is_oob_mëa_suµ‹ãd
(
pblk
 *pblk)

1356  
pblk
->
oob_mëa_size
 >(
pblk_£c_mëa
);

1357 
	}
}

	@/usr/include/linux/lightnvm.h

20 #i‚de‡
_LINUX_LIGHTNVM_H


21 
	#_LINUX_LIGHTNVM_H


	)

23 
	~<°dio.h
>

24 
	~<sys/io˘l.h
>

25 
	#DISK_NAME_LEN
 32

	)

27 
	~<löux/ty≥s.h
>

28 
	~<löux/io˘l.h
>

30 
	#NVM_TTYPE_NAME_MAX
 48

	)

31 
	#NVM_TTYPE_MAX
 63

	)

32 
	#NVM_MMTYPE_LEN
 8

	)

34 
	#NVM_CTRL_FILE
 "/dev/lighävm/c⁄åﬁ"

	)

36 
	snvm_io˘l_öfo_tgt
 {

37 
__u32
 
	mvîsi⁄
[3];

38 
__u32
 
	mª£rved
;

39 
	mtgäame
[
NVM_TTYPE_NAME_MAX
];

42 
	snvm_io˘l_öfo
 {

43 
__u32
 
	mvîsi⁄
[3];

44 
__u16
 
	mtgtsize
;

45 
__u16
 
	mª£rved16
;

46 
__u32
 
	mª£rved
[12];

47 
nvm_io˘l_öfo_tgt
 
	mtgts
[
NVM_TTYPE_MAX
];

51 
	mNVM_DEVICE_ACTIVE
 = 1 << 0,

54 
	snvm_io˘l_devi˚_öfo
 {

55 
	mdev«me
[
DISK_NAME_LEN
];

56 
	mbm«me
[
NVM_TTYPE_NAME_MAX
];

57 
__u32
 
	mbmvîsi⁄
[3];

58 
__u32
 
	mÊags
;

59 
__u32
 
	mª£rved
[8];

62 
	snvm_io˘l_gë_devi˚s
 {

63 
__u32
 
	mƒ_devi˚s
;

64 
__u32
 
	mª£rved
[31];

65 
nvm_io˘l_devi˚_öfo
 
	möfo
[31];

68 
	snvm_io˘l_¸óã_sim∂e
 {

69 
__u32
 
	mlun_begö
;

70 
__u32
 
	mlun_íd
;

73 
	snvm_io˘l_¸óã_exãnded
 {

74 
__u16
 
	mlun_begö
;

75 
__u16
 
	mlun_íd
;

76 
__u16
 
	m›
;

77 
__u16
 
	mrsv
;

81 
	mNVM_CONFIG_TYPE_SIMPLE
 = 0,

82 
	mNVM_CONFIG_TYPE_EXTENDED
 = 1,

85 
	snvm_io˘l_¸óã_c⁄f
 {

86 
__u32
 
	mty≥
;

88 
nvm_io˘l_¸óã_sim∂e
 
	ms
;

89 
nvm_io˘l_¸óã_exãnded
 
	me
;

94 
	mNVM_TARGET_FACTORY
 = 1 << 0,

97 
	snvm_io˘l_¸óã
 {

98 
	mdev
[
DISK_NAME_LEN
];

99 
	mtgây≥
[
NVM_TTYPE_NAME_MAX
];

100 
	mtgäame
[
DISK_NAME_LEN
];

102 
__u32
 
	mÊags
;

104 
nvm_io˘l_¸óã_c⁄f
 
	mc⁄f
;

107 
	snvm_io˘l_ªmove
 {

108 
	mtgäame
[
DISK_NAME_LEN
];

110 
__u32
 
	mÊags
;

113 
	snvm_io˘l_dev_öô
 {

114 
	mdev
[
DISK_NAME_LEN
];

115 
	mmmty≥
[
NVM_MMTYPE_LEN
];

117 
__u32
 
	mÊags
;

121 
	mNVM_FACTORY_ERASE_ONLY_USER
 = 1 << 0,

123 
	mNVM_FACTORY_RESET_HOST_BLKS
 = 1 << 1,

124 
	mNVM_FACTORY_RESET_GRWN_BBLKS
 = 1 << 2,

125 
	mNVM_FACTORY_NR_BITS
 = 1 << 3,

128 
	snvm_io˘l_dev_Á˘‹y
 {

129 
	mdev
[
DISK_NAME_LEN
];

131 
__u32
 
	mÊags
;

134 
	snvm_u£r_vio
 {

135 
__u8
 
	m›code
;

136 
__u8
 
	mÊags
;

137 
__u16
 
	mc⁄åﬁ
;

138 
__u16
 
	m≈∑s
;

139 
__u16
 
	mrsvd
;

140 
__u64
 
	mmëad©a
;

141 
__u64
 
	maddr
;

142 
__u64
 
	mµa_li°
;

143 
__u32
 
	mmëad©a_Àn
;

144 
__u32
 
	md©a_Àn
;

145 
__u64
 
	m°©us
;

146 
__u32
 
	mªsu…
;

147 
__u32
 
	mrsvd3
[3];

150 
	snvm_∑s°hru_vio
 {

151 
__u8
 
	m›code
;

152 
__u8
 
	mÊags
;

153 
__u8
 
	mrsvd
[2];

154 
__u32
 
	mnsid
;

155 
__u32
 
	mcdw2
;

156 
__u32
 
	mcdw3
;

157 
__u64
 
	mmëad©a
;

158 
__u64
 
	maddr
;

159 
__u32
 
	mmëad©a_Àn
;

160 
__u32
 
	md©a_Àn
;

161 
__u64
 
	mµa_li°
;

162 
__u16
 
	m≈∑s
;

163 
__u16
 
	mc⁄åﬁ
;

164 
__u32
 
	mcdw13
;

165 
__u32
 
	mcdw14
;

166 
__u32
 
	mcdw15
;

167 
__u64
 
	m°©us
;

168 
__u32
 
	mªsu…
;

169 
__u32
 
	mtimeout_ms
;

175 
	mNVM_INFO_CMD
 = 0x20,

176 
	mNVM_GET_DEVICES_CMD
,

179 
	mNVM_DEV_CREATE_CMD
,

180 
	mNVM_DEV_REMOVE_CMD
,

183 
	mNVM_DEV_INIT_CMD
,

186 
	mNVM_DEV_FACTORY_CMD
,

189 
	mNVM_DEV_VIO_ADMIN_CMD
 = 0x41,

190 
	mNVM_DEV_VIO_CMD
 = 0x42,

191 
	mNVM_DEV_VIO_USER_CMD
 = 0x43,

194 
	#NVM_IOCTL
 'L'

	)

196 
	#NVM_INFO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_INFO_CMD
, \

197 
nvm_io˘l_öfo
)

	)

198 
	#NVM_GET_DEVICES
 
	`_IOR
(
NVM_IOCTL
, 
NVM_GET_DEVICES_CMD
, \

199 
nvm_io˘l_gë_devi˚s
)

	)

200 
	#NVM_DEV_CREATE
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_CREATE_CMD
, \

201 
nvm_io˘l_¸óã
)

	)

202 
	#NVM_DEV_REMOVE
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_REMOVE_CMD
, \

203 
nvm_io˘l_ªmove
)

	)

204 
	#NVM_DEV_INIT
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_INIT_CMD
, \

205 
nvm_io˘l_dev_öô
)

	)

206 
	#NVM_DEV_FACTORY
 
	`_IOW
(
NVM_IOCTL
, 
NVM_DEV_FACTORY_CMD
, \

207 
nvm_io˘l_dev_Á˘‹y
)

	)

209 
	#NVME_NVM_IOCTL_IO_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_USER_CMD
, \

210 
nvm_∑s°hru_vio
)

	)

211 
	#NVME_NVM_IOCTL_ADMIN_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_ADMIN_CMD
,\

212 
nvm_∑s°hru_vio
)

	)

213 
	#NVME_NVM_IOCTL_SUBMIT_VIO
 
	`_IOWR
(
NVM_IOCTL
, 
NVM_DEV_VIO_CMD
,\

214 
nvm_u£r_vio
)

	)

216 
	#NVM_VERSION_MAJOR
 1

	)

217 
	#NVM_VERSION_MINOR
 0

	)

218 
	#NVM_VERSION_PATCHLEVEL
 0

	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/sem.h

2 #i‚de‡
_LINUX_SEM_H


3 
	#_LINUX_SEM_H


	)

5 
	~<löux/ùc.h
>

8 
	#SEM_UNDO
 0x1000

	)

11 
	#GETPID
 11

	)

12 
	#GETVAL
 12

	)

13 
	#GETALL
 13

	)

14 
	#GETNCNT
 14

	)

15 
	#GETZCNT
 15

	)

16 
	#SETVAL
 16

	)

17 
	#SETALL
 17

	)

20 
	#SEM_STAT
 18

	)

21 
	#SEM_INFO
 19

	)

22 
	#SEM_STAT_ANY
 20

	)

25 
	s£mid_ds
 {

26 
ùc_≥rm
 
	m£m_≥rm
;

27 
__kî√l_time_t
 
	m£m_Ÿime
;

28 
__kî√l_time_t
 
	m£m_˘ime
;

29 
£m
 *
	m£m_ba£
;

30 
£m_queue
 *
	m£m_≥ndög
;

31 
£m_queue
 **
	m£m_≥ndög_œ°
;

32 
£m_undo
 *
	mundo
;

33 
	m£m_n£ms
;

37 
	~<asm/£mbuf.h
>

40 
	s£mbuf
 {

41 
	m£m_num
;

42 
	m£m_›
;

43 
	m£m_Êg
;

47 
	u£mun
 {

48 
	mvÆ
;

49 
£mid_ds
 *
	mbuf
;

50 *
	m¨øy
;

51 
£möfo
 *
	m__buf
;

52 *
	m__∑d
;

55 
	s£möfo
 {

56 
	m£mm≠
;

57 
	m£mmni
;

58 
	m£mmns
;

59 
	m£mmnu
;

60 
	m£mm¶
;

61 
	m£m›m
;

62 
	m£mume
;

63 
	m£musz
;

64 
	m£mvmx
;

65 
	m£m´m
;

80 
	#SEMMNI
 32000

	)

81 
	#SEMMSL
 32000

	)

82 
	#SEMMNS
 (
SEMMNI
*
SEMMSL
Ë

	)

83 
	#SEMOPM
 500

	)

84 
	#SEMVMX
 32767

	)

85 
	#SEMAEM
 
SEMVMX


	)

88 
	#SEMUME
 
SEMOPM


	)

89 
	#SEMMNU
 
SEMMNS


	)

90 
	#SEMMAP
 
SEMMNS


	)

91 
	#SEMUSZ
 20

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

35 
guid_t
 
	tuuid_À
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/ipc.h

2 #i‚de‡
_LINUX_IPC_H


3 
	#_LINUX_IPC_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#IPC_PRIVATE
 ((
__kî√l_key_t
Ë0)

	)

10 
	sùc_≥rm


12 
__kî√l_key_t
 
	mkey
;

13 
__kî√l_uid_t
 
	muid
;

14 
__kî√l_gid_t
 
	mgid
;

15 
__kî√l_uid_t
 
	mcuid
;

16 
__kî√l_gid_t
 
	mcgid
;

17 
__kî√l_mode_t
 
	mmode
;

18 
	m£q
;

22 
	~<asm/ùcbuf.h
>

25 
	#IPC_CREAT
 00001000

	)

26 
	#IPC_EXCL
 00002000

	)

27 
	#IPC_NOWAIT
 00004000

	)

32 
	#IPC_DIPC
 00010000

	)

33 
	#IPC_OWN
 00020000

	)

39 
	#IPC_RMID
 0

	)

40 
	#IPC_SET
 1

	)

41 
	#IPC_STAT
 2

	)

42 
	#IPC_INFO
 3

	)

48 
	#IPC_OLD
 0

	)

50 
	#IPC_64
 0x0100

	)

58 
	sùc_kludge
 {

59 
msgbuf
 *
	mmsgp
;

60 
	mmsgtyp
;

63 
	#SEMOP
 1

	)

64 
	#SEMGET
 2

	)

65 
	#SEMCTL
 3

	)

66 
	#SEMTIMEDOP
 4

	)

67 
	#MSGSND
 11

	)

68 
	#MSGRCV
 12

	)

69 
	#MSGGET
 13

	)

70 
	#MSGCTL
 14

	)

71 
	#SHMAT
 21

	)

72 
	#SHMDT
 22

	)

73 
	#SHMGET
 23

	)

74 
	#SHMCTL
 24

	)

77 
	#DIPC
 25

	)

79 
	#IPCCALL
(
vîsi⁄
,
›
Ë((vîsi⁄)<<16 | (›))

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/stdio.h

23 #i‚de‡
_STDIO_H


24 
	#_STDIO_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<bôs/libc-hódî-°¨t.h
>

29 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

35 
	#__√ed___va_li°


	)

36 
	~<°d¨g.h
>

38 
	~<bôs/ty≥s.h
>

39 
	~<bôs/ty≥s/__Âos_t.h
>

40 
	~<bôs/ty≥s/__Âos64_t.h
>

41 
	~<bôs/ty≥s/__FILE.h
>

42 
	~<bôs/ty≥s/FILE.h
>

43 
	~<bôs/ty≥s/°ru˘_FILE.h
>

45 #ifde‡
__USE_GNU


46 
	~<bôs/ty≥s/cookõ_io_fun˘i⁄s_t.h
>

49 #i‡
deföed
 
__USE_XOPEN
 || deföed 
__USE_XOPEN2K8


50 #ifde‡
__GNUC__


51 #i‚de‡
_VA_LIST_DEFINED


52 
__gnuc_va_li°
 
	tva_li°
;

53 
	#_VA_LIST_DEFINED


	)

56 
	~<°d¨g.h
>

60 #i‡
deföed
 
__USE_UNIX98
 || deföed 
__USE_XOPEN2K


61 #i‚de‡
__off_t_deföed


62 #i‚de‡
__USE_FILE_OFFSET64


63 
__off_t
 
	toff_t
;

65 
__off64_t
 
	toff_t
;

67 
	#__off_t_deföed


	)

69 #i‡
deföed
 
__USE_LARGEFILE64
 && !deföed 
__off64_t_deföed


70 
__off64_t
 
	toff64_t
;

71 
	#__off64_t_deföed


	)

75 #ifde‡
__USE_XOPEN2K8


76 #i‚de‡
__ssize_t_deföed


77 
__ssize_t
 
	tssize_t
;

78 
	#__ssize_t_deföed


	)

83 #i‚de‡
__USE_FILE_OFFSET64


84 
__Âos_t
 
	tÂos_t
;

86 
__Âos64_t
 
	tÂos_t
;

88 #ifde‡
__USE_LARGEFILE64


89 
__Âos64_t
 
	tÂos64_t
;

93 
	#_IOFBF
 0

	)

94 
	#_IOLBF
 1

	)

95 
	#_IONBF
 2

	)

99 
	#BUFSIZ
 8192

	)

104 
	#EOF
 (-1)

	)

109 
	#SEEK_SET
 0

	)

110 
	#SEEK_CUR
 1

	)

111 
	#SEEK_END
 2

	)

112 #ifde‡
__USE_GNU


113 
	#SEEK_DATA
 3

	)

114 
	#SEEK_HOLE
 4

	)

118 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


120 
	#P_tmpdú
 "/tmp"

	)

133 
	~<bôs/°dio_lim.h
>

137 
FILE
 *
°dö
;

138 
FILE
 *
°dout
;

139 
FILE
 *
°dîr
;

141 
	#°dö
 
°dö


	)

142 
	#°dout
 
°dout


	)

143 
	#°dîr
 
°dîr


	)

146 
	$ªmove
 (c⁄° *
__fûíame
Ë
__THROW
;

148 
	$ª«me
 (c⁄° *
__ﬁd
, c⁄° *
__√w
Ë
__THROW
;

150 #ifde‡
__USE_ATFILE


152 
	$ª«mót
 (
__ﬁdfd
, c⁄° *
__ﬁd
, 
__√wfd
,

153 c⁄° *
__√w
Ë
__THROW
;

156 #ifde‡
__USE_GNU


158 
	#RENAME_NOREPLACE
 (1 << 0)

	)

159 
	#RENAME_EXCHANGE
 (1 << 1)

	)

160 
	#RENAME_WHITEOUT
 (1 << 2)

	)

164 
	$ª«mót2
 (
__ﬁdfd
, c⁄° *
__ﬁd
, 
__√wfd
,

165 c⁄° *
__√w
, 
__Êags
Ë
__THROW
;

172 #i‚de‡
__USE_FILE_OFFSET64


173 
FILE
 *
	$tmpfûe
 (Ë
__wur
;

175 #ifde‡
__REDIRECT


176 
FILE
 *
	`__REDIRECT
 (
tmpfûe
, (), 
tmpfûe64
Ë
__wur
;

178 
	#tmpfûe
 
tmpfûe64


	)

182 #ifde‡
__USE_LARGEFILE64


183 
FILE
 *
	$tmpfûe64
 (Ë
__wur
;

187 *
	$tm≤am
 (*
__s
Ë
__THROW
 
__wur
;

189 #ifde‡
__USE_MISC


192 *
	$tm≤am_r
 (*
__s
Ë
__THROW
 
__wur
;

196 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


204 *
	$ãm≤am
 (c⁄° *
__dú
, c⁄° *
__pfx
)

205 
__THROW
 
__©åibuã_mÆloc__
 
__wur
;

213 
	`f˛o£
 (
FILE
 *
__°ªam
);

218 
	`fÊush
 (
FILE
 *
__°ªam
);

220 #ifde‡
__USE_MISC


227 
	`fÊush_u∆ocked
 (
FILE
 *
__°ªam
);

230 #ifde‡
__USE_GNU


237 
	`f˛o£Æl
 ();

241 #i‚de‡
__USE_FILE_OFFSET64


246 
FILE
 *
	$f›í
 (c⁄° *
__ª°ri˘
 
__fûíame
,

247 c⁄° *
__ª°ri˘
 
__modes
Ë
__wur
;

252 
FILE
 *
	$‰e›í
 (c⁄° *
__ª°ri˘
 
__fûíame
,

253 c⁄° *
__ª°ri˘
 
__modes
,

254 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

256 #ifde‡
__REDIRECT


257 
FILE
 *
	`__REDIRECT
 (
f›í
, (c⁄° *
__ª°ri˘
 
__fûíame
,

258 c⁄° *
__ª°ri˘
 
__modes
), 
f›í64
)

259 
__wur
;

260 
FILE
 *
	`__REDIRECT
 (
‰e›í
, (c⁄° *
__ª°ri˘
 
__fûíame
,

261 c⁄° *
__ª°ri˘
 
__modes
,

262 
FILE
 *
__ª°ri˘
 
__°ªam
), 
‰e›í64
)

263 
__wur
;

265 
	#f›í
 
f›í64


	)

266 
	#‰e›í
 
‰e›í64


	)

269 #ifde‡
__USE_LARGEFILE64


270 
FILE
 *
	$f›í64
 (c⁄° *
__ª°ri˘
 
__fûíame
,

271 c⁄° *
__ª°ri˘
 
__modes
Ë
__wur
;

272 
FILE
 *
	$‰e›í64
 (c⁄° *
__ª°ri˘
 
__fûíame
,

273 c⁄° *
__ª°ri˘
 
__modes
,

274 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

277 #ifdef 
__USE_POSIX


279 
FILE
 *
	$fd›í
 (
__fd
, c⁄° *
__modes
Ë
__THROW
 
__wur
;

282 #ifdef 
__USE_GNU


285 
FILE
 *
	$f›ícookõ
 (*
__ª°ri˘
 
__magic_cookõ
,

286 c⁄° *
__ª°ri˘
 
__modes
,

287 
cookõ_io_fun˘i⁄s_t
 
__io_funcs
Ë
__THROW
 
__wur
;

290 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

292 
FILE
 *
	$fmem›í
 (*
__s
, 
size_t
 
__Àn
, c⁄° *
__modes
)

293 
__THROW
 
__wur
;

298 
FILE
 *
	$›í_mem°ªam
 (**
__buÊoc
, 
size_t
 *
__sizñoc
Ë
__THROW
 
__wur
;

304 
	$£tbuf
 (
FILE
 *
__ª°ri˘
 
__°ªam
, *__ª°ri˘ 
__buf
Ë
__THROW
;

308 
	$£tvbuf
 (
FILE
 *
__ª°ri˘
 
__°ªam
, *__ª°ri˘ 
__buf
,

309 
__modes
, 
size_t
 
__n
Ë
__THROW
;

311 #ifdef 
__USE_MISC


314 
	$£tbuf„r
 (
FILE
 *
__ª°ri˘
 
__°ªam
, *__ª°ri˘ 
__buf
,

315 
size_t
 
__size
Ë
__THROW
;

318 
	$£éöebuf
 (
FILE
 *
__°ªam
Ë
__THROW
;

326 
	`Ârötf
 (
FILE
 *
__ª°ri˘
 
__°ªam
,

327 c⁄° *
__ª°ri˘
 
__f‹m©
, ...);

332 
	`¥ötf
 (c⁄° *
__ª°ri˘
 
__f‹m©
, ...);

334 
	$•rötf
 (*
__ª°ri˘
 
__s
,

335 c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__THROWNL
;

341 
	`vÂrötf
 (
FILE
 *
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__f‹m©
,

342 
__gnuc_va_li°
 
__¨g
);

347 
	`v¥ötf
 (c⁄° *
__ª°ri˘
 
__f‹m©
, 
__gnuc_va_li°
 
__¨g
);

349 
	$v•rötf
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__f‹m©
,

350 
__gnuc_va_li°
 
__¨g
Ë
__THROWNL
;

352 #i‡
deföed
 
__USE_ISOC99
 || deföed 
__USE_UNIX98


354 
	$¢¥ötf
 (*
__ª°ri˘
 
__s
, 
size_t
 
__maxÀn
,

355 c⁄° *
__ª°ri˘
 
__f‹m©
, ...)

356 
__THROWNL
 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 3, 4)));

358 
	$v¢¥ötf
 (*
__ª°ri˘
 
__s
, 
size_t
 
__maxÀn
,

359 c⁄° *
__ª°ri˘
 
__f‹m©
, 
__gnuc_va_li°
 
__¨g
)

360 
__THROWNL
 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 3, 0)));

363 #i‡
	`__GLIBC_USE
 (
LIB_EXT2
)

366 
	$va•rötf
 (**
__ª°ri˘
 
__±r
, c⁄° *__ª°ri˘ 
__f
,

367 
__gnuc_va_li°
 
__¨g
)

368 
__THROWNL
 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__¥ötf__
, 2, 0))Ë
__wur
;

369 
	$__a•rötf
 (**
__ª°ri˘
 
__±r
,

370 c⁄° *
__ª°ri˘
 
__fmt
, ...)

371 
__THROWNL
 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__¥ötf__
, 2, 3))Ë
__wur
;

372 
	$a•rötf
 (**
__ª°ri˘
 
__±r
,

373 c⁄° *
__ª°ri˘
 
__fmt
, ...)

374 
__THROWNL
 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__¥ötf__
, 2, 3))Ë
__wur
;

377 #ifde‡
__USE_XOPEN2K8


379 
	$vd¥ötf
 (
__fd
, c⁄° *
__ª°ri˘
 
__fmt
,

380 
__gnuc_va_li°
 
__¨g
)

381 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 2, 0)));

382 
	$d¥ötf
 (
__fd
, c⁄° *
__ª°ri˘
 
__fmt
, ...)

383 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 2, 3)));

391 
	$fsˇnf
 (
FILE
 *
__ª°ri˘
 
__°ªam
,

392 c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__wur
;

397 
	$sˇnf
 (c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__wur
;

399 
	$ssˇnf
 (c⁄° *
__ª°ri˘
 
__s
,

400 c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__THROW
;

405 #i‡!
	`__GLIBC_USE
 (
DEPRECATED_SCANF
Ë&& !
deföed
 
__LDBL_COMPAT


406 #ifde‡
__REDIRECT


407 
	`__REDIRECT
 (
fsˇnf
, (
FILE
 *
__ª°ri˘
 
__°ªam
,

408 c⁄° *
__ª°ri˘
 
__f‹m©
, ...),

409 
__isoc99_fsˇnf
Ë
__wur
;

410 
	`__REDIRECT
 (
sˇnf
, (c⁄° *
__ª°ri˘
 
__f‹m©
, ...),

411 
__isoc99_sˇnf
Ë
__wur
;

412 
	`__REDIRECT_NTH
 (
ssˇnf
, (c⁄° *
__ª°ri˘
 
__s
,

413 c⁄° *
__ª°ri˘
 
__f‹m©
, ...),

414 
__isoc99_ssˇnf
);

416 
	$__isoc99_fsˇnf
 (
FILE
 *
__ª°ri˘
 
__°ªam
,

417 c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__wur
;

418 
	$__isoc99_sˇnf
 (c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__wur
;

419 
	$__isoc99_ssˇnf
 (c⁄° *
__ª°ri˘
 
__s
,

420 c⁄° *
__ª°ri˘
 
__f‹m©
, ...Ë
__THROW
;

421 
	#fsˇnf
 
__isoc99_fsˇnf


	)

422 
	#sˇnf
 
__isoc99_sˇnf


	)

423 
	#ssˇnf
 
__isoc99_ssˇnf


	)

427 #ifdef 
__USE_ISOC99


432 
	$vfsˇnf
 (
FILE
 *
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__f‹m©
,

433 
__gnuc_va_li°
 
__¨g
)

434 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__sˇnf__
, 2, 0))Ë
__wur
;

440 
	$vsˇnf
 (c⁄° *
__ª°ri˘
 
__f‹m©
, 
__gnuc_va_li°
 
__¨g
)

441 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__sˇnf__
, 1, 0))Ë
__wur
;

444 
	$vssˇnf
 (c⁄° *
__ª°ri˘
 
__s
,

445 c⁄° *
__ª°ri˘
 
__f‹m©
, 
__gnuc_va_li°
 
__¨g
)

446 
__THROW
 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__sˇnf__
, 2, 0)));

449 #i‡!
	`__GLIBC_USE
 (
DEPRECATED_SCANF
)

450 #i‡
deföed
 
__REDIRECT
 && !deföed 
__LDBL_COMPAT


451 
	`__REDIRECT
 (
vfsˇnf
,

452 (
FILE
 *
__ª°ri˘
 
__s
,

453 c⁄° *
__ª°ri˘
 
__f‹m©
, 
__gnuc_va_li°
 
__¨g
),

454 
__isoc99_vfsˇnf
)

455 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__sˇnf__
, 2, 0))Ë
__wur
;

456 
	`__REDIRECT
 (
vsˇnf
, (c⁄° *
__ª°ri˘
 
__f‹m©
,

457 
__gnuc_va_li°
 
__¨g
), 
__isoc99_vsˇnf
)

458 
	`__©åibuã__
 ((
	$__f‹m©__
 (
__sˇnf__
, 1, 0))Ë
__wur
;

459 
	`__REDIRECT_NTH
 (
vssˇnf
,

460 (c⁄° *
__ª°ri˘
 
__s
,

461 c⁄° *
__ª°ri˘
 
__f‹m©
,

462 
__gnuc_va_li°
 
__¨g
), 
__isoc99_vssˇnf
)

463 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__sˇnf__
, 2, 0)));

464 #ñi‡!
deföed
 
__REDIRECT


465 
	$__isoc99_vfsˇnf
 (
FILE
 *
__ª°ri˘
 
__s
,

466 c⁄° *
__ª°ri˘
 
__f‹m©
,

467 
__gnuc_va_li°
 
__¨g
Ë
__wur
;

468 
	$__isoc99_vsˇnf
 (c⁄° *
__ª°ri˘
 
__f‹m©
,

469 
__gnuc_va_li°
 
__¨g
Ë
__wur
;

470 
	$__isoc99_vssˇnf
 (c⁄° *
__ª°ri˘
 
__s
,

471 c⁄° *
__ª°ri˘
 
__f‹m©
,

472 
__gnuc_va_li°
 
__¨g
Ë
__THROW
;

473 
	#vfsˇnf
 
__isoc99_vfsˇnf


	)

474 
	#vsˇnf
 
__isoc99_vsˇnf


	)

475 
	#vssˇnf
 
__isoc99_vssˇnf


	)

485 
	`fgëc
 (
FILE
 *
__°ªam
);

486 
	`gëc
 (
FILE
 *
__°ªam
);

492 
	`gëch¨
 ();

494 #ifde‡
__USE_POSIX199506


499 
	`gëc_u∆ocked
 (
FILE
 *
__°ªam
);

500 
	`gëch¨_u∆ocked
 ();

503 #ifde‡
__USE_MISC


510 
	`fgëc_u∆ocked
 (
FILE
 *
__°ªam
);

521 
	`Âutc
 (
__c
, 
FILE
 *
__°ªam
);

522 
	`putc
 (
__c
, 
FILE
 *
__°ªam
);

528 
	`putch¨
 (
__c
);

530 #ifde‡
__USE_MISC


537 
	`Âutc_u∆ocked
 (
__c
, 
FILE
 *
__°ªam
);

540 #ifde‡
__USE_POSIX199506


545 
	`putc_u∆ocked
 (
__c
, 
FILE
 *
__°ªam
);

546 
	`putch¨_u∆ocked
 (
__c
);

550 #i‡
deföed
 
__USE_MISC
 \

551 || (
deföed
 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
)

553 
	`gëw
 (
FILE
 *
__°ªam
);

556 
	`putw
 (
__w
, 
FILE
 *
__°ªam
);

564 *
	$fgës
 (*
__ª°ri˘
 
__s
, 
__n
, 
FILE
 *__ª°ri˘ 
__°ªam
)

565 
__wur
;

567 #i‡
	`__GLIBC_USE
 (
DEPRECATED_GETS
)

577 *
	$gës
 (*
__s
Ë
__wur
 
__©åibuã_dïªˇãd__
;

580 #ifde‡
__USE_GNU


587 *
	$fgës_u∆ocked
 (*
__ª°ri˘
 
__s
, 
__n
,

588 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

592 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

603 
__ssize_t
 
	$__gëdñim
 (**
__ª°ri˘
 
__löïå
,

604 
size_t
 *
__ª°ri˘
 
__n
, 
__dñimôî
,

605 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

606 
__ssize_t
 
	$gëdñim
 (**
__ª°ri˘
 
__löïå
,

607 
size_t
 *
__ª°ri˘
 
__n
, 
__dñimôî
,

608 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

616 
__ssize_t
 
	$gëlöe
 (**
__ª°ri˘
 
__löïå
,

617 
size_t
 *
__ª°ri˘
 
__n
,

618 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

626 
	`Âuts
 (c⁄° *
__ª°ri˘
 
__s
, 
FILE
 *__ª°ri˘ 
__°ªam
);

632 
	`puts
 (c⁄° *
__s
);

639 
	`ungëc
 (
__c
, 
FILE
 *
__°ªam
);

646 
size_t
 
	$‰ód
 (*
__ª°ri˘
 
__±r
, 
size_t
 
__size
,

647 
size_t
 
__n
, 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

652 
size_t
 
	`fwrôe
 (c⁄° *
__ª°ri˘
 
__±r
, size_à
__size
,

653 
size_t
 
__n
, 
FILE
 *
__ª°ri˘
 
__s
);

655 #ifde‡
__USE_GNU


662 
	`Âuts_u∆ocked
 (c⁄° *
__ª°ri˘
 
__s
,

663 
FILE
 *
__ª°ri˘
 
__°ªam
);

666 #ifde‡
__USE_MISC


673 
size_t
 
	$‰ód_u∆ocked
 (*
__ª°ri˘
 
__±r
, 
size_t
 
__size
,

674 
size_t
 
__n
, 
FILE
 *
__ª°ri˘
 
__°ªam
Ë
__wur
;

675 
size_t
 
	`fwrôe_u∆ocked
 (c⁄° *
__ª°ri˘
 
__±r
, size_à
__size
,

676 
size_t
 
__n
, 
FILE
 *
__ª°ri˘
 
__°ªam
);

684 
	`f£ek
 (
FILE
 *
__°ªam
, 
__off
, 
__whí˚
);

689 
	$·ñl
 (
FILE
 *
__°ªam
Ë
__wur
;

694 
	`ªwöd
 (
FILE
 *
__°ªam
);

701 #i‡
deföed
 
__USE_LARGEFILE
 || deföed 
__USE_XOPEN2K


702 #i‚de‡
__USE_FILE_OFFSET64


707 
	`f£eko
 (
FILE
 *
__°ªam
, 
__off_t
 
__off
, 
__whí˚
);

712 
__off_t
 
	$·ñlo
 (
FILE
 *
__°ªam
Ë
__wur
;

714 #ifde‡
__REDIRECT


715 
	`__REDIRECT
 (
f£eko
,

716 (
FILE
 *
__°ªam
, 
__off64_t
 
__off
, 
__whí˚
),

717 
f£eko64
);

718 
__off64_t
 
	`__REDIRECT
 (
·ñlo
, (
FILE
 *
__°ªam
), 
·ñlo64
);

720 
	#f£eko
 
f£eko64


	)

721 
	#·ñlo
 
·ñlo64


	)

726 #i‚de‡
__USE_FILE_OFFSET64


731 
	`fgëpos
 (
FILE
 *
__ª°ri˘
 
__°ªam
, 
Âos_t
 *__ª°ri˘ 
__pos
);

736 
	`f£ços
 (
FILE
 *
__°ªam
, c⁄° 
Âos_t
 *
__pos
);

738 #ifde‡
__REDIRECT


739 
	`__REDIRECT
 (
fgëpos
, (
FILE
 *
__ª°ri˘
 
__°ªam
,

740 
Âos_t
 *
__ª°ri˘
 
__pos
), 
fgëpos64
);

741 
	`__REDIRECT
 (
f£ços
,

742 (
FILE
 *
__°ªam
, c⁄° 
Âos_t
 *
__pos
), 
f£ços64
);

744 
	#fgëpos
 
fgëpos64


	)

745 
	#f£ços
 
f£ços64


	)

749 #ifde‡
__USE_LARGEFILE64


750 
	`f£eko64
 (
FILE
 *
__°ªam
, 
__off64_t
 
__off
, 
__whí˚
);

751 
__off64_t
 
	$·ñlo64
 (
FILE
 *
__°ªam
Ë
__wur
;

752 
	`fgëpos64
 (
FILE
 *
__ª°ri˘
 
__°ªam
, 
Âos64_t
 *__ª°ri˘ 
__pos
);

753 
	`f£ços64
 (
FILE
 *
__°ªam
, c⁄° 
Âos64_t
 *
__pos
);

757 
	$˛óªº
 (
FILE
 *
__°ªam
Ë
__THROW
;

759 
	$„of
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

761 
	$„º‹
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

763 #ifde‡
__USE_MISC


765 
	$˛óªº_u∆ocked
 (
FILE
 *
__°ªam
Ë
__THROW
;

766 
	$„of_u∆ocked
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

767 
	$„º‹_u∆ocked
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

775 
	`≥º‹
 (c⁄° *
__s
);

781 
	~<bôs/sys_îæi°.h
>

784 #ifdef 
__USE_POSIX


786 
	$fûío
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

789 #ifde‡
__USE_MISC


791 
	$fûío_u∆ocked
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

795 #ifde‡
__USE_POSIX2


800 
FILE
 *
	$p›í
 (c⁄° *
__comm™d
, c⁄° *
__modes
Ë
__wur
;

806 
	`p˛o£
 (
FILE
 *
__°ªam
);

810 #ifdef 
__USE_POSIX


812 *
	$˘îmid
 (*
__s
Ë
__THROW
;

816 #i‡(
deföed
 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
Ë|| deföed 
__USE_GNU


818 *
	`cu£rid
 (*
__s
);

822 #ifdef 
__USE_GNU


823 
ob°ack
;

826 
	$ob°ack_¥ötf
 (
ob°ack
 *
__ª°ri˘
 
__ob°ack
,

827 c⁄° *
__ª°ri˘
 
__f‹m©
, ...)

828 
__THROWNL
 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 2, 3)));

829 
	$ob°ack_v¥ötf
 (
ob°ack
 *
__ª°ri˘
 
__ob°ack
,

830 c⁄° *
__ª°ri˘
 
__f‹m©
,

831 
__gnuc_va_li°
 
__¨gs
)

832 
__THROWNL
 
	`__©åibuã__
 ((
	`__f‹m©__
 (
__¥ötf__
, 2, 0)));

836 #ifde‡
__USE_POSIX199506


840 
	$Êockfûe
 (
FILE
 *
__°ªam
Ë
__THROW
;

844 
	$·rylockfûe
 (
FILE
 *
__°ªam
Ë
__THROW
 
__wur
;

847 
	$fu∆ockfûe
 (
FILE
 *
__°ªam
Ë
__THROW
;

850 #i‡
deföed
 
__USE_XOPEN
 && !deföed 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


853 
	~<bôs/gë›t_posix.h
>

858 
	`__uÊow
 (
FILE
 *);

859 
	`__ovîÊow
 (
FILE
 *, );

863 #ifde‡
__USE_EXTERN_INLINES


864 
	~<bôs/°dio.h
>

866 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


867 
	~<bôs/°dio2.h
>

869 #ifde‡
__LDBL_COMPAT


870 
	~<bôs/°dio-ldbl.h
>

873 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@
1
.
1
/usr/include
24
429
core.c
pblk-cache.c
pblk-core.c
pblk-gc.c
pblk-init.c
pblk-map.c
pblk-rb.c
pblk-read.c
pblk-recovery.c
pblk-rl.c
pblk-sysfs.c
pblk-trace.h
pblk-write.c
pblk.h
/usr/include/linux/lightnvm.h
/usr/include/linux/module.h
/usr/include/linux/sem.h
/usr/include/linux/types.h
/usr/include/linux/uuid.h
/usr/include/linux/ioctl.h
/usr/include/linux/ipc.h
/usr/include/linux/posix_types.h
/usr/include/stdio.h
/usr/include/linux/stddef.h
